<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>交换流程</title>
<script src="../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>

	<!-- 按钮区域 -->
	<div class="fui-toolbar">
		<div class="btn-group">
			<a class="mini-button mini-btn-primary" id="start"
				onclick="startJob()">启动</a> <a class="mini-button mini-btn-warning"
				id="stop" onclick="stopJob()">停止</a> <a
				class="mini-button mini-btn-danger" id="del" onclick="deleteFlow()">删除</a>
		</div>
	</div>

	<!-- 条件区域 -->
	<div class="fui-search" primaryControl="flowName" opened="false">
		<!-- 表单布局 -->
		<div class="fui-form" id="fui-form">
			<div role="form">
				<div role="row">
					<div role="control" label="流程名称">
						<input bind="dataBean.flowName" id="flowName" class="mini-textbox" />
					</div>
					<div role="control" label="状态">
						<input bind="status" id="status" class="mini-combobox"
							action="getStatusSelectList" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="生成时间(开始)">
						<input bind="generateBegin" id="beginDate" class="mini-datepicker"
							onvaluechanged="onValueChanged" />
					</div>
					<div role="control" label="生成时间(结束)">
						<input bind="generateEnd" id="endDate" class="mini-datepicker"
							onvaluechanged="onValueChanged" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="所属节点域">
						<input bind="nodeGuid" class="mini-combobox"
							action="getNodeGuidList" />
					</div>
					<div role="control" label="集成类型">
						<input bind="dataBean.integrationType" class="mini-combobox"
							action="getIntegrationTypeList" />
					</div>
				</div>
			</div>
		</div>

		<!-- 搜索按钮 -->
		<a role="searcher" callback="searchData"></a>
	</div>

	<!-- 表格区域 -->
	<div class="fui-content">
		<form id="download_form" method="post" enctype="multipart/form-data"></form>
		<div id="datagrid" name="datagrid" class="mini-datagrid"
			idField="rowguid" multiSelect="true"
			style="width: 100%; height: 100%;" showPager="true"
			action="getDataGridData">
			<div property="columns">
				<div type="checkcolumn" width="35"></div>
				<div type="indexcolumn" width="45" headerAlign="center">序</div>
				<div field="flowname" width="120" headerAlign="center" align="left">流程名称
				</div>
				<div field="flowintegrationtype" width="120" headerAlign="center"
					align="center">集成类型</div>
				<div field="nodename" width="100" headerAlign="center"
					align="center">节点域</div>
				<div field="integrationType" visible="false">集成类型</div>
				<div field="msmqtype" visible="false">集成类型</div>
				<div field="isdagchild" visible="false">dag节点</div>
				<div field="generatedate" width="160" headerAlign="center"
					data-options="{'format':'yyyy-MM-dd HH:mm:ss'}" allowSort="true"
					allowOrder="desc" dateFormat="yyyy-MM-dd HH:mm:ss" align="center">生成日期
				</div>
				<div field="operaDate" width="160" headerAlign="center"
					data-options="{'format':'yyyy-MM-dd HH:mm:ss'}" allowSort="true"
					allowOrder="desc" dateFormat="yyyy-MM-dd HH:mm:ss" align="center">更新日期
				</div>
				<div field="status" width="80" headerAlign="center" align="center"
					renderer="onStatusRender">状态</div>
				<div field="export" width="80" headerAlign="center" align="center"
					renderer="onExportRenderer">导出作业</div>
				<div field="log" width="80" headerAlign="center" align="center"
					renderer="onLogRenderer">作业日志</div>
			</div>
		</div>
	</div>

	<script src="../../rest/resource/jsboot"></script>
	<script>
		epoint.initPage('dxprelateintegraflowinfolistaction', '', function(data) {
			if (mini.get('datagrid').getSelecteds().length === 0) {
	            buttonDisable();
	        }
		});
		
	    function buttonDisable() {
	        mini.get('del').disable();
	        mini.get('stop').disable();
	        mini.get('start').disable();
	    }
	    
	    function buttonEnable() {
	        mini.get('del').enable();
	        mini.get('stop').enable();
	        mini.get('start').enable();
	    }

	    var grid = mini.get('datagrid');
	    //隐藏第五列生成状态和第八列调度状态
	    grid.on('selectionchanged', function (e) {
	        if (e.selecteds.length > 0) {
	            buttonEnable();
	        } else {
	            buttonDisable();
	        }
	    });

		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		}

		var onLogRenderer = function(e) {
			return epoint.renderCell(e, "action-icon modicon-49",
					"openLogList", "rowguid,flowname");
		};

		function openLogList(e) {
			epoint.openDialog(e.flowname, './dxpschedulerloglist?guid='
					+ e.rowguid, null, {
				'width' : 1000,
				'height' : 600
			});
		}
		
		function onStatusRender(e) {
			var color = 'red';
			if (e.value == '交换中') {
				color = '#f39c12';
			} else if (e.value == '已停止') {
				color = '#d2d6de';
			} else if (e.value.indexOf('运行中') != -1) {
				color = '#00a65a';
			} else {
				color = '#dd4b39';
			}
			return '<span class="label" style="background-color:' + color + ';border-radius:.25em;color:white;padding: .2em .6em .3em;">'
					+ e.value + '</span>';
		}

		function onExportRenderer(e) {
			return epoint.renderCell(e, "action-icon modicon-86", "exportKTR");
		}

		function exportKTR(e) {
			var form = document.getElementById('download_form');
			form.action = "dxpintegraflowinfolistaction.action?cmd=exportKTR&flowGuid="
					+ e;
			form.submit();
		}

		function onValueChanged(e) {
			var sender = e.sender;
			if (sender.id == 'beginDate') {
				var todate = mini.get('endDate').getValue();
				if (todate) {
					if (sender.value.getTime() > todate.getTime()) {
						epoint.alert('开始时间不能大于结束时间！', '', function() {
							epoint.clear(sender.id);
						});
					}
				}
			} else if (sender.id == 'endDate') {
				var bedate = mini.get('beginDate').getValue();
				if (bedate) {
					if (sender.value.getTime() < bedate.getTime()) {
						epoint.alert('结束时间不能小于开始时间！', '', function() {
							epoint.clear(sender.id);
						});
					}
				}
			}
		}
		
	    function startJob() {
			// start标志变量启动作业
			if (mini.get('datagrid').getSelecteds().length == 0) {
				epoint.alert('请选择启动的作业!', '', null, 'warning');
			} else {
				 mini.showMessageBox({
		                title: "启动确认",
		                iconCls: "mini-messagebox-question",
		                buttons: ["yes", "no"],
		                message: "启动任务后是否立即执行一次？",
		                callback: function (action) {
		                    if(action=='yes'){
		                    	start('1');
		                    }else{
		                    	start('0');
		                    }
		                }
		        });
			}
		}
	    
		function start(type){
			epoint.execute('doJobWork', '', ['start',type], function(data) {
				if (data.msg.indexOf('成功') != -1) {
					epoint.alert(data.msg, '', function() {
						epoint.refresh([ 'datagrid', 'fui-form' ], '',
										true);
					}, 'success');
				} else {
					epoint.alert(data.msg, '', '', 'warning');
				}
			});
		}
	    
    	function stopJob() {
    		if (mini.get('datagrid').getSelecteds().length == 0) {
    			epoint.alert('请选择停止的作业!', '', null, 'warning');
    		} else {
    			epoint.confirm('确认要停止吗?', '', function() {
    				// stop 标志变量停用作业
    				epoint.execute('doJobWork', '', 'stop', function(data) {
    					if (data.msg.indexOf('成功') != -1) {
    						epoint.alert(data.msg, '', function() {
    							epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
    						}, 'success');
    					} else {
    						epoint.alert(data.msg);
    					}
    				});
    			});
    		}
    	}
    	
    	function deleteFlow() {
    		if (mini.get('datagrid').getSelecteds().length == 0) {
    			epoint.alert('请选择要删除的交换!', '', null, 'warning');
    		} else {
    			var select=mini.get('datagrid').getSelecteds();
    			for(var i=0;i<select.length;i++){
    				if(select[i].isdagchild){
    					epoint.alert(select[i].flowname+"是DAG子流程，不能被删除，请排除后再操作！");
    					return;
    				}
    			}
    			epoint.confirm('确认删除吗?', '', function() {
    				epoint.execute('deleteFlow', '', function(data) {
    					if (data.msg.indexOf('成功') != -1) {
    						epoint.alert(data.msg, '', function() {
    							epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
    						}, 'success');
    					} else {
    						epoint.alert(data.msg);
    					}
    				});
    			});
    		}
    	}
	</script>
</body>
</html>