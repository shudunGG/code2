<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="../../frame/fui/js/cssboot.js"></script>
    <script>
        SrcBoot.output([
            '../css/common.css',
            './css/common.css',
            './css/add-development.css'
        ]);
    </script>
    <title>转换开发</title>
</head>

<body>
    <div class="page-loading"></div>
    <!-- 缩小状态添加state-mini -->
    <div class="main-box ">
        <div class="left-nav">
            <div class="search-container">
                <div class="search-box">
                    <input id="search" type="text" placeholder="请输入关键词">
                    <a href="javascript:;" id="search-btn"></a>
                </div>
            </div>
            <div class="tab left-tab" id="tab">

            </div>
            <!-- 搜索结果容器 -->
            <div class="search-result hidden">
                <ul class="json-list result-json" id="search-result">

                </ul>
                <a class="back-btn" href="javascript:;">返回</a>
            </div>

            <a class="left-control" href="javascript:;"></a>
        </div>

        <div class="design-main">
            <!-- 头部 -->
            <div class="design-header clearfix" id="design-header">
                <div class="design-functions l">
                    <ul class="clearfix">
                        <li class="l func-item">
                            <div class="l icons-func func-prev unprev" title="Ctrl+z"></div>
                            <div class="l icons-func func-next unnext" title="Ctrl+y"></div>
                        </li>
                        <li class="l func-item">
                            <div class="icons-func func-log" id="func-log">运行</div>
                        </li>
                        <li class="l func-item">
                            <div class="icons-func func-send" id="func-send">发布</div>
                        </li>
                        <li class="l func-item">
                            <div class="icons-func func-release" title="Ctrl+s" id="func-release">保存</div>
                        </li>
                        <li class="l func-item">
                            <div class="icons-func func-property" id="func-property">属性</div>
                        </li>
                    </ul>
                </div>
              <!--   <div class="design-help r">操作说明</div> -->
            </div>
            <!-- 内容 -->
            <div class="design-container design-mini">
                <!-- 用法简介 -->
                <!-- <div class="design-item-tips hidden" id="design-item-tips">
                </div> -->
                <div class="design-panel" id="design-panel">
                    <div  class="design-name hidden">转换名称: <span id="design-name"></span></div>
                    <div class="design-diagram design-tip" id="myDiagramDiv">

                    </div>
                    <div class="design-btns">
                        <ul>
                            <li data-ref="plus" class="btns-icons btn-plus"></li>
                            <li data-ref="reduce" class="btns-icons btn-reduce"></li>
                           <!--  <li data-ref="location" class="btns-icons btn-location"></li> -->
                           <!--  <li data-ref="full" class="btns-icons btn-fullscreen"></li>  -->
                        </ul>
                    </div>
                    <!-- 右键菜单 -->
                    <div id="contextMenu" class="contextMenu">
                        <ul>
                            <li data-type="main" class="cxm cxm-open"><i class="icon-item set-icon"></i>主输出步骤</li>
                            <li data-type="wrong" class="cxm cxm-copy"><i class="icon-item delete-icon"></i>错误处理步骤</li>
                        </ul>
                    </div>
                </div>
                <!-- 底部容器 -->
                <div class="booter-bar tab" id="tab2">
                    <ul class="hd tool-top clearfix">
                        <li class="journal">日志</li>
                        <li class="step">执行步骤</li>
                        <!-- <li class="preview">预览</li> -->
                    </ul>
                    <div class="bd">
                        <div id="bdl" style="border:1px solid gray;width:100%;height:350px;overflow: scroll;">
                            <p class="state-empty">
                                暂无执行日志
                            </p>
                        </div>
						<div id="datagridstep" style="overflow: auto;height:350px" class="mini-datagrid" showPager="false" allowAlternating="true">
							<div property="columns">
								<div type="indexcolumn" width="55" headerAlign="center">序</div>
								<div field="stepname" headerAlign="center" width="120">
								步骤名称
								</div>
								<div field="copyrow" headerAlign="center" width="120">
								复制的记录行数
								</div>
								<div field="readrow" headerAlign="center" width="80">
								读
								</div>
								<div field="writerow" headerAlign="center" width="80">
								写
								</div>
								<div field="inputrow" headerAlign="center" width="80">
								输入
								</div>
								<div field="outputrow" headerAlign="center" width="80">
								输出
								</div>
								<div field="updaterow" headerAlign="center" width="80">
								更新
								</div>
								<div field="recjectrow" headerAlign="center" width="80">
								拒绝
								</div>
								<div field="errorrow" headerAlign="center" width="80">
								错误
								</div>
								<div field="status" headerAlign="center" width="80">
								激活
								</div>
								<div field="usetime" headerAlign="center" width="120">
								时间
								</div>
								<div field="speed" headerAlign="center" width="120">
								速度(条记录/秒)
								</div>
							</div>
						</div>
						<!-- <div class="bdl">
                            预览内容
                        </div> -->
                    </div>
                    <a class="control-tool" href="javascript:;"></a>
                </div>
            </div>
            <!-- 操作说明 -->
            <div id="operation-description" class="mini-window" title="" style="width:540px;height:55%;display: none;"
                showMaxButton="false" showCollapseButton="false" showShadow="true" showToolbar="false" showFooter="true"
                showModal="true" allowResize="false" allowDrag="true">

                <div property="footer"
                    style="text-align:right;height: 32px;background-color: #edeef0;padding:5px;padding-right:15px;">
                    <!-- <input type='button' value='Hide' onclick="hideWindow()" style='vertical-align:middle;'/> -->
                    <div class="ws-btn-confirm r" id="od-confirm">我知道了</div>
                </div>
                <div class="od-container">
                    <p>
                    	暂时省略
                    </p>
                </div>
            </div>
            <!-- 运行后的悬浮提示 -->
            <div class="success-tip" id="tip-box">
                <p class="tip-name">执行成功</p>
                <p class="tip-value">
                    用时：<span id="time-value"></span>
                </p>
            </div>

        </div>
    </div>

    <!-- 提示 -->
    <div class="tip-wrap">
        <p>提示文字内容</p>
    </div>

    <!-- 左侧导航模板 -->
    <script type="text/template" id="list-temp">
        <div class="nav-hd">
                {{#hdList}}
                <div class="hdl" data-target="{{target}}"><img src="{{typeicon}}" alt=""><span>{{name}}</span></div>
                {{/hdList}}
            </div>
            <div class="bd-content">
                {{#navList}}
                <div class="bdl" data-target="{{target}}">
                    <ul class="json-list">
                        {{#list}}
                        <li class="tree-item">
                            <div title="{{name}}" data-name="{{name}}" data-icon="{{icon}}"
                                 data-url="{{url}}" data-introduce="{{introduce}}" data-banwrong="{{banwrong}}"  data-maxlinks="{{maxLinks}}" data-type="{{type}}"
                                data-id="{{guid}}" draggable="true" class="tree-text">
                                <div class="l img-wrap">
                                    <img src="{{iconsmall}}" alt="">
                                </div>
                                <span>{{name}}</span>
                            </div>
                        </li>
                        {{/list}}
                    </ul>
                </div>
                {{/navList}}
            </div>
    </script>

    <!-- 搜索结果 -->
    <script type="text/template" id="result-temp">
        {{#list}}
        <li class="tree-item">
            <div title="{{name}}" data-title="" data-name="{{name}}" data-icon="{{icon}}"
                data-url="{{url}}"  data-introduce="{{introduce}}" data-banwrong="{{banwrong}}"  data-maxlinks="{{maxLinks}}" data-type="{{type}}"
                data-id="{{guid}}" draggable="true" class="tree-text">
                <div class="l img-wrap">
                    <img src="{{iconsmall}}" alt="">
                </div>
                <span>{{{textname}}}</span>
            </div>
        </li>
        {{/list}}
    
    </script>

    <script src="../../frame/fui/js/jsboot.js"></script>

    <script src="js/mustache.min.js"></script>
    <script src="js/go.js"></script>
    <script src="js/jquery-tab.js"></script>
    <script src="../js/jquery.nicescroll.min.js"></script>

    <!-- 模拟数据实际请删除 -->
    <script src="tools/mock-min.js"></script>
    <script src="tools/trans.js"></script>
    <script src="../js/websocket/IndexWebsocket.js"></script>
    
    <script>
		//属性参数
		var callBackData;
        var nodeGuid;
        var transGuid;
        var indexWebSocket;
        var taskName;
        var isErrorStep;
   		var log = $('#bdl');
		var designUrl = epoint.dealRestfulUrl("../../rest/dxpdatadeveloptransformationaction/getDesignData");
		var saveUrl = epoint.dealRestfulUrl("../../rest/dxpdatadeveloptransformationaction/saveData");
		var getStepInfoUrl = epoint.dealRestfulUrl("../../rest/dxpdatadeveloptransformationaction/getStepInfo");
		var getLeftMenu = epoint.dealRestfulUrl("../../rest/dxpdatadeveloptransformationaction/getLeftMenu");
	    epoint.initPage('dxpdatadeveloptransformationaction','',function(data){
	    	nodeGuid = data.msg;
	    	transGuid = data.transGuid;
	    	taskName = data.taskName;
	    	if (data.property) {
	    		callBackData = JSON.parse(data.property);
			}else{
				callBackData = {
						changeName:taskName,
             			rowSize:10000
				}
			}
	    	taskName = data.taskName;
	    	$("#design-name").text(data.taskName);
	    	var sessionId = data.sessionId;
	    	//websocket每个任务调试的唯一编号需动态传入
	    	indexWebSocket = new IndexWebSocket(sessionId+transGuid,log,data.contextPath+"/websocket/pushlog");
	    	load();
	    });
    </script>
    
    <script>
        var newTimer, saveTimer,
            workDescription, //作业描述
            workName; //作业名称
            var kettlePort;
    		var batchNum;
    		var nodeData;

        var designConfig = {
        	leftMenu:getLeftMenu, //左侧菜单
            attrType: 1, //拖拽还是其他生成
            isNewSave: true, //是否第一次保存
            maxHistoryLength: 20, //能保存历史记录的次数
            ctxMenu: [ // 右键菜单
                {
                    name: '主输出步骤',
                    type: 'main'
                },
                {
                    name: '错误处理步骤',
                    type: 'wrong'
                }
            ],
            // 运行运行按钮点击事件
            onLogClick: function (data, dom) {
            	data.Ie.forEach(function(value,i){
            		if(value.type=="com.epoint.dxp.development.trans.steps.ErrorTransStep"){
            			isErrorStep=true;
            		}
            	})
            	if(isErrorStep){
            		epoint.alert('存在未识别的组件，无法运行！');
            		return;
            	}
            	nodeData = data;
                if (dom.hasClass('cancel-btn')) {
                	epoint.execute('stopTransformation', '',function(result){
                		if(result.msg == 'success'){
                			epoint.alert('停止成功');
                		}else{
                			epoint.alert('停止失败', '', null, 'warning');
                		}
                	});
                    clearInterval(newTimer);
                    dom.removeClass('cancel-btn');
                    dom.text('运行');
                } else {
                	log.html('');//清空日志div
                	gridStep.clearRows();
                	//初始化执行步骤
                	//测试渲染底部执行步骤
                	 $.each(data.nodeDataArray, function (i, item) {
                		 gridStep.addRow({'stepname':item.name},i);
                	 });
                	
                	 if (callBackData) {
                     	var property= {
                     			changeName:callBackData.changeName,
                     			rowSize:callBackData.rowSize
                     	}
                     	var myDiagramData = JSON.parse(myDiagram.model.toJSON());
                     	myDiagramData.property = property;
     				}
                	
                	//调用后台运行任务
                	epoint.execute('runTransformation', '', JSON.stringify(myDiagramData),function(result){
                		if(result.errormsg){
                			epoint.alert("组件编译失败！请检查组件必要配置，或查看后台日志报错。", '', null, 'warning');
                			
                		}
                		kettlePort = result.port;
                		batchNum = result.batchNum;
                		getStepInfo(kettlePort,batchNum);
                		newTimer = setInterval(
                                function () {
                                	getStepInfo(kettlePort,batchNum,nodeData);
                                }, 1000
                            )
                	});
                    dom.addClass('cancel-btn');
                    dom.text('取消');
                }
            },
            //发布按钮
            onSendClick: function (data) {
            	if(data.indexOf('com.epoint.dxp.development.trans.steps.ErrorTransStep')!=-1){
            		epoint.alert('存在未识别的组件，无法发布！');
            		return;
            	}
                if (callBackData) {
                	var property= {
                			changeName:callBackData.changeName,
                			rowSize:callBackData.rowSize
                	}
                	var tempData = JSON.parse(data)
                	tempData.property = property;
                	data = JSON.stringify(tempData)
				}
                epoint.confirm("确认发布吗", "提示", function() {
					//调用后台发布转换
					epoint.execute('publishTrans','',[data],function(result){
						//发布成功或者失败提示
						if(result == 'success'){
							epoint.alert('发布成功');
							if (callBackData) {
								document.getElementById('design-name').innerHTML=callBackData.changeName;
							}
						}else{
							epoint.alert(result, '', null, 'warning');
						}
					});
                });

            },
            // 保存页面
            onSaveFrame : function(data, isEmpty) {
            	if(data.indexOf('com.epoint.dxp.development.trans.steps.ErrorTransStep')!=-1){
            		epoint.alert('存在未识别的组件，无法保存！');
            		return;
            	}
					if (isEmpty) {
						mini.showTips({
							content : "暂无数据",
							state : "danger",
							x : "center",
							y : "center",
							timeout : 3000
						});
					} else {
						data = JSON.parse(data);
						data.name = workName;
						data.description = workDescription;
						//存储属性值
						data.property = callBackData;
						data = JSON.stringify(data);
						
						//调用后台接口保存配置信息
						epoint.execute('saveData', '',data, function(msg) {
							if(msg == 'success'){
								mini.showTips({
			                        content: "保存成功!  转换需重新发布",
			                        state: "success",
			                        x: "center",
			                        y: "center",
			                        timeout: 3000
			                    });
								if (callBackData) {
									 document.getElementById('design-name').innerHTML=callBackData.changeName;
								}

							}else{
								mini.showTips({
			                        content: "保存失败",
			                        state: "danger",
			                        x: "center",
			                        y: "center",
			                        timeout: 3000
			                    });
							}
						});
						
					}
				},
			 //属性按钮
			 onPropertyClick : function() {
				 if (callBackData) {
					 epoint.openDialog("转换属性", "dxp/development/property?property="+ JSON.stringify(callBackData) + "&taskName=" + taskName, 
							 callback, {
							'width' : 500,
							'height' : 200
						})
				}else{
					epoint.openDialog("转换属性", "dxp/development/property?taskName=" + taskName, callback, {
						'width' : 500,
						'height' : 200
					})
				}
				},
            // 开始拖拽
            onDropStart: function (data) {
            	var myDiagramData = JSON.parse(myDiagram.model.toJson());
            	var nodeNameNew = data.name+myDiagramData.nodeDataArray.length;
            	var nodeKeyNew = data.key+name+myDiagramData.nodeDataArray.length;
            	data.name = nodeNameNew;
            	data.key = nodeKeyNew;
            	console.log(data);
            	//调用后台，先创建一个stepmeta
            	epoint.execute("createEasyStep", '',[data], function(data) {
            		if(data != '1'){
            			epoint.alert(data, '', null, 'warning');
            		}
            	});
                // 这个地方的newData格式需要和下面的 onAddNodeData 回调中的 newData 格式一致
                var newData = $.extend({}, data, {
                	name:nodeNameNew,
                    id: ''
                });
                designUtil.model.addNodeData(newData);
            },
            // 节点之间进行连线后
            onLinked: function (opt) {
            	//连线直接创建一个TransHopMeta
                var _count = opt.count, // 当前被连接的节点的连接数
                    _toNode = opt.toNode, // 被连接的节点
                    _fromNodeKey = opt.fromNodeKey, // 连线的起点
                    _firstNodeKey = opt.firstNodeKey, // 第一条连线
                    _toNodeMax = Number(_toNode.data.maxLinks), // 被连接的节点最小连线数
                    _toNodeMin = Number(_toNode.data.minLinks), // 被连接的节点最大连线数
                    _fromNode = opt.fromNode, // fromjiedian
                    _fromCount = opt.fromCount, // fromjiedian
                    _fromFirstNodeKey = opt.fromFirstNodeKey,
                    _toNodeKey = _toNode.data.key;

                if (Number(_fromNode.data.maxLinks)) {
                    // 当前连接数大于最大连接数则移除与其最早连接的那个节点间的连线
                    if (opt.fromCount > Number(_fromNode.data.maxLinks)) {
                        // console.log('超过上限啦max');
                        // 移除第一个连线
                        designUtil.removeLink(_fromNode.data.key, _fromFirstNodeKey);

                    }
                }
                
                epoint.execute("createEasyTransHop", '',[_fromNodeKey,_toNodeKey], function(msg) {
            		if(msg != '1'){
            			epoint.alert(msg, '', null, 'warning');
            		}
            	});
                
            },
            // 双击节点
            onNodeDoubleClick: function (opt) {
                nodeData = opt.nodeData;
                linkCount = opt.linkCount;
                
                //挤入操作类型
                designConfig.attrType = 2;
                //console.log(nodeData);
                if(nodeData.url){
                	  epoint.openTopDialog(nodeData.name, Util.getRightUrl(nodeData.url+"?nodeGuid="+nodeGuid+"&transGuid="+transGuid),
                              function (
                                  param) {
                                  //判断弹窗是否直接关闭
                                  if (param != 'close') {
                                      myDiagram.startTransaction('edit');
                                      myDiagram.model.setDataProperty(nodeData, "edit", "edit");
                                      myDiagram.model.setDataProperty(nodeData, "id", param);
                                      var stepValue = JSON.parse(param);
                                      myDiagram.model.setDataProperty(nodeData, "name", stepValue.stepName);
                                      myDiagram.commitTransaction('edit');
                                  }
                              });
                }
            },
            canDelete: function (data) {
                // 根据节点数据判断是否可以删除，返回true则不能删除
                if (selectedObj.data && (selectedObj.data.noDelete || selectedObj.data.type === 'result')) {
                    return true;
                }
             	//调用后台，删除组件或变迁
            	epoint.execute("removeStepOrHop", '',[selectedObj.data], function(msg) {
            		if(msg != '1'){
            			epoint.alert(msg, '', null, 'warning');
            		}
            	});
                return false;
            },
            // 右键菜单点击事件
            onCtxMenuClick: function (opt) {
                var type = opt.type,
                    nodeData = opt.nodeData,
                    linkCount = opt.linkCount;
                if (type == 'main') {

                } else if (type == 'wrong') {


                }

            }

        }
      	//定时调用后台获取执行步骤信息
        function getStepInfo(kettlePort,batchNum,nodeData){
        	Util.ajax({
                url: getStepInfoUrl,
                data: {port:kettlePort,batchNum:batchNum},
                async:true
            }).done(function (result) {
            	if(result){
            		gridStep.clearRows();
            		gridStep.addRows(result,result.length);
                        
            		//组件鼠标悬停效果
            		$.each(result,function(key, value){
            			$.each(nodeData.nodeDataArray,function(i, item){
            				if(value.stepname == item.name){
	            				myDiagram.model.setDataProperty(item, "success",1);
	                            myDiagram.model.setDataProperty(item, "time",value.usetime);
            				}
            			});
            		});
        		}
            });
        	
        }
        
        //转换执行完最后一次调用后台获取步骤信息
        function getLastStepInfo(kettlePort,batchNum,nodeData){
        	Util.ajax({
                url: getStepInfoUrl,
                data: {port:kettlePort,batchNum:batchNum},
                async:true
            }).done(function (result) {
            	if(result){
            		gridStep.clearRows();
            		gridStep.addRows(result,result.length);
                        
            		//组件鼠标悬停效果
            		$.each(result,function(key, value){
            			$.each(nodeData.nodeDataArray,function(i, item){
            				if(value.stepname == item.name){
            					if(value.isSuccess == '1'){
            						myDiagram.model.setDataProperty(item, "successicon","images/success-icon.png");
		            				myDiagram.model.setDataProperty(item, "success",1);
            					}else if(value.isSuccess == '0'){
            						myDiagram.model.setDataProperty(item, "successicon","images/fail-icon.png");
		            				myDiagram.model.setDataProperty(item, "success",0);
            					}else{
            						myDiagram.model.setDataProperty(item, "success",1);
            					}
	                            myDiagram.model.setDataProperty(item, "time",value.usetime);
            				}
            			});
            		});
        		}
            });
        	
        }
        
        //属性返回参数
        function callback(data){
        	if (data && "close" != data) {
        		callBackData = data;
			}
        }
    </script>
    <script src="js/add-development.js"></script>
</body>

</html>