<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>交换流程</title>
    <script src="../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
<div class="page-loading"></div>

<div class="fui-left">
    <div role="head" title="选择分组">
        <a class="mini-button mini-btn-primary" onclick="addGroup()">新增分组</a>
    </div>
    <div role="body">
        <ul id="tree" class="mini-filtertree" textField="text" idField="id"
            parentField="pid" action="dxpflowgroupaction.getTreeModel" resultAsTree="false"
            filterMode="server">
        </ul>
    </div>
</div>

<div class="fui-right">
    <!-- 按钮区域 -->
    <div class="fui-toolbar">
        <div class="btn-group mr10">
            <a class="mini-button mini-btn-primary" iconCls="icon-addcircle" onclick="openDataDev()">新建流程</a>
        </div>
        <div class="btn-group mr10">
        <a class="mini-button mini-btn-primary" id="start"
					onclick="startJob()">启动</a> <a class="mini-button mini-btn-warning"
					id="stop" onclick="stopJob()">停止</a>
            <a class="mini-button mini-btn-warning" id="move" onclick="moveFlow()">移动</a>
            <a class="mini-button mini-btn-danger" id="del" iconCls="icon-minuscircle" onclick="deleteFlow()">删除交换</a>
        </div>
    </div>

    <!-- 条件区域 -->
    <div class="fui-search" primaryControl="flowName" opened="false">
        <!-- 表单布局 -->
        <div class="fui-form" id="fui-form">
            <div role="form">
                <div role="row">
                    <div role="control" label="流程名称">
                        <input bind="dataBean.flowName" id="flowName" class="mini-textbox"/>
                    </div>
                </div>
                <div role="row">
                    <div role="control" label="生成时间(开始)">
                        <input bind="generateBegin" id="beginDate" class="mini-datepicker" onvaluechanged="onValueChanged"/>
                    </div>
                    <div role="control" label="生成时间(结束)">
                        <input bind="generateEnd" id="endDate" class="mini-datepicker" onvaluechanged="onValueChanged"/>
                    </div>
                </div>
                <input bind="groupGuid" id="groupGuid" class="mini-hidden"/>
            </div>
        </div>

        <!-- 搜索按钮 -->
        <a role="searcher" callback="searchData"></a>
    </div>

    <!-- 表格区域 -->
    <div class="fui-content">
    <form id="download_form" method="post" enctype="multipart/form-data"></form>
        <div id="datagrid" name="datagrid" class="mini-datagrid"
             idField="rowguid" multiSelect="true"
             style="width: 100%; height: 100%;" showPager="true"
             action="getDataGridData">
            <div property="columns">
                <div type="checkcolumn" width="30"></div>
                <div type="indexcolumn" width="50" headerAlign="center">序</div>
                <div field="flowname" width="200" headerAlign="center"
                     align="center" renderer="onTitleRenderer">流程名称
                </div>
                <div field="generatedate" width="160" headerAlign="center"
                     data-options="{'format':'yyyy-MM-dd HH:mm:ss'}"
                     dateFormat="yyyy-MM-dd HH:mm:ss" align="center">生成日期
                </div>
                <div field="operatedate" width="160" headerAlign="center"
                     data-options="{'format':'yyyy-MM-dd HH:mm:ss'}"
                     dateFormat="yyyy-MM-dd HH:mm:ss" align="center">更新日期
                </div>
                <div field="nodeguid"  headerAlign="center"
                     align="center"  visible="false">节点guid
                </div>
                <div field="rowguid"  visible="false">flowguid
                </div>
                <div field="jobstatus" width="80" headerAlign="center" align="center"
						renderer="onStatusRender">状态</div>
				<!-- <div  width="80" headerAlign="center"
						align="center" renderer="onScheduleRenderer">调度配置</div> -->
                <div width="80" headerAlign="center"
                     align="center" renderer="onChildListRenderer">DAG节点流程
                </div>
                <div width="80" headerAlign="center"
                     align="center" renderer="onDesignerRenderer">流程设计
                </div>
                <div width="80" headerAlign="center"
                     align="center" renderer="onEditRenderer">编辑流程
                </div>
                <div width="80" headeralign="center" align="center" renderer="onLogRenderer">流程实例</div>
            </div>
        </div>
    </div>
</div>

<script src="../../../rest/resource/jsboot"></script>
<script>
    epoint.initPage('dxpdagdeveloplistaction', '', function (data) {
        if (mini.get('datagrid').getSelecteds().length === 0) {
            buttonDisable();
        }
    });

    var tree = mini.get('tree');
    tree.on('beforenodeselect', function (e) {
    	console.log(e);
        if (e.node.id == 'f9root') {
            mini.get('groupGuid').setValue('');
        } else {
            mini.get('groupGuid').setValue(e.node.id);
        }
        searchData();
    });

    var grid = mini.get('datagrid');
    grid.on('selectionchanged', function (e) {
        if (e.selecteds.length > 0) {
            buttonEnable();
        } else {
            buttonDisable();
        }
    });

    function addGroup() {
        epoint.openDialog("新增分组", "dxp/flowinfo/flowgroupadd", function () {
            epoint.refresh('tree');
        }, {
            'width': 650,
            'height': 420
        })
    }

    function moveFlow() {
        let array = grid.getSelecteds();
        let guidArray = [];
        for(var i=0;i<array.length;i++){
            guidArray.push(array[i].rowguid);
        }
        let guid = guidArray.join(",");
        epoint.openDialog("移动集成", "dxp/flowinfo/flowgroupselect?guid=" + guidArray, searchData(), {
            'width': 700,
            'height': 420
        })
    }

    function searchData() {
        epoint.refresh(['datagrid', 'fui-form'],null,true);
    }

	var onScheduleRenderer = function(e) {
		if(e.record.integrationType=='4'&&e.record.msmqtype=='0'){
			return "";
		}
		return epoint.renderCell(e, "action-icon modicon-97",
					"openScheduleList");
	};

	function openScheduleList(e) {
		epoint.openDialog('调度配置', 'dxp/flowinfo/dagtaskconfigNew?guid=' + e, null, {
			'width' : 700,
			'height' : 350
		});
	}
    
    function startJob() {
    	// start标志变量启动作业
    		if (mini.get('datagrid').getSelecteds().length == 0) {
    			epoint.alert('请选择启动的作业!', '', null, 'warning');
    		} else {
    			epoint.execute('doJobWork', '', 'start', function(data) {
    				if (data.msg.indexOf('成功') != -1) {
    					epoint.alert(data.msg, '', function() {
    						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
    					}, 'success');
    				} else {
    					epoint.alert(data.msg, '', '', 'warning');
    				}
    			});
    		}
    	}

    	function stopJob() {
    		if (mini.get('datagrid').getSelecteds().length == 0) {
    			epoint.alert('请选择停止的作业!', '', null, 'warning');
    		} else {
    			epoint.confirm('确认要停止吗?', '', function() {
    				// stop 标志变量停用作业
    				epoint.execute('doJobWork', '', 'stop', function(data) {
    					if (data.msg.indexOf('成功') != -1) {
    						epoint.alert(data.msg, '', function() {
    							epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
    						}, 'success');
    					} else {
    						epoint.alert(data.msg);
    					}
    				});
    			});
    		}
    	}


	function deleteFlow() {
		if (mini.get('datagrid').getSelecteds().length == 0) {
			epoint.alert('请选择要删除的交换!', '', null, 'warning');
		} else {
			epoint.confirm('确认删除吗?', '', function() {
				epoint.execute('deleteFlow', '', function(data) {
					if (data.msg.indexOf('成功') != -1) {
						epoint.alert(data.msg, '', function() {
							epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
						}, 'success');
					} else {
						epoint.alert(data.msg);
					}
				});
			});
		}
	}
	
	function freshFlowCache() {
		if (mini.get('datagrid').getSelecteds().length == 0) {
			epoint.alert('请选择要刷新的交换!', '', null, 'warning');
		} else {
			epoint.confirm('确认刷新吗?', '', function() {
				epoint.execute('freshFlowCache', '', function(data) {
					if (data.msg.indexOf('成功') != -1) {
						epoint.alert(data.msg, '', function() {
							epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
						}, 'success');
					} else {
						epoint.alert(data.msg);
					}
				});
			});
		}
	}

	
	function openDataDev(){
		var groupid=mini.get('groupGuid').getValue();
		epoint.openDialog('新建DAG流程', './adddagdevflowinfo?groupid='+groupid, function(data) {
			mini.get('datagrid').reload();
		}, {
			'width' : 1000,
			'height' : 450
		});
	}
	
	function onStatusRender(e) {
		var color = 'red';
		if (e.value == '交换中') {
			color = '#f39c12';
		} else if (e.value == '已停止') {
			color = '#d2d6de';
		} else if (e.value.indexOf('运行中') != -1) {
			color = '#00a65a';
		} else {
			color = '#dd4b39';
		}
		return '<span class="label" style="background-color:' + color + ';border-radius:.25em;color:white;padding: .2em .6em .3em;">'
				+ e.value + '</span>';
	}

    function buttonEnable() {
        mini.get('move').enable();
        mini.get('del').enable();
        mini.get('start').enable();
        mini.get('stop').enable();

    }

    function buttonDisable() {
        mini.get('move').disable();
        mini.get('del').disable();
        mini.get('start').disable();
        mini.get('stop').disable();

    }
    
    
    function onEditRenderer(e) {
		return epoint.renderCell(e, "action-icon icon-edit", "editFlow","rowguid,flowtype");
	}

	function editFlow(e) {
		epoint.openDialog('编辑DAG流程', './editdagdevflowinfo?flowguid='+e.rowguid, function(data) {
			mini.get('datagrid').reload();
		}, {
			'width' : 1000,
			'height' : 450
		});
	}
	
	function onDesignerRenderer(e){
		return epoint.renderCell(e, "action-icon icon-paper",
				"openDesigner", "rowguid");
	}
    
	function openDesigner(dagGuid){
		/* epoint.openTopDialog('DAG流程设计',
				'dxp/development/chart/designer?dagGuid=' + dagGuid,
				function(param) {
					if (param != 'close') {
						epoint.alert(param, null, null, 'info');
					}
					epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
				});
		 */
		window.open("../../../dxp/development/chart/designer?dagGuid="
				+ dagGuid);
	}
	
	
	// 绘制日志按钮
	var onLogRenderer = function(e) {
		return epoint.renderCell(e, "action-icon icon-doc", "openLog",
				"rowguid");
	};

	// 弹出流程日志展示页
	function openLog(guid) {
		epoint.openDialog('DAG流程实例列表',
						'frame/pages/epointjob/epointjobdagloglist?dagGuid='
								+ guid, "", {
							'width' : 1400,
							'height' : 1000
						})

	}

	
	function onChildListRenderer(e){
		return epoint.renderCell(e, "action-icon icon-doc", "openChildList",
		"rowguid");
	}
	
	
	function openChildList(flowGuid){
		epoint.openDialog('DAG节点流程列表',
				'dxp/development/flowinfo/devdagchildflowinfolist?flowGuid='
						+ flowGuid, "", {
					'width' : 1400,
					'height' : 1000
				}) 
	
	}
	
	
	
	function onValueChanged(e) {
    	var sender=e.sender;
    	if(sender.id=='beginDate'){
    		var todate=mini.get('endDate').getValue();
    		if(todate){
        		if(sender.value.getTime()>todate.getTime()){
        			epoint.alert('开始时间不能大于结束时间！','',function(){
        				epoint.clear(sender.id);
        			});
        		}
    		}
    	}else if(sender.id=='endDate'){
    		var bedate=mini.get('beginDate').getValue();
    		if(bedate){
        		if(sender.value.getTime()< bedate.getTime()){
        			epoint.alert('结束时间不能小于开始时间！','',function(){
        				epoint.clear(sender.id);
        			});
        		}
    		}
    	}
    }
    
</script>
</body>
</html>