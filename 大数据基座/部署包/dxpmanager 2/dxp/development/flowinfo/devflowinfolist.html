<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>交换流程</title>
<script src="../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>

	<div class="fui-left">
		<div role="head" title="选择分组">
			<a class="mini-button mini-btn-primary" onclick="addGroup()">新增分组</a>
		</div>
		<div role="body">
			<ul id="tree" class="mini-filtertree" textField="text" idField="id"
				parentField="pid" action="dxpflowgroupaction.getTreeModel"
				resultAsTree="false" filterMode="server">
			</ul>
		</div>
	</div>

	<div class="fui-right">
		<!-- 按钮区域 -->
		<div class="fui-toolbar">
			<div class="btn-group mr10">
				<a class="mini-button mini-btn-primary" iconCls="icon-addcircle"
					onclick="openDataDev()">新建流程</a> <a
					class="mini-button mini-btn-primary" iconCls="icon-addcircle"
					id="import" onclick="openUpload()">导入流程</a>
			</div>
			<div class="btn-group mr10">
				<a class="mini-button mini-btn-warning" id="move"
					onclick="moveFlow()">移动</a> <a class="mini-button mini-btn-danger"
					id="del" iconCls="icon-minuscircle" onclick="deleteFlow()">删除交换</a>
				<a class="mini-button mini-btn-warning" id="fresh"
					onclick="freshFlowCache()">刷新缓存</a>
			</div>
		</div>

		<!-- 条件区域 -->
		<div class="fui-search" primaryControl="flowName" opened="false">
			<!-- 表单布局 -->
			<div class="fui-form" id="fui-form">
				<div role="form">
					<div role="row">
						<div role="control" label="流程名称">
							<input bind="dataBean.flowName" id="flowName"
								class="mini-textbox" />
						</div>
						<div role="control" label="所属节点域">
							<input bind="nodeguid" id="nodeguid" class="mini-combobox"
								allowInput="true" action="getNodeGuidList" />
						</div>
					</div>
					<div role="row">
						<div role="control" label="发布状态">
							<input bind="publishStatus" class="mini-combobox"
								data="[{text:'未发布',id:'0'},{text:'已发布',id:'1'}]"
								textField="text" valueField="id" />
						</div>
						<div role="control"></div>
					</div>
					<div role="row">
						<div role="control" label="生成时间(开始)">
							<input bind="generateBegin" id="beginDate"
								class="mini-datepicker" onvaluechanged="onValueChanged" />
						</div>
						<div role="control" label="生成时间(结束)">
							<input bind="generateEnd" id="endDate" class="mini-datepicker"
								onvaluechanged="onValueChanged" />
						</div>
					</div>
					<input bind="groupGuid" id="groupGuid" class="mini-hidden" />
				</div>
			</div>

			<!-- 搜索按钮 -->
			<a role="searcher" callback="searchData"></a>
		</div>

		<!-- 表格区域 -->
		<div class="fui-content">
			<form id="download_form" method="post" enctype="multipart/form-data"></form>
			<div id="datagrid" name="datagrid" class="mini-datagrid"
				idField="rowguid" multiSelect="true"
				style="width: 100%; height: 100%;" showPager="true"
				action="getDataGridData">
				<div property="columns">
					<div type="checkcolumn" width="30"></div>
					<div type="indexcolumn" width="50" headerAlign="center">序</div>
					<div field="flowname" width="200" headerAlign="center"
						align="center" renderer="onTitleRenderer">流程名称</div>
					<div field="nodename" width="100" headerAlign="center"
						align="center">所属节点域</div>
					<div field="publishstatusname" width="100" headerAlign="center"
						align="center">发布状态</div>
					<div field="flowtype" visible="false">流程类型</div>
					<div field="generatedate" width="160" headerAlign="center"
						data-options="{'format':'yyyy-MM-dd HH:mm:ss'}"
						dateFormat="yyyy-MM-dd HH:mm:ss" align="center">生成日期</div>
					<div field="operatedate" width="160" headerAlign="center"
						data-options="{'format':'yyyy-MM-dd HH:mm:ss'}"
						dateFormat="yyyy-MM-dd HH:mm:ss" align="center">更新日期</div>
					<div field="nodeguid" headerAlign="center" align="center"
						visible="false">节点guid</div>
					<div field="isDagChild" headerAlign="center" align="center"
						visible="false">isDagChild</div>
					<div width="80" headerAlign="center" align="center"
						renderer="onTransRenderer">转换管理</div>
					<div width="80" headerAlign="center" align="center"
						renderer="onEditRenderer">流程开发</div>
					<div field="export" width="80" headerAlign="center" align="center"
						renderer="onExportRenderer">导出流程</div>
				</div>
			</div>
		</div>
	</div>

	<script src="../../../rest/resource/jsboot"></script>
	<script>
		epoint.initPage('dxpdatadeveloplistaction', '', function(data) {
			if (data.flowType == '01') {
				//集成不显示导入
				mini.get('import').setVisible(false);
			}
			if (mini.get('datagrid').getSelecteds().length === 0) {
				buttonDisable();
			}
		});

		var tree = mini.get('tree');
		tree.on('beforenodeselect', function(e) {
			if (e.node.id == 'f9root') {
				mini.get('groupGuid').setValue('');
			} else {
				mini.get('groupGuid').setValue(e.node.id);
			}
			searchData();
		});

		var grid = mini.get('datagrid');
		grid.on('selectionchanged', function(e) {
			if (e.selecteds.length > 0) {
				buttonEnable();
			} else {
				buttonDisable();
			}
		});

		function addGroup() {
			epoint.openDialog("新增分组", "dxp/flowinfo/flowgroupadd", function() {
				epoint.refresh('tree');
			}, {
				'width' : 650,
				'height' : 420
			})
		}

		function moveFlow() {
			let array = grid.getSelecteds();
			let guidArray = [];
			for (var i = 0; i < array.length; i++) {
				guidArray.push(array[i].rowguid);
			}
			let guid = guidArray.join(",");
			epoint.openDialog("移动集成", "dxp/flowinfo/flowgroupselect?guid="
					+ guidArray,function(){
				searchData();
			}, {
				'width' : 700,
				'height' : 420
			}) 
		}

		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
		}

		function deleteFlow() {
			if (mini.get('datagrid').getSelecteds().length == 0) {
				epoint.alert('请选择要删除的交换!', '', null, 'warning');
			} else {
				var select=mini.get('datagrid').getSelecteds();
				for(var i=0;i<select.length;i++){
					if(select[i].isDagChild!=0){
						epoint.alert(select[i].flowname+"是DAG子流程，不能被删除，请排除后再操作！");
						return;
					}
				}
				epoint.confirm('确认删除吗?', '', function() {
					epoint.execute('deleteFlow', '', function(data) {
						if (data.msg.indexOf('成功') != -1) {
							epoint.alert(data.msg, '', function() {
								epoint.refresh([ 'datagrid', 'fui-form' ], '',
										true);
							}, 'success');
						} else {
							epoint.alert(data.msg);
						}
					});
				});
			}
		}

		function freshFlowCache() {
			if (mini.get('datagrid').getSelecteds().length == 0) {
				epoint.alert('请选择要刷新的交换!', '', null, 'warning');
			} else {
				epoint.confirm('确认刷新吗?', '', function() {
					epoint.execute('freshFlowCache', '', function(data) {
						if (data.msg.indexOf('成功') != -1) {
							epoint.alert(data.msg, '', function() {
								epoint.refresh([ 'datagrid', 'fui-form' ], '',
										true);
							}, 'success');
						} else {
							epoint.alert(data.msg);
						}
					});
				});
			}
		}

		function openUpload() {
			var groupid = mini.get('groupGuid').getValue();
			epoint.openDialog('导入作业', 'dxp/flowinfo/uploadflow?groupid='
					+ groupid, function(data) {
				epoint.execute('checkFile', '', data);
				mini.get('datagrid').reload();
			}, {
				'width' : 800,
				'height' : 480
			});
		}

		function onExportRenderer(e) {
			if(e.row.publishstatusname==='未发布'){
	    		return '';
	    	}
			return epoint.renderCell(e, "action-icon modicon-86", "exportKTR");
		}

		function exportKTR(e) {
			var form = document.getElementById('download_form');
			form.action = "dxpdatadeveloplistaction.action?cmd=exportKTR&flowGuid="
					+ e;
			form.submit();
		}

		function onTitleRenderer(e) {
			return '<a href="javascript:void(0);" onclick="importKTR(' + "'"
					+ e.row.rowguid + "','" + e.row.flowtype + '\');" >'
					+ e.value + '</a>';
		}

		function importKTR(rowguid, flowtype) {
			var groupid = mini.get('groupGuid').getValue();
			var url = 'dxp/flowinfo/uploadflowedit?groupid=' + groupid
					+ '&flowGuid=' + rowguid;
			epoint.openDialog('编辑作业', url, function(data) {
				epoint.execute('checkFile', '', data);
				mini.get('datagrid').reload();
			}, {
				'width' : 800,
				'height' : 480
			});
		}

		function openDataDev() {
			var groupid = mini.get('groupGuid').getValue();
			epoint.openDialog('新建流程', './adddevflowinfo?groupid=' + groupid,
					function(data) {
						epoint.execute('checkFile', '', data);
						mini.get('datagrid').reload();
					}, {
						'width' : 800,
						'height' : 450
					});
		}

		function buttonEnable() {
			mini.get('move').enable();
			mini.get('del').enable();

		}

		function buttonDisable() {
			mini.get('move').disable();
			mini.get('del').disable();

		}

		function onEditRenderer(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "editFlow",
					"rowguid,flowtype,nodeguid");
		}

		function editFlow(e) {
			/*  if(e.flowtype == '03'){
				epoint.alert('治理流程暂时不支持编辑', '',null, 'warning');
			}else{ */
			window
					.open("../../../dxp/development/add-flowdevelopment?flowguid="
							+ e.rowguid+"&nodeGuid="+e.nodeguid);
			/* } */
		}

		function onTransRenderer(e) {
			/*   return '<a href="javascript:void(0);" onclick="addTrans(' + "'"
			      + e.row.rowguid + "'" + ');" >' + "配置转换" + '</a>'; */
			return epoint.renderCell(e, "action-icon icon-fix", "addTrans",
					"rowguid,nodeguid,flowtype");
		}

		function addTrans(e) {
			epoint.openDialog('转换管理', "./adddevtaskinfolist?flowGuid="
					+ e.rowguid + "&nodeGuid=" + e.nodeguid + "&flowtype="
					+ e.flowtype, searchData, {
				'width' : 1000,
				'height' : 550
			});
		}

		function onValueChanged(e) {
			var sender = e.sender;
			if (sender.id == 'beginDate') {
				var todate = mini.get('endDate').getValue();
				if (todate) {
					if (sender.value.getTime() > todate.getTime()) {
						epoint.alert('开始时间不能大于结束时间！', '', function() {
							epoint.clear(sender.id);
						});
					}
				}
			} else if (sender.id == 'endDate') {
				var bedate = mini.get('beginDate').getValue();
				if (bedate) {
					if (sender.value.getTime() < bedate.getTime()) {
						epoint.alert('结束时间不能小于开始时间！', '', function() {
							epoint.clear(sender.id);
						});
					}
				}
			}
		}
	</script>
</body>
</html>