<!DOCTYPE html>
<html lang="zh-CN">

<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>保存</title>
<script src="../../../frame/fui/js/cssboot.js"></script>
</head>
<style>
body, html {
	overflow: auto !important;
}
</style>
<body>

	<!-- 	<div class="page-loading"></div> 
	<!-- toolbar区域 -->
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<a id="savetype" class="mini-button mini-btn-primary" onclick="saveModify">保存并关闭</a> 
			<a class="mini-button mini-btn-primary" id="closebtn" onclick="epoint.closeDialog">关闭</a>
		</div>
	</div>
<div class="fui-content">
	<div id="form" class="fui-form">
		<div role="row" style="padding-top: 1px">
			<div role="control" label="步骤名称" starred="true">
				<input id="stepName" name="stepName" class="mini-textbox"
					required="true" emptyText="请输入步骤名称" style="width: 70%" />
			</div>
		</div>
		<div id="tabs1" class="mini-tabs" activeIndex="0" plain="false">
			<div name="tabs1" title="Webservice配置">
				<span>设置:</span>
					<div role="row">
						<div role="control" label="URL" starred="true" style="width:55%">
							<input id="url" name="url" class="mini-textbox" required="true" />
						</div>
						<div role="control" style="width:5%">
							<a id="getOption" class="mini-button mini-btn-primary" onclick="getOperationNames">获取方法</a> 
						</div>
					</div>
					<div role="row">
						<div role="control" label="方法">
							<input id="operationName" name="operationName" class="mini-textbox" required="false"/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="operation request name">
							<input id="operationRequestName" name="operationRequestName" class="mini-textbox" required="false"/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="Web Service 调用步骤" starred="true">
							<input id="callStep" name="callStep" class="mini-textbox" required="true"/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="将输入的数据传到输出">
							<input id="passDataToServletOutput" name="passDataToServletOutput" class="mini-checkbox"/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="v2.x/3.0 兼容模式">
							<input id="compatible" name="compatible" class="mini-checkbox"/>
						</div>
					</div>
										
					<div role="row">
						<div role="control" label="重复元素名称" >
							<input id="repeatingElementName" name="repeatingElementName" class="mini-textbox" required="false"/>
						</div>
					</div>					
					<div role="row">
						<div role="control" label="输出完整返回赋值 ">
							<input id="returningReplyAsString" name="returningReplyAsString" class="mini-checkbox"/>
						</div>
					</div>			
							
					<hr style="height:1px;border:none;border-top:1px solid #ebebeb;" />
					<span >HTTP 授权 :</span>
					<div role="row">
						<div role="control" label="Http 登录">
							<input id="httpLogin" name="httpLogin" class="mini-textbox" required="false"/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="Http 密码">
							<input id="httpPassword" name="httpPassword" class="mini-textbox" required="false"/>
						</div>
					</div>
					
					<hr style="height:1px;border:none;border-top:1px solid #ebebeb;" />
					<span >使用代理</span>
						<div role="row">
						<div role="control" label="代理主机">
							<input id="proxyHost" name="proxyHost" class="mini-textbox" required="false"/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="代理端口">
							<input id="proxyPort" name="proxyPort" class="mini-textbox" required="false"/>
						</div>
					</div>
					<input id="inData" name="inData" class="mini-textbox hidden">
					<input id="outData" name="outData" class="mini-textbox hidden">
				</div>
				
				
			<div name="tabs2" title="输入参数">
				<div class="" style="padding-top: 1px">
					<div class="btn-group mr10">
						<a class="mini-button mini-btn-primary" onclick="addHeaders" style="margin-left: 20px">新增字段</a>
						<a id="deleteHelder" class="mini-button mini-btn-danger"
				onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要删除的记录!', '', null, 'warning');} else {epoint.confirm('确认删除?','',deleteHeadersSelected);}">删除选中</a>
					</div>
				</div>
				<div class="fui-content" style="padding-top: 1px">
					<div id="datagrid" name="datagrid" class="mini-datagrid"
						 multiSelect="true" allowCellValid="true" action="getHeadersDataGridData"
						allowCellEdit="true" style="height: 100%;" allowResize="true"
						showPager="false" allowCellSelect="true" editNextOnEnterKey="true"
						editNextRowCell="true">
						<div property="columns">
							<div type="checkcolumn" width="55"></div>
							<div type="indexcolumn" width="55" headerAlign="center">序</div>
							<div field="inField" headerAlign="center" vtype="required" width="200">
								名称<input property="editor" class="mini-combobox" style="width: 100%"
								emptyText="请选择字段..." data="preFieldList" textField="text" valueField="id" required="true"/>
							</div>
							<div field="inName" headerAlign="center" vtype="required" width="200">
								WS名称<input property="editor" class="mini-textbox" style="width: 100%" required="true"/>
							</div>
							<div field="inType" headerAlign="center" vtype="required" width="200">
								WS类型<input property="editor" class="mini-textbox" style="width: 100%" required="true"/>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div name="tabs3" title="输出结果">
				<div class="" style="padding-top: 1px">
					<div class="btn-group mr10">
						<a class="mini-button mini-btn-primary" id="addParameter" onclick="addParameters" style="margin-left: 20px">新增参数</a>
						<a id="deleteParameter" class="mini-button mini-btn-danger"
				onclick="if(mini.get('datagrid2').getSelecteds().length==0){epoint.alert('请选择要删除的记录!', '', null, 'warning');} else {epoint.confirm('确认删除?','',deleteParametersSelected);}">删除选中</a>
					</div>
				</div>
				<div class="fui-content" style="padding-top: 1px">
					<div id="datagrid2" name="datagrid2" class="mini-datagrid"
						 multiSelect="true" allowCellValid="true" action="getParametersDataGridData"
						allowCellEdit="true" style="height: 100%;" allowResize="true"
						showPager="false" allowCellSelect="true" editNextOnEnterKey="true"
						editNextRowCell="true">
						<div property="columns">
							<div type="checkcolumn" width="55"></div>
							<div type="indexcolumn" width="55" headerAlign="center">序</div>
							<div field="outField" headerAlign="center" vtype="required" width="200">
								名称<input property="editor" class="mini-textbox" style="width: 100%" required="true"/>
							</div>
							<div field="outName" headerAlign="center" vtype="required" width="200">
								WS名称<input property="editor" class="mini-textbox" style="width: 100%" required="true"/>
							</div>
							<div field="outType" headerAlign="center" vtype="required" width="200">
								WS类型<input property="editor" class="mini-textbox" style="width: 100%" required="true"/>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
		<script src="../../../frame/fui/js/jsboot.js"></script>



		<script>
			var form = new mini.Form("#form");
			var stepNameForm = mini.get('stepName');
			var grid = mini.get("datagrid");
			var grid2 = mini.get("datagrid2");
			var nodeData;
			var nodeInfo;
			var preFieldList;
			
			function pageLoad() {
				//从父页面获取表单数据
				var data = top.nodeData;
				nodeInfo = data;
				nodeData = mini.decode(data.id);
				epoint.initPage('webserviceaction?nodeInfoKey=' + nodeInfo.key,
				{'nodeData':epoint.encodeUtf(JSON.stringify(nodeData))},
				initCallBack);
			}
			
			function initCallBack(e) {
				//填充表单数据
				form.setData(nodeData);
				var nodeName = nodeData.stepname;
				if(!nodeName){
					stepNameForm.setValue(nodeInfo.name);
				}
				if(e.preFieldList){
					preFieldList = e.preFieldList;
				}
			}
			
			//获取form表单数据
			function getForm() {
				var data = form.getData(true, false);
				var s = mini.encode(data);
				return s;
			}
	
			//保存修改
			function saveModify() {
				grid.validate();
				if (grid.isValid() == false) {
					var error = grid.getCellErrors()[0];
					grid.beginEditCell(error.record, error.column);
					return;
				}
				grid2.validate();
				if (grid2.isValid() == false) {
					var error = grid2.getCellErrors()[0];
					grid2.beginEditCell(error.record, error.column);
					return;
				}
				if (epoint.validate()) {
					// 把表格的数据拿出来放到隐藏域中
					setGridData();
					var nodeForm = getForm();
					epoint.execute('saveAll', '@none', [ nodeInfo, nodeForm ], function(
							data) {
						if (data.success == 'success') {
							epoint.closeDialog(nodeForm);
						} else {
							epoint.alert(data.msg, '', null, 'warning');
						}
					});
				}
			}
			
			//新增类别
			function addHeaders() {
				var newRow = {
				//lx : "保留非全局角色"
				};
				grid.addRow(newRow, 0);
				grid.beginEditRow(newRow);
			}
			
			//新增类别
			function addParameters() {
				var newRow = {
				//lx : "保留非全局角色"
				};
				grid2.addRow(newRow, 0);
				grid2.beginEditRow(newRow);
			}
	
			//删除Headers选中
			function deleteHeadersSelected() {
				grid.removeRows(grid.getSelecteds(), false);
				setGridData();
			}
			
			//删除Parameters选中
			function deleteParametersSelected() {
				grid2.removeRows(grid2.getSelecteds(), false);
				setGridData();
			}
			
			function setGridData(){
				var datas = grid.getData();
				var array = [];
				for (var i = 0; i < datas.length; i++) {
					var row = datas[i];
					array.push({
						"inField" : row.inField,
						"inName" : row.inName,
						"inType" : row.inType,
					});
				}
				mini.get('inData').setValue(JSON.stringify(array));
				
				var datas2 = grid2.getData();
				var array2 = [];
				for (var i = 0; i < datas2.length; i++) {
					var row2 = datas2[i];
					console.log(row2);
					array2.push({
						"outField" : row2.outField,
						"outName" : row2.outName,
						"outType" : row2.outType,
					});
				}
				mini.get('outData').setValue(JSON.stringify(array2));
			}
			
			function getOperationNames(e){
				var url = mini.get('url').getValue();
				var httpLogin = mini.get('httpLogin').getValue();
				var httpPassword = mini.get('httpPassword').getValue();
				epoint.execute('getOperations','',[ url,httpLogin,httpPassword ],function(data){
					console.log(data);
					if(data!=null&&data.length>0){
						mini.get('operationName').setData(data);
						epoint.alert('获取成功');
					}else{
						epoint.alert('获取失败,请检查url');
					}
				});
				
			}
		</script>
</body>

</html>