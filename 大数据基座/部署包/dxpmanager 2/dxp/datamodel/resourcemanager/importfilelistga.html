<!DOCTYPE html>
<html>

<head>
<title>数据管理</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<script src="../../../frame/fui/js/cssboot.js"></script>
<script>
	SrcBoot.output([ 'modelga/style/globalresource.css' ]);
</script>
</head>

<body>
	<div class="page-loading"></div>
	<div class="page-toolbar clearfix">
			<!-- <span class="toolbar-button" onclick="importfile()">导入文件</span> -->
		<span class="toolbar-button" onclick="if(mini.get('datagrid').getSelecteds()==0){epoint.alert('请选择要删除的记录!');} else {epoint.confirm('该操作会同步删除导入的数据表及元数据！ 确认要删除吗?','',deleteSelected);}">删除</span>	
	</div>
	<!--<div class="fui-search" primaryControl="tableName" opened="false">
		&lt;!&ndash; 表单布局 &ndash;&gt;
		<div class="fui-form" id="fui-form">
			<div role="form">
				&lt;!&ndash; 2列 &ndash;&gt;
				<div role="row">
					<div role="control" label="数据名称" starred="false">
						<input bind="tableName" id="tableName" class="mini-textbox" />

					</div>
				</div>
			</div>
		</div>
		&lt;!&ndash; 搜索按钮 &ndash;&gt;
		<a role="searcher" callback="searchData"></a>
	</div>-->
	<div class="fui-condition">
		<!-- 表单布局 -->
		<div class="fui-form" id="fui-form">
			<div role="form">
				<!-- 2列 -->
				<div role="row">
					<div role="control" label="表名称" starred="false">
						<input bind="tableName" id="tableName" class="mini-textbox" />

					</div>
				</div>
			</div>
		</div>
		<!-- 搜索按钮 -->
		<a role="searcher" callback="searchData"></a>
	</div>
	<div class="fui-content">
		<div id="datagrid" class="mini-datagrid" sortOrder="desc"
			idField="rowguid" multiSelect="true"
			style="width: 100%; height: calc(100% - 30px)" allowResize="true"
			allowCellValid="true" action="getTableData" showPager="true"
			allowCellEdit="true" allowCellSelect="true" editNextOnEnterKey="true"
			editNextRowCell="true">
			<div property="columns">
				<div type="checkcolumn" width="20"></div>
				<div type="indexcolumn" headerAlign="center" width="20">序</div>
				<div field="rowguid" width="80" headerAlign="center" visible="false"></div>
				<div field="TableName" width="80" headerAlign="center"
					vtype="required">表名称</div>
				<div field="fromtable" width="80" headerAlign="center">文件名称</div>
				<div field="status" width="40" headerAlign="center" align="center"
					renderer="onStatusRender">导入状态</div>
				<div field="importDate" width="40" headerAlign="center"
					align="center" dateFormat="yyyy-MM-dd HH:mm:ss"
					data-options="{'format':'yyyy-MM-dd HH:mm:ss'}">导入时间</div>
				<div field="userguid" width="40" headerAlign="center" align="center">创建人</div>
				<!-- 				<div width="40" headerAlign="center" align="center"
					renderer="onEditRenderer">修改</div> -->
				<div width="40" name="show" headerAlign="center" align="center"
					renderer="onShowRenderer">数据结构</div>
				<div width="40" headerAlign="center" align="center"
					renderer="onDataRenderer">查看数据</div>
				<div field="download" width=40 headerAlign="center" align="center"
					renderer="onDownLoadRenderer">日志下载</div>
				 <div width="80" headerAlign="center" align="center"
                renderer="onGrantRenderer">授权
                </div>
				<div field="tabletype" visible="false"></div>
				<div field="dsid" visible="false"></div>
				<div field="tableid" visible="false"></div>
			</div>
		</div>
		<form id="download_form" method="post" enctype="multipart/form-data"></form>
	</div>
	<script src="../../../frame/fui/js/jsboot.js"></script>
	<script>
		//<![CDATA[
		//初始化页面
		epoint.initPage("importfilelistaction");

		var grid = mini.get("datagrid");
		grid.on("load", function(e) {
			var rows = e.sender.findRows();
			for (var i = 0; i < rows.length; i++) {
				grid.beginEditRow(rows[i]);
			}
		});

		// 绘制修改按钮
		var onEditRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "openEdit",
					"tableid,tabletype");
		}

		//绘制授权按钮
		var onGrantRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-gear",
					"grant","tableid,status");
		}


		function grant(data){
			if(data.status==2){
				 epoint.openDialog('授权',
						'./settingallowtoall?tableID='
								+ data.tableid);
			}else{
				epoint.alert('当前记录未导入成功，不可以授权！','','','warning');
			}
		}

		function grantbat(){
            var datagrid = mini.get('datagrid');
			var ids = datagrid.getSelectedIds();
			if (ids.length > 0) {
			   var id= ids.join(',');
                epoint.openDialog('授权',
					'./settingallowtoall?tableID='
							+ id, function(ret) {
					});

			}else{
			    epoint.alert('请选择要授权的数据表记录！');
			}

		}

		//修改
		function openEdit(e) {
			epoint.openDialog('修改数据表', './tablebasicinfoedit?tableID='
					+ e.tableid, function() {
				epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
			}, {
				'width' : 1000,
				'height' : 400
			});
		}

		// 绘制表结构按钮
		var onShowRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-doc", "tableStruct",
					"tableid,tabletype");
		};

		//绘制查看数据按钮
		var onDataRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-search",
					"searchRecord","tableid");
		}

		//查看数据
		function searchRecord(tableid) {
			if (tableid == "") {
				epoint.alert("未查询到导入表元数据！请检查是否成功导入。");
			} else {
				epoint.openTopDialog('数据列表', './viewtabledata?tableID=' + tableid,
						function(ret) {

						});
			}
		}

		// 表结构

		function tableStruct(e) {
			if (e.tableid == "") {
				epoint.alert("未查询到导入表元数据！请检查是否成功导入。");
			} else {
				epoint.openDialog('数据表结构', './tablestructlist?tableID='
						+ e.tableid, function() {
					epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
				});
			}
		}

		// 表格的搜索
		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		}

		//导入文件
		function importfile() {
			epoint.openTopDialog('导入数据选择', './importfile',
					searchData, {
						'width' : 700,
						'height' : 550
					});
		}

		function onStatusRender(e) {
			var color = 'red';
			var value = '成功';
			if (e.value == '2') {
				color = '#00a65a';
				value = '成功';
			} else if (e.value == '3') {
				color = '#dd4b39';
				value = '导入失败';
			} else if (e.value == '1') {
				color = '#f39c12';
				value = '导入中';
			} else {
				color = '#d2d6de';
			}
			return '<span class="label" style="background-color:' + color + ';border-radius:.25em;color:white;padding: .2em .6em .3em;">'
					+ value + '</span>';
		}

		// 删除
		function deleteSelected() {
			epoint.execute('deleteSelected', '', function(data) {
				if (data.msg) {
					epoint.alert(data.msg,'','','success');
					searchData();
				}
			});
		}

		//绘制下载按钮
		function onDownLoadRenderer(e) {
			return epoint.renderCell(e, "action-icon icon-download",
					"download", 'rowguid,flowguid');
		}

		function download(e) {
			//先判断是否运行中，运行中的截至
			epoint.execute("checkFlowStatus",'', [e.rowguid], function(data){
				if(data){
					var form = document.getElementById('download_form');
					form.action = "dxpschedulerloglistaction.action?cmd=downloadLog&rowGuid="
							+ data.logid+"&guid="+e.rowguid+"&type=import";
					form.submit();
				}
			});
		}
		//_$t
	</script>

</body>
</html>