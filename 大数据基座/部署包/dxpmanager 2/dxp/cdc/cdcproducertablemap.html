<!DOCTYPE html>
<html lang="zh-CN">

<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>保存</title>
<script src="../../frame/fui/js/cssboot.js"></script>
</head>

<body>
	<!-- toolbar区域 -->
	<div class="fui-toolbar" id="btns"
		style="padding-top: 10px; border-bottom: none;">
		<div class="btn-group mr10">
			<a id="savetype" class="mini-button mini-btn-primary" onclick="save">保存修改</a>
			<a class="mini-button mini-btn-primary" onclick="epoint.closeDialog">关闭</a>
		</div>
		<input id="tableData" name="tableData" style="display: none;"
			class="mini-textbox">
			
		
	</div>
	<div class="fui-condition" style="width: 75%;">
		<div class="fui-form" id="fui-form">
			<div id="cform" role="form">
				<div role="row">
					<div role="control" label="表名" style="width: 30%;">
						<input id="sourceTable" class="mini-textbox" style="margin-left: -10px;"/>
					</div>
				</div>
			</div>
		</div>
		<a role="searcher" callback="searchPrimaryKey"></a>
	</div>
	<table style="height: 40%;">
		<tr>
			<td>
				<div id="grid1" class="mini-datagrid"
					style="width: 100%; height: 100%; margin-top: 0px; margin-left: 15px;"
					multiSelect="true" resultAsData="true" showPager="false"
					action="getSourceGridData">
					<div property="columns">
						<div type="checkcolumn"></div>
						<div header="监听表" field="tablename"></div>
					</div>
				</div>
			</td>

			<td style="width: 60px; margin-left: 10px; text-align: center;">
				<input type="button" value=">" onclick="adds()"
				style="width: 50px; height: 30px; margin-left: 50px;" /><br /> <input
				type="button" value=">>" onclick="addAll()"
				style="width: 50px; height: 30px; margin-left: 50px;" /><br /> <input
				type="button" value="&lt;&lt;" onclick="removeAll()"
				style="width: 50px; height: 30px; margin-left: 50px;" /><br /> <input
				type="button" value="&lt;" onclick="removes()"
				style="width: 50px; height: 30px; margin-left: 50px;" /><br />
			</td>
			<td>
				<div id="grid2" class="mini-datagrid"
					style="width: 100%; height: 361px; margin-left: 30px; margin-top: 0px"
					multiSelect="true" showPager="false" allowCellEdit="true"
					allowCellSelect="true">
					<div property="columns">
						<div type="checkcolumn"></div>
						<div header="已选监听表" field="tablename"></div>
					</div>
				</div> <input type="button" value="Up" onclick="upItem()"
				style="width: 55px; margin-left: 30px; margin-top: 30px;" /> <input
				type="button" value="Down" onclick="downItem()" style="width: 55px;" />
			</td>
			<td style="width: 50px; text-align: center; vertical-align: bottom">

			</td>
		</tr>

	</table>

	<script src="../../frame/fui/js/jsboot.js"></script>

	<script>
		var grid1 = mini.get("grid1");
		var grid2 = mini.get("grid2");
		var tablelinkStr;

		epoint.initPage('dxpcdcproducertablemapaction','',function(data){
			tablelinkStr = localStorage.getItem("tablelink");
			getAll();
		});

		function getTableLink() {
			var items3 = grid2.getData();
			var tableLink = [];
			for (var i = 0; i < items3.length; i++) {
				tableLink[i] = {
					"tablename" : items3[i].tablename
				}
			}
			return mini.encode(tableLink);
		}

		//保存修改
		function save() {
			if (epoint.validate()) {
				// 把表格的数据拿出来放到隐藏域中
				var tableLink = getTableLink();
				console.log(tableLink);
				epoint.closeDialog(tableLink);
			}
		}

		function adds() {
			//获取源字段中数据并解析
			var items = grid1.getSelecteds();
			var length = items.length
			for (var i = 0; i < length; i++) {
				var items3 = clone(items[i]);
				grid1.removeRow(items[i]);
				grid2.addRow(items3, 0);
			}
		}

		function removeAll() {
			var items3 = grid2.getData();
			grid2.removeRows(items3);
			grid1.load();
		}

		function addAll() {
			var items = grid1.getData();
			var length = items.length;
			for (var i = 0; i < length; i++) {
				grid1.removeRow(items[i]);
				grid2.addRow(items[i], 0);
			}
		}

		function removes() {
			var items3 = grid2.getSelecteds();
			var length = Object.keys(items3).length
			grid2.removeRows(items3);
			
			for (var i = 0; i < length; i++) {
				var items = grid1.getData();
				var length1 = Object.keys(items).length;
				var flag1 = true;
				for (var j = 0; j < length1; j++) {
					if(items[j].tablename.toLowerCase() == items3[i].tablename.toLowerCase()){
						flag1 = false;
					}
				}
				if(flag1){
					grid1.addRow(items3[i]);
				}
			}
		}

		function upItem() {
			var items = grid2.getSelecteds();
			grid2.moveUp(items);
		}
		function downItem() {
			var items = grid2.getSelecteds();
			grid2.moveDown(items);
		}
		
		function getAll() {
			if(tablelinkStr == ''){
				return;
			}
			var items = grid1.getData();
			var tablelinkArray=JSON.parse(tablelinkStr);
			var length1 = Object.keys(items).length;
			var length3 = Object.keys(tablelinkArray).length;
			for (var i = 0; i < length3; i++) {
				var res1 = '';
				for (var j = 0; j < length1; j++) {
					if(items[j].tablename.toLowerCase() == tablelinkArray[i].tablename.toLowerCase()){
						res1 = items[j];
						break;
					}
				}
				grid1.removeRow(res1);
				grid2.addRow(res1, 0);
			}
		 }
		
		//搜索源表
		function searchPrimaryKey() {
			var sourceTable = mini.get("sourceTable").getValue();
			if (sourceTable != "") {
				var items = grid1.getData();
				var j = 0;
				for (var i = 0; i < items.length; i++) {
					var fromTable = items[i].tablename;
					var sourceTableReg = null;
					sourceTableReg = new RegExp(sourceTable, "i");
					if (sourceTableReg.test(fromField)) {
						grid1.moveRow(
								grid1.getRow(i), j);
						j++;
					}
				}
			}
		}
		
		function clone(Obj){
			var buf;
			if(Obj instanceof Array){
				buf=[];
				var i=Obj.length;
				while(i--){
					buf[i]=clone(Obj[i]);
				}
				return buf;
			}
			else if(Obj instanceof Object){
				buf={};
				for(var k in Obj){
					buf[k]=clone(Obj[k]);
				}
				return buf;
			}else{
				return Obj;
			}
		}
		
	</script>
</body>

</html>