<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>cdc监听任务</title>
<script src="../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>

	<div class="fui-left">
		<div role="head" title="选择分组">
			<a class="mini-button mini-btn-primary r" onclick="addGroup()">新增分组</a>
		</div>
		<div role="body">
			<ul id="tree" class="mini-filtertree" textField="text" idField="id"
				parentField="pid" action="dxpflowgroupaction.getTreeModel"
				resultAsTree="false" filterMode="server">
			</ul>
		</div>
	</div>

	<div class="fui-right">
		<!-- 按钮区域 -->
		<div class="fui-toolbar">
			<div class="btn-group">
				<a class="mini-button mini-btn-primary " id="addJob"
					onclick="add()">新增任务</a>
				<a class="mini-button mini-btn-primary" id="start"
					onclick="startJob()">启动</a> <a class="mini-button mini-btn-warning"
					id="stop" onclick="stopJob()">停止</a> <a
					class="mini-button mini-btn-primary" id="move" onclick="moveFlow()">移动</a>
				<a class="mini-button mini-btn-danger" id="del"
					onclick="deleteFlow()">删除</a> <a
					class="mini-button mini-btn-warning" id="fresh"
					onclick="freshFlowCache()">刷新缓存</a>
				<!-- <a class="mini-button mini-btn-warning" id="fresh"
					onclick="resetSite()">重置位点</a> -->
			</div>
		</div>

		<!-- 条件区域 -->
		<div class="fui-search" primaryControl="flowName" opened="false">
			<!-- 表单布局 -->
			<div class="fui-form" id="fui-form">
				<div role="form">
					<div role="row">
						<div role="control" label="流程名称">
							<input bind="dataBean.flowName" id="flowName"
								class="mini-textbox" />
						</div>
						<div role="control" label="状态">
							<input bind="status" id="status" class="mini-combobox"
								action="getStatusSelectList" />
						</div>
					</div>
					<div role="row">
						<div role="control" label="生成时间(开始)">
							<input bind="generateBegin" id="beginDate"
								class="mini-datepicker"  onvaluechanged="onValueChanged"/>
						</div>
						<div role="control" label="生成时间(结束)">
							<input bind="generateEnd" id="endDate"
								class="mini-datepicker"  onvaluechanged="onValueChanged"/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="所属节点域">
							<input bind="nodeGuid" class="mini-combobox" 
								action="getNodeGuidList" />
						</div>
					</div>
					<!-- <div role="row">
						<div role="control" label="最新执行结果">
							<input bind="logStatus" id="logStatus" class="mini-combobox"
								action="getLogStatusSelectList" />
						</div>
						<div role="control" label=""></div>
					</div> -->
					<input bind="groupGuid" id="groupGuid" class="mini-hidden" />
				</div>
			</div>

			<!-- 搜索按钮 -->
			<a role="searcher" callback="searchData"></a>
		</div>

		<!-- 表格区域 -->
		<div class="fui-content">
		<form id="download_form" method="post" enctype="multipart/form-data"></form>
			<div id="datagrid" name="datagrid" class="mini-datagrid"
				idField="rowguid" multiSelect="true"
				style="width: 100%; height: 100%;" showPager="true" 
				action="getDataGridData">
				<div property="columns">
					<div type="checkcolumn" width="35"></div>
					<div type="indexcolumn" width="45" headerAlign="center">序</div>
					<div field="flowname" width="120" headerAlign="center" align="left">流程名称
					</div>
					<div field="nodename" width="100" headerAlign="center"
						align="center">节点域</div>
					<div field="generatedate" width="160" headerAlign="center"
						data-options="{'format':'yyyy-MM-dd HH:mm:ss'}" allowSort="true"
						allowOrder="desc" dateFormat="yyyy-MM-dd HH:mm:ss" align="center">生成日期
					</div>
					<div field="operaDate" width="160" headerAlign="center"
						data-options="{'format':'yyyy-MM-dd HH:mm:ss'}" allowSort="true"
						allowOrder="desc" dateFormat="yyyy-MM-dd HH:mm:ss" align="center">更新日期
					</div>
					<div field="status" width="80" headerAlign="center" align="center"
						renderer="onStatusRender">状态</div>
					<!-- <div field="logstatus" width="120" headerAlign="center" align="center"
						renderer="onLogStatusRender">最新执行结果</div> -->
					<div field="rowguid" width="60" headerAlign="center" align="center"
						renderer="onEditRenderer">编辑</div>
					<div field="export" width="80" headerAlign="center" align="center"
						renderer="onExportRenderer">导出作业</div>
					<div field="log" width="80" headerAlign="center" align="center"
						renderer="onLogRenderer">作业日志</div>
				</div>
			</div>
		</div>
	</div>

	<script src="../../rest/resource/jsboot"></script>
	<script>
    epoint.initPage('dxpcdcproducerlistaction', '', function (data) {
        if (mini.get('datagrid').getSelecteds().length === 0) {
            buttonDisable();
        }
    });

    var tree = mini.get('tree');
    tree.on('beforenodeselect', function (e) {
        if (e.node.id === 'f9root') {
            mini.get('groupGuid').setValue('');
        } else {
            mini.get('groupGuid').setValue(e.node.id);
        }
        searchData();
    });

    var grid = mini.get('datagrid');
    //隐藏第五列生成状态和第八列调度状态
    grid.on('selectionchanged', function (e) {
        if (e.selecteds.length > 0) {
            buttonEnable();
        } else {
            buttonDisable();
        }
    });

    function addGroup() {
        epoint.openDialog("新增分组", "../flowinfo/flowgroupadd", function () {
            epoint.refresh('tree');
        }, {
            'width': 600,
            'height': 400
        })
    }

    function moveFlow() {
        let array = grid.getSelecteds();
        let guidArray = [];
        for(var i=0;i<array.length;i++){
            guidArray.push(array[i].rowguid);
        }
        let guid = guidArray.join(",");
        epoint.openDialog("移动集成", "../flowinfo/flowgroupselect?guid=" + guidArray, function(){
        	searchData();
        }, {
            'width': 700,
            'height': 400
        })
    }

    function searchData() {
        epoint.refresh(['datagrid', 'fui-form']);
    }

    function startJob() {
		// start标志变量启动作业
		if (mini.get('datagrid').getSelecteds().length == 0) {
			epoint.alert('请选择启动的作业!', '', null, 'warning');
		} else {
			 mini.showMessageBox({
	                title: "启动确认",
	                iconCls: "mini-messagebox-question",
	                buttons: ["yes", "no"],
	                message: "启动任务后是否立即执行一次？",
	                callback: function (action) {
	                    if(action=='yes'){
	                    	start('1');
	                    }else{
	                    	start('0');
	                    }
	                }
	        });
		}
	}
	
	function start(type){
		epoint.execute('doJobWork', '', ['start',type], function(data) {
			if (data.msg.indexOf('成功') != -1) {
				epoint.alert(data.msg, '', function() {
					epoint.refresh([ 'datagrid', 'fui-form' ], '',
									true);
				}, 'success');
			} else {
				epoint.alert(data.msg, '', '', 'warning');
			}
		});
	}

    	function stopJob() {
    		if (mini.get('datagrid').getSelecteds().length == 0) {
    			epoint.alert('请选择停止的作业!', '', null, 'warning');
    		} else {
    			epoint.confirm('确认要停止吗?', '', function() {
    				// stop 标志变量停用作业
    				epoint.execute('doJobWork', '', 'stop', function(data) {
    					if (data.msg.indexOf('成功') != -1) {
    						epoint.alert(data.msg, '', function() {
    							epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
    						}, 'success');
    					} else {
    						epoint.alert(data.msg);
    					}
    				});
    			});
    		}
    	}


	var onScheduleRenderer = function(e) {
		if(e.record.integrationType=='4'&&e.record.msmqtype=='0'){
			return "";
		}
		if(e.record.isdagchild){
			return "";
		}
		return epoint.renderCell(e, "action-icon modicon-97",
					"openScheduleList");
	};

	function openScheduleList(e) {
		epoint.openDialog('调度配置', '../flowinfo/taskconfigNew?guid=' + e, null, {
			'width' : 700,
			'height' : 400
		});
	}

	var onLogRenderer = function(e) {
		return epoint.renderCell(e, "action-icon modicon-49", "openLogList","rowguid,flowname");
	};

	function openLogList(e) {
		epoint.openDialog(e.flowname, '../flowinfo/dxpschedulerloglist?guid=' + e.rowguid, null, {
			'width' : 1000,
			'height' : 600
		});
	}

	function deleteFlow() {
		if (mini.get('datagrid').getSelecteds().length == 0) {
			epoint.alert('请选择要删除的交换!', '', null, 'warning');
		} else {
			var select=mini.get('datagrid').getSelecteds();
			for(var i=0;i<select.length;i++){
				if(select[i].isdagchild){
					epoint.alert(select[i].flowname+"是DAG子流程，不能被删除，请排除后再操作！");
					return;
				}
			}
			epoint.confirm('确认删除吗?', '', function() {
				epoint.execute('deleteFlow', '', function(data) {
					if (data.msg.indexOf('成功') != -1) {
						epoint.alert(data.msg, '', function() {
							epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
						}, 'success');
					} else {
						epoint.alert(data.msg);
					}
				});
			});
		}
	}
	
	function freshFlowCache() {
		if (mini.get('datagrid').getSelecteds().length == 0) {
			epoint.alert('请选择要刷新的交换!', '', null, 'warning');
		} else {
			epoint.confirm('确认刷新吗?', '', function() {
				epoint.execute('freshFlowCache', '', function(data) {
					if (data.msg.indexOf('成功') != -1) {
						epoint.alert(data.msg, '', function() {
							epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
						}, 'success');
					} else {
						epoint.alert(data.msg);
					}
				});
			});
		}
	}
	
	function resetSite() {
		if (mini.get('datagrid').getSelecteds().length == 0) {
			epoint.alert('请选择要重置的任务!', '', null, 'warning');
		} else {
			epoint.confirm('确认重置吗?', '', function() {
				epoint.execute('resetSite', '', function(data) {
					if (data.msg.indexOf('成功') != -1) {
						epoint.alert(data.msg, '', function() {
							epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
						}, 'success');
					} else {
						epoint.alert(data.msg);
					}
				});
			});
		}
	}

	function onStatusRender(e) {
		var color = 'red';
		if (e.value == '交换中') {
			color = '#f39c12';
		} else if (e.value == '已停止') {
			color = '#d2d6de';
		} else if (e.value.indexOf('运行中') != -1) {
			color = '#00a65a';
		} else {
			color = '#dd4b39';
		}
		return '<span class="label" style="background-color:' + color + ';border-radius:.25em;color:white;padding: .2em .6em .3em;">'
				+ e.value + '</span>';
	}
	
	function onLogStatusRender(e) {
		var color = 'red';
		if (e.value == '-1') {
			color = '#f39c12';
			e.value = "进程中断";
		} else if (e.value == '1') {
			color = '#00a65a';
			e.value = "交换成功";
		} else if (e.value = 0) {
			color = '#red';
			e.value = "交换失败";
		} else {
			color = '#d2d6de';
			e.value = "未执行";
		}
		return '<span class="label" style="background-color:' + color + ';border-radius:.25em;color:white;padding: .2em .6em .3em;">'
				+ e.value + '</span>';
	}

	function onEditRenderer(e) {
		return epoint.renderCell(e, "action-icon modicon-64", "edit","rowguid,integrationType,msmqtype");
	}
	function onExportRenderer(e) {
		return epoint.renderCell(e, "action-icon modicon-86", "exportKTR");
	}

	function exportKTR(e) {
		var form = document.getElementById('download_form');
		form.action = "dxpintegraflowinfolistaction.action?cmd=exportKTR&flowGuid="+e;
		form.submit();
	}

    function buttonEnable() {
        mini.get('move').enable();
        mini.get('del').enable();
        mini.get('stop').enable();
        mini.get('start').enable();
        mini.get('fresh').enable();
    }

    function buttonDisable() {
        mini.get('move').disable();
        mini.get('del').disable();
        mini.get('stop').disable();
        mini.get('start').disable();
        mini.get('fresh').disable();
    }
    
	function onValueChanged(e) {
    	var sender=e.sender;
    	if(sender.id=='beginDate'){
    		var todate=mini.get('endDate').getValue();
    		if(todate){
        		if(sender.value.getTime()>todate.getTime()){
        			epoint.alert('开始时间不能大于结束时间！','',function(){
        				epoint.clear(sender.id);
        			});
        		}
    		}
    	}else if(sender.id=='endDate'){
    		var bedate=mini.get('beginDate').getValue();
    		if(bedate){
        		if(sender.value.getTime()< bedate.getTime()){
        			epoint.alert('结束时间不能小于开始时间！','',function(){
        				epoint.clear(sender.id);
        			});
        		}
    		}
    	}
    }
	
    function add() {
		var groupid=mini.get('groupGuid').getValue();
		window.location.href=Util.getRightUrl("dxp/cdc/cdcproduceradd?groupid="+groupid);
    }
    
	function edit(data){
		window.location.href=Util.getRightUrl("dxp/cdc/cdcproduceredit?rowguid="+data.rowguid);
	}
</script>
</body>
</html>