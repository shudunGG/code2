<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>文档编辑</title>
<script src="../../../../../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>

	<!-- toolbar区域 -->
	<div class="fui-toolbar" id="btn">
		<div class="btn-group mr10">
			<a class="mini-button" iconCls="icon-save" id="save"
				onclick="save();">发布</a>
		</div>
	</div>

	<!-- 内容区域 -->
	<div class="fui-content">
		<div class="fui-accordions">
			<div role="accordion">
				<div role="head" title="基本信息"></div>
				<div role="body">
					<div id="fui-form" class="fui-form">
						<div role="row">
							<div role="control" label="上层标题" starred="true">
								<ul id="tree1" class="mini-treeselect" action="getTreeData"
									showRadioButton="true" showTreeIcon="true" textField="text"
									idField="id" onbeforenodeselect="beaforenodeselect"
									expandOnNodeClick="true" bind="parentTitleGuid">
								</ul>
							</div>
						</div>
						<div role="row">
							<div role="control" label="标题名称" starred="true">
								<input id="titlename" class="mini-textbox" bind="titleName"
									required="true" requiredErrorText="文档标题名称不能为空!" />
							</div>
						</div>
						<div role="row">
							<div role="control" label="文档概要" starred="true">
								<input id="outline" class="mini-textarea" bind="outline"
									required="true" requiredErrorText="文档概要不能为空!" />
							</div>
						</div>
						<div role="row">
							<div role="control" label="排序">
								<input id="orderNumber" class="mini-textbox" bind="orderNumber"
									vtype="int;range:0,99999999"/>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div role="accordion" opened="true" id="infocontent">
				<div role="head" title="信息内容"></div>
				<div role="body">
					<div class="fui-form" id="fui-form2">
						<div role="row">
							<div role="control" style="width: 100%; height: 350px;">
								<div id="editormd"></div>
							</div>
							<div class="mini-hidden" id="content" bind="content"></div>
							<div class="mini-hidden" id="mdcontent" bind="mdContent"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="../../../../../../../rest/resource/jsboot"></script>
	<script src="../../../../../../fui/js/widgets/mdeditor/mdConfig.js"></script>
	<script src="../../../../../epointworkflow/js/tableproperty.js"></script>

	<script>
		//<![CDATA[ 

		var docGuid;
		// 初始化页面
		epoint.initPage('apidocumentaction', '', initCallBack);

		function initCallBack(data) {

			docGuid = data.docGuid;

			var content = mini.get("content").getValue();
			var mdContent = mini.get("mdcontent").getValue();

			var url = epoint.dealRestfulUrl('apidocumentaction/uploadList');

			mdEditor.updateImageUrl({
				clipImageUrl : Util.getRootPath() + url
			});

			if ("" == mdContent) {
				mdContent = content;
			}
			mdEditor.renderEditor({
				content : mdContent
			});

			if (data.parentTitleName) {
				mini.get("tree1").setText(data.parentTitleName);
			}
		}

		function save() {
			mini.get("content").setValue(mdEditor.editor.getHTML());
			mini.get("mdcontent").setValue(mdEditor.editor.getMarkdown());
			if (epoint.validate()) {
				epoint.execute('save', [ 'fui-form', 'fui-form2' ],
						closeCallback);
			}
		}

		// 关闭操作的回调
		function closeCallback(data) {
			if (data.msg) {
				epoint.alertAndClose(data.msg, '', null, null, 'success');
			}
		}

		var mdEditor = MDEditor({
			id : "editormd",
			useStorage : false, // 是否启用本地存储
			clipImageUrl : Util.getRootPath()+ epoint.dealRestfulUrl('apidocumentaction/uploadList'), // 图片上传地址
			getReferInfoList : Util.getRootPath()+ epoint.dealRestfulUrl('apidocumentaction/getReferInfoList'),//获取文章列表
			imgUploadSuccess : function(file) {
			},
			imgUploadFaild : function(file) {
				// 图片上传失败
				console.log("上传失败");
				console.log(file);
			},
			imgUploadComplete : function(e) {
			},
			onMdLoad : function() {
				// 编辑器初始化结束的回调
				// console.log(mdEditor.clipImageUrl);
			},
			onMdChange : function(editor) {
				// 监听文档内容变化
				// console.log(editor.getMarkdown());
				// console.log(editor.getHTML());
			}
		});

		//无法选择自身
		function beaforenodeselect(e) {
			if (!e.node.ckr) {
				e.cancel = true;
			}
		}
		//]]>
	</script>
</body>
</html>