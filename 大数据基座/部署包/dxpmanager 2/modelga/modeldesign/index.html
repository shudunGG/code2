<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="../../frame/fui/js/cssboot.js"></script>
    <link rel="stylesheet" href="css/jRange.css"/>
    <link rel="stylesheet" href="css/index.css"/>
    <title>建模设计</title>
    <!-- <style type="text/css">
    .mini-panel .mini-panel-viewport {
        height: 135px !important;
    }
    </style> -->
</head>

<body>
<div class="main">
    <!-- 顶部标题 -->
    <div class="header clearfix">
        <div class="logo l">
            <!--img src="./images/title/logo.png" class="" alt="">
            <img src="./images/title/title.png" class="logo-title" alt="">-->
            <img src="./images/title/logo_sm.png" class="" alt="">
            <img src="./images/title/title_sm.png" class="logo-title" alt="">
        </div>
        <div class="right-group r">
            <div class="back-home title-btn l">返回首页</div>
            <div class="user title-btn l" id="user"></div>
            <div class="click-user">
                <p class="user-action-item logout">退出登录</p>
                <p class="user-action-item change-pwd">修改密码</p>
            </div>
        </div>
    </div>
    <!-- 下面内容 -->
    <div class="container clearfix">

        <!-- 左侧菜单 -->
        <div class="left-panel l" id="left-panel">
           <div class="move-line" id="move-line"></div>
            <ul class="left-panel-ul">
                <li class="top-menu-item pb-16 active">
                    <div class="menu-item">
                        <span class="top-menu-name text-ellipsis l">数据资源</span>
                        <span class="top-menu-count l text-ellipsis" id="top-resource">(30)</span>
                        <i class="top-menu-arrow"></i>
                    </div>
                    <!-- 数据资源内容【全局资源、我的资源】 -->
                    <div class="menu-item-content data-source">
                        <!-- <ul class="source-tab clearfix">
                            <li class="source-tab-item active l" data-type="all">全局资源</li>
                            <li class="source-tab-item l" data-type="my">我的资源</li>
                        </ul> -->
                        <div class="data-source-wrap">
                            <div class="all-source" id="source-all">
                                <div class="source-search">
                                    <input type="text" class="search-input" id="all-search"  autocomplete="off" placeholder="请输入关键词搜索">
                                    <i class="search-icon"></i>
                                </div>
                                <div class="source-panel" id="all-resource"></div>
                            </div>
                            <div class="my-source hidden" id="source-my">
                                <div class="source-search">
                                    <input type="text" class="search-input" id="my-search" autocomplete="off" placeholder="请输入关键词搜索">
                                    <i class="search-icon"></i>
                                </div>
                                <div class="source-panel" id="my-resource"></div>

                            </div>

                        </div>

                    </div>
                </li>
                <li class="top-menu-item pb-16">
                    <div class="menu-item">
                        <span class="top-menu-name text-ellipsis l">数据组件</span>
                        <span class="top-menu-count l text-ellipsis" id="top-component">(30)</span>
                        <i class="top-menu-arrow"></i>
                    </div>
                    <!-- 数据组件内容 -->
                    <div class="menu-item-content data-component">
                        <div class="source-search mt-14">
                            <input type="text" class="search-input" id="data-search" autocomplete="off" placeholder="请输入关键词搜索">
                            <i class="search-icon"></i>
                        </div>
                        <div class="component-list">
                            <ul class="clearfix" id="data-component">
                                <li>
                                    <div>了解数据</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="top-menu-item pb-16">
                    <div class="menu-item">
                        <span class="top-menu-name text-ellipsis l">智能组件</span>
                        <span class="top-menu-count l text-ellipsis" id="top-ai">(30)</span>
                        <i class="top-menu-arrow"></i>
                    </div>
                    <div class="menu-item-content">
                        <div class="source-search mt-14">
                            <input type="text" class="search-input" id="ai-search" autocomplete="off"  placeholder="请输入关键词搜索">
                            <i class="search-icon"></i>
                        </div>
                        <!-- 智能组件 的内容  -->
                        <div class="component-list ai-component">
                            <ul class="clearfix" id="ai-component">

                            </ul>
                        </div>
                    </div>
                </li>
                <li class="top-menu-item">
                    <div class="menu-item">
                        <span class="top-menu-name text-ellipsis l">可视化组件</span>
                        <span class="top-menu-count l text-ellipsis" id="top-visual">(30)</span>
                        <i class="top-menu-arrow"></i>
                    </div>
                    <div class="menu-item-content">
                        <div class="source-search mt-14">
                            <input type="text" class="search-input" id="visual-search" autocomplete="off" placeholder="请输入关键词搜索">
                            <i class="search-icon"></i>
                        </div>
                        <!-- 可视化组件 的内容 -->
                        <div class="component-list visual-component">
                            <ul class="clearfix" id="visual-component">

                            </ul>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <!-- 右侧内容 -->
        <div class="right-panel l" id="right-panel">
            <!-- 图标操作 -->
            <div class="icon-group clearfix">
                <ul class="left-icon-group l">
                    <li class="icon-item top-item mr-18  l" data-type="savedata" title="Ctrl+s">
                        <div class="func-release">
                            <i class="handle-icon l handle-icon-save"></i>
                            <p class="handle-icon-text">保存当前画布</p></div>
                    </li>
                    <li class="icon-item top-item mr-18 l" data-type="save">
                        <i class="handle-icon l handle-icon-save"></i>
                        <p class="handle-icon-text">保存</p>
                    </li>
                    <li class="icon-item top-item mr-18 l" data-type="othersave">
                        <i class="handle-icon l handle-icon-other"></i>
                        <p class="handle-icon-text">另存</p>
                    </li>
                    <!-- <li class="icon-item-split l mr-18"></li>
                    <li class="icon-item top-item mr-18 l" data-type="prev">
                        <i class="handle-icon l handle-icon-prev"></i>
                        <p class="handle-icon-text">撤销</p>
                    </li>
                    <li class="icon-item top-item mr-18 l" data-type="next">
                        <i class="handle-icon l handle-icon-next"></i>
                        <p class="handle-icon-text">恢复</p>
                    </li>
                    <li class="icon-item-split l mr-18"></li> -->
                    <li class="icon-item top-item mr-18 l" data-type="clear">
                        <i class="handle-icon l handle-icon-del"></i>
                        <p class="handle-icon-text">清空</p>
                    </li>
                    <li class="icon-item top-item mr-18 l top-item-scale" data-type="scale">
                        <i class="handle-icon l handle-icon-scale"></i>
                        <p class="handle-icon-text">缩放</p>
                    </li>
                    <li class="icon-item top-item l mr-18" data-type="init">
                        <i class="handle-icon l handle-icon-init"></i>
                        <p class="handle-icon-text">定位</p>
                    </li>
                    <li class="icon-item top-item l mr-18" data-type="del">
                        <i class="handle-icon l handle-icon-del"></i>
                        <p class="handle-icon-text">删除</p>
                    </li>
                    <li class="icon-item top-item l" data-type="layout">
                        <i class="handle-icon l handle-icon-init"></i>
                        <p class="handle-icon-text">排版</p>
                    </li>
                </ul>
                <ul class="right-icon-group r">
                    <li class="icon-item top-item mr-18 l" data-type="do">
                        <i class="handle-icon l handle-icon-do"></i>
                        <p class="handle-icon-text" id="func-log">执行</p>
                    </li>
                    <li class="icon-item top-item l" data-type="release">
                        <i class="handle-icon l handle-icon-release"></i>
                        <p class="handle-icon-text">发布</p>
                    </li>
                </ul>

                <div class="scale-box clearfix" id="scale-box">
                    <div class="scale-move">
                        <i class="scale-item min-icon l" data-type="min">-</i>
                        <div class="head-scale l">
                            <input class="head-range" id="range-scale" type="hidden" value="1"/>
                        </div>
                        <i class="scale-item max-icon l" data-type="max">+</i>
                    </div>
                    <div class="scale-num clearfix">
                        <span class="l scale-split">50%</span>
                        <span class="l scale-split">80%</span>
                        <span class="l scale-split">100%</span>
                        <span class="l scale-split">120%</span>
                        <span class="l scale-split">150%</span>
                    </div>

                </div>
            </div>
            <!-- 中间图表 -->
            <div class="chart-wrap">
                <!--<div class="chart-legend">
                    <i class="legend-item legend-local l"></i>
                    <span class="l">数据源</span>
                    <i class="legend-item legend-resource l"></i>
                    <span class="l">目标数据源</span>

                </div>-->
                <div class="chart-canvas" id="chart-canvas"></div>
                <!-- 右键菜单 -->
                <div id="contextMenu" class="contextMenu">
                    <ul>
                        <li data-type="config" class="cxm cxm-config"><i class="icon-item config-icon"></i>配置</li>
                        <li data-type="preview" class="cxm"><i class="icon-item preview-icon"></i>重新运行</li>
                        <li data-type="openpreview" class="cxm"><i class="icon-item preview-icon"></i>打开预览</li>
                        <li data-type="sqlpreview" class="cxm"><i class="icon-item preview-icon"></i>预览SQL</li>
                        <!-- <li data-type="save" class="cxm cxm-save"><i class="icon-item save-icon"></i>结果保存</li> -->
                        <!-- <li data-type="copy" class="cxm cxm-copy"><i class="icon-item copy-icon"></i>复制</li> -->
                        <li data-type="delete" class="cxm cxm-delete"><i class="icon-item delete-icon"></i>删除</li>
                    </ul>
                </div>
                <!-- 双击背景弹出框 -->
                <div class="design-layer" id="design-layer">
                    <div id="design-layer-move" class="design-layer-move"></div>
                    <div class="design-layer-search">
                        <input class="layer-search-input" type="text" placeholder="搜索"/>
                    </div>
                    <div class="design-layer-container">
                        <ul class="design-layer-ul">
                            <li></li>
                        </ul>
                    </div>
                </div>
                <!-- 节点提示 -->
                <div class="complete-tip" id="complete-tip"></div>

            </div>
            <!-- 预览数据、执行日志 -->
            <div class="log-panel unfold" id="log-panel">
                <div class="log-panel-move" id="log-panel-move"></div>
                <div class="log-panel-btn active" id="log-panel-btn"></div>
                <!-- 切换tab -->
                <div class="log-head clearfix">
                    <ul class="log-tab l">
                        <li id="datapreview" data-type="preview" class="log-tab-item log-item-preview active l">预览数据
                        </li>
                        <li id="logpreview" data-type="do" class="log-tab-item log-item-do l">执行日志</li>
                    </ul>
                    <div class="calc-text r">
                    	<div class="l" style="margin-right:15px">
                            <a class="button" id="clearLog" onclick="clearLog()" title="清理执行日志" >
                            	<input type="image" src="./images/top/icon_del.png" />
                            </a>
                        </div>
                    
                        <div class="l">
                            运算结果数据量<span id="count">0</span>条，展示量&nbsp;&nbsp;
                        </div>
                        <div class="l">
                            <input id="level" name="level"
                                   data="[{text:'10',id:'10'},{text:'20',id:'20'},{text:'50',id:'50'},{text:'100',id:'100'}]"
                                   textField="text" valueField="id" value="10" class="mini-combobox"
                                   style="width: 66px; height: 32px;vertical-align: middle"
                                   onValueChanged="changetabledata"/>
                        </div>

                    </div>
                    <!--  <div class="r temp-download">临时结果下载</div> -->

                </div>
                <!-- tab 对应的内容 -->
                <div class="log-list-box">
                    <!-- 预览数据内容 -->
                    <div class="log-list log-preview no-data" id="log-preview">
                        <div id="datagrid" class="mini-datagrid preview-list"
                             sortOrder="desc" idField="rowguid" multiSelect="true"
                             style="width: 100%; height: 100%;" allowResize="true"
                             showPager="false">
                            <div property="columns">
                                <!-- <div field="createtime" data-options="{'format':'yyyy-MM-dd'}">创建时间</div> -->
                            </div>
                        </div>
                    </div>
                    <!-- 执行日志内容 -->
                    <div class="log-list hidden" id="log-do">
                        <ul class="log-ul">
                            <!-- <li class="log-item">
                                <span class="log-name">开始解析</span>
                                <span class="log-time">2020-08-12 12:02:06</span>
                            </li>
                            <li class="log-item">
                                <span class="log-name">开始解析</span>
                                <span class="log-time">2020-08-12 12:02:06</span>
                            </li>
                            <li class="log-item">
                                <span class="log-name">开始解析</span>
                                <span class="log-time">2020-08-12 12:02:06</span>
                            </li>
                            <li class="log-item log-red">
                                <span class="log-name">开始解析</span>
                                <span class="log-time">2020-08-12 12:02:06</span>
                            </li>
                            <li class="log-item">
                                <span class="log-name">开始解析</span>
                                <span class="log-time">2020-08-12 12:02:06</span>
                            </li> -->
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


<script type="x-tmpl-mustache" id="left-menu-tpl">
        <li class="tree-item active">
            <div title="{{name}}({{tablename}})"
                data-grouptype="{{grouptype}}"
                data-modeltype="{{modeltype}}"
                data-step="{{step}}" 
                data-bagguid="{{bagguid}}" 
                data-sfname="{{sfname}}"  
                data-title="{{title}}" 
                data-tableid="{{tableid}}"  
                data-tablename="{{tablename}}"  
                data-designpage="{{designpage}}" 
                data-extraction="{{extraction}}" 
                data-name="{{name}}"  
                data-dsid="{{dsid}}" 
                data-icon="{{icon}}" 
                data-caninitview="{{canInitView}}" 
                data-url="{{url}}" 
                data-status="{{status}}" 
                data-message="{{message}}" 
                data-minlinks="{{minLinks}}" 
                data-maxlinks="{{maxLinks}}" 
                data-type="{{type}}" 
                data-id="{{id}}" 
                data-category="{{category}}" 
                style="padding-left:{{depLength}}px" 
                {{^hasChild}}draggable="true"{{/hasChild}} 
                class="tree-text text-ellipsis drag-item{{#hasChild}} sub{{/hasChild}} clearfix" 
               >
                <i class="menu-arrow{{^hasChild}} no-child{{/hasChild}} l"></i>
                {{^result}}<span class="l tree-name text-ellipsis">{{name}}</span>{{/result}}
                {{{result}}}
            </div>
            {{#hasChild}}{{{child}}}{{/hasChild}}
        </li>


</script>

<!-- 20200924 -->
<script type="x-tmpl-mustache" id="component-list-tpl">
        {{#list}}
            <li>
                <div class="component-title" style="width:170.47px;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;">
                    <span>{{name}}</span>
                    <i class="component-arrow"></i>
                </div>
                <ul class="clearfix component-list-ul">
                    {{#children}}
                        <li class="component-item drag-item l" title="{{name}}" data-step="{{step}}" data-bagguid="{{bagguid}}" data-sfname="{{sfname}}" data-title="{{title}}" data-tablename="{{tablename}}"  data-tableid="{{tableid}}" data-designpage="{{designpage}}" data-extraction="{{extraction}}" data-name="{{name}}" data-dsid="{{dsid}}" data-icon="{{icon}}" data-caninitview="{{canInitView}}" data-url="{{url}}" data-status="{{status}}" data-message="{{message}}" data-minlinks="{{minLinks}}" data-maxlinks="{{maxLinks}}" data-type="{{type}}" data-category="{{category}}" data-id="{{id}}"  data-grouptype="{{grouptype}}"
                data-modeltype="{{modeltype}}" draggable="true">
                            <div class="component-icon-box">
                                <img class="component-img" src="{{icon}}" alt="">
                            </div>
                            <p class="component-txt">{{^result}}{{name}}{{/result}}{{{result}}}</p>
                        </li>
                    {{/children}}
                </ul>
            </li>
        {{/list}}



</script>
<!-- 20200924 end -->

<script type="x-tmpl-mustache" id="component-item-tpl">
        {{#list}}
            <li class="component-item drag-item l" title="{{name}}"
                data-step="{{step}}"
                data-grouptype="{{grouptype}}"
                data-modeltype="{{modeltype}}"
                data-bagguid="{{bagguid}}" 
                data-sfname="{{sfname}}" 
                data-title="{{title}}" 
                data-tableid="{{tableid}}" 
                data-designpage="{{designpage}}" 
                data-extraction="{{extraction}}" 
                data-name="{{name}}" 
                data-dsid="{{dsid}}" 
                data-icon="{{icon}}" 
                data-caninitview="{{canInitView}}" 
                data-url="{{url}}" 
                data-status="{{status}}" 
                data-message="{{message}}" 
                data-minlinks="{{minLinks}}" 
                data-maxlinks="{{maxLinks}}" 
                data-type="{{type}}" 
                data-category="{{category}}" 
                data-id="{{id}}" draggable="true" >
                <div class="component-icon-box" >
                    <img class="component-img" src="{{icon}}" alt="">
                </div>
                <p class="component-txt">{{^result}}{{name}}{{/result}}{{{result}}}</p>
            </li>
        {{/list}}


</script>

<script type="x-tmpl-mustache" id="layer-item-tpl">
        {{#list}}
            <li class="tree-item">
                <div title="{{name}}" data-step="{{step}}" data-bagguid="{{bagguid}}" data-grouptype="{{grouptype}}"
                data-modeltype="{{modeltype}}" data-category='{{category}}' data-sfname="{{sfname}}" data-title="{{title}}" data-tableid="{{tableid}}" data-designpage="{{designpage}}" data-tablename="{{tablename}}" data-extraction="{{extraction}}" data-name="{{name}}" data-dsid="{{dsid}}" data-icon="{{icon}}" data-status="{{status}}" data-message="{{message}}" data-caninitview="{{canInitView}}" data-url="{{url}}" data-minlinks="{{minLinks}}" data-maxlinks="{{maxLinks}}" data-type="{{type}}" data-id="{{id}}" data-from="layer" style="padding-left:{{depLength}}px" class="text-ellipsis drag-item tree-text{{#hasChild}} sub{{/hasChild}}" data-id="{{id}}" data-url="{{url}}">
                    <!-- {{#icon}}<img class="tree-icon" src="{{icon}}">{{/icon}} -->
                    {{^result}}{{name}}{{/result}}{{{result}}}
                </div>
            </li>
        {{/list}}



</script>

<script type="x-tmpl-mustache" id="tip-item-tpl">
        {{#list}}
            <p><span>{{name}}：</span><span>{{val}}</span></p>
        {{/list}}
</script>


<script src="../../rest/resource/jsboot"></script>
<script src="js/go.js"></script>
<script src="js/jquery.jRange.js"></script>
<script src="../../dxp/datamodel/modelflow/js/IndexWebsocket.js"></script>
<script src="js/RealtimeDragSelectingTool.js"></script>
<script type="text/javascript">
		function uuid() {
		    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { 
		        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8); 
		        return v.toString(16); 
		    }); 
		}
		var grid= mini.get("datagrid");
		
		// 初始化回掉，动态生成列
		 function callbackinit(data) {
		 try{
                //adjustContentHeight();//隐藏的condition出来 要重新计算一次高度
                if (data) {
                    drawDynamicColumn(data);
                    //grid.reload();
                    grid.setData(epoint.decodeJson(data.tableData));
                }
            }catch(err){
              console.log(err)
            }
		}

		// 绘制动态列
	function drawDynamicColumn(data) {
			var tmp = data.columns;
			var columns = eval('(' + tmp + ')');
			grid.set(columns);
			grid.doLayout();
		}

    // 展示量改变后重新获取数据事件
    function changetabledata(e){
        // 运行成功后动态加载数据
        if(stepId){
            var showcount = e.value;
            var nodes = myDiagram.model.nodeDataArray;
            var nodeKeys = new Array();
            var nodeData;
            $(nodes).each(function(index, item) {
                if(stepId==item.key){
                    nodeData=item;
                }
            });
            $('.log-preview').addClass('data-loading');
            epoint.execute("getTablePreView", '',[nodeData,showcount], function(msg) {
                   if(msg){
                  	   callbackinit(msg);
                  	   stepId=nodeData.key;
                  	   myDiagram.model.setDataProperty(
                  	            				nodeData,
                                    			"count",
                                    			msg.count+"条"
                       );
                  	   $('#count').html(msg.count);
                   }
                   $('.log-preview').removeClass('data-loading');
                   $('.log-preview').removeClass('no-data');
             },true);
        }
    }

      var MSG_UNLOAD =
        "离开前请先保存，否则所做操作信息将全部丢失，是否离开?";
        var UnloadConfirm = {};
    // 启用监听浏览器刷新、关闭的方法
    UnloadConfirm.set = function(confirm_msg) {
        window.onbeforeunload = function(event) {
            event = event || window.event;
            event.returnValue = confirm_msg;
        };
    };
    // 关闭监听浏览器刷新、关闭的方法
    UnloadConfirm.clear = function() {
        window.onbeforeunload = function() {};
    };
    UnloadConfirm.set(MSG_UNLOAD);
    
    function clearLog(){
    	$("#log-do").empty();
    }

</script>

<script>
        SrcBoot.output([
            './js/config.js',
            './js/index.js'
        ])


</script>
</body>

</html>