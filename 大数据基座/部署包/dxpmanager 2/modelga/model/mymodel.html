<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <!--  <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <title>模型中心-我的模型</title>
    <script src="../../frame/fui/js/cssboot.js"></script>
    <script>
	SrcBoot.output([ './css/mymodel.css', '../style/globalresource.css' ]);

    </script>
    <style type="text/css">
    </style>
</head>

<body>
<div class="page-loading"></div>

<div class="fui-left" id="fui-tree">
    <div role="head" title="模型分类列表">
        <a class="action-icon icon-gear" title="编辑分类" onclick="editcategory()"
           style="float: right; margin-top: 8px"></a>
    </div>
    <div role="body">
        <ul id="tree" class="mini-filtertree" style="height: 100%" textField="text" idField="id" parentField="pid"
            action="dxpflowgroupaction.getTreeModel" resultAsTree="false" filterMode="server"></ul>
    </div>
</div>

<div class="fui-right">


    <div class="fui-toolbar my-model fui-condition" id="condition">
        <div class="l" style="color: #dfe2e3; font-size: 15px; font-weight: 200;">模型状态:</div>
        <span class="mini-combobox" style="margin-left: 10px;" textField="text" valueField="id" id="moduleState"
              bind="publishStatus" data="[{text:'所有',id:'9'},{text:'已发布',id:'1'},{text:'草稿',id:'0'}]"
              onvaluechanged="searchData"></span>
        <div class="l" style="color: #dfe2e3; font-size: 15px; font-weight: 200; margin-left: 10px;">模型类型:</div>
        <span class="mini-combobox" style="margin-left: 10px;" textField="text" id="moduleType" valueField="id"
              bind="dataBean.flowtype"
              data="[{text:'所有',id:'9'},{text:'图形建模',id:'1'},{text:'向导式建模',id:'2'}]" onvaluechanged="searchData"></span>

        <div class="r">
            <div class="diy-button-group l">
                <span class="diy-button btn-card"></span>
                <span class="diy-button btn-list active"></span>
            </div>
            <span class="mini-buttonedit fui-primary-search r" bind="dataBean.flowName"
                  onbuttonclick="searchData"></span>
            <input bind="groupGuid" class="mini-hidden" id="modelCategoryCode"/>
        </div>
    </div>
    <div class="page-toolbar clearfix"
         style="padding-left: 30px; padding-top: 5px; margin-bottom: -30px; position: absolute;">
        <span class="toolbar-button" onclick="deleteFlow()">删除模型</span>
        <span class="toolbar-button" onclick="upload()">导入模型</span>
        <span class="toolbar-button" onclick="download()">导出模型</span>
        <span class="toolbar-button" onclick="moveFlow()">移动分组</span>
        <span class="toolbar-button" onclick="public()">公开</span>
        <span class="toolbar-button" onclick="unpublic()">不公开</span>
    </div>
    <div class="fui-content my-model">
        <div id="grid-wrap" style="height: 100%;"></div>
    </div>
</div>
<script type="x/html" id="card-view-tpl">
        <div class="mini-datagrid card-grid"  id="datagrid"  style="height: 100%;" action="getMyDataGridData" pagerType="pagination" viewType="cardview" itemRenderer="cardItemRenderer" showColumns="false" pagesize="30">
            <div property="columns"></div>
        </div>
</script>
<script type="x/html" id="list-view-tpl">
        <div class="mini-datagrid" id="datagrid" style="height: 100%;" action="getMyDataGridData" autoload="true" pagerType="pagination" pagesize="20" multiSelect="true" idField="rowguid">
            <div property="columns">
				<div type="checkcolumn" width="30"></div>
                <div type="indexcolumn"></div>
                <div field="flowname"  headeralign="center" width="200">模型名称</div>
                <div field="generatedate" align="center"  headeralign="center" width="100" allowsort="true" data-options="{'format':'yyyy-MM-dd HH:mm:ss'}" dateFormat="yyyy-MM-dd HH:mm:ss">创建时间</div>
                <div field="createusername" align="center"  headeralign="center" width="90">创建用户</div>
                <div field="publishstatusname" align="center"  headeralign="center" width="60">模型状态</div>
                <div field="flowtype" align="center"  headeralign="center" width="60" renderer="flowtypeRender">模型类型</div>
                <div field="groupname" align="center"  headeralign="center" width="80">所在分组</div>
                <div field="dscribeinfo" align="center"  headeralign="center" width="90">模型描述</div>
                <div field="executecount" align="center"  headeralign="center" width="60">执行次数</div>
                <div field="nodeguid" visible="false"></div>
                <div field="flowtype" visible="false"></div>
                <div field="publishstatus" visible="false"></div>
                <div align="center"  headeralign="center" width="60"  renderer="editRender">编辑</div>
                <div align="center"  headeralign="center" width="60"  renderer="deleteRender">删除</div>
				<div align="center"  headeralign="center"  width="80"  renderer="configRender">运行策略配置</div>
            </div>
        </div>
</script>
<script type="x/html" id="card-item-tpl">
        <div class="card-item-wrap">
            <div class="card-item" data-id="{{flowname}}">
                <div class="card-item-state {{stateCls}}">{{publishstatusname}}</div>
                <p class="card-item-name">{{flowname}}</p>
                <p class="card-item-info">
                    <span class="card-item-user-name">{{createusername}}</span><span class="card-item-time">{{generatedate}}</span>
                </p>
                <p class="card-item-info">
                   	 <span style="margin-right: 40px;">执行次数: {{executecount}}</span>
                </p>
                <div class="card-item-footer clearfix">
                    <span class="card-item-button" onclick="onEditClick('{{rowguid}}','{{nodeguid}}','{{flowtype}}')"><span class="card-button-icon diy-grid-icon icon-edit" ></span>编辑</span>
	                 <span class="card-item-button" onclick="onRemoveClick('{{rowguid}}')"><span class="card-button-icon diy-grid-icon icon-trash" ></span>删除</span>    
					<span class="card-item-button" onclick="onConfigClick1('{{rowguid}}','{{publishstatus}}')"><span class="card-button-icon diy-grid-icon icon-config" ></span>运行策略配置</span>
                </div>
            </div>
        </div>

</script>
<script>
		var CARD_ITEM_TPL = document.querySelector('#card-item-tpl').innerHTML;
		function cardItemRenderer(record, rowIndex, meta) {
			meta.rowCls = 'card-item-row';
			if (record.publishstatusname == '草稿') {
				record.stateCls = "blue";
			} else if (record.publishstatusname == '已发布') {
				record.stateCls = "green";
			}
			return Mustache.render(CARD_ITEM_TPL, record);
		}

</script>
<script src="../../rest/resource/jsboot"></script>
<script>
		// 默认为卡片视图
		$($('#list-view-tpl').html()).appendTo($('#grid-wrap').empty());
		mini.parse();
		DtoUtils.bindBeforeLoad();
		epoint.initPage("dxpmodeldatadeveloplistaction");
		var tree = mini.get("tree");
        var grid=mini.get("datagrid");
		function editRender(e) {
			return epoint.renderCell(e, "diy-grid-icon icon-edit", "onEditClick1", "rowguid,nodeguid,flowtype");
		}

		function configRender(e) {
			return epoint.renderCell(e, "diy-grid-icon icon-config", "onConfigClick", "rowguid,publishstatus");
		}

		function deleteRender(e) {
			return epoint.renderCell(e, "diy-grid-icon icon-trash", "onRemoveClick", "rowguid");
		}

		function flowtypeRender(e){
			var typestr = "";
			if(e.value == '1'){
				typestr = "图形";
			}else{
				typestr = "向导式";
			}
			return typestr;
		}
		function onEditClick1(e) {
			if (e.flowtype == '2') {
				window.open(Util
						.getRightUrl("modelga/guidemodel/choose?rowguid="
								+ e.rowguid));
			}else{
				window.open(Util
						.getRightUrl("modelga/modeldesign/index?flowGuid="
								+ e.rowguid + "&nodeGuid=" + e.nodeguid
								+ "&flowtype=" + e.flowtype));
			}
		}

		function onEditClick(rowguid, nodeguid, flowtype) {
			if (flowtype == '2') {
				window.open(Util
						.getRightUrl("modelga/guidemodel/choose?rowguid="
								+ rowguid));
			}else{			
				window.open(Util
						.getRightUrl("modelga/modeldesign/index?flowGuid="
								+ rowguid + "&nodeGuid=" + nodeguid
								+ "&flowtype=" + flowtype));
			}
		}

		function onConfigClick(data) {
		    if(data.publishstatus!=1){
                epoint.alert('当前模型未发布，无法进行运行策略配置');
                return;
		    }
			epoint.openDialog("运行策略配置",
					'dxp/datamodel/modelflow/taskconfigNew?modelguid=' + data.rowguid
							+ '&isshow=0', null, {
						'width' : 700,
						'height' : 350

					});
		}

		function onConfigClick1(rowguid,publishstatus) {
		    if(publishstatus!=1){
                epoint.alert('当前模型未发布，无法进行运行策略配置');
                return;
		    }
			epoint.openDialog("运行策略配置",
					'dxp/datamodel/modelflow/taskconfigNew?modelguid=' + rowguid
							+ '&isshow=0', null, {
						'width' : 700,
						'height' : 350

					});
		}

		function searchData() {
			epoint.refresh([ 'datagrid','tree', 'condition' ]);
		}

		function onRemoveClick(e) {
			epoint.confirm('确定删除？', '系统提醒', function() {
				epoint.execute('deleteFlow1', '', e, function(data) {
					if (data.msg.indexOf('成功') != -1) {
						epoint.alertAndRefresh(data.msg, null, 'success');
					} else {
						epoint.alert(data.msg, null, null, 'error');
					}
				});
			});
		}

		tree.on('nodeselect', function(e) {
			if (e.node.id == 'f9root') {
				mini.get('modelCategoryCode').setValue('');
			} else {
				mini.get('modelCategoryCode').setValue(e.node.id);
			}
			epoint.refresh([ 'datagrid', 'condition']);
		});


		function editcategory() {
			epoint.openTopDialog('模型分类', 'dxp/flowinfo/flowgroupadd',
					function refreshData() {
						epoint.refresh([ 'tree' ], '', true);
					}, {
						width : 1200,
						height : 600
					});
		}
        //移动分类
		function moveFlow() {
			let array = grid.getSelecteds();
			if (array.length == 0) {
				epoint.alert('请选择要移动的模型!', '', null, 'warning');
			} else{
                let guidArray = [];
                for (var i = 0; i < array.length; i++) {
                    guidArray.push(array[i].rowguid);
                }
                let guid = guidArray.join(",");
                epoint.openDialog("移动模型", "modelga/model/modelgroupselect?guid="
                        + guidArray, searchData, {
                    'width' : 800,
                    'height' : 420
                })
			}
		}

        function public(){
            let array = grid.getSelecteds();
			if (array.length == 0) {
				epoint.alert('请选择要公开的模型!', '', null, 'warning');
			} else{
                epoint.confirm('公开后模型所有人可见，确认公开吗?', '', function() {
					epoint.execute('changepublic', '','1', function(data) {
						if (data.msg.indexOf('成功') != -1) {
							epoint.alert(data.msg, '', searchData, 'success');
						} else {
							epoint.alert(data.msg);
						}
					});
				});
			}
        }
        function unpublic(){
            let array = grid.getSelecteds();
			if (array.length == 0) {
				epoint.alert('请选择要取消公开的模型!', '', null, 'warning');
			} else{
                epoint.confirm('确认取消公开吗?', '', function() {
					epoint.execute('changepublic', '','0', function(data) {
						if (data.msg.indexOf('成功') != -1) {
							epoint.alert(data.msg, '', searchData, 'success');
						} else {
							epoint.alert(data.msg);
						}
					});
				});
			}
        }




        function deleteFlow() {
			if (mini.get('datagrid').getSelecteds().length == 0) {
				epoint.alert('请选择要删除的模型!', '', null, 'warning');
			} else {
				epoint.confirm('确认删除吗?', '', function() {
					epoint.execute('deleteFlow', '', function(data) {
						if (data.msg.indexOf('成功') != -1) {
							epoint.alert(data.msg, '', searchData, 'success');
						} else {
							epoint.alert(data.msg);
						}
					});
				});
			}
		}

        //导入
		function upload() {
			var groupid = mini.get('modelCategoryCode').getValue();
			epoint.openDialog('导入模型', 'dxp/datamodel/modelflow/uploadflow?groupid=' + groupid,
					function(data) {
						epoint.execute('checkFile', '', data, function(data) {
							searchData();
						});
					}, {
						'width' : 1000,
						'height' : 550
					});
		}

        //导出
		function download() {
			var datagrid = mini.get('datagrid');
			var ids = datagrid.getSelectedIds();
			if (ids.length > 0) {
			   var rows=datagrid.getSelecteds();
			   for(var i=0;i<rows.length;i++){
			        if(rows[i].flowtype=='2'){
                        epoint.alert('['+rows[i].flowname+']是向导式建模，向导式建模不支持导出操作！请重新选择模型导出！');
                        return;
			        }
			   }
				var data = {
					allmodelguid : ids.join(',')
				};
				var downloadurl = "dxpmodeldatadeveloplistaction.action?cmd=exportModel";
				var form = document.getElementById("download_form");
				DownLoadFile({
					url : downloadurl,
					data : data
				});
				searchData();
			} else {
				epoint.alert("请选择要导出的模型!");
			}
		}

		var DownLoadFile = function(options) {
			var config = $.extend(true, {
				method : 'post'
			}, options);
			var $iframe = $('<iframe id="down-file-iframe" />');
			var $form = $('<form target="down-file-iframe" method="' + config.method + '" />');
			$form.attr('action', config.url);
			for ( var key in config.data) {
				$form.append('<input type="hidden" name="' + key + '" value="' + config.data[key] + '" />');
			}
			$iframe.append($form);
			$(document.body).append($form);
			$form[0].submit();
			$form.remove();
		}

</script>
<script>
		SrcBoot.output([ './js/mymodel.js' ]);

</script>
</body>

</html>