<!DOCTYPE html>
<html>

<head>
<title>作业管理</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<script src="../../frame/fui/js/cssboot.js"></script>
<style>
.modicon-117 {
	color: #888;
}
</style>
</head>
<body>
	<!-- 等待提示框 -->
	<div class="page-loading"></div>
	<!-- 按钮区域 -->
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<a class="mini-button" onclick="openAdd">添加任务</a>
			<a class="mini-button" onclick="deletejob">删除任务</a>
		</div>
	</div>
	<!-- 条件区域 -->
	<div class="fui-condition">
		<div class="fui-form" id="fui-form">
			<div role="form">
				<div role="row">
					<div role="control" label="模型名称">
						<input bind="dataBean.flowname" class="mini-textbox" />
					</div>
				</div>
			</div>
		</div>
		<!-- 搜索按钮 -->
		<a role="searcher" callback="searchData"></a>
	</div>
	<!-- 列表区域 -->
	<div class="fui-content">
		<div id="datagrid" name="datagrid" class="mini-datagrid"
			idField="rowguid" multiSelect="true" pagerType="pagination"
			style="width: 100%; height: 100%;" allowResize="true"
			showPager="true" action="getDataGridData" allowCellSelect="true"
			editNextOnEnterKey="true" onlyCheckSelection="true">
			<div property="columns">
				<div type="checkcolumn" width="50"></div>
				<div type="indexcolumn" width="50" headerAlign="center">序</div>
				<div field="modelname" width="320" headerAlign="center">模型名称</div>
				<div field="flowname" width="320" headerAlign="center">任务名称</div>
				<div field="generateDate" width="150" headerAlign="center"
					align="center" data-options="{format:'yyyy-MM-dd HH:mm:ss'}">作业创建时间</div>
				<div field="tasktiming" width="150" headerAlign="center"
					align="center">定时任务</div>
				<div field="schedulerguid" visible="false"></div>
				<div field="jobstatus" width="50" headerAlign="center"
					align="center" renderer="changestatus">状态</div>
				<div field="edit" width="50" headerAlign="center" align="center"
					renderer="onEditRenderer">编辑作业</div>
				<div field="edit" width="50" headerAlign="center" align="center"
					renderer="onDetailRenderer">查看执行</div>
				<div field="modelguid" visible="false"></div>
			</div>
		</div>
	</div>
</body>



<script src="../../rest/resource/jsboot"></script>

<!-- 配置变量 -->
<script>
	//<![CDATA[  
	//表格js对象
	var grid = mini.get("datagrid");
	//初始化页面
	epoint.initPage("dxpmodeljobinfolistaction");

	//渲染修改日志按钮
	function onEditRenderer(e) {
		return epoint.renderCell(e, "action-icon icon-edit", "edit", "rowguid");
	}

	function edit(e) {
		epoint.openDialog('调度配置',
				'dxp/datamodel/modelflow/taskconfigNew?guid=' + e, null, {
					'width' : 700,
					'height' : 350
				});
	}

	// 绘制行查看按钮
	var onDetailRenderer = function(e) {
		return epoint.renderCell(e, "action-icon icon-search", "openDetail",
				"rowguid,flowname");
	};

	// 弹出明细窗口
	function openDetail(e) {
		epoint.openDialog(e.flowname, 'dxp/flowinfo/dxpschedulerloglist?guid='
				+ e.rowguid, searchData, {
			'width' : 1500,
			'height' : 750
		});
	}

	// formThe search of
	function searchData() {
		if (epoint.validate()) {
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		}
	}

	//删除回调事件
	function callback(data) {
		epoint.alert(data.msg, null, null, 'info');
	}

	//删除选中行

	function deletejob() {
		var datagrid = mini.get('datagrid');
		var ids = datagrid.getSelectedIds();
		if (ids.length > 0) {
			epoint.confirm("确定删除选中记录？", "", function(action) {
				epoint.execute("delete", '@all', "", function(data) {
					if (data.msg) {
						if (data.msg.indexOf('成功') != -1) {
							epoint.alert(data.msg, null, null, 'success');
						} else {
							epoint.alert(data.msg, null, null, 'info');
						}
						searchData();
					}
				});
			});
		} else {
			epoint.alert("请选择要删除的记录!", null, null, 'warning');
		}
	}

	function changestatus(e) {
		if (e.row.jobstatus == '已停止') {
			return '<a href="javascript:void(0);" onclick="startJob(\''
					+ e.row.rowguid
					+ '\');" class="action-icon icon-pause" title="已停止"></a>';
		} else {
			return '<a href="javascript:void(0);" onclick="stopJob(\''
					+ e.row.rowguid
					+ '\');" class="action-icon icon-start" title="启动中"></a>';
		}
	}

	function startJob(e) {
		epoint.execute('doJobWork', '', [ 'start', e ], function(data) {
			if (data.msg.indexOf('成功') != -1) {
				epoint.alert(data.msg, '', function() {
					epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
				}, 'success');
			} else {
				epoint.alert(data.msg, '', '', 'warning');
			}
		});
	}

	function stopJob(e) {
		epoint.confirm('确认要停止吗?', '', function() {
			// stop 标志变量停用作业
			epoint.execute('doJobWork', '', [ 'stop', e ], function(data) {
				if (data.msg.indexOf('成功') != -1) {
					epoint.alert(data.msg, '', function() {
						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
					}, 'success');
				} else {
					epoint.alert(data.msg);
				}
			});
		});
	}
	
	function openAdd() {
		epoint.openDialog('调度配置',
				'dxp/datamodel/modelflow/taskconfigNew?guid=&ischoose=1&isnew=1', searchData, {
					'width' : 700,
					'height' : 350
				});
	}

	//]]>
</script>
</html>