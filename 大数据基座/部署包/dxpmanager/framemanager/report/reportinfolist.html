<!DOCTYPE html>
<html>

<head>
<title>报表管理</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />

<script src="../../frame/fui/js/cssboot.js"></script>
</head>
<body>

	<div class="page-loading"></div>


	<!-- 左侧树 -->
	<div class="fui-left">

		<div role="head" title="分类管理">
			<div class="btn-group r">
				<a class="mini-button" iconCls="icon-gear" style="margin-top: 5px;margin-right: 5px;"
					onclick="editCat();">分类管理</a>
			</div>
		</div>

		<div role="body">
			<ul id="tree" class="mini-tree" style="height: 100%" textField="text"
				idField="id" parentField="pid" action="getTreeData"
				resultAsTree="false"></ul>
		</div>
	</div>

	<!-- 右侧内容区域 -->
	<div class="fui-right">
		<!-- toolbar区域 -->
		<div class="fui-toolbar">
			<div class="btn-group mr10">
				<a class="mini-button" id="addbtn" onclick="addReport();">新增报表</a> <a
					class="mini-button" id="savebtn" onclick="saveReport();">保存修改</a> <a
					class="mini-button mini-btn-danger" id="delbtn"
					onclick="deleteSelect();">删除选中</a><a class="mini-button"
					onclick="setDs();">设置数据源</a>
			</div>
			<input id="dsID" action="getDsItems" allowInput="false"
				autoLoad="true" class="mini-combobox" showNullItem="false" />
		</div>


		<!-- 条件区域 -->
		<div class="fui-condition">
			<div class="fui-form" id="fui-form">
				<div role="form">
					<div role="row">
						<div role="control" label="报表名称">
							<div class="mini-textbox" bind="reportName"></div>
						</div>
						<div role="control"></div>
					</div>
					<!-- 添加隐藏域，用于树与表格的联动 -->
					<input bind="leftTreeNodeGuid" id="leftTreeNodeGuid"
						class="mini-hidden" />
				</div>
			</div>
			<!-- 搜索按钮 -->
			<a role="searcher" callback="searchData"></a>
		</div>

		<!-- 列表区域 -->
		<div class="fui-content">
			<div id="datagrid" name="datagrid" class="mini-datagrid"
				idField="rowguid" multiSelect="true"
				style="width: 100%; height: 100%;" allowResize="true"
				showPager="true" action="getDataGridData" allowCellSelect="true"
				editNextOnEnterKey="true" editNextRowCell="true"
				allowCellEdit="true">
				<!-- allowCellEdit="true" -->
				<div property="columns">
					<div type="checkcolumn" width="50"></div>
					<div type="indexcolumn" width="50" headerAlign="center">序</div>
					<div field="reportname" headerAlign="center" width="150">
						报表名称<input property="editor" class="mini-textbox" />
					</div>
					<div field="dsName" headerAlign="center" width="100%">数据源</div>
					<div field="categoryname" headerAlign="center" width="80">报表类别</div>
					<div field="ordernumber" headerAlign="center" width="80">
						排序号<input property="editor" class="mini-textbox" vtype="int;range:0,99999999"/>
					</div>
					<div headerAlign="center" renderer="onDownLoadRender"
						align="center" width="60">下载</div>
					<div headerAlign="center" renderer="onEditRender" align="center"
						width="60">修改</div>
					<div headerAlign="center" renderer="onPreviewRender" align="center"
						width="60">预览</div>
					<div field="attachguid" visible="false"></div>
				</div>
			</div>
		</div>


	</div>

	<script src="../../rest/resource/jsboot"></script>

	<!-- 配置变量 -->
	<script>
		//<![CDATA[ 
		//初始化页面
		epoint.initPage("reportinfolistaction");

		//树js对象
		var tree = mini.get("tree");

		//点击树节点刷新表格
		tree.on("nodeselect", function(e) {
			if (e.node) {
				var id = e.node.id;
				//将左侧树点击的节点id放到隐藏域中
				mini.get('leftTreeNodeGuid').setValue(id);
			}
			//刷新表格
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		});

		// 表格的搜索
		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form', 'tree' ]);
		}

		//编辑分类
		function editCat() {
			epoint.openDialog("报表分类配置",
					"framemanager/report/reportcategorylist", function(data) {
						epoint.refresh([ 'datagrid', 'fui-form', 'tree' ], '',
								true);
					}, {
						width : 1000,
						height : 500
					});
		}

		//新增报表
		function addReport() {
			if (tree.getValue() && tree.getValue() != "f9root") {
				epoint.openDialog("新增报表",
						'framemanager/report/reportinfo?categoryGuid='
								+ tree.getValue(), function(data) {
							epoint.refresh([ 'datagrid', 'fui-form', 'tree' ],
									'', true);
						}, {
							'width' : 1000,
							'height' : 500
						});
			} else {
				epoint.alert("请先报表分类!", '', null, 'warning');
			}
		}

		//保存修改
		function saveReport() {
			epoint.execute("save", "datagrid", function(data) {
				epoint.alert(data.message, '', null, 'info');
				//刷新表格
				epoint.refresh([ 'datagrid', 'fui-form', 'tree' ], '', true);
			});
		}

		// 绘制行编辑按钮
		var onPreviewRender = function(e) {
			return epoint.renderCell(e, "action-icon icon-search",
					"openPreview")
		};

		// 初始化stimulsoftreportshow.jsp参数
		var optionsparams = {
			'showExportDialog' : true,
			'showViewModeButton' : true,
			'showZoomButton' : true,
			'showMenuMode' : 'Hover',
			'viewMode' : 'OnePage',
			'showPageShadow' : true,
			'showTooltips' : false,
			'scrollbarsMode' : false,
			'rightToLeft' : false
		};
		function openPreview(rowguid) {
			epoint.openDialog("报表预览",
					"frame/pages/stimulsoftreport/stimulsoftreportshow.jsp?rowguid="
							+ rowguid);
		}

		//渲染修改按钮
		var onEditRender = function(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "editReport")
		}

		function editReport(rowguid) {
			epoint.openDialog("修改报表",
					'framemanager/report/reportinfo?reportGuid=' + rowguid,
					function(data) {
						epoint.refresh([ 'datagrid', 'fui-form', 'tree' ], '',
								true);
					}, {
						'width' : 1000,
						'height' : 500
					});
		}

		//删除选中行
		function deleteSelect() {
			var datagrid = mini.get('datagrid');
			var ids = datagrid.getSelectedIds();
			if (ids.length > 0) {
				epoint.confirm("确定删除选中记录？", "", function(action) {
					epoint.execute("delete", "datagrid", function(data) {
						if (data.message) {
							epoint.alert(data.message);
							epoint.refresh([ 'datagrid', 'fui-form', 'tree' ],
									'', true);
						}
					});
				});
			} else {
				epoint.alert("请选择要删除的记录!", '', null, 'warning');
			}
		}

		//设置数据源
		function setDs() {
			var dsID = mini.get("dsID").getValue();
			if (dsID.length > 0) {
				var datagrid = mini.get('datagrid');
				var ids = datagrid.getSelectedIds();
				if (ids.length > 0) {
					epoint.confirm("确定修改所选报表数据源？", "", function(action) {
						epoint
								.execute("saveDs", "datagrid", [ dsID ],
										function(data) {
											if (data.message) {
												epoint.alert(data.message, '',
														null, 'info');
												epoint.refresh([ 'datagrid',
														'fui-form', 'tree' ],
														'', true);
											}
										});
					});
				} else {
					epoint.alert("请选择要修改的记录!", '', null, 'warning');
				}
			} else {
				epoint.alert("请选择数据源!", '', null, 'warning');
			}
		}

		//渲染下载按钮
		var onDownLoadRender = function(e) {
			if (e.row.attachguid)
				return epoint.renderCell(e, "action-icon icon-download",
						"getDownLoadUrl", "attachguid");
		}
		
		function getDownLoadUrl(attachguid){
			epoint.execute('getDownLoadUrl', 'datagrid', [attachguid], downloadReport);
		}
		
        function downloadReport(data){
        	console.log("data="+data.url);
        	window.open("../../" +data.url);
        	//window.open("../../../../mis/base/attach/attachdown?attachGuid=" + attachGuid);
        }

		/*function downloadReport(attachGuid) {
			window.open("../../frame/pages/basic/attach/attachdown?attachGuid="
					+ attachGuid);
		}*/

		//]]>
	</script>
</body>
</html>