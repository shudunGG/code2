<!DOCTYPE html>
<html>

	<head>
		<title>方法管理</title>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />

		<script src="../../../frame/fui/js/cssboot.js"></script>
	</head>
	<body>
		<div class="page-loading"></div>
		<!-- toolbar区域 -->
		<div class="fui-toolbar">
			<div class="btn-group mr10">
			<a class="mini-button" onclick="openAdd" iconCls="icon-addcircle">新增方法</a>
			<a class="mini-button" onclick="saveBtn" iconCls="icon-addcircle">保存设置</a>
				<a
				class="mini-button" onclick="deleteAll" iconCls="icon-removecircle">清空</a>
			</div>
		</div>
		<!-- 条件区域 -->
		<div class="fui-condition" opened="true">
			<div class="fui-form" id="fui-form">
				<div role="form">
				<div role="row">
						<div role="control" label="角色列表">
							<input id="roleType" autoLoad="false" bind="roleTypeGuid"
							action="getFrameRoleType" textField="text" emptyText="未分类"
							showNullItem="true" nullItemText="未分类" onvaluechanged="roleTypeChange"
							valueField="id" class="mini-combobox mr10" />
						</div>
						<div role="control" label="方法名称" >
							<input bind="methodName" class="mini-textbox" onkeypress="updateTable" vtype="maxLength:50" />
						</div>
					</div>
					<div role="row">
						<div role="control" label="角色">
							<div id="roleGroup" class="mini-checkboxlist" repeatItems="5" repeatLayout="table"
							textField="text" valueField="id" bind="selectRoleGuids" onvaluechanged="roleGroupChange"
							action="checkgroupModal" ></div>
						</div>
					</div>
				</div>
			</div>
		</div>	
		<!-- 内容区域 -->
		<div id="fuiContent" class="fui-content">
			<div id="datagrid" name="datagrid" class="mini-datagrid" showPager="true"  allowCellEdit="true" 
				idField="methodguid" action="getDataGridData" showFooter="false" style="width: 100%;height:100%"
				allowSortColumn="false"></div>
		</div>

		<script src="../../../rest/resource/jsboot"></script>
		<link href="../../../frame/fui/js/miniui/plugin/gridcheckall/checkall.css" rel="stylesheet" type="text/css" />
		<script src="../../../frame/fui/js/miniui/plugin/gridcheckall/checkall.js" type="text/javascript"></script>
		<script>
			//<![CDATA[
			//初始化页面
			epoint.initPage("servicemethodlistaction",'',callbackinit);
			
			var moduleGuid="";
			// 表格对象
			var grid = mini.get("datagrid");
			
			// 初始化回掉，动态生成列
			function callbackinit(data) {
				adjustContentHeight();//隐藏的condition出来 要重新计算一次高度
				if (data) {
					if(data.moduleGuid){
						moduleGuid=data.moduleGuid;
					}
					drawDynamicColumn(data);
				}
			}
			
			function updateTable(){
				if (event.keyCode == 13) {
					searchData();
				}
			}

			// 表格的搜索
			function searchData() {
				epoint.refresh(['datagrid', 'fui-form']);
			}

			// 回diao提醒
			function msgCallBack(data) {
				var msg = data.msg;
				if (msg) {
					if (data.success) {
						epoint.alert(msg, '', function(){
							epoint.refresh(['datagrid', 'fui-form'],'',true, 'success');
						});
					} else {
						epoint.alert(msg, '', '', 'warning');
					}
				}
				epoint.refresh(['datagrid', 'fui-form'],'',true);
			}

			//新增
			function openAdd() {
				var serviceguid = Util.getUrlParams('serviceguid');
				var settings = {
					'width' : 600,
					'height' : 350
				};
				epoint.openDialog('新增服务方法', 'framemanager/orga/service/servicemethodadd?serviceguid=' + serviceguid, addEditCallBack, settings);
			}

			//保存设置
			function saveBtn() {
				epoint.execute('saveBtn', '', msgCallBack);
			}

			//删除选中
			function deleteSelected(methodguid) {
				epoint.execute('deleteSelected', 'datagrid',[methodguid], msgCallBack);
			}
			
			function deleteAll(){
				epoint.confirm('此操作将删除当前服务所有除pageLoad以外的方法配置,确定？', '', function() {
					epoint.execute('deleteAll', 'datagrid', msgCallBack);
				});
			}
			

			//打开配置权限页面
			function openRight(methodguid) {
				var settings = {
					'width' : 800,
					'height' : 500
				};
				epoint.openDialog('配置方法权限', 'framemanager/orga/service/servicemethodright?methodguid=' + methodguid, addEditCallBack, settings);
			}

			//绘制配置权限按钮
			function onMethodRenderer(e) {
				return epoint.renderCell(e, "action-icon icon-gear", "openRight", "methodguid");
			}

			//新增 修改回调
			function addEditCallBack(param) {
				if (param) {
					epoint.refresh(['datagrid', 'fui-form'],'',true);
				}
			}

			function editItems(methodguid) {
				var settings = {
					'width' : 600,
					'height' : 350
				};
				epoint.openDialog('修改服务方法', 'framemanager/orga/service/servicemethodedit?methodguid=' + methodguid, addEditCallBack, settings);
			}

			// 绘制行编辑按钮
			var onEditRenderer = function(e) {
				return epoint.renderCell(e, "action-icon icon-edit", "editItems", "methodguid")
			};
			
			
			function deleteMethod(methodguid){
				// 弹出确认框
				epoint.confirm("删除方法会同步删除其权限数据,确定要删除吗?", '', function() {
					epoint.execute("deleteSelected", 'datagrid', [ methodguid ],msgCallBack);
				});
			}
			
			// 绘制行删除按钮
			var onDelRenderer = function(e) {
				var url=epoint.renderCell(e, "action-icon icon-remove", "deleteMethod","methodguid");
				if(e.row.methodname=='pageLoad'){
					if(!moduleGuid){//没关联模块,此时不允许删除
						url="";
					}
				}
				return url;
			};
			
			
			// 角色类别变更
			function roleTypeChange() {
				mini.get('roleGroup').setValue('');
				epoint.execute('roleTypeChange', '', function(data) {
					drawDynamicColumn(data);
					searchData();
				});
			}

			// 显示方式变更
			function moduleDisplayChange() {
				searchData();
			}

			// 选择角色变更
			function roleGroupChange() {
				epoint.execute("initDynamicRole", 'roleGroup', function(data) {
					drawDynamicColumn(data);
					searchData();
				});
			}

			// 绘制动态列
			function drawDynamicColumn(data) {
				if(data.columns){
					var tmp = data.columns;
					var columns = Util.safeEval('(' + tmp + ')');
					grid.set(columns);
					var tmpObj = epoint.decodeJson(tmp);
					var columnsObj = tmpObj.columns;
					if(columnsObj && columnsObj.length){
						$.each(columnsObj, function(k,v){
							if(columnsObj[k].type=='checkboxcolumn'){
								new CheckAll(grid, columnsObj[k].name);
							}
						});
					}
				}
				
			}

			//]]>
		</script>
	</body>
</html>