<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>用户列表</title>
<script src="../../../../frame/fui/js/cssboot.js"></script>
<style type="text/css">
        .btn-in-column{margin-right:5px;}
        .btn-in-column-text{margin-left:5px;margin-right:5px;}
</style>
</head>
<body>
	<div class="page-loading"></div>
	
	<!-- 条件区域 -->
	<div class="fui-condition">
		<div class="fui-form" id="fui-form">
			<div id="cform" role="form">
				<div role="row">
					<div role="control" label="状态">
						<div id="search_userStatus" class="mini-combobox" style="width:150px;"
						textField="text" valueField="id" bind="userStatus" showClose="true"
					    data="[{id:'1',text:'禁用'},{id:'2',text:'待审核'},{id:'3',text:'审核不通过'},{id:'4',text:'审核通过'}]" onkeyenter="searchData();" oncloseclick="onCloseClick"></div>
					</div>
					<div role="control" label="用户名">
						<input id="search_displayName" class="mini-textbox"
							bind="displayName" onkeyenter="searchData();" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="登录名">
						<input id="search_loginId" class="mini-textbox"
							bind="loginId" onkeyenter="searchData();" />
					</div>
					<div role="control" label="企业名">
						<input id="search_companyName" class="mini-textbox"
							bind="companyName" onkeyenter="searchData();" />
					</div>
				</div>
			</div>
		</div>
		<a role="searcher" callback="searchData"></a>
	</div>
	
	<!-- 内容区域 -->
	<div class="fui-content">
		<div id="datagrid" name="datagrid" class="mini-datagrid"
			idField="userGuid" multiSelect="true"
			style="width: 100%; height: 100%;" allowResize="true"
			showPager="true" action="getDataGridData">
			<div property="columns">
				<div type="indexcolumn" width="50" headerAlign="center">序</div>
				<div field="displayName" headerAlign="center" width="150">用户名称</div>
				<div field="loginId" headerAlign="center" width="150">登录名称</div>
				<div field="companyName" headerAlign="center" align="left" width="100%">企业名称</div>
				<div field="mobile" headerAlign="center" align="center" width="150">手机号</div>
				<div field="lastLoginTime" headerAlign="center" renderer="onTimeRender"
					align="center" width="150">最近登录时间</div>
				<div field="userStatus" headerAlign="center" align="center" width="100" renderer="onStatusRender">状态</div>
				<div name="operation" headerAlign="center" renderer="onOperationRender"
					align="center" width="250">操作</div>
			</div>
		</div>
	</div>

	<script src="../../../../rest/resource/jsboot"></script>
	<script>
		//<![CDATA[
		                      
		//初始化页面
		epoint.initPage('platformuserlistaction');

		// 表格对象
		var grid = mini.get("datagrid");

		// 格式化审核时间列
		function onTimeRender(e) {
			
			var time = e.value;
			if (time) {
				
				time = new Date(time);
				
				// 格式化时间
				var year = time.getFullYear();
				var month = time.getMonth() + 1;
				month = fixZero(month);
				var date = time.getDate();
				date = fixZero(date);
				var hours = time.getHours();
				hours = fixZero(hours);
				var minutes = time.getMinutes();
				minutes = fixZero(minutes);
				var seconds = time.getSeconds();
				seconds = fixZero(seconds);
				
				return year + '-' + month + '-' + date + ' ' + hours + ':' + minutes + ':' + seconds;
			}
		}

		function fixZero(data){
			if (data < 10) {
				data = '0' + data;
			}
			return data;
		}
		
		function onStatusRender(e){
			var status = e.value;
			var result = '';
			if (status == 1) {
				result = '禁用';
			} else if (status == 2) {
				result = '待审核';
			}  else if (status == 3) {
				result = '审核不通过';
			} else if (status == 4) {
				result = '审核通过';
			}
			return result;
		}
		
		// 绘制操作按钮
		function onOperationRender(e) {
			var userGuid = e.row['userGuid'];
			var userStatus = e.row['userStatus'];
			
			// 启用
			var enableHtml = '<a class="mini-button btn-in-column" id="btnEnable" onclick="enableUser(\'' + userGuid + '\');"><div class="btn-in-column-text">启用</div></a>';
			// 禁用
			var disableHtml = '<a class="mini-button mini-btn-danger btn-in-column" id="btnDisable" onclick="disableUser(\'' + userGuid + '\');"><div class="btn-in-column-text">禁用</div></a>';
			// 初始化密码
			var resetPwsHtml = '<a class="mini-button btn-in-column" id="btnResetPwd" onclick="resetPwd(\'' + userGuid + '\');"><div class="btn-in-column-text">初始化密码</div></a>'
			// 查看详情
			var forDetailHtml = '<a class="mini-button btn-in-column" id="btnDetail" onclick="toDetail(\'' + userGuid + '\');"><div class="btn-in-column-text">查看详情</div></a>';
		
			var renderHtml = '<div>';
			if (userStatus == 1) {
				// 禁用状态
				renderHtml += enableHtml;
			} else if (userStatus == 4) {
				// 审核通过状态
				renderHtml += disableHtml;
			}
			renderHtml += resetPwsHtml + forDetailHtml + '</div>';
			return renderHtml;
		}		
		
		// 启用账号
		function enableUser(userGuid){
			epoint.execute('enableUser', '', [userGuid], dealUserCallBack);
		}
		
		// 禁用账号
		function disableUser(userGuid){
			epoint.execute('disableUser', '', [userGuid], dealUserCallBack);
		}
		
		// 初始化密码
		function resetPwd(userGuid){
			epoint.execute('resetPwd', '', [userGuid], dealUserCallBack);
		}
		
		// 回调
		function dealUserCallBack(data){
			var msg =data.msg;
			if (msg) {
				
				if(data.success){
					epoint.showTips(msg, {timeout: 1000});
					epoint.refresh(['datagrid', 'fui-form'],'',true);
				} else {
					epoint.alert(msg, '', '', 'warning');
				}
			} else {
				epoint.alert('操作失败', '', '', 'warning');
			}
		}
		
		// 查看详情
		function toDetail(userGuid){
			epoint.openDialog("用户详情", 'framemanager/orga/openplatform/user/platformuseredit?userGuid=' + userGuid + '&showMode=detail', detailCallBack, {'width': 1000, 'height': 580});
		}
		
		// 查看详情回调
		function detailCallBack(param) {
	        if (param) {
	        	epoint.refresh(['datagrid', 'fui-form'],'',true);
	        }
	    }

		// 搜索条件状态清除
		function onCloseClick(e) {
            var obj = e.sender;
            obj.setText("");
            obj.setValue("");
        }
		
		// 搜索
		function searchData(){
			epoint.refresh(['datagrid', 'fui-form']);
		}
		//]]>
	</script>


</body>
</html>