<!DOCTYPE html>
<html>

	<head>
		<title>模块管理授权</title>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />

		<script src="../../../../../frame/fui/js/cssboot.js"></script>

		<style>
			.link:hover {
				cursor: pointer;
				color: red;
				text-decoration: underline;
			}
		</style>
	</head>

	<body>
		<div class="page-loading"></div>
		<div class="fui-left">
			<div role="head" title="选择模块"></div>

			<div role="body">
				<ul id="tree" name="tree" class="mini-tree" style="width: 100%;height:100%" autoLoad="false"
				showTreeIcon="true" textField="text" idField="id" parentField="pid"  action="getTreeModel"
				resultAsTree="false"></ul>
			</div>
		</div>

		<div class="fui-right" id="fui-right">
			<!-- toolbar区域 -->
			<div class="fui-toolbar">
				<div class="btn-group mr10">
					<a class="mini-button"
					onclick="multiAccredit">授权给部门管理</a>
				</div>
			</div>

			<div class="fui-condition">
				<!-- 表单布局 -->
				<div class="fui-form" id="fui-form">
					<div id="cform" role="form">
						<!-- 2列 -->
						<div role="row">
							<div role="control" label="模块名称">
								<input bind="searchString" id="name"
								class="mini-textbox" emptyText="" style="width: 60%;"/>
							</div>
						</div>
					</div>
					<input bind="moduleCode" id="moduleCode" class="mini-hidden" />
				</div>
				<!-- 搜索按钮 -->
				<a role="searcher" callback="updateTable"></a>
			</div>
			<div id="fuiContent" class="fui-content">
				<div id="datagrid" name="datagrid" class="mini-datagrid"
				idField="moduleguid" multiSelect="true" action="getDataGridData"
				style="width: 100%; height: 100%;" allowResize="true"
				showPager="true"  allowCellEdit="true" allowCellValid="true"
				allowCellSelect="true" editNextOnEnterKey="true"
				editNextRowCell="true" ondrawcell="onCheckRender">
					<div property="columns">
						<div type="checkcolumn"></div>
						<div type="indexcolumn" headerAlign="center" width="40">
							序
						</div>

						<div field="moduleName" width="150"
						headerAlign="center" allowSort="true">
							模块名称
						</div>
						<div field="moduleCode" width="150"
						headerAlign="center" align="right" allowSort="true">
							模块代码
						</div>
						<div field="moduleUrl" headerAlign="center" width="100%" allowSort="true">
							模块地址
						</div>
						<div field="orderNumber" width="80" align="right"
						headerAlign="center" allowSort="true">
							排序号
						</div>
						<div field="isDisable" width="60" align="center" renderer="onIsDisableRenderer"
						headerAlign="center">
							禁用
						</div>
						<div field="isBlank" width="60" align="center" renderer="onIsDisableRenderer"
						headerAlign="center">
							弹出
						</div>
						<div width="60" align="center" headerAlign="center"
						renderer="onAuthRenderer">
							授权
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../../../../rest/resource/jsboot"></script>

		<!-- 配置变量 -->
		<script>
			//<![CDATA[
			epoint.initPage("framemoduleauthaction");
			
			var grid = mini.get("datagrid");
			grid.on("beforeselect", function (e) {
	            if (!e.record.isAllowToAll){
	            	e.cancel = true;
	            }
	        });
			
			//树js对象
			var tree = mini.get("tree");

			// 点击左侧树刷新右侧表格
			tree.on("nodeselect", function(e) {
				var id = e.node.objectcode;
				//将左侧树点击的节点id放到隐藏域中
				mini.get('moduleCode').setValue(id);
				//刷新表格
				updateTable();
			});

			// 绘制行授权按钮
			var onAuthRenderer = function(e) {
				if (e.record.isAllowToAll) {
					return "<a class=\"link\" onclick=\"accredit('" + e.record.moduleguid + "')\">授权</a>";
				} else {
					return "";
				}
			};

			function onCheckRender(e) {
				if (!e.record.isAllowToAll && e.cellCls === "mini-checkcolumn") {
					e.cellHtml = "";
				}

			}

			function onIsDisableRenderer(e) {
				if (e.value == '0') {
					return "否";
				} else {
					return "是";
				}
			}

			function multiAccredit() {
				if (mini.get('datagrid').getSelecteds().length == 0) {
					epoint.alert('请选择授权模块!', '', null, 'warning');
				} else {
					var selects = mini.get('datagrid').getSelecteds();
					var arr = new Array();
					for (var i = 0; i < selects.length; i++) {
						arr[i] = selects[i].moduleguid;
					}
				}
				accredit(arr.join(","));
			}

			function accredit(moduleGuids) {
				epoint.openDialog("授权给部门管理", "framemanager/orga/uiset/menu/module/accredittoou?moduleGuids=" + moduleGuids, function(){
					epoint.refresh(['datagrid', 'fui-form'],'',true);
				}, {
					'width' : 800,
					'height' : 500
				});
			}

			function updateTable() {
				epoint.refresh(["datagrid", "fui-form"]);
			}

			//]]>
		</script>

	</body>

</html>
