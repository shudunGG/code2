<!DOCTYPE html>
<html lang="zh-CN">

<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>CDC消费者任务新增</title>
<script src="../../frame/fui/js/cssboot.js"></script>
<script>
	SrcBoot.output([ './css/common.css', ]);
</script>
</head>

<body style="overflow: auto;">
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<a class="mini-button mini-btn-primary" id="save"onclick="save" >保存并关闭</a>
			<a class="mini-button mini-btn-primary" onclick="window.history.back()">关闭</a>
		</div>
	</div>
	<div class="fui-content">
		<!-- 页面内容区域 -->
		<div id="form" class="fui-form" style="padding-top: 1px">
			<div id="tabs1" class="mini-tabs" activeIndex="0" plain="false">
				<div name="tabs1" title="一般" id="ttttt">
					<div role="row">
						<div role="control" label="流程名称" starred="true">
							<input id="flowName" name="flowName" bind="flowName" class="mini-textbox"
								required="true" emptyText="请输入步骤名称" />
						</div>
						<div role="control" label="所属节点" starred="true">
							<input id="nodeGuid" bind="nodeGuid"
								class="mini-combobox" required="true" onvaluechanged="nodeSelect"
								requiredErrorText="所属节点不能为空" action="getNodeGuidList"
								/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="监听任务" starred="true">
							<input id="producerGuid" bind="producerGuid"
								class="mini-combobox" required="true" onvaluechanged="producerSelect"
								requiredErrorText="监听任务不能为空" action="getProducerList" />
						</div>
						<div role="control" label="topic名称" starred="true">
							<input id="topicName" name="topicName" bind="topicName" class="mini-textbox"
								readOnly="true"/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="消费组名称" starred="true">
							<input id="groupName" name="groupName" bind="groupName" class="mini-textbox"
								readOnly="true"/>
						</div>
						<div role="control"></div>
					</div>
					<div role="row">
						<div role="control" label="选择来源数据库" starred="true">
							<input class="mini-combobox" name="fromDataSource" id="fromDataSource"
								showClose="true" allowInput="true" bind="fromDataSource"
								showNullItem="false" action="getFromDataSourceList" required="true" />
						</div>
						<div role="control" label="选择目标数据库" starred="true">
							<input class="mini-combobox" name="targetDataSource" id="targetDataSource"
								showClose="true" allowInput="true" bind="targetDataSource"
								showNullItem="false" action="getTargetDataSourceList" required="true" />
						</div>
					</div>
					<div role="row">
						<div role="control" label="提交数量">
							<input class="mini-textbox" required="true" id="commitSize"
								name="commitSize" bind="commitSize" vtype="int;range:0,99999999;" />
						</div>
						<div role="control" label="定时提交时间">
							<input class="mini-textbox" required="true" id="commitInterval"
								name="commitInterval" bind="commitInterval" vtype="int;range:0,99999999;" />
						</div>
					</div>
					<input id="tableLinkData" name="tableLinkData" bind="tableLinkData" class="mini-hidden"> 
				<HR>
	<!-- 	 		<div class="fui-condition" style="width: 75%;">
					<div class="fui-form" id="fui-form">
						<div id="cform" role="form">
							<div role="row">
								<div role="control" label="源字段" style="width: 30%;">
									<input id="sourceField" class="mini-textbox" style="margin-left: -10px;"/>
								</div>
								<div role="control" label="目标字段" style="width: 35%;padding-lefte:20px">
									<input id="targetField" class="mini-textbox" style="margin-left: -10px;"/>
								</div>
							</div>
						</div>
					</div>
					<a role="searcher" callback="searchPrimaryKey"></a>
				</div> -->
				<table style="height: 40%;margin-top:20px">
					<tr>
						<td>
							<div id="grid1" class="mini-datagrid"
								style="width: 100%; height: 100%; margin-top: 0px; margin-left: 15px;"
								multiSelect="false" resultAsData="true" showPager="false"
								action="getFromTableGridData">
								<div property="columns">
									<div type="checkcolumn"></div>
									<div header="来源表" field="fromTable"></div>
								</div>
							</div>
						</td>
						<td>
							<div id="grid11" class="mini-datagrid"
								style="width: 100%; height: 100%; margin-left: 25px; margin-top: 0px"
								multiSelect="false" resultAsData="true" showPager="false"
								action="getTargetTableGridData">
								<div property="columns">
									<div type="checkcolumn"></div>
									<div header="目标表" field="targetTable"></div>
								</div>
							</div>
						</td>
			
						<td style="width: 60px; margin-left: 10px; text-align: center;">
							<input type="button" value=">" onclick="adds()"
							style="width: 50px; height: 30px; margin-left: 50px;" /><br /> <input
							type="button" value=">>" onclick="addAll()"
							style="width: 50px; height: 30px; margin-left: 50px;" /><br /> <input
							type="button" value="&lt;&lt;" onclick="removeAll()"
							style="width: 50px; height: 30px; margin-left: 50px;" /><br /> <input
							type="button" value="&lt;" onclick="removes()"
							style="width: 50px; height: 30px; margin-left: 50px;" /><br />
						</td>
						<td>
							<div id="grid2" class="mini-datagrid"
								style="width: 100%; height: 361px; margin-left: 30px; margin-top: 0px"
								multiSelect="true" showPager="false" allowCellEdit="true"
								allowCellSelect="true">
								<div property="columns">
									<div type="checkcolumn"></div>
									<div header="来源表" field="fromTable">
										<input id="fromTable" name="fromTable" class="mini-textbox"
											bind="fromTable" />
									</div>
									<div header="目标表" field="targetTable">
										<input id="targetTable" name="targetTable" class="mini-textbox"
											bind="targetTable" />
									</div>
								</div>
							</div> <input type="button" value="Up" onclick="upItem()"
							style="width: 55px; margin-left: 30px; margin-top: 30px;" /> <input
							type="button" value="Down" onclick="downItem()" style="width: 55px;" />
						</td>
						<td style="width: 50px; text-align: center; vertical-align: bottom">
						</td>
					</tr>
				</table>
			</div>
			<div name="tabs2" title="表映射关系">
				<div id="tablelinkDatagrid" name="tablelinkDatagrid" class="mini-datagrid"
						idField="id" multiSelect="false" allowCellValid="true"
						allowCellEdit="true"
						style="width: 100%; height: 300px; margin-left: 10px;"
						allowResize="true" showPager="false" allowCellSelect="true"
						editNextOnEnterKey="true" editNextRowCell="true">
					<div property="columns">
						<div type="checkcolumn" width="20"></div>
						<div type="indexcolumn" width="20" headerAlign="center">序</div>
						<div header="来源表" field="fromTable">
							<input id="fromTable" name="fromTable" class="mini-textbox"
								bind="fromTable" />
						</div>
						<div header="目标表" field="targetTable">
							<input id="targetTable" name="targetTable" class="mini-textbox"
								bind="targetTable" />
						</div>
					</div>
				</div>
				<input id="tblink" name="tblink" bind="tblink" class="mini-hidden"> 
						
				<div class="fui-toolbar" id="btns"
					style="padding-top: 1px; border-bottom: none;">
					<div class="btn-group mr10" style="width: 50%;">
						<a class="mini-button mini-btn-primary" onclick="add">添加条件</a> <a
							class="mini-button mini-btn-danger"
							onclick="if(mini.get('key-datagrid').getSelecteds().length==0){epoint.alert('请选择要删除的记录!', '', null, 'warning');} else {epoint.confirm('确认删除?','',deleteSelected);}">删除选中</a>
					</div>
					<div class="btn-group mr10">
						<a class="mini-button mini-btn-primary" onclick="addField">添加映射</a> <a
							class="mini-button mini-btn-danger"
							onclick="if(mini.get('field-datagrid').getSelecteds().length==0){epoint.alert('请选择要删除的记录!', '', null, 'warning');} else {epoint.confirm('确认删除?','',deleteSelectedField);}">删除选中</a>
						<a class="mini-button mini-btn-primary" onclick="updateFieldMap">编辑更新字段</a>
					</div>
				</div>
	
				<!-- 内容区域 -->
				<div class="fui-content" style="padding-top: 1px">
					<table style="height: 100%;">
						<tr>
							<td>
								<div id="key-datagrid" name="key-datagrid" class="mini-datagrid"
									idField="id" multiSelect="true" allowCellValid="true"
									allowCellEdit="true" style="width: 100%; height: 100%;"
									allowResize="true" showPager="false" allowCellSelect="true"
									editNextOnEnterKey="true" editNextRowCell="true"
									action="getDataGridModel">
									<div property="columns">
										<div type="checkcolumn" width="30"></div>
										<div type="indexcolumn" width="40" headerAlign="center">序</div>
										<div field="fromkey" headerAlign="center" align="center"
											vtype="required" type="comboboxcolumn">
											来源表字段<input id="fromkeyList" name="test" property="editor" class="mini-combobox"
												emptyText="请选择来源表字段..." textField="text" data="fromfieldList"
												valueField="id" style="width: 100%" />
										</div>
										<div field="condition" headerAlign="center" vtype="required"
											align="center" type="comboboxcolumn">
											比较符<input property="editor" class="mini-combobox"
												emptyText="请选择比较符..." textField="text" data="compareTypeList"
												valueField="id" style="width: 100%" />
										</div>
										<div field="targetkey" headerAlign="center" align="center"
											vtype="required" type="comboboxcolumn">
											目标表字段<input id="targetkeyList" property="editor" class="mini-combobox"
												emptyText="请选则目标表字段..." textField="text" data="targetfieldList"
												valueField="id" style="width: 100%" />
										</div>
									</div>
								</div>
							</td>
			
							<td>
								<div id="field-datagrid" name="field-datagrid" class="mini-datagrid"
									idField="id" multiSelect="true" allowCellValid="true"
									allowCellEdit="true" action="getDataGridColumnModel"
									style="width: 100%; height: 100%; margin-left: 10px;"
									allowResize="true" showPager="false" allowCellSelect="true"
									editNextOnEnterKey="true" editNextRowCell="true">
									<div property="columns">
										<div type="checkcolumn" width="30"></div>
										<div type="indexcolumn" width="40" headerAlign="center">序</div>
										<div field="fromfield" headerAlign="center" vtype="required"
											align="center" type="comboboxcolumn">
											来源表字段<input id="fromfieldList" property="editor" class="mini-combobox"
												emptyText="请选择来源表字段..." textField="text" data="fromfieldList"
												valueField="id" style="width: 100%" />
										</div>
										<div field="targetfield" headerAlign="center" align="center"
											vtype="required" type="comboboxcolumn">
											目标表字段<input id="targetfieldList" property="editor" class="mini-combobox"
												emptyText="请选择目标表字段..." textField="text" data="targetfieldList"
												valueField="id" style="width: 100%" />
										</div>
										<div field="isupdate" align="center" type="checkboxcolumn" 
											value="1" truevalue="1" falsevalue="0" headerAlign="center" >是否更新</div>
									</div>
								</div>
							</td>
						</tr>
					</table>
				</div>
			</div>
		</div>
	</div>

	<script src="../../frame/fui/js/jsboot.js"></script>

	<script>
		var form = new mini.Form("#form");
		var nodeInfo;
		var compareTypeList;
		var sourceFieldList;
		var fieldList;
		
		var grid1 = mini.get("grid1");
		var grid11 = mini.get("grid11");
		var grid2 = mini.get("grid2");
		var keygrid = mini.get("key-datagrid");
		var fieldgrid = mini.get("field-datagrid");
		var isShowFields = false;
		var tablelinkDatagrid = mini.get('tablelinkDatagrid');
		var tableLinkData = mini.get('tableLinkData');
		var tableLinkDataValue;
		var fromfieldList;
		var targetfieldList;
		var tblinkVal = "";
		var cdcDatasource;
		
		var node = mini.get('nodeGuid');
		var producer = mini.get('producerGuid');
		var fromDataSource = mini.get('fromDataSource');
		var targetDataSource = mini.get('targetDataSource');

		epoint.initPage('dxpcdcconsumereditaction','',function(data){
			initCallBack(data);
		});
		
		function getForm() {
			var data = form.getData(true, false);
			var s = mini.encode(data);
			return s;
		}

		function initCallBack(e) {
			var datas = fromDataSource.getValue();
			//填充表单数据
			if (e.compareTypeList) {
				compareTypeList = e.compareTypeList;
			}
			if (e.sourceFieldList) {
				sourceFieldList = e.sourceFieldList;
			}
			fromDataSource.setValue(datas);
			console.log(e.tableLinkData);
			if(e.tableLinkData){
				tableLinkData.setValue(e.tableLinkData);
				tableLinkDataValue = e.tableLinkData;
				var tbList = JSON.parse(e.tableLinkData);
				for(var i=0;i<tbList.length;i++){
					var items = grid1.findRow(function(row){
					    if(row.fromTable == tbList[i].fromtable) return true;
					});
					var items2 = grid11.findRow(function(row){
					    if(row.targettable == tbList[i].targettable) return true;
					});
					var items3 = {
						"fromTable" : tbList[i].fromtable,
						"targetTable" : tbList[i].targettable
					};
					if(!isShowFields){
						grid1.removeRow(items);
						grid11.removeRow(items2);
					}
					var items4 = clone(items3);
					grid2.addRow(items3, 0);
					tablelinkDatagrid.addRow(items4,0);
				}
			}
			console.log('tablelinkDataValue:'+tableLinkDataValue);
		}

		//选择数据来源
		fromDataSource.on('valuechanged', function(e) {
			fromDataSource.setValue(e.value);
			epoint.refresh([ 'grid1', 'form' ], '', true);
		}).on('closeclick', function(e) {
			e.sender.setText('');
			e.sender.setValue('');
			clearGrid();
		});
		
		//选择数据目标
		targetDataSource.on('valuechanged', function(e) {
			targetDataSource.setValue(e.value);
			epoint.refresh([ 'grid11', 'form' ], '', true);
		}).on('closeclick', function(e) {
			e.sender.setText('');
			e.sender.setValue('');
			clearGrid();
		});

		function clearGrid() {
			grid2.clearRows();
			mini.get('keyTableData').setValue('');
			mini.get('columnTableData').setValue('');
		}

		function setGridData() {
			//[{"fromtable":"","targettable":"","keyLink":[{"fromkey":"","targetkey":""}],"fieldLink":[{"fromfield":"","targetfield":""}]}]
			var lastFromTable = tblinkVal.split(';')[0];
			var	lastTargetTable = tblinkVal.split(';')[1];
			var keyData = keygrid.getData();
			var fieldData = fieldgrid.getData();
			if(keyData.length == [] || fieldData == []){
				return;
			}
			var tblinkdata = tableLinkData.getValue();
			var array = [];
			if(tblinkdata != '[]' && tblinkdata != ''){
				array = JSON.parse(tblinkdata);
				for(var i=0;i<array.length;i++){
					if(array[i].fromtable == lastFromTable){
						array.splice(i, 1);
						break;
					}
				}
			}
			var keyLink = [];
			for(var i=0;i<keyData.length;i++){
				keyLink.push({
					"fromkey":keyData[i].fromkey,
					"targetkey":keyData[i].targetkey,
					"condition":keyData[i].condition,
				});	
			}
			var fieldLink = [];
			for(var i=0;i<fieldData.length;i++){
				fieldLink.push({
					"fromfield":fieldData[i].fromfield,
					"targetfield":fieldData[i].targetfield,
					"isupdate":fieldData[i].isupdate==1?1:0
				});	
			}
			array.push({
				"fromtable" : lastFromTable,
				"targettable" : lastTargetTable,
				"keyLink": keyLink,
				"fieldLink": fieldLink
			});
			tableLinkData.setValue(JSON.stringify(array));
			tableLinkDataValue=JSON.stringify(array);
		}
		
		function add() {
			var newRow = {};
			keygrid.addRow(newRow, 0);
			mini.get("fromkeyList").setData(fromfieldList);
			mini.get("targetkeyList").setData(targetfieldList);
			//keygrid.getCellEditor(2, 0).setData(fieldList);
		}

		//删除选中
		function deleteSelected() {
			keygrid.removeRows(keygrid.getSelecteds(), false);
			//setGridData();
		}
		
		function addField() {
			var newRow = {};
			fieldgrid.addRow(newRow, 0);
			mini.get("fromfieldList").setData(fromfieldList);
			mini.get("targetfieldList").setData(targetfieldList);
			//grid2.getCellEditor(2, 0).setData(fieldList);
		}

		//删除选中
		function deleteSelectedField() {
			fieldgrid.removeRows(fieldgrid.getSelecteds(), false);
			//setGridData2();
		}

		//保存修改,不需要入库，只需要将配置内容传给父页面
		function save() {
			if (epoint.validate()) {
				// 把表格的数据拿出来放到隐藏域中
				setGridData();
				var nodeForm = getForm();
				if (epoint.validate()) {
					epoint.execute('add', '@all', function(data) {
		        		if(data.msg.indexOf('成功')!=-1||data.msg.indexOf('流程异常')!=-1){
		        			epoint.alert(data.msg,'',function(){
		        				window.history.back();
		        			});
		        		}else{
		        			epoint.alert(data.msg);
		        		}
		        	});
				}
			}
		}
		
		function updateFieldMap(sysGuid) {
			var fromDataSource = mini.get("fromDataSource").value;
			var targetDataSource = mini.get("targetDataSource").value;
			var columnLinkList = fieldgrid.getData();
			localStorage.setItem("cloumnlink",JSON.stringify(columnLinkList));
			epoint.openDialog('字段映射',
					'./cdcconsumerfieldmap?fromDataSource=' + fromDataSource + "&targetDataSource=" + targetDataSource 
							+ "&tableName=" + tblinkVal, function(data) {
						if (data != 'close') {
							console.log(data);
							fieldgrid.load({
								'columnTableData' : data
							});
						}
					}, {
						'width' : 1000,
						'height' : 600
					});
		}
		

		function adds() {
			//获取源字段中数据并解析
			var items = grid1.getSelecteds();
			var items2 = grid11.getSelecteds();
			if (items.length == 1 && items2.length == 1) {
				var items3 = {
					"fromTable" : items[0].fromTable,
					"targetTable" : items2[0].targetTable
				};
				if(!isShowFields){
					grid1.removeRows(items);
					grid11.removeRows(items2);
				}
				var items4 = clone(items3);
				grid2.addRow(items3, 0);
				tablelinkDatagrid.addRow(items4,0);
			} else {
				epoint.alert("请选择来源表或目标表", '', null, 'warning');
			}
		}

		function removeAll() {
			var items3 = grid2.getData();
			var items4 = tablelinkDatagrid.getData();
			var length = Object.keys(items3).length
			grid2.removeRows(items3);
			tablelinkDatagrid.removeRows(items4);
			grid1.load();
			keygrid.load();
			fieldgrid.load();
			epoint.refresh(['grid11','form'],'');
			tableLinkDataValue = '';
		}

		function addAll() {
			var items = grid1.getData();
			var items2 = grid11.getData();
			var length1 = Object.keys(items).length;
			var length2 = Object.keys(items2).length;
			var count = 0;
			for (var i = 0; i < length1; i++) {
				for (var j = 0; j < length2; j++) {
					if ((items[i].fromTable.toLowerCase()) == (items2[j].targetTable.toLowerCase())) {
						count++;
						var res1 = [];
						res1.push(items[i]);
						var res2 = [];
						res2.push(items2[j]);
						var items3 = {
							"fromTable" : res1[0].fromTable,
							"targetTable" : res2[0].targetTable
						}
						if(!isShowFields){
							grid1.removeRows(res1);
							grid11.removeRows(res2);
						}
						var items4 = clone(items3);
						grid2.addRow(items3, 0);
						tablelinkDatagrid.addRow(items4,0);
						break;
					}

				}
			}
			if (count == 0) {
				epoint.alert("没有匹配的表", '', null, 'warning');
			}
		}

		function removes() {
			var items3 = grid2.getSelecteds();
			var length = Object.keys(items3).length
			grid2.removeRows(items3);
			
			for (var i = 0; i < length; i++) {
				var items = grid1.getData();
				var items2 = grid11.getData();
				var length1 = Object.keys(items).length;
				var length2 = Object.keys(items2).length;
				var flag1 = true;
				var flag2 = true;
				for (var j = 0; j < length1; j++) {
					if(items[j].fromTable.toLowerCase() == items3[i].fromTable.toLowerCase()){
						flag1 = false;
					}
				}
				for (var j = 0; j < length2; j++) {
					if(items2[j].targetTable.toLowerCase() == items3[i].targetTable.toLowerCase()){
						flag2 = false;
					}
				}
				if(flag1){
					grid1.addRow(items3[i]);
				}
				if(flag2){
					grid11.addRow(items3[i]);
				}
				// 移除表关联信息
				var items4 = tablelinkDatagrid.findRows(function(row){
				    if(row.fromTable == items3[i].fromTable) return true;
				});
				tablelinkDatagrid.removeRow(items4[0]);
				var array = JSON.parse(tableLinkDataValue);
				for(var i=0;i<array.length;i++){
					if(array[i].fromtable == items4[0].fromTable){
						array.splice(i, 1);
						break;
					}
				}
				tableLinkDataValue = JSON.stringify(array);
			}
		}

		function upItem() {
			var items = grid2.getSelecteds();
			grid2.moveUp(items);
		}
		function downItem() {
			var items = grid2.getSelecteds();
			grid2.moveDown(items);
		}
		
		//搜索源，目标
		/* function searchPrimaryKey() {
			var sourceField = mini.get("sourceField").getValue();
			if (sourceField != "") {
				var items = grid1.getData();
				var j = 0;
				for (var i = 0; i < items.length; i++) {
					var fromField = items[i].sourceField;
					var sourceFieldReg = null;
					sourceFieldReg = new RegExp(sourceField, "i");
					if (sourceFieldReg.test(fromField)) {
						grid1.moveRow(
								grid1.getRow(i), j);
						j++;
					}
				}
			}
			var targetField = mini.get("targetField").getValue();
			if (targetField != "") {
				var items2 = grid11.getData();
				var j = 0;
				for (var i = 0; i < items2.length; i++) {
					var toField = items2[i].targetField;
					var targetFieldReg = null;
					targetFieldReg = new RegExp(targetField, "i");
					if (targetFieldReg.test(toField)) {
						grid11.moveRow(
								grid11.getRow(i), j);
						j++;
					}
				}
			}
		} */
		

		function clone(Obj){
			var buf;
			if(Obj instanceof Array){
				buf=[];
				var i=Obj.length;
				while(i--){
					buf[i]=clone(Obj[i]);
				}
				return buf;
			}
			else if(Obj instanceof Object){
				buf={};
				for(var k in Obj){
					buf[k]=clone(Obj[k]);
				}
				return buf;
			}else{
				return Obj;
			}
		}
		
		tablelinkDatagrid.on('rowclick', function(e) {
			//[{"fromtable":"","targettable":"","keyLink":[{"fromkey":"","targetkey":"","condition":""}],"fieldLink":[{"fromfield":"","targetfield":"","isupdate":""}]}]
			var fromTable = e.record.fromTable;
			var targetTable = e.record.targetTable;
			//缓存选中字段
			var array = [];
			var tblinkdata = tableLinkDataValue;
			if(tblinkdata != '[]' && tblinkdata!='' && tblinkdata!=null){
				array = JSON.parse(tblinkdata);
			}
			if(tblinkVal != '' ){
				var lastFromTable = tblinkVal.split(';')[0];
				var	lastTargetTable = tblinkVal.split(';')[1];
				var keyData = keygrid.getData();
				var fieldData = fieldgrid.getData();
				if(tblinkdata != '[]' && tblinkdata!=''){
					array = JSON.parse(tblinkdata);
					for(var i=0;i<array.length;i++){
						if(array[i].fromtable == lastFromTable){
							array.splice(i, 1);
							break;
						}
					}
				}
				var keyLink = [];
				for(var i=0;i<keyData.length;i++){
					keyLink.push({
						"fromkey":keyData[i].fromkey,
						"targetkey":keyData[i].targetkey,
						"condition":keyData[i].condition,
					});	
				}
				var fieldLink = [];
				for(var i=0;i<fieldData.length;i++){
					fieldLink.push({
						"fromfield":fieldData[i].fromfield,
						"targetfield":fieldData[i].targetfield,
						"isupdate":fieldData[i].isupdate==1?1:0
					});	
				}
				array.push({
					"fromtable" : lastFromTable,
					"targettable" : lastTargetTable,
					"keyLink": keyLink,
					"fieldLink": fieldLink
				});
			}
			tableLinkData.setValue(JSON.stringify(array));
			tableLinkDataValue = JSON.stringify(array);
			
			tblinkVal = fromTable+';'+targetTable;
			mini.get('tblink').setValue(tblinkVal);
			epoint.execute('getOwnFields',['tblink','key-datagrid','field-datagrid','fromDataSource','targetDataSource'], '' ,function(data){
				fromfieldList = data.fromField;
				targetfieldList = data.targetField;
				keygrid.setData(null);
				fieldgrid.setData(null);
 				//渲染选中字段
				if(array != '[]'){
					for(var i=0;i<array.length;i++){
						if(array[i].fromtable == fromTable){
							if(mini.get("fromkeyList") != undefined){
								mini.get("fromkeyList").setData(fromfieldList);
								mini.get("targetkeyList").setData(targetfieldList);
								mini.get("fromfieldList").setData(fromfieldList);
								mini.get("targetfieldList").setData(targetfieldList);
							}
							var keyList = JSON.parse(array[i].keyLink);
							var fieldList = JSON.parse(array[i].fieldLink);
  							for(var j=0;j<keyList.length;j++){
								var newRow = {
									"fromkey":keyList[j].fromkey,
									"targetkey":keyList[j].targetkey,
									"condition":keyList[j].condition
								};
								keygrid.addRow(newRow, 0);
							}
  							for(var j=0;j<fieldList.length;j++){
								var newRow = {
									"fromfield":fieldList[j].fromfield,
									"targetfield":fieldList[j].targetfield,
									"isupdate":fieldList[j].isupdate==1?1:0
								};
								fieldgrid.addRow(newRow, 0);
							}
  							mini.get("fromkeyList").setData(fromfieldList);
							mini.get("targetkeyList").setData(targetfieldList);
							mini.get("fromfieldList").setData(fromfieldList);
							mini.get("targetfieldList").setData(targetfieldList);
							break;
						}
					}	
				} 
			});
		});
		
        // 选择节点
        function nodeSelect(e){
        	node.setValue(e.value);
        	mini.get('producerGuid').setValue('');
        	mini.get('topicName').setValue('');
        	mini.get('fromDataSource').setValue('');
        	mini.get('targetDataSource').setValue('');
        	epoint.refresh(['nodeGuid','producerGuid','fromDataSource','targetDataSource'],'');
        }
        
    	 // 选择监听任务
        function producerSelect(e){
        	producer.setValue(e.value);
        	epoint.execute('getTopic','producerGuid', '' , function(data){
        		if(data.topicName){
        			mini.get('topicName').setValue(data.topicName);
        		}
        		fromDataSource.setValue('');
        		epoint.refresh(['producerGuid','fromDataSource'],'');
        	});
        }
        
		
	</script>
</body>

</html>