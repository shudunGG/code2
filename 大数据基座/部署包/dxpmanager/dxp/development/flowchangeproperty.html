<!DOCTYPE html>
<html lang="zh-CN">

<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>流程转换</title>
<script src="../../frame/fui/js/cssboot.js"></script>
</head>
<style>
body, html {
	overflow: auto !important;
}
</style>
<body>

	<!-- 	<div class="page-loading"></div> 
	<!-- toolbar区域 -->
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<a id="savetype" class="mini-button mini-btn-primary"
				onclick="saveModify">保存并关闭</a> <a id="deletetype"
				class="mini-button mini-btn-danger" onclick="deleteSelectedRecord">删除选中</a>
				<a id="openTrans" class="mini-button mini-btn-primary" onclick="openTrans">打开转换详情</a>
		</div>
	</div>

	<div id="form" class="fui-form">
		<input id="argument" name="argument" class="mini-textbox hidden">
		<input id="namedParam" name="namedParam" class="mini-textbox hidden">
		<input id="copyPreResultToPosition" name="copyPreResultToPosition"
			class="mini-textbox hidden"> <input id="copyPreResultToNamed"
			name="copyPreResultToNamed" class="mini-textbox hidden"> <input
			id="passAllValues" name="passAllValues" class="mini-textbox hidden">

		<div role="row" style="padding-top: 1px">
			<div role="control" label="流程名称" starred="true">
				<input id="changeName" name="changeName" class="mini-textbox"
					required="true" emptyText="请输入流程名称" />
			</div>
		</div>

		<div role="row">
			<div role="control">Options :</div>
		</div>

		<div role="row">
			<div role="control">
				<div id="executedEachInputRow" name="executedEachInputRow"
					class="mini-checkbox">执行每一个输入行</div>
			</div>
			<div role="control">
				<div id="waitForRemoteEnd" name="waitForRemoteEnd"
					class="mini-checkbox">等待远程转换执行结束</div>
			</div>
		</div>
		<div role="row">
			<div role="control">
				<div id="clearRowsBeforeExec" name="clearRowsBeforeExec"
					class="mini-checkbox">在执行前清除结果行列表</div>
			</div>
			<div role="control">
				<div id="localAndRemoteEnd" name="localAndRemoteEnd"
					class="mini-checkbox">本地转换终止时远程转换也通知终止</div>
			</div>
		</div>
		<div role="row">
			<div role="control">
				<div id="clearFileListBeforeExec" name="clearFileListBeforeExec"
					class="mini-checkbox">在执行前清除结果文件列表</div>
			</div>
		</div>
	</div>

	</div>


	<table>
		<tr>
			<td style="width: 50%"><span style="padding-left: 20px">Arguments
					:</span>
				<div role="row" style="padding-left: 20px">
					<div role="control">
						<div id="copyPreResultToPositionBox"
							name="copyPreResultToPositionCheckBox" class="mini-checkbox">复制上一步结果到位置参数</div>
					</div>
				</div>
				<div class="" style="padding-top: 1px">
					<div class="btn-group mr10">
						<a class="mini-button mini-btn-primary" onclick="add"
							style="margin-left: 20px">新增参数</a>
					</div>
				</div> <!-- 内容区域 -->
				<div class="fui-content" style="padding-top: 1px">
					<div id="datagrid" name="datagrid" class="mini-datagrid"
						idField="roleTypeGuid" multiSelect="true" allowCellValid="true"
						allowCellEdit="true" style="width: 100%; height: 80%;"
						allowResize="true" showPager="false" allowCellSelect="true"
						editNextOnEnterKey="true" editNextRowCell="true">
						<div property="columns">
							<div type="checkcolumn" width="55"></div>
							<div type="indexcolumn" width="55" headerAlign="center">序</div>
							<div field="argument" headerAlign="center" width="150"
								align="left" vtype="required">
								Argument <input field="argumentField" property="editor"
									class="mini-textbox" bind="argumentField" maxLength="50"
									style="width: 100%" />
							</div>
						</div>
					</div>
				</div></td>

			<td style="width: 50%"><span style="padding-left: 20px">命名参数
					:</span>
				<div role="row" style="padding-left: 20px">
					<div role="control">
						<div id="copyPreResultToNamedBox" name="copyPreResultToNamedBox"
							class="mini-checkbox">复制上一步结果到命名参数</div>
						<div role="control">
							<div id="passAllValuesBox" name="passAllValuesBox"
								class="mini-checkbox">将所有参数值都传递到子转换</div>
						</div>
					</div>
				</div>
				<div class="btn-group mr10" style="padding-top: 1px">
					<div class="btn-group mr10">
						<a class="mini-button mini-btn-primary" onclick="addDataGrid2"
							style="margin-left: 20px">新增参数</a>
					</div>
				</div>
				<div class="fui-content" style="padding-top: 1px">
					<div id="datagrid2" name="datagrid2" class="mini-datagrid"
						multiSelect="true" allowCellValid="true" allowCellEdit="true"
						style="height: 100%;" allowResize="true" showPager="false"
						allowCellSelect="true" editNextOnEnterKey="true"
						editNextRowCell="true">
						<div property="columns">
							<div type="checkcolumn" width="55"></div>
							<div type="indexcolumn" width="55" headerAlign="center">序</div>
							<div field="namedParam" headerAlign="center" width="200">
								命名参数<input field="namedParamField" property="editor"
									class="mini-textbox" maxLength="50" style="width: 100%" />
							</div>
							<div field="flowName" headerAlign="center" width="200">
								流列名<input field="flowNameField" property="editor"
									class="mini-textbox" maxLength="50" style="width: 100%" />
							</div>
							<div field="value" headerAlign="center" width="200">
								值<input field=valueFiled property="editor" class="mini-textbox"
									maxLength="50" style="width: 100%" />
							</div>
						</div>
					</div>
				</div></td>
		</tr>
	</table>



	<script src="../../frame/fui/js/jsboot.js"></script>

	<script>
		var grid = mini.get("datagrid");
		var grid2 = mini.get("datagrid2");
		var form = new mini.Form("#form");
	
		function pageLoad() {
			var data = top.nodeData;
			nodeguid = GetQueryString('nodeGuid');
			transid = data.key;
			if (data.id) {
				//从父页面获取表单数据
				var nodeData = mini.decode(data.id);
				
				//填充表单数据
				form.setData(nodeData);
				grid.setData(mini.decode(nodeData.argument));
				grid2.setData(mini.decode(nodeData.namedParam));
				
				mini.get('copyPreResultToPositionBox').setValue(nodeData.copyPreResultToPosition);
				mini.get('copyPreResultToNamedBox').setValue(nodeData.copyPreResultToNamed);
				mini.get('passAllValuesBox').setValue(nodeData.passAllValues);
			}else{
				mini.get('changeName').setValue(data.name);
			}
            
			
        }
		

		

		//新增类别
		function add() {
			var newRow = {
			//lx : "保留非全局角色"
			};
			grid.addRow(newRow, 0);
			grid.beginEditRow(newRow);
		}
		
		//新增格式
		function addDataGrid2() {
			var newRow = {
			};
			grid2.addRow(newRow, 0);
			grid2.beginEditRow(newRow);
		}

		//删除选中
		function deleteSelectedRecord(){
			if(mini.get('datagrid').getSelecteds().length==0 && mini.get('datagrid2').getSelecteds().length==0){
				epoint.alert('请选择要删除的记录!', '', null, 'warning');
				} else {
					epoint.confirm('确认删除?','', deleteSelected);
				}
		}
		
		function deleteSelected() {
			if (grid.getSelecteds()) {
				grid.removeRows(grid.getSelecteds(), false);
			}
			if (grid2.getSelecteds()) {
				grid2.removeRows(grid2.getSelecteds(), false);
			}
			setGridData();
		}

		//保存修改
		function saveModify() {
			grid.validate();
			if (grid.isValid() == false) {
				var error = grid.getCellErrors()[0];
				grid.beginEditCell(error.record, error.column);
				return;
			}
			if (epoint.validate()) {
				// 把表格的数据拿出来放到隐藏域中
				setGridData();
				var data = form.getData(true, false);
				epoint.closeDialog(mini.encode(data));
			}
		}

		function setGridData() {
			var datas = grid.getData();
			var arguments = [];
			for (var i = 0; i < datas.length; i++) {
				var row = datas[i];
				arguments.push({
					"argument" : row.argument
				});
			}
			
			var copyPreResultToPosition = mini.get('copyPreResultToPositionBox').value;
			
			var datas2 = grid2.getData();
			var array = [];
			for (var i = 0; i < datas2.length; i++) {
				var row = datas2[i];
				array.push({
					"namedParam" : row.namedParam,
					"flowName" : row.flowName,
					"value" : row.value
				});
			}
			
			var copyPreResultToNamed = mini.get('copyPreResultToNamedBox').value;
			var passAllValues = mini.get('passAllValuesBox').value;
	
			
			mini.get('argument').setValue(JSON.stringify(arguments));
			mini.get('namedParam').setValue(JSON.stringify(array));
			
			//checkbox不选择时，可能为空，故进行判断
			if (copyPreResultToPosition) {
				mini.get('copyPreResultToPosition').setValue(copyPreResultToPosition);
			}else{
				mini.get('copyPreResultToPosition').setValue("false");
			}
			
			if (copyPreResultToNamed) {
				mini.get('copyPreResultToNamed').setValue(copyPreResultToNamed);
			}else{
				mini.get('copyPreResultToNamed').setValue("false");
			}
			
			if (passAllValues) {
				mini.get('passAllValues').setValue(passAllValues);
			}else{
				mini.get('passAllValues').setValue("false");
			}
			
		}
		
		function openTrans(){
			window.open("../../dxp/development/add-taskdevelopment?id="+transid+"&nodeguid="+nodeguid);
		}
		
		function GetQueryString(name){
			var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
		    var r = window.location.search.substr(1).match(reg);
		    if (r != null) {
			    return decodeURIComponent(r[2]); 
		    }	
		    return null;
		}
	</script>
</body>

</html>