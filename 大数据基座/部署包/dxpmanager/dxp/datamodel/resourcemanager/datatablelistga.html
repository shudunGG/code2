<!DOCTYPE html>
<html>

<head>
    <title>数据管理</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <script src="../../../frame/fui/js/cssboot.js"></script>
    <script>
	SrcBoot.output([ 'modelga/style/globalresource.css' ]);


    </script>
</head>

<body>
<div class="page-loading"></div>

<div class="fui-left">
    <div role="head" title="选择数据库">
    </div>
    <div role="body">
        <ul id="tree" class="mini-tree" style="height: 100%" textField="text"
            idField="id" parentField="pid" action="getTreeData"
            resultAsTree="false" onbeforenodeselect="beforenodeselect"></ul>
    </div>
</div>

<div class="fui-right">
    <!-- toolbar区域 -->
    <div class="page-toolbar clearfix">
        <span class="toolbar-button" onclick="saveAll()">保存元数据</span> <span
            class="toolbar-button" onclick="saveAndClose()">采集元数据</span><span
            class="toolbar-button" onclick="synctablestruct()">同步表结构</span><span
            class="toolbar-button" id="delete" onclick="deleteSelected()">删除元数据</span><span
            class="toolbar-button" id="grantbat" onclick="grantbat()">授权</span><span
            class="toolbar-button" id="refreshcache" onclick="refreshcache()">刷新数据表缓存</span>
    </div>


    <div class="fui-condition">
        <!-- 表单布局 -->
        <div class="fui-form" id="fui-form">
            <div role="form">
                <!-- 2列 -->
                <div role="row">
                    <div role="control" label="表中文名称" starred="false">
                        <input bind="tableName" id="tableName" class="mini-textbox"/>

                    </div>
                    <div role="control" label="表英文名称">
                        <input bind="sqlTableName" id="sqlTableName" class="mini-textbox"/>
                    </div>
                </div>
                <!-- 添加隐藏域，用于树与表格的联动  -->
                <input bind="treecategorynum" id="treecategorynum"
                       class="mini-hidden"/>
            </div>
        </div>
        <!-- 搜索按钮 -->
        <a role="searcher" callback="searchData"></a>
    </div>
    <div class="mini-fit">
        <div id="datagrid" style='width: 100%;height:100%' class="mini-datagrid" sortOrder="desc"
             idField="tableid" multiSelect="true"
             allowResize="true" onlyCheckSelection="true"
             allowCellValid="true" action="getTableData" showPager="true"
             allowCellEdit="true" allowCellSelect="true" pagerType="pagination"
             editNextOnEnterKey="true" editNextRowCell="true">
            <div property="columns">
                <div type="checkcolumn" width="30"></div>
                <div type="indexcolumn" headerAlign="center" width="40">序</div>
                <div field="TableName" width="160" headerAlign="center"
                     vtype="required;maxLength:100">
                    表中文名称 <input property="editor" class="mini-textbox"
                                 style="width: 99%"/>
                </div>
                <div field="Sql_TableName" width="100" headerAlign="center">表英文名称</div>
                <div field="tabletypeguid" width="80" headerAlign="center" align="center" type="comboboxcolumn">类别
                    <input property="editor" class="mini-combobox" textField="text"
                               style="width: 100%"  valueField="value" showClose="true" autoClear="true"/>
                </div>
                <div field="orderNum" width="80" headerAlign="center"
                     align="center" vtype="required;int;range:0,99999">
                    排序号 <input property="editor" class="mini-textbox"
                               style="width: 99%"/>
                </div>
                <div width="80" name="show" headerAlign="center" align="center"
                     renderer="onShowRenderer">数据结构
                </div>
                <div width="80" headerAlign="center" align="center"
                     renderer="onDataRenderer">查看数据
                </div>
                <div width="80" headerAlign="center" align="center"
                renderer="onGrantRenderer">授权
                </div>
                <div field="tabletype" visible="false"></div>
                <div field="dsid" visible="false"></div>
            </div>
        </div>
    </div>
</div>
<script src="../../../frame/fui/js/jsboot.js"></script>
<script>
		//<![CDATA[

		var grid = mini.get("datagrid");
		var typeList=[];
		//初始化页面
		epoint.initPage("dxpmodeldatatablebasicinfolistaction",null,function(data){
            if(!data.isAdmin){
                //非管理员
                grid.hideColumn(8);
                $('#grantbat').hide();
                $('#delete').hide();
            }
		});

		function epoint_preload(ctrs,data) {
			grid.getCellEditor(4,0).setData(data.typelist);
        }

		//树js对象
		var tree = mini.get("tree");
		// 点击左侧树刷新右侧表格
		tree.on("nodeselect", function(e) {
			var id = e.node.id;
			var text = e.node.text;
			var pid = e.node.pid;
			mini.get('treecategorynum').setValue(id);
			searchData2();
		});

		// 绘制修改按钮
		var onEditRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "openEdit",
					"tableid,tabletype");
		};

		// 绘制授权按钮
		var onSqRenderer = function(e) {
			return epoint
					.renderCell(e, "action-icon icon-gear", "setViewRight");
		};

		//修改
		function openEdit(e) {
			var config = epoint.decodeJson(e);
			if (config.tabletype == 3) {
				epoint.openDialog('修改实体',
						'frame/epointmis/backend/TableBasicViewEdit?tableID='
								+ config.tableid, function() {
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						}, {
							'width' : 1000,
							'height' : 400
						});
			} else if (config.tabletype == 5) {
				epoint.openDialog('修改填报表',
						'frame/epointmis/backend/FillInTableEdit?tableID='
								+ config.tableid, searchData, {
							'width' : 1200,
							'height' : 550
						});
			} else {
				epoint.openDialog('修改数据表',
						'frame/pages/eianalysemis/datasource/tablebasicinfoedit?tableID='
								+ config.tableid, function() {
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						}, {
							'width' : 1000,
							'height' : 400
						});
			}
		}

		// 授权
		function setViewRight(tableID) {
			epoint.openDialog('设置数据表权限',
					'framemanager/metadata/mis/tableinfo/settingviewright?tableID='
							+ tableID, searchData, {
						'width' : 700,
						'height' : 550
					});
		}

		// 绘制表结构按钮
		var onShowRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-doc", "tableStruct",
					"tableid,tabletype");
		};

		//绘制查看数据按钮
		var onDataRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-search",
					"searchRecord");
		}
		//绘制授权按钮
		var onGrantRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-gear",
					"grant");
		}

		//绘制查看数据按钮
		var removeRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-forward",
					"removeCatelog", "dsid,tableid");
		}

		function removeCatelog(e) {
			epoint.openDialog('采集目录编辑',
					"frame/pages/eianalysemis/datasource/removecategory?treecategorynum2="
							+ e.dsid + ",0&tableid=" + e.tableid, searchData, {
						'width' : 1000,
						'height' : 500
					});
		}

		//查看数据
		function searchRecord(id) {
			epoint.openDialog('数据列表',
					'./viewtabledata?tableID='
							+ id, function(ret) {

					});
		}

		function grant(id){
	        epoint.openDialog('授权',
					'./settingallowtoall?tableID='
							+ id, function(ret) {
					});

		}

		function grantbat(){
            var datagrid = mini.get('datagrid');
			var ids = datagrid.getSelectedIds();
			if (ids.length > 0) {
			   var id= ids.join(',');
                epoint.openDialog('授权',
					'./settingallowtoall?tableID='
							+ id, function(ret) {
					});

			}else{
			    epoint.alert('请选择要授权的数据表记录！');
			}

		}

		// 表结构
		function tableStruct(e) {
			var config = epoint.decodeJson(e);
			if (config.tabletype == 3) {
				epoint.openDialog('实体结构',
						'frame/epointmis/backend/TableStructViewList?tableID='
								+ config.tableid, function() {
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						}, {
							'width' : 1200,
							'height' : 550
						});
			} else {
				epoint.openDialog('数据表结构',
						'./tablestructlist?tableID='
								+ config.tableid, function() {
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						});
			}
		}
		// 回调刷新
		function callBack(param) {
			if (param) {
				searchData2();
			}
		}

		// 采集数据对象
		function saveAndClose() {
			if (!mini.get('treecategorynum').getValue()||mini.get('treecategorynum').getValue()==0
					|| !mini.get('treecategorynum').getValue().split(",")[0]) {
				epoint.alert('请选择数据源！');
			}

			else {
				epoint.openTopDialog('采集元数据',
						'./datatableselect?dsID='
								+ mini.get('treecategorynum').getValue(), callback, {
							'width' : 800,
							'height' : 550
						});
			}
		}
		//刷新库中表的缓存
		function refreshcache() {
			if (!mini.get('treecategorynum').getValue()
					|| !mini.get('treecategorynum').getValue().split(",")[0]) {
				epoint.alert('请选择数据源！');
			}
			else {
				epoint.execute('refreshcache','',mini.get('treecategorynum').getValue(),function(data){
					epoint.alert(data.msg);
				});
			}
		}

		// 删除
		function deleteSelected() {
		var datagrid = mini.get('datagrid');
			var ids = datagrid.getSelectedIds();
			if (ids.length > 0) {
		epoint.confirm("确定删除？", "", function(action) {

			epoint.execute('deleteSelected', '', function(data) {
				if (data.msg) {
					epoint.alertAndRefresh(data.msg);
				}
			});
			});
			}else{
			    epoint.alert('请选择需要删除的记录！');
			}
		}

		// 回掉提醒
		function msgCallBack(data) {
			var msg = data.msg;
			if (msg) {
				if (msg.indexOf("成功") == -1) {
					epoint.alert(msg, '', '', 'warning');
					searchData();
				} else {
					epoint.alert(msg);
					searchData();
				}
			}
		}

		// 表格的搜索
		function searchData() {
			epoint
					.refresh([ 'datagrid', 'treecategorynum', 'fui-form',
							'tree' ]);
		}

		function searchData2() {
			epoint.refresh([ 'datagrid', 'treecategorynum', 'fui-form' ], '',
					true);
		}

		//禁止选中父节点  --是否需要禁止选中父节点
		function beforenodeselect(e) {
			var id = e.node.id;
			if (id == '') {
				e.cancel = true;
			}
		}

		//新增数据表
		function addTable() {
			epoint.openDialog('添加数据表',
					'frame/pages/eianalysemis/datasource/tablebasicinfoadd',
					function() {
						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
					}, {
						'width' : 1000,
						'height' : 450
					});
		}

		// 保存信息
		function saveAll() {
			if (mini.get('datagrid').isValid()) {
				epoint.execute('saveAll', [ 'datagrid', 'fui-form' ],
						msgCallBack);
			} else {
			    var error = mini.get('datagrid').getCellErrors()[0];
			    grid.beginEditCell(error.record, error.column);
				if(error.column.field=='TableName'){
				   epoint.alert('表中文名称'+error.errorText, '', null, 'warning');
				}else{
				   epoint.alert('排序号的值必须在0-99999之间!', '', null, 'warning');
				}
			}
		}

		function callback(param) {
			if ("close" == param) {
				searchData2();
			} else {
				searchData();
			}
		}

		function updateTableTree() {
			epoint.refresh([ 'tree' ]);
		}

		function onUploadBeforeSend(obj, data, headers) {
			var dsID = mini.get("treecategorynum").getValue();
			obj.data.dsID = dsID;
		}

		//刷新数据源
		function refreshSource() {
			epoint.refresh([ 'tree', 'isShow' ]);
		}

		//导入文件
		function importfile() {
			epoint
					.openTopDialog(
							'导入数据选择',
							'frame/pages/eianalysemis/datasource/selectdatatableuploader',
							searchData, {
								'width' : 700,
								'height' : 550
							});
		}

		//同步表结构
		function synctablestruct() {
			var datagrid = mini.get('datagrid');
			var ids = datagrid.getSelectedIds();
			if (ids.length > 0) {
				epoint.confirm("同步后原先字段配置会清空！确定同步表结构？", "", function(action) {
					epoint.execute(
							"synctablestruct",
							"","", function(data) {
								if (data) {
									epoint.alert(data, null, null, 'info');
									searchData();
								}
							});
				});
			} else {
				epoint.alert("请选择要同步的表!", null, null, 'warning');
			}
		}

		function editcategory() {
			var treecategorynum2 = mini.get('treecategorynum').getValue();
			if (!treecategorynum2 || treecategorynum2.split(",")[1] == '-1') {
				epoint.alert("请选择到数据源根目录进行编辑！");
			} else {
				epoint.openDialog('节点编辑',
						"frame/pages/eianalysemis/datasource/editcategory?treecategorynum2="
								+ treecategorynum2, searchData, {
							'width' : 1000,
							'height' : 500
						});
			}
		}
		//_$t


</script>

</body>
</html>