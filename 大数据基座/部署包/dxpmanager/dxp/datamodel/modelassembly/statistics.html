<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>数值统计</title>
    <!-- 请修改相对路径 -->
    <script src="../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
<!-- 必须有，加载时的loading效果 -->
<div class="page-loading"></div>
<!-- toolbar区域 -->
<div class="fui-toolbar">
    <div class="btn-group mr10">
        <a class="mini-button mini-btn-primary" id="save"
           onclick="saveModify">保存修改</a> <a
            class="mini-button mini-btn-primary" onclick="epoint.closeDialog">关闭</a>
    </div>
</div>

<!-- 内容区域 -->
<div class="fui-content">
    <div id="form" class="fui-form" style="width: 90%">
        <div role="form">
            <div role="row">
                <div role="control" label="步骤名称" starred="true">
                    <input id="stepName" name="stepName" class="mini-textbox" vtype="maxLength:20"
                           required="true" emptyText="请输入步骤名称" requiredErrorText="步骤名称不能为空！"/>
                </div>
            </div>
            <div role="row">
                <div role="control" label="统计类型" starred="true">
                    <div id="functype" name="functype" data="[{'id':'sum','text':'求和'},{'id':'count','text':'统计数量'}]"
                         class="mini-combobox" textField="text" valueField="id" requiredErrorText="转换类型不能为空！"
                         required="true" onvaluechanged="onvaluechanged"></div>
                </div>
                <div role="control" label="列选择" starred="true" id="columnselect">
                    <input id="columnid" name="columnid" class="mini-combobox"
                           textField="text" valueField="id" action="getNumberPreFields"
                           emptyText="请选择..." required="true" allowInput="false"
                           showNullItem="false" nullItemText="请选择..." requiredErrorText="列选择不能为空！"/>
                </div>

            </div>
            <div role="row">
                <div role="control" label="字段名" starred="true">
                    <input id="newcolumnid" name="newcolumnid" class="mini-textbox"
                           required="true" onvalidation="englishjy"
                           requiredErrorText="字段名不能为空!"/>
                </div>
                <div role="control" label="中文注释" starred="true">
                    <input id="newcolumnname" name="newcolumnname" required="true"
                           class="mini-textbox" requiredErrorText="字段中文注释不能为空！"/>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 请修改相对路径 -->
<script src="../../../frame/fui/js/jsboot.js"></script>
<script src="./js/fieldcheck.js">
		SrcBoot.output([
	        'js/fieldcheck.js'
	    ]);

</script>

<script>
		//获取表单数据
		var selectcolumn = mini.get("columnid");
		var form = new mini.Form("#form");
		var stepNameForm = mini.get('stepName');
		var nodeData;
		var nodeInfo;
		var gridcount = 0;
		function getForm() {
			var data = form.getData(true, false);
			var s = mini.encode(data);
			return s;
		}
		function pageLoad() {
			//从父页面获取表单数据
			var data = top.nodeData;
			nodeInfo = data;
			nodeData = mini.decode(data.id);
			epoint.initPage('modelnumericalstatisticsaction?stepId='
					+ nodeInfo.key, {
				'nodeData' : epoint.encodeUtf(JSON.stringify(nodeData))
			}, initCallBack);
		}

		function initCallBack(e) {
			//填充表单数据
			form.setData(nodeData);
			var nodeName = nodeData.stepName;

			if (!nodeName) {
				stepNameForm.setValue(nodeInfo.name);
			}
			if(nodeData.functype=='sum'){
                Util.form.showField("#columnselect");
                Util.form.setLabel("#columnselect",'列选择');
			}else{
			    Util.form.hideField("#columnselect");
                Util.form.setLabel("#columnselect",'');
			}
		}

		//保存修改
		function saveModify() {
		if (epoint.validate('@all', false)) {
			//check 新增的字段名字不能和列选择存在的一样哦
			if (mini.get("columnid").getValue().toLowerCase() == mini.get(
					"newcolumnid").getValue()) {
				epoint.alert("新增字段名不能和选择的字段名称一样!");
				return;
			}
				var nodeForm = getForm();
				epoint.execute("save", '', [ nodeInfo, nodeForm ], function(
						data) {
					if (data.success == 'success') {
						epoint.closeDialog(nodeForm);
					} else {
						epoint.alert(data.msg, '', null, 'warning');
					}
				});
			}
		}

		function onCloseClick(e) {
			var obj = e.sender;
			obj.setText("");
			obj.setValue("");
		}

		function setType() {
			mini.get("converttype").setData([ {
				text : '转换为标准字符串',
				id : '0'
			} ]);
		}

		function englishjy(e) {
			var retainedFields = ['like','as'];
			if(retainedFields.indexOf(e.value) != -1){
				e.errorText = "字段名称不能为数据库保留字："+retainedFields;
				e.isValid = false;
				return;
			}
			var reg =  new RegExp("^[a-zA-Z][a-zA-Z0-9_]*$");
			var v = reg.test(e.value);
			if (!v) {
				e.errorText = "必须以字母开头，英文、数字、下划线作为字段组合名称!";
				e.isValid = false;
			}
	    }

	    function onvaluechanged(e){
	        if(e.value=='count'){
                Util.form.hideField("#columnselect");
                Util.form.setLabel("#columnselect",'');
	        }else{
	            Util.form.showField("#columnselect");
                Util.form.setLabel("#columnselect",'列选择');
	        }
	    }
		

</script>
</body>
</html>