<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>条件</title>
<!-- 请修改相对路径 -->
<script src="../../../frame/fui/js/cssboot.js"></script>
<link rel="stylesheet" href="./css/tablefilter.css" />
<style>
.nonebd {
	border-right: 0;
	border-bottom: 0;
}

#pwhereFilter {
	margin-top: 10px;
}
</style>
</head>

<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>
	<!-- toolbar区域 -->
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<a class="mini-button" id="addNew" onclick="confirmadd">确定</a>
			<a class="mini-button" id="cancleadd" onclick="epoint.closeDialog">取消</a>
		</div>
	</div>

	<!-- 内容区域 -->
	<div id="form" class="fui-form" style="padding-top: 1px">
		<div role="form">
			<input id="columnTableData" name="columnTableData"
				class="mini-hidden">
		</div>
	</div>
	<div class="mini-fit" style="padding-top: 1px">

		<div class="fui-content">
			<div id="form1" class="fui-form" style="width: 90%">
				<div role="form" id="form2">
					<div role="row">
						<div role="control" label="筛选条件"></div>
					</div>
					<div class="filter-data" id="filter-data"></div>
				</div>
			</div>
		</div></div>

	<!-- 请修改相对路径 -->
	<script type="x-tmpl-mustache" id="filter-template">
        <li class="filter-item">
            {{^first}}
            <div class="ext_select">
                <input class="mini-combobox filter-relate-select" showNullItem="false"
                    data="[{id: 1,name: '并'},{id: 2,name: '或'}]"
                    valueFromSelect value="{{relateVal}}"
                    textField="name" valueField="id" allowInput="true" />
            </div>
            {{/first}}

            <div class="clearfix">
                <div class="l mr-10 filter-category">
                    <input width="200px" name="category" id="pinputds" class="mini-combobox filter-category-select" showNullItem="false"
                        valueFromSelect value="{{categoryVal}}" onvaluechanged="fieldchange" requiredErrorText="条件字段不能为空"
                        textField="text" valueField="id" allowInput="false" required="true" />
                </div>
                <div class="l mr-10 filter-operate">
                    <input width="130px" onvaluechanged="valueChange" class="mini-combobox filter-operate-select" showNullItem="false"
                        data="[{id: 1,name: '日期范围'},{id: 2,name: '包含'},{id: 3,name: '不包含'},{id: 4,name: '起始包含'},{id: 5,name: '结尾包含'},{id: 6,name: '起始不包含'},{id: 7,name: '结尾不包含'},{id: 8,name: '空值'},{id: 9,name: '非空值'},{id: 10,name: '等于'},{id: 11,name: '小于'},{id: 12,name: '大于'},{id: 13,name: '小于等于'},{id: 14,name: '大于等于'},{id: 15,name: '不等于'},{id: 16,name: '包含(字段)'},{id: 17,name: '不包含(字段)'},{id: 18,name: '起始包含(字段)'},{id: 19,name: '结尾包含(字段)'},{id: 20,name: '起始不包含(字段)'},{id: 21,name: '结尾不包含(字段)'},{id: 22,name: '等于(字段)'},{id: 26,name: '小于(字段)'},{id: 27,name: '大于(字段)'},{id: 25,name: '小于等于(字段)'},{id: 24,name: '大于等于(字段)'},{id: 23,name: '不等于(字段)'}]"
                        valueFromSelect value="{{operateVal}}"
                        textField="name" valueField="id" allowInput="true" required="true" requiredErrorText="条件类型不能为空"/>
                </div>
                <div class="l mr-10 filter-time {{^showTime}}hidden{{/showTime}} {{#hideAll}}hidden{{/hideAll}} {{#showFilterField}}hidden{{/showFilterField}}">
                        <input width="200px" name="time" class="mini-datepicker mr-10 begin-time" format="yyyy-MM-dd H:mm:ss" showTime="true" timeFormat="H:mm:ss" showOkButton="true"  showTodayButton="false" value="{{beginTime}}" allowInput="false" />
                        <input  width="200px" name="time" class="mini-datepicker end-time" format="yyyy-MM-dd H:mm:ss" showTime="true" timeFormat="H:mm:ss" value="{{endTime}}" showOkButton="true" showTodayButton="false" allowInput="false" />
                    
                </div>
				
                <div class=" mr-10 filter-value {{#showTime}}hidden{{/showTime}} {{#hideAll}}hidden{{/hideAll}} {{#showFilterField}}hidden{{/showFilterField}} l">
                    <input name="" class="mini-textbox filter-value-input" value="{{filterVal}}" />
                </div>
				<div class="l mr-10 filter-dropdown {{#showTime}}hidden{{/showTime}} {{#hideAll}}hidden{{/hideAll}} {{^showFilterField}}hidden{{/showFilterField}}" >
                    <input width="200px" name="filterField" id="pinputds1" class="mini-combobox filter-dropdown-select" showNullItem="false"  allowInput="false"
                        valueFromSelect value="{{filterField}}" requiredErrorText="条件字段不能为空"
                        textField="text" valueField="id" allowInput="false" required="true" />
                </div>
                <div class="filter-icon l">
                    <a class="action-icon  {{#first}}filter-item-add icon-addcircle{{/first}} {{^first}}filter-item-min icon-minuscircle{{/first}}"></a>
                </div>
            </div>
        </li>
    </script>

	<script type="x-tmpl-mustache" id="filter-ul-template">
        <ul class="filter-box">
            {{^first}}
            <li class="filter-box-relate">
                <div class="box_ext_select">
                    <input class="mini-combobox filter-relate-select" showNullItem="false"
                        data="[{id: 1,name: '并'},{id: 2,name: '或'}]"
                        valueFromSelect value="{{relate}}"
                        textField="name" valueField="id" allowInput="true" />
                    
                </div>
            </li>
            {{/first}}

            {{{filterItem}}}
            
            
            <li class="filter-add">
                <div class="filter-icon l">
                    <a class="action-icon {{#first}}filter-box-add icon-addcircle{{/first}} {{^first}}filter-box-min icon-minuscircle{{/first}}"></a>
                </div>
            </li>
            
        </ul>
           
    </script>


	<script src="../../../rest/resource/jsboot"></script>
	<script src="./js/casewhenfilterindex.js"></script>

	<script>
		// 初始化页面
		var grid = mini.get('defaultModel');
		var form = new mini.Form("#form");
		var nodeData;
		var nodeInfo;
		var transGuid;
		var columnTemp;
		var rightConList;
		var compareTypeList;
		var sourceFieldList;

		function getForm() {
			var data = form.getData(true, false);
			var s = mini.encode(data);
			return s;
		}

		function pageLoad(pdata) {
			var condition=epoint.decodeJson(pdata.condition);
			var data = top.nodeData;
			nodeInfo = data;
			nodeData = mini.decode(data.id);
			form.setData(nodeData);
			if(condition.columnTableData){
				//喧染所有表格
				initHtml(eval('(' + condition.columnTableData + ')'));
				mini.parse();
			}
			epoint.initPage('modelcasewhenaction?stepId=' + nodeInfo.key, {
				'nodeData' : epoint.encodeUtf(JSON.stringify(nodeData))
			}, initCallBack);
		}

		function initCallBack(e) {
			//填充表单数据
			form.setData(nodeData);
			if (e.Genderstime1) {
				sourceFieldList = e.Genderstime1;
			}
			for(var i=0;i<mini.getsByName("category").length;i++){
				mini.getsByName("category")[i].setData(sourceFieldList);
			}
			for(var i=0;i<mini.getsByName("filterField").length;i++){
				mini.getsByName("filterField")[i].setData(sourceFieldList);
			}
		}

		var selectData = "";
		//保存
		function confirmadd() {
			mini.get('columnTableData').setValue(confirm());
 			if (epoint.validate('@all', true)) {
				var nodeForm = getForm();
				epoint.closeDialog(nodeForm);
			}
		}

		function chgds(src, rel) {
			var ds = mini.get('p' + src).getValue();
			epoint.execute("getTable", null, [ ds ], function(ret) {
				var relslst = rel.split(',');
				for (var i = 0; i < relslst.length; i++) {
					mini.get('p' + relslst[i]).setData(ret);
					//alert(mini.get('p' + relslst[i]).getAtt(""));
				}
			});
		}

		function chgtbl(src, rel) {
			var tbl = mini.get('p' + src).getValue();
			epoint.execute("getColumn", null, [ tbl ], function(ret) {
				var relslst = rel.split(',');
				for (var i = 0; i < relslst.length; i++) {
					mini.get('p' + relslst[i]).setData(ret);
				}
			});
		}

		function fieldchange(e) {
			var stype = e.selected.type.toLowerCase();
			var data = JSON.stringify(getSelectDataBy(null));

			//字符串类型
			if (stype == "string" || stype == "nvarchar2" || stype == "varchar" || stype == "nvarchar" || stype.indexOf("字符串") != -1) {
				data = JSON.stringify(getSelectDataBy(new Array(11, 12, 13, 14, 24, 25, 26, 27)));
			} else if (stype == "date" || stype == "datetime" || stype == "timestamp" || stype.indexOf("日期型") != -1) {
				data = JSON.stringify(getSelectDataBy(null));
			} else if (stype == "numeric" || stype == "bigint" || stype == "int" || stype == "decimal" || stype == "double" || stype == "float" || stype.indexOf("数值") != -1 || stype == "integer") {
				data = JSON.stringify(getSelectDataBy(new Array(1)));
			}
			var $parent = $(e.sender.el).parent().siblings('.filter-operate');
			var $time = mini.byClass('filter-operate-select', $parent);
			mini.get($time).setData(data);
		}

		function fieldchangeinit(stype, item) {
			var data = JSON.stringify(getSelectDataBy(null));

			//字符串类型
			if (stype == "string" || stype == "nvarchar2" || stype == "varchar" || stype == "nvarchar" || stype.indexOf("字符串") != -1) {
				data = JSON.stringify(getSelectDataBy(new Array(11, 12, 13, 14, 24, 25, 26, 27)));
			} else if (stype == "date" || stype == "datetime" || stype == "timestamp" || stype.indexOf("日期型") != -1) {
				data = JSON.stringify(getSelectDataBy(null));
			} else if (stype == "numeric" || stype == "bigint" || stype == "int" || stype == "decimal" || stype == "double" || stype == "float" || stype.indexOf("数值") != -1 || stype == "integer") {
				data = JSON.stringify(getSelectDataBy(new Array(1)));
			}

			var $parent = $(item.el).parent().siblings('.filter-operate');
			var $time = mini.byClass('filter-operate-select', $parent);
			mini.get($time).setData(data);
		}

		function onCloseClick(e) {
			var obj = e.sender;
			obj.setText("");
			obj.setValue("");
		}

		function OnUploadFinished() {
			console.log("所有文件上传结束");
		}

		function getSelectDataBy(ids) {
			var allSelect = [ {
				id : 1,
				name : '日期范围'
			}, {
				id : 2,
				name : '包含'
			}, {
				id : 3,
				name : '不包含'
			}, {
				id : 4,
				name : '起始包含'
			}, {
				id : 5,
				name : '结尾包含'
			}, {
				id : 6,
				name : '起始不包含'
			}, {
				id : 7,
				name : '结尾不包含'
			}, {
				id : 8,
				name : '空值'
			}, {
				id : 9,
				name : '非空值'
			}, {
				id : 10,
				name : '等于'
			}, {
				id : 11,
				name : '小于'
			}, {
				id : 12,
				name : '大于'
			}, {
				id : 13,
				name : '小于等于'
			}, {
				id : 14,
				name : '大于等于'
			}, {
				id : 15,
				name : '不等于'
			}, {
				id : 16,
				name : '包含(字段)'
			}, {
				id : 17,
				name : '不包含(字段)'
			}, {
				id : 18,
				name : '起始包含(字段)'
			}, {
				id : 19,
				name : '结尾包含(字段)'
			}, {
				id : 20,
				name : '起始不包含(字段)'
			}, {
				id : 21,
				name : '结尾不包含(字段)'
			}, {
				id : 22,
				name : '等于(字段)'
			}, {
				id : 26,
				name : '小于(字段)'
			}, {
				id : 27,
				name : '大于(字段)'
			}, {
				id : 25,
				name : '小于等于(字段)'
			}, {
				id : 24,
				name : '大于等于(字段)'
			}, {
				id : 23,
				name : '不等于(字段)'
			} ];

			for (var i = allSelect.length - 1; i >= 0; i--) {
				var id = allSelect[i].id;
				if (ids && contains(ids, id)) {
					allSelect.remove(allSelect[i]);
				}
			}
			return allSelect;
		}

		function contains(arr, obj) {
			var i = arr.length;
			while (i--) {
				if (arr[i] === obj) {
					return true;
				}
			}
			return false;
		}
	</script>
</body>
</html>