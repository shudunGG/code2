<!DOCTYPE html>
<html lang="zh-CN">

<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>分组</title>
<script src="../../../frame/fui/js/cssboot.js" type="text/javascript"></script>
<script type="text/javascript">
	SrcBoot.output([ './css/common.css', ]);
</script>
</head>
<body style="overflow: auto;">
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<a class="mini-button mini-btn-primary" id="addbtn" onclick="save">保存修改</a>
			<a class="mini-button mini-btn-primary" onclick="epoint.closeDialog">关闭</a>
		</div>
		<!--帮助按钮 -->
		<a role="helper"></a>
	</div>

	<!-- 页面内容区域 -->
	<div id="form" class="fui-form" style="padding-top: 1px">
		<div role="form">
			<div role="row">
				<div role="control" label="步骤名称" starred="true">
					<input id="stepName" name="stepName" class="mini-textbox"
						required="true" emptyText="请输入步骤名称" vtype="maxLength:20" requiredErrorText="步骤名称不能为空"/>
				</div>
			</div>
			<div role="row">
					<div role="control" label="查询（分组）字段" starred="true">
						<input id="filterColumn" name="filterColumn" class="mini-combobox" 
						allowInput="true" showClose="true" action="getPreFields" multiSelect="true"
						 style="width: 100%" textField="text" required="true" requiredErrorText="查询（分组）字段不能为空"
							valueField="id" oncloseclick="onCloseClick"/>
					</div>
				</div>
			<input id="keyTable" name="keyTable" 
				class="mini-hidden"> <input id="dataTable" name="dataTable" 
				class="mini-hidden"> 
		</div>
	</div>
	<div class="fui-toolbar" id="btns" style="padding-top: 1px">
		<div class="btn-group mr10">
			<a class="mini-button mini-btn-primary"
				onclick="addkeyfield"
				style="margin-left: 20px">添加聚合函数</a><a id="deletekeyfield"
				class="mini-button mini-btn-danger"
				onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要删除的记录!', '', null, 'warning');} else {epoint.confirm('确认删除?','',deleteSelected);}">删除</a>
			</div>
	</div>
	<!-- 内容区域 -->
	<div class="mini-fit" style="padding-top: 1px">
					<div id="datagrid" name="datagrid" class="mini-datagrid"
						idField="id" multiSelect="true"
						 style="width: 100%; height: 100%"
						allowResize="true" showPager="false"
						 action="getDataGridData">
						<div property="columns">
							<div type="checkcolumn" width="45"></div>
							<div type="indexcolumn" width="55" headerAlign="center">序</div>
							<div field="function" headerAlign="center" align="center"
								width="80" maxLength="8" type="comboboxcolumn" required="true">
								聚合函数<input property="editor" class="mini-combobox"
									emptyText="请选择函数..."  required="true"
									data="[{'text':'分组连接','id':'group_concat'},{'text':'求平均值','id':'avg'},{'text':'求和','id':'sum'},{'text':'求最大值','id':'max'},{'text':'求最小值','id':'min'},{'text':'统计数量','id':'count'}]"
									 textField="text"
									valueField="id"  
									style="width: 100%" requiredErrorText="聚合函数不能为空"/>
							</div>
							<div field="keyfield" headerAlign="center" align="center"
								width="100" maxLength="8"  type="comboboxcolumn">
								参数字段<input property="editor" class="mini-combobox" showClose="true"
									emptyText="请选择字段..." data="sourceFieldList" textField="text" 
									valueField="id"  style="width: 100%"  oncloseclick="onCloseClick" onvaluechanged="chgfield"/>
							</div>
							<div field="fieldtype" name="fieldtype" headerAlign="center" align="center"
								width="80" >
								字段类型<input property="editor" class="mini-textbox fieldtype-operate-select"
									  allowInput="false"/>
							</div>
							<!--<div field="diykey" headerAlign="center" align="center"
								width="120" maxLength="8"  >
								自定义参数<input property="editor" class="mini-textbox"
									emptyText="不选择字段时可以自定义参数" style="width: 100%" />
							</div>-->
							<div field="separator" headerAlign="center" align="center"
								width="60" maxLength="8" >
								连接符<input property="editor" class="mini-textbox"
									emptyText="分组连接函数的连接符"  style="width: 100%" />
							</div>
							<div field="othername" headerAlign="center" align="center"
								width="90" maxLength="8" >
								别名<input property="editor" class="mini-textbox"
									emptyText="请输入名称..." inputStyle="text-align:center"
									style="width: 50%" onvalidation="englishjy" required="true" requiredErrorText="别名不能为空"/>
							</div>
							<div width="90" headerAlign="center" align="center" field="chinesename" >
					字段中文名称<input property="editor" class="mini-textbox"
						style="width: 100%;" inputStyle="text-align:left" required="true" requiredErrorText="中文名称不能为空"/>
				</div>
						</div>
					</div>
					<!-- <div id="datagrid1" name="datagrid1" class="mini-datagrid"
						idField="id" multiSelect="true" allowCellValid="true"
						allowCellEdit="true"
						style="width: 100%; height: 100%; margin-left: 10px;"
						allowResize="true" showPager="false" allowCellSelect="true"
						editNextOnEnterKey="true" action="getDataGridData1">
						<div property="columns">
							<div type="checkcolumn" width="45"></div>
							<div type="indexcolumn" width="55" headerAlign="center">序</div>
							<div field="datafield" headerAlign="center" align="center"
								width="200" maxLength="8" type="comboboxcolumn">
								字段<input property="editor" class="mini-combobox"
									emptyText="请选择字段..." data="sourceFieldList" textField="text" required="true"
									valueField="id"  style="width: 100%" />
							</div>
						</div>
					</div> -->
	</div>

	<script src="../../../frame/fui/js/jsboot.js" type="text/javascript"></script>
	<script src="js/fieldcheck.js"></script>
	<script type="text/javascript">
		//获取表单数据
		var form = new mini.Form("#form");
		var stepNameForm = mini.get('stepName');
		var nodeData;
		var nodeInfo;
		var sourceFieldList;
		var grid = mini.get("datagrid");

		//解决下拉框不展示的问题

		function getForm() {
			var data = form.getData(true, false);
			var s = mini.encode(data);
			return s;
		}
		//选择参数字段
		function chgfield(e) {
			var type = e.selected.type;
			var $parent = $(e.sender.el).parent().parent();
			var $time = mini.byClass('fieldtype-operate-select',
								$parent);
			mini.get($time).setValue(type);
		}

		
		function pageLoad() {
			//从父页面获取表单数据
			var data = top.nodeData;
				nodeInfo = data;
				nodeData = mini.decode(data.id);
			epoint.initPage('modelgroupbyaction?stepId=' + nodeInfo.key,
				{'nodeData':epoint.encodeUtf(JSON.stringify(nodeData))},
				initCallBack);
		}

		function initCallBack(e) {
			//填充表单数据
			form.setData(nodeData);
			var nodeName = nodeData.stepname;
			if (e.sourceFieldList) {
				sourceFieldList = e.sourceFieldList;
			}
			if (!nodeName) {
				stepNameForm.setValue(nodeInfo.name);
			}
			loadParam();
		}
		
		//新增关键字段
		function addkeyfield() {
			var newRow = {};
			grid.addRow(newRow, 'last');
			grid.beginEditRow(newRow);
		}

		//加载参数列表
		function loadParam() {
			if (grid.data) {
				for (var i = 0; i < grid.data.length; i++) {
					grid.beginEditRow(grid.getRow(i));
				}
			}
		}


		//删除选中
		function deleteSelected() {
			grid.removeRows(grid.getSelecteds(), true);
		}
		function setGridData(){
			var rows = grid.findRows();
			$.each(rows, function(i, o) {
				grid.commitEditRow(o);
			});
			var dataStr = JSON.stringify(grid.getData());
			mini.get('keyTable').setValue(dataStr);
		}
		
		//保存修改,不需要入库，只需要将配置内容传给父页面
		function save() {
			grid.validate();
			if (grid.isValid() == false) {
				var error = grid.getCellErrors()[0];
				grid.beginEditCell(error.record, error.column);
				epoint.alert(error.errorText);
				return;
			}
			if (epoint.validate()) {
				// 把表格的数据拿出来放到隐藏域中
				setGridData();
				var griddata=grid.getData();

				for(var i=0;i<griddata.length;i++){
					var keyfield=griddata[i].keyfield;
					var fun=griddata[i].function;
					var type=griddata[i].fieldtype.toLowerCase();
					if (fun == 'sum' || fun == 'avg'
								|| fun == 'max' || fun == 'min') {
							if (type.indexOf("varchar") != -1
									|| type.indexOf("string") != -1|| type.indexOf("text") != -1|| type.indexOf("bit") != -1) {
								epoint.alert("字符串类型的字段不能进行数值分析类统计,请先转换成数值类型字段!");
								loadParam();
								return;
							}
						}
				}
				var nodeForm = getForm();
				epoint.execute('save', '@none', [ nodeInfo, nodeForm ],
						function(data) {
							if (data.success == 'success') {
								epoint.closeDialog(nodeForm);
							} else {
								epoint.alert(data.msg, '', null, 'warning');
								loadParam();
							}
						});
			}
		}
		
		function onCloseClick(e){
			e.sender.setText('');
			e.sender.setValue('');
		}
		
		function englishjy(e) {
			var retainedFields = ['like','as'];
			if(retainedFields.indexOf(e.value) != -1){
				e.errorText = "字段名称不能为数据库保留字："+retainedFields;
				e.isValid = false;
				return;
			}
			var reg =  new RegExp("^[a-zA-Z][a-zA-Z0-9_]*$");
			var v = reg.test(e.value);
			if (!v) {
				e.errorText = "必须以字母开头，英文、数字、下划线作为字段组合名称!";
				e.isValid = false;
			}
		}
	</script>
</body>

</html>