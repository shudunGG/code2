<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>交换流程</title>
<script src="../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>

	<div class="fui-left">
		<div role="head" title="选择分组">
		</div>
		<div role="body">
			<ul id="tree" class="mini-filtertree" textField="text" idField="id"
				parentField="pid" action="dxpflowgroupaction.getTreeModel"
				resultAsTree="false" filterMode="server">
			</ul>
		</div>
	</div>

	<div class="fui-right">
		<!-- 按钮区域 -->
		<!--<div class="fui-toolbar">
			<div class="btn-group mr10">
				<a class="mini-button mini-btn-danger" id="del"
					iconCls="icon-minuscircle" onclick="deleteFlow()">删除模型</a>
			</div>
		</div>-->

		<!-- 条件区域 -->
		<div class="fui-search" primaryControl="flowName" opened="false">
			<!-- 表单布局 -->
			<div class="fui-form" id="fui-form">
				<div role="form">
					<div role="row">
						<div role="control" label="流程名称">
							<input bind="dataBean.flowName" id="flowName"
								class="mini-textbox" />
						</div>
						<div role="control" label="所属节点域">
							<input bind="nodeguid" id="nodeguid" class="mini-combobox"
								allowInput="true" action="getNodeGuidList" />
						</div>
					</div>
					<div role="row">
						<div role="control" label="发布状态">
							<input bind="publishStatus" class="mini-combobox"
								data="[{text:'未发布',id:'0'},{text:'已发布',id:'1'}]"
								textField="text" valueField="id" />
						</div>
						<div role="control"></div>
					</div>
					<div role="row">
						<div role="control" label="生成时间(开始)">
							<input bind="generateBegin" id="beginDate"
								class="mini-datepicker" onvaluechanged="onValueChanged" />
						</div>
						<div role="control" label="生成时间(结束)">
							<input bind="generateEnd" id="endDate" class="mini-datepicker"
								onvaluechanged="onValueChanged" />
						</div>
					</div>
					<input bind="groupGuid" id="groupGuid" class="mini-hidden" />
				</div>
			</div>

			<!-- 搜索按钮 -->
			<a role="searcher" callback="searchData"></a>
		</div>

		<!-- 表格区域 -->
		<div class="fui-content">
			<form id="download_form" method="post" enctype="multipart/form-data"></form>
			<div id="datagrid" name="datagrid" class="mini-datagrid"
				idField="rowguid" multiSelect="true"
				onshowrowdetail="onShowRowDetail" style="width: 100%; height: 100%;"
				showPager="true" action="getDeleteDataGridData">
				<div property="columns">
					<div type="expandcolumn" width="30"></div>
					<div type="checkcolumn" width="30"></div>
					<div type="indexcolumn" width="50" headerAlign="center">序</div>
					<div field="flowname" width="200" headerAlign="center"
						align="center" renderer="onTitleRenderer">流程名称</div>
					<div field="nodename" width="100" headerAlign="center"
						align="center">所属节点域</div>
					<div field="publishstatusname" width="100" headerAlign="center"
						align="center">模型状态</div>
					<div field="flowtype" visible="false">流程类型</div>
					<div field="isdagchild" visible="false">dag节点</div>
					<div field="generatedate" width="160" headerAlign="center"
						data-options="{'format':'yyyy-MM-dd HH:mm:ss'}"
						dateFormat="yyyy-MM-dd HH:mm:ss" align="center">生成日期</div>
					<div field="operatedate" width="160" headerAlign="center"
						data-options="{'format':'yyyy-MM-dd HH:mm:ss'}"
						dateFormat="yyyy-MM-dd HH:mm:ss" align="center">更新日期</div>
					<!-- <div field="jobstatus" width="80" headerAlign="center" align="center"
						renderer="onStatusRender">状态</div> -->
					<div field="nodeguid" headerAlign="center" align="center"
						visible="false">节点guid</div>
					<div width="80" headerAlign="center" align="center"
						renderer="onTransRenderer">模型开发</div>
				</div>
			</div>
			<div id="detailGrid_JobForm" style="display: none;"
				style="width:100%;height:150px;">
				<div id="flowinfogrid" class="mini-datagrid"
					action="getFlowInfoGridData" idField="rowguid" showPager="false"
					allowRowSelect="false">
					<div property="columns">
						<div type="indexcolumn" field="index" headerAlign="center"
							align="center" width="15">序</div>
						<div field="flowName" width="300" headerAlign="center"
							align="center">名称</div>
						<div field="jobStatus" width="150" headerAlign="center"
							align="center" renderer="onStatusRender">状态</div>
						<div field="outputtype" visible="false"></div>
						<div field="log" width="80" headerAlign="center" align="center"
							renderer="onLogRenderer">运行日志</div>
						<div field="export" width="80" headerAlign="center" align="center"
							renderer="onExportRenderer">导出流程</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="../../../rest/resource/jsboot"></script>
	<script>
		epoint.initPage('dxpmodeldatadeveloplistaction');

		var tree = mini.get('tree');
		tree.on('beforenodeselect', function(e) {
			console.log(e);
			if (e.node.id == 'f9root') {
				mini.get('groupGuid').setValue('');
			} else {
				mini.get('groupGuid').setValue(e.node.id);
			}
			searchData();
		});

		var grid = mini.get('datagrid');
		grid.on('selectionchanged', function(e) {
			if (e.selecteds.length > 0) {
				buttonEnable();
			} else {
				buttonDisable();
			}
		});


		function onExportRenderer(e) {
			if (e.row.publishstatusname == '未发布') {
				return '';
			}
			return epoint.renderCell(e, "action-icon modicon-86", "exportKTR");
		}
		function exportKTR(e) {
			var form = document.getElementById('download_form');
			form.action = "dxpmodeldatadeveloplistaction.action?cmd=exportKTR&flowGuid="
					+ e;
			form.submit();
		}

		function onResultRenderer(e) {
			if (e.row.publishstatusname == '未发布') {
				return '';
			}
			return epoint.renderCell(e, "action-icon icon-search",
					"openResultDetail", "rowguid,outputtype");
		}

		function openResultDetail(e) {
			epoint.execute('checkTableIsExist','',e.rowguid,function(data){
				if(data.msg){
					epoint.alert(data.msg);
					return;
				}
				if (e.outputtype == '2') {
				epoint.openDialog('查看结果',
						'dxp/datamodel/modelflow/modelresultviewchart?flowGuid='
								+ e.rowguid);
				} else {
					epoint.openDialog('查看结果',
						'dxp/datamodel/modelflow/modelresultviewdata?flowGuid='
								+ e.rowguid);
				}

			});

		}

		function moveFlow() {
			let array = grid.getSelecteds();
			let guidArray = [];
			for (var i = 0; i < array.length; i++) {
				guidArray.push(array[i].rowguid);
			}
			let guid = guidArray.join(",");
			epoint.openDialog("移动集成", "dxp/flowinfo/flowgroupselect?guid="
					+ guidArray, searchData(), {
				'width' : 700,
				'height' : 420
			})
		}

		function onStatusRender(e) {
			var color = 'red';
			if (e.value == '交换中') {
				color = '#f39c12';
			} else if (e.value == '已停止') {
				color = '#d2d6de';
			} else if (e.value.indexOf('运行中') != -1) {
				color = '#00a65a';
			} else {
				color = '#dd4b39';
			}
			return '<span class="label" style="background-color:' + color + ';border-radius:.25em;color:white;padding: .2em .6em .3em;">'
					+ e.value + '</span>';
		}

		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ], null, true);
		}

		var onLogRenderer = function(e) {
			return epoint.renderCell(e, "action-icon modicon-49",
					"openLogList", "rowguid,flowName");
		};

		var onScheduleRenderer = function(e) {
			if (e.record.isdagchild) {
				return "";
			}
			return epoint.renderCell(e, "action-icon modicon-97",
					"openScheduleList");
		};


		var onChangeStatusRenderer = function(e) {
			return epoint.renderCell(e, "action-icon modicon-49", "start",
					"rowguid");
		}

		function openLogList(e) {
			console.log(e);
			epoint.openDialog(e.flowName,
					'dxp/flowinfo/dxpschedulerloglist?guid=' + e.rowguid, null,
					{
						'width' : 1000,
						'height' : 600
					});
		}

		function onTitleRenderer(e) {
			return '<a href="javascript:void(0);" onclick="editFlow(' + "'"
					+ e.row.rowguid + "'" + ')" >' + e.value + '</a>';
		}


		function openDataDev() {
			var groupid = mini.get('groupGuid').getValue();
			epoint.openDialog('新建流程', './adddevflowinfo?groupid=' + groupid,
					function(data) {
						epoint.execute('checkFile', '', data);
						mini.get('datagrid').reload();
					}, {
						'width' : 1000,
						'height' : 550
					});
		}



		function onTransRenderer(e) {
			return epoint.renderCell(e, "action-icon icon-fix", "addTrans",
					"rowguid,nodeguid,flowtype");
		}

		function addTrans(e) {
			window.open("../../../dxp/datamodel/modelflow/model?flowGuid="
					+ e.rowguid + "&nodeGuid=" + e.nodeguid + "&flowtype="
					+ e.flowtype);
		}

		function onValueChanged(e) {
			var sender = e.sender;
			if (sender.id == 'beginDate') {
				var todate = mini.get('endDate').getValue();
				if (todate) {
					if (sender.value.getTime() > todate.getTime()) {
						epoint.alert('开始时间不能大于结束时间！', '', function() {
							epoint.clear(sender.id);
						});
					}
				}
			} else if (sender.id == 'endDate') {
				var bedate = mini.get('beginDate').getValue();
				if (bedate) {
					if (sender.value.getTime() < bedate.getTime()) {
						epoint.alert('结束时间不能小于开始时间！', '', function() {
							epoint.clear(sender.id);
						});
					}
				}
			}
		}



		var employee_grid = mini.get("flowinfogrid");
		var detailGrid_Form = document.getElementById("detailGrid_JobForm");

		function onShowRowDetail(e) {

			var grid = e.sender;
			var row = e.record;
			var td = grid.getRowDetailCellEl(row);
			td.appendChild(detailGrid_Form);
			detailGrid_Form.style.display = "block";
			employee_grid.load({
				modelGuid : row.rowguid
			});
		}

	</script>
</body>
</html>