// jshint -W030
//EMsg聊天窗口定义
function EMsgDialog(y){var p=this,k,g,n={},t="close",q=$("#msgEMsg");$(".emsg-recent-list",q);var m=$("#emsgDialog"),d=$(".emsg-session-list",m),w=$(".emsg-dialog-head",m),r=$(".emsg-message-panel",m),l=$(".emsg-message-text",m),z=$(".emsg-top-bar",m),A=$(".emsg-btn-send",m);if(this.useEnterSend=!0===EmsgConfig.enterSend)A[0].title="\u6309ENTER\u952e\u53d1\u9001";var u=$(".emsg-session-info",w),C=$(".emsg-user-img img",w),c=$(".emsg-curr-name",u),S=$(".emsg-group-date",u),D=$(".emsg-group-rename",u),T=$("\x3ci class\x3d'emsg-not-read'\x3e\x3c/i\x3e"),E,v=Mustache,aa=$.trim($("#emsg-sessionitem-templ").html()),L=$.trim($("#emsg-messagelist-templ").html()),F=$.trim($("#emsg-fileupload-templ").html());$.trim($("#emsg-recent-templ").html());this.status=function(){return t};var ba=function(){M().done(function(a){k=a;k.imgUrl=k.imgUrl||EmsgConfig.userImg})},M=function(a){var b={query:"getuserinfo",uid:a};a&&(b.uid=a);b={url:EmsgConfig.baseUrl,data:b};a||(b.async=!1);return Util.ajax(b)},N=function(a){return Util.ajax({url:EmsgConfig.baseUrl,data:{query:"getgroupinfo",uid:a}})},ca=function(){function a(){$(".nicescroll",m).niceScroll({cursorcolor:"rgba(0,0,0,.2)",horizrailenabled:!1});r.niceScroll({cursorcolor:"rgba(0,0,0,.2)",horizrailenabled:!1})}$.nicescroll?a():Util.loadJs("/frame/fui/js/widgets/jquery.nicescroll.min.js",function(){a()})},da=function(){Util.loadJs("/frame/fui/js/widgets/jquery.emotion.js",function(){$(".emsg-emotion-icon").emotion({target:".emsg-message-text",path:"/"+Util.getRootPath().split("//")[1].split("/")[1]+"/frame/fui/js/widgets/emsg/images/emotion/"})})},U=parseInt(EmsgConfig.attachSizeLimit)||5,V=function(){var a="gif jpg jpeg bmp png rar zip doc xls ppt docx xlsx pptx txt pdf".split(" "),b,e=WebUploader.create({dnd:"#EmsgText",auto:!0,swf:Util.getRightUrl("/frame/fui/js/widgets/webuploader/Uploader.swf"),server:Util.getRightUrl(EmsgConfig.baseUrl),pick:{id:"#fileUploader",multiple:!1},duplicate:!0,accept:{extensions:a.join(",")}});e.on("beforeFileQueued",function(f){if(!eMsgSocket.isConnect())return mini.showTips({content:"E\u8baf\u5df2\u65ad\u5f00\u8fde\u63a5\uff0c\u65e0\u6cd5\u53d1\u9001\u6d88\u606f\uff01",state:"danger",x:"center",y:"center",timeout:2E3}),!1;var h=f.name.substr(f.name.lastIndexOf(".")+1).toLowerCase();f=f.size;if(-1==$.inArray(h,a))return mini.alert("\u9009\u62e9\u7684\u683c\u5f0f\u4e0d\u6b63\u786e\uff01"),!1;if(0==f)return mini.alert("\u4e0d\u80fd\u53d1\u9001\u7a7a\u6587\u4ef6\uff01"),!1;if(f>1048576*U)return mini.alert("\u6587\u4ef6\u5927\u5c0f\u9700\u5c0f\u4e8e"+U+"M\uff01"),!1});e.on("uploadStart",function(a){a=v.render(F,{name:a.name,size:G(a.size)});b=H(g.sessionId,{content:a,time:mini.formatDate(new Date,"yyyy-MM-dd HH:mm:ss"),IsSend:!0,imgUrl:k.imgUrl});e.options.formData={query:"uploadfile",sessionid:g.sessionId};$(".emsg-uploader-status",b).removeClass("down");$(".emsg-uploader-process",b).css("visibility","visible")});e.on("uploadProgress",function(a,h){$(".emsg-process-inner",b).css("width",100*h+"%")});e.on("uploadSuccess",function(a,h){h=h.custom;!1===h.success?(mini.alert("\u4e0a\u4f20\u5931\u8d25"+(h.msg?"\uff1a"+h.msg:"")),b.remove()):($(".emsg-uploader-status",b).addClass("success"),$(".emsg-file-uploader",b).wrap($("\x3ca/\x3e",{"class":"emsg-file-down",href:Util.getRightUrl(h.href),target:"_blank"})))});e.on("uploadError",function(a){$(".emsg-uploader-status",b).addClass("fail");$(".emsg-file-reupload",b).show().on("click",function(){b.remove();e.retry()})});e.on("uploadComplete",function(a){$(".emsg-uploader-process",b).css("visibility","hidden")});e.on("uploadBeforeSend",function(a,h,b){if(a=$.cookie("_CSRFCOOKIE"))b.CSRFCOOKIE=a})},G=function(a){return 1048576<a?(a/1048576).toFixed(2)+"MB":(a/1024).toFixed(2)+"KB"},fa=function(){m.draggable({handle:w,containment:"body",cursor:"move"});var a=$(".emsg-dialog-min",m),b=$(".emsg-dialog-close",m),e=$(".emsg-history-link",m);a.on("click",function(){$(this).hasClass("max")?p.show("max"):p.show("min")});b.on("click",function(){1==W()?I(g.sessionId):mini.showMessageBox({title:"\u7cfb\u7edf\u63d0\u793a",message:"\u5173\u95ed\u6b64\u7a97\u53e3\u6240\u6709\u4f1a\u8bdd\u8fd8\u662f\u4ec5\u5173\u95ed\u5f53\u524d\u4f1a\u8bdd\uff1f",buttons:["\u5173\u95ed\u6240\u6709","\u5173\u95ed\u5f53\u524d"],iconCls:"mini-messagebox-question",callback:function(a){"\u5173\u95ed\u6240\u6709"==a?X():"\u5173\u95ed\u5f53\u524d"==a&&I(g.sessionId)}})});d.on("click",".emsg-session-item",function(a){J($(this).data("sessionid"))}).on("click",".emsg-remove",function(a){a.stopPropagation();a=$(this).closest("li").data("sessionid");I(a)});r.on("click",".emsg-load-link",function(){var a=$(this).closest(".emsg-message-tab");$(this).find(".emsg-load-icon").hasClass("nomore")||ea(a)});l.on("keydown",function(a){var h=a.ctrlKey,b=a.shiftKey;if(13===a.which)if(p.useEnterSend){if(!h&&!b)return O(),!1;h&&(a=$("\x3cdiv\x3e\x3cbr\x3e\x3c/div\x3e"),window.getSelection?(h=window.getSelection(),b=h.getRangeAt(0),b.insertNode(a[0]),b.collapse(!1),h.removeAllRanges(),h.addRange(b),h.collapseToEnd()):document.selection&&document.selection.createRange?(h=document.selection,b=h.createRange(),b.pasteHTML(a[0].outerHTML),b.collapse(!1),b.select()):(a.appendTo(l),l.focus()))}else if(h)return O(),!1});c.on("mousedown",function(){if(0!=$(this).closest(".emsg-group-info").length&&"min"!=t){var a=$(this).width(),b=$(this).hide().html();D.data("origname",b).val(b).width(a).show().focus();return!1}});D.on("keydown",function(a){13==a.keyCode&&D.trigger("blur")}).on("blur",function(){var a=$(this),b=a.hide().val();c.show();if(""==$.trim(b))return epoint.showTips("\u8ba8\u8bba\u7ec4\u540d\u79f0\u4e0d\u80fd\u4e3a\u7a7a",{state:"error"});b!=a.data("origname")&&Util.ajax({url:EmsgConfig.baseUrl,data:{query:"renamegroup",groupid:g.uid,name:b},success:function(h){if(h.success){c.html(b);a.data("origname",h.name);n[g.sessionId].name=h.name;var f=x(h.groupid);$(".emsg-user-name",f).html(h.name)}else mini.showTips({content:"\u4fee\u6539\u7ec4\u540d\u5931\u8d25",state:"danger",x:"center",y:"center",timeout:2E3})},error:function(){mini.showTips({content:"\u4fee\u6539\u7ec4\u540d\u5931\u8d25",state:"danger",x:"center",y:"center",timeout:2E3})}})});if(EmsgConfig.sendEmailUrl){w.find(".emsg-write-email").removeClass("hidden");var f=EmsgConfig.sendEmailUrl+(-1!=EmsgConfig.sendEmailUrl.indexOf("?")?"\x26":"?");z.on("click",".emsg-write-email",function(){"group"==g.type?N(g.uid).done(function(a){a=$.map(a.members,function(a,h){return a.uid}).join(";");epoint.openDialog("\u53d1\u9001\u90ae\u4ef6",f+"ToUserGuidList\x3d"+a,"",{showCloseButton:!0,showMaxButton:!0,allowResize:!0})}):epoint.openDialog("\u53d1\u9001\u90ae\u4ef6",f+"ToUserGuid\x3d"+g.uid,"",{showCloseButton:!0,showMaxButton:!0,allowResize:!0})})}z.on("click",".emsg-quit-group",function(){var a=g.uid,b=g.sessionId;mini.showMessageBox({title:"\u7cfb\u7edf\u63d0\u793a",message:"\u786e\u5b9a\u9000\u51fa\u8ba8\u8bba\u7ec4\uff1f",buttons:["\u786e\u5b9a","\u53d6\u6d88"],iconCls:"mini-messagebox-question",callback:function(h){"\u786e\u5b9a"==h&&Util.ajax({url:EmsgConfig.baseUrl,data:{query:"quitgroup",groupid:a},success:function(a){1==a.success?(I(b),RefreshEMsg&&RefreshEmsg()):mini.alert("\u9000\u51fa\u5931\u8d25\uff01")}})}})}).on("click",".emsg-create-group",function(){E||(E=new EMsgGroupDialog(y));"friend"==g.type?E.createGroup([{uid:k.uid,name:k.name},{uid:g.uid,name:g.name}]):E.editGroup(g.uid)});A.on("click",function(){O()});e.on("click",function(){var a=EmsgConfig.historyUrl+"?exunsessionid\x3d"+g.sessionId,a=Util.getRightUrl(a);if(EmsgConfig.onHistoryBtnClick)EmsgConfig.onHistoryBtnClick(a,g);else TabsNav.addTab({id:g.sessionId,name:"\u548c"+g.name+"\u804a\u5929\u8bb0\u5f55",url:a});p.show("min")})},x=function(a){return d.find("li[data-sessionid\x3d'"+a+"']")},B=function(a){return r.find("div[data-sessionid\x3d'"+a+"']")},J=function(a,b){var e=x(a);e.siblings().removeClass("active").end().addClass("active");var f=n[a];g=f;"group"==f.type?(S.html("\u521b\u5efa\u65e5\u671f\uff1a"+f.createDate).show(),u.addClass("emsg-group-info")):(u.removeClass("emsg-group-info"),S.hide());C.attr("src",f.imgUrl).on("error",function(){this.src=EmsgConfig.userImg;C.off("error")});c.html(f.name).show();D.hide();var h=$(".emsg-not-read",e);h.length&&h.remove();h=$.trim(l.html());l.empty();var d=l.data("sessionId");x(d).data("saveMsg",h);!0===b?(Y({sessionId:a,pageIndex:1}).done(function(b){K(a);var h,e,c=-1;if("friend"==f.type){e=b.messagelist;for(var d=0,g=e.length;d<g;d++)if(!e[d].readtime){c=d;break}-1==c&&(c=e.length);h=e.slice(0,c);e=e.slice(c)}else{h={member:b.member};e={member:b.member};d=0;for(g=b.messagelist.length;d<g;d++)if(!b.messagelist[d].readtime){c=d;break}-1==c&&(c=b.messagelist.length);h.messagelist=b.messagelist.slice(0,c);e.messagelist=b.messagelist.slice(c)}P(e,f);c=B(a);0<b.messagelist.length&&$(".emsg-message-list",c).prepend("\x3cli class\x3d'emsg-message-tip'\x3e\x3ci class\x3d'emsg-tip-icon'\x3e\x3c/i\x3e\u4ee5\u4e0a\u662f\u5386\u53f2\u6d88\u606f\x3c/li\x3e");P(h,f,c);c.siblings().hide().end().show().data("page",1);r.scrollTop(c.prop("scrollHeight"));l.empty()}),$.isArray(a)):(h=B(a).siblings().hide().end().show(),r.scrollTop(h.prop("scrollHeight")),K(a),e=e.data("saveMsg"),0<$.trim(e).length&&l.html($.trim(e)));l.data("sessionId",a);Q(l[0])},I=function(a){var b=x(a),e=B(a);if(b.hasClass("active")){var f;f=b.next();0===f.length&&(f=b.prev());0<f.length&&(f=f.data("sessionid"),J(f,!1))}$(".emsg-not-read",b).length&&K(a);b.remove();e.remove();$.isArray(a);delete n[a];0===W()&&X()},ga=function(a){a!=g.sessionId?(a=x(a),0===$(".emsg-not-read",a).length&&a.append(T.clone())):"min"==t&&0===$(".emsg-not-read",u).length&&c.next().after(T.clone())},K=function(a){Util.ajax({url:EmsgConfig.baseUrl,data:{query:"ignoremessage",sessionid:a},success:function(a){}})},ha=function(a,b){R(a)&&N(b).done(function(b){$.extend(b,{type:"group",sessionId:a,imgUrl:EmsgConfig.groupImg});n[a]=b;var f=x(a);$(".emsg-user-name",f).html(b.name);g.sessionId==a&&c.html(b.name)})},R=function(a){return"undefined"==typeof n[a]?!1:!0},W=function(){var a=0,b;for(b in n)a++;return a},X=function(){d.empty();$.each(r.children(),function(a,b){$(b).getNiceScroll().remove()});r.empty();var a=[],b;for(b in n)a.push(b);$.isArray(a);n={};m.hide();l.removeData("uid").empty();t="close"},Y=function(a,b){return Util.ajax({url:EmsgConfig.baseUrl,beforeSend:b,data:{query:"loadhistorymessage",sessionid:a.sessionId,pageindex:a.pageIndex}})},ea=function(a){var b=a.data("page")+1,e=$(".emsg-load-link",a),f=$(".emsg-load-icon",e),h=$(".emsg-load-text",e);a.data("page",b);var e=a.data("sessionid"),c=n[e];Y({sessionId:e,pageIndex:b},function(a){$.ajaxSettings.beforeSend&&$.ajaxSettings.beforeSend(a);f.addClass("loading");h.html("\u52a0\u8f7d\u7b49\u5f85")}).done(function(b){f.removeClass("loading");0<b.messagelist.length?("friend"==c.type&&(b=b.messagelist),P(b,c,a),h.html("\u67e5\u770b\u66f4\u591a\u4fe1\u606f")):(f.addClass("nomore"),h.html("\u65e0\u66f4\u591a\u4fe1\u606f"))})},P=function(a,b,e){if("friend"==b.type)a=$.map(a,function(a,f){a.uid==k.uid?(a.IsSend=!0,a.imgUrl=k.imgUrl):(a.IsReceive=!0,a.imgUrl=b.imgUrl);a.content&&(a.content=a.content.replace(/\n/g,"\x3cbr\x3e"));if("file"===a.type){var h=v.render(F,{name:a.content,size:G(a.size)});a.IsFile=!0;a.href=Util.getRightUrl(a.href);a.content=h}return a});else{var f=[];$.each(a.member,function(a,b){f[b.uid]=b});a=$.map(a.messagelist,function(a,b){a.IsGroup=!0;a.uid==k.uid?(a.IsSend=!0,a.imgUrl=k.imgUrl):(a.IsReceive=!0,a.imgUrl=f[a.uid].imgUrl||EmsgConfig.userImg,a.name=f[a.uid].name);a.content&&(a.content=a.content.replace(/\n/g,"\x3cbr\x3e"));if("file"===a.type){var e=v.render(F,{name:a.content,size:G(a.size)});a.IsFile=!0;a.href=Util.getRightUrl(a.href);a.content=e}return a})}e?(a=$(Util.clearHtml(v.render(L,{hasHead:!0,sessionId:b.sessionId,items:a}))),a.prependTo($(".emsg-message-list",e))):(a=$(Util.clearHtml(v.render(L,{sessionId:b.sessionId,items:a}))),a.appendTo(r))},H=function(a,b){var e;b.content&&(b.content=b.content.replace(/\n/g,"\x3cbr\x3e"));e=v.render(L,{hasHead:!0,items:[b]});var f=B(a);e=$(e);e.appendTo($(".emsg-message-list",f));r.getNiceScroll().resize();r.scrollTop(f.prop("scrollHeight"));K(a);return e},ia=function(a,b,e){a=B(a);var f="",c="";"renamegroup"==b?(f=e.member,c="\u5c06\u8ba8\u8bba\u7ec4\u66f4\u540d\u4e3a\x3cspan class\x3d'emsg-tip-important'\x3e"+e.name+"\x3c/span\x3e"):"quitgroup"==b?(f=e.member,c="\u9000\u51fa\u8ba8\u8bba\u7ec4"):"joingroup"==b?(f=e.members.join("\u3001"),c="\u52a0\u5165\u8ba8\u8bba\u7ec4"):"receivedfile"==b&&(c="\u5bf9\u65b9\u5df2\u6210\u529f\u63a5\u6536\u4e86\u60a8\u53d1\u9001\u7684\u6587\u4ef6\u201c"+e.name+"\u201d");$(".emsg-message-list",a).append("\x3cli class\x3d'emsg-message-tip'\x3e\x3ci class\x3d'emsg-tip-icon'\x3e\x3c/i\x3e\x3cspan class\x3d'emsg-tip-important'\x3e"+f+"\x3c/span\x3e"+c+"\x3c/li\x3e");r.getNiceScroll().resize();r.scrollTop(a.prop("scrollHeight"))};document.addEventListener("paste",function(a){if(a.clipboardData||a.originalEvent){var b=a.clipboardData||a.originalEvent.clipboardData;if(b.items)for(var b=b.items,e=b.length,f=0;f<e;f++){var c;if(c=-1!==b[f].type.indexOf("image"))c=(isFirefox=0<navigator.userAgent.indexOf("Firefox"))?!0:void 0,c=!c&&!(window.ActiveXObject||"ActiveXObject"in window);c&&(mini.showTips({content:"\u60a8\u5f53\u524d\u6d4f\u89c8\u5668\u4e0d\u652f\u53d1\u9001\u622a\u56fe\uff0c\u82e5\u8981\u4f7f\u7528\uff0c\u8bf7\u7528IE",state:"danger",x:"center",y:"center",timeout:2E3}),a.preventDefault())}}});var Z=void 0===EmsgConfig.msgLengthLimit?1E3:parseInt(EmsgConfig.msgLengthLimit),O=function(){var a=l.html(),b=a.replace(/<.*?>/g,"").length;Z&&b>Z?epoint.alert("\u8f93\u5165\u7684\u5185\u5bb9\u8fc7\u957f"):(a=a.replace(/<\/(?:div|p)>/ig,"\n").replace(/<br>/g,"\n"),a=a.replace(/<(?!img)[^>]*>/g,""),l.empty(),0===$.trim(a.replace(/&nbsp;/ig,"").replace(/<br\s*\/?>/g,"")).length?(A.addClass("empty-tootip"),setTimeout(function(){A.removeClass("empty-tootip")},1E3)):(a=a.replace(/(http:\/\/|https:\/\/)((\w|=|:|\?|\.|\/|&|-)+)/g,function(a){return'\x3ca href\x3d"'+a+'" target\x3d"_blank" \x3e'+a+"\x3c/a\x3e"}),b={content:a,time:mini.formatDate(new Date,"yyyy-MM-dd HH:mm:ss"),IsSend:!0,imgUrl:k.imgUrl},eMsgSocket.sendMessage(JSON.stringify({type:"message",sessionid:g.sessionId,from_uid:k.uid,from_name:k.name,content:a}))&&H(g.sessionId,b),Q(l[0])))},Q=function(a){$.fn.emotion&&$(a).emotion("resetCursor")};this.init=function(){ba();fa();ca();da();window.WebUploader?V():Util.loadJs("/frame/fui/js/widgets/webuploader/webuploader.min.js",function(){V()})};this.openSession=function(a,b,c){R(a)?(p.show("max"),J(a,!1)):("friend"==c?M(b):N(b)).done(function(b){b.type=c;b.sessionId=a;"friend"===c&&(b.imgUrl=b.imgUrl||EmsgConfig.userImg);"group"==c&&(b.imgUrl=EmsgConfig.groupImg,$.each(b.members,function(a,b){b.imgUrl=b.imgUrl||EmsgConfig.userImg}));n[a]=b;b=v.render(aa,$.extend({},b,{sessionid:a}));d.find("li").removeClass("active");$(Util.clearHtml(b)).prependTo(d);J(a,!0);p.show("max")}).fail(function(){mini.alert("E\u8baf\u6253\u5f00\u5931\u8d25\uff01")})};this.open=function(a){a==eMsgSocket.uid?mini.alert("\u65e0\u6cd5\u548c\u81ea\u5df1\u804a\u5929\uff01"):Util.ajax({url:EmsgConfig.baseUrl,data:{query:"opensession",userid:a},success:function(b){1==b.success?p.openSession(b.sessionid,a,"friend"):mini.alert("E\u8baf\u6253\u5f00\u5931\u8d25\uff01")},error:function(a){mini.alert("E\u8baf\u6253\u5f00\u5931\u8d25\uff01")}})};this.show=function(a){var b=$(".emsg-dialog-min",m);if(a&&"max"!==a)l.blur(),D.hide(),c.html($(this).data("origname")).show(),m.data("offset",m.offset()),m.draggable("disable"),m.effect("size",{to:{width:250,height:42}},300,function(){$(this).addClass("min")}).effect("transfer",{to:".emsg-mindialog",className:"emsg-dialog-transfer"},500,function(){$(this).css({left:"",top:""}).addClass("bottom")}),t="min",b.addClass("max").attr("title","\u6700\u5927\u5316");else{if(t==a)return;m.draggable("enable");$(".emsg-not-read",u).remove();var e,f;(f=m.data("offset"))?(e=f.top,f=f.left):(e=($(window).height()-540)/2,f=($(window).width()-800)/2);0>e&&(e=0);0>f&&(f=0);m.removeClass("bottom min").removeAttr("style").css({left:f,top:e,width:800,height:540,"font-size":"inherit"});m.show();t="max";b.removeClass("max").attr("title","\u6700\u5c0f\u5316");Q(l[0]);"max"===a&&(a=B(g.sessionId),r.scrollTop(a.prop("scrollHeight")))}m.css("z-index",Util.getZIndex())};this.receiveMessage=function(a){var b=a.sessionid,e=a.type;if(R(b)){var f=n[b];ga(f.sessionId);if("message"==e||"file"==e){var h={IsReceive:!0,imgUrl:f.imgUrl,content:a.content,time:a.time};"file"==e&&(e=v.render(F,{name:a.content,size:G(a.size)}),$.extend(h,{IsFile:!0,href:Util.getRightUrl(a.href),content:e}));if("group"==f.type){h.IsGroup=!0;var d;$.each(f.members,function(b,c){if(c.uid==a.from_uid)return d=c,!1});if(null==d){M(a.from_uid).done(function(a){h.imgUrl=a.imgUrl||EmsgConfig.userImg;h.name=a.name;H(b,h)});return}h.imgUrl=d.imgUrl;h.name=d.name}H(b,h)}else-1<$.inArray(e,["renamegroup","quitgroup","joingroup","receivedfile"])&&("renamegroup"==f.type&&(f=x(b),$(".emsg-user-name",f).html(a.name),c.html(a.name)),ia(b,e,a),"receivedfile"!==e&&ha(b,a.groupid))}};this.init()}function EMsgGroupDialog(y){var p=$(".emsg-cgroup-layer"),k=$(".emsg-cgroup-dialog"),g=$(".emsg-cgroup-title",k),n=$(".emsg-cgroup-list",k);$(".emsg-cgroup-src",k);var t=$(".emsg-cgroup-filter",k),q,m=null,d=function(){k.draggable({handle:g,containment:"body",cursor:"move"});k.on("click",".emsg-cgroup-close",function(){0<$(".remove",n).length?mini.confirm("\u662f\u5426\u4fdd\u5b58\u4fee\u6539\uff1f","\u7cfb\u7edf\u63d0\u793a",function(c){"ok"==c?C():u()}):u()}).on("click",".emsg-btn-cancle",function(){u()}).on("click",".emsg-btn-ok",function(){C()});t.on("keyup",function(c){if(13==c.keyCode){var d=$(this).val();""==d?(q.clearFilter(),q.collapseAll()):(d=d.toLowerCase(),q.filter(function(c){if(-1!=(c.name?c.name.toLowerCase():"").indexOf(d))return!0}),q.expandAll())}});n.on("click",".remove",function(){$(this.parentNode).remove()});p.click(function(){k.addClass("zoom")});k.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(c){k.removeClass("zoom")})},w=function(){Util.ajax({url:EmsgConfig.treeUrl,dataType:"json",success:function(c){q.loadData(c)}})},r=function(c){var d=c.items;if(d){c=0;for(var g=d.length;c<g;c++)r(d[c])}else l(c)},l=function(c){0===n.find('li[uid\x3d"'+c.guid+'"]').length&&z(c.guid,c.name,!0)},z=function(c,d,g){c=$("\x3cli uid\x3d'"+c+"' class\x3d'emsg-cgroup-item'\x3e\x3cspan class\x3d'name'\x3e"+d+"\x3c/span\x3e\x3c/li\x3e");g&&c.append("\x3ci title\x3d'\u5220\u9664' class\x3d'remove'\x3e\u00d7\x3c/i\x3e");n.append(c)},A=function(c){$.isArray(c)?$.each(c,function(c,d){z(d.uid,d.name)}):Util.ajax({url:EmsgConfig.baseUrl,data:{query:"getgroupinfo",uid:m},success:function(c){$.each(c.members,function(c,d){z(d.uid,d.name,!(d.uid===y||d.uid===window._userGuid_))})}})},u=function(){k.hide();p.hide();q.uncheckAllNodes();q.collapseAll();n.empty();m=null},C=function(){var c=$("li",n),d=[],g="",k="";c.each(function(c,m){d.push($(this).attr("uid"));k=$(this).find("span").text();10>g.length&&10>g.length+k.length&&(g+=k+"\u3001")});g=""==g?c.eq(0).find("span").text():g.substr(0,g.length-1);if(2>=d.length)return mini.showTips({content:"\u8bf7\u9009\u62e9\u8ba8\u8bba\u7ec4\u6210\u5458\uff01",state:"danger",x:"center",y:"center",timeout:1E3}),!1;c={query:"creategroup",memberids:d.join(";")};m?(c.groupid=m,c.query="editgroup"):c.groupname=g;Util.ajax({url:EmsgConfig.baseUrl,data:c,success:function(c){1==c.success&&c.sessionid&&eMsg.openSession(c.sessionid,c.groupid,"group");u()},error:function(){u();mini.alert("\u8ba8\u8bba\u7ec4\u7f16\u8f91\u5931\u8d25\uff01")}})};this.createGroup=function(c){var d="\u521b\u5efa\u8ba8\u8bba\u7ec4";m&&(d="\u7f16\u8f91\u8ba8\u8bba\u7ec4");g.html(d);t.val("");var d=($(window).height()-400)/2,l=($(window).width()-500)/2;k.css({left:l,top:d,"z-index":Util.getZIndex()}).show();p.show();w();A(c)};this.editGroup=function(c){m=c;this.createGroup()};(function(){q=new mini.Tree;q.set({idField:"guid",textField:"name",nodesField:"items",autoLoad:!0,resultAsTree:!0});q.on("drawnode",function(c){!0!==!c.node.items&&(c.nodeHtml="\x3cspan class\x3d'mini-tree-nodetext'\x3e"+c.node.name+"\x3c/span\x3e\x3ci class\x3d'emsg-cgroup-additem' title\x3d'\u6dfb\u52a0'\x3e\x3c/i\x3e")}).on("nodeclick",function(c){var d=c.node,g=d.items;$(c.htmlEvent.target).hasClass("emsg-cgroup-additem")?g&&r(d):g&&g.length?q.isExpandedNode(d)?q.collapseNode(d):q.expandNode(d):l(d)});q.render(document.getElementById("emsg_group"));w();d()})()}function EMsgSocket(y,p,k){function g(d){eMsg&&eMsg.receiveMessage(d);eMsg&&"max"==eMsg.status()||"message"!=d.type&&"file"!=d.type||q(d);-1<$.inArray(d.type,["message","creategroup","joingroup"])&&window.RefreshEMsg&&RefreshEMsg()}this.uid=y;this.uname=p;var n=k.subSocket;this.sendMessage=function(d){if(!n.request.isOpen)return mini.showTips({content:"E\u8baf\u5df2\u65ad\u5f00\u8fde\u63a5\uff0c\u65e0\u6cd5\u53d1\u9001\u6d88\u606f\uff01",state:"danger",x:"center",y:"center",timeout:2E3}),!1;n.push(d);return!0};this.isConnect=function(){return n.request.isOpen};this.close=function(){atmosphere.unsubscribe()};var t={},q=function(d){var g=d.sessiontype,k;k="friend"==g?{query:"getuserinfo",uid:d.from_uid}:{query:"getgroupinfo",uid:d.sessionid};if("undefined"==typeof t[k.uid])Util.ajax({url:EmsgConfig.baseUrl,data:k}).done(function(l){l.imgUrl="friend"==g?l.imgUrl||EmsgConfig.userImg:EmsgConfig.groupImg;t[k.uid]=l;m(l.name,{body:d.content,icon:l.imgUrl})}).fail(function(){});else{var l=t[k.uid];m(l.name,{body:d.content,icon:l.imgUrl})}},m=function(d,g,k){var l;"string"==typeof g&&(g={body:g});if("Notification"in window)"granted"===Notification.permission?l=new Notification(d,g):"denied"!==Notification.permission&&Notification.requestPermission(function(k){"granted"===k&&(l=new Notification(d,g))});else return!1;setTimeout(function(){l.close()},k||3E3)};this.socketEvent=p=k.socketEvent;p.on("message",function(d){g(d.data)});p.on("file",function(d){g(d.data)});p.on("renamegroup",function(d){g(d.data)});p.on("remotelogin",function(d){epoint.alert(d.data.message,"\u7cfb\u7edf\u63d0\u793a",function(d){if(UserConfig.onLogout)UserConfig.onLogout()})});p.on("config",function(d){EmsgConfig.showErrorMsg=d.data.showerrormsg});window.eMsg=new EMsgDialog(y)};