!function(e,i){var t,a=i("#wizard-bar"),s=i("#wizard-nav"),r=i(".next",s),d=i(".prev",s),n=i(".finish",s),l=i("#wizard-iframe"),o=Mustache,u=i.trim(i("#flow-item-templ").html()),c=i(".wizard-list",a),h=function(e){var i;for(i in e)"status"==i?"disabled"==e.status&&(this._disabled=1):this["_"+i]=e[i]};h._readyOnlyProps=["code","name","title"],i.extend(h.prototype,{next:function(){return this.isLast()?null:v[this._index+1]},prev:function(){return this.isFirst()?null:v[this._index-1]},getIndex:function(){return this._index},isFirst:function(){return 0==this._index},isLast:function(){return this._index==h._length-1},disable:function(){this._disabled=1,$flow=C(this._index),$flow.removeClass("default done active error").addClass("disabled"),Util.redrawPseudoEl($flow[0])},enable:function(){this._disabled=0,$flow=C(this._index),$flow.removeClass("disabled active default error").addClass("done"),Util.redrawPseudoEl($flow[0])},isDisabled:function(){return!!this._disabled},getData:function(){return i.extend({},f[this._index])},setUrl:function(e){this._setData("url",e)},_setData:function(e,t){i.inArray(e,h._readyOnlyProps)==-1&&(this["_"+e]=t,f[this._index][e]=t)},_active:function(){var e=this._index,i=C(e),t=i.removeClass("default done disabled error").addClass("active").siblings(".active").removeClass("active");l[0].src=Util.getRightUrl(this._url),_=e,Util.redrawPseudoEl(i[0]),Util.redrawPseudoEl(t[0])},_error:function(){var e=C(this._index);e.removeClass("default active disabled done").addClass("error"),Util.redrawPseudoEl(e[0])},_done:function(){var e=C(this._index);e.removeClass("default active disabled error").addClass("done"),Util.redrawPseudoEl(e[0])}});var v=[],f=[],_=null,x=function(e){var t=[];h._length=e.length,i.each(e,function(a,s){var r=i.extend({},s);r.index=a,r.title||(r.title=s.name),a==e.length-1&&(r.isLast=!0),null==_&&"active"==s.status&&(_=a),t.push(o.render(u,r)),s.index=a,v.push(new h(s))}),c.html(Util.clearHtml(t.join("")))},C=function(e){return t.eq(e)},b=function(a){f=a,x(a),t=c.find(".wizard-item"),WizardNav.onInit&&i.proxy(WizardNav.onInit,e,v[_])(),l[0].src=Util.getRightUrl(a[_].url),w(_)},m=function(){var e=i.extend({query:"init-wizard"},WizardNav.params);Util.ajax({type:"POST",dataType:"json",url:Util.getRightUrl(WizardNav.loadUrl),data:e,success:function(e){e&&e.length&&b(e),Util.loadJs("fui/js/lib/jquery.nicescroll.min.js",function(){a.niceScroll({cursorcolor:"#666"})})},error:Util._ajaxErr})},p=function(){d.removeClass("disabled"),r.removeClass("disabled"),r.removeClass("hidden"),n.addClass("hidden")},w=function(e){var i=v[e];p(),(i.isFirst()||i.prev()._disabled)&&d.addClass("disabled"),i.isLast()&&(r.addClass("hidden"),n.removeClass("hidden"))};s.on("click",".wizard-step",function(e){e.preventDefault();var t=i(this),a=t.hasClass("next")?1:0;if(!t.hasClass("disabled")){var s=1,l=v[_],o=WizardNav.onStepChange;if(t.hasClass("finish"))return void(o&&i.proxy(o,this,"over",l)());if(o&&(s=i.proxy(o,this,a?"next":"prev",l)()),s===!1)return void l._error();var u=v[a?_+1:_-1];p(),(u.isFirst()||l._disabled&&a||u.prev()._disabled&&!a)&&d.addClass("disabled"),u.isLast()&&(r.addClass("hidden"),n.removeClass("hidden")),l._disabled||l._done(),u._active()}}),c.on("click",".done",function(e){e.preventDefault();var t=i(this),a=Util.toInt(t.data("index"));if(!t.hasClass("disabled")){var s=v[_],r=v[a];s._done(),r._active(),w(a),WizardNav.onFlowClick&&i.proxy(WizardNav.onFlowClick,this,r)()}}),m()}(this,jQuery);