<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>外部通讯录联系人添加</title>
    <!-- 请修改相对路径 -->
    <script src="../../../fui/js/cssboot.js"></script>
    <style type="text/css">
        /*个性化上传控件按钮，为普通按钮样式*/
        #uploader .mini-uploader-btns .webuploader-pick {
            box-sizing: border-box;
            border: 1px solid;
            background-color: #51a6ef;
            padding: 1px 14px;
            border-color: #33a1d1;
        }

        #uploader .mini-uploader-btns .webuploader-pick:hover {
            background-color: #31afe5;
            border-color: #31afe5;
        }
    </style>
</head>

<body>
<!-- 必须有，加载时的loading效果 -->
<div class="page-loading"></div>


<div class="fui-left">
    <div id="tree" name="tree" class="mini-tree"
         autoLoad="false"
         showTreeIcon="true" textField="text" idField="id"
         parentField="pid" action="getCategoryModal()" resultAsTree="false"
         showCheckBox="false" checkRecursive="false" autoCheckParent="false" expandOnLoad="true"
         showRadioButton="true" style="height:100%"
    ></div>
</div>
<div class="fui-right">
    <!-- toolbar区域 -->
    <div class="fui-toolbar">
        <div class="btn-group mr10">
            <a class="mini-button" id="addClose" onclick="saveAndClose">保存并关闭</a>
            <a class="mini-button" onclick="epoint.closeDialog">关闭</a>
        </div>
    </div>
    <!-- 内容区域 -->
    <div class="fui-content">
        <div id="fui-form" class="fui-form">
            <div role="row">
                <div role="control" label="联系人照片">
                    <img src="" id="linkpic" alt="" style="width:168px;height:180px"/>
                </div>
            </div>
            <div role="row" style="padding-left:2px;padding-right:10px">
                <div role="control" label="">
                    <div id="uploader" class="mini-webuploader"
                         style="float:left;width:auto;vertical-align:top;margin-right:8px;"
                         action="oabusinesscarduseraddaction.getFileUploadModel"
                         fileSingleSizeLimit="5120" limitType="jpeg,jpg,gif,png,bmp" auto="true"
                         onfilesuccess="OnPhotoSuccess" showDefaultUI="false"></div>
                    <a class="mini-button" style="float:none;width:auto;vertical-align:top;" id="delpic"
                       onclick="delpic">删除照片</a>
                </div>
                <div role="control" label="">

                </div>
            </div>
            <div role="row">
                <div role="control" label="联系人姓名" starred="true">
                    <input id="linkdisplayname" class="mini-textbox" bind="dataBean.linkdisplayname"
                           required="true" vtype="maxLength:15"/>
                </div>
                <div role="control" label="性别">
                    <!--<input id="sex" class="mini-textbox" bind="dataBean.sex"/>-->
                    <input class="mini-combobox" id="sex"
                           bind="dataBean.sex" textField="text" valueField="id"
                           data="[{id:'男',text:'男'},{id:'女',text:'女'}]"
                           emptyText="请选择..."/>
                </div>

            </div>
            <div role="row">
                <div role="control" label="手机号码">
                    <input id="mobile" class="mini-textbox" bind="dataBean.mobile" vtype="mobile"/>
                </div>
                <div role="control" label="办公电话">
                    <input id="telephoneoffice" class="mini-textbox" bind="dataBean.telephoneoffice" vtype="tel"/>
                </div>
            </div>
            <div role="row">
                <div role="control" label="QQ号码">
                    <input id="qqnumber" class="mini-textbox" bind="dataBean.qqnumber" vtype="maxLength:15"/>
                </div>
                <div role="control" label="电子邮件">
                    <input id="email" class="mini-textbox" bind="dataBean.email" vtype="email"/>
                </div>

            </div>
            <div role="row">
                <div role="control" label="家庭电话">
                    <input id="telephonehome" class="mini-textbox" bind="dataBean.telephonehome" vtype="phone"/>
                </div>
                <div role="control" label="其他通讯">
                    <input id="otherimnumber" class="mini-textbox" bind="dataBean.otherimnumber" vtype="maxLength:20"/>
                </div>
                <!-- <div role="control" label="MSN">
                    <input id="msnnumber" class="mini-textbox" bind="dataBean.msnnumber" />
                </div> -->
            </div>
            <div role="row">
                <div role="control" label="部门">
                    <input id="deptname" class="mini-textbox" bind="dataBean.deptname" vtype="maxLength:15"/>
                </div>
                <div role="control" label="传真">
                    <input id="fax" class="mini-textbox" bind="dataBean.fax" vtype="maxLength:15"/>
                </div>
            </div>
            <div role="row">
                <div role="control" label="职务">
                    <input id="title" class="mini-textbox" bind="dataBean.title" vtype="maxLength:15"/>
                </div>
                <div role="control" label="邮编">
                    <input id="postaldddress" class="mini-textbox" bind="dataBean.postaladdress" vtype="postCode"/>
                </div>
            </div>

            <div role="row">
                <!--<div role="control" label="排序号">
                    <input id="ordernumber" class="mini-textbox" bind="dataBean.ordernumber"/>
                </div>-->
                <div role="control" label="单位">
                    <input id="companyname" class="mini-textbox" bind="dataBean.companyname" vtype="maxLength:15"/>
                </div>
                <div role="control" label="地址">
                    <input id="workaddress" class="mini-textbox" bind="dataBean.workaddress" vtype="maxLength:15"/>
                </div>
            </div>
            <div role="row">
                <!-- <div role="control" label="Email2">
                    <input id="txtemail2" class="mini-textbox" bind="dataBean.txtemail2" />
                </div> -->
                <div role="control" label="主页">
                    <input id="weburl" class="mini-textbox" bind="dataBean.weburl" vtype="url"/>
                </div>
                <div role="control" label="个人博客">
                    <input id="txtpersonweburl" class="mini-textbox" bind="dataBean.txtpersonweburl"
                           vtype="maxLength:20"/>
                </div>
            </div>
            <!-- <div role="row">
                <div role="control" label="居住地地址">
                    <input id="txtzhuzaiaddress" class="mini-textbox" bind="dataBean.txtzhuzaiaddress" />
                </div>
                <div role="control" label="居住地传真号">
                    <input id="txtzhuzaifax" class="mini-textbox" bind="dataBean.txtzhuzaifax"/>
                </div>
            </div> -->
            <!-- <div role="row">
                <div role="control" label="居住地邮政地址">
                    <input id="txtzhuzaipostaladdress" class="mini-textbox" bind="dataBean.txtzhuzaipostaladdress" />
                </div>

            </div> -->
            <!--<div role="row">
                <div role="control" label="家庭电话">
                    <input id="telephonehome" class="mini-textbox" bind="dataBean.telephonehome" vtype="phone"/>
                </div>

            </div>-->
            <div role="row">
                <div role="control" label="说明">
                    <input id="note" class="mini-textarea" bind="dataBean.note"/>
                </div>
            </div>
            <div class="hidden">
                <input id="linkuserguid" class="mini-textbox" bind="dataBean.linkuserguid"/>
                <input id="owneruserguid" class="mini-textbox" bind="dataBean.owneruserguid"/>
            </div>
        </div>
    </div>
</div>
<!-- 请修改相对路径 -->
<script src="../../../rest/resource/jsboot"></script>
<script>
    // 初始化页面
    epoint.initPage('oabusinesscarduseraddaction', null, function (data) {
        if (Util.getUrlParams().categoryguid != "") {
            mini.get("tree").setValue(Util.getUrlParams().categoryguid);
        }
        mini.get("sex").setValue("男");
    });

    function checkname() {
        var name = mini.get("linkdisplayname").getValue();
        var ret = /^[a-zA-Z\u4e00-\u9fa5][0-9a-zA-Z\u4e00-\u9fa5]+$/;
        if (ret.test(name) && name.toLowerCase() != "null") {
            return true;
        } else {
            return false;
        }
    }

    function saveAndNew() {
        if (epoint.validate()) {
            if (checkname()) {
                //epoint.execute('addNew','fui-form',newCallback);
                epoint.execute('checkUserName', 'fui-form', null, function (data) {
                    if (data.isrepeat) {
                        epoint.confirm("该姓名已存在是否确认增加？", "", function (action) {
                            epoint.execute('addNew', '@all', newCallback);
                        });
                    } else {
                        epoint.execute('addNew', '@all', newCallback);
                    }
                });
            } else {
                epoint.showTips("您输入的名字不合法！", {
                    state: 'danger',
                    y: 'center'
                });
            }
        }
    }


    function saveAndClose() {
        var selectgroup = mini.get('tree').getSelectedNodes();
        if (selectgroup == ''||mini.get('tree').getValue()=='f9root') {
            epoint.showTips("请先选择分组！", {
                state: 'danger',
                y: 'center'
            });
            return;
        }
        if (epoint.validate()) {
            if (checkname()) {
                epoint.execute('checkUserName', 'fui-form', null, function (data) {
                    if (data.isrepeat) {
                        epoint.confirm("该姓名已存在是否确认增加？", "", function (action) {
                            epoint.execute('add', 'fui-form', [selectgroup[0].id], closeCallback);
                        });
                    } else {
                        epoint.execute('add', 'fui-form', [selectgroup[0].id], closeCallback);
                    }
                });
                //epoint.execute('add','fui-form',closeCallback);
            } else {
                epoint.showTips("名字不合法，请输入中文或英文！", {
                    state: 'danger',
                    y: 'center'
                });
            }

        }
    }

    // 新增操作的回调
    function newCallback(data) {
        if (data.msg) {
            epoint.alert(data.msg);
            // 清空表单
            epoint.clear('fui-form');
        }
    }

    // 关闭操作的回调
    function closeCallback(data) {
        if (data.msg) {
            epoint.alertAndClose(data.msg);
        }
    }

    function OnPhotoSuccess(args) {
        //   alert(1);

        epoint.alert("上传成功", "", function () {
            epoint.execute("loadImg", null, function (data) {
                if (data) {
                    $("#linkpic").attr('src', data.imgdata);
                }
            });
        });

    }

    function delpic() {
        epoint.execute("delpic", '', function () {
            $("#linkpic").attr('src', '');
            mini.get("uploader").clearFile();
        });
    }
</script>
</body>
</html>