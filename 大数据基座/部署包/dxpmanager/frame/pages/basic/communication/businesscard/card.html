<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>卡片式通讯录</title>
    <script src="../../../fui/js/cssboot.js"></script>
    <script>
        SrcBoot.output([
            './css/communicate.css',
            '../../js/classifysearch/classifysearch.css',
            './css/card.css'
        ]);
    </script>
</head>

<body>
<!-- 必须有，加载时的loading效果 -->
<div class="page-loading"></div>

<!-- toolbar区域 -->
<div class="fui-toolbar">
    <div class="com-toolbar-item">
        <a class="mini-button hidden" id="groupmanager"
           onclick="opensetting">分组设置</a> <a
            class="mini-button  hidden" id="btnadd"
            onclick="openadd">添加联系人</a> <a
            class="mini-button  hidden" id="btndel"
            onclick="deleteSelect">删除选中</a>
    </div>
    <div class="com-toolbar-ext">
        <div class="com-toolbar-item" id="view-wrap">
            <div class="com-btn">
                <a href="card" class="view view-card active" title="卡片式" id="acard"></a>
            </div>
            <div class="com-btn">
                <a href="list" class="view view-list" title="列表式" id="alist"></a>
            </div>
        </div>
        <div class="com-toolbar-item">
            <div class="classify-search" id="com-search">
                <input type="text" placeholder="姓名、手机号" class="classify-search-input"
                       id="smart-search"/>
                <button class="button-search" title="点击搜索"></button>
            </div>
        </div>
        <div class="com-toolbar-item">
            <div class="com-question">
                <span class="icon-question" title="帮助" style='display:none'></span>
            </div>
        </div>
    </div>
</div>

<!-- 内容区域 -->
<div class="fui-content">
    <div class="mini-fit" style="height: 100px; overflow: hidden;">
        <!-- 卡片 -->
        <div class="card-items clearfix nicescroll" id="card-items"></div>
        <!-- 加载更多 -->
        <div class="loading-more" id="btn-more">
				<span><i class="icon-load"><img
                        src="images/loading-more.png" alt="加载更多"></i>加载更多</span>
        </div>
    </div>
</div>

<script src="../../../rest/resource/jsboot"></script>
<!-- 卡片模板 -->
<script type="x-tmpl-mustache" id="cardlist-tmpl">
    {{#data}}
    <div class="card-itembox" >
        <div class="card-item" id="{{userguid}}">
            <div class="staff-baseinfo clearfix samll">
                <div class="staff-portrait">
                    <img style="cursor:pointer" src="../../../rest/readpictureaction/getUserPicture?isCommondto=true&userGuid={{userguid}}" id="{{userguid}}" alt="portrait" class="icon-portrait" onerror="javascript:if('{{{sex}}}'!='女') this.src='images/photo-boy.png'; else this.src='images/photo-girl.png';"/>



                    <!--<img src="{{gendericon}}" alt="gender" class="icon-gender">-->
                </div>
                <p class="name" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width: 50%;"><span class="sname" id="{{userguid}}">{{displayname}}</span><i class="state {{statecls}}">{{state}}</i></p>
                <p class="info dept" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width: 50%;">部门 <span class="text">{{ouname}}</span></p>
                <p class="info duty" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width: 50%;">职务 <span class="text">{{title}}</span></p>
            </div>
            <div class="contact clearfix">
                <div class="contact-item r">
                    <img src="images/icon-phone.png" />
                    <span class="contact-num">{{telephoneoffice}}</span>
                </div>
                <div class="contact-ect l">
                    <div class="contact-item">
                        <img src="images/icon-mobile.png" />
                        <span class="contact-num">{{usermobile}}</span>
                    </div>
                    <div class="contact-item">
                        <img src="images/icon-car.png" />
                        <span class="contact-num">{{carNum}}</span>
                    </div>
                </div>
            </div>
            <div class="sender-bar">
                <a href="javascript:writeMail('{{userguid}}','{{displayname}}');" class="contactmail">发邮件</a>
                <a href="javascript:sendMsg('{{userguid}}')" class="webmsg">微消息</a>
                <!-- <a href="javascript:sendMobileMsg('{{userguid}}')" class="sendermsg">发短信</a>-->
                <!--<div class="bar-more">更多</div>-->
            </div>
            <div class="checked"><img src="images/icon-checked.png" alt="选中"></div>
        </div>
    </div>
    {{/data}}

</script>
<!-- 配置接口 -->
<script>
    //var getInnerCardList = "./test/getInnerCardList";
</script>
<script>
    SrcBoot.output([
        // './test/_testcard.js', // 测试模拟js
        '../../../fui/js/lib/jquery.nicescroll.min.js',
        '../../js/classifysearch/classifysearch.js',
        './js/businesscommon.js',
        './js/card.js'
    ]);
</script>
<script>
    var $smartSearch = $("#smart-search"),
            $cardContainer = $("#card-items");

    var cardListTmpl = $("#cardlist-tmpl").html();

    var defaultPageIndex = 0,
            defaultPageSize = window.EpFrameSysParams ? EpFrameSysParams['gridPageSize'] : 20;


    var userGuid;

    initCardPage();
    // init
    function initCardPage() {
        requestCard(true);

        bindCardEvent();
        initSearch();
    }

    //
    function getQuery() {
        var urlQueryString = Util.getUrlParams(),
                grouptype = urlQueryString.group,
                groupguid = urlQueryString.guid,
                key = $.trim($smartSearch.val()),
                type = 0,
                result = {};
        result.grouptype = grouptype;
        result.groupguid = groupguid;
        result.pagesize = defaultPageSize;
        result.pageindex = defaultPageIndex;
        $('#acard').attr('href', 'card?group=' + grouptype + '&guid=' + groupguid);
        $('#alist').attr('href', 'inaddresslist?grouptype=' + grouptype + '&groupguid=' + groupguid);


        if (key && key.length) {
            result.key = key;
            result.type = type;
        }

        return result;
    }

    // 请求card data
    function requestCard(isfirst, query) {
        if (query === undefined) {
            query = getQuery();
        }

        epoint.execute('framecardaction.getData', "@none", query, function (data) {
            if (data.userGuid)
                userGuid = data.userGuid;
            if (Util.getUrlParams().group == 3 || (Util.getUrlParams().group == 2 && data.canManager == true)) {
                $("#groupmanager").removeClass("hidden");
                $("#btnadd").removeClass("hidden");
                $("#btndel").removeClass("hidden");
            } else {
                // 不能操作的页面，card不能勾选， add by xiaol
                $cardContainer.addClass('cant-manage');
            }
            renderCardList(epoint.decodeJson(data.group));

            if (isfirst) {
                Util.hidePageLoading();
            }
            //defaultPageIndex++;

        });
    }

    // 渲染card
    function renderCardList(data) {
        if (data) {

            // Modify view
            var items = data.data,
                    l = items.length;

            //在位情况暂时隐藏         qqf  2017-5-9
            /* for(var i = 0; i < l; i++) {


             if(items[i].state === "在岗") {
             items[i].statecls = "on";
             } else if (items[i].state === "请假") {
             items[i].statecls = "leave";
             } else if (items[i].state === "外出") {
             items[i].statecls = "out";
             }
             } */

            if (defaultPageIndex === 0) {
                $cardContainer.empty();
            }
            console.log(data);
            $cardContainer.append(Mustache.render(cardListTmpl, data));
        }
    }

    // 绑定事件
    function bindCardEvent() {
        $("#btn-more").on('click', function (event) {
            defaultPageIndex++;
            requestCard();
        });

        $(".button-search").on('click', function (event) {
            var key = $.trim($smartSearch.val());

            if (key && key.length) {
                requestCard();
            }

        });
    }

    // 获取选中的项目，返回userguid的数组
    function getSelectCard() {
        var selectGuids = [];

        var $cardItems = $cardContainer.find(".card-item");

        $cardItems.each(function (index, el) {
            if ($(el).hasClass("active")) {
                selectGuids.push(el.id);
            }
        });

        return selectGuids;

    }

    // TODO 发送邮件
    // TODO 发送邮件
    function writeMail(id, name) {


        if (top.TabsNav) { //如果顶层窗口支持 tab 式打开  使用 tab  打开整个邮件应用
            top.TabsNav.addTab({
                id: 'tab-' + id,
                name: '公务邮件',
                url: 'oa9/mail/mailframe',
                closeIcon: true, // 是否显示最小化按钮
                maxIcon: true
            });
        }
        else { // 否则使用div 方式打开邮件发送页面
            epoint.openDialog('发送邮件', 'oa9/mail/mailsend', '', {
                'width': null,
                'height': null,
                'showCloseButton': true,
                'showMaxButton': true,
                'allowResize': true
            });
        }

        top.mail = { //在顶层窗口对象中记录 邮件对象
            target: "mailsend",// 如果是开打 mailframe 页面 初始化加载哪个子页面
            touser: [{id: id, name: name, userType: 0}] //收件人数组
        };

    }

    // TODO 发消息
    function sendMsg(id) {
        top.OpenEMsg(id);
    }

    // TODO 发短信
    function sendMobileMsg(id) {
        console.log(id);
    }
    // 标识是否搜索过，搜索过之后，清空输入框才进行重新加载。
    var isSearched = false;



    // 分类搜素按键回调
    function searchkeyup(index, key) {
        if (key.length === 0 && isSearched) { // 清空输入框时，重新加载表格
            requestCard();
            isSearched = false;
        }
    }

    // smartsearch 搜索
    function clickenter(id,key) {
        var index=id;
        var type;

        if (index === -1 || index === undefined) {
            type = 0;
        } else {
            type = index;
        }

        var query = getQuery();
        query.type = index;

        if (key && key.length) {
            query.type = type;
            query.key = key;
            defaultPageIndex = 0;
            query.pageindex = 0;
            requestCard(false, query);
        }
        isSearched = true;
    }

    //删除选中行
    function deleteSelect() {
        var ids = getSelectCard();
        if (ids.length > 0) {
            epoint.confirm("确定删除选中记录？", "", function (action) {
                var urlQueryString = Util.getUrlParams();
                epoint.execute("framecardaction.delete", "", [ids
                        .join(','), urlQueryString.guid], function (data) {
                    if (data.msg) {
                        epoint.showTips("删除成功！", {
                            state: 'success',
                            y: 'center'
                        });
                        searchData();
                    }
                });
            });
        } else {
            epoint.showTips("请选择需要删除的联系人！", {
                state: 'danger',
                y: ''
            });
            return;
        }
    }

    function openadd() {
        epoint.openTopDialog('添加联系人', 'oa9/communication/businesscard/oaaddressuserselect?groupguid=' + Util.getUrlParams().guid + '&grouptype=' + Util.getUrlParams().group, searchData, {
            width: 700,
            Height: 450,
            'showCloseButton': true,
            'showMaxButton': true
        });
    }

    // 表格的搜索
    function searchData() {
        requestCard();
        window.parent.requestGroup(1);
        window.parent.requestGroup(2);
    }

    function opensetting() {
        if (Util.getUrlParams().group == 2) {
            epoint.openTopDialog('分组管理', 'oa9/communication/businesscard/addressgroup/addressgrouplist?userGuid=public', searchData, {
                width: 1000,
                height: 750,
                'showCloseButton': true,
                'showMaxButton': true,
                'allowResize': true

            });
        }
        if (Util.getUrlParams().group == 3) {
            epoint.openTopDialog('分组管理', 'oa9/communication/businesscard/addressgroup/addressgrouplist?userGuid=' + userGuid, searchData, {
                width: 1000,
                height: 750,
                'showCloseButton': true,
                'showMaxButton': true,
                'allowResize': true
            });
        }
    }


    //nicescroll
    $(".nicescroll").niceScroll({
        touchbehavior: false,
        cursorcolor: "#f2f2f2",
        cursoropacitymax: 1,
        cursorwidth: 5,
        cursorborder: "none",
        cursorborderradius: "5px",
        autohidemode: false
    });
</script>
</body>

</html>
