"use strict";var _createClass=function(){function o(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(t,e,i){return e&&o(t.prototype,e),i&&o(t,i),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!==module?module.exports=e():"function"==typeof define&&define.amd?define(e()):t.ImageClip=e()}(window,function(){var i={lineColor:"#2196f3",lineWidth:3,pointRadius:10,bgcolor:"#333",pointColor:"#ffeb3b",borderColor:"#fff",borderWidth:"1px"};return function(){function e(t){if(_classCallCheck(this,e),!t.el)throw new Error("请传入ImgClip容器id");this.env=/Mobile/g.test(navigator.userAgent)?"Mobile":"Browser",this.extend(this,t,i),this.el=this.getHTMLElement(t.el),this.rectEl=this.getHTMLElement(".imgclip-rect"),this.imgEl=document.createElement("img"),this.setBgColor(t.bgcolor),this.maxSize=t.maxSize||""}return _createClass(e,[{key:"setBgColor",value:function(t){this.el.style.backgroundColor=t}},{key:"getHTMLElement",value:function(t){var e=this.el&&"string"!=typeof this.el?this.el:document;return 1!==t.nodeType?e.querySelector(t):t}},{key:"drawImage",value:function(t,i,o){var n=document.createElement("canvas"),a=n.getContext("2d"),e=this.imgEl,r=this.rectEl,s=this,l=this.getPixelRatio(a);l=l?l+2:0,this.canvasEl=n,this.ctx=a,this.base64=t,e.src=t,e.onload=function(){var t=-i/2,e=-o/2;s.pixelRatio=l,n.style.width=i+"px",n.style.height=o+"px",n.width=i*l,n.height=o*l,r.style.cssText="width: "+i+"px; height: "+o+"px; margin-left: "+t+"px; margin-top: "+e+"px; cursor: crosshair;",s.drawWidth=i*l,s.drawHeight=o*l,a.drawImage(this,0,0,i*l,o*l)}}},{key:"getPixelRatio",value:function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e}},{key:"showImg",value:function(){var t=this.canvasEl,e=this.rectEl;e.innerHTML="",this.el.style.display="block",e.appendChild(t)}},{key:"hidden",value:function(){this.el.style.display="none"}},{key:"show",value:function(){this.el.style.display="block"}},{key:"handleCoordinate",value:function(t){if("object"===(void 0===t?"undefined":_typeof(t)))return t;var e=this.canvasEl.width,i=this.canvasEl.height,o=this.pixelRatio;for(var n in t=t?this.sortableCoordinate(t):{topLeft:{x:0,y:0},topRight:{x:e,y:0},bottomLeft:{x:0,y:i},bottomRight:{x:e,y:i}}){var a=t[n],r=a.x,s=a.y;a.x=r/o,a.y=s/o}return this.coordinate=t}},{key:"sortableCoordinate",value:function(t){t=JSON.parse(t);var n=[],i=[],a=[],r=[];t.forEach(function(t,e){n.push(t[0]),i.push(t[1])});var e=function(t){return t.sort(function(t,e){return t-e})};return n=e(n),i=e(i),t.forEach(function(t,e){var i=t[0],o=t[1];i===n[0]||i===n[1]?a.push({x:i,y:o}):r.push({x:i,y:o})}),{topLeft:a[0].y>a[1].y?a[1]:a[0],topRight:r[0].y>r[1].y?r[1]:r[0],bottomLeft:a[0].y>a[1].y?a[0]:a[1],bottomRight:r[0].y>r[1].y?r[0]:r[1]}}},{key:"paintPoints",value:function(t){this.getHTMLElement(".imgclip-dot-rect")&&(this.rectEl.innerHTML=""),t=this.handleCoordinate(t),this._drawLine(t);var e=document.createDocumentFragment(),i=parseInt(this.pointRadius,10),o=this.pointColor;for(var n in t){var a=t[n],r=document.createElement("span");r.classList.add("imgclip-dot-rect"),r.setAttribute("data-imageclip",n.toLowerCase()),r.style.cssText="width: "+2*i+"px; height: "+2*i+"px; left: "+(parseInt(a.x,10)-i)+"px; top: "+(parseInt(a.y,10)-i)+"px; background-color: "+o+"; border: "+parseInt(this.borderWidth)+"px solid "+this.borderColor+";",e.appendChild(r)}this.rectEl.appendChild(e),e=null}},{key:"openPointsDragDrop",value:function(a){a=a||this.coordinate;var t=this.getHTMLElement.bind(this),i=t("[data-imageclip=topleft]"),o=t("[data-imageclip=topright]"),n=t("[data-imageclip=bottomleft]"),r=t("[data-imageclip=bottomright]"),s=this._drawLine.bind(this),l=parseInt(this.pointRadius,10),e=this.env,c=0,h=0,u=0,d=0,p=!1,f=null,v=function(t){t.preventDefault();var e=t.touches?t.touches[0]:t;c=e.pageX,h=e.pageY,u=parseInt(this.style.left,10),d=parseInt(this.style.top,10)},y=function(t,e){t.preventDefault();var i=t.touches?t.touches[0]:t,o=u+i.pageX-c,n=d+i.pageY-h;this.style.left=o+"px",this.style.top=n+"px",a[e].x=o+l,a[e].y=n+l,s(a)};"Mobile"===e?(i.addEventListener("touchstart",function(t){v.call(this,t)},{passive:!1}),i.addEventListener("touchmove",function(t){y.call(this,t,"topLeft")},{passive:!1}),o.addEventListener("touchstart",function(t){v.call(this,t)},{passive:!1}),o.addEventListener("touchmove",function(t){y.call(this,t,"topRight")},{passive:!1}),n.addEventListener("touchstart",function(t){v.call(this,t)},{passive:!1}),n.addEventListener("touchmove",function(t){y.call(this,t,"bottomLeft")},{passive:!1}),r.addEventListener("touchstart",function(t){v.call(this,t)},{passive:!1}),r.addEventListener("touchmove",function(t){y.call(this,t,"bottomRight")},{passive:!1})):"Browser"===e&&(document.addEventListener("mousedown",function(t){var e=t.target.dataset.imageclip;if(e){switch(p=!0,e){case"topleft":v.call(i,t);break;case"topright":v.call(o,t);break;case"bottomleft":v.call(n,t);break;case"bottomright":v.call(r,t)}f=e}}),document.addEventListener("mousemove",function(t){if(p)switch(f){case"topleft":y.call(i,t,"topLeft");break;case"topright":y.call(o,t,"topRight");break;case"bottomleft":y.call(n,t,"bottomLeft");break;case"bottomright":y.call(r,t,"bottomRight")}}),document.addEventListener("mouseup",function(t){p=!1}))}},{key:"_drawLine",value:function(t){var e=this.pixelRatio,i=t.topLeft,o=t.topRight,n=t.bottomLeft,a=t.bottomRight,r=this.canvasEl,s=r.width,l=r.height,c=this.ctx,h=this.drawWidth,u=this.drawHeight;c.strokeStyle=this.lineColor,c.lineWidth=this.lineWidth*e,c.clearRect(0,0,s,l),c.drawImage(this.imgEl,0,0,h,u),this.coordinate=t,c.beginPath(),c.moveTo(o.x*e,o.y*e),c.lineTo(i.x*e,i.y*e),c.stroke(),c.beginPath(),c.moveTo(n.x*e,n.y*e),c.lineTo(i.x*e,i.y*e),c.stroke(),c.beginPath(),c.moveTo(o.x*e,o.y*e),c.lineTo(a.x*e,a.y*e),c.stroke(),c.beginPath(),c.moveTo(n.x*e,n.y*e),c.lineTo(a.x*e,a.y*e),c.stroke()}},{key:"getData",value:function(){var t=JSON.parse(JSON.stringify(this.coordinate)),e=this.pixelRatio;for(var i in t){var o=t[i],n=o.x,a=o.y;o.x=n*e,o.y=a*e}return{coordinate:t,base64:this.base64}}},{key:"getImgMIME",value:function(t){return t.match(/data:(.*);/)[1]}},{key:"getImgBase64Url",value:function(t){return t.match(/data:.*,/)[0]}},{key:"on",value:function(t,e){"object"!==_typeof(this.evt)&&(this.evt={upload:""}),this.evt[t]=e}},{key:"formatCoordinate",value:function(t){"object"!==(void 0===(t=t||this.coordinate)?"undefined":_typeof(t))&&(t=JSON.parse(t));var e=t.topLeft,i=t.topRight,o=t.bottomLeft,n=t.bottomRight;return[o.x,o.y,e.x,e.y,i.x,i.y,n.x,n.y]}},{key:"removeBase64Url",value:function(t){return t.match(/base64,(.*)/)[1]}},{key:"extend",value:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];for(var o=e[0],n=1,a=e.length;n<a;n++){var r=e[n];for(var s in r)void 0===o[s]&&(o[s]=r[s])}}}]),e}()});