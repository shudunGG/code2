// jshint -W030
//EMsg聊天窗口定义
function EMsgDialog(x){function u(a){if("string"!==typeof a)return a;if(0==a.length)return"";a=a.replace(/&amp;/g,"\x26");a=a.replace(/&lt;/g,"\x3c");a=a.replace(/&gt;/g,"\x3e");a=a.replace(/&nbsp;/g," ");a=a.replace(/&#39;/g,"'");return a=a.replace(/&quot;/g,'"')}var m=this,p,d,q={},l="close",f=$("#emsgDialog"),n=$(".emsg-session-list",f),w=$(".emsg-dialog-head",f),r=$(".emsg-message-panel",f),k=$(".emsg-message-text",f),y=$(".emsg-top-bar",f),z=$(".emsg-btn-send",f);if(this.useEnterSend=!0===EmsgConfig.enterSend)z[0].title="\u6309ENTER\u952e\u53d1\u9001";var t=$(".emsg-session-info",w),D=$(".emsg-user-img img",w),c=$(".emsg-curr-name",t),S=$(".emsg-group-date",t),C=$(".emsg-group-rename",t),T=$("\x3ci class\x3d'emsg-not-read'\x3e\x3c/i\x3e"),E,v=Mustache,Z=Util.clearHtml($("#emsg-sessionitem-templ").html()),L=Util.clearHtml($("#emsg-messagelist-templ").html()),F=Util.clearHtml($("#emsg-fileupload-templ").html());this.status=function(){return l};var aa=function(){M().done(function(a){p=a;p.imgUrl=p.imgUrl||EmsgConfig.userImg})},M=function(a){var b={query:"getuserinfo",uid:a};a&&(b.uid=a);b={url:EmsgConfig.baseUrl,data:b};a||(b.async=!1);return Util.ajax(b)},N=function(a){return Util.ajax({url:EmsgConfig.baseUrl,data:{query:"getgroupinfo",uid:a}})},ba=function(){function a(){$(".nicescroll",f).niceScroll({cursorcolor:"#ff821b",horizrailenabled:!1});r.niceScroll({cursorcolor:"#ff821b",horizrailenabled:!1})}$.nicescroll?a():Util.loadJs("fui/js/lib/jquery.nicescroll.min.js",function(){a()})},ca=function(){Util.loadJs("fui/js/lib/jquery.emotion.js",function(){$(".emsg-emotion-icon").emotion({target:".emsg-message-text",path:"../../emsg/images/emotion/"})})},da=parseInt(EmsgConfig.attachSizeLimit)||5,U=function(){var a="gif jpg jpeg bmp png rar zip doc xls ppt docx xlsx pptx txt pdf".split(" "),b,e=WebUploader.create({dnd:"#EmsgText",auto:!0,swf:Util.getRightUrl("fui/js/lib/webuploader/Uploader.swf"),server:Util.getRightUrl(EmsgConfig.baseUrl),pick:{id:"#fileUploader",multiple:!1},duplicate:!0,accept:{extensions:a.join(",")}});e.on("beforeFileQueued",function(g){if(!eMsgSocket.isConnect())return mini.showTips({content:"E\u8baf\u5df2\u65ad\u5f00\u8fde\u63a5\uff0c\u65e0\u6cd5\u53d1\u9001\u6d88\u606f\uff01",state:"danger",x:"center",y:"center",timeout:2E3}),!1;var h=g.name.substr(g.name.lastIndexOf(".")+1).toLowerCase();g=g.size;if(-1==$.inArray(h,a))return mini.alert("\u9009\u62e9\u7684\u683c\u5f0f\u4e0d\u6b63\u786e\uff01"),!1;if(0==g)return mini.alert("\u4e0d\u80fd\u53d1\u9001\u7a7a\u6587\u4ef6\uff01"),!1;if(g>1048576*da)return mini.alert("\u6587\u4ef6\u5927\u5c0f\u9700\u5c0f\u4e8e5M\uff01"),!1});e.on("uploadStart",function(a){a=v.render(F,{name:a.name,size:G(a.size)});b=H(d.sessionId,{content:a,time:mini.formatDate(new Date,"yyyy-MM-dd HH:mm:ss"),IsSend:!0,imgUrl:p.imgUrl});e.options.formData={query:"uploadfile",sessionid:d.sessionId};$(".emsg-uploader-status",b).removeClass("down");$(".emsg-uploader-process",b).css("visibility","visible")});e.on("uploadProgress",function(a,h){$(".emsg-process-inner",b).css("width",100*h+"%")});e.on("uploadSuccess",function(a,h){h=h.custom;$(".emsg-uploader-status",b).addClass("success");$(".emsg-file-uploader",b).wrap($("\x3ca/\x3e",{"class":"emsg-file-down",href:Util.getRightUrl(h.href),target:"_blank"}))});e.on("uploadError",function(a){$(".emsg-uploader-status",b).addClass("fail");$(".emsg-file-reupload",b).show().on("click",function(){b.remove();e.retry()})});e.on("uploadComplete",function(a){$(".emsg-uploader-process",b).css("visibility","hidden")});e.on("uploadBeforeSend",function(a,h,b){if(a=$.cookie("_CSRFCOOKIE"))b.CSRFCOOKIE=a})},G=function(a){return 1048576<a?(a/1048576).toFixed(2)+"MB":(a/1024).toFixed(2)+"KB"},fa=function(){f.draggable({handle:w,containment:"body",cursor:"move"});var a=$(".emsg-dialog-min",f),b=$(".emsg-dialog-close",f),e=$(".emsg-history-link",f);a.on("click",function(){$(this).hasClass("max")?m.show("max"):m.show("min")});b.on("click",function(){1==V()?I(d.sessionId):mini.showMessageBox({title:"\u7cfb\u7edf\u63d0\u793a",message:"\u5173\u95ed\u6b64\u7a97\u53e3\u6240\u6709\u4f1a\u8bdd\u8fd8\u662f\u4ec5\u5173\u95ed\u5f53\u524d\u4f1a\u8bdd\uff1f",buttons:["\u5173\u95ed\u6240\u6709","\u5173\u95ed\u5f53\u524d"],iconCls:"mini-messagebox-question",callback:function(a){"\u5173\u95ed\u6240\u6709"==a?W():"\u5173\u95ed\u5f53\u524d"==a&&I(d.sessionId)}})});n.on("click",".emsg-session-item",function(a){J($(this).data("sessionid"))}).on("click",".emsg-remove",function(a){a.stopPropagation();a=$(this).closest("li").data("sessionid");I(a)});r.on("click",".emsg-load-link",function(){var a=$(this).closest(".emsg-message-tab");$(this).find(".emsg-load-icon").hasClass("nomore")||ea(a)});k.on("keydown",function(a){var h=a.ctrlKey,b=a.shiftKey;if(13===a.which)if(m.useEnterSend){if(!h&&!b)return O(),!1;h&&(a=$("\x3cdiv\x3e\x3cbr\x3e\x3c/div\x3e"),window.getSelection?(h=window.getSelection(),b=h.getRangeAt(0),b.insertNode(a[0]),b.collapse(!1),h.removeAllRanges(),h.addRange(b),h.collapseToEnd()):document.selection&&document.selection.createRange?(h=document.selection,b=h.createRange(),b.pasteHTML(a[0].outerHTML),b.collapse(!1),b.select()):(a.appendTo(k),k.focus()))}else if(h)return O(),!1});c.on("mousedown",function(){if(0!=$(this).closest(".emsg-group-info").length&&"min"!=l){var a=$(this).width(),b=$(this).hide().html();C.data("origname",b).val(b).width(a).show().focus();return!1}});C.on("keydown",function(a){13==a.keyCode&&C.trigger("blur")}).on("blur",function(){var a=$(this),b=a.hide().val();c.show();if(""==$.trim(b))return epoint.showTips("\u8ba8\u8bba\u7ec4\u540d\u79f0\u4e0d\u80fd\u4e3a\u7a7a",{state:"error"});b!=a.data("origname")&&Util.ajax({url:EmsgConfig.baseUrl,data:{query:"renamegroup",groupid:d.uid,name:b},success:function(h){try{if(h.success){c.html(b);a.data("origname",b);q[d.sessionId].name=b;var g=A(d.uid);$(".emsg-user-name",g).html(b);epoint.showTips("\u4fee\u6539\u6210\u529f",{state:"success"})}else epoint.showTips("\u4fee\u6539\u8ba8\u8bba\u7ec4\u540d\u79f0\u5931\u8d25",{state:"error"})}catch(ja){}}})});if(EmsgConfig.sendEmailUrl){w.find(".emsg-write-email").removeClass("hidden");var g=EmsgConfig.sendEmailUrl+(-1!=EmsgConfig.sendEmailUrl.indexOf("?")?"\x26":"?");y.on("click",".emsg-write-email",function(){"group"==d.type?N(d.uid).done(function(a){a=$.map(a.members,function(a,b){return a.uid}).join(";");epoint.openDialog("\u53d1\u9001\u90ae\u4ef6",g+"ToUserGuidList\x3d"+a,"",{showCloseButton:!0,showMaxButton:!0,allowResize:!0})}):epoint.openDialog("\u53d1\u9001\u90ae\u4ef6",g+"ToUserGuid\x3d"+d.uid,"",{showCloseButton:!0,showMaxButton:!0,allowResize:!0})})}y.on("click",".emsg-quit-group",function(){var a=d.uid,b=d.sessionId;mini.showMessageBox({title:"\u7cfb\u7edf\u63d0\u793a",message:"\u786e\u5b9a\u9000\u51fa\u8ba8\u8bba\u7ec4\uff1f",buttons:["\u786e\u5b9a","\u53d6\u6d88"],iconCls:"mini-messagebox-question",callback:function(h){"\u786e\u5b9a"==h&&Util.ajax({url:EmsgConfig.baseUrl,data:{query:"quitgroup",groupid:a},success:function(a){1==a.success?(I(b),RefreshEMsg&&RefreshEmsg()):mini.alert("\u9000\u51fa\u5931\u8d25\uff01")}})}})}).on("click",".emsg-create-group",function(){E||(E=new EMsgGroupDialog(x));"friend"==d.type?E.createGroup([{uid:p.uid,name:p.name},{uid:d.uid,name:d.name}]):E.editGroup(d.uid)});z.on("click",function(){O()});e.on("click",function(){var a=EmsgConfig.historyUrl+"?exunsessionid\x3d"+d.sessionId,a=Util.getRightUrl(a);if(EmsgConfig.onHistoryBtnClick)EmsgConfig.onHistoryBtnClick(a,d);else TabsNav.addTab({id:d.sessionId,name:"\u548c"+d.name+"\u804a\u5929\u8bb0\u5f55",url:a});m.show("min")})},A=function(a){return n.find("li[data-sessionid\x3d'"+a+"']")},B=function(a){return r.find("div[data-sessionid\x3d'"+a+"']")},J=function(a,b){var e=A(a);e.siblings().removeClass("active").end().addClass("active");var g=q[a];d=g;"group"==g.type?(S.html("\u521b\u5efa\u65e5\u671f\uff1a"+g.createDate).show(),t.addClass("emsg-group-info")):(t.removeClass("emsg-group-info"),S.hide());D.attr("src",EmsgConfig.userImg).attr("src",g.imgUrl).off("error").on("error",function(){this.src=EmsgConfig.userImg});c.html(g.name).show();C.hide();var h=$(".emsg-not-read",e);h.length&&h.remove();h=$.trim(k.html());k.empty();var f=k.data("sessionId");A(f).data("saveMsg",h);!0===b?(X({sessionId:a,pageIndex:1}).done(function(b){K(a);var h,e,c=-1;if("friend"==g.type){e=b.messagelist;for(var d=0,f=e.length;d<f;d++)if(!e[d].readtime){c=d;break}-1==c&&(c=e.length);h=e.slice(0,c);e=e.slice(c)}else{h={member:b.member};e={member:b.member};d=0;for(f=b.messagelist.length;d<f;d++)if(!b.messagelist[d].readtime){c=d;break}-1==c&&(c=b.messagelist.length);h.messagelist=b.messagelist.slice(0,c);e.messagelist=b.messagelist.slice(c)}P(e,g);c=B(a);0<b.messagelist.length&&$(".emsg-message-list",c).prepend("\x3cli class\x3d'emsg-message-tip'\x3e\x3ci class\x3d'emsg-tip-icon'\x3e\x3c/i\x3e\u4ee5\u4e0a\u662f\u5386\u53f2\u6d88\u606f\x3c/li\x3e");P(h,g,c);c.siblings().hide().end().show().data("page",1);r.scrollTop(c.prop("scrollHeight"));k.empty()}),$.isArray(a)):(h=B(a).siblings().hide().end().show(),r.scrollTop(h.prop("scrollHeight")),K(a),e=e.data("saveMsg"),0<$.trim(e).length&&k.html($.trim(e)));k.data("sessionId",a);Q(k[0])},I=function(a){var b=A(a),e=B(a);if(b.hasClass("active")){var g;g=b.next();0===g.length&&(g=b.prev());0<g.length&&(g=g.data("sessionid"),J(g,!1))}$(".emsg-not-read",b).length&&K(a);b.remove();e.remove();$.isArray(a);delete q[a];0===V()&&W()},ga=function(a){a!=d.sessionId?(a=A(a),0===$(".emsg-not-read",a).length&&a.append(T.clone())):"min"==l&&0===$(".emsg-not-read",t).length&&c.next().after(T.clone())},K=function(a){Util.ajax({url:EmsgConfig.baseUrl,data:{query:"ignoremessage",sessionid:a},success:function(a){}})},ha=function(a,b){R(a)&&N(b).done(function(b){$.extend(b,{type:"group",sessionId:a,imgUrl:EmsgConfig.groupImg});q[a]=b;var e=A(a);$(".emsg-user-name",e).html(b.name);d.sessionId==a&&c.html(b.name)})},R=function(a){return"undefined"==typeof q[a]?!1:!0},V=function(){var a=0,b;for(b in q)a++;return a},W=function(){n.empty();$.each(r.children(),function(a,b){$(b).getNiceScroll().remove()});r.empty();var a=[],b;for(b in q)a.push(b);$.isArray(a);q={};f.hide();k.removeData("uid").empty();l="close"},X=function(a,b){return Util.ajax({url:EmsgConfig.baseUrl,beforeSend:b,data:{query:"loadhistorymessage",sessionid:a.sessionId,pageindex:a.pageIndex}})},ea=function(a){var b=a.data("page")+1,e=$(".emsg-load-link",a),g=$(".emsg-load-icon",e),h=$(".emsg-load-text",e);a.data("page",b);var e=a.data("sessionid"),c=q[e];X({sessionId:e,pageIndex:b},function(a){$.ajaxSettings.beforeSend&&$.ajaxSettings.beforeSend(a);g.addClass("loading");h.html("\u52a0\u8f7d\u7b49\u5f85")}).done(function(b){g.removeClass("loading");0<b.messagelist.length?("friend"==c.type&&(b=b.messagelist),P(b,c,a),h.html("\u67e5\u770b\u66f4\u591a\u4fe1\u606f")):(g.addClass("nomore"),h.html("\u65e0\u66f4\u591a\u4fe1\u606f"))})},P=function(a,b,e){if("friend"==b.type)a=$.map(a,function(a,c){a.uid==p.uid?(a.IsSend=!0,a.imgUrl=p.imgUrl):(a.IsReceive=!0,a.imgUrl=b.imgUrl);a.content&&(a.content=a.content.replace(/\n/g,"\x3cbr\x3e"));if("file"===a.type){var h=v.render(F,{name:a.content,size:G(a.size)});a.IsFile=!0;a.href=Util.getRightUrl(a.href);a.content=h}return a});else{var c=[];$.each(a.member,function(a,b){c[b.uid]=b});a=$.map(a.messagelist,function(a,b){a.IsGroup=!0;a.uid==p.uid?(a.IsSend=!0,a.imgUrl=p.imgUrl):(a.IsReceive=!0,a.imgUrl=c[a.uid].imgUrl||EmsgConfig.userImg,a.name=c[a.uid].name);a.content&&(a.content=a.content.replace(/\n/g,"\x3cbr\x3e"));if("file"===a.type){var e=v.render(F,{name:a.content,size:G(a.size)});a.IsFile=!0;a.href=Util.getRightUrl(a.href);a.content=e}return a})}e?(a=$(Util.clearHtml(v.render(L,{hasHead:!0,sessionId:b.sessionId,items:a}))),a.prependTo($(".emsg-message-list",e))):(a=$(Util.clearHtml(v.render(L,{sessionId:b.sessionId,items:a}))),a.appendTo(r))},H=function(a,b){var c;b.content&&(b.content=b.content.replace(/\n/g,"\x3cbr\x3e"));c=v.render(L,{hasHead:!0,items:[b]});var g=B(a);c=$(c);c.appendTo($(".emsg-message-list",g));r.getNiceScroll().resize();r.scrollTop(g.prop("scrollHeight"));K(a);return c},ia=function(a,b,c){a=B(a);var g="",e="";"renamegroup"==b?(g=c.member,e="\u5c06\u8ba8\u8bba\u7ec4\u66f4\u540d\u4e3a\x3cspan class\x3d'emsg-tip-important'\x3e"+c.name+"\x3c/span\x3e"):"quitgroup"==b?(g=c.member,e="\u9000\u51fa\u8ba8\u8bba\u7ec4"):"joingroup"==b?(g=c.members.join("\u3001"),e="\u52a0\u5165\u8ba8\u8bba\u7ec4"):"receivedfile"==b&&(e="\u5bf9\u65b9\u5df2\u6210\u529f\u63a5\u6536\u4e86\u60a8\u53d1\u9001\u7684\u6587\u4ef6\u201c"+c.name+"\u201d");$(".emsg-message-list",a).append("\x3cli class\x3d'emsg-message-tip'\x3e\x3ci class\x3d'emsg-tip-icon'\x3e\x3c/i\x3e\x3cspan class\x3d'emsg-tip-important'\x3e"+g+"\x3c/span\x3e"+e+"\x3c/li\x3e");r.getNiceScroll().resize();r.scrollTop(a.prop("scrollHeight"))},Y=void 0===EmsgConfig.msgLengthLimit?1E3:parseInt(EmsgConfig.msgLengthLimit),O=function(){var a=k.html(),b=a.match(RegExp("\x3cimg","g")),b=10*(b?b.length:0)+a.replace(/<.*?>/g,"").length;Y&&b>Y?epoint.alert("\u8f93\u5165\u7684\u5185\u5bb9\u8fc7\u957f"):(a=a.replace(/<\/(?:div|p)>/ig,"\n").replace(/<br>/g,"\n"),a=a.replace(/<(?!img)[^>]*>/g,""),k.empty(),0===$.trim(a.replace(/&nbsp;/ig,"").replace(/<br\s*\/?>/g,"")).length?(z.addClass("empty-tootip"),setTimeout(function(){z.removeClass("empty-tootip")},1E3)):(a=u(a),b={content:a,time:mini.formatDate(new Date,"yyyy-MM-dd HH:mm:ss"),IsSend:!0,imgUrl:p.imgUrl},eMsgSocket.sendMessage(JSON.stringify({type:"message",sessionid:d.sessionId,from_uid:p.uid,from_name:p.name,content:a}))&&H(d.sessionId,b),Q(k[0])))},Q=function(a){$.fn.emotion&&$(a).emotion("resetCursor")};this.init=function(){aa();fa();ba();ca();window.WebUploader?U():Util.loadJs("fui/js/lib/webuploader/webuploader.min.js",function(){U()})};this.openSession=function(a,b,c){R(a)?(m.show("max"),J(a,!1)):("friend"==c?M(b):N(b)).done(function(b){b.type=c;b.sessionId=a;"friend"===c&&(b.imgUrl=b.imgUrl||EmsgConfig.userImg);"group"==c&&(b.imgUrl=EmsgConfig.groupImg,$.each(b.members,function(a,b){b.imgUrl=b.imgUrl||EmsgConfig.userImg}));q[a]=b;b=v.render(Z,$.extend({},b,{sessionid:a}));n.find("li").removeClass("active");$(Util.clearHtml(b)).prependTo(n);J(a,!0);m.show("max")}).fail(function(){mini.alert("E\u8baf\u6253\u5f00\u5931\u8d25\uff01")})};this.open=function(a){a==eMsgSocket.uid?mini.alert("\u65e0\u6cd5\u548c\u81ea\u5df1\u804a\u5929\uff01"):Util.ajax({url:EmsgConfig.baseUrl,data:{query:"opensession",userid:a},success:function(b){1==b.success?m.openSession(b.sessionid,a,"friend"):mini.alert("E\u8baf\u6253\u5f00\u5931\u8d25\uff01")},error:function(a){mini.alert("E\u8baf\u6253\u5f00\u5931\u8d25\uff01")}})};this.show=function(a){var b=$(".emsg-dialog-min",f);if(a&&"max"!==a)k.blur(),C.hide(),c.html($(this).data("origname")).show(),f.data("offset",f.offset()),f.draggable("disable"),f.effect("size",{to:{width:250,height:42}},300,function(){$(this).addClass("min")}).effect("transfer",{to:".emsg-mindialog",className:"emsg-dialog-transfer"},500,function(){$(this).css({left:"",top:""}).addClass("bottom")}),l="min",b.addClass("max").attr("title","\u6700\u5927\u5316");else{if(l==a)return;f.draggable("enable");$(".emsg-not-read",t).remove();var e,g;(g=f.data("offset"))?(e=g.top,g=g.left):(e=($(window).height()-540)/2,g=($(window).width()-800)/2);0>e&&(e=0);0>g&&(g=0);f.removeClass("bottom min").css({left:g,top:e,width:800,height:540,"font-size":"inherit"});f.show();l="max";b.removeClass("max").attr("title","\u6700\u5c0f\u5316");Q(k[0]);"max"===a&&(a=B(d.sessionId),r.scrollTop(a.prop("scrollHeight")))}f.css("z-index",Util.getZIndex())};this.receiveMessage=function(a){var b=a.sessionid,c=a.type;if(R(b)){var g=q[b];ga(g.sessionId);if("message"==c||"file"==c){var h={IsReceive:!0,imgUrl:g.imgUrl,content:a.content,time:a.time};"file"==c&&(c=v.render(F,{name:a.content,size:G(a.size)}),$.extend(h,{IsFile:!0,href:Util.getRightUrl(a.href),content:c}));if("group"==g.type){h.IsGroup=!0;var d;$.each(g.members,function(b,c){if(c.uid==a.from_uid)return d=c,!1});if(null==d){M(a.from_uid).done(function(a){h.imgUrl=a.imgUrl||EmsgConfig.userImg;h.name=a.name;H(b,h)});return}h.imgUrl=d.imgUrl;h.name=d.name}H(b,h)}else-1<$.inArray(c,["renamegroup","quitgroup","joingroup","receivedfile"])&&(ia(b,c,a),"receivedfile"!==c&&ha(b,a.groupid))}};this.init()}function EMsgGroupDialog(x){var u=$(".emsg-cgroup-layer"),m=$(".emsg-cgroup-dialog"),p=$(".emsg-cgroup-title",m),d=$(".emsg-cgroup-list",m);$(".emsg-cgroup-src",m);var q=$(".emsg-cgroup-filter",m),l,f=null,n=function(){m.draggable({handle:p,containment:"body",cursor:"move"});m.on("click",".emsg-cgroup-close",function(){0<$(".remove",d).length?mini.confirm("\u662f\u5426\u4fdd\u5b58\u4fee\u6539\uff1f","\u7cfb\u7edf\u63d0\u793a",function(c){"ok"==c?D():t()}):t()}).on("click",".emsg-btn-cancle",function(){t()}).on("click",".emsg-btn-ok",function(){D()});q.on("keyup",function(c){if(13==c.keyCode){var d=$(this).val();""==d?(l.clearFilter(),l.collapseAll()):(d=d.toLowerCase(),l.filter(function(c){if(-1!=(c.name?c.name.toLowerCase():"").indexOf(d))return!0}),l.expandAll())}});d.on("click",".remove",function(){$(this.parentNode).remove()});u.click(function(){m.addClass("zoom")});m.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(c){m.removeClass("zoom")})},w=function(){Util.ajax({url:EmsgConfig.treeUrl,dataType:"json",success:function(c){l.loadData(c)}})},r=function(c){var d=c.items;if(d){c=0;for(var f=d.length;c<f;c++)r(d[c])}else k(c)},k=function(c){0===d.find('li[uid\x3d"'+c.guid+'"]').length&&y(c.guid,c.name,!0)},y=function(c,f,n){c=$("\x3cli uid\x3d'"+c+"' class\x3d'emsg-cgroup-item'\x3e\x3cspan class\x3d'name'\x3e"+f+"\x3c/span\x3e\x3c/li\x3e");n&&c.append("\x3ci title\x3d'\u5220\u9664' class\x3d'remove'\x3e\u00d7\x3c/i\x3e");d.append(c)},z=function(c){$.isArray(c)?$.each(c,function(c,d){y(d.uid,d.name)}):Util.ajax({url:EmsgConfig.baseUrl,data:{query:"getgroupinfo",uid:f},success:function(c){$.each(c.members,function(c,d){y(d.uid,d.name,!(d.uid===x||d.uid===window._userGuid_))})}})},t=function(){m.hide();u.hide();l.uncheckAllNodes();l.collapseAll();d.empty();f=null},D=function(){var c=$("li",d),n=[],k="",l="";c.each(function(c,d){n.push($(this).attr("uid"));l=$(this).find("span").text();10>k.length&&10>k.length+l.length&&(k+=l+"\u3001")});k=""==k?c.eq(0).find("span").text():k.substr(0,k.length-1);if(2>=n.length)return mini.showTips({content:"\u8bf7\u9009\u62e9\u8ba8\u8bba\u7ec4\u6210\u5458\uff01",state:"danger",x:"center",y:"center",timeout:1E3}),!1;c={query:"creategroup",memberids:n.join(";")};f?(c.groupid=f,c.query="editgroup"):c.groupname=k;Util.ajax({url:EmsgConfig.baseUrl,data:c,success:function(c){1==c.success&&c.sessionid&&eMsg.openSession(c.sessionid,c.groupid,"group");t()},error:function(){t();mini.alert("\u8ba8\u8bba\u7ec4\u7f16\u8f91\u5931\u8d25\uff01")}})};this.createGroup=function(c){var d="\u521b\u5efa\u8ba8\u8bba\u7ec4";f&&(d="\u7f16\u8f91\u8ba8\u8bba\u7ec4");p.html(d);q.val("");var d=($(window).height()-400)/2,n=($(window).width()-500)/2;m.css({left:n,top:d,"z-index":Util.getZIndex()}).show();u.show();w();z(c)};this.editGroup=function(c){f=c;this.createGroup()};(function(){l=new mini.Tree;l.set({idField:"guid",textField:"name",nodesField:"items",autoLoad:!0,resultAsTree:!0});l.on("drawnode",function(c){!0!==!c.node.items&&(c.nodeHtml="\x3cspan class\x3d'mini-tree-nodetext'\x3e"+c.node.name+"\x3c/span\x3e\x3ci class\x3d'emsg-cgroup-additem' title\x3d'\u6dfb\u52a0'\x3e\x3c/i\x3e")}).on("nodeclick",function(c){var d=c.node,f=d.items;$(c.htmlEvent.target).hasClass("emsg-cgroup-additem")?f&&r(d):f&&f.length?l.isExpandedNode(d)?l.collapseNode(d):l.expandNode(d):k(d)});l.render(document.getElementById("emsg_group"));w();n()})()}function EMsgSocket(x,u,m){function p(d){eMsg&&eMsg.receiveMessage(d);eMsg&&"max"==eMsg.status()||"message"!=d.type&&"file"!=d.type||l(d);-1<$.inArray(d.type,["message","creategroup","joingroup"])&&RefreshEMsg()}this.uid=x;this.uname=u;var d=m.subSocket;this.sendMessage=function(f){if(!d.request.isOpen)return mini.showTips({content:"E\u8baf\u5df2\u65ad\u5f00\u8fde\u63a5\uff0c\u65e0\u6cd5\u53d1\u9001\u6d88\u606f\uff01",state:"danger",x:"center",y:"center",timeout:2E3}),!1;d.push(f);return!0};this.isConnect=function(){return d.request.isOpen};this.close=function(){atmosphere.unsubscribe()};var q={},l=function(d){var l=d.sessiontype,n;n="friend"==l?{query:"getuserinfo",uid:d.from_uid}:{query:"getgroupinfo",uid:d.sessionid};if("undefined"==typeof q[n.uid])Util.ajax({url:EmsgConfig.baseUrl,data:n}).done(function(k){k.imgUrl="friend"==l?k.imgUrl||EmsgConfig.userImg:EmsgConfig.groupImg;q[n.uid]=k;f(k.name,{body:d.content,icon:k.imgUrl})}).fail(function(){});else{var k=q[n.uid];f(k.name,{body:d.content,icon:k.imgUrl})}},f=function(d,f,l){var k;"string"==typeof f&&(f={body:f});if("Notification"in window)"granted"===Notification.permission?k=new Notification(d,f):"denied"!==Notification.permission&&Notification.requestPermission(function(l){"granted"===l&&(k=new Notification(d,f))});else return!1;setTimeout(function(){k.close()},l||3E3)};this.socketEvent=u=m.socketEvent;u.on("message",function(d){p(d.data)});u.on("file",function(d){p(d.data)});u.on("remotelogin",function(d){epoint.alert(d.data.message,"\u7cfb\u7edf\u63d0\u793a",function(d){if(UserConfig.onLogout)UserConfig.onLogout()})});u.on("config",function(d){EmsgConfig.showErrorMsg=d.data.showerrormsg});window.eMsg=new EMsgDialog(x)};