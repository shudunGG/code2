//EMsg交互
(function(e,b){function d(a){this.$content=b(a.content);this.getUrl=a.getUrl;this.ignoreUrl=a.ignoreUrl;this.userImg=a.userImg;this.groupImg=a.groupImg;this.onDecEmsgCount=a.onDecEmsgCount;this.afterOpenEMsg=a.afterOpenEMsg;this._bindEvent()}var f=Mustache,g=b.trim('{{#items}}\x3cli class\x3d"emsg-recent-item {{^hasRead}}newmsg{{/hasRead}}" data-sessionid\x3d"{{sessionId}}" data-uid\x3d"{{uid}}" data-type\x3d"{{type}}"\x3e\x3cdiv class\x3d"emsg-user-img"\x3e\x3cimg src\x3d"{{imgUrl}}" onerror\x3d"this.onerror\x3d\'\';this.src\x3d\'../../emsg/images/emsg-user-error.jpg\';" /\x3e\x3c/div\x3e\x3cdiv class\x3d"emsg-recent-record"\x3e\x3ch2\x3e\x3cspan class\x3d"emsg-user-name" title\x3d"{{name}}"\x3e{{name}}\x3c/span\x3e{{^hasRead}}\x3ci class\x3d"emsg-not-read"\x3e\x3c/i\x3e{{/hasRead}}\x3cspan class\x3d"emsg-recent-date"\x3e{{date}}\x3c/span\x3e\x3c/h2\x3e\x3cp class\x3d"emsg-recent-message"\x3e{{message}}\x3c/p\x3e{{^hasRead}} \x3cspan class\x3d"emsg-ignore-icon"\x3e\u5ffd\u7565\x3c/span\x3e{{/hasRead}}\x3c/div\x3e\x3c/li\x3e{{/items}}');d.prototype={_bindEvent:function(){var a=this;this.$content.on("click",".emsg-ignore-icon",function(c){c.stopPropagation();b(this).closest("div").find(".emsg-not-read").remove();c=b(this).closest("li").removeClass("newmsg").data("sessionid");a.ignoreMessage(c);a.onDecEmsgCount&&a.onDecEmsgCount();b(this).remove()}).on("click",".emsg-recent-item",function(c){c.stopPropagation(c);b(this).removeClass("newmsg");c=b(this).find(".emsg-not-read,.emsg-ignore-icon");var d=b(this).data("sessionid"),e=b(this).data("uid"),f=b(this).data("type");c.length&&(c.remove(),a.onDecEmsgCount&&a.onDecEmsgCount());OpenEMsg(d,e,f);a.afterOpenEMsg&&a.afterOpenEMsg()})},renderEmsgPanel:function(a){a&&a.sessionlist.length?(a=b.map(a.sessionlist,function(a,b){"friend"===a.type&&""===a.imgUrl&&(a.imgUrl=this.userImg);"group"===a.type&&(a.imgUrl=this.groupImg);a.message=a.message.replace(/<[^>]+>/g,"").replace(/&nbsp;/ig,"");return a}),a=f.render(g,{items:a}),b(Util.clearHtml(a)).appendTo(this.$content.empty().removeClass("empty"))):this.$content.empty().addClass("empty")},getData:function(){Util.ajax({url:this.getUrl,data:{query:"loadrecentsession"}}).done(b.proxy(this.renderEmsgPanel,this))},ignoreMessage:function(a){Util.ajax({url:this.ignoreUrl,data:{query:"ignoremessage",sessionid:a}})}};e.EMsgList=d})(this,jQuery);