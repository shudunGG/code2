/* jshint -W030 */
// 应用模板
var METRO_APP_TPL='\x3cdiv class\x3d"metro-app" data-id\x3d"{{id}}" title\x3d"{{name}}" style\x3d"top:{{top}}px;left:{{left}}px;width:{{width}}px;height:{{height}}px;"\x3e\x3cdiv class\x3d"app-inner" style\x3d"background-color:{{bgcolor}}"\x3e{{#innerUrl}}\x3ciframe src\x3d"{{innerUrl}}" frameborder\x3d"0" width\x3d"{{ifrWidth}}" height\x3d"{{ifrHeight}}" allowtransparency\x3d"true" class\x3d"app-iframe" scrolling\x3d"no"\x3e\x3c/iframe\x3e{{/innerUrl}}{{#icon}}\x3cimg src\x3d"{{icon}}" class\x3d"app-icon" alt\x3d""\x3e{{/icon}}\x3cp class\x3d"app-name"\x3e{{name}}\x3c/p\x3e{{#count}}\x3cspan class\x3d"unread"\x3e{{count}}\x3c/span\x3e{{/count}}\x3c/div\x3e\x3c/div\x3e',METRO_SCREEN_TPL='\x3cdiv class\x3d"screen-item l"\x3e\x3cdiv class\x3d"apps-wrap"\x3e\x3c/div\x3e\x3c/div\x3e',METRO_LEFTNAV_TPL='\x3cli class\x3d"left-nav-item page-item"\x3e\x3ca href\x3d"javascript:void(0);" class\x3d"left-nav-link " data-page\x3d"{{page}}"  data-index\x3d"{{screenIndex}}"  title\x3d"{{name}}"\x3e{{#icon}}\x3ci  class\x3d"left-nav-icon {{icon}}"  title\x3d"{{name}}"\x3e\x3c/i\x3e{{/icon}}\x3cspan class\x3d"left-nav-text"\x3e{{name}}\x3c/span\x3e\x3c/a\x3e\x3c/li\x3e',METRO_QUICK_MENU_TPL='\x3cli\x3e\x3ca href\x3d"javascript:void(0);" url\x3d"{{url}}" index\x3d"{{index}}"\x3e\x3ci class\x3d"{{icon}}"\x3e\x3c/i\x3e{{name}}\x3c/a\x3e\x3c/li\x3e',METRO_TASK_TPL='\x3ca href\x3d"javascript:void(0);" data-id\x3d"{{id}}" class\x3d"task-item l clearfix" title\x3d"{{name}}"\x3e\x3cp class\x3d"task-name"\x3e{{name}}\x3c/p\x3e\x3c/a\x3e';(function(g,a){EpDialog.setMaxCoord({top:50,left:0,right:0,bottom:40});a.extend(Util,{getZIndex:function(){return mini.getMaxZIndex()},sortArr:function(a,b){var d=Array.prototype.slice.call(a,0),g;b||(b="asc");"asc"==b?g=function(a,b){return a-b}:"desc"==b&&(g=function(a,b){return b-a});return d.sort(g)},fixPath:function(d){var b=a.extend({},d);b.url=Util.getRightUrl(d.url);b.icon&&(b.icon=Util.getRightUrl(d.icon));d.innerUrl&&(b.innerUrl=Util.getRightUrl(d.innerUrl));return b},highlightApp:function(a){var b=function(){a.animate({opacity:.3},200,g)},d=function(){a.animate({opacity:1},200,g)},g=function(){a.queue("highlight").length?a.dequeue("highlight"):a.clearQueue("highlight")};a.queue("highlight",[b,d,b,d,b,d,b,d]);g()},configAppCmOpers:function(a,b){!1!==b.uninstallable?a.enableItem("uninstall-app"):a.disableItem("uninstall-app");!1!==b.movable?a.enableItem("move-app"):a.disableItem("move-app");!1!==b.openable?a.enableItem("open-app"):a.disableItem("open-app")}})})(this,jQuery);(function(g,a){var d=a("#metro-screens"),b=a(".screen-list",d),f=a("#left-nav-list"),l=240*METRO_COLUMN_NUM,v=115*METRO_ROW_NUM,r=v/2,m=l/2,n=5,k=DEFAULT_ACTIVE_PAGE-1,e=Mustache,h=a.trim(METRO_SCREEN_TPL),p=a.trim(METRO_LEFTNAV_TPL),t=a.trim(METRO_APP_TPL),w,u=function(){var c=Util.getBdSize(),a={width:c.width-90,height:c.height};d.css(a);d.find(".screen-item").css(a);b.css("margin-top",-k*c.height)},x=function(c){a.each(c,function(c,a){C(c,a)})},B=function(c){var e={},b=c.index,d=240*c.colspan-6,f=115*c.rowspan-6,h=d-28,k=f-6-35,g=b%METRO_ROW_NUM*115,b=240*Util.toInt(b/METRO_ROW_NUM);a.extend(e,{width:d,height:f,ifrWidth:h,ifrHeight:k,top:g,left:b,bgcolor:c.bgcolor||"#2a6ebb"});return e},C=function(c,q){if(q&&q.screenApps){var d=b.find(".screen-item").eq(c),f=q.leftNav.screenIndex,h=[];a.each(q.screenApps,function(q,b){b=Util.fixPath(b);b.page=c;b.screenIndex=f;h.push(e.render(t,a.extend({},b,B(b))));AppMgr.cacheAppData(b.id,b)});d.find(".apps-wrap").html(h.join(""))}},z=[],D=function(){var c=a("#left-nav-wrap"),e=c.find(".left-scroll-up"),b=c.find(".left-scroll-down"),d=f.height(),h=c.height()-60,k=d-h,p,l=0;a(window).on("resize",function(){h=c.height()-60;k=d-h;m();r();t()});var m=function(){h<d?(e.removeClass("invisible"),b.removeClass("invisible")):(e.addClass("invisible"),b.addClass("invisible"))};m();var t=function(){Math.abs(l)>Math.abs(k)&&f.stop(!0).animate({marginTop:-k},300,function(){l=Math.ceil(parseFloat(f.css("margin-top"),10))})},r=function(){if(!b.hasClass("invisible")){var c=MetroScreen.getActiveNavItem(),a=c.outerHeight(),c=c.prevAll().length*a,e=Math.ceil(Math.abs(parseFloat(f.css("margin-top"),10))),q=e;c<e?q=c:c>=h+e?q=c+a-h:c>e&&c<h+e&&c+a>h+e&&(q=c+a-h);f.stop(!0).animate({marginTop:-q},300,function(){l=Math.ceil(parseFloat(f.css("margin-top"),10))})}};g.adjustActiveVisibile=r;var n=function(){p=setInterval(function(){Math.abs(l)>=k?clearInterval(p):f.animate({marginTop:"-\x3d1px"},10,function(){l=Math.ceil(parseFloat(f.css("margin-top"),10))})},20)},u=function(){p=setInterval(function(){0<=l?clearInterval(p):f.animate({marginTop:"+\x3d1px"},10,function(){l=Math.ceil(parseFloat(f.css("margin-top"),10))})},20)};b.on("mouseenter mouseleave",function(c){b.hasClass("invisible")||("mouseenter"===c.type?n():(f.stop(!0),clearInterval(p)))});e.on("mouseenter mouseleave",function(c){e.hasClass("invisible")||("mouseenter"===c.type?u():(f.stop(!0),clearInterval(p)))})},A=function(c){var a=c;0>c?a=0:c>=n&&(a=n-1);return a};a(document).on("keydown",function(c){c=c.which;var a;38==c?a=k-1:40==c&&(a=k+1);void 0!==a&&(a=A(a),MetroScreen.setPageActive(a),adjustActiveVisibile())});f.on("click",".left-nav-link",function(c){c.preventDefault();c=a(this).data("page");MetroScreen.setPageActive(c);adjustActiveVisibile()});Util.loadJs(Util.getRightUrl("fui/js/lib/jquery.mousewheel.min.js"),function(){var c;d.on("mousewheel",function(a){console.log(a.deltaX,a.deltaY,a.deltaFactor);c&&clearTimeout(c);c=setTimeout(function(){var c;0>a.deltaY?c=k+1:0<a.deltaY&&(c=k-1);void 0!==c&&(c=A(c),MetroScreen.setPageActive(c),adjustActiveVisibile())},200)})});g.MetroScreen={setPageActive:function(c){c=A(c);var e=a("body").height(),h=f.find(".page-item").eq(c);h.hasClass("active")||(b.stop(!0).animate({marginTop:-c*e},300),h.addClass("active").siblings().removeClass("active"),appContextmenu&&w.enableItem("page-"+k).disableItem("page-"+c),k=c)},getActivePage:function(){return k},getActiveNavItem:function(){return f.find(".page-item").eq(k)},getScreen:function(c){return b.find(".screen-item").eq(c)},getApp:function(c){return d.find('[data-id\x3d"'+c+'"]')},addApp:function(c,q){var h=b.find(".screen-item").eq(q),d=a(e.render(t,a.extend({},c,B(c))));d.appendTo(h.find(".apps-wrap"));AppDragMgr.enableApp(d);c.page=q;c.screenIndex=z[q].screenIndex;AppMgr.cacheAppData(c.id,c);Util.highlightApp(d)},removeApp:function(c){var a=this.getApp(c);AppDragMgr.destroy(a);a.fadeOut(200,function(){a.remove()})},getOccupiedGrids:function(c){var e=[];c=this.getScreen(c).find(".metro-app");a.each(c,function(c,b){var h=a(b),d=h.data("id");h.hasClass("ignored")||(e=e.concat(MetroScreen.getAppOccupiedGrids(d)))});2<=e.length&&(e=Util.sortArr(e));return Array.prototype.slice.call(e,0)},getAppOccupiedGrids:function(c){var e=a.isPlainObject(c)?c:AppMgr.getAppData(c);c=[];var b=e.rowspan,h=e.colspan,e=e.index,d=0,f,k;if(1==h&&1==b)c.push(e);else for(;d<b;d++)for(k=e+d,c.push(k),f=1;f<h;f++)c.push(k+f*METRO_ROW_NUM);2<=c.length&&(c=Util.sortArr(c));return Array.prototype.slice.call(c,0)},getAppByIndex:function(c,e){var b=!1;this.getScreen(c).find(".metro-app").each(function(c,h){var d=a(h).data("id");if(AppMgr.getAppData(d).index==e)return b=a(h),!1});return b},getAppIndexByPos:function(c){var a;c.left>240*(METRO_COLUMN_NUM-1)+120||c.top>115*(METRO_ROW_NUM-1)+57.5?a=-1:(a=(0>c.left?0:c.left)/240,c=(0>c.top?0:c.top)/115,a=Math.round(a)*METRO_ROW_NUM+Math.round(c));return a},adjustAppPosByIndex:function(c,a){var e=c.data("id"),b=AppMgr.getAppData(e),h;h=Util.toInt(a/METRO_ROW_NUM);var d=Util.toInt(a%METRO_ROW_NUM);h={left:240*h,top:115*d};c.stop(!0).animate(h,200);b.index!=a&&(b.index=a,AppMgr.cacheAppData(e,b),AppMgr.sendAppUpdate(e,"update-app-index"))},isOneBlock:function(c){var a=c.index;c=c.rowspan;for(var e=Util.toInt(a/METRO_ROW_NUM),b=1;b<c;b++)if(Util.toInt((a+b)/METRO_ROW_NUM)!=e)return!1;return!0},getEmptyGrids:function(c){var e=METRO_COLUMN_NUM*METRO_ROW_NUM;c=MetroScreen.getOccupiedGrids(c);for(var b=[],h=0;h<e;h++)-1==a.inArray(h,c)&&b.push(h);return Array.prototype.slice.call(b,0)},getInsertIndex:function(c,e){var b=c.rowspan,h=c.colspan,d=MetroScreen.getEmptyGrids(e),f=0,k=!0,g,q,p;q=d.length;p=b*h;if(!q||p>q)f=-1;else if(1==b&&1==h)f=d[0];else{for(h=0;h<q;h++)if(k=!0,c.index=d[h],MetroScreen.isOneBlock(c)){b=MetroScreen.getAppOccupiedGrids(c);for(g=0;g<p;g++)if(-1==a.inArray(b[g],d)){k=!1;break}if(k){f=c.index;break}}k||-1==f}return f}};var E=function(){var c=[],a,e=[],b=function(c,a){AppMgr.moveToScreen(c.id,a.page)};c.push({text:"\u6253\u5f00\u5e94\u7528",role:"open-app",click:function(c){AppMgr.openApp(c.id)}});c.push("sep");for(a=1;a<=n;a++)e.push({text:z[a-1].name,role:"page-"+(a-1),page:a-1,click:b});c.push({text:"\u79fb\u52a8\u5e94\u7528\u5230",role:"move-app",items:e});c.push({text:"\u5378\u8f7d\u5e94\u7528",role:"uninstall-app",click:function(c){mini.confirm("\u60a8\u786e\u5b9a\u5378\u8f7d\u8be5\u5e94\u7528\u5417\uff1f\u5378\u8f7d\u540e\u53ef\u4ece\u5e94\u7528\u4ed3\u5e93\u4e2d\u518d\u6b21\u6dfb\u52a0\u5230\u684c\u9762\u3002","\u7cfb\u7edf\u63d0\u793a",function(a){"ok"==a&&AppMgr.uninstallApp(c.id)})}});return new EpContextMenu({items:c})},y={};g.sss=y;g.AppMgr={cacheAppData:function(c,e){y[c]=a.extend({},e)},getAppData:function(c){return(c=y[c])?a.extend({},c):!1},delAppData:function(c){y[c]=null},openApp:function(c){var a=AppMgr.getAppData(c);a.isBlank?g.open(a.url):TaskBar.addOrActiveTask(c)},installApp:function(c){var a=MetroScreen.getActivePage();c=Util.fixPath(c);c.index=MetroScreen.getInsertIndex(c,a);if(-1==c.index)return epoint.alert("\u5f88\u62b1\u6b49\uff0c\u5f53\u524d\u9875\u6ca1\u6709\u8db3\u591f\u7684\u7a7a\u95f4\u5b89\u88c5\u8be5\u5e94\u7528\uff0c\u60a8\u53ef\u4ee5\u9009\u62e9\u5176\u4ed6\u5206\u5c4f\u6216\u8005\u8c03\u6574\u5e94\u7528\u5e03\u5c40\u540e\u518d\u5b89\u88c5\u3002","\u7cfb\u7edf\u63d0\u793a"),!1;MetroScreen.addApp(c,a);epoint.alert("\u5e94\u7528\u3010"+c.name+"\u3011\u5b89\u88c5\u6210\u529f\uff01","\u7cfb\u7edf\u63d0\u793a");AppMgr.sendAppUpdate(c,"install-app")},moveToScreen:function(c,a){var e=AppMgr.getAppData(c),b=MetroScreen.getInsertIndex(e,a);-1==b?epoint.alert("\u5f88\u62b1\u6b49\uff0c\u7b2c"+(a+1)+"\u5206\u5c4f\u6ca1\u6709\u8db3\u591f\u7684\u7a7a\u95f4\uff0c\u60a8\u53ef\u4ee5\u9009\u62e9\u5176\u4ed6\u5206\u5c4f\u6216\u8005\u8c03\u6574\u5e94\u7528\u5e03\u5c40\u540e\u518d\u79fb\u52a8\u3002","\u7cfb\u7edf\u63d0\u793a"):(e.index=b,MetroScreen.removeApp(c),MetroScreen.addApp(e,a),AppMgr.sendAppUpdate(c,"screen-to-screen"))},uninstallApp:function(a){TaskBar.removeTask(a);MetroScreen.removeApp(a);AppMgr.sendAppUpdate(a,"uninstall-app");AppMgr.delAppData(a)},updateAppReminder:function(c){Util.ajax({type:"POST",dataType:"json",url:g.updateAppUrl,data:{query:"update-app-reminder",id:c},success:function(e){e=e.count;var b=MetroScreen.getApp(c).find(".app-inner"),h=b.find(".unread");0>=e?h.remove():(h.length||(h=a('\x3cspan class\x3d"unread"\x3e\x3c/span\x3e'),h.appendTo(b)),h.html(99<=e?99:e))},error:Util._ajaxErr})},sendAppUpdate:function(c,e){var b=a.isPlainObject(c)?c:AppMgr.getAppData(c),b=a.extend({},b,{query:e});Util.ajax({type:"POST",url:g.updateAppUrl,dataType:"json",data:b,success:Util.noop,error:Util._ajaxErr})}};d.on("click",".metro-app",function(c){c=a(this).data("id");AppMgr.openApp(c)});if(appContextmenu)d.on("contextmenu",".metro-app",function(c){var e=a(this).data("id"),b=AppMgr.getAppData(e);w.setOptions("id",e).show({x:c.pageX,y:c.pageY});Util.configAppCmOpers(w,b);return!1});a(g).on("resize",u);(function(){Util.ajax({type:"POST",dataType:"json",url:g.screenInfoUrl,data:{query:"screen-apps"},success:function(a){if(a&&a.length){for(var c=[],d=a.length,g=0;g<d;g++)c.push(h);b.html(c.join(""));b.find(".apps-wrap").css({marginTop:-r,marginLeft:-m,width:l,height:v});for(var c=a.length,g=[],t=0;t<c;t++)d=a[t].leftNav||{},z.push(d),g.push(e.render(p,{page:t,name:d.name,icon:d.icon,screenIndex:d.screenIndex}));f.html(g.join(""));n=c;x(a);appContextmenu&&(w=E());AppDragMgr.enableAllApps();u();MetroScreen.setPageActive(k);D()}},error:Util._ajaxErr})})()})(this,jQuery);(function(g,a){var d=a("#metro-screens"),b={containment:"body",scroll:!1,opacity:.5,distance:10,iframeFix:!0,start:function(b,d){a(this).addClass("app-drag-zindex")},stop:function(b,d){var f=a(this),g=f.data("id"),l=AppMgr.getAppData(g),n=l.index,k=MetroScreen.getAppIndexByPos(d.position),e=[],h=[],p=[],t=[],w=[],u=[],e=!1,x=MetroScreen.getActivePage();l.index=k;-1==k?e=!1:MetroScreen.isOneBlock(l)?(e=MetroScreen.getAppOccupiedGrids(l),h=MetroScreen.getAppOccupiedGrids(a.extend({},l,{index:n})),w=MetroScreen.getEmptyGrids(x),a.each(e,function(a,e){var b=MetroScreen.getAppByIndex(x,e);b&&b.data("id")!=g&&p.push(b.addClass("ignored"))}),p.length&&a.each(p,function(a,e){var b=e.data("id");t=t.concat(MetroScreen.getAppOccupiedGrids(b))}),a.each(e,function(e,b){-1==a.inArray(b,w)&&-1==a.inArray(b,h)||u.push(b)}),u=Util.sortArr(u.concat(t)),e=u[0]==e[0]&&u[u.length]==e[e.length]&&u.length==e.length):e=!1;e||(k=n);MetroScreen.adjustAppPosByIndex(f,k);p.length&&(e?a.each(p,function(a,e){var b=e.data("id"),b=AppMgr.getAppData(b),b=MetroScreen.getInsertIndex(b,x);MetroScreen.adjustAppPosByIndex(e.removeClass("ignored"),b)}):a.each(p,function(a,e){e.removeClass("ignored")}));f.removeClass("app-drag-zindex")}};g.AppDragMgr={enableAllApps:function(){d.find(".metro-app").draggable(b)},enableApp:function(a){a.draggable(b)},destroy:function(a){a.draggable("destroy")}}})(this,jQuery);(function(g,a){var d=a("#metro-quick-menu-trigger"),b=d.next(),f=b.find("\x3eul"),l=a("body");l.on("click",function(f){f=f.target;!a.contains(b[0],f)&&d.hasClass("active")&&f!==d[0]&&n()});var v=Mustache,r=a.trim(METRO_QUICK_MENU_TPL),m;Util.ajax({type:"POST",dataType:"json",url:g.quickMenuUrl,data:{query:"quick-menu"},success:function(d){var e=[];d.length&&(f[0].innerHTML="",a.each(d,function(b,d){d.index=b;e.push(v.render(r,d));d=Util.fixPath(d);AppMgr.cacheAppData("quick-menu-item-"+b,a.extend(d,{id:"quick-menu-item-"+b}))}),f[0].innerHTML=e.join(""));m=b.outerHeight();b.css("bottom",-m).addClass("hidden").removeClass("hidden-accessible")},error:Util._ajaxErr});var n=function(){b.is(":animated")||(b.animate({bottom:-m},300,function(){b.addClass("hidden")}),d.removeClass("active"))};l.on("click",".metro-quick-menu-trigger",function(a){a.preventDefault();d.hasClass("active")?n():b.is(":animated")||(b.removeClass("hidden"),b.animate({bottom:40},300),d.addClass("active"))});b.on("click","a",function(a){a.preventDefault();a=parseInt(this.getAttribute("index"),10);TaskBar.addOrActiveTask("quick-menu-item-"+a);n()})})(this,jQuery);(function(g,a){var d=a("#metro-task-bar"),b=a(".tasks-wrap",d),f=a(".task-list",d),l=d.find(".scroll-wrap"),v=Mustache,r=a.trim(METRO_TASK_TPL),m=function(){var e=a("body").width()-100-130;b.css("width",e);114*f.find(".task-item").length>e?l.removeClass("hidden"):(l.addClass("hidden"),f.css("margin-left",0))},n=new EpContextMenu({items:[{text:"\u663e\u793a\u684c\u9762",click:function(a){TaskBar.minAllTasks()}},"sep",{text:"\u5173\u95ed\u6b64\u4efb\u52a1",click:function(a){TaskBar.removeTask(a.id)}},{text:"\u53ea\u663e\u793a\u6b64\u4efb\u52a1\u7a97\u53e3",click:function(a){TaskBar.minAllTasks(a.id)}},"sep",{text:"\u5173\u95ed\u5176\u4ed6\u4efb\u52a1",click:function(a){TaskBar.removeOthers(a.id)}},{text:"\u5173\u95ed\u6240\u6709\u4efb\u52a1",click:function(){TaskBar.removeAll()}},"sep",{text:"\u53d6\u6d88",role:"cancel"}]}),k={};g.TaskBar={openTask:function(a){var e=AppMgr.getAppData(a),b=null,b=Util.getBdSize();k[a]?(b=k[a],b.show(0,0)):(b=(new EpDialog({id:a+"-epdialog",title:e.name,url:e.url,draggable:!0,resizable:!0,width:(e.widthRatio||DIALOG_SIZE_RATIO[0])*b.width,height:(e.heightRatio||DIALOG_SIZE_RATIO[1])*b.height,btns:[{role:"min",title:"\u6700\u5c0f\u5316",click:function(){this.hide()}},{role:"maxwin",title:"\u6700\u5927\u5316"},{role:"refresh",title:"\u5237\u65b0"},{role:"close",title:"\u5173\u95ed",click:function(a){TaskBar.removeTask(a.id);return!1}}]})).setOptions("id",a),e.isFullView?b.show(0,0).maxWin():b.show(0,1),k[a]=b)},minAllTasks:function(a){var b,e;for(b in k)k.hasOwnProperty(b)&&(e=k[b],b!=a?e.hide():(e.show(0,0),TaskBar.activeTask(b)))},addOrActiveTask:function(b){var e=k[b],d=AppMgr.getAppData(b);e||(a(v.render(r,{id:d.id,name:d.name})).appendTo(f),m());TaskBar.openTask(b);TaskBar.activeTask(b)},makeTaskVisiable:function(a){a=114*TaskBar.getTask(a).prevAll().length;var e=Math.abs(Util.toInt(f.css("margin-left"))),d=b.width(),g=0;a<e?g=a:a+114-d>e&&(g=a+114-d);g&&f.stop(!0).animate({marginLeft:-g},300)},getTask:function(a){return f.find('[data-id\x3d"'+a+'"]')},removeTask:function(a){var b=TaskBar.getTask(a);b.length&&(b.remove(),k[a].hide().destroy(),k[a]=null,delete k[a],m())},removeOthers:function(b){var e=f.find(".task-item");e.length&&(e.each(function(e,d){var h=a(d),f=h.data("id");b!=f&&(h.remove(),k[f].hide().destroy(),k[f]=null,delete k[f])}),m())},removeAll:function(){var b=f.find(".task-item");b.length&&(b.each(function(b,e){var d=a(e),h=d.data("id");d.remove();k[h].hide().destroy();k[h]=null;delete k[h]}),m())},activeTask:function(a){var b=TaskBar.getTask(a);b.hasClass("active")||b.addClass("active").siblings().removeClass("active");TaskBar.makeTaskVisiable(a)}};a(g).on("resize",m).on("resize",function(){var a,b;for(a in k)k.hasOwnProperty(a)&&(b=k[a])&&!b.isHidden()&&b.isMax()&&b.maxWin()});d.on("click",".scroll-l",function(a){a=Math.abs(Util.toInt(f.css("margin-left")));var b=a-200;a&&(0>b&&(b=0),f.stop(!0).animate({marginLeft:-b},200))}).on("click",".scroll-r",function(a){a=Math.abs(Util.toInt(f.css("margin-left")));var e=114*f.find(".task-item").length,d=b.width(),g=e-d;dis=a+200;a!=e-d&&(dis>g&&(dis=g),f.stop(!0).animate({marginLeft:-dis},300))}).on("click",".task-item",function(b){b=a(this);var e=b.data("id"),e=k[e];b.hasClass("active")?e.toggle():(b.addClass("active").siblings().removeClass("active"),e.show(0,0))}).on("contextmenu",".task-item",function(b){var e=a(this).data("id");n.setOptions("id",e).show({x:b.pageX,y:b.pageY});return!1});a("body").on("click",".epdialog-hd",function(b){b.preventDefault();b.stopPropagation();/^epdialog-hd(?!-btn)/.test(b.target.className)&&(b=a(this).parent(".epdialog")[0].id.replace(/(.+)-epdialog$/,"$1"))&&TaskBar.addOrActiveTask(b)});m();g.TabsNav={addTab:function(a){var b=a.id;AppMgr.getAppData(b)||AppMgr.cacheAppData(b,{name:a.name,id:b,url:a.url});TaskBar.addOrActiveTask(b)},refreshTabContent:function(a){(a=k[a])&&a.refresh&&a.refresh()}}})(this,jQuery);(function(g,a){a("#metro-top-bar .top-btns").on("click",".logout",function(a){a.preventDefault();mini.confirm("\u60a8\u786e\u5b9a\u8981\u9000\u51fa\u7cfb\u7edf\u5417\uff1f","\u7cfb\u7edf\u63d0\u793a",function(a){"ok"==a&&g.onLogout&&(eWebSocket&&eWebSocket.close(),g.onLogout())})})})(this,jQuery);(function(g,a){var d=a("#metro-top-bar .online"),b=function(){Util.ajax({type:"POST",dataType:"json",url:g.onlineUserCountUrl,data:{query:"online-user-count"},success:function(a){d.attr("title","\u5728\u7ebf"+a.count+"\u4eba")},error:Util._ajaxErr})};b();setInterval(b,6E4)})(this,jQuery);(function(g,a){var d=a("#msg-sound"),b,f;Util.browsers.isIE?b=a('\x3ciframe src\x3d"" frameborder\x3d"0" class\x3d"hidden" id\x3d"msgcenter-sound"\x3e\x3c/iframe\x3e').appendTo(d):(d.html('\x3caudio id\x3d"msgcenter-sound-audio" controls\x3d"controls" src\x3d"../../msgsound/newsms.wav" class\x3d"hidden-accessible"\x3e\x3c/audio\x3e'),f=document.getElementById("msgcenter-sound-audio"));var l=a("#metro-top-bar .message"),v=document.title,r="\u60a8\u6709\u65b0\u6d88\u606f\u63d0\u9192\uff0c\u8bf7\u70b9\u51fb\u67e5\u770b\uff01",m=0,n=function(){document.title=r;clearTimeout(m);m=setTimeout(function h(){document.title=r.substring(1,r.length)+r.substring(0,1);r=document.title;m=setTimeout(h,300)},300)},k=function(){Util.ajax({type:"POST",url:g.msgCountUrl,dataType:"json",global:!1,data:{haseXun:!0,needNum:!0},success:function(a){a.remind?(d.hasClass("triggered")||(Util.browsers.isIE?b[0].src=Util.getRightUrl("../../msgsound/sound.html")+"?timestamp\x3d"+ +new Date:f.play(),d.addClass("triggered")),l.removeClass("message").addClass("message-new"),n()):(Util.browsers.isIE&&(b[0].src=""),l.removeClass("message-new").addClass("message"),d.removeClass("triggered"),clearTimeout(m),document.title=v,r="\u60a8\u6709\u65b0\u6d88\u606f\u63d0\u9192\uff0c\u8bf7\u70b9\u51fb\u67e5\u770b\uff01");updateEmsgCount(parseInt(a.eXun)||0)},error:Util.noop,complete:Util.noop})};k();setInterval(k,6E4)})(this,jQuery);(function(g,a){Util.ajax({url:g.getMsgAppUrl,data:{query:"get-msg-app-url"}}).done(function(b){b&&b.url&&a.each(g.defaultApps,function(a,d){if("sys-msg-reminder"===d.id)return d.url=b.url,!1});d()}).fail(function(a){console&&console.error&&console.error(a);d()});var d=function(){var b=a("#metro-top-bar .top-btns");a.each(g.defaultApps,function(a,b){b=Util.fixPath(b);AppMgr.cacheAppData(b.id,b)});b.on("click",".default-app-btn",function(b){b.preventDefault();b=a(this).data("id");AppMgr.openApp(b)})}})(this,jQuery);(function(g,a){var d=a("#user-info");(function(){Util.ajax({type:"POST",dataType:"json",url:g.userInfoUrl,data:{query:"user-info"},success:function(a){d.html(a.userName+"\uff08"+a.ouName+"\uff09");g._userName_=a.userName;g._userGuid_=a.userGuid},error:Util._ajaxErr})})()})(this,jQuery);window.eWebSocket=void 0;window.creatWebSocket=function(g,a,d){if(eWebSocket)d&&d();else{var b=window.EWebSocketConfig?window.EWebSocketConfig:{url:EmsgConfig.websocketUrl};b.uid=g;b.uname=a;window.EWebSocket?(eWebSocket=new EWebSocket(b),d&&d()):Util.loadJs("fui/pages/ewebsocket/ewebsocket.js",function(){eWebSocket=new EWebSocket(b);d&&d()})}};window.OpenEMsg=function(g,a,d){window.eMsg?"undefined"===typeof a?eMsg.open(g):eMsg.openSession(g,a,d):creatWebSocket(_userGuid_,_userName_,function(){eWebSocket.openEmsg(g,a,d)})};(function(g,a){function d(){b=new ThemeSelection({getThemesUrl:getThemesUrl,saveThemeUrl:saveThemeUrl});window.themeSelection=b;f.on("click",function(){f.hasClass("active")?(f.removeClass("active"),b.hide()):b.show()})}var b,f=a("#theme-btn");window.ThemeSelection?d():Util.loadJs("fui/pages/themeselection/themeselection.js",d);a("body").on("click",function(d){d=a(d.target);a.contains(b.$container[0],d[0])||d.closest("#theme-btn").length||b.hide()})})(this,jQuery);(function(g,a){function d(){m=new EMsgList({content:r,getUrl:EmsgConfig.baseUrl,ignoreUrl:EmsgConfig.baseUrl,userImg:EmsgConfig.userImg,groupImg:EmsgConfig.groupImg,afterOpenEMsg:function(){b()},onDecEmsgCount:n});g.RefreshEMsg=a.proxy(m.getData,m)}function b(){f.removeClass("active");l.stop(!0).animate({right:-350},function(){l.addClass("hidden")})}var f=a("#msgTrigger"),l=a("#msgEMsg"),v=a(".msg-panel-content",l),r=a(".emsg-recent-list",v),m,n=function(){var a=f.data("num")||0;a&&(a=parseInt(a,10)-1);k(a)},k=function(a){0>=a?f.data("num",0).removeClass("new-msg"):f.data("num",a).addClass("new-msg")};g.EMsgList?d():Util.loadJs("../../emsglist/emsglist.js",function(){d()});f.on("click",function(){a(this).hasClass("active")?b():(m.getData(),f.addClass("active"),l.removeClass("hidden"),l.stop(!0).animate({right:0}))});l.on("click",".msg-panel-hide",function(){b()});a("body").on("click",function(d){a(d.target).closest("#msgEMsg , #msgTrigger").length||b()});g.updateEmsgCount=k})(this,jQuery);