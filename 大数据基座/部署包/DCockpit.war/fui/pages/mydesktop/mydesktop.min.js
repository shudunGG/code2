// 元件模板
var WIDGET_TPL='\x3cli class\x3d"widget gs-w" data-id\x3d"{{code}}" data-view\x3d"{{view}}"\x3e\x3ciframe src\x3d"" data-src\x3d"{{url}}" frameborder\x3d"0" width\x3d"100%" height\x3d"100%" scrolling\x3d"no"\x3e\x3c/iframe\x3e\x3cdiv class\x3d"widget-cover trans hidden"\x3e\x3cdiv class\x3d"widget-sz-opts"\x3e{{#btns}}\x3cspan class\x3d"widget-sz-btn {{cls}}" data-view\x3d"{{view}}" title\x3d"{{title}}"\x3e\x3c/span\x3e{{/btns}}\x3c/div\x3e\x3c/div\x3e\x3c/li\x3e';(function(t,f){var q=function(){var a=130,b=f(t).width();1366<b&&(a*=b/1200);return[a,130]}(),h=["small","medium","large"],u=Mustache,v=WIDGET_TPL,l=f("#my-desktop ul");l.css("min-width",8*(q[0]+20));var k=l.gridster({widget_margins:[10,10],widget_base_dimensions:q,extra_cols:4,max_cols:8,draggable:{start:function(a,b){b.$player.find(".widget-sz-opts").addClass("hidden")},stop:function(a,b){b.$player.find(".widget-sz-opts").removeClass("hidden")}},serialize_params:function(a,b){return{code:a.data("id"),col:b.col,row:b.row,view:a.data("view")}}}).data("gridster"),r=function(a){var b={};switch(a){case h[0]:b.x=1;b.y=1;break;case h[1]:b.x=2;b.y=2;break;case h[2]:b.x=4,b.y=2}return b},w=function(a,b,d){var c={},e=[];a=h[a];e.push(a);d==a&&e.push("active");b?b="\u5207\u6362\u5230"+a+"\u89c6\u56fe":(e.push("disabled"),b="\u8be5\u7ec4\u4ef6\u672a\u914d\u7f6e"+a+"\u89c6\u56fe");c.title=b;c.view=a;c.cls=e.join(" ");return c},x=function(a){var b={};f.extend(b,{code:a.code,view:a.view,url:m.getWidgetViewUrl(a.code,a.view),btns:function(){for(var b=[],c=0,e=a.urls.length;c<e;c++)b.push(w(c,a.urls[c],a.view));return b}()});return b},m={_cache:{},cacheWidgetData:function(a){this._cache[a.code]=a},getWidgetViewUrl:function(a,b){var d=this._cache[a],c="",e=f.inArray(b,h);-1!==e&&(c=d.urls[e]);return c}},n=null,y=function(){var a=0,b=f(".widget \x3e iframe"),d=b.length;setTimeout(function e(){b[a].src=Util.getRightUrl(b.eq(a).data("src"));a++;a!=d&&setTimeout(e,120)},120)},z=function(a){var b=[],d;if(a&&a.length){for(var c=0,e=a.length;c<e;c++)if(d=a[c],!d.col&&0!==d.col||!d.row&&0!==d.row)b.push(a.splice(c,1)[0]),e--;c=0;for(e=a.length;c<e;c++)for(var g=0;g<e-1-c;g++)a[g].row>a[g+1].row&&(d=a[g+1],a[g+1]=a[g],a[g]=d);b.length&&f.each(b,function(b,c){a.push(c)});f.each(a,function(a,b){m.cacheWidgetData(b);var c=u.render(v,x(b)),d=r(b.view);b.col&&b.row?k.add_widget(c,d.x,d.y,b.col,b.row):k.add_widget(c,d.x,d.y)});n=f(".widget-cover");y()}},A=function(a,b){var d=a.data("id"),c=m.getWidgetViewUrl(d,b),d=r(b);a.data("view",b);k.resize_widget(a,d.x,d.y,function(){setTimeout(function(){a.find("\x3e iframe")[0].src=Util.getRightUrl(c)},400)})},B=f("#desktop-lock"),p=null,C=function(){l.on("click",".widget-sz-btn",function(a){a=f(this);if(!a.hasClass("active")&&!a.hasClass("disabled")){var b=a.closest(".widget");a.addClass("active").siblings().removeClass("active");A(b,a.data("view"))}});B.on("click",function(a){a=f(this);a.hasClass("locked")?(a.removeClass("locked").addClass("unlocked"),n.removeClass("hidden")):(a.removeClass("unlocked").addClass("locked"),n.addClass("hidden"),p&&p.abort(),p=Util.ajax({type:"POST",url:Util.getRightUrl(MyDesktop.save.url),data:f.extend(MyDesktop.save.params,{widgetStatus:JSON.stringify(k.serialize())}),success:Util.noop,error:Util._ajaxErr}))})};f(function(){Util.ajax({type:"POST",dataType:"json",url:Util.getRightUrl(MyDesktop.get.url),data:MyDesktop.get.params}).done(z,C).fail(Util._ajaxErr)})})(this,jQuery);