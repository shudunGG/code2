!function(doc,Util,stringTools){"use strict";function Form(e,t){var r=this;t=t||{},r.options=Util.extend(defaultSetting,t),r.container=Util.selector(e),r.validatorEl=r.getValidatorEl(r.options.tag),r.ruleMethod={range:r._handleRange,maxlength:r._handleMaxlength,minlength:r._handleMinlength,phone:stringTools.isPhoneNum.bind(this),tel:stringTools.isTelNum.bind(this),email:stringTools.isEmail.bind(this),idcard:stringTools.idcard.validate.bind(this)},registerMethod.length>0&&r._ruleMergeMethod(registerMethod)}var formInstance=null,defaultSetting={tag:"input",errCls:""},defaultPrompt={phone:"手机号码格式不正确",email:"邮箱格式不正确",tel:"电话号码格式不正确",idcard:"身份证输入不正确",required:function(e){return e+"不能为空"},maxlength:function(e){return this.innerHTML+"不能大于"+e+"位"},minlength:function(e){return this.innerHTML+"不能小于"+e+"位"},regexp:function(){return this.innerHTML+"输入不正确"},equal:function(){return"密码输入不一致，请重新输入"}},registerMethod=[];Form.prototype={validate:function(){return this._handleRuleType(this.validatorEl)},getData:function(){var e=this.validatorEl,t={};return e.forEach(function(e){var r=e.dataset;r.id?t[r.id]=e.value||"":r.name&&(t[r.name]=e.value||"")}),t},getError:function(){return this.error},getValidatorEl:function(e){e=e.trim();var t=[],r=this.container,e=e.split(";");return Array.isArray(e)&&e.forEach(function(e,n){t=t.concat([].slice.call(r.querySelectorAll(e)))}),t},reset:function(){for(var e=this.validatorEl,t=0,r=e.length;t<r;t++)e[t].value=""},setDefaultErrMsg:function(e){defaultPrompt=Util.extend(defaultPrompt,e)},_handleRuleType:function(e){for(var t=this,r=0,n=e.length,l=t._handleRequire,a=t._handleVType;r<n;r++){var i=e[r],o=i.hasAttribute("vtype");if(i.required){if(!l.call(t,i))return!1;if(o&&!a.call(t,i))return!1}else{if(""!=i.value&&o&&!a.call(t,i))return!1;if(o&&~i.getAttribute("vtype").indexOf("equal")){var s=i.getAttribute("vtype"),u=s.indexOf("equal:")+6;s.indexOf(";",u)==-1?t._handleEqual.call(t,i,s.slice(u)):t._handleEqual.call(t,i,s.slice(u,s.indexOf(";",u)))}}}return!0},_handleRequire:function(e){return!(!e.value||""==e.value)||(this._handleError(e,defaultPrompt.required,this.options.errCls),!1)},_handleVType:function(e){var t=e.getAttribute("vtype"),r=/^[a-z]+:/i,n=this,l=n.ruleMethod;if(""!=t&&r.test(t)){t=t.toLowerCase().trim(),t=t.split(";");for(var a=0,i=t.length;a<i;a++){var o=t[a],s=o.slice(0,o.indexOf(":"));if(l[s]&&!l[s].call(n,e,o))return!1;if("regtype"==s&&!n._handleRegType(e,o))return!1;if("regexp"==s&&!n._handleRegExp(e,o))return!1;if("equal"==s&&!n._handleEqual(e,o))return!1}return!0}},_handleRegType:function(e,t){var r=this,n=r.ruleMethod,t=(e.previousElementSibling,this._analysisVtype(t)),l=n[t];if("function"==typeof l)return"m7_util_form_custom_regtype"===l.type?!!r._handleCustomRegType(e,l):!!l(e.value)||(r._handleError(e,defaultPrompt[t],r.options.errCls),!1);throw new Error("未找到改判定条件")},_handleCustomRegType:function(e,t){for(var r=t.regTypeName,n=null,l=0,a=registerMethod.length;l<a;l++){var i=registerMethod[l];r==i.callback.regTypeName&&(n=i.param,t=t.bind(e,i.param))}return!!t()||(this._handleError(e,n,n.errCls),!1)},_handleRegExp:function(el,vtype){var self=this,labelEle=el.previousElementSibling;return vtype=self._analysisVtype(vtype),vtype=eval(vtype),!!vtype.test(el.value)||(self._handleError(el,defaultPrompt.regexp(labelEle),self.options.errCls),!1)},_handleEqual:function(e,t){var r=this,n=e.value,t=r._analysisVtype(t),l=doc.getElementById(t)||doc.querySelector("[data-id='"+t+"']");return n==l.value||(r._handleError(e,defaultPrompt.equal(),r.options.errCls),!1)},_handleRange:function(e,t){var r=this,n=(e.previousElementSibling,Boolean(t.indexOf(",")==-1)),l=t.slice(t.indexOf(":")+1,n?t.length:t.indexOf(",")),a=n?"":t.slice(t.indexOf(",")+1);return!!r._handleMinlength(e,"",l)&&!!r._handleMaxlength(e,"",a)},_handleMinlength:function(e,t,r){var n=e.value.length,l=e.previousElementSibling,a=this;return t&&(r=a._analysisVtype(t)),!(n<r)||(a._handleError(e,defaultPrompt.minlength(l,r),a.options.errCls),!1)},_handleMaxlength:function(e,t,r){var n=e.value.length,l=e.previousElementSibling,a=this;return t&&(r=a._analysisVtype(t)),!(n>r)||(a._handleError(e,defaultPrompt.maxlength(l,r),a.options.errCls),!1)},_ruleMergeMethod:function(e){var t=this;e.forEach(function(e){var r=e.callback,n=e.name;r.type="m7_util_form_custom_regtype",r.regTypeName=n,t.ruleMethod[n]=r})},_handleErrCls:function(e,t){if(t&&""!=t){for(var r=e.parentElement;r&&!r.hasAttribute("data-role");)r=r.parentElement;r&&r.hasAttribute("data-role")&&r.classList.add(t)}},_analysisVtype:function(e){return e=e.trim().replace(/\s/g,""),e=e.slice(e.indexOf(":")+1)},_handleError:function(e,t,r){var n=e.previousElementSibling,l="";e.dataset&&e.dataset.title?l=e.dataset.title:"label"==n.tagName.toLowerCase()&&(l=n.innerHTML),"function"==typeof t?t=t.call(e,l):"object"==typeof t&&(t=t.errMsg||""),this._setError(e,t),this.toast(t),this._handleErrCls(e,r)},_setError:function(e,t){this.error={dom:e,message:t}},toast:function(e){e&&Util.ejs.ui.toast(e)},isEmptyObject:function(e){for(var t in e)return!1;return!0},registerVtype:function(e,t,r){registerMethod.push({callback:r,param:t,name:e}),this._ruleMergeMethod(registerMethod)}},Util.form={getInstance:function(e,t){return formInstance=new Form(e,t)},registerVtype:function(e,t){var r=t.callback;delete t.callback,formInstance?formInstance.registerVtype(e,t,r):registerMethod.push({callback:r,param:t,name:e})},setDefaultErrMsg:function(e){defaultPrompt=Util.extend(defaultPrompt,e)}}}(document,this.Util,this.Util.string);