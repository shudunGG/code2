<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="renderer" content="webkit" />
    <script src="../../../frame/fui/js/cssboot.js"></script>
    <link rel="stylesheet" href="login.css" />
    <link rel="shortcut icon" href="images/rhino.ico" />
    <title>The candidate points online collaborative work platformV9.0</title>
</head>

<body>
    <div class="page-loading"></div>
    <!-- background -->
    <div class="bg">
        <img style="" src="images/login-bg.jpg" />
    </div>
    <!-- The login subject -->
    <div class="content">
        <div class="download-area">
            <ul class="download-items">
                <li class="download-item">
                    <div class="download-item-def">
                        <span class="icon-phone"></span> <span>Iphone</span> <i class="icon-download"></i>
                    </div>
                    <div class="download-item-hide">
                        <img src="images/ihpone-dl.png" alt="" />
                    </div>
                </li>
                <li class="download-item">
                    <div class="download-item-def">
                        <span class="icon-andriod"></span> <span>Android</span> <i class="icon-download"></i>
                    </div>
                    <div class="download-item-hide">
                        <img src="images/ihpone-dl.png" alt="" />
                    </div>
                </li>
            </ul>
        </div>
        <!-- Login page title -->
        <div class="login-tt">
            <img id="logo-img" src="images/login-title.png" alt="" />
        </div>
        <!-- The login dialog -->
        <div class="login-wrap">
            <div class="login-tab-head clearfix" data-role="head">
                <h5 id="ID" class="login-tab-head-item l act" data-role="tab" data-target="user" onclick="changeLoginType('0')">Log in as user name</h5>
                <h5 id="KEY" class="login-tab-head-item l" data-role="tab" data-target="usb" onclick="changeLoginType('10')">Log in as USB</h5>
            </div>
            <div class="login-tabcontent" data-role="body">
                <div class="login-tabcontent-item" data-role="tab-content" data-id="user">
                    <div class="login-row">
                        <label for="username" class="icon-user"></label>
                        <input type="text" placeholder="Please enter OA user name" class="login-input" id="username" /> <i class="icon-erwm"></i>
                    </div>
                    <div class="login-row">
                        <label for="psd" class="icon-psd"></label>
                        <input type="password" placeholder="Please enter the password" class="login-input" id="psd" /> <i class="icon-keyboard"></i>
                    </div>
                    <div class="login-btn-row">
                        <button class="btn-login" onclick="encryUserMsg()">login</button>
                    </div>
                </div>
                <div class="login-tabcontent-item" data-role="tab-content" data-id="usb">
                    <div id="warn" class="login-row usb-note" style="display: none;">
                        <i class="icon-sad"></i>USB key not detected, please check your device
                    </div>
                    <div class="login-row">
                        <label for="psd" class="icon-psd"></label>
                        <input type="password" placeholder="Please enter the password" class="login-input" id="usbpsd" /> <i class="icon-keyboard"></i>
                    </div>
                    <div class="login-btn-row">
                        <button class="btn-login" onclick="encryUserMsg()">login</button>
                    </div>
                </div>
            </div>
        </div>
        <input class="mini-hidden" id="exponent_hidden" />
        <input class="mini-hidden" id="modulus_hidden" />
        <object classid='clsid:4391DCDD-5FB4-462F-9308-70A195937DAE' height='0' width='0' id='EliteIVGetSerialNumber' />
    </div>
    
 
 	<script type="text/javascript">var miniLocal='en_US.js';</script>
 	<script src="../../../rest/resource/jsboot"></script>
    <script>
    SrcBoot.output([
        'frame/fui/js/libs/security.js'
    ]);
    </script>
    <script>
    // Initialization timetitleandlogoThe request of address
    var initUrl = epoint.dealRestfulUrl("loginaction/getLoginData");

    var key;

    //Access can be automatically againThe login
    epoint.execute("loginaction.autoLoad", "", function(data) {
        key = RSAUtils.getKeyPair(data.publicExponent, "", data.modulus);
        Util.hidePageLoading();

    }, true);
    </script>
    <script>
    SrcBoot.output([
        'frame/fui/js/widgets/jquery.placeholder.min.js', 
        './login.js'
    ]);
    </script>
    <script>
    //<![CDATA[ 
    (function(win, $) {

        var $name = $('#username'),
            $pwd = $('#psd'),
            $usbpsd = $('#usbpsd');
        var userName;
        var passWord;
        var loginType = '0';

        win.changeLoginType = function(type) {
            if ('10' == type) {
                //To obtainusbkey
                var key = checkUsbKey();
                if (key) {
                    $("#warn").hide();
                } else {
                    $("#warn").show();
                }
            }
            loginType = type;
        };

        win.encryUserMsg = function() {
            var result = true;
            if ('0' == loginType) {
                userName = $.trim($name.val());
                passWord = $.trim($pwd.val());
                if (!(userName && passWord)) {
                    result = false;
                    epoint.alert('User name and password can not be empty!', null, null, 'warning');
                    return false;
                }
            } else if ('10' == loginType) {
                userName = checkUsbKey();
                passWord = $.trim($usbpsd.val());
                if (!(userName && passWord)) {
                    result = false;
                    epoint.alert('CA lock not detected, insert CA lock!', null, null, 'warning');
                    return false;
                }
            }

            //cacheUserName(userName);

            //Avoid ChineseThe loginName of problem, for firstutf-8coding
            userName = epoint.encodeUtf8(userName);
            userName = RSAUtils.encryptedString(key, userName);

            passWord = epoint.encodeUtf8(passWord);
            passWord = RSAUtils.encryptedString(key, passWord);
            epoint.execute('loginaction.login', '', [
                userName, passWord, loginType
            ], checkMultipleLogin);

            return result;
        };

        win.checkMultipleLogin = function(args) {
            if (args.systemMessages) {
                if (args.systemMessages.indexOf('This account') != -1) {
                	var msgs = args.systemMessages.split('?');
                    epoint.confirm(msgs[0] + '?', '', function () {
                    	epoint.execute('loginaction.login', '', [userName, passWord, '20'],checkMultipleLogin);
                    });
                } else if (args.systemMessages.indexOf('IsDefaultOU') != -1) {
                    var userguid = args.systemMessages.split('?')[1];
                    var url = "frame/orga/user/switchparttime?userguid=" + userguid;
                    epoint.openDialog("Account to choose", url, secondLogin, {
                        'width': 850,
                        'height': 350
                    });
                } else {
                    epoint.alert(args.systemMessages, null, null, 'warning');
                }
            }
        };

        win.secondLogin = function(result) {
            if (result && result != 'success' && result != 'close') {
                var msgs = result.split(";");
                //TODO Need to rethink this logic implementation,The background of
                var userName;
                var passWord;
                if ('0' == loginType) {
                    userName = $.trim($name.val());
                    passWord = $.trim($pwd.val());
                } else if ('10' == loginType) {
                    userName = checkUsbKey();
                    passWord = $.trim($usbpsd.val());
                }
                epoint.execute('loginaction.userLogin', '', [
                    loginType, msgs[1], msgs[2], userName, passWord
                ], userLoginCallBack);
            }
        };

        win.userLoginCallBack = function(args) {
            if (args.systemMessages) {
                epoint.alert(args.systemMessages, null, null, 'warning');
            }
        }
        
	    function checkUsbKey() {
	        var str;
	        try {
	            str = document.all('EliteIVGetSerialNumber').SERIAL_NUMBER();
	        } catch (e) {
	            epoint.alert("The current browser does not support", null, null, 'warning');
	            return false;
	        }
	        return str;
	    }

    }(this, jQuery));


    //]]>
    </script>
</body>

</html>
