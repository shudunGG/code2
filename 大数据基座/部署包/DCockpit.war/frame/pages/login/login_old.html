<!DOCTYPE html>
<html lang="zh-CN">

<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta name="renderer" content="webkit" />
<script src="../../../frame/fui/js/cssboot.js"></script>
<link rel="stylesheet" href="login.css" />
<link rel="shortcut icon" href="images/rhino.ico" />
<title>智能分析平台</title>
</head>

<body>
	<div class="page-loading"></div>
	<!-- 背景 -->
	<div class="bg">
		<img style="" src="images/login-bg.png" />
	</div>
	<!-- 登录主体 -->
	<form>
		<div class="content">
			<div class="download-area">
				<ul class="download-items">
					<li class="download-item">
						<div class="download-item-def">
							<span class="icon-phone"></span> <span>Iphone</span> <i class="icon-download"></i>
						</div>
						<div class="download-item-hide">
							<img src="images/ihpone-dl.png" alt="" />
						</div>
					</li>
					<li class="download-item">
						<div class="download-item-def">
							<span class="icon-andriod"></span> <span>Android</span> <i class="icon-download"></i>
						</div>
						<div class="download-item-hide">
							<img src="images/ihpone-dl.png" alt="" />
						</div>
					</li>
				</ul>
			</div>
			<!-- 登录页标题 -->
			<div class="login-tt">
				<img id="logo-img" src="images/login-title1.png" alt="" />
			</div>
			<!-- 登录框 -->
			<div class="login-wrap">
				<div class="login-tab-head clearfix" data-role="head">
					<h5 id="ID" class="login-tab-head-item l act" data-role="tab" data-target="user" onclick="changeLoginType('0')">用户登录</h5>
					<h5 id="KEY" class="login-tab-head-item l" data-role="tab" data-target="usb" onclick="changeLoginType('10')">USB Key登录</h5>
				</div>
				<div class="login-tabcontent" data-role="body">
					<div class="login-tabcontent-item" data-role="tab-content" data-id="user">
						<div class="login-row">
							<label for="username" class="icon-user"></label> <input type="text" name="username" placeholder="请输入用户名" class="login-input" id="username" />
							<i class="icon-erwm"></i>
						</div>
						<div class="login-row">
							<label for="psd" class="icon-psd"></label> <input type="password" name="psd" placeholder="请输入密码" class="login-input" id="psd" /> <i
								class="icon-keyboard"></i>
						</div>
						<div class="login-btn-row">
							<button class="btn-login" onclick="encryUserMsg()" type="button">登 录</button>
						</div>
					</div>
					<div class="login-tabcontent-item" data-role="tab-content" data-id="usb">
						<div id="warn" class="login-row usb-note" style="display: none;">
							<i class="icon-sad"></i>未检测到USB Key 请检查您的设备
						</div>
						<div class="login-row">
							<label for="psd" class="icon-psd"></label> <input type="password" name="usbpsd" placeholder="请输入密码" class="login-input" id="usbpsd" /> <i
								class="icon-keyboard"></i>
						</div>
						<div class="login-btn-row">
							<button class="btn-login" onclick="encryUserMsg()" type="button">登 录</button>
						</div>
					</div>
				</div>
		<!-- 		<span style="color: white; ">江苏国泰新点软件有限公司</span> -->

			</div>
			<input class="mini-hidden" id="exponent_hidden" /> <input class="mini-hidden" id="modulus_hidden" />
			<object classid='clsid:4391DCDD-5FB4-462F-9308-70A195937DAE' height='0' width='0' id='EliteIVGetSerialNumber'></object>
		</div>
	</form>
	<script src="../../../rest/resource/jsboot"></script>
	<script>
		SrcBoot.output([ 'frame/fui/js/libs/security.js' ]);
	</script>
	<script>
		// 初始化时获取title和logo的请求地址
		var initUrl = epoint.dealRestfulUrl("loginaction/getLoginData");

		var key;

		//再次访问可以自动登录
		epoint.execute("loginaction.autoLoad", "", function(data) {
			//key = RSAUtils.getKeyPair(data.publicExponent, "", data.modulus);
			Util.hidePageLoading();

		}, true);
	</script>
	<script>
		SrcBoot.output([ 'frame/fui/js/widgets/jquery.placeholder.min.js', './login.js' ]);
	</script>
	<script>
		//<![CDATA[ 
		(function(win, $) {

			var $name = $('#username'), $pwd = $('#psd'), $usbpsd = $('#usbpsd');

			var loginType = '0';

			var userName;
			var passWord;

			win.changeLoginType = function(type) {
				if ('10' == type) {
					//获取usbkey
					var key = checkUsbKey();
					if (key) {
						$("#warn").hide();
					} else {
						$("#warn").show();
					}
				}
				loginType = type;
			};

			win.encryUserMsg = function() {
				var result = true;
				if ('0' == loginType) {
					userName = $.trim($name.val());
					passWord = $.trim($pwd.val());
					if (!(userName && passWord)) {
						result = false;
						epoint.alert('用户名和密码不能为空!', null, null, 'warning');
						return false;
					}
				} else if ('10' == loginType) {
					userName = checkUsbKey();
					passWord = $.trim($usbpsd.val());
					if (!(userName && passWord)) {
						result = false;
						epoint.alert('未检测到CA锁，请插入CA锁!', null, null, 'warning');
						return false;
					}
				}

				//cacheUserName(userName);

				// 本地保存登录类型 和 用户名  用于快捷登录中的自动切换和填充
				if (window.localStorage) {
					localStorage.setItem('_loginType_', loginType);
					localStorage.setItem('_loginUsername_', userName);
				}

				//调用自定义编码
				userName = epoint.encode(userName);
				passWord = epoint.encode(passWord);

				epoint.execute('loginaction.login', '', [ userName, passWord, loginType ], checkMultipleLogin);

				return result;
			};

			win.checkMultipleLogin = function(args) {
				if (args.systemMessages) {
					if (args.systemMessages.indexOf('此账号') != -1) {
						var msgs = args.systemMessages.split('?');
						epoint.confirm(msgs[0] + '?', '', function() {
							epoint.execute('loginaction.login', '', [ userName, passWord, '20' ], checkMultipleLogin);
						});
					} else if (args.systemMessages.indexOf('IsDefaultOU') != -1) {
						var userguid = args.systemMessages.split('?')[1];
						var url = "frame/pages/login/switchparttime?userguid=" + userguid;
						epoint.openDialog("账号选择", url, secondLogin, {
							'width' : 850,
							'height' : 350
						});
					} else {
						epoint.alert(args.systemMessages, '', null, 'warning');
					}
				}
			};

			win.secondLogin = function(result) {
				if (result && result != 'success' && result != 'close') {
					var msgs = result.split(";");
					//TODO 下面这段逻辑需要重新考虑实现,后台的
					var userName;
					var passWord;
					if ('0' == loginType) {
						userName = $.trim($name.val());
						passWord = $.trim($pwd.val());
					} else if ('10' == loginType) {
						userName = checkUsbKey();
						passWord = $.trim($usbpsd.val());
					}
					epoint.execute('loginaction.userLogin', '', [ loginType, msgs[1], msgs[2], userName, passWord ], userLoginCallBack);
				}
			};

			win.userLoginCallBack = function(args) {
				if (args.systemMessages) {
					epoint.alert(args.systemMessages, null, null, 'warning');
				}
			}

			function checkUsbKey() {
				var str;
				try {
					str = document.all('EliteIVGetSerialNumber').SERIAL_NUMBER();
				} catch (e) {
					epoint.alert("当前浏览器不支持", null, null, 'error');
					return false;
				}
				return str;
			}

		}(this, jQuery));

		//]]>
	</script>
</body>

</html>