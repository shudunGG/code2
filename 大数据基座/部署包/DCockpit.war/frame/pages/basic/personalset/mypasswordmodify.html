<!DOCTYPE html>
<html>

<head>
<title>修改密码</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />

<script src="../../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<!-- 等待提示框 -->
	<div class="page-loading"></div>

	<!-- 按钮区域 -->
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<a class="mini-button" onclick="save">确定修改</a> <a id="notthistime"
				class="mini-button" onclick="redirectFrame">暂不修改</a>
		</div>
		<div>
			<span id="valid" style="color: red"> 密码已过期，请重新设置密码。</span><span
				id="force" style="color: red">密码不能为初始化值，请重新设置。</span>
		</div>
	</div>


	<!-- 内容区域 -->
	<div class="fui-content">
		<div class="fui-form" id="fui-form">
			<div role="form">
				<div role="row">
					<div role="control" label="原密码" starred="true">
						<input id="txtOldPsd" class="mini-password" required="true"
							emptyText="请输入原密码" style="width: 90%;"
							bind="mypasswordmodifyaction.txtOldPsd" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="新密码" starred="true">
						<input id="txtNewPsd" class="mini-password" required="true"
							emptyText="请输入新密码" style="width: 90%;"
							bind="mypasswordmodifyaction.txtNewPsd" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="确认密码" starred="true">
						<input id="txtNewPsdCon" class="mini-password" required="true"
							emptyText="请输入确认密码" style="width: 90%;"
							bind="mypasswordmodifyaction.txtNewPsdCon" />
					</div>

				</div>
			</div>
		</div>
		<!-- 隐藏域 -->
<!-- 		<input bind="mypasswordmodifyaction.complexPassWord" -->
<!-- 			id="complexPassWord" class="mini-hidden" />  -->
			<input
			bind="mypasswordmodifyaction.neededit" id="neededit"
			class="mini-hidden" />
	</div>

	<script src="../../../../rest/resource/jsboot"></script><script>
		// sm2加密引入js文件
		SrcBoot.output([
			'../../../fui/js/libs/sm2security.js'
		]);
	</script>

	<script>
		//<![CDATA[  
		//初始化页面
		epoint.initPage("mypasswordmodifyaction", "", initCallback);

		//暂不修改按钮显示
		function initCallback(data) {
			var reason = Util.getUrlParams("reason");
			if (reason && reason == "valid") {
				$('#valid').css('display', 'block');
				$('#force').css('display', 'none');
			} else if (reason && reason == "force") {
				$('#valid').css('display', 'none');
				$('#force').css('display', 'block');
			} else {
				$('#valid').css('display', 'none');
				$('#force').css('display', 'none');
			}
			if (mini.get("neededit").getValue() != 1) {
				mini.get("notthistime").setVisible(false);
			}
		}

// 		//校验复杂度
// 		function checkPass1(s) {
// 			if (s.length < 8)
// 				return 0;
// 			var ls = 0;
// 			if (s.match(/([a-z])+/))
// 				ls++;
// 			if (s.match(/([0-9])+/))
// 				ls++;
// 			if (s.match(/([A-Z])+/))
// 				ls++;
// 			if (s.match(/[^a-zA-Z0-9]+/))
// 				ls++;
// 			return ls
// 		}

		//修改回调事件
		function saveCallback(data) {
			epoint.alert(data.msg, '', function() {
				//跳转到首页
				if (data.success) {
					redirectFrame();
				} else if(data.msg.indexOf('已锁定')!=-1){
					window.top.location.href = Util
					.getRightUrl('rest/logout?isCommondto=true');
				}else {
					//清空表单
					epoint.clear('fui-form');
				}
			}, 'info');
		}

		//确认修改
		function save() {
			if (epoint.validate()) {
				var txtOldPsd = mini.get("txtOldPsd").getValue();
				var txtNewPsd = mini.get("txtNewPsd").getValue();
				var txtNewPsdCon = mini.get("txtNewPsdCon").getValue();
				//判断新旧密码是否相同
				if (txtOldPsd == txtNewPsd) {
					epoint.alert("新密码不能和旧密码相同！", '', null, 'warning');
					return false;
				}
				//判断确认密码是否相同
				if (txtNewPsd != txtNewPsdCon) {
					epoint.alert("确认密码和新密码不同！", '', null, 'warning');
					return false;
				}
// 				//复杂度校验
// 				var complexPassWord = mini.get("complexPassWord").getValue();
// 				if ("1" == complexPassWord) {
// 					if (checkPass1(txtNewPsd) == 0) {
// 						epoint.alert("密码长度必须大于8，请重新设置！", '', null, 'warning');
// 						return false;
// 					}
// 				} else if ("2" == complexPassWord) {
// 					if (checkPass1(txtNewPsd) < 2) {
// 						epoint.alert("密码长度必须大于8，且拥有小写、大写字母、数字、特殊字符4种组合中的两种，请重新设置！", '', null, 'warning');
// 						return false;
// 					}
// 				} else if ("3" == complexPassWord) {
// 					if (checkPass1(txtNewPsd) < 3) {
// 						epoint.alert("密码长度必须大于8，且拥有小写、大写字母、数字、特殊字符4种组合中的三种，请重新设置！", '', null, 'warning');
// 						return false;
// 					}
// 				}
				mini.get("txtOldPsd").setValue(Util.encryptSM2(txtOldPsd));
				mini.get("txtNewPsd").setValue(Util.encryptSM2(txtNewPsd));
				mini.get("txtNewPsdCon").setValue(Util.encryptSM2(txtNewPsdCon));
				epoint.execute("checkPasswordComplex", "", mini.get("txtNewPsd").getValue(), function(data){
					if(data.success) {
						//执行后台方法修改
						epoint.execute("sure", "", saveCallback);
					}
					else {
						if(data.msg) {
							epoint.alert(data.msg, '', '', 'warning');
						}
						mini.get("txtOldPsd").setValue("");
						mini.get("txtNewPsd").setValue("");
						mini.get("txtNewPsdCon").setValue("");
					}
				});
			}
		}

		function redirectCallBack(e) {
			var url = Util.getUrlParams('uri');
			if (url) {
				if (url.indexOf('http') < 0) {
					url = Util.getRootPath() + url;
				}
				Util.getSafeLocation().href = url;
			}
		}

		//暂不修改 ，跳转到首页
		function redirectFrame() {
			//得先在session放个标志位，不然后面无限循环修改密码
			epoint.execute("notModify", "", redirectCallBack);
		}

		//]]>
	</script>

</body>
</html>