<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>个人资料</title>
    <script src="../../../../../frame/fui/js/cssboot.js"></script>
    <style type="text/css">
        .scroll-container {
            max-width: 1080px;
            margin-left: auto;
            margin-right: auto;
        }

        .cate-header {
            margin-top: 26px;
            margin-bottom: 20px;
            color: #2586d9;
            font-size: 16px;
            line-height: 30px;
            padding-left: 3px;
            height: 36px;
            position: relative;
        }

        .cate-header:before {
            content: "";
            position: absolute;
            width: 100%;
            bottom: 0;
            height: 0;
            border-bottom: 1px solid #ebf2f8;
        }

        /*  asLabel 模式 */

        .asLabel .mini-textbox-border,
        .asLabel .mini-textbox-input,
        .asLabel .mini-buttonedit-border,
        .asLabel .mini-buttonedit-input,
        .asLabel .mini-textboxlist-border {
            border-color: transparent;
            background: none;
            cursor: default;
        }

        .asLabel .mini-buttonedit-button,
        .asLabel .mini-textboxlist-close {
            display: none;
        }

        .asLabel .mini-textboxlist-item {
            padding-right: 8px;
        }

        .asLabel .mini-radiobuttonlist-item,
        .asLabel .mini-radiobuttonlist-item-selected .mini-list-icon {
            display: none;
        }

        .asLabel .mini-radiobuttonlist-item-selected {
            display: block;
        }

        .asLabel .mini-radiobuttonlist-item-selected label {
            display: block;
            line-height: 26px;
        }
    </style>
	<script>
		SrcBoot.outputCustomSkin("./skins/persondata/");
	</script>
</head>

<body>
    <div class="fui-content" id="person-data" style="padding:0 20px;">
        <div class="scroll-container">
            <div class="cate-header fui-theme-main-color">基本信息</div>
            <div class="fui-form">
                <div role="form">
                    <div role="row">
                        <div role="control" label="姓名">
                            <input id="user-name" class="mini-textbox" value="张三" required="true" onvaluechanged="saveChange" />
                        </div>
                        <div role="control" label="办公电话">
                            <input id="office-tel" class="mini-textbox" value="12312341234" required="true" onvaluechanged="saveChange" />
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="性别">
                            <input id="gender" class="mini-radiobuttonlist" textField="text" valueField="id" value="0" data="[{id:0,text:'男'},{id:1,text:'女'}]"
                                required="true" onvaluechanged="saveChange" />
                        </div>
                        <div role="control" label="短号码">
                            <input id="short-tel" class="mini-textbox" value="7633" required="true" onvaluechanged="saveChange" />
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="职务">
                            <input id="postion" class="mini-textbox" value="前端工程师" onvaluechanged="saveChange" />
                        </div>
                        <div role="control"></div>
                    </div>
                </div>
            </div>
            <div class="cate-header fui-theme-main-color">扩展信息</div>
            <div class="fui-form">
                <div role="form">
                    <div role="row">
                        <div role="control" label="身份号码">
                            <input id="id-card" class="mini-textbox" value="123456789012345678" required="true" onvaluechanged="saveChange" />
                        </div>
                        <div role="control" label="移动电话" class="clearfix">
                            <input id="mobile-phone" class="mini-textbox" value="12312341234" required="true" style="float:left;width: 150px;margin-right: 10px;"
                                onvaluechanged="saveChange" />
                            <span id="mobile-phone-open" class="mini-checkbox switch" readOnly="false" text="公开" style="width:100px;" onvaluechanged="saveChange"></span>
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="生日">
                            <input id="birthday" class="mini-datepicker" value="2010-01-01" required="true" onvaluechanged="saveChange" />
                        </div>
                        <div role="control" label="家庭电话" class="clearfix">
                            <input id="home-phone" class="mini-textbox" value="12312341234" required="true" style="float:left;width: 150px;margin-right: 10px;"
                                onvaluechanged="saveChange" />
                            <span id="home-phone-open" class="mini-checkbox switch" checked="true" text="公开" readOnly="false" style="width:100px;" onvaluechanged="saveChange"></span>
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="QQ号">
                            <input id="qq-number" class="mini-textbox" value="2010-01-01" required="true" onvaluechanged="saveChange" />
                        </div>
                        <div role="control" label="邮政编码">
                            <input id="postal-code" class="mini-textbox" value="215600" required="true" onvaluechanged="saveChange" />
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="MSN">
                            <input id="msn" class="mini-textbox" value="--" required="true" onvaluechanged="saveChange" />
                        </div>
                        <div role="control" label="家庭地址">
                            <input id="address" class="mini-textbox" value="苏州市张家港杨舍镇江帆路8号江苏国泰新点软件有限公司" required="true" onvaluechanged="saveChange" />
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="车牌号">
                            <input id="car-code" class="mini-textbox" value="苏E00007" onvaluechanged="saveChange" />
                        </div>
                        <div role="control"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // 数据模拟
        SrcBoot.debug = true;
        SrcBoot.mock = true;
    </script>
    <script src="../../../../../rest/resource/jsboot"></script>
    <script>
        epoint.initPage('./test/init.json');
        // 转化为 label 模式
        function labelModel(c) {
            if (c.setReadOnly) c.setReadOnly(true); //只读
            if (c.setIsValid) c.setIsValid(true); //去除错误提示
            if (c.addCls) c.addCls("asLabel"); //增加asLabel外观
        }

        function allToLabel() {
            var form = new mini.Form("person-data");
            var fields = form.getFields();
            for (var i = 0, l = fields.length; i < l; i++) {
                var c = fields[i];
                if (c.type != 'checkbox') {
                    labelModel(c);
                }
            }
        }
        allToLabel();

        // 转为编辑模式
        function inputModel(c) {
            if (c.removeCls) c.removeCls('asLabel');
            if (c.setReadOnly) c.setReadOnly(false); //只读
            // if (c.setIsValid) c.setIsValid(false); //去除错误提示
        }
        if (Util.browsers.isIE) {
            // IE下需要重写此方法
            // cause IE下直接点击鼠标进入编辑模式后（实际上并未进入，需要再次点击才能正确聚焦）
            // 为解决此问题，在 IE下加入为其设置焦点的操作
            function inputModel(c) {
                if (c.removeCls) c.removeCls('asLabel');
                if (c.setReadOnly) c.setReadOnly(false); //只读
                // if (c.setIsValid) c.setIsValid(false); //去除错误提示
                c.focus && c.focus();
            }
        }

        var activeControl;
        // 点击控件部分进入编辑模式
        // $('body').on('click', '.form-control', function (e) {
        $('body').on('click', '.form-control > :first-child', function (e) {
            // var controlEl = $(this).find('>:first-child')[0];
            var controlEl = this;

            if (controlEl && controlEl.id) {
                e.stopPropagation();
                var c = mini.get(controlEl.id);
                // 将之前控件调整为label模式
                if (activeControl) {
                    labelModel(activeControl);
                }

                if (c) {
                    activeControl = c;
                    activeControlValue = c.getValue();
                    inputModel(c);
                }
            }
        }).on('click', function (e) {
            // 空白处点击
            if (activeControl) {
                var type = activeControl.type;
                // 验证不通过时值还原
                if (activeControl.validate && !activeControl.validate()) {
                    activeControlValue && activeControl.setValue(activeControlValue);
                }
                if (type == 'textbox') {
                    labelModel(activeControl);
                } else if (type == 'datepicker') {
                    if (!$(activeControl.el).hasClass('mini-buttonedit-focus')) {
                        labelModel(activeControl);
                    }
                }
            }
        });
        // 空方法
        function emptyFn() {}
        var activeControlValue;
        // 修改完成后进行保存
        function saveChange(e) {
            // 如果校验不通过 不报错 不提交
            // console.log(e, e.sender.validate());
            if (e.sender.validate && !e.sender.validate()) {
                epoint.showTips(e.sender.errorText || '数据验证不通过', {
                    state: 'danger'
                });
                if (e.oldValue) {
                    activeControlValue = e.oldValue;
                }
                return;
            }
            var id = e.sender.id;
            // 只用提交当前修改的即可
            epoint.execute('./test/test.json', id, function () {
                if (e.sender.type != 'checkbox') {
                    labelModel(e.sender);
                }
                epoint.refresh(id, emptyFn);
                epoint.showTips('修改成功', {
                    state: 'success'
                });
                // 如果修改的是姓名、职务等 同步头上
                if (id == 'user-name') {
                    $('#user-top-name').text(mini.get('user-name').getValue());
                }
                if (id == 'postion') {
                    $('#position-text').text(mini.get('postion').getValue());
                }
            });
        }
    </script>
</body>

</html>