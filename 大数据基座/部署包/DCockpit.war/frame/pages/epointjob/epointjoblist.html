<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>调度平台任务列表</title>
<script src="../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>
	<!-- toolbar区域 -->
	<div class="fui-toolbar">
		<a class="mini-button" state="primary" onclick="addJob">新增任务</a>
		<!--帮助按钮 -->
		<a role="helper" class="mr10">注意事项</a>
	</div>

	<!-- 帮助信息区域 默认隐藏-->
	<div class="fui-notice hidden">
		<p>
			<span class="text-danger"> 暂无描述 </span>
		</p>
	</div>

	<!-- 条件区域 -->
	<div class="fui-condition">
		<div class="fui-form" id="fui-form">
			<div role="form">
				<div role="row">
					<div role="control" label="任务描述">
						<input bind="jobDesc" class="mini-textbox" />
					</div>
					<div role="control" label="任务状态">
						<input id="triggerStatus" class="mini-radiobuttonlist"
							action="getTriggerStatusList" bind="triggerStatus" value="-1"
							onvaluechanged="statusChange" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="执行器组">
						<input class="mini-combobox" showNullItem="false"
							bind="groupName" action="getJobGroupList"
							emptyText="请选择执行器..." showClose="true"  autoClear="true" textField="text"
							allowInput="false" valueField="id" />
					</div>
					<div role="control" label="JobHandler">
						<input bind="executorHandler" class="mini-textbox" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="负责人">
						<input bind="author" class="mini-textbox" />
					</div>
					<div role="control" label=""></div>
				</div>
			</div>
		</div>
		<a id="searchBtn" role="searcher" callback="searchData"></a>
	</div>

	<!-- 内容区域 -->
	<div class="fui-content">
		<div id="datagrid" name="datagrid" class="mini-datagrid"
			idField="jobGuid" multiSelect="false"
			style="width: 100%; height: 100%;" allowResize="true"
			allowCellValid="false" allowCellEdit="false" showPager="true"
			action="getDataGridData" allowCellSelect="false">
			<div property="columns">
				<div type="indexcolumn" width="40">序</div>
				<div field="jobDesc" width="100%">任务描述</div>
				<div field="jobCron" width="130">Cron</div>
				<div field="author" width="100">负责人</div>
				<div field="triggerStatus" headeralign="center" align="center" width="120" renderer="onStatusRenderer">状态</div>
				<div width="80" headeralign="center" align="center" renderer="onStartOrStopRenderer" name="edit">启动停止</div>
				<div width="80" headeralign="center" align="center" renderer="onTriggerRenderer">执行一次</div>
				<div width="80" headeralign="center" align="center" renderer="onLogRenderer">查看日志</div>
				<div width="110" headeralign="center" align="center" renderer="onNextTimeRenderer">后续调度时间</div>
				<div width="80" headeralign="center" align="center" renderer="onEditRenderer">编辑</div>
				<div width="80" headeralign="center" align="center" renderer="onDelRenderer">删除</div>
			</div>
		</div>
	</div>

	<script src="../../../rest/resource/jsboot"></script>
	<script>
		//初始化页面		
		epoint.initPage('epointjoblistaction', '@all', function(data) {
			if (data.msg) {
				epoint.alert(data.msg, '提示', null, 'info');
			}
		});

		// 表格对象
		var grid = mini.get("datagrid");

		// 表格的搜索
		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		}

		// 任务状态渲染
		function onStatusRenderer(e) {
			var cls = "";
			var statusName = "";
			if (e.row.triggerStatus == "1") {
				cls = "dot-success";
				statusName = "运行";
			} else {
				cls = "dot-gone";
				statusName = "停止";
			}
			return '<i class="' + cls+ '"></i>' + statusName;
		}

		// 弹出新增窗口
		function addJob() {
			epoint.openDialog('新增调度任务', 'frame/pages/epointjob/epointjobadd',
					function(param) {
						if (param != 'close') {
							epoint.alert(param, null, null, 'info');
						}
						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
					}, {
						'width' : 1200,
						'height' : 800
					});
		}

		// 绘制行编辑按钮
		var onEditRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "openEdit",
					"jobGuid");
		};

		// 弹出修改窗口
		function openEdit(guid) {
			var url = 'frame/pages/epointjob/epointjobadd?jobGuid=' + guid;
			epoint.openDialog("编辑调度任务", url, editCallBack, {
				'width' : 1200,
				'height' : 800
			});
		}

		function editCallBack(param) {
			if (param) {
				if (param != 'close') {
					epoint.alert(param, null, null, 'info');
				}
				epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
			}
		}

		// 绘制行删除按钮
		var onDelRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-remove", "delJob",
					"jobGuid");
		};

		// 删除一行数据
		function delJob(guid) {
			// 弹出确认框
			epoint.confirm("确定要将本调度任务删除吗?", '', function() {
				epoint.execute("delJob", '', [ guid ], function(data) {
					if (data.msg) {
						epoint.alert(data.msg, '', null, 'info');
						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
					}
				});
			});
		}

		// 绘制启动停止按钮
		var onStartOrStopRenderer = function(e) {
			if (e.row.triggerStatus == "1") {
				return epoint.renderCell(e, "action-icon icon-pause error",
						"stopJob", "jobGuid");
			} else {
				return epoint.renderCell(e, "action-icon icon-start success",
						"startJob", "jobGuid");
			}
		};

		// 开始任务
		function startJob(guid) {
			// 弹出确认框
			epoint.confirm("你确定要启动该任务？", '', function() {
				epoint.execute("startJob", '', [ guid ], function(data) {
					if (data.msg) {
						epoint.alert(data.msg, '', null, 'info');
						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
					}
				});
			});
		}

		// 停止任务
		function stopJob(guid) {
			// 弹出确认框
			epoint.confirm("你确定要停止该任务？", '', function() {
				epoint.execute("stopJob", '', [ guid ], function(data) {
					if (data.msg) {
						epoint.alert(data.msg, '', null, 'info');
						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
					}
				});
			});
		}

		// 绘制执行一次按钮
		var onTriggerRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-check", "trigger",
					"jobGuid");
		};

		function trigger(guid) {
			// 弹出触发任务页
			epoint.openDialog('触发一次任务',
					'frame/pages/epointjob/epointjobtrigger?guid=' + guid
							+ "&type=0", function(param) {
						if (param != 'close') {
							epoint.alert(param, null, null, 'info');
						}
						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
					}, {
						'width' : 400,
						'height' : 200
					});
		}

		// 绘制查看日志按钮
		var onLogRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-doc", "openLog",
					"jobGuid");
		}

		// 打开查看日志按钮
		function openLog(guid) {
			var url = 'frame/pages/epointjob/epointjobloglist?jobGuid=' + guid;
			epoint.openDialog("查看任务调度日志", url, "", {
				'width' : 1400,
				'height' : 1000
			});
		}

		// 绘制查看下次执行时间按钮
		var onNextTimeRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-clock", "nextTime",
					"jobCron");
		};

		//查看下次执行的时间
		function nextTime(cron) {
			// 弹出确认框
			epoint.execute("nextTriggerTime", '', [ cron ], function(data) {
				if (data.msg) {
					epoint.alert(data.msg, '', null, 'info');
				}
			});
		}

		// 任务状态切换事件
		function statusChange(e) {
			// 任务状态切换时，触发搜索事件
			$('#searchBtn span').trigger('click');
		}
	</script>
</body>
</html>