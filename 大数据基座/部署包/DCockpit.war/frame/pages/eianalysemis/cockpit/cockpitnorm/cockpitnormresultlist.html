<!DOCTYPE html>
<html>

<head>
<title>指标定义表列表</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<!-- 请修改相对路径 -->
<script src="../../../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>

	<!-- toolbar区域 -->
	<div class="fui-toolbar" id="toolbar">
		<div class="btn-group mr10">
			<a class="mini-button" id="saveAndSubmit" onclick="saveAndSubmit">保存并送审</a>
			<a class="mini-button" id="saveAndRefresh" onclick="saveAndRefresh">保存</a>
		</div>
	</div>

	<!-- 内容区域 -->
	<div id="fuiContent" class="fui-content">
		<div id="datagrid" class="mini-datagrid" idField="rowguid"
			action="getDataGridData" sortOrder="desc" showPager="true"
			style="width: 100%; height: 100%;" allowResize="true"
			multiSelect="true" allowCellEdit="true" allowCellSelect="true"
			editNextOnEnterKey="true" editNextRowCell="true">
			<div property="columns"></div>
		</div>
	</div>
	<script src="../../../../../rest/resource/jsboot"></script>
	<script>
		// 初始化页面
		var id = Util.getUrlParams('id');
		epoint.initPage('cockpitnormresultlistaction', null, function(e) {
			if (e.msg == "error") {
				epoint.alert("数据异常");
				return;
			}
			if (e.count == 0) {
				epoint.alert("上次执行无结果，请检查指标配置或查看执行日志");
			}
			if (id == 0) {
				if (e.needCheck == 'true') {
					$('#saveAndRefresh').addClass('hidden');
				} else {
					$('#saveAndSubmit').addClass('hidden');
				}
			} else {
				mini.get('datagrid').setAllowCellEdit(false);
				$('#toolbar').addClass('hidden');
			}
			createGrid(e.columns);
		});

		function saveAndRefresh() {
			epoint.execute("saveResult", 'datagrid', function(data) {
				if (data.error) {
					epoint.alert(data.error);
				}
				if (data.msg) {
					epoint.alertAndClose(data.msg);
				}
			});
		}

		function saveAndSubmit() {
			epoint
					.execute(
							"submitApply",
							'datagrid',
							function(data) {
								if (data.error) {
									epoint.alert(data.error);
								}
								if (data.batchGuid) {
									epoint
											.openTopDialog(
													'指标结果审核',
													"frame/pages/epointworkflow/client/processcreateinstance?ProcessGuid=32757acc-0102-4822-bf41-6cfcb31e0e8d&checkGuid="
															+ data.batchGuid,
													function(data) {
														if (data.action != 'close') {
															epoint
																	.closeDialog();
														}
													}, {
														'width' : 1200,
														'height' : 800
													});
								}
							});
		}

		var grid = mini.get("datagrid");
		function createGrid(columns) {
			for (var i = 0; i < columns.length; i++) {
				if (columns[i].header != '序') {
					columns[i].editor = {
						type : 'textbox'
					}
				}
			}
			grid.setColumns(columns);
		}
	</script>
</body>
</html>