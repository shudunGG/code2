<!DOCTYPE html>
<html>

<head>
<title>版块授权</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<script src="../../../../../frame/fui/js/cssboot.js"></script>
<link rel="stylesheet"
	href="../../../../../frame/pages/basic/gateway/app/appinfomanage/css/roleSelect.css" />
<style type="text/css">
.role-status {
	margin-bottom: 10px;
}
</style>
</head>
<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>
	<!-- 内容区域 -->
	<div class="fui-content">
		<div class="role-status" id="role-status">
			<div class="public-status l" id="public-status"></div>
			<span class="public-lable" id="public-lable"> 公开状态：未开启</span>
		</div>
		<div class="fui-form" id="fui-form3"
			style="margin-right: 2%; overflow-y: auto; overflow-x: hidden;">
			<div role="row">
				<div role="control" label="角色设置">
					<div class="mini-repeat clearfix" id="repeat"
						templateId="roleTemplate"></div>
					<input id="controlIds" class="mini-hidden" /> <input
						bind="selectedRoles" id="roleValues" class="mini-hidden" />
				</div>

			</div>
		</div>
	</div>

	<!-- toolbar区域 -->
	<div class="fui-toolbar-bottom text-center" id="bar">
		<div class="btn-group mr10"
			style="float: none; display: inline-block;">
			<a class="mini-button" iconCls="icon-save" id="addClose"
				onclick="saveAndClose">保存并关闭</a>
		</div>
	</div>
	<script type="text/template" id="roleTemplate">
			<div id="panel1" class="mini-panel" title="{{title}}" iconCls="icon-add" showCollapseButton="false"  allowResize="true" showFooter="false" style="width:75%;float:left;margin-left:1%;margin-top:10px;">
			<div id="{{roleType}}" class="mini-checkboxlist" repeatLayout="table" repeatItems="3" textField="text" valueField="value"></div>
			</div>
	</script>

	<script src="../../../../../rest/resource/jsboot"></script>

	<script>
		//<![CDATA[  
        //初始化请求
        var $roleStatus = $ ('#role-status');
        var $publicLable = $ ('#public-lable');
        var $publicStatus = $ ('#public-status');
        epoint.initPage ('cockpitplateauthorizeaction', null, function (data) {
	        initCallback (data);
        });
        
        var repeat = mini.get ('repeat');
        
        function initCallback (e) {
	        //初始化角色区域
	        var data = e.uirepeat;
	        repeat.setData (data);
	        //将checkboxlist id存入隐藏域
	        mini.get ("controlIds").setValue (data["controlIds"]);
	        if (e.isPublic == "true"){
		        $publicStatus.addClass ('active');
		        $publicLable.text (' 公开状态：已开启');
	        }
        }

        function saveAndClose () {
	        if (epoint.validate ()){
		        var isPublic = $publicStatus.hasClass ('active');
		        if (!isPublic){
			        saveUserRole ();
		        }
		        var roleGuids = mini.get ("roleValues").getValue ();
		        epoint.execute ('save', '', isPublic, function (data) {
			        if (data.msg.indexOf ("成功") == -1){
				        epoint.alert (data.msg, '', null, null, 'info');
			        }
			        else{
				        epoint.alertAndClose (data.msg, '', null, null, 'info');
			        }
		        });
	        }
        }

        //将角色值赋到隐藏域
        function saveUserRole () {
	        var checkbox = mini.get ("controlIds").getValue ().split (',');
	        var selected = '';
	        $.each (checkbox, function (n, value) {
		        var cValue = mini.get (value).getValue ();
		        if (cValue){
			        selected += cValue + ";";
		        }
	        });
	        //将所有checkboxlist 的选中值存入隐藏域
	        mini.get ("roleValues").setValue (selected.substring (0, selected.length - 1));
        }

        $roleStatus.on ('click', '.public-status', function () {
	        var $this = $ (this);
	        if ($this.hasClass ("active")){
		        $this.removeClass ('active');
		        var $repeat = $ ('#repeat');
		        if ($repeat){
			        $repeat.removeClass ('status-active');
		        }
		        $publicLable.text (' 公开状态：未开启');
	        }
	        else{
		        $this.addClass ('active');
		        var $repeat = $ ('#repeat');
		        if ($repeat){
			        $repeat.addClass ('status-active');
		        }
		        $publicLable.text (' 公开状态：已开启');
	        }
	        
        });

        //]]>
	</script>
</body>
</html>