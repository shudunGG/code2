<!DOCTYPE html>
<html>

<head>
<title>专题管理</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<!-- 请修改相对路径 -->
<script src="../../../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>
	<div class="fui-left" id="fui-left">
		<div role="head" title="主题与专题分类"></div>
		<div role="body">
			<div class="mini-tree" id="tree" action="cockpitmobileauthorizationaction.getCardTreeModel"></div>
		</div>
	</div>
	<div class="fui-right">

		<div class="fui-toolbar">
			<div class="btn-group mr10">
				<a class="mini-button" iconCls="icon-addcircle" onclick="openAdd">新增授权</a>
				<a class="mini-button" iconCls="icon-edit" onclick="openEdit">编辑授权</a>
				<a class="mini-button" iconCls="icon-trash" onclick="deleteUser">取消授权</a>
			</div>
			<div style="float: right;margin-right: 40px;">
				<a style="color: blue;text-decoration: underline;" id="userurl" >人员视角</a>
				&nbsp;/&nbsp;
				<a >内容视角</a>
			</div>
		</div>

		<div class="fui-condition">
			<div class="fui-form" id="fui-form" style="padding: 0px 16px;">
				<div id="cform" role="form">
					<div class="form-row" style="padding: 0px 0px;">
						<label class="form-label" id="contentLabel" style="width: auto;">【驾驶舱】的授权用户列表</label>
						<input class="mini-hidden" id="cockpitguid" bind="dataBean.cockpitguid"/>
						<input id="columnguid" class="mini-hidden" bind="columnguid" />
						<input id="projectcateguid" class="mini-hidden" bind="projectcateguid" />
						<input id="projectguid" class="mini-hidden" bind="projectguid" />
						<input id="plateguid" class="mini-hidden" bind="dataBean.plateguid" />
						<input id="cardcateguid" class="mini-hidden" bind="dataBean.cardcateguid" />
						<input id="cardguid" class="mini-hidden" bind="dataBean.rowguid" />
					</div>
				</div>
			</div>
		</div>
		<!-- 内容区域 -->
		<div id="fuiContent" class="fui-content" style="padding: 0px 16px;">
			<div id="datagrid" class="mini-datagrid" idField="rowguid" action="getDataGridData" sortOrder="desc" showPager="true" style="height: 100%;" allowResize="true" multiSelect="true" allowCellEdit="true" allowCellSelect="true" editNextOnEnterKey="true" editNextRowCell="true">
				<div property="columns">
					<div type="indexcolumn" width="40" headerAlign="center" align="center">序</div>
					<div field="username" headerAlign="center" align="center" width="120">用户名称</div>
					<div field="ouname" headerAlign="center" align="center" width="120">所在部门</div>
				</div>
				
			</div>
		</div>
		
	</div>

	

	<!-- 请修改相对路径 -->
	<script src="../../../../../rest/resource/jsboot"></script>
	<script>
		// 初始化页面
		
		var cockpitguid;
		//树js对象
		var tree = mini.get("tree");
		epoint.initPage('cockpitmobileauthlistaction', '@all', function (data){
			mini.get("cockpitguid").setValue(data.cockpitguid);
			document.getElementById("userurl").href="./cockpitmobileauthuserlist?cockpitguid=" + data.cockpitguid;
		});

		// 弹出新增窗口
		function openAdd() {
			var guid = mini.get("cockpitguid").getValue();
			epoint.openTopDialog("新增授权", './cockpitmobileauthorization?cockpitguid=' + guid, searchData, {
				'width' : 1200,
				'height' : 800
			});
		}

		// 表格的搜索
		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		}

		function callBack(data) {
			if(data.msg){
				epoint.alert(data.msg);
			}
			epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
		}

		// 绘制修改按钮
		var onEditRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "editItems");
		};

		// 弹出修改窗口
		function openEdit() {
			var node = tree.getSelectedNode();
			if(!node){
				var type = "cockpit";
				var id = mini.get("cockpitguid").getValue();
			}
			else{
				var type = node.type;
				var id = node.id
			}
			epoint.openDialog("修改卡片", './cockpitmobileauthedituser?id=' + id + '&type=' + type, searchData, {
				'width' : 1000,
				'height' : 800
			});
		}

		// 删除数据
		function deleteUser() {

			epoint.confirm('确认要取消该内容的所有授权用户吗？', '', function() {
				epoint.execute('deleteUser', 'fui-form', null, function(data) {
					if (data.msg) {
						epoint.alert(data.msg, '', searchData());
						searchData();
					}
				});
			});
		}

		
		// 点击左侧树刷新右侧表格
		tree.on("nodeselect", function(e) {
			document.getElementById("contentLabel").innerHTML = "【" + e.node.text + "】的授权用户列表";
			var id = e.node.id;
			var type = e.node.type;
			mini.get("columnguid").setValue("");
			mini.get("projectcateguid").setValue("");
			mini.get("cockpitguid").setValue("");
			mini.get("projectguid").setValue("");
			mini.get("plateguid").setValue("");
			mini.get("cardcateguid").setValue("");
			mini.get("cardguid").setValue("");
			if(type == 'cockpit'){
				mini.get("cockpitguid").setValue(id);
			}
			else if(type == 'column'){
				mini.get("columnguid").setValue(id);
			}
			else if(type == 'projectcate'){
				mini.get("projectcateguid").setValue(id);
			}
			else if(type == 'project'){
				mini.get("projectguid").setValue(id);
			}
			else if(type == 'plate'){
				mini.get("plateguid").setValue(id);
			}
			else if(type == 'cardcate'){
				mini.get("cardcateguid").setValue(id);		
			}
			else if(type == 'card'){
				mini.get("cardguid").setValue(id);
			}
			epoint.refresh([ 'datagrid', 'fui-form']);
		});

	</script>
</body>
</html>