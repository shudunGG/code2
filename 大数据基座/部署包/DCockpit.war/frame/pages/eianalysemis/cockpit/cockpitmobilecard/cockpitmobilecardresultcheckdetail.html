<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>卡片数据更新详情页</title>
<!-- 请修改相对路径 -->
<script src="../../../../../frame/fui/js/cssboot.js"></script>
</head>
<style type="text/css" media="screen">
.adddprow {
	background: #eeeeee;
}

.resolution {
	width: 100%;
}

.resolution .mini-textbox {
	width: 70%;
}

.operate-minus {
	margin-left: 10px;
	border: 2px solid #DDDDDD;
	font-size: 20px;
	cursor: pointer;
}

.operate-plus {
	cursor: pointer;
}

.operate.text-center {
	margin-top: 5px;
	border: 1px dashed #DDDDDD;
}
</style>
<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>

	<!-- toolbar区域 -->
	<div class="fui-toolbar" id="toolbar">
		<div class="btn-group mr10">
			<a class="mini-button" iconCls="icon-save" id="addClose"
				onclick="saveAndClose">保存并关闭</a> <a class="mini-button"
				iconCls="icon-minuscircle" onclick="epoint.closeDialog">关闭</a>
		</div>
	</div>

	<!-- 内容区域 -->
	<div class="fui-content">
		<div class="fui-accordions" id="fui-form"
			style="margin: 0px; padding: 0px">
			<div role="accordion">
				<div role="head" title="关联指标"></div>
				<div role="body">
					<div id="datagrid" name="datagrid" class="mini-datagrid"
						idField="rowguid" multiSelect="true"
						style="width: 100%; max-height: 300px;" allowResize="false"
						showPager="true" action="getDataGridData" allowCellSelect="true"
						allowCellEdit="true" editNextOnEnterKey="true">
						<div property="columns">
							<div type="indexcolumn" width="60" headerAlign="center">序号</div>
							<div field="normname" width="200" headerAlign="center"
								align="center">指标名称</div>
							<div field="normtype" width="100" headerAlign="center"
								align="center">指标类型</div>
							<div field="source" width="100" headerAlign="center"
								align="center">来源</div>
							<div name="operate" type="actioncolumn" headerAlign="center"
								align="center" renderer="onSubit">操作
							</div>
						</div>
					</div>
				</div>
			</div>
			<div role="accordion">
				<div role="head" title="卡片描述"></div>
				<div role="body">
					<div id="fui-form" class="fui-form">
						<div role="form">
							<div id="bigscreen">
								<div role="row">
									<div role="control" label="卡片区域总结">
										<div id="bgrow">
											<div class="adddprow form-row">
												<div class="resolution">
													<span>总结区域：</span> <input class="mini-textbox cardarea"
														name="dpurl" />
												</div>
											</div>
										</div>
										<div class="operate text-center" id="addone">
											<span class="operate-plus">+ 增加一条</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script type="text/templ" id="row-tpl-2">
		<div class="adddprow form-row" >
			<div class="resolution">
				<span>总结区域：</span> <input class="mini-textbox cardarea" name="dpurl" />
			</div>
		</div>
    </script>
	<script type="text/templ" id="row-tpl-1">
		<div class="adddprow form-row" >
			<div class="resolution">
				<span>总结区域：</span> <input class="mini-textbox cardarea" name="dpurl" />
				<a class="mini-button mini-btn-danger operate-minus" iconCls="icon-minuscircle"></a>
			</div>
		</div>
    </script>
	<!-- 请修改相对路径 -->
	<script src="../../../../../rest/resource/jsboot"></script>
	<script src="../cockpitnorm/js/ace.js"></script>
	<script>
		var grid = mini.get("datagrid");
		var $bgrow = $("#bgrow");
		var rowTpl = $('#row-tpl-1').html();
		var rowTpl2 = $('#row-tpl-2').html();
		var checkGuid = Util.getUrlParams('checkGuid');
		var bigscreen;
		var canEdit = true;
		// 初始化页面
		epoint.initPage('cockpitmobilecardresultcheckdetailaction', null,
				function(data) {
					if (data.isHandlerUser == true) {
						canEdit = true;
					} else if (data.isHandlerUser == false) {
						canEdit = false;
					}
					if (data.applyStatus == '2') {
						canEdit = false;
					}
					if (!canEdit) {
						$('#toolbar').addClass('hidden');
						$('.cardarea').find("input").attr('disabled', 'true');
						$('#addone').css('display', 'none');
					}
					if (data.cardareasummary) {
						var json = JSON.parse(data.cardareasummary);
						var len = json.length;
						for (var i = 0; i < len; i++) {
							if (mini.getsbyName('dpurl').length < len) {
								// 直接将模板加到页面上
								if (data.cardModel == ''&&canEdit) {
									$bgrow.append(rowTpl);
								} else {
									$('#addone').css('display', 'none');
									$bgrow.append(rowTpl2);
								}

								// 解析里面的控件
								mini.parse($bgrow[0]);
								epoint.refresh('bgrow');
							}
							$('#bgrow').each(function() {
								mini.getsbyName('dpurl')[i].setValue(json[i]);
							});
						}
					}
				});

		function saveAndClose() {
			if (epoint.validate()) {
				var data = JSON.parse(grid.data);
				var len = data.length;
				var msg = true;
				for (var i = 0; i < len; i++) {
					var normguid = data[i].normguid;
					if (normguid == '') {
						msg = false;
					}
				}
				if (msg) {
					getScreen();
					epoint.execute('save', 'fui-form', [ bigscreen ],
							closeCallback);
				} else {
					epoint.alert('请在数据绑定模块关联好指标！');
				}
			}
		}

		function getScreen() {
			if (epoint.validate()) {
				// 拼接查询语句
				var conditionArr = [];
				$(".adddprow").each(function(i) {
					var conditionMap = {};
					var dpurl = $(this).find("input[name='dpurl']").val();
					// 输入框均未输入值则不需要拼接，输入了值需要验证并拼接
					if (i == 0 && dpurl == "") {
						bigscreen += "";
					} else {
						conditionArr.push(dpurl);
					}
				});
				bigscreen = JSON.stringify(conditionArr);
			}
		}

		// 新增操作的回调
		function closeCallback(data) {
			if (data.msg) {
				epoint.alertAndClose(data.msg);
			}
		}

		function openResult(guid) {
			epoint
					.openDialog(
							'指标数据',
							"frame/pages/eianalysemis/cockpit/cockpitmobilecard/cockpitmobilecardresultlist?checkGuid="
									+ checkGuid + "&normGuid=" + guid,
							function(data) {
								epoint.refresh('datagrid');
							}, {
								'width' : 1000,
								'height' : 550
							});
		}
		
		function onSubit(e) {
			return '<span type="action" style=\"color:blue\" onclick="openResult(\''
			+ e.row.rowguid + '\')">查看指标结果</span>';
		}
	</script>
</body>
</html>