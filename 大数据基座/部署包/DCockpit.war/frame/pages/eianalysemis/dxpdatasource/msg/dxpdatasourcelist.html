<!DOCTYPE html>
<html lang="zh-CN">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<title>数据源配置</title>
<script src="../../../../fui/js/cssboot.js"></script>
<script>
	SrcBoot.output([ "../js/chosen/chosen.css",
			"../js/pagination/mricode.pagination.css", "../css/common.css",
			"./css/common.css", "./css/data_setting.css" ]);
</script>
</head>

<body>


	<div class="main">
		<div class="fui-left" id="left">
			<div role="head" title="所有部门"></div>
			<div role="body">
				<ul id="tree" class="mini-filtertree" style="height: 100%"
					idField="id" parentField="pid" textField="text"
					resultAsTree="false" action="getOuTreeModel" filterMode="server"></ul>
			</div>
		</div>

		<div class="fui-right" id="right">
			<div class="top-area clearfix">
				<div class="left-btn-area l">
					<a id="add" class="mini-button mini-btn-primary"
						iconCls="icon-addcircle" onclick="addDataSource()">新增数据源</a>
				</div>
				<div class="right-btn-area r">
					<span class="data-name">数据源名称：</span> <input type="text"
						placeholder="请输入关键字" id="searchDataSourceName"
						class="search-input" /> <span class="data-category">数据源类别：</span>
					<select name="data-choose" id="data-choose" class="choose-category"></select>
					<!-- 				<span class="data-category">所属节点：</span>
				<select name="searchNodeName" id="searchNodeName" class="choose-category"></select> -->
					<a href="javascript:;" class="search-button btn r">搜索</a>
				</div>
			</div>
			<div class="tab">
				<ul class="tab-hd clearfix">
					<li class="panel"></li>
					<li class="grid"></li>
				</ul>
				<div class="tab-bd">
					<div>
						<div class="data-content nodata js-content">
							<ul class="sql-list clearfix"></ul>
							<div class="nodata-text">
								没有返回的数据
							</div>
						</div>
						<div id="page" class="mini-pagination" onpagechanged="onPageChanged"
							showPageSize="true" showPageIndex="true" showPageInfo="true"
							buttons="#buttons"
							style="position: absolute; bottom: 0px; right: 0;"></div>
					</div>
					<div>
						<div class="fui-form fui-condition" id="fui-form"
							style="display: none;">
							<div role="form">
								<input bind="dataSourceName" id="dataSourceName"
									class="mini-textbox" style="display: none;" /> <input
									bind="dataSourceType" id="dataSourceType" class="mini-textbox"
									style="display: none;" />
								<!-- <input bind="nodeName" id="nodeName"
										class="mini-textbox" style="display:none;"/> -->
							</div>
							<input class="mini-hidden" id="belongouguid" bind="belongouguid" />

						</div>
						<div class="fui-content mini-fit">
							<div id="datagrid" name="datagrid" class="mini-datagrid"
								idField="dsid" multiSelect="true" extraId="fui-form"
								style="width: 100%; height: 100%;" showPager="true"
								action="getDataGridData">
								<div property="columns">
									<!-- <div type="checkcolumn" width="40" headerAlign="center"></div> -->
									<div type="indexcolumn" width="60" headerAlign="center">序号</div>
									<div field="dsname" width="100" headerAlign="center"
										align="center" renderer="onNameRenderer">数据源名称</div>
									<div field="dstype" width="80" headerAlign="center"
										align="center">数据源类型</div>
									<!-- <div field="loginuser" width="80" headerAlign="center"
										align="center">登录用户</div> -->
									<div field="belongouname" name="belongouname" width="80"
										headerAlign="center" align="center">所属部门</div>
									<div field="connectionstring" width="260" headerAlign="center">连接字符串</div>
									<div field="isopen" headerAlign="center" align="center"
										width="80" renderer="changeImage">是否公开</div>
									<div field="ismyou" visible="false"></div>
									<div width="100" headerAlign="center" align="center"
										renderer="onOptionRenderer">操作</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script type="text/template" id="temp">
        {{#list}}
       <li class="sql-item" data-id="{{id}}">
           <a href="javascript:void(0);">
            <div class="clearfix">
                <div class="clearfix l">
                    <img src="images/{{src}}" alt="" class="sql-icon l" data-src="{{src}}">
                    <span class="sql-name" title="{{sqlname}}">{{sqlname}}</span>
                </div>
                
           </div>
           <ul class="detail-info">
               <li class="detail-item" title="{{type}}">数据库类型：{{type}}</li>        
               <li class="detail-item" title="{{sql}}">连接字符串：{{sql}}</li>
           </ul>
			<div class="btn-area clearfix">
                    <button class="edit-icon {{^isadmin}}{{^ismyou}}hidden{{/ismyou}}{{/isadmin}}" title="编辑">编辑</button>
					<button class="copy-icon" title="复制">复制</button>	
                    <button class="delete-icon {{^isadmin}}{{^ismyou}}hidden{{/ismyou}}{{/isadmin}} " title="删除">删除</button>
                </div>
          </a>
       </li>
      {{/list}}
    </script>
	<script type="text/template" id="temp1">
	  <option value="">请选择数据源类型</option>
      {{#list}}
       <option value="{{id}}">{{name}}</option>
      {{/list}}
    </script>
	<script type="text/template" id="temp2">
	  <option value="">请选择所属节点</option>
      {{#list}}
       <option value="{{id}}">{{name}}</option>
      {{/list}}
    </script>
	<script src="../../../../fui/js/jsboot.js"></script>

	<script>
		var param = {
			keywords : '',
			// nodename: '',
			// 数据源类型
			type : '',
			pageIndex : 0,
			pageSize : 12,
			total : 0,
			belongouguid : ''
		}
		var isadmin = false;
		var tree = mini.get("tree");
		var grid = mini.get("datagrid");
		epoint.initPage('dxpdatasourcelistaction', '', function(data) {
			if (mini.get('belongouguid').getValue() != '') {
				grid.hideColumn('belongouname');
			} else {
				grid.showColumn('belongouname');
			}
			if (data.isadmin) {
				isadmin = data.isadmin;
			}
			mini.get('page').setSizeList([12,16,20,24]);
		});

		function onPageChanged(e){
			param.pageIndex = e.pageIndex;
			param.pageSize = e.pageSize;
			RequestData(mini.get('belongouguid').getValue());
		}
		// 点击左侧树刷新右侧表格
		tree.on("nodeselect", function(e) {
			var id = e.node.id;
			if ('f9root' == id) {
				id = '';
            }
			mini.get('belongouguid').setValue(id);
			RequestData(id);
			//刷新表格
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		});

		function addDataSource() {
			epoint.openDialog('新增数据源', '../dxpdatasource', searchData, {
				'width' : 900,
				'height' : 500
			});
		}

		function onOptionRenderer(e) {
			var option = "";
			if (!isadmin) {
				if (e.row.isopen == 'true') {
					if (e.row.ismyou) {
						return '<a href="javascript:void(0);" onclick="editDataSource('
								+ "'"
								+ e.row.dsid
								+ "'"
								+ ');" >'
								+ '编辑'
								+ '</a>'
								+ '<span>&nbsp;</span>'
								+ '<a style="color: blue" href="javascript:void(0);" onclick="copyDataSource('
								+ "'"
								+ e.row.dsid
								+ "'"
								+ ');" >'
								+ '复制'
								+ '</a>'
								+ '<span>&nbsp;</span>'
								+ '<a style="color: red" href="javascript:void(0);" onclick="deleteDataSource('
								+ "'"
								+ e.row.dsid
								+ "'"
								+ ');" >'
								+ '删除'
								+ '</a>';
					} else {
						return '<a style="color: blue" href="javascript:void(0);" onclick="copyDataSource('
								+ "'"
								+ e.row.dsid
								+ "'"
								+ ');" >'
								+ '复制'
								+ '</a>' + '<span>&nbsp;</span>';
					}
				} else {
					if (e.row.ismyou) {
						return '<a href="javascript:void(0);" onclick="editDataSource('
								+ "'"
								+ e.row.dsid
								+ "'"
								+ ');" >'
								+ '编辑'
								+ '</a>'
								+ '<span>&nbsp;</span>'
								+ '<a style="color: blue" href="javascript:void(0);" onclick="copyDataSource('
								+ "'"
								+ e.row.dsid
								+ "'"
								+ ');" >'
								+ '复制'
								+ '</a>'
								+ '<span>&nbsp;</span>'
								+ '<a style="color: red" href="javascript:void(0);" onclick="deleteDataSource('
								+ "'"
								+ e.row.dsid
								+ "'"
								+ ');" >'
								+ '删除'
								+ '</a>';
					}
				}
			} else {
				return '<a href="javascript:void(0);" onclick="editDataSource('
						+ "'"
						+ e.row.dsid
						+ "'"
						+ ');" >'
						+ '编辑'
						+ '</a>'
						+ '<span>&nbsp;</span>'
						+ '<a style="color: blue" href="javascript:void(0);" onclick="copyDataSource('
						+ "'"
						+ e.row.dsid
						+ "'"
						+ ');" >'
						+ '复制'
						+ '</a>'
						+ '<span>&nbsp;</span>'
						+ '<a style="color: red" href="javascript:void(0);" onclick="deleteDataSource('
						+ "'" + e.row.dsid + "'" + ');" >' + '删除' + '</a>';
			}
			return option;
		}

		function editDataSource(id) {
			epoint.openDialog('修改数据源', "../dxpdatasource?dsid=" + id,
					searchData, {
						'width' : 900,
						'height' : 500
					});
		}

		function copyDataSource(id) {
			epoint.openDialog("复制数据源", '../dxpdatasource?dsid=' + id
					+ '&extGoal=copy', searchData, {
				'width' : 900,
				'height' : 500
			});
		}

		function callBack(param) {
			if (param) {
				epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
			}
		}

		function deleteDataSource(id) {
			epoint.confirm("确认删除吗", "提示", function() {
				epoint.execute("deleteSelected", 'datagrid', [ id ], function(
						data) {
					if (data.result === 'success') {
						epoint.alert("删除成功", "提示信息", null, "success");
					} else if (data.result === 'failed') {
						epoint.alert("删除失败", "提示信息", null, "deny");
					} else if (data.result) {
						epoint.alert(data.result, "提示信息", null, "deny");
					}
					searchData();
				});
			})
		}

		function onDetailRenderer(e) {
			return '<a href="javascript:void(0);" onclick="onDetailClick(\''
					+ e.row.dsid
					+ '\');" class="action-icon icon-search" title="查看相关集成作业"></a>';

		}

		function onNameRenderer(e) {
			return '<a href="javascript:openDetail(\'' + e.record.dsid
					+ '\')" style="color:blue;text-decoration:underline;">'
					+ e.value + '</a>';
		}

		function openDetail(guid) {
			epoint.openDialog('详细信息', "./dxpdatasourcedetail?guid=" + guid,
					searchData, {
						'width' : 1000,
						'height' : 500
					});
		}
		var changeImage = function(e) {
			if (e.row.isopen == 'true') {
				return "<img src='images/switch_true.png' title='点击不公开' style='cursor:pointer;' onclick='changeStatus(\""
						+ e.row.dsid
						+ "\",\""
						+ e.row.isopen
						+ "\",\""
						+ e.row.ismyou + "\");' />";
			} else {
				return "<img src='images/switch_false.png' title='点击公开' style='cursor:pointer;' onclick='changeStatus(\""
						+ e.row.dsid
						+ "\",\""
						+ e.row.isopen
						+ "\",\""
						+ e.row.ismyou + "\");' />";
			}

		};
		function changeStatus(id, isopen, ismyou) {
			if (!isadmin && !ismyou) {
				epoint.alert("没有权限修改");
				return;
			}
			epoint.confirm('确认修改公开状态？', '确认',
					function() {
						epoint.execute("changeStatus", "", [ id, isopen ],
								msgcallBack);
					});
		}
		function msgcallBack(data) {
			if (data.msg) {
				epoint.alert(data.msg, '', function() {
					epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
				}, 'info');
			}
		}
	</script>
	<script>
		var interfaceName = epoint
				.dealRestfulUrl("../../../../../rest/dxpdatasourcelistaction/getDataSourceList");
		var interfaceSourceTypeName = epoint
				.dealRestfulUrl("../../../../../rest/dxpdatasourcelistaction/getSourceTypeList");
		/* 		var interfaceNodeName = epoint
		 .dealRestfulUrl("../../../../../rest/dxpdatasourcelistaction/getNodeNameList"); */
	</script>
	<script>
		SrcBoot.output([ "../js/jquery-tab.js",
				"../js/pagination/mricode.pagination.js",
				"../js/chosen/chosen.jquery.min.js",
				"frame/fui/js/libs/mustache.min.js",
				"../js/jquery.nicescroll.min.js",
				// "./_test/test_setting.js",
				"../js/common.js", "./js/data_setting.js" ]);
	</script>
	<script>
		function searchData() {
			RequestData(mini.get('belongouguid').getValue());
			mini.get('datagrid').reload();
		}
	</script>
</body>

</html>