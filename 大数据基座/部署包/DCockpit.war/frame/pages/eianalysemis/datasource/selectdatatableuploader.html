<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>导入文件选择</title>
<!-- 请修改相对路径 -->
<script src="../../../fui/js/cssboot.js"></script>
</head>

<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>
	<!-- toolbar区域 -->

	<!-- 内容区域 -->
	<div class="fui-content">
		<div id="fui-form" class="fui-form">
			<div role="form">
				<div role="row"></div>
				<div role="row"></div>
				<div role="row">
					<div role="control" label="下载导入模版">
						<a class="mini-button" style="float: left; width: 15%" onclick="exportModel()" iconCls="icon-download">导入模版</a>
					</div>
				</div>
				<div role="row">
					<div role="control" label="选择导入文件" starred="true">
						<span id="filename" class="mini-textbox" width="74%"
							style="margin-right: 2px" required="true" allowInput="false"></span>
						<div id="uploader" class="mini-webuploader" pickerText="浏览"
							action="getFileUploadModel" limitType="csv,txt" auto="true"
							fileNumLimit="1" onfilesuccess="UploadSuccess"
							showDefaultUI="false" style="float: left; width: 25%;"
							visible="false" onbeforeFileQueued="checkfiletxtorcsv"
							onuploadbeforesend="onUploadBeforeSend"></div>
						<div id="uploaderexcel" style="float: left; width: 25%"
							class="mini-webuploader" pickerText="浏览"
							action="getDataImportModel9" limitType="xls,xlsx"
							fileNumLimit="1" dataImport="true"
							onfilesuccess="UploadSuccessExcel" auto="true" duplicate="true"
							showDefaultUI="true"></div>
					</div>
				</div>
				<div role="row">
					<div role="control" label="文件类型" starred="true">
						<div id="rbl" class="mini-radiobuttonlist" repeatItems="1"
							repeatLayout="table" repeatDirection="vertical" textField="text"
							valueField="id" value="xls;xlsx"
							data="[{text:'Excel文件(.xls和.xlsx)',id:'xls;xlsx'},{text:'文本文件(.txt)',id:'txt'},{text:'csv文件',id:'csv'}]"
							onvaluechanged="onFileType"></div>
					</div>
				</div>

				<div role="row" style="display: none" id="isheadshow">
					<div role="control" label="数据含列头" starred="true">
						<div id="islietou" class="mini-checkbox" checked="true"
							readOnly="false"></div>
					</div>
				</div>

				<div role="row" id="rowfengefu">
					<div role="control" label="字段分隔符" starred="true">
						<input id="fenggefu" class="mini-combobox" width="20%"
							required="true"
							data="[{'id':'1','text':'空格'},{'id':'2','text':'制表符(\\t)'},{'id':'3','text':'管线分隔符(|)'},{'id':'4','text':'逗号(,)'},{'id':'5','text':'自定义'}]"
							value="4" onvaluechanged="onFengGeChange" /> <input
							id="customfengge" style="display: none; margin-left: 5px"
							class="mini-textbox" width="20%" />
					</div>
				</div>
			</div>
		</div>
	</div>
	<form id="download_form" method="post" enctype="multipart/form-data">
	</form>
	<!-- 请修改相对路径 -->
	<script src="../../../fui/js/jsboot.js"></script>
	<script>
		// 初始化页面
		epoint.initPage('eiadatatablebasicinfolistaction', null, function(ret) {
			if (mini.get("rbl").getValue() == 'xls;xlsx') {
				$("#rowfengefu").hide();
			}
		});

		function UploadSuccess(args) {
			mini.get('filename').setValue(args.data.extraDatas.filename);
			if (args.data.extraDatas.errmsg) {
				mini.alert(args.data.extraDatas.errmsg);
			}
			if (args.data.extraDatas.success) {
				epoint.closeDialog();
				epoint.openTopDialog('确认导入',
						'frame/pages/eianalysemis/datasource/datatableuploader?uuid='
								+ args.data.extraDatas.uuid, callback, {
							'width' : 700,
							'height' : 550
						});
			}
		}

		function UploadSuccessExcel(args) {
			/* 	epoint.openTopDialog('导入数据', 'frame/pages/eianalysemis/datasource/datatableuploader?name=' + data.data.extraDatas.name, callback, {
					'width' : 700,
					'height' : 550
				}); */
			if (args.data.extraDatas.errmsg) {
				mini.alert(args.data.extraDatas.errmsg);
			}
			if (args.data.extraDatas.success) {
				epoint.alertAndClose(args.data.extraDatas.success, null, null,
						'info');
			}
			callback();
		}

		function callback() {
			epoint.clear('fui-form');// 清空表单
		}

		function onFileType() {
			if (mini.get("rbl").getValue() == 'xls;xlsx') {
				// $("#uploader").css('visibility','hidden');
				mini.get('uploader').setVisible(false);
				$("#isheadshow").hide();
				$("#rowfengefu").hide();
				// $("#uploaderexcel").css('visibility','hidden');
				mini.get('uploaderexcel').setVisible(true);
			} else {
				// $("#uploaderexcel").hide();
				// $("#uploader").show();
				$("#isheadshow").show();
				$("#rowfengefu").show();
				mini.get('uploader').setVisible(true);
				mini.get('uploaderexcel').setVisible(false);
			}
		}

		function onFengGeChange() {
			if (mini.get("fenggefu").getValue() == '5') {
				$("#customfengge").show();
			} else {
				$("#customfengge").hide();
			}
		}

		function checkfiletxtorcsv(e) {
			var selectfiletype = mini.get("rbl").getValue();
			if (selectfiletype.indexOf(e.file.ext) == -1) {
				e.cancel = true;
				epoint.alert("上传文件类型与所选文件类型不一致!");
			}
			if (mini.get("fenggefu").getValue() == '5'
					&& !mini.get("customfengge").getValue()) {
				e.cancel = true;
				epoint.alert("自定义分隔符不能为空!");
			}
		}

		//在文件上传时想要附带参数
		function onUploadBeforeSend(e) {
			e.data.fenggefu = mini.get("fenggefu").getValue();
			e.data.customfengge = mini.get("customfengge").getValue();
			e.data.islietou = mini.get("islietou").getValue();
		}
		
		//模板下载
		function exportModel() {
			var data = {};
			var downloadurl= "eiadatatablebasicinfolistaction.action?cmd=downloadModel";
			var form = document.getElementById("download_form");
			DownLoadFile({
				url : downloadurl,
				data : data
			});
			}
				    
			var DownLoadFile = function(options) {
			var config = $.extend(true, {method : 'post'}, options);
			var $iframe = $('<iframe id="down-file-iframe" />');
			var $form = $('<form target="down-file-iframe" method="' + config.method + '" />');
			$form.attr('action', config.url);
			for ( var key in config.data) {
			$form.append('<input type="hidden" name="' + key + '" value="' + config.data[key] + '" />');
			}
			$iframe.append($form);
			$(document.body).append($form);
			$form[0].submit();
			$form.remove();
		}
	</script>
</body>
</html>