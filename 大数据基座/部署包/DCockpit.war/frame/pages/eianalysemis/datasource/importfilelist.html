
<!DOCTYPE html>
<html>

<head>
<title>数据管理</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />

<script src="../../../fui/js/cssboot.js"></script>
</head>

<body>
	<div class="page-loading"></div>


	<!-- toolbar区域 -->
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<a class="mini-button" iconCls="icon-upload" onclick="importfile()">导入数据</a>
		</div>
	</div>
	<div class="fui-condition">
		<!-- 表单布局 -->
		<div class="fui-form" id="fui-form">
			<div role="form">
				<!-- 2列 -->
				<div role="row">
					<div role="control" label="数据名称" starred="false">
						<input bind="tableName" id="tableName" class="mini-textbox" />

					</div>
					<div role="control" label="数据代码">
						<input bind="sqlTableName" id="sqlTableName" class="mini-textbox" />
					</div>
				</div>
				<!-- 添加隐藏域，用于树与表格的联动  -->
				<input bind="treecategorynum" id="treecategorynum"
					class="mini-hidden" />
			</div>
		</div>
		<!-- 搜索按钮 -->
		<a role="searcher" callback="searchData"></a>
	</div>
	<div class="fui-content">
		<div id="datagrid" class="mini-datagrid" sortOrder="desc"
			idField="tableid" multiSelect="true"
			style="width: 100%; height: 100%;" allowResize="true"
			allowCellValid="true" action="getTableData" showPager="true"
			allowCellEdit="true" allowCellSelect="true" editNextOnEnterKey="true"
			editNextRowCell="true">
			<div property="columns">
				<div type="checkcolumn" width="20"></div>
				<div type="indexcolumn" headerAlign="center" width="20">序</div>
				<div field="TableName" width="80" headerAlign="center"
					vtype="required">
					数据名称 <input property="editor" class="mini-textbox"
						style="width: 99%" />
				</div>
				<div field="Sql_TableName" width="80" headerAlign="center">数据代码</div>
				<div field="tabletypezn" width="40" headerAlign="center"
					align="center">类型</div>
				<div width="40" headerAlign="center" align="center"
					renderer="onEditRenderer">修改</div>
				<div width="40" name="show" headerAlign="center" align="center"
					renderer="onShowRenderer">数据结构</div>
				<div width="40" headerAlign="center" align="center"
					renderer="onDataRenderer">查看数据</div>
				<div field="tabletype" visible="false"></div>
				<div field="dsid" visible="false"></div>
			</div>
		</div>
	</div>
	<script src="../../../fui/js/jsboot.js"></script>
	<script>
		//<![CDATA[  
		//初始化页面
		epoint.initPage("eiadatatablebasicinfolistaction");

		var grid = mini.get("datagrid");
		grid.on("load", function(e) {
			var rows = e.sender.findRows();
			for (var i = 0; i < rows.length; i++) {
				grid.beginEditRow(rows[i]);
			}
		});

		// 绘制修改按钮
		var onEditRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "openEdit",
					"tableid,tabletype");
		};

		// 绘制授权按钮
		var onSqRenderer = function(e) {
			return epoint
					.renderCell(e, "action-icon icon-gear", "setViewRight");
		};

		//修改
		function openEdit(e) {
			var config = epoint.decodeJson(e);
			if (config.tabletype == 3) {
				epoint.openDialog('修改实体',
						'frame/epointmis/backend/TableBasicViewEdit?tableID='
								+ config.tableid, function() {
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						}, {
							'width' : 1000,
							'height' : 400
						});
			} else if (config.tabletype == 5) {
				epoint.openDialog('修改填报表',
						'frame/epointmis/backend/FillInTableEdit?tableID='
								+ config.tableid, searchData, {
							'width' : 1200,
							'height' : 550
						});
			} else {
				epoint.openDialog('修改数据表',
						'frame/pages/eianalysemis/datasource/tablebasicinfoedit?tableID='
								+ config.tableid, function() {
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						}, {
							'width' : 1000,
							'height' : 400
						});
			}
		}

		// 授权
		function setViewRight(tableID) {
			epoint.openDialog('设置数据表权限',
					'framemanager/metadata/mis/tableinfo/settingviewright?tableID='
							+ tableID, searchData, {
						'width' : 700,
						'height' : 550
					});
		}

		// 绘制表结构按钮
		var onShowRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-doc", "tableStruct",
					"tableid,tabletype");
		};

		//绘制查看数据按钮
		var onDataRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-search",
					"searchRecord");
		}

		//绘制查看数据按钮
		var removeRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-forward",
					"removeCatelog", "dsid,tableid");
		}

		function removeCatelog(e) {
			epoint.openDialog('采集目录编辑',
					"frame/pages/eianalysemis/datasource/removecategory?treecategorynum2="
							+ e.dsid + ",0&tableid=" + e.tableid, searchData, {
						'width' : 1000,
						'height' : 500
					});
		}

		//查看数据
		function searchRecord(id) {
			epoint.openTopDialog('数据列表',
					'framemanager/metadata/datamanager/viewtabledata?tableID='
							+ id, function(ret) {

					});
		}

		// 表结构
		function tableStruct(e) {
			var config = epoint.decodeJson(e);
			if (config.tabletype == 3) {
				epoint.openDialog('实体结构',
						'frame/epointmis/backend/TableStructViewList?tableID='
								+ config.tableid, function() {
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						}, {
							'width' : 1200,
							'height' : 550
						});
			} else {
				epoint.openDialog('数据表结构',
						'frame/pages/eianalysemis/datasource/tablestructlist?tableID='
								+ config.tableid, function() {
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						});
			}
		}
		// 回调刷新
		function callBack(param) {
			if (param) {
				searchData2();
			}
		}

		// 采集数据对象
		function saveAndClose() {
			if (!mini.get('treecategorynum').getValue()
					|| !mini.get('treecategorynum').getValue().split(",")[0]) {
				epoint.alert('请选择数据分类！');
			}

			else {
				epoint.openTopDialog('采集元数据',
						'framemanager/metadata/datamanager/datatableselect?dsID='
								+ mini.get('treecategorynum').getValue().split(
										",")[0], callback, {
							'width' : 700,
							'height' : 550
						});
			}
		}

		// 删除
		function deleteSelected() {
			epoint.execute('deleteSelected', '', function(data) {
				if (data.msg) {
					epoint.alert(data.msg);
					searchData();
				}
			});
		}

		// 回掉提醒
		function msgCallBack(data) {
			var msg = data.msg;
			if (msg) {
				if (msg.indexOf("成功") == -1) {
					epoint.alert(msg, '', '', 'warning');
					searchData();
				} else {
					epoint.alert(msg);
					searchData();
				}
			}
		}

		// 表格的搜索
		function searchData() {
			epoint
					.refresh([ 'datagrid', 'treecategorynum', 'fui-form',
							'tree' ]);
		}

		function searchData2() {
			epoint.refresh([ 'datagrid', 'treecategorynum', 'fui-form' ], '',
					true);
		}

		//禁止选中父节点  --是否需要禁止选中父节点
		function beforenodeselect(e) {
			var id = e.node.id;
			if (id == '') {
				e.cancel = true;
			}
		}

		//新增数据表
		function addTable() {
			epoint.openDialog('添加数据表',
					'frame/pages/eianalysemis/datasource/tablebasicinfoadd',
					function() {
						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
					}, {
						'width' : 1000,
						'height' : 450
					});
		}

		// 保存信息
		function saveAll() {
			if (mini.get('datagrid').isValid()) {
				console.log(grid.getData());
				epoint.execute('saveAll', [ 'datagrid', 'fui-form' ],
						msgCallBack);
			} else {
				epoint.alert('表中文名称不允许为空,排序号长度不允许超过5位!', '', null, 'warning');
			}
		}

		function callback(param) {
			if ("close" == param) {
				searchData2();
			} else {
				searchData();
			}
		}

		function updateTableTree() {
			epoint.refresh([ 'tree' ]);
		}

		function onUploadBeforeSend(obj, data, headers) {
			var dsID = mini.get("treecategorynum").getValue();
			obj.data.dsID = dsID;
		}

		//刷新数据源
		function refreshSource() {
			epoint.refresh([ 'tree', 'isShow' ]);
		}

		//导入文件
		function importfile() {
			epoint
					.openTopDialog(
							'导入数据选择',
							'frame/pages/eianalysemis/datasource/selectdatatableuploader',
							searchData, {
								'width' : 700,
								'height' : 550
							});
		}

		//同步表结构
		function synctablestruct() {
			var datagrid = mini.get('datagrid');
			var ids = datagrid.getSelectedIds();
			if (ids.length > 0) {
				epoint.confirm("确定同步表结构？", "", function(action) {
					epoint.execute(
							"eiadatatablebasicinfolistaction.synctablestruct",
							"", [ ids.join(',') ], function(data) {
								if (data) {
									epoint.alert(data, null, null, 'info');
									searchData();
								}
							});
				});
			} else {
				epoint.alert("请选择要同步的表!", null, null, 'warning');
			}
		}

		function editcategory() {
			var treecategorynum2 = mini.get('treecategorynum').getValue();
			if (!treecategorynum2 || treecategorynum2.split(",")[1] == '-1') {
				epoint.alert("请选择到数据源根目录进行编辑！");
			} else {
				epoint.openDialog('采集目录编辑',
						"frame/pages/eianalysemis/datasource/editcategory?treecategorynum2="
								+ treecategorynum2, searchData, {
							'width' : 1000,
							'height' : 500
						});
			}
		}
		//_$t
	</script>

</body>
</html>