/*!
  新点研发平台
  author:jiangqn
  date: 2019-09-23
  version: 1.0.0
 */var $main=$('#main'),$loading=$('#loading');var menuData=[],quickMenuList=[],menuWidth=185;(function(win,$){win._datamanagerEvent_=new Util.UserEvent();var $coverContainer=$('#cover-wrap');if(Util.browsers.isIE&&window.hasObjectTag){win.createMainContentCover=function(){var iframe=document.createElement('iframe');iframe.width='100%';iframe.height='100%';iframe.scrolling='no';iframe.frameBorder=0;iframe.style.background='transparent';iframe.src='../../activexcover/activexcover.html';var $cover=$('<div class="main-content-cover hidden"></div>');return $cover.append(iframe).appendTo($coverContainer);};}else{win.createMainContentCover=function(){var $cover=$('<div class="main-content-cover hidden"></div>');return $cover.appendTo($coverContainer);};}win._getData_=function(method,params){return Util.ajax({url:epoint.dealRestfulUrl(getDataUrl+'/'+method),data:params});};win.dealLinkOpen=function(linkData){switch(linkData.openType){case'tabsnav':TabsNav.addTab(linkData);break;case'dialog':epoint.openTopDialog(linkData.name,Util.getRightUrl(linkData.url));break;case'blank':win.open(Util.getRightUrl(linkData.url),linkData.id);break;default:break;}};win._ANIMATION_TIME_={slide:200};win.useWebsocket=Util.getFrameSysParam('useWebsocket')===true;win.eWebSocket=undefined;win.creatWebSocket=function(uid,uname,callback){if(eWebSocket){callback&&callback();return;}var cfg=win.EWebSocketConfig?win.EWebSocketConfig:{url:EmsgConfig.websocketUrl};cfg.uid=uid;cfg.uname=uname;if(win.EWebSocket){eWebSocket=new EWebSocket(cfg);callback&&callback();_datamanagerEvent_.fire('websocketCreated');}else{Util.loadJs('frame/fui/js/widgets/ewebsocket/ewebsocket.js',function(){eWebSocket=new EWebSocket(cfg);callback&&callback();_datamanagerEvent_.fire('websocketCreated');});}};win.getTplHtml=function(id,data){var tpl=$('#'+id).html();Mustache.parse(tpl);return Mustache.render(tpl,data);}if(!String.prototype.includes){String.prototype.includes=function(search,start){'use strict';if(typeof start!=='number'){start=0;}if(start+search.length>this.length){return false;}else{return this.indexOf(search,start)!==-1;}};}})(this,jQuery);(function(win,$){if(Object.prototype.toString.call(win.EpTabsNav)==='[object Function]'){window.TabsNav=new EpTabsNav({ifrContainer:'#main-ifr-wrap',tabContainer:'#main-tab-wrap',needScrollBtn:false,scrollBtnSite:'sides',smoothItems:3,refreshOnActiveTab:Util.getFrameSysParam('refreshOnActiveTab')||false,needQuickNav:true,position:'top',tabWidth:117,menuLinked:true,});TabsNav._$pageCover=createMainContentCover();}else{console.error('The TabsNav is required! , please add the "fui/pages/tabsnav/tabsnav.js" before theme\'s javascript file');}})(this,jQuery);(function(win,$){var $userInfo=$('#user-info'),$userPortrait=$('.user-portrait',$userInfo),$userActionPanel=$('#user-action-panel');var $cover=createMainContentCover();$userInfo.on('click','.user-info-summary',function(){if(!$userInfo.hasClass('active')){$userInfo.addClass('active');$userActionPanel.slideDown();$cover.removeClass('hidden');}else{$userInfo.removeClass('active');$userActionPanel.slideUp();$cover.addClass('hidden');}}).on('click','.user-action-item',function(){var $this=$(this);if($this.hasClass('person-info')){TabsNav.addTab({id:this.getAttribute('data-id'),name:this.getAttribute('data-name'),url:this.getAttribute('data-url')});}else if($this.hasClass('logout')){mini.confirm('您确定要退出系统吗？','系统提示',function(action){if(action=='ok'){eWebSocket&&eWebSocket.close();UserSettings.logout();}});}else if($this.hasClass('role-change')){UserSettings.changeRole(_userGuid_);}else{var openType=$this.data('opentype'),id=$this.data('id'),url=$this.attr('url'),name=$this.text(),script=$this.attr('script');if(!id){id=Util.uuid();$this.data('id',id).attr('data-id',id);}if(url){dealLinkOpen({id:id,openType:openType,name:name,url:url});}else if(script){try{eval(script);}catch(error){console.error(error);}}}$userInfo.removeClass('active');$cover.addClass('hidden');});$('body').on('click',function(e){if(!$(e.target).closest('#user-info,#user-action-panel').length){$userInfo.removeClass('active');$userActionPanel.slideUp();$cover.addClass('hidden');}});Util.ajax({url:getUserInfoUrl,}).done(function(data){win._userName_=data.name;win._userGuid_=data.guid;win._msgcenterConfig_=$.extend({},MsgCenterConfig,{isMsgCenterMaxSize:data.isMsgCenterMaxSize||false,msgCenterOrder:data.msgCenterOrder||"asc",hideCallback:function(){$cover.addClass('hidden');}})if(useWebsocket){creatWebSocket(_userGuid_,_userName_);}if(data.portrait){var url=Util.getRightUrl(epoint.dealRestfulUrl(data.portrait));$userPortrait.attr('src',url+"&t="+Math.random());}if(data.hasParttime){$userInfo.find('.user-action-item.role-change').removeClass('hidden');}var $userInfoDetail=$('#user-info-detail');$userInfoDetail.find('.user-name').text(data.name).attr('title',data.name);$userInfoDetail.find('.user-dept').text(data.ouName).attr('title',data.ouName);})function dealData(homes,defaultHome){var home={closeIcon:false,refresh:true};var signleHomes=[];for(var i=0;i<homes.length;i++){var cate=homes[i];var finded=false;if(cate.items!=undefined){!finded&&$.each(cate.items,function(j,item){if(defaultHome){if(item.code==defaultHome){home.id=item.code||'home';home.url=item.url;home.name=item.name;finded=true;return false;}}else{if(item.openType=='tabsnav'){home.id=item.code||'home';home.url=item.url;home.name=item.name;finded=true;return false;}}});}else{if(!finded){if(defaultHome){if(cate.code==defaultHome){home.id=cate.code||'home';home.url=cate.url;home.name=cate.name;finded=true;}}else{if(cate.openType=='tabsnav'){home.id=cate.code||'home';home.url=cate.url;home.name=cate.name;finded=true;}}}signleHomes=signleHomes.concat(homes.splice(i,1));i--;}}var outputHomes=[{code:'signleHomes',name:'默认分类',items:signleHomes}];$.each(homes,function(i,item){outputHomes.push(item);});return{homes:outputHomes,home:home};}_getData_('getPageInfo').done(function(data){if(data.title){document.title=data.title;win.systemTitle=data.title;$("#ei-logoname").html(data.title);}if(data.logo){$("#ei-logo").attr('src',/^data:/i.test(data.logo)?data.logo:Util.getRightUrl(data.logo));}if(data.fullSearchUrl){win._fullSearchUrl_=data.fullSearchUrl;}var newdata=dealData(data.homes,data.defaultHome);TabsNav.addTab(newdata.home);_datamanagerEvent_.fire('afterPageInfo');});$(win).on('message',function(e){try{var data=JSON.parse(e.originalEvent.data);if(data.type==='userPortraitChange'){$userPortrait.attr('src',data.imgData);}}catch(error){}});var EXT_TAB_TPL='<li class="user-action-item" title="{{name}}" url="{{url}}" data-opentype="{{openType}}" script="{{script}}"><span class="{{icon}}"></span>{{name}}</li>';_getData_('getExtTabsInfo').done(function(data){if(data&&data.length){var html='';$.each(data,function(i,item){item.icon=item.icon||'modicon-8';if(/^icon-/.test(item.icon)){item.icon='action-icon '+item.icon;}html+=Mustache.render(EXT_TAB_TPL,item);});$(html).insertAfter('#person-info-setting');}});})(this,jQuery);window.OpenEMsg=function(sessionid,uid,type){if(window.eMsg){if(typeof uid==='undefined'){eMsg.open(sessionid);}else{eMsg.openSession(sessionid,uid,type);}}else{creatWebSocket(_userGuid_,_userName_,function(){eWebSocket.openEmsg(sessionid,uid,type);});}};(function(win,$){var SOUND_URL='../../msgsound/sound.html',ROLLER_TEXT='您有新消息提醒，请点击查看！',rollerTip=ROLLER_TEXT,timer=0,title='';var rollDocTitle=function(){title=win.systemTitle||document.title;document.title=rollerTip;clearTimeout(timer);timer=setTimeout(function roll(){document.title=rollerTip.substring(1,rollerTip.length)+rollerTip.substring(0,1);rollerTip=document.title;timer=setTimeout(roll,300);},300);};var restoreDocTitle=function(){clearTimeout(timer);document.title=title||document.title;rollerTip=ROLLER_TEXT;};var docTitle={roll:rollDocTitle,stop:restoreDocTitle};var $msgSound=$('#msg-sound'),$soundIframe,msgAudio;if(Util.browsers.isIE){$soundIframe=$('<iframe src="" frameborder="0" class="hidden" id="msgcenter-sound"></iframe>').appendTo($msgSound);}else{$msgSound.html('<audio id="msgcenter-sound-audio" controls="controls" src="../../msgsound/newsms.wav" class="hidden-accessible"></audio>');msgAudio=document.getElementById('msgcenter-sound-audio');}var parseNum=function(num){var n=parseInt(num,10);if(n>99){return'99+';}else if(n<=0){return'';}return n+'';};var $topActionList=$('#header-action-btns'),$remindNum=$('.remind-num',$topActionList),$eMsgNum=$('.emsg-num',$topActionList),$msgPanel=$('#msg-panel'),$msgRemind=$('#msgRemind',$msgPanel),$msgRemindContent=$('.msg-panel-content',$msgRemind);var $msgEMsg=$('#msgEMsg',$msgPanel),$msgEMsgContent=$('.msg-panel-content',$msgEMsg),$msgEMsgRecent=$('.emsg-recent-list',$msgEMsgContent),$onlineUserNum=$('.online-user-num',$msgEMsg),onlineUserIframe=document.getElementById('online-user');var remindTips={show:function(){if(RemindTipsCfg.show){this.autoHide();}},autoHide:(function(){if(RemindTipsCfg.timeout!=0){return function(){clearTimeout(remindTips.timer);remindTips.timer=setTimeout(function(){},RemindTipsCfg.timeout);};}return function(){};}()),initEvent:function(){}};remindTips.initEvent();var getMsgCount=function(inCache){var data={haseXun:true,needNum:true};if(inCache){data.inCache=true;}return _getData_('getMsgCount',data).done(function(data){updateMsgCount(data);});};var updateMsgCount=function(data){var old=0,hasNew=false;if(data.remind){old=parseInt($remindNum.data('num'),10)||0;if(data.remind>old){hasNew=true;remindTips.show();}$remindNum.removeClass('hidden').text(parseNum(data.remind));$remindNum.data('num',data.remind);}else{$remindNum.text('').addClass('hidden');}if(data.eXun){old=parseInt($eMsgNum.data('num'),10)||0;if(data.eXun>old){hasNew=true;}$eMsgNum.removeClass('hidden').text(parseNum(data.eXun));$eMsgNum.data('num',data.eXun);}else{$eMsgNum.text('').addClass('hidden');}if(hasNew){if(Util.getFrameSysParam('messageSound')!==false){if(Util.browsers.isIE){$soundIframe[0].src=Util.getRightUrl(SOUND_URL+'?_='++new Date());}else{try{msgAudio&&msgAudio.play()['catch'](function(){var speechSU=new window.SpeechSynthesisUtterance();speechSU.text='您有新短消息，请注意查收！';window.speechSynthesis.speak(speechSU);});}catch(err){}}}docTitle.roll();}else{docTitle.stop();}};_datamanagerEvent_.on('afterPageInfo',function(){getMsgCount();if(!useWebsocket){setInterval(function(){getMsgCount(true);},60000);}});if(useWebsocket){_datamanagerEvent_.on('websocketCreated',function(){eWebSocket.socketEvent.on('messagecount',function(e){updateMsgCount(e.data);});});}win.getMessageCount=getMsgCount;var messageList;function initMessageList(){messageList=new MessageList({container:$msgRemindContent,getUrl:epoint.dealRestfulUrl(getDataUrl+'/getMsgData'),ignoreUrl:epoint.dealRestfulUrl(getDataUrl+'/ignoreRemind'),afterOpenMsg:function(){hidePanel();},afterIgnore:function(){getMsgCount();}});}if(!win.MessageList){Util.loadJs('../../../js/widgets/messagelist/messagelist.js',function(){initMessageList();});}else{initMessageList();}var decreaseEmsgCount=function(){var cnt=$eMsgNum.text();if(cnt){cnt=parseInt(cnt,10)-1;}if(cnt==0){cnt='';$eMsgNum.data('num',0).addClass('hidden');}$eMsgNum.text(cnt);};var emsgList;function initEMsgList(){emsgList=new EMsgList({content:$msgEMsgRecent,getUrl:EmsgConfig.baseUrl,ignoreUrl:EmsgConfig.baseUrl,userImg:EmsgConfig.userImg,groupImg:EmsgConfig.groupImg,afterOpenEMsg:function(){hidePanel();},onDecEmsgCount:decreaseEmsgCount});win.RefreshEMsg=$.proxy(emsgList.getData,emsgList);}if(!win.EMsgList){Util.loadJs('../../../js/widgets/emsglist/emsglist.js',function(){initEMsgList();});}else{initEMsgList();}if(win.OnlineUserSettings&&win.OnlineUserSettings.show){$msgEMsg.find('.msg-panel-head').addClass('tab').find('.panel-hd-tab.hidden').removeClass('hidden');$msgEMsg.on('click','.panel-hd-tab',function(){var $this=$(this),ref=$this.data('ref'),hasShow=$this.data('hasShow'),$content=$msgEMsgRecent;if(!$this.hasClass('active')){$this.addClass('active').siblings().removeClass('active');if(ref){$content=$('#'+ref,$msgEMsgContent);if(!hasShow){setTimeout(function(){OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count);});$this.data('hasShow',true);},10);}}$content.removeClass('hidden').siblings().addClass('hidden');}});}function hidePanel(){$cover.addClass('hidden');$msgPanel.stop(true).animate({right:-350},function(){$msgPanel.addClass('hidden');});$topActionList.find('[data-ref].active').removeClass('active');}win.hideMessagePanel=hidePanel;var $cover=createMainContentCover();var msgCenter;win.messageCenter={refresh:function(){if(msgCenter){msgCenter.refresh();}}}$topActionList.on('click','[data-ref]',function(){var $el=$(this),ref=$el.data('ref'),$panel=$('#'+ref,$msgPanel);if($el.hasClass('active')){hidePanel();$cover.addClass('hidden');}else{$el.addClass('active').siblings('.active').removeClass('active');if(ref=='msgRemind'){if(!msgCenter){msgCenter=new MsgCenter(_msgcenterConfig_);}msgCenter.show();hideMessagePanel();return;}else if(ref=='msgEMsg'){emsgList.getData();if(win.OnlineUserSettings&&win.OnlineUserSettings.show){if(!onlineUserIframe.src){onlineUserIframe.src=OnlineUserSettings.url;if(onlineUserIframe.attachEvent){onlineUserIframe.attachEvent("onload",function(){OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count);});});}else{onlineUserIframe.onload=function(){OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count);});};}}else{OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count);});}}}else if(ref=='msgSkin'){win.initSkinView&&win.initSkinView();}$panel.removeClass('hidden').siblings('.msg-panel-detail').addClass('hidden');$panel.find('.msg-panel-content').removeClass('hidden');$msgPanel.removeClass('hidden');$msgPanel.stop(true).animate({right:0});$cover.removeClass('hidden');}});$msgPanel.on('click','.msg-panel-hide',function(){hidePanel();});$('body').on('click',function(e){var $target=$(e.target);if(!$target.closest('#msg-panel , .header-action-btn[data-ref]').length){hideMessagePanel();}});})(this,jQuery);(function(win,$){var $header=$('.header-container');var $topSearch=$('#top-search').addClass('invisible');function doSearch(type,kw){type=type||'all';try{TabsNav.removeTab('fullsearch');}catch(error){}TabsNav.addTab({id:'fullsearch',name:'全文检索',url:win._fullSearchUrl_+'?wd='+win.encodeURI(kw)+'&type='+type});}var isCateDataLoaded=false;var cateData=[{id:'all',name:'全文检索',iconCls:'modicon-25'}];function getCateData(){return Util.ajax({url:win.fullSearchCateUrl}).done(function(data){var categories=data.categories||[];if(typeof categories=='string'){categories=JSON.parse(categories);}var cates=[];$.each(categories,function(i,item){cates.push({id:item.guid,name:item.name,iconCls:item.icon||'view'});});if(cates.length){cateData=cates;cs&&cs.setOpt('category',cateData);}isCateDataLoaded=true;});}var cs;function initTopFullSearch(){ClassifySearch._styleLoaded=true;ClassifySearch._$pageCover=createMainContentCover();cs=new ClassifySearch({id:'header-search',searchTarget:'内容',category:cateData,placeholder:'请输入',maxShowCharacter:5,enter:function(id,key){doSearch(id,key);},focus:function(){if(!isCateDataLoaded){getCateData();}}});setTimeout(function(){$topSearch.removeClass('invisible');},200);}_datamanagerEvent_.on('afterPageInfo',function(){if(win._fullSearchUrl_){initTopFullSearch();$header.addClass('has-search');}else{$header.removeClass('has-search');}_datamanagerEvent_.fire('headerSearchLoad');});})(this,jQuery);(function(win,$){var $menuTrigger=$('#menu-trigger'),$globalMenu=$('#global-menu'),$quickMenuList=$('#quick-menu-list'),$allMenuSearch=$('#all-menu-search'),$allmenuSearchInput=$('#allmenu-search-input'),$allMenuBody=$('#all-menu-body'),$allMenu=$('#all-menu'),$allMenuBox=$('#all-menu-box'),$cover=createMainContentCover();var quickMenuFlag=false,menuDataFlag=false,_QUICK_DELAY_TIME_=500,_ALL_MENU_BOX_ENTER_DELAY_=200,_ALL_MENU_BOX_LEAVE_DELAY_=600;function waterfall(){var hArr=[];$('.all-menu-block',$allMenuBody).each(function(i,item){var $item=$(item);if(i<3){if(i===0){$item.css({top:'10px',left:0})}else{$item.css({top:'10px',left:(menuWidth*i)+'px'})}hArr.push($item.outerHeight()+10);}else{var min=getMin(hArr);if(min===0){$item.css({top:(min.num+30)+'px',left:0})}else{$item.css({top:(min.num+30)+'px',left:(menuWidth*min.index)+'px'})}hArr[min.index]=$item.outerHeight()+min.num+30;}})}function getMin(arr){var num=0,index=0;arr.forEach(function(item,i){if(i===0){num=item;}else if(i!==0&&item<num){num=item;index=i;}})return{num:num,index:index}}function renderQuickMenu(){var quickMenuData=[];quickMenuList.forEach(function(item){var parentCode=$('#all-menu-'+item.code).siblings('.level1').data('id');for(var i=0,len=menuData.length;i<len;i++){if(parentCode==menuData[i].code){var hasmenu=false,activeQuickIndex=0;for(var j=0,len1=quickMenuData.length;j<len1;j++){if(quickMenuData[j].code==parentCode){hasmenu=true;activeQuickIndex=j;break;}}if(hasmenu){quickMenuData[activeQuickIndex].items.push(JSON.parse(JSON.stringify(item)));}else{quickMenuData.push({code:menuData[i].code,name:menuData[i].name,icon:menuData[i].icon,openType:menuData[i].openType,items:[JSON.parse(JSON.stringify(item))]})}break;}}})$quickMenuList.html(getTplHtml('quick-menu-tpl',{list:quickMenuList}))}function getQuickMenu(){Util.ajax({url:getQuickMenuUrl,}).done(function(data){quickMenuFlag=true;quickMenuList=data;if(menuDataFlag){renderQuickMenu();activeAllMenu();}})}function getMenu(){Util.ajax({url:getMenuUrl,data:{query:'all'}}).done(function(data){menuDataFlag=true;menuData=data;initMenuData();$allMenuBody.html(getTplHtml('allmenu-block-tpl',{list:menuData}));waterfall();if(quickMenuFlag){renderQuickMenu();activeAllMenu();}})}function initMenuData(){menuData.forEach(function(item){if(item.items&&item.items.length){item.hasSub=true;}else{item.hasSub=false;}})}function activeAllMenu(){for(var i=0;i<quickMenuList.length;i++){$('#all-menu-'+quickMenuList[i].code).addClass('active');if(quickMenuList[i].items&&quickMenuList[i].items.length){quickMenuList[i].items.forEach(function(item){$('#all-menu-'+item.code).addClass('active');})}}}function unActiveAllMenu(id){var $allMenu=$('.allmenu-item');for(var i=0;i<$allMenu.length;i++){var $item=$allMenu.eq(i)if($item.data('id')==id){$item.removeClass('active');break;}}}function sortQuickMenu(){var arr=[];$('.quick-menu').each(function(i,item){var $item=$(item),id=$item.data('id');for(var j=0;j<quickMenuList.length;j++){if(quickMenuList[j].code==id){arr.push(quickMenuList[j]);break;}}})quickMenuList=arr;}function deleteQuickMenu(id){for(var i=0;i<quickMenuList.length;i++){if(quickMenuList[i].code==id){quickMenuList.splice(i,1);break;}else if(quickMenuList[i].items&&quickMenuList[i].items.length){for(var j=0,len=quickMenuList[i].items.length;j<len;j++){if(quickMenuList[i].items[j].code==id){quickMenuList[i].items.splice(j,1);renderQuickMenu();return;}}}}renderQuickMenu();}function saveCommonMenu(){var userSelected=[];quickMenuList.forEach(function(item){userSelected.push(String(item.code));if(item.hasOwnProperty("items")){var itemcodes=new Array();itemcodes=item.items;for(var i=0;i<itemcodes.length;i++){userSelected.push(itemcodes[i].code);}}})Util.ajax({url:saveCommonMenuUrl,data:{quickMenuList:JSON.stringify(quickMenuList),type:'user-setting',userSelected:JSON.stringify(userSelected)}}).done(function(data){})}function drag(){$quickMenuList.sortable({axis:"y",handle:".quick-menu-drag",zIndex:100,deactivate:function(event,ui){sortQuickMenu();saveCommonMenu();}});}function searchAllMenu(){var val=$allmenuSearchInput.val(),arr=[],menuDataCopy=JSON.parse(JSON.stringify(menuData));if(val===''){$allMenuBody.html(getTplHtml('allmenu-block-tpl',{list:menuData}));}else{menuDataCopy.forEach(function(item){var showFlag=false,menuItem={items:[]};if(item.name.includes(val)){showFlag=true;}if(item.items&&item.items.length){item.items.forEach(function(item1){if(item1.name.includes(val)){menuItem.items.push(item1);showFlag=true;}})}if(showFlag){menuItem.code=item.code;menuItem.name=item.name;menuItem.icon=item.icon;menuItem.openType=item.openType;menuItem.url=item.url;arr.push(menuItem);}})$allMenuBody.html(getTplHtml('allmenu-block-tpl',{list:arr}));}waterfall();activeAllMenu();}$menuTrigger.on('click',function(){if($menuTrigger.hasClass('active')){hideAllMenu()}else{$menuTrigger.addClass('active');$globalMenu.removeClass('hide');$cover.removeClass('hidden');}});$allmenuSearchInput.on('focus',function(){$allMenuSearch.addClass('active');}).on('blur',function(){$allMenuSearch.removeClass('active');}).on('keydown',function(e){if(e.keyCode===13){searchAllMenu();}});$allMenuBody.on('click','.allmenu-item-flag',function(e){e.stopPropagation();var $menuItem=$(this).parent(),id=$menuItem.data('id'),parentId='';var icon=$menuItem.data('icon'),name=$menuItem.data('name'),url=$menuItem.data('url'),openType=$menuItem.data('opentype'),icon=$menuItem.data('icon');if($menuItem.hasClass('active')){if($menuItem.hasClass('level1')){$menuItem.removeClass('active').siblings().removeClass('active');}else{$menuItem.removeClass('active');}deleteQuickMenu(id);}else{var itemData={code:id,name:name,icon:icon,openType:openType}if(url){itemData.url=url;}if($menuItem.hasClass('level1')){for(var i=0,len=menuData.length;i<len;i++){if(id==menuData[i].code){var itemData={code:menuData[i].code,name:menuData[i].name,icon:menuData[i].icon,openType:menuData[i].openType,items:[]}$quickMenuList.append(getTplHtml('quick-menu-tpl',{list:itemData}));$menuItem.addClass('active');quickMenuList.push(itemData);break;}}}else{parentId=$menuItem.siblings('.allmenu-item').data('id');var $activeQuickMenu=$('#quick-menu-'+parentId);if($activeQuickMenu.length){$activeQuickMenu.siblings('.quick-menu-subbox').append(getTplHtml('quick-menu-sub-tpl',{list:itemData}));for(var i=0,len=quickMenuList.length;i<len;i++){if(quickMenuList[i].code==parentId){quickMenuList[i].items.push(itemData);break;}}}else{for(var i=0,len=menuData.length;i<len;i++){if(parentId==menuData[i].code){var itemDataPar={code:menuData[i].code,name:menuData[i].name,icon:menuData[i].icon,openType:menuData[i].openType,items:[itemData]}$quickMenuList.append(getTplHtml('quick-menu-tpl',{list:itemDataPar}));quickMenuList.push(itemDataPar);break;}}}$('#all-menu-'+parentId).addClass('active');$menuItem.addClass('active');}}saveCommonMenu();}).on('click','.allmenu-item',function(){var $this=$(this),id=$this.data('id'),name=$this.data('name'),url=$this.data('url'),openType=$this.data('opentype'),hasSub=$this.data('hassub'),icon=$this.data('icon');$loading.removeClass('hidden');hideAllMenu();setTimeout(function(){if(url){dealLinkOpen({id:id,name:name,url:url,openType:openType});}var openFirstUrl=url?false:true;if($this.hasClass('level1')){if(hasSub){$main.removeClass('left-none');getLefMenu({code:id,name:name,icon:icon},openFirstUrl);}else{$main.addClass('left-none');dealLinkOpen({id:id,name:name,url:url,openType:openType});}}else{var $topItem=$this.siblings('.level1'),topId=$topItem.data('id'),topName=$this.data('name'),topUrl=$this.data('url'),topOpenType=$this.data('opentype'),topHasSub=$this.data('hassub'),topIcon=$this.data('icon');$main.removeClass('left-none');getLefMenu({code:topId,name:topName,icon:topIcon,activeCode:id},openFirstUrl);}$loading.addClass('hidden');$(win).trigger('resize');},_QUICK_DELAY_TIME_)});$quickMenuList.on('click','.quick-menu-close',function(e){e.stopPropagation();var $menuItem=$(this).parent(),id=$menuItem.data('id');if($menuItem.hasClass('quick-menu-sub')){deleteQuickMenu(id);unActiveAllMenu(id);}else{unActiveAllMenu(id);$menuItem.siblings('.quick-menu-subbox').find('.quick-menu-sub').each(function(i,item){unActiveAllMenu($(item).data('id'));})deleteQuickMenu(id);}saveCommonMenu();}).on('click','.quick-menu',function(){$allmenuSearchInput.val('');searchAllMenu();$('#all-menu-'+$(this).data('id')).trigger('click');}).on('click','.quick-menu-sub',function(){$allmenuSearchInput.val('');searchAllMenu();$('#all-menu-'+$(this).data('id')).trigger('click');});var timer1,timer2;$allMenu.on('mouseenter',function(){win.clearTimeout(timer2);$allMenu.addClass('active');timer1=setTimeout(function(){$allMenuBox.addClass('show');},_ALL_MENU_BOX_ENTER_DELAY_)}).on('mouseleave',function(){win.clearTimeout(timer1);$allMenu.removeClass('active');timer2=setTimeout(function(){$allMenuBox.removeClass('show');},_ALL_MENU_BOX_LEAVE_DELAY_);})$allMenuBox.on('mouseenter',function(){win.clearTimeout(timer2);$allMenu.addClass('active');}).on('mouseleave',function(){win.clearTimeout(timer1);$allMenu.removeClass('active');timer2=setTimeout(function(){$allMenuBox.removeClass('show');},_ALL_MENU_BOX_LEAVE_DELAY_);})function hideAllMenu(){$menuTrigger.removeClass('active');$globalMenu.addClass('hide');$allMenuBox.removeClass('show');$cover.addClass('hidden');}$('body').on('click',function(e){if(!$(e.target).closest('#menu-trigger,#global-menu,#all-menu-box').length){hideAllMenu();}});drag();getMenu();getQuickMenu();})(window,jQuery);(function(win,$){var leftMenuStatus={};var $leftMenu=$('#left-menu'),$leftMenuTrigger=$('.left-nav-trigger',$leftMenu),$leftMenuContainer=$('.left-nav-container',$leftMenu),$cover=createMainContentCover();var $activeLeftMenu;var LEFT_MENU_ITEM_TPL='<li class="left-menu-item {{level}}"><a href="javascript:void(0);" data-url="{{url}}" data-id="{{code}}" title="{{name}}" data-openType="{{openType}}" data-hasSub="{{hasSub}}" class="left-menu-link"style="padding-left: {{indent}}px;">{{#isTop}}<i class="left-menu-icon {{icon}} "></i>{{/isTop}}<span class="left-menu-name">{{name}}</span>{{#hasSub}}<i class="left-menu-trigger"></i>{{/hasSub}}</a>{{#hasSub}}{{#isTop}}<div class="left-menu-sub"><div class="left-menu-sub-inner"><div class="left-menu-sub-header"><span class="left-menu-sub-title">{{name}}</span></div>{{/isTop}}<ul class="left-menu-sub-list" style="display:none;"> {{{subMenu}}}</ul>{{#isTop}}</div></div>{{/isTop}}{{/hasSub}}</li>';var LEFT_MENU_TPL='<div class="left-menu-wrap" id="left-menu-{{code}}"><div class="left-menu-header" data-url="{{url}}" data-id="{{code}}" data-openType="{{openType}}" data-hasSub="{{hasSub}}" ><span class="left-menu-header-txt">{{name}}</span><span class="left-menu-header-icon {{icon}}"></span></div><ul class="left-menu-list">{{{leftMenuItems}}}</ul></div>';var _DELAY_TIME_=300;function initEvent(){var leftMenuState='normal';$main[leftMenuState=='normal'?'removeClass':'addClass']('left-narrow');var isIE89=Util.browsers.isIE8||Util.browsers.isIE9;var $cover=createMainContentCover();$('.left-nav-trigger').on('click',function(){if($main.hasClass('left-narrow')){$main.removeClass('left-narrow');}else{$main.addClass('left-narrow');if($activeLeftMenu){var $openedMenu=$activeLeftMenu.find('.left-menu-item.level-1.opened');if($openedMenu.length){}else{$leftMenu.trigger('hide-trans');}}}});$leftMenu.on('hide-trans',function(){!isIE89&&$leftMenu.addClass('hide-trans');}).on('transitionend',function(e){if(e.target!==this){return;}$leftMenu.removeClass('hide-trans');}).on('click','.left-menu-link',function(){var $this=$(this),$item=$this.parent(),isTop=$item.hasClass('level-1'),hasSub=$this.data('hassub'),linkData={url:$this.data('url'),openType:$this.data('opentype'),name:this.title,id:$this.data('id')},isNarrow=leftMenuState==='narrow';if(hasSub){var $sub=isTop?$this.next().find('.left-menu-sub-list:eq(0)'):$this.next();if(!$item.hasClass('opened')){$item.addClass('opened');isTop&&isNarrow&&$cover.removeClass('hidden');$sub.stop(true).slideDown(_ANIMATION_TIME_.slide);$item.siblings('.opened').removeClass('opened').find('.left-menu-sub-list:eq(0)').stop(true).slideUp(_ANIMATION_TIME_.slide);}else{$item.removeClass('opened');$sub.stop(true).slideUp(_ANIMATION_TIME_.slide);isTop&&isNarrow&&$cover.addClass('hidden');}}if(linkData.url){$('.left-menu-link').removeClass('active');$this.addClass('active');dealLinkOpen(linkData);if(isNarrow){$activeLeftMenu.find('.left-menu-item.level-1.opened').removeClass('opened').find('.left-menu-sub-list:eq(0)').slideUp(_ANIMATION_TIME_.slide);$cover.addClass('hidden');$leftMenu.removeClass('has-opened');}}if(isTop&&isNarrow){$leftMenu[($activeLeftMenu.find('.left-menu-item.level-1.opened').length)?'addClass':'removeClass']('has-opened');}});$('body').on('click',function(e){if(!$(e.target).closest('#left-menu').length){$cover.addClass('hidden');if(leftMenuState==='narrow'&&$activeLeftMenu){$activeLeftMenu.find('.left-menu-item.level-1.opened').removeClass('opened').find('.left-menu-sub-list:eq(0)').slideUp();}}});}initEvent();function getRowKey(rowkey,i){return rowkey===undefined?i+'':rowkey+'-'+i;}var INDENT_INIT=36,INDENT_STEP=15;function getIndent(rowkey,len){len=len||rowkey.split('-').length;if(len==2||len==1){return INDENT_INIT;}else{return INDENT_INIT+(len-2)*INDENT_STEP;}}function buildLeftMenu(data,rowkey){var html='';$.each(data,function(i,item){var view=item;view.hasSub=!!(item.items&&item.items.length);view.rowkey=getRowKey(rowkey,i);var len=view.rowkey.split('-').length;view.isTop=len===1;view.level='level-'+len;view.indent=getIndent(view.rowkey,len);if(len===1){view.icon=view.icon||'modicon-1';}if(view.hasSub){html+=Mustache.render(LEFT_MENU_ITEM_TPL,$.extend(view,{subMenu:buildLeftMenu(item.items,view.rowkey)}));}else{html+=Mustache.render(LEFT_MENU_ITEM_TPL,view);}});return html;}function ininView(data,tMenu){if(data&&data.length){var html=buildLeftMenu(data);var viewData={code:tMenu.code,name:tMenu.name,leftMenuItems:html,icon:tMenu.icon,hasSub:tMenu.hasSub,openType:tMenu.openType,url:tMenu.url};$activeLeftMenu=$(Mustache.render(LEFT_MENU_TPL,viewData));$activeLeftMenu.appendTo($leftMenuContainer).siblings('.left-menu-wrap').addClass('hidden');if(Util.browsers.isIE8){$activeLeftMenu.find('.left-menu-list').height($leftMenu.height()-$leftMenuTrigger.height()||36);}}}function getLefMenu(tMenu,findSubUrlOpen){var tCode=tMenu.code;if(!leftMenuStatus[tCode]){for(var i=0;i<menuData.length;i++){var item=menuData[i];if(item.code==tCode){ininView(item.items,item);leftMenuStatus[tCode]='resolve';findSubUrlOpen&&findFirstSecUrlOpen(tCode+'');break;}}}if(leftMenuStatus[tCode]==='resolve'){$activeLeftMenu=$('#left-menu-'+tCode);$activeLeftMenu.removeClass('hidden').siblings('.left-menu-wrap').addClass('hidden');findSubUrlOpen&&findFirstSecUrlOpen(tCode);}if(tMenu.activeCode){var $leftMenuActive=$('#left-menu-'+tCode),$level1Link=$('.left-menu-item.level-1>.left-menu-link',$leftMenuActive);$('.left-menu-sub-list',$leftMenuActive).slideUp(_ANIMATION_TIME_.slide);$('.left-menu-link').removeClass('active');$('.left-menu-item').removeClass('opened');$level1Link.each(function(i,item){var $item=$(item);if($item.data('id')==tMenu.activeCode){if($item.data('hassub')){$item.parent().addClass('opened');$item.parent().find('.left-menu-sub-list:eq(0)').slideDown(_ANIMATION_TIME_.slide);}else{$item.addClass('active');}}})}}win.getLefMenu=getLefMenu;var subUrlCache={};function findFirstSecUrlOpen(targetMenu){if(subUrlCache[targetMenu]){return TabsNav.addTab(subUrlCache[targetMenu]);}var $targetMenu=$leftMenuContainer.find('#left-menu-'+targetMenu);var openType='',url='';$targetMenu.find('.left-menu-link').each(function(i,item){url=item.getAttribute('data-url');openType=item.getAttribute('data-opentype');if(url&&openType=='tabsnav'){subUrlCache[targetMenu]={id:item.getAttribute('data-id'),name:item.title,url:url};TabsNav.addTab(subUrlCache[targetMenu]);return false;}});}var menuTimer;$leftMenu.on('mouseover','.left-menu-list,.left-menu-header',function(){if($main.hasClass('left-narrow')){leftOverFlag=true;menuTimer=setTimeout(function(){$main.removeClass('left-narrow');$main.addClass('left-over');},_DELAY_TIME_);}}).on('mouseleave',function(){win.clearTimeout(menuTimer);if($main.hasClass('left-over')){$main.removeClass('left-over');$main.addClass('left-narrow');}}).on('click','.left-menu-header',function(){if($(this).data('url')){dealLinkOpen({id:$(this).data('id'),name:$(this).data('name'),url:$(this).data('url'),openType:$(this).data('opentype')})}})}(this,jQuery));