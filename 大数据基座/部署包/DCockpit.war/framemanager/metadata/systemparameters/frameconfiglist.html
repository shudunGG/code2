
<!DOCTYPE html>
<html>

<head>
<title>系统参数</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<script src="../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>
	<!-- 左右布局页面的左侧内容 -->
	<div class="fui-left" id="fui-left">
		<!-- 左侧的标题
             @local 国际化的标识
             表示从语言包中的'sysParamCategory'取值
         -->
		<div role="head" title="参数分类">
			<a class="action-icon icon-gear" title="分类管理" onclick="openType();"></a>
		</div>
		<!-- 左侧的内容区域 -->
		<div role="body">
			<ul id="tree" class="mini-tree" style="height: 100%" textField="text"
				idField="id" parentField="pid" action="getTreeData"
				resultAsTree="false">
			</ul>
		</div>
	</div>
	<!-- 左右布局页面的右侧内容 -->
	<div class="fui-right" id="fui-right">
		<!-- toolbar区域 -->
		<div class="fui-toolbar">
			<div class="btn-group mr10">
				<!-- local标签用于国际化 -->
				<a class="mini-button" onclick="addConfig"> 新增参数 </a> <a class="mini-button"
					iconCls="icon-right"
					onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要操作的记录!', '', null, 'warning');}else{move();}">转移选中</a>
				<a id="deleteUser" class="mini-button mini-btn-danger"
					onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要删除的记录!', '', null, 'warning');} else {epoint.confirm('确认删除？','',deleteSelected);}">删除选中</a>

				<a class="mini-button" iconCls="icon-gear"
					onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择想要导出的记录！', '', null, 'warning');} else {epoint.execute('exportScript','',exportsql)}">脚本导出</a>
				<input id="database" autoLoad="false" action="getDsTypes"
					textField="text" valueField="id" class="mini-combobox mr10" />
			</div>
			<a class="mini-dataexport" id="dataexport" gridId="datagrid"
				fileName="系统参数" action="getExportModel" extraId="fui-form" exportAction="frameconfiglistaction.export"></a> <span
				style="padding-left: 15px; padding-right: 5px">开启关联jsboot</span> <input
				class="mini-checkbox" id="isrestjsboot" bind="isrestjsboot"
				onvaluechanged="clickRestJs" />

		</div>
		<!-- 条件区域 -->
		<div class="fui-condition">
			<!-- 表单布局
                 在表格二次请求时，会自动带上div.fui-form里的条件
            -->
			<div class="fui-form" id="fui-form">
				<div id="cform" role="form">
					<!-- 2列 -->
					<div role="row">
						<div role="control" label="参数名称或关键字">
							<input bind="frameconfiglistaction.frameConfig.configname"
								id="name" class="mini-textbox" />
						</div>
					</div>
				</div>
				<!-- 添加隐藏域，用于树与表格的联动 -->
				<input bind="frameconfiglistaction.frameConfig.categoryguid"
					id="categoryGuid" class="mini-hidden" /><input bind="ishid"
					id="ishid" class="mini-hidden" />
			</div>
			<!-- 搜索按钮 -->
			<a role="searcher" callback="searchData"></a>
		</div>
		<!-- 内容区域 -->
		<div id="fuiContent" class="fui-content">
			<div id="datagrid" class="mini-datagrid" sortOrder="desc"
				idField="sysguid" multiSelect="true" style="height: 100%;"
				allowResize="true" action="getDataGridData" showPager="true">
				<div property="columns">
					<div type="checkcolumn" width="50"></div>
					<div type="indexcolumn" width="50" headerAlign="center">序</div>
					<div field="configname" width="100" headerAlign="center"
						allowSort="true" sortOrder="desc">
						参数名称 <input property="editor" class="mini-textbox" />
					</div>
					<div field="configvalue" width="100" headerAlign="center">
						参数值 <input property="editor" class="mini-textbox" />
					</div>
					<div field="description" headerAlign="center" width="100%">
						参数描述 <input property="editor" class="mini-textbox" />
					</div>
					<div field="isrestjsboot" width="80" align="center"
						headerAlign="center" renderer="onCheckRestJs">接入js</div>
					<div field="ordernumber" width="80" align="right" allowSort="true"
						headerAlign="center" sortOrder="desc">
						排序号 <input property="editor" class="mini-textbox" vtype="int;range:0,99999999"/>
					</div>
					<div width="50" align="center" headerAlign="center"
						renderer="onEditRenderer">修改</div>
					<div width="50" align="center" headerAlign="center"
						renderer="onDelRenderer">删除</div>
				</div>
			</div>
		</div>
	</div>
	<script src="../../../rest/resource/jsboot"></script>
	<script>
		// 初始化页面
		epoint.initPage('frameconfiglistaction', '', initDataBase);

		function initDataBase(e) {
			mini.get("database").setValue("oracle,B");
			mini.get("database").setText("Oracle");

			//判断是否有获取到categoryguid，有的话影藏左侧树
			if (e.categoryguidvalue) {
				$('#fui-left').addClass("closed");
				$('#fui-left').hide();
				mini.get('categoryGuid').setValue(
						id == 'f9root' ? "" : e.categoryguidvalue);
			}

			if (e.ishid) {
				mini.get("ishid").setValue(e.ishid);
			}

			if (e.isrestjsboot) {
				mini.get("isrestjsboot").setValue(e.isrestjsboot);
			}
		}

		//树js对象
		var tree = mini.get("tree");
		// 点击左侧树刷新右侧表格
		tree.on("nodeselect", function(e) {
			var id = e.node.id;
			// 将左侧树点击的节点id放到隐藏域中
			// 在表格发二次请求时，会自动带上条件区域中的内容
			mini.get('categoryGuid').setValue(id == 'f9root' ? "" : id);
			//刷新表格
			searchData();
		});

		// 表格的搜索
		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		}

		// 绘制行编辑按钮
		var onEditRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "editItems");
		};

		// 绘制行删除按钮
		var onDelRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-remove", "delItems",
					"configname");
		};

		var temp_configName;
		// 删除一行数据
		function delItems(configName) {
			temp_configName = configName;
			// 弹出确认框
			epoint.confirm('确认删除吗', '', function() {
				epoint.execute("frameconfiglistaction.delConfig", '',
						[ temp_configName ], callback);
			});
		}

		// 弹出新增窗口
		function addConfig() {
			var categoryGuid = mini.get('categoryGuid').getValue();
			var isHid = mini.get('ishid').getValue();
			epoint.openDialog('参数新增',
					'framemanager/metadata/systemparameters/frameconfig?categoryGuid='
							+ categoryGuid + '&flg=' + isHid, addCallBack,
					addCallBack, {
						'width' : 800,
						'height' : 350
					});
		}
		// 弹出修改窗口
		function editItems(sysGuid) {
			var isHid = mini.get('ishid').getValue();
			epoint.openDialog('参数修改',
					'framemanager/metadata/systemparameters/frameconfig?sysGuid='
							+ sysGuid + '&flg=' + isHid, addCallBack, {
						'width' : 800,
						'height' : 350
					});
		}

		// 弹出分类管理窗口
		function openType() {
			epoint
					.openDialog(
							'系统参数分类管理',
							"framemanager/metadata/systemparameters/frameconfigcategory",
							isRefreshTree, {
								'width' : 1000,
								'height' : 500
							});
		}

		// 刷新tree
		function isRefreshTree(value) {
			if (value) {
				epoint.refresh([ 'tree', 'datagrid', 'fui-form' ]);
			}
		}

		//新增回调
		function addCallBack(param) {
			if (param) {
				epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
			}
		}

		//回调
		function callback(args) {
			if (args.msg) {
				epoint.alert(args.msg, '', null, 'info');
				epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
			}
		}
		//删除选中
		function deleteSelected() {
			epoint.execute('deleteSelected', [ 'datagrid', 'fui-form' ],
					callback);
		}
		// 导出sql语句
		function exportsql(data) {
			var combox = mini.get("database").getValue();
			var obj = combox.split(",");
			epoint.openDialog(mini.get("database").getText() + '脚本导出',
					"framemanager/metadata/systemparameters/frameconfigexport?configID="
							+ data.exportlist + "&databaseType=" + obj[0]
							+ "&type=" + obj[1], '', {
						'width' : 1000,
						'height' : 400
					});
		}
		// 转移选中
		function move() {
			epoint.execute('frameconfiglistaction.move', 'datagrid', movetc);
		}

		function movetc(data) {
			epoint.openDialog('转移参数分类',
					"framemanager/metadata/systemparameters/frameconfigcategoryselect?guidlist="
							+ data.movelist, movetcCallBack, {
						'width' : 500,
						'height' : 400
					});
		}

		function movetcCallBack(msg) {
			if (msg && msg != 'close') {
				searchKeepPage(msg);
			}
		}
		function searchKeepPage(msg) {
			if (msg == 'success') {
				epoint.showTips('转移成功');
			}
			epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
		}

		function clickRestJs() {
			var val = mini.get("isrestjsboot").value;
			epoint.execute("checkIsRestJs", "", val);
		}

		function onCheckRestJs(e) {
			//默认接入的
			var flag = "gridAllowUnselect" == e.row.configname
					|| "EnableCustomSort" == e.row.configname
					|| "noUseTabsNav" == e.row.configname
					|| "adjustGridPageSize" == e.row.configname
					|| "alertToTips" == e.row.configname
					|| "fileSizeLimit" == e.row.configname
					|| "fileLimitType" == e.row.configname
					|| "editorModel" == e.row.configname
					|| "uploadPreviewUrl" == e.row.configname
					|| "uploadPreviewText" == e.row.configname
					|| "gridPageSize" == e.row.configname;
			if ("1" == e.row.isrestjsboot || flag) {
				return epoint.renderCell(e, "action-icon icon-check");
			}

		}
	</script>
</body>

</html>
