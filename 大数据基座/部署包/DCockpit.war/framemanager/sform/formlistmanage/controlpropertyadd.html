<!DOCTYPE html>
<html>
<head>
<title>属性添加</title>
<meta charset="UTF-8" />
<meta http-equiv="content-type" content="text/html" />
<script src="../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
	<div class="page-loading"></div>

	<!-- toolbar区域 -->
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<!-- a class="mini-button" id="addNew" onclick="saveAndNew"
				iconCls="icon-save">保存并新建</a--> 
			<a class="mini-button" id="addClose"
				onclick="saveAndClose" iconCls="icon-save">保存并关闭</a> <a
				class="mini-button" onclick="epoint.closeDialog();"
				iconCls="icon-removecircle">关闭</a>
		</div>
	</div>

	<!-- 内容区域 -->
	<div class="fui-content">
		<div id="fui-form" class="fui-form">
			<div role="row">
				<div role="control" label="属性名称" starred="true">
					<input class="mini-textbox" bind="dataBean.propertyname"
						required="true" requiredErrorText="属性名称不能为空!" />
				</div>
				<div role="control" label="属性英文名称" starred="true">
					<input class="mini-textbox" bind="dataBean.propertyenglishname"
						required="true" requiredErrorText="属性英文名称不能为空!" />
				</div>
			</div>
			<div role="row">
				<div role="control" label="数据类型" starred="true">
					<input class="mini-checkboxlist" action="getDataType"
						repeatItems="5" repeatLayout="table" textField="text"
						valueField="id" bind="dataBean.allowfieldtype" />
				</div>
			</div>
			<div role="row">
				<div role="control" label="控件显示类型" starred="true" style="width: 27%">
					<input autoLoad="false" id="displayID" action="getDisplayType"
						textField="text" valueField="id" showNullItem="true"
						emptyText="请选择控件显示类型..." nullItemText="请选择控件显示类型..."
						bind="dataBean.displaytype" class="mini-combobox" onvaluechanged="changType"/>
				</div>
				<!-- 
				<div role="control" label="数据源代码" style="width: 27%;display:none">
					<input autoLoad="false" id="codesource" action="getCodesource"
						textField="text" valueField="id" showNullItem="true"
						emptyText="请选择" nullItemText="请选择" allowInput="true"
						onvalidation="onComboValidation" bind="dataBean.datasourcename"
						class="mini-combobox" />
				</div>
				<div class="btn-group mr10" style="width: 10%;display:none">
					<a class="mini-button" id="codeItem" onclick="addCodeItem();">代码项</a>
				</div> 
				-->
			</div>
			<div role="row">
				<div role="control" label="排序号">
					<input class="mini-textbox" bind="dataBean.ordernum" vtype="int;range:0,99999999"
						value="0" />
				</div>
				<div role="control" label="启用">
					<input class="mini-checkbox" bind="dataBean.initiatemode" />
				</div>
			</div>
			<div role="row" id="itemValue" style="display: none">
				<div role="control" label="子项值">
					<input class="mini-textbox" id="addItem" width="200px" /> 
					<a class="mini-button" id="addRecord" width="100px" onclick="addRecord" iconCls="icon-addcircle">新增子项</a> 
					<a class="mini-button" id="delRecord" width="100px" onclick="delRecord" iconCls="icon-minuscircle">删除子项</a>
				</div>
			</div>
			<div role="row" id="itemValues" style="display: none">
				<div role="control">
					<select id="items" multiple="multiple" style="width: 100%; height: 100%">
					</select>
				</div>
			</div>
		</div>
	</div>

	<script src="../../../rest/resource/jsboot"></script>
	<script>
		// 初始化页面
		epoint.initPage('controlpropertyaddaction');

		function saveAndNew() {
			if (epoint.validate()) {
				epoint.execute('addNew', 'fui-form', newCallback);
			}
		}

		function saveAndClose() {
			var items="";
			var selOpt = $("#items option");
			for(var n=0; selOpt!=null && selOpt.length>0 && n<selOpt.length; n++){
				items += selOpt[n].innerHTML+";";
			}
			if (epoint.validate()) {
				epoint.execute('add', 'fui-form', [items], closeCallback);
			}
		}

		// 新增操作的回调
		function newCallback(data) {
			if (data.msg) {
				epoint.alert(data.msg, '', null, 'info');
				// 清空表单
				epoint.clear('fui-form');
			}
		}

		// 关闭操作的回调
		function closeCallback(data) {
			if (data.msg) {
				if (data.msg.indexOf("成功") > -1) {
					epoint.alertAndClose(data.msg, '', null, 'success');
				} else {
					epoint.alert(data.msg, '', null, null, 'error');
				}
			}
		}
		
		//切换控件显示类型，控制下拉值自定义维护控件显隐
		function changType() {
			var displayName = mini.get("displayID").getValue();
			if(displayName == "combobox"){
				document.getElementById("itemValue").style.display = "block";
				document.getElementById("itemValues").style.display = "block";
			}else if(displayName == "textbox"){
				document.getElementById("itemValue").style.display = "none";
				document.getElementById("itemValues").style.display = "none";
			}
		}

        var itemsString = "";
		
		function addRecord() {
			var addItem = mini.get("addItem").getValue();
			if(addItem){
 				var m=0;
 				if(itemsString != null && itemsString != ""){
 					for(var n=0;itemsString.split(";").length>0 && n<itemsString.split(";").length; n++){
 	 					if(itemsString.split(";")[n] == addItem){
 	 						return;
 	 					}else{
 	 						m++;
 	 					}
 	 				}
 	 				if(m == itemsString.split(";").length){
 	 					var selObj = $("#items");
 	 	 				selObj.append("<option value='"+addItem+"'>" + addItem + "</option>");
 	 	 				itemsString += addItem +";";
 	 				}else{
	 					return;
 	 				}
 				}else{
 					var selObj = $("#items");
	 	 			selObj.append("<option value='"+addItem+"'>" + addItem + "</option>");
	 	 			itemsString += addItem +";";
 				}
 			}
			mini.get("addItem").setValue("");
		}

		function delRecord() {
			var selOpt = $("#items option:selected");
			selOpt.remove();
			mini.get("addItem").setValue("");
			
			//删除子项后重置下拉值
 			var opts =  $("#items option");
 			var delAfterStr = "";
 			for(var n=0; opts!=null && opts.length>0 && n<opts.length; n++){
 				delAfterStr += opts[n].innerHTML+";";
 			}
 			itemsString = delAfterStr;
		}
		
      /*
		function onComboValidation(e) {
			if (e.value) {
				var items = this.findItems(e.value);
				if (!items || items.length == 0) {
					e.isValid = false;
					e.errorText = "输入值不在下拉数据中";
				}
			}
		}

		function addCodeItem() {
			epoint.openDialog("代码项", "framemanager/sform/formlistmanage/codemainlist",
					addCallBack, {
						'width' : 1000,
						'height' : 600
					});
		}

		function addCallBack(data) {
			if (data) {
				epoint.refresh('codesource');
			}
		}*/
	</script>
</body>
</html>