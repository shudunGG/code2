<!DOCTYPE html>
<html>

	<head>
		<title>服务管理</title>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />

		<script src="../../../frame/fui/js/cssboot.js"></script>
	</head>
	<body>
		<div class="page-loading"></div>

		<div class="fui-left">
			<div role="head" title="服务类别">
				<div class="btn-group r">
					<a class="mini-button" iconCls="icon-gear" style="margin-top: 5px;margin-right: 5px;"
						onclick="openType()">服务类别</a>
				</div>
			</div>

			<div role="body">
				<ul id="tree" class="mini-tree" style="height: 100%" textField="text"
				idField="id" parentField="pid"
				action="servicelistaction.getTreeData" resultAsTree="false"></ul>
			</div>
		</div>

		<!-- 右侧内容区域 -->
		<div class="fui-right">
			<!-- 操作按钮区域 -->
			<div class="fui-toolbar">
				<div class="btn-group mr10">
					<a class="mini-button" onclick="openAdd" iconCls="icon-addcircle">新增服务</a>
					<a class="mini-button" onclick="saveOrder" iconCls="icon-save">修改排序</a>
					<a class="mini-button mini-btn-danger" onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要删除的记录!', '', null, 'warning');} else {epoint.confirm('确认删除?','',deleteSelected);}" iconCls="icon-minuscircle">删除服务</a>
					<a class="mini-button" onclick="epoint.confirm('一键生成将先删除所有服务配置,同时自动插入模块页面对应的服务,确认执行?','',autoCreate);" iconCls="icon-gear">一键生成</a>
				</div>
				<!--帮助按钮 -->
				<a role="helper" class="mr10">注意事项</a>
			</div>
			
			<!-- 帮助信息区域 默认隐藏-->
		<div class="fui-notice hidden">
			<p>
				<span class="text-danger">
				          一键生成:先删除所有服务配置,同时自动插入模块页面对应的服务,(执行此操作后将会删除现有所有配置，一般用于第一次初始化后台模块对应的服务权限)
				</span>
			</p>
		</div>

			<!-- 条件区域 -->
			<div class="fui-condition">
				<div class="fui-form" id="fui-form">
					<div role="form">
						<div role="row">
							<div role="control" label="服务名称">
								<input bind="servicelistaction.frameService.servicename"
								class="mini-textbox" />
							</div>
							<div role="control" label="描述">
								<input bind="servicelistaction.frameService.description"
								class="mini-textbox" />
							</div>
						</div>
						<!-- 添加隐藏域，用于树与表格的联动 -->
						<input bind="servicelistaction.frameService.servicetypeguid"
						id="leftTreeNodeGuid" class="mini-hidden" />
					</div>
				</div>
				<!-- 搜索按钮 -->
				<a role="searcher" callback="searchData"></a>
			</div>

			<!-- 表格区域 -->
			<div class="fui-content">
				<div id="datagrid" name="datagrid" class="mini-datagrid"
				idField="serviceguid" multiSelect="true" allowResize="true" style="width: 100%; height: 100%;"
				showPager="true" action="servicelistaction.getDataGridData" allowCellSelect="true" allowCellValid="true" allowCellEdit="true"
				editNextOnEnterKey="true" editNextRowCell="true" ondrawcell="onCheckRender">
					<div property="columns">
						<div type="checkcolumn" width="50"></div>
						<div type="indexcolumn" width="50" headerAlign="center">
							序
						</div>
						<div field="servicename" headerAlign="center" width="150" Align="left">
							服务名称
						</div>
						<div field="servicetag" headerAlign="center" align="left" width="150" >
							服务tag
						</div>
						<div field="moduleName" width="140" headerAlign="center" align="left">
							关联模块
						</div>
						<div field="relationurl" width="140" headerAlign="center" align="left">
							关联地址
						</div>
						<div field="orderNumber" width="80" allowSort="true" vtype="int;range:0,99999999" sortOrder="desc" headerAlign="center" align="right">
							排序
							<input property="editor" class="mini-textbox" vtype="int;range:0,99999999" style="width:100%" />
						</div>
						<div name="methodList" width="80" align="center" headerAlign="center"
						renderer="onMethodRenderer">
							配置
						</div>
						<div name="edit" width="65" align="center" headerAlign="center"
						renderer="onEditRenderer">
							修改服务
						</div>
					</div>
				</div>

			</div>
		</div>

		<script src="../../../rest/resource/jsboot"></script>

		<!-- 配置变量 -->
		<script>
			//<![CDATA[
			//初始化页面
			epoint.initPage("servicelistaction",'',initCallback);
			var codeId="";
			
			function initCallback(e) {
				if(e && e.codeId){
					codeId=e.codeId;
				}
			}
			// 表格对象
			var grid = mini.get("datagrid");
			
			
			grid.on("beforeselect", function (e) {
				var belongOuGuid=e.record.moduleguid;
	            if (belongOuGuid){
	            	e.cancel = true;
	            }
	        });
			
			function onCheckRender(e){
				//此功能只是隐藏掉选择框，但是还是可以被选到的，注意！！！！，要配合beforeselect使用
				var belongOuGuid=e.record.moduleguid;
				if( belongOuGuid && e.cellCls === "mini-checkcolumn"){
					e.cellHtml = "";
				}
			}
			
			// 在表格数据加载完之后打开表格编辑状态
			//grid.on("load", function(e) {
			//	var rows = e.sender.findRows();
			//	for (var i = 0; i < rows.length; i++) {
			//		grid.beginEditRow(rows[i]);
			//	}
			//});

			//树js对象
			var tree = mini.get("tree");
			// 点击左侧树刷新右侧表格
			tree.on("nodeselect", function(e) {
				if (e.node) {
					var id = e.node.id;
					//将左侧树点击的节点id放到隐藏域中
					mini.get('leftTreeNodeGuid').setValue(id == 'f9root' ? "" : id);
				}
				//刷新表格
				searchData();
			});

			// 表格的搜索
			function searchData() {
				epoint.refresh(['datagrid', 'fui-form']);
			}

			//打开新增action的窗口
			function openAdd() {
				//获取树节点值
				var itemid = mini.get("tree").getValue();
				var settings = {
					'width' : 800,
					'height' : 500
				};
				epoint.openDialog('新增服务', 'framemanager/orga/service/serviceadd?servicetypeguid=' + itemid, addCallBack, settings);
			}

			function addCallBack(data) {
				epoint.refresh(['datagrid', 'fui-form'],'',true);
			}

			function saveOrderCallBack(data) {
				epoint.alert(data.msg, '', null, 'info');
				epoint.refresh(['datagrid', 'fui-form'],'',true);
			}

			//保存排序
			function saveOrder() {
				grid.validate();
	            if (grid.isValid() == false) {
	                //alert("请校验输入单元格内容");
	                var error = grid.getCellErrors()[0];
	                grid.beginEditCell(error.record, error.column);
	                return;
	            }
				epoint.execute('servicelistaction.saveOrder', '', saveOrderCallBack);
			}

			//删除提示并刷新
			function deleteCallBack(data) {
				epoint.alert(data.msg, '', null, 'info');
				epoint.refresh(['datagrid', 'fui-form'],'',true);
			}

			//删除选中行
			function deleteSelected() {
				epoint.execute('servicelistaction.delete', 'datagrid', deleteCallBack);
			}
			
			function autoCreateCallBack(data) {
				epoint.alert(data.msg, '', null, 'info');
				epoint.refresh(['datagrid', 'fui-form'],'',true);
				updateTree();
			}
			//一键生成
			function autoCreate() {
				epoint.execute('servicelistaction.autoCreate', 'datagrid', autoCreateCallBack);
			}

			function editItems(serviceguid) {
				var settings = {
					'width' : 800,
					'height' : 500
				};
				epoint.openDialog('修改服务', 'framemanager/orga/service/serviceedit?serviceguid=' + serviceguid, addCallBack, settings);
			}

			// 绘制行编辑按钮
			var onEditRenderer = function(e) {
				return epoint.renderCell(e, "action-icon icon-edit", "editItems", "serviceguid")
			};

			function openMethod(serviceguid) {
				epoint.openDialog('配置方法', 'framemanager/orga/service/servicemethodlist?serviceguid=' + serviceguid, '');
			}

			// 绘制配置按钮
			var onMethodRenderer = function(e) {
				return epoint.renderCell(e, "action-icon icon-gear", "openMethod", "serviceguid");
			};
			
			
			// 刷新tree
			function updateTree() {
				epoint.refresh([ 'tree' ]);
			}
			
			//打开服务类别
			function openType() {
				epoint.openDialog('服务类别',"framemanager/metadata/code/codeitemslist?codeID="+codeId,
							updateTree, {'width' : 1000});
			}
			
			//]]>
		</script>
	</body>
</html>