<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>文档详情</title>
<script src="../../../../frame/fui/js/cssboot.js"></script>

<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/editormd.css" />
</head>

<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>

	<!-- toolbar区域 -->
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<div id="notReleased">
				<a class="mini-button" id="btnRelease" onclick="releaseDoc">发布</a>
				<a class="mini-button" id="btnSave" onclick="saveDoc">保存</a>
				<a class="mini-button mini-btn-danger" id="btnDelete" onclick="deleteDoc">删除</a>
            	<a class="mini-button" onclick="epoint.closeDialog('close')">关闭</a>
			</div>
			<div id="released">
				<a class="mini-button mini-btn-warning" id="btnWithdraw" onclick="withdrawDoc">撤回</a>
				<a class="mini-button mini-btn-danger" id="btnDelete" onclick="deleteDoc">删除</a>
            	<a class="mini-button" onclick="epoint.closeDialog('close')">关闭</a>
			</div>
		</div>
	</div>

	<!-- 内容区域 -->
	<div class="fui-content">

		<div id="fui-form" class="fui-form">
			<div role="row">
				<div role="control" label="标题" starred="true">
					<input id="docTitle" class="mini-textbox"
						bind="doc.title" required="true" requiredErrorText="标题不能为空!" />
				</div>
			</div>
			<div role="row">
				<div role="control" label="文档分类" starred="true">
					<input id="selectedDocType" bind="docType" allowInput="false" width="200px"
						class="mini-buttonedit" emptyText="" required="true" requiredErrorText="请选择文档分类"
						onbuttonclick="selectDocType"
						selectOnFocus="true" />
						<!-- 隐藏域 -->
					<input bind="doc.codeId" id="doctype" class="mini-hidden" />
				</div>
			</div>
			<div role="row">
				<div role="control" label="正文" starred="true">
					<div id="docContent">
               			<textarea style="display:none;"></textarea>
          			</div>
				</div>
			</div>
			<!-- 隐藏域 -->
			<input bind="contentText" id="contentText" class="mini-hidden" />
		</div>
	</div>
	
	<script src="../../../../rest/resource/jsboot"></script>
	<script src="js/jquery.min.js"></script>
    <script src="js/editormd.min.js"></script>
	
	<script>
		//<![CDATA[ 
		// 初始化页面
		epoint.initPage('docdetailaction', '', initCallBack);

		var docGuid = '';
		var docEditor;
		var root = Util.getSafeLocation().pathname.split('/')[1];
		var domain = Util.getSafeLocation().protocol + '//' + Util.getSafeLocation().host + '/';
		function initCallBack(e){
			docGuid = e.docGuid;
			var docStatus = e.docStatus;
			
			if (docStatus == 1) {
				// 文档已发布
				hideForReleased();
				
			} else if (docStatus == 2) {
				// 文档未发布
				hideForNotReleased();
			}
			

			mini.get("selectedDocType").setText(e.docType);
			mini.get("selectedDocType").setValue(e.docType);
			
			
			var connect = domain + root + '/rest/framemanager/orga/openplatform/doc/';
			var uploadUrl = connect + "docaddaction/uploadImg?isCommondto=true&docGuid="+docGuid;
			// 初始化MD编辑器
	        $(function() {
	        	docEditor = editormd("docContent", {
	                width   : "100%",
	                height  : 640,
	                syncScrolling : "single",
	                path    : "lib/",
	                emoji   : true,
	                tocm: true, // Using [TOCM]
	                tex: true, // 开启科学公式TeX语言支持，默认关闭
	                flowChart: true, // 开启流程图支持，默认关闭
	                sequenceDiagram: true, // 开启时序/序列图支持，默认关闭
	                saveHTMLToTextarea: true,
	                imageUpload: true,
	                imageUploadURL: uploadUrl,
	                imageFormats: ["jpg", "jpeg", "gif", "png", "rar", "zip","doc","docx","xlsx","ppt"],
	                crossDomainUpload: false,
	                onchange: restMdPreviewImgSrc,
	                onload : restMdPreviewImgSrc,
	        		markdown: e.contentText
	        	});
	                        
	        });

			console.log(e.contentText)
			mini.get("contentText").setValue(e.contentText);
		}
		
		function restMdPreviewImgSrc() {
			// 修改图片请求路径，使在MD预览界面可以请求图片显示
        	var images = docEditor.preview.context.images;
            if (images) {
        		for (var i=0; i<images.length; i++) {
        			var imgUrl = images[i].src;
        			// 截取请求图片的URL
        			if (imgUrl) {
        				var imgRestUrl= domain + root + imgUrl.split("framemanager/orga/openplatform/doc")[1];
        				images[i].src = imgRestUrl;
        			}
        		}
        	}
		}
		
		// 当前为已发布状态，隐藏相关内容
		function hideForReleased(){
			document.getElementById("released").style.display = '';
			// 隐藏相关按钮
			document.getElementById("notReleased").style.display = 'none';
			// 将题干、问题分类和正文内容设置为不可修改
			/* mini.get('docTitle').readOnly = true;
			mini.get('selectedDocType').readOnly = true;
			mini.get('docContent').readOnly = true;
			 var docEditor = mini.get("docContent").editor;
			if (docEditor) {
				docEditor.setReadOnly('1');
			} */
			
		}
		
		// 当前为未发布状态，隐藏相关内容
		function hideForNotReleased(){
			document.getElementById("notReleased").style.display = '';
			// 隐藏相关按钮
			document.getElementById("released").style.display = 'none';
			// 将标题、文档分类和正文内容设置为可修改
			/* mini.get('docTitle').readOnly = false;
			mini.get('selectedDocType').readOnly = false;
			mini.get('docContent').readOnly = false;
			var docEditor = mini.get("docContent").editor;
			if (docEditor) {
				docEditor.setReadOnly('');
			} */
			
		}
		
		// 获取正文文本内容
		function getContentText(){
			var contentText = docEditor.getMarkdown();
			mini.get("contentText").setValue(contentText);
		}
		
		// 发布
		function releaseDoc(){
			if (epoint.validate()) {
				getContentText();
				epoint.execute('releaseDoc', '', docGuid, releaseDocCallBack);
			}
		}
		
		// 发布回调
		function releaseDocCallBack(data){
			var msg =data.msg;
			if (msg) {
				if(data.success){
					epoint.showTips(msg, {timeout: 1000});
					hideForReleased();
				} else {
					epoint.alert(msg, '', '', 'warning');
				}
			} else {
				epoint.alert('操作失败', '', '', 'warning');
			}
		}

		// 撤回
		function withdrawDoc(){
			if (epoint.validate()) {
				getContentText();
				epoint.execute('withdrawDoc', '', docGuid, withdrawDocCallBack);
			}
		}

		// 撤回回调
		function withdrawDocCallBack(data){
			var msg =data.msg;
			if (msg) {
				if(data.success){
					epoint.showTips(msg, {timeout: 1000});
					hideForNotReleased();
				} else {
					epoint.alert(msg, '', '', 'warning');
				}
			} else {
				epoint.alert('操作失败', '', '', 'warning');
			}
		}
		
		// 保存文档
		function saveDoc(){
			if (epoint.validate()) {
				getContentText();
				epoint.execute('saveDoc', '', docGuid, saveDocCallBack);
			}
		}
		
		// 保存文档回调
		function saveDocCallBack(data){
			var msg =data.msg;
			if (msg) {
				if(data.success){
					epoint.showTips(msg, {timeout: 1000});
				} else {
					epoint.alert(msg, '', '', 'warning');
				}
			} else {
				epoint.alert('操作失败', '', '', 'warning');
			}
		}
		
		// 删除文档
		function deleteDoc(){
			epoint.confirm('是否删除该文档？', '删除文档确认', function () {
				// 删除文档确认回调
				epoint.execute('deleteDoc', '', docGuid, function (data) {
					var msg =data.msg;
					if (msg) {
						if(data.success){
							epoint.closeDialog("success");
						} else {
							epoint.alert(msg, '', '', 'warning');
						}
					} else {
						epoint.alert('操作失败', '', '', 'warning');
					}
				});
			}, function () {
				// 删除文档取消回调
				
			})
		}

		// 选择文档分类
		function selectDocType(){
			epoint.openDialog("选择文档分类",
					'framemanager/orga/openplatform/app/selectcodeitem?codeName=文档',
					dealSelectDocTypeBackValue, {
						'width' : 300,
						'height' : 400
					});
		}
		
		// 选择代码项回调
		function dealSelectDocTypeBackValue(rtnValue){
			if (rtnValue && rtnValue != 'close') {
				// codeid_SPLIT_名称
				var idAndName = rtnValue.split("_SPLIT_");
				var id = idAndName[0];
				var	name = idAndName[1];
			
				mini.get("selectedDocType").setText(name);
				mini.get("doctype").setValue(id);
				
			}
		}
		//]]>
	</script>
</body>
</html>