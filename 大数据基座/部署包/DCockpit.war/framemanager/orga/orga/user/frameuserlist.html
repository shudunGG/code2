<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>用户列表</title>
<script src="../../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>
	<!-- 页面内容区域 -->
	<div class="fui-left">
		<div role="head" title="选择部门"></div>
		<div role="body">
			<ul id="tree" class="mini-filtertree" style="height: 100%"
				textField="text" idField="id" parentField="pid"
				action="getTreeModel" filterMode="server" resultAsTree="false">
			</ul>
		</div>
	</div>
	<div class="fui-right">
		<!-- toolbar区域 -->
		<div class="fui-toolbar">
			<div class="btn-group mr10">
				<a id="addUser" class="mini-button" onclick="addUser">新增</a> <a
					id="deleteUser" class="mini-button"
					onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要删除的记录!', '', null, 'warning');} else {epoint.confirm('确认删除？','',deleteSelected);}">删除</a>
				<a id="saveAll" class="mini-button" onclick="saveAll">保存</a> <a
					id="moveUser" class="mini-button"
					onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要转移的记录!', '', null, 'warning');} else {moveuser();}">移动</a>
				 <a id="moveUserRole" class="mini-button"
					onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要转移角色的用户记录!', '', null, 'warning');} else if(mini.get('datagrid').getSelecteds().length >1){epoint.alert('请选择一条要转移角色的用户记录!', '', null, 'warning');} else {moveuserrole();}">转移用户角色</a>
				<a id="setUserEnable" class="mini-button"
					onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要启用/禁用的记录!', '', null, 'warning');} else {setUserEnable();}">启用/禁用</a>
			</div>
			<div id="uploader" class="mini-webuploader mr1" pickerText="导入"
				action="frameuserlistaction.getDataImport" limitType="xls,xlsx"
				dataImport="true" showDefaultUI="false"
				onfilesuccess="onFileSuccess" auto="true"></div>
			<a class="mini-dataexport" id="dataexport" gridId="datagrid"
				fileName="用户列表" action="getExportModel" extraId="fui-form" exportAction="frameuserlistaction.export"></a> <a id="morebtn"
				class="mini-menubutton" menu="#popupMenu" style="margin-left: 1px">更多</a>
			<ul id="popupMenu" class="mini-menu" style="display: none;">
				<li id="addStepSize" onclick="addStepSize">调整排序步长</li>
				<li id="changeAccountMode" onclick="changeAccountMode">切换账号模式</li>
				<li id="setUserSyncThirdParty"
					onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要开启/关闭同步到第三方平台的记录!', '', null, 'warning');} else {setUserSyncThirdParty();}">授权/取消同步第三方</li>
			</ul>
			<!--帮助按钮 -->
			<a role="helper" class="mr10" id="helper">导入模板</a>
		</div>
		<!-- 帮助信息区域 默认隐藏-->
		<div class="fui-notice hidden">
			<p>
				<em><a href="userimport.xlsx">下载excel导入模板</a></em>
			</p>
		</div>
		<!-- 条件区域 -->
		<div class="fui-search" opened="false" primaryControl="userName">
			<div class="fui-form" id="fui-form">
				<div role="form">
					<div role="row">
						<div role="control" label="用户名称">
							<input bind="userName" class="mini-textbox" id="userName" />
						</div>
						<div role="control" label="登录名称">
							<input bind="loginId" class="mini-textbox" />
						</div>
					</div>
					<div role="row">
						<div role="control" label="部门名称">
							<input bind="ouName" class="mini-textbox" />
						</div>
						<div role="control" label="状态">
							<input bind="enabled" class="mini-combobox" action="getEnabledItem"/>
						</div>
					</div>
					<div role="row">
						<div role="control" label="直属用户">
							<div name="onlyDirect" bind="isDirect" class="mini-checkbox"
								onvaluechanged="searchData"></div>
						</div>
					</div>
					<!-- 添加隐藏域，用于树与表格的联动 -->
					<input bind="leftTreeNodeGuid" id="leftTreeNodeGuid"
						class="mini-hidden" /> <input bind="transferOuguid" id="ouguid"
						class="mini-hidden" />
				</div>
			</div>
			<!-- 搜索按钮 -->
			<a role="searcher" callback="searchData"></a> <a role="reset"
				callback="resetCallback"></a> <a role="close"
				callback="closeCallback"></a>
		</div>
		<!-- 内容区域 -->
		<div class="fui-content">
			<div id="datagrid" name="datagrid" class="mini-datagrid"
				idField="userGuid" multiSelect="true"
				style="width: 100%; height: 100%;" allowResize="true"
				showPager="true" action="getDataGridData" allowCellSelect="true"
				allowCellValid="true" allowCellEdit="true" editNextOnEnterKey="true"
				editNextRowCell="true" ondrawcell="onCheckRender" oncellbeginedit="cellBeginEdit">
				<div property="columns">
					<div type="checkcolumn" width="50"></div>
					<div type="indexcolumn" width="50" headerAlign="center">序</div>
					<div field="displayName" headerAlign="center"
						renderer="onDisplayNameRender" width="100">用户名称</div>
					<div field="showLoginId" headerAlign="center" width="100">
						登录名称</div>
					<div field="ouname" headerAlign="center" align="left" width="100">部门名称</div>
					<div name="edit" field="framemj" headerAlign="center"
						align="center">涉密等级</div>
					<div name="jzqk" field="jzqk" headerAlign="center"
						renderer="onJzqkRender" align="center" width="70">兼职情况</div>
					<div field="zt" headerAlign="center" renderer="onZtRender"
						align="center" width="50">状态</div>
					<div name="syncthirdparty" field="syncthirdparty"
						headerAlign="center" renderer="onThirdPartyRender" align="center"
						width="120">是否同步第三方</div>
					<div field="orderNumber" width="80" align="right"
						headerAlign="center" allowSort="true" sortOrder="desc" vtype="int;range:0,99999999">
						排序 <input property="editor" class="mini-textbox" vtype="int;range:0,99999999"
							inputStyle="text-align:right" style="width: 100%" />
					</div>
					<div name="copyColumn" headerAlign="center" renderer="onCopyRender"
						align="center" width="50">复制</div>
					<div name="cshmm" headerAlign="center" renderer="onCshmmRender"
						align="center" width="100">初始化密码</div>
					<div field="usbsetstr" name="usbkeyset" headerAlign="center"
						renderer="onUsbkeysetRender" align="center" width="80">
						USB设置</div>
					<div name="msgsz" headerAlign="center" renderer="onMsgszRender"
						align="center" width="60">秘书岗</div>
					<!-- <div name="ckmk" headerAlign="center" renderer="onCkmkRender"
						align="center" width="70">查看模块</div> -->
					<div name="setaccountrelation" headerAlign="center"
						renderer="onSetAccountRelation" align="center" width="70">关联账号</div>
					<div name="ckmk" headerAlign="center"
						renderer="onSelectUserModuleRender" align="center" width="70">模块订阅</div>
					<div name="pzjs" headerAlign="center"
						renderer="onSelectRoleRender" align="center" width="70">配置角色</div>
					<div name="userswitch" width="50" align="center"
						headerAlign="center" renderer="onLoginRenderer">用此账号登录</div>
				</div>
			</div>
		</div>
	</div>

	<div id="info-box" class="mini-window mini-messagebox" title="进度提醒"
		style="width: 400px; height: 250px; display: none;"
		showMaxButton="false" showCollapseButton="false" showShadow="true"
		showToolbar="false" showFooter="true" showModal="true"
		allowResize="false" allowDrag="false">
		<i class="mini-messagebox-icon mini-messagebox-info" style=""></i>
		<div style="margin-left: 100px; height: 50px; margin-top: 60px;">
			<div id="info-box-moving">
				<div id="move-progressbar" class="mini-progressbar" value="0"></div>
				<p>
					初始化中，当前第<span id="info-box-curr"></span> 个，共 <span
						id="info-box-all"></span> 个。
				</p>
			</div>
		</div>
	</div>

	<script src="../../../../rest/resource/jsboot"></script>
	<script>
		//<![CDATA[
		// 表格对象
		var grid = mini.get("datagrid");

		//初始化页面
		epoint.initPage('frameuserlistaction', '', initGrid);

		var attr = Util.getUrlParams('isSub');
		var isSub = attr == undefined ? '' : attr;
		var isMultiAccountMode = 0;
		var userRole;
		var enableThreeManage = false;

		// 在表格数据加载完之后打开表格编辑状态
		//grid.on("load", function(e) {
		//	var rows = e.sender.findRows();
		//	for (var i = 0; i < rows.length; i++) {
		//		grid.beginEditRow(rows[i]);
		//	}
		//});
		grid.on("cellbeginedit", function(e) {
			if (e.field == "orderNumber") {
				var row = e.record;
				var editor = e.editor;
				var enabled = row.canOperateBaseOu == "0" ? false : true;
				editor.setEnabled(enabled);
			}
		});
		//soa需要隐藏列
		function initGrid(e) {
			console.log(e.showDelBtn);
			var grid = mini.get("datagrid");

			//SOA模式下面要隐藏掉增删改操作
			if (e.enableSOA == true) {
				mini.get('addUser').setVisible(false);
				mini.get('uploader').setVisible(false);
				mini.get('deleteUser').setVisible(false);
				mini.get('saveAll').setVisible(false);
				mini.get('moveUser').setVisible(false);
				mini.get('moveUserRole').setVisible(false);
				mini.get('setUserEnable').setVisible(false);
				mini.get('addStepSize').setVisible(false);
				mini.get('setUserSyncThirdParty').setVisible(false);

				var grid = mini.get("datagrid");
				grid.hideColumn("jzqk");//隐藏兼职情况
				grid.hideColumn("copyColumn");//隐藏复制列
				grid.hideColumn("cshmm");//隐藏初始化密码
				grid.hideColumn("usbkeyset");//隐藏usb设置
				grid.hideColumn("setaccountrelation");//隐藏帐号关联设置
				grid.hideColumn("syncthirdparty");//隐藏同步第三方设置
				if(e.isSoaSyncRole==true){
					grid.hideColumn("pzjs");
				}
			} else if (e.showDelBtn == false) {
				mini.get('deleteUser').setVisible(false);
			}

			if (e.showUserSwitch != "1") {
				grid.hideColumn("userswitch");//隐藏用户切换 
			}
			
			if (e.isSheMi == 'false') {//要隐藏掉涉密信息列
				grid.hideColumn("edit");
			}

			isMultiAccountMode = e.isMultiAccountMode;
			if (e.isMultiAccountMode == 1) {
				grid.hideColumn("jzqk");//隐藏兼职情况
			} else if (e.isMultiAccountMode == 0) {
				grid.hideColumn("setaccountrelation");//隐藏帐号关联设置
			}
			if (e.isSyncThirdParty == 0) {
				//隐藏同步第三方设置
				grid.hideColumn("syncthirdparty");
			}
			
			// 部门管理下，隐藏切换账号模式
			if (isSub == "1") {
				mini.get('changeAccountMode').setVisible(false);
			}
			
			if (e.enableThreeManage) {
				enableThreeManage = true;
				$('#helper').hide();
				mini.get('uploader').setVisible(false);
				if(e.role) {
					if (e.role.indexOf('systemadmin') >= 0 
							&& e.role.indexOf('securityadmin') == -1) {
						userRole = 'systemadmin';
						mini.get('setUserEnable').setVisible(false);
						grid.hideColumn("ckmk");
						grid.hideColumn("pzjs");
					}
					else if (e.role.indexOf('securityadmin') >= 0 
							&& e.role.indexOf('systemadmin') == -1) {
						userRole = 'securityadmin';
						mini.get('addUser').setVisible(false);
						mini.get('deleteUser').setVisible(false);
						mini.get('saveAll').setVisible(false);
						mini.get('moveUser').setVisible(false);
						mini.get('moveUserRole').setVisible(false);
						mini.get('morebtn').setVisible(false);
						grid.hideColumn("jzqk");
						grid.hideColumn("setaccountrelation");
						grid.hideColumn("copyColumn");
						grid.hideColumn("cshmm");
						grid.hideColumn("msgsz");
						grid.hideColumn("usbkeyset");
						grid.showColumn("pzjs");
					}
					else {
						userRole = e.role;
					}
				}
			}
		}
		
		function cellBeginEdit(e) {
			if(enableThreeManage && userRole.indexOf('securityadmin') >= 0 
					&& userRole.indexOf('systemadmin') == -1 && e.field == 'orderNumber') {
				e.cancel = true;
			}
		};

		$(document).ready(function() {
			// 将导出按钮文字设置为“导出”
			$("#dataexport").find(".mini-button-text").text("导出")
			$("#dataexport").click(function(e) {
				$("#dataexport").find(".mini-button-text").text("导出")
			});
		});

		//树js对象
		var tree = mini.get("tree");
		// 点击左侧树刷新右侧表格
		tree.on("nodeselect",
				function(e) {
					if (e.node) {
						var id = e.node.id;
						//将左侧树点击的节点id放到隐藏域中
						mini.get('leftTreeNodeGuid').setValue(
								id == 'f9root' ? "" : id);
					}
					//刷新表格
					searchData();
				});

		// 表格的搜索
		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		}

		//修改回调
		function editCallBack(param) {
			if (param) {
				epoint.refresh([ 'tree' ]);
				epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
			}
		}

		//修改用户js
		function updateUser(userGuid) {
			epoint
					.openDialog("修改用户",
							'framemanager/orga/orga/user/frameuseredit?isSub='
									+ isSub + '&userGuid=' + userGuid, editCallBack, {
								'width' : 1100,
								'height' : 580
							});
		}

		//重新绘制用户名称列
		function onDisplayNameRender(e) {
			var url = e.value;
			if (enableThreeManage && userRole.indexOf('securityadmin') >= 0 
					&& userRole.indexOf('systemadmin') == -1) {
				return url;
			}
			var userGuid = e.row['userGuid'];
			var enableSOA = e.row['enableSOA'];
			var isCopy = e.row['isCopy'];
			if (!enableSOA) {
				if(isCopy == "1") {
					url = "<a style=\"cursor:pointer\" onclick=\"updateUser('"
						+ userGuid + "')\" >" + e.value + "<font color='red'>（关联账号）</font></a>";
				}
				else {
					url = "<a style=\"cursor:pointer\" onclick=\"updateUser('"
						+ userGuid + "')\" >" + e.value + "</a>";
				}
			}
			if (e.row['canOperateBaseOu'] == 0) {
				url = "<div>" + e.value + "</div>";
			}
			return url;
		}

		//配置兼职
		function showSecondOu(userGuid, isCopy) {
			if (isCopy == 1) {
				epoint.alert('关联账号不允许这么操作', '', '', 'warning');
			} else {
				epoint.openDialog("用户兼职设定",
						'framemanager/orga/orga/user/framesecondoulist?userGuid='
								+ userGuid + '&isSub=' + isSub, function() {
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						}, {
							'width' : 1200,
							'height' : 600
						});
			}
		}

		//绘制兼职链接
		function onJzqkRender(e) {
			var userGuid = e.row['userGuid'];
			var isCopy = e.row['isCopy'];
			var styleStr = "";
			if (e.value == '有兼职') {
				styleStr = " style=\"cursor:pointer;color:red;\" ";
			} else {
				styleStr = " style=\"cursor:pointer;\" ";
			}
			if (e.row['canOperateBaseOu'] == 0) {
				return "<div>" + e.value + "</div>";
			}
			return "<a " + styleStr + " onclick=\"showSecondOu('" + userGuid
					+ "','" + isCopy + "')\" >" + e.value + "</a>";
		}

		//绘制状态列
		function onZtRender(e) {
			var ztValue = e.value;
			if (ztValue == '禁用') {
				return "<span style=\"color:red;\">" + ztValue + "</span>";
			}
			return ztValue;
		}

		//打开复制页
		function createUser(userGuid) {
			epoint.openDialog("复制用户",
					'framemanager/orga/orga/user/frameusercreate?isSub='
							+ isSub + '&userGuid=' + userGuid, addCallBack, {
						'width' : 1000,
						'height' : 580
					});
		}

		//绘制复制列
		function onCopyRender(e) {
			return epoint.renderCell(e, "action-icon icon-copy", "createUser",
					"userGuid");
		}

		// 初始化密码回调
		function rePasswordCallback(data) {
			if (data.success) {
				epoint.refresh([ 'datagrid', 'tree', 'fui-form' ], '', true);
				epoint.alert(data.msg, '', null, 'success');
			}
			else{
				if (data.msg) {
					epoint.alert(data.msg, '', null, 'warning');
				}
			}
		}

		//初始化密码
		function rePassword(userGuid, isCopy) {
			if (isCopy == 1) {
				epoint.alert('关联账号不允许这么操作', '', '', 'warning');
			} else {
				epoint.execute('rePassword', 'fui-form', '[' + userGuid + ']',
						rePasswordCallback);
			}
		}

		//绘制初始化密码列
		function onCshmmRender(e) {
			if (e.row['canOperateBaseOu'] == 0) {
				return "<div></div>";
			}
			var userGuid = e.row['userGuid'];
			var isCopy = e.row['isCopy'];
			return "<a  style=\"cursor:pointer;\"  onclick=\"rePassword('"
					+ userGuid + "','" + isCopy + "')\" >初始化</a>";
		}

		//设置usbKey
		function keySet(userGuid, isCopy) {
			if (isCopy == 1) {
				epoint.alert('关联账号不允许这么操作', '', '', 'warning');
			} else {
				epoint.openDialog("USB 设置",
						'framemanager/orga/orga/user/usbkeyset?userGuid='
								+ userGuid+ "&isSub=" + isSub, '', {
							'width' : 950,
							'height' : 550
						});
			}
		}

		//绘制usb设置列
		function onUsbkeysetRender(e) {
			if (e.row['canOperateBaseOu'] == 0) {
				return "<div></div>";
			}
			var userGuid = e.row['userGuid'];
			var isCopy = e.row['isCopy'];
			return "<a  style=\"cursor:pointer;\"  onclick=\"keySet('"
					+ userGuid + "','" + isCopy + "')\" >" + e.value + "</a>";
		}

		//打开秘书岗
		function setSecretaryInfo(userGuid, isCopy) {
			if (isCopy == 1) {
				epoint.alert('关联账号不允许这么操作', '', '', 'warning');
			} else {
				epoint.openDialog("秘书岗设置",
						'framemanager/orga/orga/user/settingsecretaryinfo?userGuid='
								+ userGuid + '&isSub=' + isSub, '', {
							'width' : 700,
							'height' : 650
						});
			}
		}

		//秘书岗设置
		function onMsgszRender(e) {
			if (e.row['canOperateBaseOu'] == 0) {
				return "<div></div>";
			}
			var userGuid = e.row['userGuid'];
			var isCopy = e.row['isCopy'];
			return "<a  style=\"cursor:pointer;\"  onclick=\"setSecretaryInfo('"
					+ userGuid + "','" + isCopy + "')\" >设置</a>";
		}

		//打开模块页
		function showModule(userGuid) {
			epoint.openDialog("查看模块",
					'framemanager/orga/orga/user/showusermodule?userGuid='
							+ userGuid, '', {
						'width' : 400,
						'height' : 400
					});
		}

		//查看模块
		function onCkmkRender(e) {
			var userGuid = e.row['userGuid'];
			return "<a  style=\"cursor:pointer;\"  onclick=\"showModule('"
					+ userGuid + "')\" >查看模块</a>";
		}
		//打开模块页
		function selectModule(userGuid) {
			var tUrl = 'framemanager/orga/uiset/menu/module/subscribemodule/subscribemoduletree?userGuid='
					+ userGuid;
			if (isSub && isSub == "1") {
				tUrl = 'framemanager/orga/uiset/menu/module/sub/subsubscribemoduletree?userGuid='
						+ userGuid;
			}
			epoint.openDialog("订阅模块", tUrl, '', {
				'width' : 1000,
				'height' : 800
			});
		}

		//授权模块
		function onSelectUserModuleRender(e) {
			var userGuid = e.row['userGuid'];
			return "<a  style=\"cursor:pointer;\"  onclick=\"selectModule('"
					+ userGuid + "')\" >订阅模块</a>";
		}
		
		// 授权角色
		function onSelectRoleRender(e) {
			var userGuid = e.row['userGuid'];
			return "<a  style=\"cursor:pointer;\"  onclick=\"selectRole('"
					+ userGuid + "')\" >配置角色</a>";
		}
		
		//打开授权角色设置页
		function selectRole(userGuid) {
			epoint.openDialog("设置用户角色关系",
					'framemanager/orga/orga/user/settinguserrole?userGuid='
							+ userGuid + "&isSub=" + isSub, '', {
						'width' : 680,
						'height' : 480
					});
		}

		// 关联账号
		function onSetAccountRelation(e) {
			var userGuid = e.row['userGuid'];
			var isCopy = e.row['isCopy'];

			return "<a  style=\"cursor:pointer;\"  onclick=\"setAccountRelation('"
					+ userGuid + "','" + isCopy + "')\" >关联账号</a>";
		}

		//打开关联账号设置页
		function setAccountRelation(userGuid, isCopy) {
			if (isCopy == 1) {
				epoint.alert('关联账号不允许这么操作', '', '', 'warning');
			} else {
				epoint.openDialog("设置关联账号",
						'framemanager/orga/orga/user/settingaccountrelation?userGuid='
								+ userGuid + "&isSub=" + isSub, '', {
							'width' : 1200,
							'height' : 600
						});
			}
		}

		//新增回调
		function addCallBack(param) {
			if (param) {
				epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
			}
		}

		//新增用户
		function addUser() {
			var ouGuid = mini.get('leftTreeNodeGuid').getValue();
			epoint.openDialog("新增用户",
					'framemanager/orga/orga/user/frameuseradd?isSub=' + isSub
							+ '&leftTreeNodeGuid=' + ouGuid, addCallBack, {
						'width' : 1000,
						'height' : 580
					});
		}

		// 回diao提醒
		function msgCallBack(data) {
			var msg = data.msg;
			if (msg) {
				//if (msg.indexOf("成功") == -1) {
				//	epoint.alert(msg, '', '', 'warning');
				//} else {
				//	epoint.alert(msg, '', searchData());
				//}
				if (data.success) {
					epoint.alert(msg, '', function() {
						epoint.refresh([ 'datagrid', 'fui-form' ], '', true);

					}, 'success');
				} else {
					epoint.alert(msg, '', '', 'warning');
				}
			}
			searchData();
		}

		//删除选中
		function deleteSelected() {
			epoint.execute('deleteSelected', [ 'datagrid',
					'fui-form' ], msgCallBack);
		}
		//保存排序
		function saveAll() {
			grid.validate();
			if (grid.isValid() == false) {
				//alert("请校验输入单元格内容");
				var error = grid.getCellErrors()[0];
				grid.beginEditCell(error.record, error.column);
				return;
			}
			epoint.execute('saveAll', [ 'datagrid', 'fui-form' ], msgCallBack);
		}

		//转移用户回调
		function moveuserCallBack(data) {
			if (data) {
				if (data != 'close') {
					epoint.confirm('确认转移吗?', '', function(){
						var s = data.split(";");
						if (s[1] != 'f9root') {
							epoint.execute('moveUser', '', '[' + s[1] + ',' + epoint.encodeUtf8(s[0]) + ']',
									msgCallBack);
						}
					});
				}
			}
		}

		//转移选中
		function moveuser() {
			var url = "framemanager/orga/orga/ou/selectou?type=1";
			if (isSub && isSub == "1") {
				url = url + "&isSub=1";
			}
			epoint.openDialog("转移用户", url, moveuserCallBack, {
				'width' : 300,
				'height' : 500
			});
		}
		
		var roles = '';
		var users = '';
		//用户角色转移
		function moveuserrole(){
		     var selectedItemIds = grid.getSelectedIds();
			 var userGuid = '';
			 if(selectedItemIds.length>0){
			     userGuid = selectedItemIds[0];
			 }
			 var url = 'framemanager/orga/orga/role/userroleselect?userGuid='+ userGuid;
			 if (isSub && isSub == "1") {
					url = url + "&isSub=1";
				}
		     epoint.openDialog("转移角色选择", url,
					selectRoleCallback, {
						'width' : 800,
						'height' : 500
					});
		}
		
		function selectRoleCallback(rtnValue){
		    if(rtnValue && rtnValue !='close'){
			   roles = rtnValue;
			   epoint.openDialog("转移用户对象选择", 'framemanager/orga/orga/user/selectuser',
					selectUserCallback, {
						'width' : 1200,
						'height' : 500
					});
		    }
		}
		
		function selectUserCallback(rtnValue){
		    if(rtnValue && rtnValue !='close'){
			    users = rtnValue;
			    epoint.execute('moveUserRole','',[roles,users], msgCallBack);
		    }
		}
		
		/*
		function moveuserroleCallBack(data){
			if(data){
				if(data != 'close'){
					epoint.confirm('确认转移用户角色吗?', '', function(){
						var s = data.split(";");
						if (s[1] != 'f9root') {
							epoint.execute('moveUserRole', '', '[' + s[1] + ',' + epoint.encodeUtf8(s[0]) + ']',
									msgCallBack);
						}
					});
				}
			}
		}*/

		//启用/禁用
		function setUserEnable() {
			epoint.execute('setUserEnable', [ 'datagrid', 'fui-form' ],
					msgCallBack);
		}

		function onFileSuccess(e) {
			if (e.data && e.data.extraDatas.msg) {
				epoint.alert(e.data.extraDatas.msg, '', null, 'info');
				epoint.refresh([ 'tree' ]);
			}
		}
		function onCheckRender(e) {
			//此功能只是隐藏掉选择框，但是还是可以被选到的，注意！！！！，要配合beforeselect使用
			if (e.record.canOperateBaseOu) {
				var canOperateBaseOu = e.row['canOperateBaseOu'];
				if (canOperateBaseOu == "0" && e.cellCls === "mini-checkcolumn") {
					e.cellHtml = "";
				}
			}
		}
		grid.on("beforeselect", function(e) {
			if (e.record.canOperateBaseOu) {
				var canOperateBaseOu = e.row['canOperateBaseOu'];
				if (canOperateBaseOu == "0") {
					e.cancel = true;
				}
			}
		});

		var onLoginRenderer = function(e) {
			var userGuid = e.row['userGuid'];
			var isCopy = e.row['isCopy'];
			return "<a class=\"action-icon modicon-91\"  onclick=\"userLogin('"
				+ userGuid + "','" + isCopy + "')\" ></a>";
		};

		function userLogin(id, isCopy) {
			if (isCopy == 1) {
				epoint.alert('关联账号不允许这么操作', '', '', 'warning');
			} else {
				epoint.execute('getLoginUrl', null, id, function(e) {
					var url = Util.getRootPath() + e.url;
					epoint.confirm('确认切换账号？', '系统提醒', function() {
						top.location.href = url;
					});
				});
			}
		}

		function changeAccountMode() {
			var info = "";
			if (isMultiAccountMode == 1) {
				info = '当前账号模式为多账号模式，是否确认切换为兼职模式，切换后关联账号对应的所有数据都将失效！';
			} else if (isMultiAccountMode == 0) {
				info = '当前账号模式为兼职模式，是否确认切换为多账号模式，切换后兼职对应的所有数据都将失效！';
			}
			epoint.confirm(info, '切换模式', confirmChangeAccountMode);
		}

		function confirmChangeAccountMode() {
			var mode = 0;
			if (isMultiAccountMode == 1) {
				mode = 0;
			} else if (isMultiAccountMode == 0) {
				mode = 1;
			}
			epoint.execute('modifyAccountMode', '', [ mode ], function(data) {
				var msg = data.msg;
				if (msg) {
					if (data.success) {
						epoint.alert(msg, '', function(){
							Util. getSafeLocation().href = Util. getSafeLocation().href;
						}, 'success');
					} else {
						epoint.alert(msg, '', '', 'warning');
					}
				}
			});
		}

		// 提示区域
		var infoBox = mini.get('info-box');
		// 进度条
		var progressbar = mini.get('move-progressbar');
		// 总数
		var $infoCountAll = $('#info-box-all'),
		// 当前数据
		$infoCountCurr = $('#info-box-curr'),
		// 转移中提示
		$moveingTips = $('#info-box-moving'),
		// 暂停中提示
		$pausingTips = $('#info-box-moving');

		// var IS_PAUSED = false;


		// 增加步长
		function addStepSize() {

			// 打开步长选择对话框
			epoint
					.openDialog(
							'选择步长',
							'frame/pages/basic/stepsize/selectstepsize?data=2,3,5,10,20',
							dealSelectStepSize, {
								width : 600,
								height : 300
							});
		}

		// 选择步长的回调
		function dealSelectStepSize(rtnValue) {
			if (rtnValue && rtnValue != 'close') {
				epoint.execute("addUserStepSize?stepsize=" + rtnValue,
						[ 'fui-form' ], function(data) {
							epoint.alert(data.msg, '', null, 'info');
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						});
			}
		}
		//绘制同步列
		function onThirdPartyRender(e) {
			var ztValue = e.value;
			if (ztValue != '否') {
				return "<span style=\"color:green;\">" + ztValue + "</span>";
			}
			return ztValue;
		}
		//授权/取消
		function setUserSyncThirdParty() {
			epoint.execute('setUserSyncThirdParty', [ 'datagrid', 'fui-form' ],
					msgCallBack);
		}
		//]]>
	</script>


</body>
</html>