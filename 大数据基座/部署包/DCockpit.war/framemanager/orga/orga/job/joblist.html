<!DOCTYPE html>
<html lang="zh-CN">

<head>
<title>职位管理列表</title>
<meta charset="UTF-8"/>
<meta http-equiv="content-type" content="text/html" />
<script src="../../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>

	<div class="fui-left">
		<div role="head" title="选择部门"></div>
		<div role="body">
			<ul id="tree" name="tree" class="mini-tree"
				style="width: 100%; height: 100%" autoLoad="false"
				showTreeIcon="true" textField="text" idField="id" parentField="pid"
				action="getTreeModel" resultAsTree="false">
			</ul>
		</div>
	</div>

	<div class="fui-right">
		<!-- toolbar区域 -->
		<div class="fui-toolbar">
			<div class="btn-group mr10">
				<a class="mini-button" iconCls="icon-addcircle" id="btnAddRecord" onclick="addJob();">新增职位</a> 
				<a class="mini-button" iconCls="icon-save" id="btnUpdate" onclick="numberUpdate();">更新排序</a>
				<a class="mini-button mini-btn-danger" iconCls="icon-minuscircle" id="btnDel"
					onclick="if(mini.get('datagrid').getSelecteds().length==0){epoint.alert('请选择要删除的记录!', '', null, 'warning');} else {epoint.confirm('确认要删除吗?','',deleteSelect);}">删除选中
				</a> 				
			</div>
		</div>

		<!-- 条件区域 -->
		<div class="fui-condition">
			<div class="fui-form" id="fui-form">
				<div id="cform" role="form">
					<div role="row">
						<div role="control" label="职位名称">
							<input id="search_JobName" class="mini-textbox"
								bind="joblistaction.searchString" emptyText="" onkeyenter="searchData();" />
						</div>
						<div role="control" label="所属用户">
							<input id="search_BelongDisplayName" class="mini-textbox"
								bind="joblistaction.searchString1" onkeyenter="searchData();" />
						</div>
					</div>
				</div>
				<input bind="joblistaction.leftTreeNodeGuid" id="ouGuid" class="mini-hidden" /> 
				<input bind="joblistaction.frameJob.jobGuid" id="jobGuid" class="mini-hidden" />
			</div>
			<a role="searcher" callback="searchData"></a>
		</div>

		<!-- 内容区域 -->
		<div id="fuiContent" class="fui-content">
			<div id="datagrid" name="datagrid" class="mini-datagrid"
				idField="jobGuid" multiSelect="true" action="getDataGridData"
				showPager="true" style="width: 100%; height: 100%;"
				allowResize="true" allowCellEdit="true"
				allowCellSelect="true" allowCellValid="true"
				editNextOnEnterKey="true" editNextRowCell="true">
				<div property="columns">
					<div type="checkcolumn" width="50"></div>
					<div type="indexcolumn" width="50" headerAlign="center">序</div>
					<div field="jobName" width="150"  headerAlign="center">职位名称</div>
					<div field="ouName" width="150" headerAlign="center">部门</div>
					<div field="belongUserName" headerAlign="center" width="100%">所属用户</div>
					<div field="orderNumber" width="80" headerAlign="center" align="right" vtype="int;range:0,99999999">
						排序号<input property="editor" class="mini-textbox" minWidth="20" 
						  inputStyle="text-align:right" vtype="int;range:0,99999999"/>
					</div>
					<div width="80" align="center" headerAlign="center"
						renderer="onEditRenderer">修改</div>
				</div>
			</div>
		</div>
	</div>
	<script src="../../../../rest/resource/jsboot"></script>

	<script>
	//<![CDATA[
		// 初始化页面
		epoint.initPage('joblistaction');

		//树js对象
		var tree = mini.get("tree");
		
		var grid = mini.get("datagrid");

		// 点击左侧树刷新右侧表格
		tree.on("nodeselect", function(e) {
			var id = e.node.id;
			//将左侧树点击的节点id放到隐藏域中
			mini.get('ouGuid').setValue(id=='f9root'?"":id);
			//刷新表格
			updateTable_tree();
		});
		
		function addJob() {
			var ouGuid = mini.get('ouGuid').getValue();
			var settings = {
				'width' : 1000,
				'height' : 520
			};
			epoint.openDialog('新增职位', 'framemanager/orga/orga/job/job?ouGuid=' + ouGuid, addCallBack, settings);
		}

		// 绘制行编辑按钮
		var onEditRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "editJob","jobGuid");
		};
		
		function editJob(jobGuid) {
			var settings = {
				'width' : 1000,
				'height' : 520
			};
			epoint.openDialog('修改职位', 'framemanager/orga/orga/job/job?jobGuid=' + jobGuid, addCallBack, settings);
		}

		//新增回调
		function addCallBack(param) {
			if (param) {
				epoint.refresh([ 'datagrid', 'fui-form', "tree" ],'',true);
			}
		}

		// 保存排序码刷新页面
		function numberUpdate() {
			grid.validate();
			if (grid.isValid() == false) {
				var error = grid.getCellErrors()[0];
				grid.beginEditCell(error.record, error.column);
				return;
			}
			epoint.execute('numberUpdate', '', callback);
		}

		function callback(data) {
			if (data.msg) {
				epoint.alert(data.msg, '', function(){
					epoint.refresh([ 'datagrid', 'fui-form', "tree" ],'',true);
				}, 'info');
			}
		}

		// 删除数据
		function deleteSelect() {
			epoint.execute("deleteSelect", ['datagrid','fui-form'], callback);
		}
		
		function updateTable_tree() {
			epoint.refresh([ "datagrid", "fui-form" ]);
		}
		
		// 表格的搜索
		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form', "tree" ]);
		}
		//]]>
	</script>
</body>
</html>