<!DOCTYPE html>
<html>
<head>
<title>脚本检测</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
<link href="css/bootstrap.min.css" rel="stylesheet" />
<link href="css/style.css" type="text/css" rel="stylesheet" />
<link href="css/bootstrap.css" rel="stylesheet" />

<style>
.hideerr {
	color: red;
}
</style>
</head>
<style>
body, html {
	overflow: auto !important;
}
</style>
<body class="body-content">
	<div class="page-loading"></div>

	<div class="container">
		<div>
			sql：所有脚本可直接复制到sql server查询设计器中执行 <br />
			oracle：如需手工在PL/SQL中执行，把语句拷贝到查询设计器，然后将下一行BEGIN和最后一行的END;前的注释去除即可 <br />
			mysql：如需手工在navicat中执行，把语句拷贝到查询设计器，然后将下一行DELIMITER GO和最后一行的DELIMITER ;
			注释去除即可
		</div>
		<form method="post" id="sqlForm" action="">
			<table style="background-color: #fff"
				class="showtable table table-bordered responsive-utilities"
				id="sqltable">
				<tr>
					<td style="width: 20%; font-weight: bold">脚本版本</td>
					<td style="width: 20%; font-weight: bold">是否更新</td>
					<td style="width: 20%; font-weight: bold">ִ执行更新</td>
					<td style="width: 20%; font-weight: bold">脚本详情</td>
					<td style="width: 20%; font-weight: bold">ִ更新说明</td>
				</tr>
			</table>
			<input type="hidden" name="doUpdateIndex" id="doUpdateIndex" />
		</form>
	</div>
</body>

<script src="js/sm2security.js" type="text/javascript" charset="utf8"></script>

<script src="js/jquery.min.js" type="text/javascript" charset="utf8"></script>
<script src="js/template-web.js" type="text/javascript" charset="utf8"></script>
<script src="js/common.js" type="text/javascript" charset="utf8"></script>
<script src="js/bootstrap.min.js" type="text/javascript" charset="utf8"></script>

<!-- 配置变量 -->
<script>
	//<![CDATA[
	//初始化页面
	var showDiv;
	var sm2PubKey;
	$
			.getJSON(
					'../../eianalysesqllist/checkSql',
					function(data) {
						if (data) {
							var html = "";
							sm2PubKey = data[data.length - 1].sm2PubKey;
							for (var i = 0; i < data.length - 1; i++) {
								html += "<tr>";
								html += "<td width='20%'>" + data[i].dateDir
										+ "</td>";
								html += "<td width='20' class='ischeck'>"
										+ data[i].check + "</td>";
								if (data[i].check.indexOf('无需更新') >= 0) {
									html += "<td width='20%'>无需更新</td>";
								} else {
									html += "<td width='20%'><a href='javascript:;' onclick='doUpdate("
											+ i + ")'>更新脚本</a></td>";
								}
								html += "<td width='20%'><a onclick='toggleDiv($(\".hidesql\").eq("
										+ i + "));'>查看</a></td>";
								html += "<td width='20%'><a onclick='toggleDiv($(\".hidedesc\").eq("
										+ i + "));'>查看</a></td>";
								html += "</tr>";
								html += "<tr class='hidesql' id='hidesql"+ i +"'>";
								html += "<td colspan='5'>";
								if (data[i].update) {
									html += data[i].update.replace("\r\n",
											"<br/>");
								}
								html += "</td></tr>";
								html += "<tr class='hidedesc' id='hidedesc"+ i +"'>";
								html += "<td colspan='5'>"
										+ data[i].description + "</td>";
								html += "</tr><tr>";
								html += "<td class='hideerr' colspan='5'>"
										+ data[i].error + "</td>";
								html += "</tr><tr>";
								html += "<td class='hidepath' colspan='5'>"
										+ data[i].path + "</td>";
								html += "</tr>";
							}
							$("#sqltable").append(html);
							/* var result = template("eachTemplate",data);
							var eachBox = document.getElementById("sqltable");
							eachBox.innerHTML = result;*/
							hideAll(true);
						}
					});

	function doUpdate(i) {
		var filepath = $('.hidepath').eq(i).html();
		if (sm2PubKey != '') {
			filepath = sm2Encrypt(filepath, sm2PubKey, 0);
		}
		if (filepath) {
			$.getJSON('../../eianalysesqllist/updateSql?filepath='
					+ encodeURI(filepath), function(data) {
				$('.hideerr').eq(i).html(data.result);
				toggleDiv($('.hideerr').eq(i));
				showDiv = false;
				if (data.result == 'Ok') {
					$('.ischeck').eq(i).html('已更新')
				} else {
					alert("更新失败");
				}
			});
		}
	}

	function hideAll(showerror) {
		$('.hidesql').hide();
		$('.hidedesc').hide();
		$('.hidepath').hide();
		$('.hideerr').each(function() {
			if ($(this).html().trim() == "")
				$(this).hide();
			else if ($(this).html().trim() == "OK") {
				$(this).hide();
				$(this).html("");
			} else {
				showDiv = $(this);
				$(this).show();
			}
		});
	}

	function toggleDiv(tDiv) {
		if (showDiv) {
			showDiv.hide();
			if (showDiv[0].id != tDiv[0].id) {
				showDiv = tDiv;
				showDiv.show();
			} else
				showDiv = null;
		} else {
			showDiv = tDiv;
			showDiv.show();
		}
	}
	//]]>
</script>
</html>
