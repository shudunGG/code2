"use strict";Util.loadJs(["pages/common/common.js","js/widgets/fileinput/fileinput.js"],function(){customBiz.configReady()});var customBiz={configReady:function(){var e=this;Config.configReady([],function(){e.initListeners()},function(e){})},initListeners:function(){var e=this;e.modulename=Util.getExtraDataByKey("modulename"),e.moduleguid=Util.getExtraDataByKey("moduleguid"),e.isLock=!1,e.questiontype="报错",e.deviceinfo="",e.userguid="",e.imageNames=[],e.domain="",mui("body").on("tap",".g-form-button",function(){e.checkInputFormat()&&e.submit()}),document.querySelector("#content").addEventListener("input",function(){if(!e.isLock){var t=this.value.length;document.querySelector(".word-number").innerText=t,t>=250?document.querySelector(".word-number").classList.add("red-star"):document.querySelector(".word-number").classList.remove("red-star")}}),document.querySelector("#content").addEventListener("compositionstart",function(){e.isLock=!0}),document.querySelector("#content").addEventListener("compositionend",function(){var t=this.value.length;e.isLock=!1,document.querySelector(".word-number").innerText=t,t>=250?document.querySelector(".word-number").classList.add("red-star"):document.querySelector(".word-number").classList.remove("red-star")}),mui(".mui-content").on("tap",".g-question-btn",function(){var t=this,n=document.querySelectorAll(".g-question-btn"),i=t.innerText;e.questiontype=i;for(var o=0;o<n.length;o++)n[o].classList.remove("active");t.classList.add("active")}),new FileInput({container:"#upload-img",isMulti:!1,type:"Image_Camera",success:function(t,n,i){var o=Util.uuid();n.uuid=o,e.uploadImg(n)},error:function(e){console.error(e)}}),mui(".mui-content").on("tap",".upload-img-del",function(){var t=this,n=document.querySelector(".g-upload-frame").querySelectorAll(".uploadimg"),i=t.parentNode.getAttribute("uuid"),o=n.length;ejs.ui.confirm({title:"提示",message:"是否删除该附件！",buttonLabels:["取消","确定"],cancelable:1,success:function(r){if(1===r.which)for(var u=0;u<n.length;u++)if(n[u].getAttribute("uuid")===i){var s=t.parentNode,a=e.imageNames.indexOf(n[u].getAttribute("imgname"));e.imageNames.splice(a,1),o-=1,t.parentNode.parentNode.removeChild(s),document.querySelector(".img-num").innerText=o,o<3&&(document.querySelector(".img-num").classList.remove("red-star"),document.querySelector(".upload-btn").classList.remove("mui-hidden"))}},error:function(e){}})}),mui(".mui-content").on("tap",".uploadimg img",function(){for(var e=document.querySelector(".g-upload-frame").querySelectorAll(".uploadimg"),t=[],n=0,i=this.getAttribute("src"),o=0;o<e.length;o++)t.push(e[o].querySelector("img").getAttribute("src")),i===e[o].querySelector("img").getAttribute("src")&&(n=o);ejs.util.prevImage({index:n,selectedPhotos:t,success:function(e){},error:function(e){}})}),ejs.auth.getUserInfo({success:function(t){e.userguid=JSON.parse(t.userInfo).userguid,e.username=JSON.parse(t.userInfo).displayname},error:function(e){}}),ejs.device.getVendorInfo({success:function(t){Util.os.ios?e.deviceinfo=t.uaInfo.replace(/iOS/,""):Util.os.android&&(e.deviceinfo=t.uaInfo.replace(/android/,""))},error:function(e){}}),ejs.runtime.getAppVersion({success:function(t){e.appversion=t.version},error:function(e){}}),e.osVersion=e.getOSVersion(),console.log(e.osVersion),ejs.runtime.getPlatformUrl({success:function(t){e.domain=t.platformUrl},error:function(e){}})},getOSVersion:function(){var e=null,t=navigator.userAgent,n=t.indexOf("Android")>-1||t.indexOf("Linux")>-1,i=!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);if(n){var o=/android [\d._]+/gi,r=t.match(o);e=(r+"").replace(/[^0-9|_.]/gi,"").replace(/_/gi,".")}if(i){var u=/os [\d._]+/gi,s=t.match(u);e=(s+"").replace(/[^0-9|_.]/gi,"").replace(/_/gi,".")}return e},uploadImg:function(e){var t=this;ejs.ui.showWaiting("正在加载..."),Util.upload({url:t.domain+"feedbackImageUpload",files:[{name:e.name,file:e}],isEncrypt:!1,beforeSend:function(){},success:function(n,i,o){if(1===n.status.code){var r=[],u="",s=document.getElementById("img-tmp").innerHTML,a=new RegExp("/client/"),c=t.domain.replace(a,"/file/getFile");r.push({uuid:e.uuid,url:c+"?fileName="+n.custom.imageNames+"&outname=",imageNames:n.custom.imageNames}),mui.each(r,function(e,t){u+=Mustache.render(s,t)}),Zepto(".g-upload-frame").prepend(u);var m=document.querySelector(".g-upload-frame").querySelectorAll(".uploadimg"),d=m.length;document.querySelector(".img-num").innerText=d,d>=3&&(document.querySelector(".img-num").classList.add("red-star"),document.querySelector(".upload-btn").classList.add("mui-hidden")),t.imageNames.push(n.custom.imageNames),ejs.ui.closeWaiting()}else ejs.ui.toast("上传失败，请重试~")},error:function(e,t,n){ejs.ui.closeWaiting()},uploading:function(e,t,n){ejs.ui.closeWaiting(),console.log("上传中:"+e+",speed:"+t+",msg:"+n)}})},submit:function(){var e=this,t=e.imageNames.join(";");ejs.runtime.getAppKey({success:function(n){var i={userid:e.userguid,content:document.querySelector("#content").value,appguid:n.appKey,deviceinfo:e.deviceinfo,displayname:e.username,moduleguid:e.moduleguid,modulename:e.modulename,errorstatus:e.questiontype,devicesystemversion:e.osVersion,appversion:e.appversion,frameversion:"",imageNames:t,platform:Util.os.ios?6:5};common.ajax({url:e.domain+"feedback",data:i,isShowWaiting:!0,isEncrypt:!1},function(e){1===e.status.code?(ejs.ui.toast("提交成功！"),ejs.page.close({resultData:{key:"value2"}})):ejs.page.open({pageUrl:"./feedback_fail.html",pageStyle:1,orientation:1,data:{key1:"value1"},error:function(e){}})},function(e){ejs.ui.toast(Config.TIPS_II)},{isDebug:!1})},error:function(e){}})},checkInputFormat:function(){var e=!0,t=this,n=t.questiontype,i=document.querySelector("#content").value;return""==n?(ejs.ui.toast("请选择问题类型！"),e=!1):""==i&&(ejs.ui.toast("请填写问题描述！"),e=!1),e}};