"use strict";function initListeners(){isHidden=Util.getExtraDataByKey("isHidden")||"0",1==isHidden&&document.querySelector(".em-tool-share").classList.add("mui-hidden"),ejs.storage.getItem({key:"isShowTitle",success:function(e){isShowTitle=""==e.isShowTitle?{ouname:1,title:0,phone:0,mail:0,address:0}:JSON.parse(e.isShowTitle)},error:function(e){}}),saveAndShare(),ejs.os.ejs?ejsGetUserInfo().then(function(e){controlExplicit(isShowTitle),controlDiff(isShowTitle),buildQrcode(e.userguid).then(function(){document.querySelector(".mui-content").classList.remove("mui-hidden")}),console.log("都成功了")}):(alert("请在ejs容器中访问页面"),getUserId(function(e){isHidden=1,Promise.all([getUserInfo(e),getCoInfo()]).then(function(){buildQrcode(e).then(function(){document.querySelector(".mui-content").classList.remove("mui-hidden")}),console.log("都成功了")})["catch"](function(e){console.log(e),console.log("有任务失败了")})["finally"](function(){console.log("所有任务执行完毕")})})),mui(".mui-content").on("tap",".em-user-tel",function(){var e=this.getAttribute("tel");ejs.device.callPhone(e)}),mui(".em-toggle-div").on("tap",".mui-switch",function(e){var t=this,o=this.parentNode.getAttribute("is-show-type"),s=this.classList.contains("mui-active");if("co"==o&&0==coName)return void ejs.ui.alert({title:"提示",message:"请通知管理人员在中间平台增加公司名称参数",buttonName:"确定",cancelable:0,success:function(e){document.querySelector(".em-toggle-co-name .mui-active").classList.remove("mui-active"),document.querySelector(".em-toggle-co-name .mui-switch-handle").style.transform="translate(0px, 0px)"},error:function(e){}});var i=this.classList.contains("em-has-data");i||ejs.ui.alert({title:"提示",message:"请在个人信息中完善基本信息",buttonName:"确定",cancelable:0,success:function(e){t.classList.remove("mui-active"),t.querySelector(".mui-switch-handle").style.transform="translate(0px, 0px)"},error:function(e){}}),s?(isShowTitle[o]=1,console.log("打开状态")):(isShowTitle[o]=0,console.log("关闭状态")),console.log(isShowTitle)}),mui(".mui-content").on("tap",".em-tool-zdy",function(e){showToggle();var t={title:"个性化页面",url:"#toggle"};window.history.pushState(t,t.title,t.url)}),ejs.os.ios?window.addEventListener("popstate",function(e){backFun()},!1):ejs.os.android&&(ejs.navigator.hookSysBack({success:function(e){1==showTogglePage?backFun():ejs.page.close()},error:function(e){}}),ejs.navigator.hookBackBtn({success:function(e){1==showTogglePage?backFun():ejs.page.close()},error:function(e){}}))}function backFun(){0==isShowTitle.co?document.querySelector(".em-card-top").classList.add("flex-direction-row"):document.querySelector(".em-card-top").classList.remove("flex-direction-row"),document.querySelector('[is-show-type="ouname"] .mui-switch').classList.contains("mui-active")?isShowTitle.ouname=1:isShowTitle.ouname=0,document.querySelector('[is-show-type="title"] .mui-switch').classList.contains("mui-active")?isShowTitle.title=1:isShowTitle.title=0,document.querySelector('[is-show-type="phone"] .mui-switch').classList.contains("mui-active")?isShowTitle.phone=1:isShowTitle.phone=0,document.querySelector('[is-show-type="mail"] .mui-switch').classList.contains("mui-active")?isShowTitle.mail=1:isShowTitle.mail=0,document.querySelector('[is-show-type="address"] .mui-switch').classList.contains("mui-active")?isShowTitle.address=1:isShowTitle.address=0,hideToggle(),ejs.storage.setItem({isShowTitle:JSON.stringify(isShowTitle),success:function(e){},error:function(e){}}),controlExplicit(isShowTitle)}function controlExplicit(e){for(var t in e)e.hasOwnProperty(t)&&(console.log(t+" "+e[t]),0==e[t]?(console.log(t),document.querySelector("."+t).classList.add("mui-hidden")):1==e[t]&&document.querySelector("."+t).classList.remove("mui-hidden"))}function hideToggle(){showTogglePage=0,buildQrcode(),setTimeout(function(){document.querySelector(".em-toggle-div").classList.remove("em-toggle-show")},200),setTimeout(function(){document.querySelector(".em-toggle-div").classList.add("mui-hidden")},400),history.go(-1)}function showToggle(){showTogglePage=1,document.querySelector(".em-toggle-div").classList.remove("mui-hidden"),setTimeout(function(){document.querySelector(".em-toggle-div").classList.add("em-toggle-show")},100),setTimeout(function(){document.querySelector("#qrcode canvas").remove(),document.querySelector('#qrcode [alt="Scan me!"]').remove()},1e3)}function getUserId(e){var t=Util.getExtraDataByKey("userGuid")||"440c5ddb-af66-45cf-aa17-145382e6780b";""==t?ejs.auth.getUserInfo({success:function(t){var t=JSON.parse(t.userInfo);console.log(t.userguid);var o=t.userguid;e&&e(o)},error:function(e){}}):e&&e(t)}function ejsGetUserInfo(){return new Promise(function(e,t){ejs.util.invokePluginApi({path:"contact.provider.serverOperation",dataMap:{method:"getPersonalDetailInfo"},success:function(t){var o=t;console.log(t),processUserData(o).then(function(){e(o)})},error:function(e){alert(JSON.stringify(e))}})})}function getUserInfo(e){return new Promise(function(t,o){common.ajax({url:"address_getuserdetail_v7",data:{userguid:e},isShowWaiting:!1},function(e){if(e.status&&1==e.status.code){var o=e.custom;processUserData(o).then(function(){t()})}else ejs.ui.alert({title:"提示",message:e.status.text,buttonName:"确定",cancelable:0,success:function(e){ejs.page.close({resultData:{key:"value2"},success:function(e){}})},error:function(e){}})},function(e){var o={custom:{ccworksequenceid:"5365685463046424",loginid:"wsze",ouguid:"9579bbf9-31d0-4548-b78f-ea4392bf68f9",telephoneoffice:"58121212",sex:"男",mobile:"18651125426",postaladdress:"前端开发工程师前端开发工程师前端开发工程师前端开发工程师前端开发工程师前端开发工程师前端开发工程师前端开发工程师",title:"前端开发工程师",sequenceid:"5365685463046424",photourl:"rest/readpictureaction/getUserPicture?isCommondto=true&userGuid=440c5ddb-af66-45cf-aa17-145382e6780b&isMobile=true&md5=658f10519a47d9b57df7e3261232cd8e",userguid:"440c5ddb-af66-45cf-aa17-145382e6780b",baseouname:"系统管理部",postalcode:"",displayname:"吴松泽",ordernumber:1,fax:"",pinyininitials:"wsz",telephonehome:"",email:"461834849@qq.com",ouname:"系统管理部",shortmobile:""},status:{code:1,text:"请求成功"}};processUserData(o.custom).then(function(){t()})},{isDebug:!1})})}function processUserData(e){return new Promise(function(t,o){userInfo.displayname=e.displayname,userInfo.userguid=e.userguid,userInfo.ouname=e.ouname,userInfo.title=e.title,userInfo.phone=e.mobile,userInfo.mail=e.email,userInfo.address=e.postaladdress,e.photourl=Config.serverOA9Url+e.photourl;var s=document.getElementById("tmp-user").innerHTML,i=Mustache.render(s,e);userPhoto=e.photourl,document.querySelector(".qrcode__logo").setAttribute("src",userPhoto),document.querySelector(".qrcode__logo").setAttribute("alt",e.displayname),document.querySelector(".em-user-div").innerHTML=i;var n=document.getElementById("tmp-toggle").innerHTML,c=Mustache.render(n,e);document.querySelector(".em-toggle-div").innerHTML=c,mui(".mui-switch")["switch"](),t(userInfo)})}function getCoInfo(){return new Promise(function(e,t){ejs.os.ejs?(ejs.runtime.getPlatformUrl({success:function(t){rusinessRestUrl=t.platformUrl,console.log(rusinessRestUrl),ejs.runtime.getAppKey({success:function(t){var o=t.appKey,s={params:JSON.stringify({appguid:o})};Util.ajax({url:rusinessRestUrl+"getAppParams",data:s,isEncrypt:0,isAutoProxy:0,success:function(t){console.log("配置参数："+JSON.stringify(t)),"1"==t.status.code?(coName=0,isShowTitle.co=0,e()):ejs.ui.toast(t.status.text)}})},error:function(e){}})},error:function(e){}}),ejs.storage.getBusinessRestUrl({success:function(e){},error:function(e){}})):e()})}function buildQrcode(e){return new Promise(function(t,o){console.log(window.location.href+"?userGuid="+e),scanUrl(function(e){var e=e;console.log("url:"+e),document.querySelector('[alt="Scan me!"]')&&document.querySelector('[alt="Scan me!"]').remove(),new QRCode(document.getElementById("qrcode"),{text:e,width:370,height:370,colorDark:"#333",colorLight:"transparent",correctLevel:QRCode.CorrectLevel.Q}),t()})})}function saveAndShare(){var e="oacustomplugin.oacustomprovider.screenCaptureandShareAction";document.querySelector(".em-tool-share").addEventListener("tap",function(){document.querySelector(".em-tool-zdy").classList.add("mui-hidden"),0==isHidden?document.querySelector(".em-tool-share").classList.add("mui-hidden"):"",document.querySelector(".em-tool-save").classList.add("mui-hidden"),setTimeout(function(){document.querySelector(".em-tool-zdy").classList.remove("mui-hidden"),0==isHidden?document.querySelector(".em-tool-share").classList.remove("mui-hidden"):"",document.querySelector(".em-tool-save").classList.remove("mui-hidden")},3e3),setTimeout(function(){ejs.util.invokePluginApi({path:e,dataMap:{method:"screenCaptureToShare",islong:"0",longheight:document.querySelector("body").clientHeight},success:function(e){},error:function(e){var t=ejs.os.ios?"WPLAboutViewController":"com.epoint.app.oa.view.OA_AboutActivity";ejs.ui.alert({title:"提示",message:"分享失败，请更新OA至最新版本",buttonName:"去更新",cancelable:0,success:function(e){ejs.page.openLocal({className:t,isOpenExist:0,data:{key1:"value1"},success:function(e){},error:function(e){}})},error:function(e){}})}})},500)}),document.querySelector(".em-tool-save").addEventListener("tap",function(){document.querySelector(".em-tool-zdy").classList.add("mui-hidden"),document.querySelector(".em-tool-share").classList.add("mui-hidden"),document.querySelector(".em-tool-save").classList.add("mui-hidden"),setTimeout(function(){ejs.io.screenShot({captureType:1,success:function(e){ejs.ui.toast("已保存至相册"),document.querySelector(".em-tool-zdy").classList.remove("mui-hidden"),0==isHidden?document.querySelector(".em-tool-share").classList.remove("mui-hidden"):"",document.querySelector(".em-tool-save").classList.remove("mui-hidden")},error:function(e){}})},500)})}function scanUrl(e){getShortUrl(function(t){e&&e(t)})}function getShortUrl(e){ejs.runtime.getPlatformUrl({success:function(t){rusinessRestUrl=t.platformUrl,console.log(rusinessRestUrl);var o=Util.getProjectBasePath()+"pages/brand/business_card_scan.html?encodeData=";console.log(o),common.ajax({url:"getpersonnalcard",data:{showmobile:isShowTitle.phone,showouname:isShowTitle.ouname,showmail:isShowTitle.mail,showtitle:isShowTitle.title,showaddress:isShowTitle.address,empaddress:o}},function(t){"1"==t.status.code?(console.log(t),e&&e(t.custom.shorturl)):ejs.ui.toast(t.status.text)},function(e){ejs.ui.toast(Config.TIPS_II)},{isDebug:!1})},error:function(e){}})}function controlDiff(e){0==e.ouname&&document.querySelector('[is-show-type="ouname"] .mui-active')?document.querySelector('[is-show-type="ouname"] .mui-active').classList.remove("mui-active"):"",0==e.title&&document.querySelector('[is-show-type="title"] .mui-active')?document.querySelector('[is-show-type="title"] .mui-active').classList.remove("mui-active"):"",0==e.phone&&document.querySelector('[is-show-type="phone"] .mui-active')?document.querySelector('[is-show-type="phone"] .mui-active').classList.remove("mui-active"):"",0==e.mail&&document.querySelector('[is-show-type="mail"] .mui-active')?document.querySelector('[is-show-type="mail"] .mui-active').classList.remove("mui-active"):"",0==e.address&&document.querySelector('[is-show-type="address"] .mui-active')?document.querySelector('[is-show-type="address"] .mui-active').classList.remove("mui-active"):""}Util.loadJs("./js/qrcode.js","./js/html2canvas.js","pages/common/common.js","js/utils/util.charset.js",function(){var e;e=Util.os.android?"com.epoint.android.workflow.container.ejsapi.EpointWorkflowApi":"OAEJSCustomCalss",Config.configReady(null,function(){initListeners()},function(e){})});var userPhoto="",showTogglePage=0,coName=1,brandCoZh="",brandCoEn="",brandCoLogo="",userInfo={},isShowTitle,rusinessRestUrl,isHidden;