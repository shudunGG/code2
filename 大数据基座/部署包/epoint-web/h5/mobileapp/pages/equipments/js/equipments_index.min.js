"use strict";var APPID="",APPMANAGEURL="",DEVICEID="";Util.loadJs("pages/common/common.js",function(){Config.configReady(null,function(){ejs.runtime.getAppKey({success:function(e){APPID=e.appKey,ejs.device.getDeviceId({success:function(e){DEVICEID=e.deviceId,customBiz.initListeners()},error:function(e){}})},error:function(e){}})},function(e){})});var customBiz={initListeners:function(){var e=this;ejs.runtime.getPlatformUrl({success:function(e){APPMANAGEURL="/"===e.platformUrl.substr(-1)?e.platformUrl:e.platformUrl+"/"},error:function(e){}}),e.getDeviceList(),e.getValidateCode(),ejs.device.setBounce({isEnable:0,success:function(e){},error:function(e){}});var t=document.querySelector("#qrcode"),i=mui.createMask(function(){t.style.display="none"});mui(".em-header-yzm").on("tap",".showcode",function(){i.show(),t.style.display="flex",t.classList.add("bounceInDown"),t.classList.add("animated")}),t.addEventListener("tap",function(){t.style.display="none",i.close()}),mui("#listdata").on("tap",".remove",function(t){var i=this.getAttribute("deviceId");ejs.ui.confirm({title:"提示",message:"删除后，在该设备登录需要重新验证授权。",buttonLabels:["取消","确定"],cancelable:1,success:function(t){1==t.which&&e.delUserDevice(i,function(){e.getDeviceList()})},error:function(e){}})});var n=document.querySelector(".em-loginList"),o=document.querySelector(".em-indexPage");document.querySelector(".em-lastTime").addEventListener("tap",function(){o.classList.add("mui-hidden"),n.classList.remove("mui-hidden");var t={title:"登录列表",url:"#login"};e.loginPage=1,window.history.pushState(t,t.title,t.url)}),e.loginPage=0,ejs.navigator.hookBackBtn({success:function(t){1==e.loginPage?window.history.go(-1):0==e.loginPage&&ejs.page.close()},error:function(e){}}),ejs.navigator.hookSysBack({success:function(t){1==e.loginPage?window.history.go(-1):0==e.loginPage&&ejs.page.close()},error:function(e){}}),window.addEventListener("popstate",function(t){1==e.loginPage?(n.classList.add("mui-hidden"),o.classList.remove("mui-hidden"),e.loginPage=0):0==e.loginPage&&(n.classList.remove("mui-hidden"),o.classList.add("mui-hidden"),e.loginPage=1)},!1),String.prototype.splice||(String.prototype.splice=function(e,t,i){return this.slice(0,e)+i+this.slice(e+Math.abs(t))}),String.prototype.splice=function(e,t,i){return this.slice(0,e)+i+this.slice(e+Math.abs(t))}},initJdt:function(e,t){var i=this;mui("#jdt").progressbar({progress:0}).show(),mui("#jdt").progressbar().setProgress(100),document.querySelector(".mui-progressbar span").style.transition=e+"s",i.timeOut=0,setInterval(function(){i.timeOut+=1,mui("#jdt").progressbar().setProgress(i.timeOut),i.timeOut>100&&(i.timeOut=0,mui("#jdt").progressbar().setProgress(i.timeOut),t&&t())},e*(1e3/60))},compare:function(e){return function(t,i){var n=t[e],o=i[e];return n>o?-1:n<o?1:(n=o)?0:void 0}},getDeviceList:function(){var e=this,t={appguid:APPID};common.ajax({url:"getdevicelist",data:t,isEncrypt:0},function(t){if(1==t.status.code){var i=t.custom,n=document.getElementById("item-template").innerHTML,o="";i.length>0&&Zepto(".em-data-hidden").removeClass("mui-hidden"),mui.each(i,function(e,t){t.deviceDetailInfo=""==t.deviceDetailInfo?"未知设备":t.deviceDetailInfo,t.firstRegistdate=t.firstRegistdate.replace(/[0-9][0-9]\:[0-9][0-9]\:[0-9][0-9]/,""),t.isSelf=DEVICEID==t.deviceId?"":"mui-hidden",t.noDel=DEVICEID==t.deviceId?"mui-hidden":"",o+=Mustache.render(n,t)}),document.getElementById("listdata").innerHTML=o;var s=t.custom,c=document.getElementById("login-template").innerHTML,o="";s.sort(e.compare("lastUsedate")),mui.each(s,function(e,t){t.deviceDetailInfo=""==t.deviceDetailInfo?"未知设备":t.deviceDetailInfo,t.lastUsedate=t.lastUsedate.substring(5,16),o+=Mustache.render(c,t)}),document.getElementById("loginlist").innerHTML=o}},function(e){ejs.ui.toast(Config.TIPS_II)},{isDebug:!1})},getValidateCode:function(){var e=this,t={appguid:APPID};common.ajax({url:"getvalidatecode",data:t,isEncrypt:0},function(t){if(1==t.status.code){var i=Math.floor(9e5*Math.random()+1e5);e.codeNum=t.custom.validateCode,document.querySelector(".mui-content").classList.remove("mui-hidden"),1!=e.first?(e.first=1,e.initJdt(60,function(){e.getValidateCode()}),e.code=new Flip({node:document.querySelector(".flip"),duration:1.5,from:i}),e.qrcode=new QRCode(document.getElementById("qrcode"),{text:e.codeNum.toString().splice(1,0,",").splice(3,0,",").splice(5,0,",").splice(7,0,",").splice(9,0,","),width:200,height:200,colorDark:"#333",colorLight:"transparent"})):(document.querySelector("#qrcode").innerHTML="",e.qrcode=new QRCode(document.getElementById("qrcode"),{text:e.codeNum.toString().splice(1,0,",").splice(3,0,",").splice(5,0,",").splice(7,0,",").splice(9,0,","),width:200,height:200,colorDark:"#333",colorLight:"transparent"})),e.code.flipTo({to:e.codeNum});var n=document.querySelector(".em-true-code");if(n.querySelectorAll("div").length<1){document.querySelector(".em-true-code").classList.add("mui-hidden");var o=document.querySelector(".em-fixed").querySelectorAll(".ctnr");[].forEach.call(o,function(t,i){t.querySelector(".digit").innerText=e.codeNum.toString().split("")[i]})}}},function(e){ejs.ui.toast(Config.TIPS_II)},{isDebug:!1})},delUserDevice:function(e,t){var i={deviceid:e,appguid:APPID};common.ajax({url:"deluserdevice",data:i,isEncrypt:0},function(e){1==e.status.code&&t&&t()},function(e){ejs.ui.toast(Config.TIPS_II)},{isDebug:!1})},getUserInfo:function(e){var t=this;ejs.auth.getUserInfo({success:function(i){i=JSON.parse(i.userInfo),t.userGuid=i.userguid,e&&e()},error:function(e){}})}};