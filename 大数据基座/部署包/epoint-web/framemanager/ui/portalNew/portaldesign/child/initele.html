<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>初始化</title>
  <script src="../../../../../frame/fui/js/cssboot.js"></script>
  <style>
    .content {
      padding: 15px;
    }

    .mr-5 {
      margin-right: 5px;
    }

    .w-full {
      width: 100%;
    }

    .lh-mid {
      line-height: 24px;
      margin-top: 5px;
    }

    .scroll {
      height: 100%;
      overflow-y: auto;
    }

    .footer {
      height: 50px;
      line-height: 50px;
      box-sizing: border-box;
      padding: 9px 15px;
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
    }

    .tip-label {
      line-height: 32px;
    }

  </style>
</head>

<body class="portal-child-page">
  <div class="content">
    <div class="clearfix lh-mid">
      <div>元件标题</div>
      <div>
        <input id="name" name="name" class="mini-textbox w-full" />
      </div>
    </div>
    <div class="clearfix lh-mid">
      <div>数据来源</div>
      <div>
        <input id="column" name="column" data="" textField="name" valueField="id" emptyText="选择数据来源" value=""
          class="mini-combobox w-full" onvaluechanged="onColumnChange" />

        <input id="url" name="url" emptyText="输入链接地址" class="mini-textbox w-full" visible="false" />
      </div>
    </div>
    <div class="clearfix lh-mid">
      <div id="diy" name="diy" class="mini-checkbox" readOnly="false" text="自定义数据来源" onvaluechanged="onDiyChange"></div>
    </div>
    <div></div>
  </div>

  <div class="footer text-right clearfix">
    <div id="tip" name="tip" class="mini-checkbox l tip-label" readOnly="false" text="本次设计不再提示"></div>
    <a class="mini-button r mr-5 portal-confirm" state="primary" onclick="save()">保存</a>
    <a class="mini-button r mr-5 portal-cancel" onclick="jump()">跳过</a>
  </div>

  <script src="../../../../../rest/resource/jsboot"></script>
  <script>
    var portalConfig = {
      getColumns: 'rest/portaldesignaction/getColumns?isCommondto=true' // 获取数据来源
    };
  </script>
  <!--     <script src="./_test/mock_data.column.js"></script> -->
  <script>
  
  	
    (function (win, $) {
      var $column = mini.get('column'),
        $url = mini.get('url'),
        $name = mini.get('name'),
        $diy = mini.get('diy'),
        $tip = mini.get('tip');
      var countUrl ='';

      $name.setValue(Util.getUrlParams('title'));

      // 保存
      win.save = function () {

        var isDiy = $diy.checked;

        if (!isDiy) {
          if (!$column.value) {
            epoint.alert('数据来源信息不能为空');
            return;
          }
        } else {
          if (!$url.value) {
            epoint.alert('自定义数据来源不能为空');
            return;
          }
        }

        var selectColumn = $column.getSelected();
        var url = '',
          id = '',
          name = '';

        if (selectColumn && selectColumn.id) {
          url = selectColumn.url;
          id = selectColumn.id;
          name = selectColumn.name;
        } else {
          url = $url.value;
        }
        
 				
        epoint.closeDialog({
          type: 'ok',
          options: {
            name: $name.value,
            columnId: id,
            columnName: name,
            columnUrl: url, // 数据来源地址
            countUrl : countUrl,
            isDiy: isDiy,
            tip: $tip.checked
          }
        });
      }

      win.jump = function () {
        epoint.closeDialog({
          type: 'close',
          options: {
            tip: $tip.checked
          }
        });
      }

      // 自定义数据来源
      win.onDiyChange = function (e) {
        if (this.getChecked()) {
          $column.setVisible(false);
          $url.setVisible(true);
        } else {
          $column.setVisible(true);
          $url.setVisible(false);
        }
      }

      /* -------- 加载数据来源 ---------- */

      function getColumns() {
        Util.ajax({
          url: portalConfig.getColumns
        }).done(function (data) {
          $column.setData(data.columns);
        });
      }

      getColumns();
      
     
      win.onColumnChange = function (e) {
      	countUrl = e.selected.countUrl;
      }
     

      /* -------- 加载数据来源 end ---------- */
    })(window, jQuery);
  </script>
</body>

</html>