<!DOCTYPE html>
<html>

<head>
<title>附件权限配置列表</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<script src="../../../frame/fui/js/cssboot.js"></script>
<style type="text/css">
.mini-grid-headerCell-inner,.mini-grid-cell-inner{
text-align: left;
}
.checkall{
margin-left: 50px
}
</style>
</head>

<body>
	<div class="page-loading"></div>
	<div class="fui-toolbar">
		<a class="mini-button" state="primary" onclick="openAdd" id="btnAddRecord">新增配置</a>
		<a class="mini-button" onclick="saveBtn()">保存设置</a>
	</div>
	
	<div class="fui-condition" opened="true">
		<div class="fui-form" id="fui-form">
			<div id="cform" role="form">
				<!-- 2列 -->
				<div role="row">
					<div role="control" label="角色列表">
						<input id="roleType" autoLoad="false" bind="roleTypeGuid"
						action="getFrameRoleType" textField="text" emptyText="未分类"
						showNullItem="true" nullItemText="未分类" onvaluechanged="roleTypeChange"
						valueField="id" class="mini-combobox mr10" />
					</div>
					<div role="control" label="">
					</div>
				</div>
				<div role="row">
					<div role="control" label="角色">
						<div id="roleGroup" class="mini-checkboxlist" repeatItems="5" repeatLayout="table"
						textField="text" valueField="id" bind="selectRoleGuids" onvaluechanged="roleGroupChange"
						action="checkgroupModal" >
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 内容区域 -->
	<div id="fuiContent" class="fui-content">
		<div id="datagrid" name="datagrid" class="mini-datagrid" 
			idField="id" multiSelect="true" action="getDataGridData" 
			style="width: 100%; height: 100%;" allowResize="true" 
			showPager="true" sortOrder="desc"
			allowCellValid="true" allowCellEdit="true" 
			allowCellSelect="true" editNextOnEnterKey="true"
			editNextRowCell="true"></div>
	</div>

	<script src="../../../rest/resource/jsboot"></script>
	<link href="../../../frame/fui/js/miniui/plugin/gridcheckall/checkall.css" rel="stylesheet" type="text/css" />
	<script src="../../../frame/fui/js/miniui/plugin/gridcheckall/checkall.js" type="text/javascript"></script>

	<script>
		// 初始化页面
		epoint.initPage("frameattachrightconfiglistaction", '', callbackinit);
		
		var grid = mini.get("datagrid");
		
		// 初始化回掉，动态生成列
		function callbackinit(data) {
			adjustContentHeight();//隐藏的condition出来 要重新计算一次高度
			if (data && data.columns) {
				drawDynamicColumn(data);
			}
		}

		// 弹出新增窗口
		function openAdd() {
			epoint
					.openDialog(
							'新增记录',
							"framemanager/attach/frameattachrightconfig/frameattachrightconfigadd",
							searchData, {
								'width' : 550,
								'height' : 550
							});
		}

		// 表格的搜索
		function searchData(param) {
			if (param != 'close') {
				epoint.showTips(param, {state : 'success'});
			}
			epoint.refresh([ 'datagrid' ], '', true);
		}
		
		// 角色类别变更
		function roleTypeChange() {
			mini.get('roleGroup').setValue('');
			epoint.execute('roleTypeChange', '', function(data) {
				drawDynamicColumn(data);
				updateTable();
			});
		}
		
		// 选择角色变更
		function roleGroupChange() {
			epoint.execute("initDynamicRole", 'roleGroup', function(data) {
				drawDynamicColumn(data);
				updateTable();
			});
		}
		
		// 绘制动态列
		function drawDynamicColumn(data) {
			var tmp = data.columns;
			var columns = Util.safeEval('(' + tmp + ')');
			grid.set(columns);
			var tmpObj = epoint.decodeJson(tmp);
			var columnsObj = tmpObj.columns;
			if(columnsObj && columnsObj.length){
				$.each(columnsObj, function(k,v){
					if(columnsObj[k].type=='checkboxcolumn'){
						new CheckAll(grid, columnsObj[k].name);
					}
				});
			}
		}
		
		// 绘制高级设置列
		function onAdvancedSetting(e) {
			return "<a style=\"cursor: pointer\" onclick=\"doSelectRightPage('" + e.record.attachrightconfigGuid + "')\">设置</a>";
		}
		
		// 绘制删除列
		function onDeletingSetting(e) {
			return "<a style=\"cursor: pointer\" onclick=\"deleteSelect('" + e.record.attachrightconfigGuid + "')\">删除配置</a>";
		}
		
		// 绘制修改列
		function onEditSetting(e) {
			return "<a style=\"cursor: pointer\" onclick=\"editSelect('" + e.record.attachrightconfigGuid + "')\">修改配置</a>";
		}

		// 弹出附件权限设置窗口
		function doSelectRightPage(attachrightconfigGuid) {
			epoint.openDialog('附件授权', "framemanager/attach/frameattachrightinfo/frameattachrightinfo?attachrightconfigGuid=" + attachrightconfigGuid, function(){
				epoint.refresh(['datagrid', 'fui-form'],'',true);
			}, {
				'width' : 1000,
				'height' : 750
			});
		}
		
		// 弹出修改窗口
		function editSelect(attachrightconfigGuid) {
			var url = 'framemanager/attach/frameattachrightconfig/frameattachrightconfigedit?guid=' + attachrightconfigGuid;
			epoint.openDialog("修改附件权限配置", url, editCallBack, {
				'width' : 550,
				'height' : 550
			});
		}
		
		// 删除一行数据
		function deleteSelect(attachrightconfigGuid) {
			// 弹出确认框
			epoint.confirm("确定需要删除当前附件鉴权配置吗?", '', function() {
				epoint.execute("deleteSelect", '', [ attachrightconfigGuid ], function(data) {
					if (data.msg) {
						epoint.showTips(data.msg,{state : 'success'});
						epoint.refresh(['datagrid', 'fui-form'],'',true);
					}
				});
			});
		}
		
		// 保存
		function saveBtn() {
			epoint.execute('saveBtn', '', callback);
		}

		//回调
		function callback(data) {
			if (data.msg) {
				epoint.showTips(data.msg, {state : 'success'});
				epoint.refresh(['datagrid', 'fui-form'],'',true);
			}
		}
		
		function editCallBack(param) {
				if(param && param!="close"){
					epoint.showTips(param, {state : 'success'});
					epoint.refresh(['datagrid', 'fui-form'],'',true);
				}
		}
		
		function updateTable() {
			epoint.refresh(['datagrid', 'fui-form'],'',true);
		}
	</script>
</body>
</html>