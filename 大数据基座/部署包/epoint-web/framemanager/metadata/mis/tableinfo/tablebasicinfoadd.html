<!DOCTYPE html>
<html>

<head>
<title>添加数据表</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />

<script src="../../../../frame/fui/js/cssboot.js"></script>
<style type="text/css">
p {
	margin-left: 16px;
	margin-right: 16px;
}
</style>
</head>

<body>
	<div class="page-loading"></div>
	<!-- toolbar区域 -->
	<div class="fui-toolbar">
		<a class="mini-button" state="primary" id="add"
			onclick="saveAndClose()">确定添加</a><a class="mini-button"
			id="addCancel" onclick="epoint.closeDialog">取消添加</a>
		<!--帮助按钮 -->
		<a role="helper" class="mr10">注意事项</a>
	</div>
	<!-- 帮助信息区域 默认隐藏-->
	<div class="fui-notice hidden">
		<p>数据源:指定物理表数据源，选择后物理表将会新建到此数据源，如果不选择数据源，则默认框架数据源；如果勾选联机数据源，则选择联机数据源</p>
		<p>联机数据源:若启用联机数据源，所有表操作都是针对数据源下拉框对应数据源的数据表</p>
	</div>

	<div class="fui-content">
		<!-- 表单布局 -->
		<div class="fui-form" id="fui-form" style="width: 90%">
			<div role="form">
				<!-- 2列 -->
				<div role="row">
					<div role="control" label="表中文名称" starred="true">
						<input class="mini-textbox"
							bind="tablebasicinfoaddaction.tableBasicInfo.tableName"
							required="true" requiredErrorText="表中文名称不能为空"
							vtype="maxLength:50" />
					</div>
					<div role="control" label="SQL表名" id="sqlDiv">
						<input id="sqlTableName" onvalidation="onSqlTableNameValidation"
							bind="tablebasicinfoaddaction.tableBasicInfo.sqlTableName"
							class="mini-textbox" emptyText="数据表名" />
					</div>
				</div>
				<div role="row" id="sourceRow">
					<div role="control" label="数据源">
						<input autoLoad="false" id="dataSource" showClose="true"
							action="tablebasicinfoaddaction.getDataResource"
							showNullItem="false"
							bind="tablebasicinfoaddaction.dataSourceGuid" property="editor"
							oncloseclick="onCloseClick" class="mini-combobox" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="联机数据源">
						<div id="linkds" class="mini-checkbox" style="width: 20px"
							bind="tablebasicinfoaddaction.isEnable" readOnly="false"
							onvaluechanged="changType"></div>
						<div class="mini-outputtext" value="启用" style="width: 30px"></div>
					</div>
				</div>
				<div role="row" id="dataSourceRow" style="display: none">
					<div role="control" label="数据表">
						<div class="mini-autocomplete" id="acSimple" textField="text"
							valueField="id" bind="tablebasicinfoaddaction.tableName"
							extraId="dataSource" action="tablebasicinfoaddaction.getComplete"></div>
					</div>
				</div>
				<div role="row">
					<!-- TODO -->
					<div role="control" label="排序号">
						<input bind="tablebasicinfoaddaction.tableBasicInfo.ordernum"
							class="mini-textbox" maxLength="8" vtype="int;range:0,99999999" />
					</div>
					<div role="control" label="表ID">
						<input bind="tablebasicinfoaddaction.tableBasicInfo.tableid"
							class="mini-textbox" vType="int;range:0,999999999" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="流程选择">
						<input class="mini-treeselect" allowInput="false"
							id="processSelect" emptyText="请选择流程" oncloseclick="closeClick"
							valueFromSelect="false" multiSelect="false"
							showRadioButton="true" showFolderCheckBox="false"
							style="width: 100%;" onvaluechanged="selMainProcess"
							action="selectprocessaction.getTreeModel" showClose="true"
							onbeforenodeselect="beforenodeselect"
							bind="tablebasicinfoaddaction.tableBasicInfo.processguid" />
					</div>
					<input class="mini-hidden" id="processName"
						bind="tablebasicinfoaddaction.tableBasicInfo.processname" />
				</div>
				<div role="row">
					<div role="control" label="新增个性化地址">
						<input id="addurl" class="mini-textbox"
							bind="tablebasicinfoaddaction.tableBasicInfo.addurl" />
					</div>
					<div role="control" label="修改个性化地址">
						<input id="editurl" class="mini-textbox"
							bind="tablebasicinfoaddaction.tableBasicInfo.editurl" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="查看个性化地址">
						<input id="detailurl" class="mini-textbox"
							bind="tablebasicinfoaddaction.tableBasicInfo.detailurl" />
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="../../../../rest/resource/jsboot"></script>

	<!-- 配置变量 -->
	<script>
		// 初始化页面
		epoint.initPage('tablebasicinfoaddaction', "", callback);

		function callback() {
		}

		var onCloseClick = function(e) {
			mini.get('dataSource').setValue('');
		}

		// 保存并关闭
		function saveAndClose() {
			if (epoint.validate()) {
				epoint.execute('tablebasicinfoaddaction.add', 'fui-form',
						closeCallback);
			}
		}

		// 是否启用联机数据源
		function changType(e) {
			var checked = this.getChecked();
			var dsRow = $('#dataSourceRow');
			if (checked) {
				Util.form.hideField('#sqlDiv');
				dsRow.show();
				mini.get('dataSource').set({
					required : true,
					requiredErrorText : "数据源不能为空!"
				});
				$('#sourceRow').find('.form-label').addClass('required');
			} else {
				Util.form.showField('#sqlDiv');
				dsRow.hide();
				mini.get('dataSource').set({
					required : false
				});
				$('#sourceRow').find('.form-label').removeClass('required');
			}
		}

		// 关闭操作的回调
		function closeCallback(data) {
			if (data.message) {
				//if (data.message.indexOf("成功") != -1) {
				if (data.success) {
					epoint.closeDialog(data.message);
				} else {
					epoint.showTips(data.message, {state : 'danger'});
				}
			}
		}

		function onSqlTableNameValidation(e) {
			if (e.isValid) {
				if (isSqlTableValidate(e.value) == false) {
					e.errorText = "表名格式不正确";
					e.isValid = false;
				}
			}
		}

		// 是否英文+数字
		function isSqlTableValidate(v) {
			var re = new RegExp(
					"(^_([a-zA-Z0-9]_?)*$)|(^[a-zA-Z](_?[a-zA-Z0-9])*_?$)");
			if (re.test(v))
				return true;
			return false;
		}

		function selMainProcess(e) {
			var obj = e.sender
			mini.get('processSelect').setText(obj.text);
			mini.get('processSelect').setValue(obj.value);
			mini.get('processName').setValue(
					mini.get('processSelect').getText());
		}

		function closeClick() {
			mini.get('processSelect').setText('');
			mini.get('processSelect').setValue('');
			mini.get('processName').setValue('');
		}

		function beforenodeselect(e) {
			if (!e.isLeaf || e.record.path == "parent") {
				e.cancel = true;
			}
		}
	</script>
</body>

</html>
