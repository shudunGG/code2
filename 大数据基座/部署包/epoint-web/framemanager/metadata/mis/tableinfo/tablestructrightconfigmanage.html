<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>表字段权限管理</title>
<script src="../../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
	<!--必须有，加载时的loading效果  -->
	<div class="page-loading"></div>

	<div class="fui-content" align="center">
		<div class="fui-form" id="fui-form">
			<div role="form" id="form">
				<div role="row">
					<div role="control" label="字段选择" starred="true">
						<input id="fieldId" class="mini-combobox" style="width: 250px"
							textField="text" valueField="id" bind="fieldId"
							action="fieldModel" allowInput="false" showNullItem="true"
							nullitemText="请选择..." emptyText="请选择..." required="true"
							requiredErrorText="请先选择要设置权限的字段!" />
					</div>
				</div>
				<div role="row">
					<div role="control" label="权限类型" starred="true">
						<input id="rightType" class="mini-combobox" style="width: 250px"
							textField="text" valueField="id" bind="rightType"
							action="rightTypeModel" allowInput="false" showNullItem="true"
							nullitemText="请选择..." emptyText="请选择..." required="true"
							requiredErrorText="请先选择权限类型!" />
					</div>
				</div>
				<div class="fui-accordions" id="fui-accordions">
					<div role="accordion" opened="true">
						<div role="head" title="授权角色"></div>
						<div role="body">
							<!-- <input id="condition" class="mini-buttonedit search-btn"
								bind="roleSearchCondition" style="width: 200px"
								onbuttonclick="updateRepeat"> </input> -->
							<div class="mini-repeat clearfix" id="repeat"
								templateId="roleTemplate"></div>
							<input class="mini-hidden" id="controlIds" /> <input
								class="mini-hidden" id="roleValues" bind="selectedRoles" />
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="fui-toolbar bottom">
		<a class="mini-button" state="primary" id="addClose" onclick="saveAndClose">保存设置</a> 
		<a class="mini-button" id="btnClose" onclick="epoint.closeDialog();">取消设置</a>
	</div>

	<script type="text/template" id="roleTemplate">
			<div id="panel1" class="mini-panel" title="{{title}}" showCollapseButton="false"  allowResize="false" showFooter="false" style="width:49%;float:left;margin-left:1%;margin-top:10px;">
			<div id="{{roleType}}" style="overflow:auto;" class="mini-checkboxlist" repeatLayout="table" repeatItems="3" textField="text" valueField="value"></div>
			</div>
		</script>

	<script src="../../../../rest/resource/jsboot"></script>

	<script>
		//<![CDATA[  
		//初始化页面
		epoint.initPage("tablestructrightconfigmanageaction", "", initCallback);

		var repeat = mini.get('repeat');

		function initCallback(e) {
			//初始化角色区域
			var data = e.uirepeat;
			repeat.setData(data);
			//将checkboxlist id存入隐藏域
			mini.get("controlIds").setValue(data["controlIds"]);
			if (e.flag) {
				mini.get("fieldId").disable();
				mini.get("rightType").disable();
			}
		}

		//保存并关闭
		function saveAndClose() {
			if (epoint.validate()) {
				saveUserRole();
				epoint.execute('rightSet', '', closeCallback);
			}
		}

		// 关闭操作的回调
		function closeCallback(data) {
			var msg = data.msg;
			if (msg) {
				if (data.success) {
				    epoint.closeDialog(msg);
				} else {
					epoint.alert(msg, '', null, 'warning');
				}
			}
		}

		function updateRepeat() {
			epoint.execute("searchRoles", "condition", function(e) {
				//初始化角色区域
				var data = e.uirepeat;
				repeat.setData(data);
				//将checkboxlist id存入隐藏域
				mini.get("controlIds").setValue(data["controlIds"]);
			});
		}

		//将角色值赋到隐藏域
		function saveUserRole() {
			var checkbox = mini.get("controlIds").getValue().split(',');
			var selected = '';
			$.each(checkbox, function(n, value) {
				var cValue = mini.get(value).getValue();
				if (cValue) {
					selected += cValue + ",";
				}
			});
			//将所有checkboxlist 的选中值存入隐藏域
			mini.get("roleValues").setValue(
					selected.substring(0, selected.length - 1));
		}

		$("#condition").keydown(function(e) {
			e = e || window.event;
			var kcode = e.which || e.keyCode;
			if (kcode == 13) {
				updateRepeat();
			}
		});

		// 保存操作的回调
		var saveCallback = function(data) {
			var msg = data.msg;
			epoint.alertAndClose(msg);
		}

		//字段双击事件
		function itemdblclick(e) {
			addToSelected([ e.item ]);
		}

		//字段双击事件
		function selecteditemdblclick(e) {
			selected.removeItem(e.item);
		}
		//]]>
	</script>
</body>
</html>