<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>新增</title>
<script src="../../../../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
	<div class="page-loading"></div>

	<div class="fui-left">
		<div role="head" title="子集信息"></div>
		<div role="body">
			<ul id="tree" class="mini-tree" style="height: 100%" textField="text"
				idField="id" parentField="pid" action="getTreeModel"
				filterMode="server" resultAsTree="false" showCheckBox="true">
			</ul>
		</div>
	</div>

	<div class="fui-right">
		<div class="fui-toolbar">
			<a id="btnSave" class="mini-button" onclick="save">保存</a><a
				onclick="epoint.closeDialog" class="mini-button">关闭</a>
		</div>

		<div id="fuiContent" class="fui-content">
			<div id="datagrid" class="mini-datagrid" sortOrder="asc"
				idField="rowguid" multiSelect="true" sortField="ordernumber"
				style="width: 100%; height: 100%;" allowResize="true"
				allowCellValid="true" allowCellEdit="false" allowCellSelect="true"
				action="getDataGridData" showPager="false">
				<div property="columns">
					<div type="indexcolumn" headerAlign="center" width="40">序</div>
					<div field="fieldname" width="100%">字段名称</div>
					<div type="comboboxcolumn" width="100" field="ordertype"
						name="ordertype">
						排序方式<input property="editor" class="mini-combobox"
							allowInput="false" textField="text" valueField="value"
							style="width: 100%;"
							onvaluechanged="setOrderTypeValue(this.value)" />
					</div>
					<div width="50" renderer="onUpRender">上移</div>
					<div width="50" renderer="onDownRenderer">下移</div>
					<div field="fieldguid" name="fieldguid" width="0"></div>
				</div>
			</div>
		</div>
	</div>

	<script src="../../../../../../rest/resource/jsboot"></script>

	<script>
		//<![CDATA[ 
		var tree = mini.get("tree");
		var grid = mini.get("datagrid");
		var orderModel = "";
		epoint.initPage('schemeorderinfomanageaction');

		grid.on("update", function(e) {
			epoint.execute("getOrderTypeModel", "@none", "", function(result) {
				orderModel = result;
				for (var i = 0, length = grid.data.length; i < length; i++) {
					var column = grid.getColumn("ordertype");
					console.log("column=" + column);
					var editor = grid.getCellEditor(column, i);
					if (editor) {
						console.log("result=" + result);
						editor.setData(result);
					}
				}
			});
			var list = grid.getList();
			for (var i = 0, length = list.length; i < length; i++) {
				if (!grid.isEditingRow(list[i])) {
					grid.beginEditRow(list[i]);
				}
			}
		});

		function setData(i) {
			var column = grid.getColumn("ordertype");
			var editor = grid.getCellEditor(column, i);
			if (editor) {
				editor.setData(orderModel);
			}
		}

		tree.on("nodecheck", function(e) {
			var checkNodes = tree.getCheckedNodes(false);
			var nodeLength = checkNodes.length;
			var dataList = grid.getList();
			var dataLength = dataList.length;
			//删除树中未选中的信息
			if (dataList) {
				for (var i = 0; i < dataLength; i++) {
					var data = dataList[i];
					var isExist = false;
					if (checkNodes) {
						for (var j = 0; j < nodeLength; j++) {
							var node = checkNodes[j];
							if (data.fieldguid == node.id) {
								isExist = true;
							}
						}
					}
					if (!isExist) {
						grid.removeRow(grid.getRow(i), false);
					}
				}
			}

			//添加树中选中的信息
			if (checkNodes) {
				for (var i = 0; i < nodeLength; i++) {
					var node = checkNodes[i];
					var isExist = false;
					if (dataList) {
						for (var j = 0; j < dataLength; j++) {
							var data = dataList[j];
							if (data.fieldguid == node.id) {
								isExist = true;
								break;
							}
						}
					}
					if (!isExist) {
						var index = grid.data.length;
						addRow(node, index);
					}
				}
			}
		});

		function addRow(node, i) {
			var newRow = {};
			newRow.ordertype = '1';
			newRow.fieldguid = node.id;
			newRow.fieldname = node.text;
			grid.addRow(newRow, i);
			grid.beginEditRow(newRow);
			setData(i);
		}

		function onUpRender(e) {
			return epoint.renderCell(e, "action-icon icon-up", "openUp",
					"epoint_total");
		}

		function openUp() {
			var row = grid.getSelected();
			if (row) {
				var index = grid.indexOf(row);
				if (index == 0) {
					epoint.showTips("第一条记录，无法上移！");
					return;
				}
				grid.moveRow(row, index - 1);
				grid.beginEditRow(row);
				setData(index - 1);
			} else {
				alert("请选择一条记录");
			}
		}

		function onDownRenderer(e) {
			return epoint.renderCell(e, "action-icon icon-down", "openDown",
					"epoint_total");
		}

		function openDown() {
			//获取最后一条记录的下标
			var totalCount = grid.data.length - 1;
			var row = grid.getSelected();
			if (row) {
				var index = grid.indexOf(row);
				if (index == totalCount) {
					epoint.showTips("最后一条记录，无法下移！");
					return;
				}
				grid.moveRow(row, index + 2);
				grid.beginEditRow(row);
				setData(index + 1);
			} else {
				alert("请选择一条记录");
			}
		}

		function save(e) {
			var data = grid.getData();
			epoint.execute("save", null, [ data ], function(data) {
				if (data && data.msg) {
					epoint.alert(data.msg, null, null, 'info');
					epoint.refresh([ "tree", "datagrid" ]);
				}
			})
		}

		function setOrderTypeValue(value) {
			var row = grid.getSelected();
			if (row) {
				row.ordertype = value;
			}
		}

		//]]>
	</script>
</body>
</html>