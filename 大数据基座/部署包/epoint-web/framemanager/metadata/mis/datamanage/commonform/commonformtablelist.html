<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"></meta>
<meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
<title>动态生成表格</title>
<script src="../../../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>
	<div class="fui-toolbar">
		<a class="mini-button" onclick="add()">添加表记录</a>
	</div>
	<!-- 条件区域 -->
	<div class="fui-condition" id="fuiCondition">
		<a id="searchBtn" role="searcher" callback="searchData"></a>
	</div>
	<div class="fui-content">
		<div id="datagrid" class="mini-datagrid" sortOrder="desc"
			idField="rowguid" multiSelect="true"
			style="width: 100%; height: 100%;"
			action="getTableData" showPager="true"
			allowCellEdit="true" allowCellSelect="true" editNextOnEnterKey="true"
			editNextRowCell="true">
		</div>
	</div>
	<div class="display:none">
		<input class="mini-hidden" bind="pageRefresh" id="pageRefresh"/>
		<input class="mini-textbox" id="params" bind="params" />
	</div>
	
	<script src="../../../../../rest/resource/jsboot"></script>
	<script src="../../../../../frame/fui/js/epoint/epoint.controlconfig.js"></script>
	<script src="../../../../../frame/fui/js/epoint/epoint.form.js"></script>
	<script src="../search/js/eputil.js"></script>
	
	<script type="text/javascript">
		//<![CDATA[
		epoint.initPage("commonformtablelistaction", '', initCallBack);
		
		var tableID=Util.getUrlParams('tableID');
		var tableName;
		var fieldMaps = null, params = mini.get('params');
		
		var grid = mini.get("datagrid");
		
		// 初始化回掉，动态生成列
		function initCallBack(data) {
			var pageRefresh = data.pageRefresh || '0';
			
			adjustContentHeight();//隐藏的condition出来 要重新计算一次高度
			if(data.msg){
				epoint.alertAndClose(data.msg);
				return;
			}
			  if (data && data.controls) {
				drawDynamicColumn(data);
				appearCondition(data);
				if(data.fields){
					fieldMaps = data.fields;
				}
				mini.parse();
			}  
			if(data.tableName){
				tableName=data.tableName;
			}
			if(pageRefresh == '0'){
				mini.get('pageRefresh').setValue('1');
				epoint.refresh(['datagrid','pageRefresh'],'',true);
			}
		}
		
		// 加载查询区域
		function appearCondition(data) {
			var html = epoint.parseForm(data.controls);
			$('#fuiCondition').prepend(html);
			initCondition();
		}

		// 绘制动态列
		function drawDynamicColumn(data) {
			if(data.columns){
			var tmp = data.columns;
			var tmpColumn = Util.safeEval('(' + tmp + ')');
			grid.setColumns(tmpColumn.columns);
			}
		}
		// 绘制修改按钮
		var onEditRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-edit", "updateInfo");
		};
		// 绘制详情按钮
		var onDetailRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-search", "detailInfo");
		};

		// 新增
		function add() {
			epoint.openDialog('添加表记录',
					'framemanager/metadata/mis/tableinfo/commontable/commontable?tableName='
							+ tableName+'&tableID='+tableID, function() {
						epoint.refresh(['datagrid','pageRefresh'], '', true);
					}, {
						'width' : 1000,
						'height' : 600
					});
		}
		// 详情
		function detailInfo(e) {
			epoint.openDialog('查看表记录', 'framemanager/metadata/mis/tableinfo/commontable/commontabledetail?tableName='
					+ tableName+'&tableID='+tableID+'&rowguid='+e, function() {
				epoint.refresh(['datagrid','pageRefresh'],'',true);
			}, {
				'width' : 1000,
				'height' : 450
			});
		}
		// 修改
		function updateInfo(e) {
			epoint.openDialog('修改表记录', 'framemanager/metadata/mis/tableinfo/commontable/commontable?tableName='
					+ tableName+'&tableID='+tableID+'&rowguid='+e, function() {
				epoint.refresh(['datagrid','pageRefresh'],'',true);
			}, {
				'width' : 1000,
				'height' : 450
			});
		}
		// 绘制行删除按钮
		var onDelRenderer = function(e) {
			return epoint.renderCell(e, "action-icon icon-remove", "deleteRecord",
					"rowguid");
		};

		// 删除一行数据
		function deleteRecord(rowguid) {
			// 弹出确认框
			epoint.confirm("确定删除吗?", '', function() {
				epoint.execute("deleteRecord", '', [ rowguid ],
						function(data) {
							if (data.msg) {
								epoint.alert(data.msg, null, null, 'info');
								epoint.refresh(['datagrid','pageRefresh'], '', true);
							}
						});
			});
		}
		
		// 表格的搜索
		function searchData() {
			// 获取查询区域的值并赋值给params
			if(fieldMaps){
				$.each(fieldMaps, function(k, v){
					var control = mini.get(k);
					if(control){
						fieldMaps[k] = control.getValue();
					}
				});
				params.setValue(JSON.stringify(fieldMaps));
			}
			epoint.refresh(['datagrid', 'params','pageRefresh']);
		}
		
		//]]>
	</script>
</body>
</html>