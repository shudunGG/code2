<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>秘书岗设置</title>
<script src="../../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>
	
	<div class="fui-condition">
		<!-- 表单布局 -->
		<div class="fui-form" id="fui-form" style="width: 90%">
			<div role="form">
				<div role="row">
					<div role="control" label="领导所在部门">
						<input id="leadOUname" bind="ouName" class="mini-buttonedit"
							allowInput="false" emptyText="" onbuttonclick="selectou"
							showClose="true" oncloseclick="clearOu" selectOnFocus="true" />
						<!-- 隐藏域 -->
						<input bind="userGuid" id="hidUserGuid" class="mini-hidden" /> <input
							bind="ouGuid" id="hidsecOuGuid" class="mini-hidden" />
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 内容区域 -->
	<div class="fui-content">
		<div id="tree" class="mini-tabstreeselect" action="getTreeModel"
			loadWhenChecked="true" filterMode="server" selectedPanelTitle="已选秘书">
			<div tabText="人员列表"></div>
		</div>
	</div>
	<!-- toolbar区域 -->
	<div class="fui-toolbar bottom">
		<a class="mini-button" state="primary" id="addNew" onclick="saveAndClose">保存设置</a> <a
			class="mini-button" onclick="epoint.closeDialog">取消设置</a>
	</div>
	
	<script src="../../../../rest/resource/jsboot"></script>
	<script>
		//<![CDATA[
		//初始化请求
		epoint.initPage('settingsecretaryinfoaction', null, function(data) {
			if (data.soa) {
				epoint.alertAndClose(e.soa, '', null, null, 'info');
			}
			if (data.threemanage) {
				epoint.alertAndClose(e.threemanage, '', null, null, 'info');
			}
			if (data) {
				mini.get("leadOUname").setText(data.ouname);
				// mini.get("hidUserGuid").setValue(data.userGuid);
			}

			var attr = Util.getUrlParams('isSub');
			if (attr == "1") {
				mini.get("leadOUname").disable();
			}

		});

		function saveAndClose() {
			epoint.execute('save', [ 'fui-form', 'tree' ], saveCallback);
		}

		// 关闭操作的回调
		function saveCallback(data) {
			var msg = data.msg;
			if (msg) {
				// if (msg.indexOf ("成功") != -1)
				if (data.success) {
					epoint.closeDialog(msg);
				} else {
					epoint.showTips(msg,  {state : 'danger'});
				}
			}
		}

		//更新回调
		function updateFlagCallback(data) {
			var tree = mini.get("tree");
			//tree.setValue(data.secretaryGuids);
			//epoint.refresh([ 'tree' ]);
		}

		//回调
		function dealSelectSecOuValue(rtnValue) {
			if (rtnValue && rtnValue != 'close') {
				var s = rtnValue.split(";");
				if (s[1] != 'f9root') {
					mini.get("leadOUname").setText(s[0]);
					mini.get("leadOUname").setValue(s[0]);
					mini.get("hidsecOuGuid").setValue(s[1]);
					epoint.execute("updateFlag", "", updateFlagCallback);
				} else {
					epoint.alert("根节点不允许选择", '', null, 'warning');
				}
			}
		}

		//选择领导所在部门
		function selectou() {
			var userGuid = $("#hidUserGuid").val();
			var ouGuid = $("#hidsecOuGuid").val();
			epoint.openDialog("选择部门",
					'framemanager/orga/orga/user/selectsecou?userGuid='
							+ userGuid + "&ouGuid=" + ouGuid, dealSelectSecOuValue, {
						'width' : 300,
						'height' : 400
					});
		}

		//清空
		function clearOu(e) {
			var obj = e.sender;
			obj.setText("");
			obj.setValue("");
			mini.get("hidsecOuGuid").setValue("");
		}

		//]]>
	</script>
</body>
</html>