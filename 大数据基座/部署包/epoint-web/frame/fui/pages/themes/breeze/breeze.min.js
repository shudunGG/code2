/*!
 * 主题2-breeze
 * author:JiangJinJian
 * date: 2018-05-31
 * version: 1.0.0
 */

/* global UserSettings, _userName_, _userGuid_, _getNiceScroll_, tabsNavConfig, getDataUrl,resizeTab, EpTabsNav, createMainContentCover, dealLinkOpen, initPortal, eWebSocket:true */
var FIRST_MENU_TPL='{{#items}}\x3cli class\x3d"leaf-item"\x3e\x3ca href\x3d"javascript:;" data-code\x3d"{{code}}" data-name\x3d"{{name}}" data-url\x3d"{{url}}" data-openType\x3d"{{openType}}" data-hassub\x3d"{{hasSub}}" class\x3d"top-item"\x3e\x3cdiv class\x3d"clearfix relative"\x3e\x3cdiv class\x3d"l"\x3e\x3ci class\x3d"icons font-icons {{icon}}"\x3e\x3c/i\x3e\x3c/div\x3e\x3cdiv class\x3d"l text-name-contain text-ellipsis"\x3e\x3cspan class\x3d"text-name" title\x3d"{{name}}"\x3e{{name}}\x3c/span\x3e\x3c/div\x3e{{#hasSub}}\x3cdiv class\x3d"l arrow-icon"\x3e\x3c/div\x3e{{/hasSub}}\x3c/div\x3e\x3c/a\x3e\x3c/li\x3e{{/items}}';var SECOND_MENU_TPL='\x3cli class\x3d"leaf-item"\x3e\x3ca href\x3d"javascript:;" data-code\x3d"{{code}}" data-name\x3d"{{name}}" data-url\x3d"{{url}}" data-openType\x3d"{{openType}}" data-hassub\x3d"{{hasSub}}" style\x3d"padding-left: {{indent}}px;" class\x3d"second-item"\x3e\x3cdiv class\x3d"clearfix relative"\x3e\x3cdiv class\x3d"l icons-contain"\x3e\x3ci class\x3d"icons font-icons {{icon}}"\x3e\x3c/i\x3e\x3c/div\x3e\x3cdiv class\x3d"l text-name-contain text-ellipsis"\x3e\x3cspan class\x3d"text-name" title\x3d"{{name}}"\x3e{{name}}\x3c/span\x3e\x3c/div\x3e{{#hasSub}}\x3cdiv class\x3d"l arrow-icon"\x3e\x3c/div\x3e{{/hasSub}}\x3c/div\x3e\x3c/a\x3e{{#hasSub}}\x3cul class\x3d"dep-{{depLen}}"\x3e{{{subMenu}}}\x3c/ul\x3e{{/hasSub}}\x3c/li\x3e';var $surfaceMain=$("#surface-main"),$header=$("#header"),$sidebarPopUp=$("#sidebar-popup"),$msgPanel=$("#msg-panel"),$themeBtn=$("#themes-btn"),$breezeTabs=$(tabsNavConfig.tabsContainer);var $coverContainer=$("#page-cover");if(Util.browsers.isIE&&window.hasObjectTag)window.createMainContentCover=function(){var iframe=document.createElement("iframe");iframe.width="100%";iframe.height="100%";iframe.scrolling="no";iframe.frameBorder=0;iframe.style.background="transparent";iframe.src="../../activexcover/activexcover.html";var $cover=$('\x3cdiv class\x3d"main-content-cover hidden"\x3e\x3c/div\x3e');return $cover.append(iframe).appendTo($coverContainer)};else window.createMainContentCover=function(){var $cover=$('\x3cdiv class\x3d"main-content-cover hidden"\x3e\x3c/div\x3e');return $cover.appendTo($coverContainer)};window.dealLinkOpen=function(linkData){linkData.url=Util.addHtmlToUrl(linkData.url);switch(linkData.openType){case "tabsnav":TabsNav.addTab(linkData);break;case "dialog":epoint.openTopDialog(linkData.name,Util.getRightUrl(linkData.url));break;case "blank":window.open(Util.getRightUrl(linkData.url),linkData.id);break;default:break}};var _breezeEvent_=new Util.UserEvent;var useWebsocket=Util.getFrameSysParam("useWebsocket")===true;window.eWebSocket=undefined;var creatWebSocket=function(uid,uname,callback){if(eWebSocket){callback&&callback();return}var cfg=window.EWebSocketConfig?window.EWebSocketConfig:{url:EmsgConfig.websocketUrl};cfg.uid=uid;cfg.uname=uname;if(window.EWebSocket){eWebSocket=new EWebSocket(cfg);callback&&callback();_breezeEvent_.fire("websocketCreated")}else Util.loadJs("frame/fui/js/widgets/ewebsocket/ewebsocket.js",function(){eWebSocket=new EWebSocket(cfg);callback&&callback();_breezeEvent_.fire("websocketCreated")})};window.TabsNav=new EpTabsNav(tabsNavConfig);(function(win,$){var $currTitle=$("#current-title");var originActiveFn=TabsNav.activeTab;TabsNav.activeTab=function(){var $tab=$("#"+this._getTabId(arguments[0]));var tabName=$tab.find(".tn-tabs-nav-name")[0].getAttribute("title");$currTitle.text(tabName);return originActiveFn.apply(this,arguments)}})(this,jQuery);window.resizeTab=function(){$breezeTabs.css("opacity","0");setTimeout(function(){$(window).trigger("resize");$breezeTabs.css("opacity","1")},300)};var _getData_=function(method,params){return Util.ajax({url:epoint.dealRestfulUrl(getDataUrl+"/"+method),data:params})};(function(win,$){$header.on("click",".change-tab",function(){$surfaceMain.toggleClass("showtab");resizeTab()})})(window,jQuery);(function(win,$){var $menu=$("#menu"),$topMenu=$("#top-menu"),$secondMenu=$("#second-menu"),$menuContainer=$topMenu.add($secondMenu),$popupTitle=$("#popup-title");var $cover=createMainContentCover();var menuData={},topMenuData=[],quickMenuData=[],portalData=[];var winInfo={width:parseInt($(win).width(),10),height:parseInt($(win).height(),10)};$(win).on("resize",function(){winInfo={width:parseInt($(win).width(),10),height:parseInt($(win).height(),10)}});win.initPortal=function(homes,defaultHome){if(!homes||!homes.length)return;var home={closeIcon:false,refresh:true};var singleHomes=[];for(var i=0;i<homes.length;i++){var cate=homes[i];var finded=false;if(cate.items!=undefined)!finded&&$.each(cate.items,function(j,item){if(defaultHome){if(item.code==defaultHome){home.id=item.code||"home";home.url=item.url;home.name=item.name;finded=true;return false}}else if(item.openType=="tabsnav"){home.id=item.code||"home";home.url=item.url;home.name=item.name;finded=true;return false}});else{if(!finded)if(defaultHome){if(cate.code==defaultHome){home.id=cate.code||"home";home.url=cate.url;home.name=cate.name;finded=true}}else if(cate.openType=="tabsnav"){home.id=cate.code||"home";home.url=cate.url;home.name=cate.name;finded=true}singleHomes=singleHomes.concat(homes.splice(i,1));i--}}TabsNav.addTab(home);var iconCls="modicon-75";portalData=[{name:"\u5185\u7f51\u95e8\u6237",icon:iconCls,hasSub:true,code:"portal",items:[].concat(singleHomes,homes)}];function addDefaultIcon(data){$.each(data,function(i,item){if(!item.icon)item.icon=iconCls;if(item.items&&item.items.length)addDefaultIcon(item.items)})}addDefaultIcon(portalData[0].items)};function getTopMenu(){var dtd=$.Deferred();_getData_("getMenu",{query:"all"}).done(function(data){data=data||[];topMenuData=[].concat(portalData,data);$(topMenuData).each(function(index,item){item.hasSub=item.hasSub||!!(item.items&&item.items.length);if(item.hasSub)menuData[item.code]=item.items});dtd.resolve(topMenuData)});return dtd.promise()}var renderTopMenu=function(){if(topMenuData.length){var html=Mustache.render(FIRST_MENU_TPL,{items:topMenuData});$topMenu.html(html)}else getTopMenu().done(function(data){var html=Mustache.render(FIRST_MENU_TPL,{items:data});$topMenu.html(html);getQuickMenu(true)})};_breezeEvent_.on("afterPageInfo",renderTopMenu);var INDENT_INIT=0,INDENT_STEP=8;var hideSecondMenu=function(){$sidebarPopUp.fadeOut(100);$cover.addClass("hidden")};$("body").on("click",function(e){var $target=$(e.target);if(!$target.closest($menuContainer).length){hideSecondMenu();$topMenu.find(".leaf-item.active").removeClass("active")}});var showSecondMenu=function(){var top=$sidebarPopUp.data("top");$(".second-warp",$sidebarPopUp).css("height","auto");var _content_h=parseInt($secondMenu.outerHeight(),10)+5+50;var _bottom=0,_top=top-100;if(top+_content_h+32>winInfo.height){_bottom="-32px";if(winInfo.height-_content_h-32>0)_top="initial";else if(_content_h+32>winInfo.height){_top="-100px";$(".second-warp",$sidebarPopUp).css("height","100%")}}else _bottom="initial";$sidebarPopUp.css({bottom:_bottom,top:_top}).fadeIn(100)};var getIndent=function(rowkey){var len=rowkey.split("-").length;if(len<2)len=2;return INDENT_INIT+(len-2)*INDENT_STEP};var getRowkey=function(rowkey,i){return rowkey===undefined?i+"":rowkey+"-"+i};var buildLeftMenu=function(data,rowkey){var html=[];$.each(data,function(i,item){var view={name:item.name,code:item.code,url:item.url,icon:item.icon||"modicon-1",openType:item.openType,hasSub:!!(item.items&&item.items.length)};view.rowkey=getRowkey(rowkey,i);var rowkeyLength=view.rowkey.split("-").length;view.depLen=rowkeyLength;if(rowkeyLength===1){view.isTop=true;view.indent=0}else{view.isTop=false;view.indent=getIndent(view.rowkey)}if(view.hasSub)html.push(Mustache.render(SECOND_MENU_TPL,$.extend(view,{subMenu:buildLeftMenu(item.items,view.rowkey)})));else html.push(Mustache.render(SECOND_MENU_TPL,view))});return html.join("")};var initLeftMenu=function(opt){var data=opt.data,code=opt.code,top=opt.top;var html=buildLeftMenu(data);$secondMenu.html(html).attr("top-code",code);$sidebarPopUp.data("top",top);showSecondMenu()};var getSecondMenu=function(code,name,top){var data=menuData[code];$popupTitle.attr("title",name).text(name);initLeftMenu({data:data,code:code,name:name,top:top})};var getQuickMenu=function(notRender){if(quickMenuData.length){if(!notRender){var html=Mustache.render(FIRST_MENU_TPL,{items:quickMenuData});$topMenu.html(html)}}else _getData_("getQuickMenu").done(function(data){if(!data||!data.length){$(".quick-btns").hide();return}quickMenuData=data;if(!notRender)$topMenu.html(Mustache.render(FIRST_MENU_TPL,{items:data}))})};$menu.on("click",".top-item",function(e){var $this=$(this),data=$this.data(),_code=data.code,_url=data.url,_name=data.name,_openType=data.opentype,_hasSub=data.hassub;$this.parent().addClass("active").siblings(".active").removeClass("active");if(_hasSub){var _top=$this.offset().top;getSecondMenu(_code,_name,_top);$cover.removeClass("hidden")}else{hideSecondMenu();if(_url)if(_openType==="tabsnav")TabsNav.addTab({id:_code,name:_name,url:_url});else win.open(Util.getRightUrl(_url),_code)}}).on("click",".second-item",function(){var $this=$(this),data=$this.data(),_code=data.code,_url=data.url,_name=data.name,_openType=data.opentype,_hasSub=data.hassub;if(_hasSub){$this.next().slideToggle(200);$this.toggleClass("active");setTimeout(function(){showSecondMenu()},400)}else{hideSecondMenu();if(_url)if(_openType==="tabsnav")TabsNav.addTab({id:_code,name:_name,url:_url});else win.open(Util.getRightUrl(_url),_code)}}).on("click","#icon-quick",function(){var $this=$(this);if(!$this.hasClass("active")){$this.addClass("active");getQuickMenu()}else{$this.removeClass("active");renderTopMenu()}}).on("click","#icons-trigger",function(){$(this).toggleClass("active");$menu.toggleClass("narrow");$surfaceMain.toggleClass("narrow");resizeTab()})})(window,jQuery);(function(win,$){var $cover=createMainContentCover();var themeSelection;function initThemeSkin(){ThemeSelection._styleLoaded=true;themeSelection=new ThemeSelection({getPagesUrl:getPagesUrl,savePageUrl:savePageUrl,showCallback:function(){$cover.removeClass("hidden")},hideCallback:function(){$themeBtn.removeClass("active");$cover.addClass("hidden")}});window.themeSelection=themeSelection;$themeBtn.on("click",function(){if($themeBtn.hasClass("active")){$themeBtn.removeClass("active");themeSelection.hide()}else{themeSelection.show();$themeBtn.addClass("active")}});$("body").on("click",function(e){var $target=$(e.target);if(!$target.closest(".theme-selection-container, #themes-btn").length){$themeBtn.removeClass("active");themeSelection.hide()}})}if(!window.ThemeSelection)Util.loadJs("frame/fui/js/widgets/themeselection/themeselection.js",initThemeSkin);else initThemeSkin()})(this,jQuery);(function(win,$){var $logo=$("#logo-img"),$userInfo=$("#user-info"),$userPortrait=$(".user-portrait",$userInfo);var $cover=createMainContentCover();function hideUserPanel(){$userInfo.removeClass("active");$cover.addClass("hidden")}$userInfo.on("click",".user-info-summary",function(){if(!$userInfo.hasClass("active")){$userInfo.addClass("active");$cover.removeClass("hidden")}else hideUserPanel()}).on("click",".user-action-item",function(){var $this=$(this);if($this.hasClass("person-info"))dealLinkOpen({id:this.getAttribute("data-id"),name:this.getAttribute("data-name"),url:this.getAttribute("data-url"),openType:"tabsnav"});else if($this.hasClass("logout"))mini.confirm("\u60a8\u786e\u5b9a\u8981\u9000\u51fa\u7cfb\u7edf\u5417\uff1f","\u7cfb\u7edf\u63d0\u793a",function(action){if(action=="ok"){eWebSocket&&eWebSocket.close();UserSettings.logout()}});else if($this.hasClass("role-change"))UserSettings.changeRole(_userGuid_);else{var openType=$this.data("opentype"),id=$this.data("id"),url=$this.attr("url"),name=$this.text(),script=$this.attr("script");if(!id){id=Util.uuid();$this.data("id",id).attr("data-id",id)}if(url)dealLinkOpen({id:id,openType:openType,name:name,url:url});else if(script)try{eval(script)}catch(error){console.error(error)}}hideUserPanel()});$("body").on("click",function(e){if(!$(e.target).closest("#user-info").length)hideUserPanel()});var loadImg=function(url,el){var img=new Image;img.onload=function(){img.onload=null;el.src=url};img.onerror=function(){console.error(url+"\u5bf9\u5e94\u7684\u56fe\u7247\u8d44\u6e90\u65e0\u6cd5\u52a0\u8f7d\uff01")};img.src=url};_getData_("getUserInfo").done(function(data){win._userName_=data.name;win._userGuid_=data.guid;win._msgcenterConfig_=$.extend({},win.MsgCenterConfig,{isMsgCenterMaxSize:data.isMsgCenterMaxSize||false,msgCenterOrder:data.msgCenterOrder||"asc",hideCallback:function(){}});if(useWebsocket)creatWebSocket(_userGuid_,_userName_);if(data.portrait){var url=Util.getRightUrl(epoint.dealRestfulUrl(data.portrait));$userPortrait.attr("src",url)}if(data.hasParttime){$userInfo.find(".user-action-item.role-change").removeClass("hidden");if(data.isOpenDefaultOU)UserSettings.changeRole(_userGuid_)}var $userInfoDetail=$("#user-info-detail");$userInfoDetail.find(".user-name").text(data.name).attr("title",data.name);$userInfoDetail.find(".user-dept").text(data.ouName).attr("title",data.ouName)});_getData_("getPageInfo").done(function(data){if(data.title){document.title=data.title;win.systemTitle=data.title}loadImg(Util.getRightUrl(data.logo||win.DEFAULT_LOGO_URL),$logo[0]);if(data.fullSearchUrl)win._fullSearchUrl_=data.fullSearchUrl;initPortal(data.homes,data.defaultHome);_breezeEvent_.fire("afterPageInfo")});var EXT_TAB_TPL='\x3cli class\x3d"user-action-item" title\x3d"{{name}}" url\x3d"{{url}}" data-opentype\x3d"{{openType}}" script\x3d"{{script}}"\x3e\x3cspan class\x3d"{{icon}}"\x3e\x3c/span\x3e{{name}}\x3c/li\x3e';_getData_("getExtTabsInfo").done(function(data){if(data&&data.length){var html="";$.each(data,function(i,item){item.icon=item.icon||"modicon-8";if(/^icon-/.test(item.icon))item.icon="action-icon "+item.icon;html+=Mustache.render(EXT_TAB_TPL,item)});$(html).insertAfter("#person-info-setting")}})})(this,jQuery);(function(win,$){var $cover=createMainContentCover();var SOUND_URL="../../msgsound/sound.html",ROLLER_TEXT="\u60a8\u6709\u65b0\u6d88\u606f\u63d0\u9192\uff0c\u8bf7\u70b9\u51fb\u67e5\u770b\uff01",rollerTip=ROLLER_TEXT,timer=0,title="";var rollDocTitle=function(){title=win.systemTitle||document.title;document.title=rollerTip;clearTimeout(timer);timer=setTimeout(function roll(){document.title=rollerTip.substring(1,rollerTip.length)+rollerTip.substring(0,1);rollerTip=document.title;timer=setTimeout(roll,300)},300)};var restoreDocTitle=function(){clearTimeout(timer);document.title=title||document.title;rollerTip=ROLLER_TEXT};win.docTitle={roll:rollDocTitle,stop:restoreDocTitle};var $msgSound=$("#msg-sound");var parseNum=function(num){var n=parseInt(num,10);if(n>99)return"99+";else if(n<=0)return"";return n+""};var $iconList=$("#top-icons"),$remindNum=$(".icons-emsg \x3e .tip-num",$iconList),$eMsgNum=$(".icons-chat \x3e .tip-num",$iconList);var $msgEMsg=$("#msgEMsg",$msgPanel),$msgEMsgContent=$(".msg-panel-content",$msgEMsg),$msgEMsgRecent=$(".emsg-recent-list",$msgEMsgContent),$onlineUserNum=$(".online-user-num",$msgEMsg),onlineUserIframe=document.getElementById("online-user");var getMsgCount=function(useCache){var params={haseXun:true,needNum:true};if(useCache)params.inCache=true;return _getData_("getMsgCount",params).done(function(data){updateMsgCount(data)})};var updateMsgCount=function(data){var old=0,hasNew=false;if(data.remind){old=parseInt($remindNum.data("num"),10)||0;if(data.remind>old)hasNew=true;$remindNum.removeClass("hidden").text(parseNum(data.remind));$remindNum.data("num",data.remind)}else $remindNum.text("").addClass("hidden");if(data.eXun){old=parseInt($eMsgNum.data("num"),10)||0;if(data.eXun>old)hasNew=true;$eMsgNum.removeClass("hidden").text(parseNum(data.eXun));$eMsgNum.data("num",data.eXun)}else $eMsgNum.text("").addClass("hidden");if(hasNew){playNewMsgSound(100);docTitle.roll()}else docTitle.stop()};var playNewMsgSound=function($msgSoundContainer,soundIframeUrl,soundFileUrl){if(Util.getFrameSysParam("messageSound")===false)return Util.noop;soundIframeUrl=Util.getRightUrl(soundIframeUrl);if(Util.browsers.isIE){var $soundIframe=$('\x3ciframe src\x3d"" frameborder\x3d"0" class\x3d"hidden"\x3e\x3c/iframe\x3e').appendTo($msgSoundContainer);return function(){$soundIframe[0].src=soundIframeUrl+"?_\x3d"+ +new Date}}var msgAudio=document.createElement("audio");msgAudio.src=Util.getRightUrl(soundFileUrl);msgAudio.className="hidden-accessible";$msgSoundContainer.append(msgAudio);var newMsgAudioTimer=null;return function doPlayNewMsgAudio(retryLimit){if(retryLimit===undefined)retryLimit=100;msgAudio.play()["catch"](function(){clearTimeout(newMsgAudioTimer);if(retryLimit>0)newMsgAudioTimer=setTimeout(function(){doPlayNewMsgAudio(--retryLimit)},50)})}}($msgSound,SOUND_URL,"../../msgsound/newsms.wav");_breezeEvent_.on("afterPageInfo",function(){getMsgCount();if(!useWebsocket)setInterval(function(){getMsgCount(true)},6E4)});if(useWebsocket)_breezeEvent_.on("websocketCreated",function(){eWebSocket.socketEvent.on("messagecount",function(e){updateMsgCount(e.data)})});win.getMessageCount=getMsgCount;var decreaseEmsgCount=function(){var cnt=$eMsgNum.text();if(cnt)cnt=parseInt(cnt)-1;if(cnt==0){cnt="";$eMsgNum.data("num",0).addClass("hidden")}$eMsgNum.text(cnt)};var emsgList;function initEMsgList(){emsgList=new EMsgList({content:$msgEMsgRecent,getUrl:EmsgConfig.baseUrl,ignoreUrl:EmsgConfig.baseUrl,userImg:EmsgConfig.userImg,groupImg:EmsgConfig.groupImg,afterOpenEMsg:function(){hidePanel()},onDecEmsgCount:decreaseEmsgCount});win.RefreshEMsg=$.proxy(emsgList.getData,emsgList)}if(!win.EMsgList)Util.loadJs("frame/fui/js/widgets/emsglist/emsglist.js",function(){initEMsgList()});else initEMsgList();if(win.OnlineUserSettings&&win.OnlineUserSettings.show){$msgEMsg.find(".msg-panel-head").addClass("tab").find(".panel-hd-tab.hidden").removeClass("hidden");$msgEMsg.on("click",".panel-hd-tab",function(){var $this=$(this),ref=$this.data("ref"),hasShow=$this.data("hasShow"),$content=$msgEMsgRecent;if(!$this.hasClass("active")){$this.addClass("active").siblings().removeClass("active");if(ref){$content=$("#"+ref,$msgEMsgContent);if(!hasShow)setTimeout(function(){OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count)});$this.data("hasShow",true)},10)}$content.removeClass("hidden").siblings().addClass("hidden")}})}function hidePanel(){$cover.addClass("hidden");$msgPanel.stop(true).animate({right:-350},function(){$msgPanel.addClass("hidden")});$iconList.find(".js-panel.active").removeClass("active")}win.hideMessagePanel=hidePanel;var msgCenter;win.messageCenter={refresh:function(){if(msgCenter)msgCenter.refresh()}};$iconList.on("click",".js-panel",function(){var $el=$(this),ref=$el.data("ref"),$panel=$("#"+ref,$msgPanel);if($el.hasClass("active"))hidePanel();else{$el.addClass("active").siblings(".active").removeClass("active");if(ref=="msgRemind"){if(!msgCenter)msgCenter=new MsgCenter(win._msgcenterConfig_||{});msgCenter.show();hideMessagePanel();return}else if(ref=="msgEMsg"){emsgList.getData();if(win.OnlineUserSettings&&win.OnlineUserSettings.show)if(!onlineUserIframe.src){onlineUserIframe.src=OnlineUserSettings.url;if(onlineUserIframe.attachEvent)onlineUserIframe.attachEvent("onload",function(){OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count)})});else onlineUserIframe.onload=function(){OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count)})}}else OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count)})}$panel.removeClass("hidden").siblings(".js-detail").addClass("hidden");$panel.find(".msg-panel-content").removeClass("hidden");$msgPanel.removeClass("hidden");$msgPanel.stop(true).animate({right:0});$cover.removeClass("hidden")}});$msgPanel.on("click",".msg-panel-hide",function(e){hideMessagePanel()});$("body").on("click",function(e){var $target=$(e.target);if(!$target.closest("#msg-panel , .js-panel[data-ref]").length)hideMessagePanel()});win.getMessageCount=getMsgCount})(this,jQuery);(function(win,$){var $searchContainer=$("#search-container");var FULL_SEARCH_PREFIX="fullsearch";function doSearch(type,kw){type=type||"all";var fullSearchIfr=document.getElementById("tab-content-"+FULL_SEARCH_PREFIX);var aimUrl=win._fullSearchUrl_+"?wd\x3d"+win.encodeURI(kw)+"\x26type\x3d"+type;if(!fullSearchIfr)dealLinkOpen({id:FULL_SEARCH_PREFIX,name:"\u5168\u6587\u68c0\u7d22",url:aimUrl,openType:"tabsnav"});else fullSearchIfr.src=Util.getRightUrl(aimUrl);$searchContainer.removeClass("active")}function getCateData(){return Util.ajax({url:win._searchCfg.fullSearchCateUrl}).done(function(data){initFullSearch(data.categories)})}function initFullSearch(cateData){cateData=cateData||[];if(typeof cateData=="string")cateData=mini.decode(cateData);var cates=[];$.each(cateData,function(i,item){cates.push({id:item.guid,name:item.name,iconCls:item.icon||"view"})});if(!cates.length)cates.push({id:"all",name:"\u5168\u6587\u68c0\u7d22",iconCls:"modicon-25"});ClassifySearch._styleLoaded=true;ClassifySearch.CLASSIFICATION_TPL='\x3cdiv class\x3d"classify-search-classify-item {{#isActive}}active{{/isActive}}" data-id\x3d"{{id}}" data-title-tpl\x3d"\u4e0e${keyword}\u76f8\u5173\u7684{{name}}"\x3e\x3cspan class\x3d"classify-search-classify-icon {{iconCls}}"\x3e\x3c/span\x3e\u4e0e\x3cspan class\x3d"classify-search-classify-kw"\x3e\x3c/span\x3e\u76f8\u5173\u7684{{name}}\x3cspan class\x3d"classify-search-classify-target hidden"\x3e{{target}}\x3c/span\x3e\x3c/div\x3e';ClassifySearch._$pageCover=createMainContentCover();var classifySearch=new ClassifySearch({id:"header-search",searchTarget:"\u5185\u5bb9",category:cates,placeholder:"\u8bf7\u8f93\u5165",maxShowCharacter:4,enter:function(id,key){doSearch(id,key)}});dealUserModuleSearch(classifySearch);function ieOverflowFixed(show){if(Util.browsers.isIE||Util.browsers.isEdge)$searchContainer[show?"addClass":"removeClass"]("show-overflow")}$searchContainer.on("click",".search-btn",function(){ieOverflowFixed(false);$searchContainer.toggleClass("active").trigger("autoFocus")}).on("autoFocus",function(){if(!Util.browsers.isSupportTransition)$searchContainer.hasClass("active")&&classifySearch.$input.trigger("focus")});if(Util.browsers.isSupportTransition)$searchContainer.on(Util.browsers.transitionend,function(ev){if(ev.target===this)if($searchContainer.hasClass("active")){ieOverflowFixed(true);classifySearch.$input.trigger("focus")}});if(Util.browsers.isSupportAnimation)classifySearch.$popup.on(Util.browsers.animationend,function(ev){if(ev.target===this)if(!classifySearch.$container.hasClass("popup")){ieOverflowFixed(false);$searchContainer.removeClass("active")}});else classifySearch.$input.on("blur",function(){Util.browsers.isIE&&$searchContainer.removeClass("show-overflow");$searchContainer.removeClass("active")})}function dealUserModuleSearch(classifySearch){var $userItem=classifySearch.$classifyList.find('[data-id\x3d"user"]'),$moduleItem=classifySearch.$classifyList.find('[data-id\x3d"module"]');if(!$userItem.length||!$moduleItem.length)return;var $userList=$('\x3cul class\x3d"top-search-user-list"\x3e\x3c/ul\x3e'),$moduleList=$('\x3cul class\x3d"top-search-module-list"\x3e\x3c/ul\x3e');if($userItem.length){$userList.insertAfter($userItem);$userList.on("click",".top-search-user-item",function(){_searchCfg.userClick&&_searchCfg.userClick(this.getAttribute("data-id"),this.title);classifySearch.$input.blur().val("");classifySearch.hidePopup()})}if($moduleItem.length){$moduleList.insertAfter($moduleItem);$moduleList.on("click",".top-search-module-item",function(){var $this=$(this);$this.data("url")&&dealLinkOpen({id:$this.data("id"),name:this.title,url:$this.data("url"),openType:$this.data("opentype")});classifySearch.$input.blur().val("");classifySearch.hidePopup()})}var timer;var ignoreCodes=[13,16,17,18,27,37,38,39,40];var isSupportInput=function(){var input=document.createElement("input");return"oninput"in input}();if(isSupportInput)classifySearch.$input.on("input",function(){clearTimeout(timer);timer=setTimeout(immediatelySearch,50)});else classifySearch.$input.on("keyup",function(ev){if($.inArray(ev.which,ignoreCodes)!=-1)return;clearTimeout(timer);timer=setTimeout(immediatelySearch,50)});classifySearch.$input.on("setHistoryValue",immediatelySearch);var lastRequest;var USER_ITEM_TPL='\x3cli class\x3d"top-search-user-item" data-id\x3d"{{guid}}" title\x3d"{{name}}" \x3e\x3cimg class\x3d"top-search-user-item-img" src\x3d"{{portrait}}" \x3e{{{hlname}}}\x3c/li\x3e';var MODULE_ITEM_TPL='\x3cli class\x3d"top-search-module-item" data-id\x3d"{{code}}" title\x3d"{{name}}" data-opentype\x3d"{{openType}}" data-url\x3d"{{url}}"\x3e\x3cspan class\x3d"top-search-module-item-icon {{icon}}"\x3e\x3c/span\x3e{{{hlname}}}\x3c/li\x3e';function immediatelySearch(){var value=$.trim(classifySearch.$input.val());if(lastRequest)lastRequest.abort();if(!value)return;lastRequest=Util.ajax({url:epoint.dealRestfulUrl(_searchCfg.userModuleSearchUrl),data:{cnum:"user,module",key:value,rn:3,location:"search"}});lastRequest.done(function(res){var data=mini.decode(res.frameinfo);var userHTML=[],moduleHTML=[],hlReg=new RegExp(value,"ig");data.users&&$.each(data.users,function(i,item){item.portrait=Util.getRightUrl(item.portrait);item.hlname=item.name.replace(hlReg,'\x3cspan class\x3d"search-kw"\x3e'+value+"\x3c/span\x3e");userHTML.push(Mustache.render(USER_ITEM_TPL,item))});data.modules&&$.each(data.modules,function(i,item){item.icon=item.icon||"modicon-1";item.hlname=item.name.replace(hlReg,'\x3cspan class\x3d"search-kw" \x3e'+value+"\x3c/span\x3e");moduleHTML.push(Mustache.render(MODULE_ITEM_TPL,item))});$(userHTML.join("")).appendTo($userList.empty());$(moduleHTML.join("")).appendTo($moduleList.empty())})}}_breezeEvent_.on("afterPageInfo",function(){var $menu=$("#menu");if(win._fullSearchUrl_){$menu.removeClass("no-search");getCateData()}else $menu.addClass("no-search")})})(this,jQuery);window.OpenEMsg=function(sessionId,uid,type){if(window.eMsg)if(typeof uid==="undefined")eMsg.open(sessionId);else eMsg.openSession(sessionId,uid,type);else creatWebSocket(_userGuid_,_userName_,function(){eWebSocket.openEmsg(sessionId,uid,type)})};