/* jshint -W030 */
// 分屏页码模板
var SCREEN_PAGE_TPL='\x3ca href\x3d"javascript:void(0);" data-page\x3d"{{page}}" class\x3d"page-item l mr10"\x3e\x3cspan\x3e{{pageNum}}\x3c/span\x3e\x3c/a\x3e',SCREEN_TPL='\x3cdiv class\x3d"imac-screen l" data-title\x3d"\u7b2c{{page}}\u5206\u5c4f"\x3e\x3c/div\x3e',SCREEN_APP_TPL='\x3cdiv class\x3d"app-item trans" title\x3d"{{name}}" style\x3d"top:{{top}}px;left:{{left}}px" data-id\x3d"{{id}}"\x3e\x3cspan class\x3d"unread {{^count}}hidden{{/count}}"\x3e{{count}}\x3c/span\x3e\x3cimg src\x3d"{{icon}}" alt\x3d"" class\x3d"app-icon"\x3e\x3cp class\x3d"app-name"\x3e{{name}}\x3c/p\x3e\x3c/div\x3e',TASK_ITEM_TPL='\x3ca href\x3d"javascript:void(0);" id\x3d"{{id}}-task" data-id\x3d"{{id}}" class\x3d"task-item l clearfix" title\x3d"{{name}}"\x3e\x3cp class\x3d"task-name l"\x3e{{name}}\x3c/p\x3e\x3c/a\x3e',DROP_ITEM_TPL='\x3cli id\x3d"{{id}}-drop" data-id\x3d"{{id}}" class\x3d"drop-item" title\x3d"{{name}}"\x3e{{name}}\x3c/li\x3e',DOCK_APP_TPL='\x3cdiv class\x3d"dock-app" data-id\x3d"{{id}}" title\x3d"{{name}}"\x3e{{#count}}\x3cspan class\x3d"unread"\x3e{{count}}\x3c/span\x3e{{/count}}\x3cimg src\x3d"{{icon}}" alt\x3d"" \x3e\x3cp class\x3d"name"\x3e{{{sname}}}\x3c/p\x3e\x3c/div\x3e',SEARCH_APPS_TPL='\x3cdiv class\x3d"app-item trans in-panel l" title\x3d"{{name}}" id\x3d"{{id}}-search" data-id\x3d"{{id}}"\x3e\x3cimg src\x3d"{{icon}}" alt\x3d"" class\x3d"app-icon"\x3e\x3cp class\x3d"app-name"\x3e{{name}}\x3c/p\x3e\x3c/div\x3e',BOARD_BTN_TPL='\x3cdiv class\x3d"right-board-btn" data-id\x3d"{{id}}" data-url\x3d"{{url}}"\x3e{{name}}\x3c/div\x3e',BOARD_CONTENT_TPL='\x3ciframe src\x3d"{{url}}" class\x3d"board-content hidden" id\x3d"board-content-{{id}}" height\x3d"100%" width\x3d"100%" frameborder\x3d"0" scrolling\x3d"no"\x3e\x3c/iframe\x3e',FOLDER_ITEM_TPL='\x3cli class\x3d"folder-item l" data-id\x3d"{{id}}"\x3e\x3cimg src\x3d"{{icon}}" class\x3d"folder-app-icon"\x3e\x3c/li\x3e',SCREEN_FOLDER_TPL='\x3cdiv class\x3d"app-item folder"  title\x3d"{{name}}" style\x3d"top:{{top}}px;left:{{left}}px" data-id\x3d"{{id}}"\x3e\x3cspan class\x3d"unread {{^count}}hidden{{/count}}"\x3e{{count}}\x3c/span\x3e\x3cul class\x3d"folder-list"\x3e{{#apps}}\x3cli class\x3d"folder-item l" data-id\x3d"{{id}}"\x3e\x3cimg src\x3d"{{icon}}" class\x3d"folder-app-icon"\x3e\x3c/li\x3e{{/apps}}\x3c/ul\x3e\x3cp class\x3d"app-name"\x3e{{name}}\x3c/p\x3e\x3c/div\x3e',FOLDER_TPL='\x3cdiv class\x3d"folder-cover" data-id\x3d"{{id}}"\x3e\x3cp class\x3d"folder-name" title\x3d"\u5355\u51fb\u91cd\u547d\u540d"\x3e\x3cspan class\x3d"folder-name-text"\x3e{{name}}\x3c/span\x3e\x3cinput type\x3d"text" class\x3d"folder-name-input" maxlength\x3d"6" required/\x3e\x3c/p\x3e\x3cdiv class\x3d"folder-container"\x3e{{{appHTML}}}\x3c/div\x3e\x3c/div\x3e';window.ImacEvent=new Util.UserEvent;var OCCUPIED_H=50+44,APP_INIT_TOP=15,APP_INIT_LEFT=25,APP_GAP_V=20,APP_GAP_H=40,APP_WIDTH=105,APP_HEIGHT=125;window.dealLinkOpen=function(linkData){switch(linkData.openType){case "tabsnav":TabsNav.addTab(linkData);break;case "dialog":epoint.openTopDialog(linkData.name,Util.getRightUrl(linkData.url));break;case "blank":window.open(Util.getRightUrl(linkData.url),(linkData.id+"").replace(/-/g,"_"));break;default:break}};(function(win,$){var SEARCH_APPS_NUM=20;$.extend(Util,{debounce:function(fn,delay,ctx){delay=delay||17;var timer;return function(){var args=arguments;var context=ctx||this;clearTimeout(timer);timer=setTimeout(function(){fn.apply(context,args)},delay)}},throttle:function(fn,delay,ctx){delay=delay||200;var timer,prevTime=+new Date;return function(){clearTimeout(timer);var args=arguments;var context=ctx||this;var pastTime=+new Date-prevTime;if(pastTime>=delay){fn.apply(context,args);prevTime=+new Date}else timer=setTimeout(function(){fn.apply(context,args);prevTime=+new Date},delay-pastTime)}},localMemory:{_get:function(key){return JSON.parse(localStorage.getItem(key))||[]},_add:function(value,key,length){var data=this._get(key);var index=$.inArray(value,data);if(index!=-1){data.splice(index,1);data.unshift(value);return false}if(data.unshift(value)>length)data.length=length;localStorage.setItem(key,JSON.stringify(data));return true},_del:function(value,key){var data=this._get(key);var index=$.inArray(value,data);if(index===-1)return;data.splice(index,1);localStorage.setItem(key,JSON.stringify(data))},SearchHistory:{get:function(){return Util.localMemory._get("_search-history_")},add:function(appId){return Util.localMemory._add(appId,"_search-history_",SEARCH_APPS_NUM)},remove:function(appId){return Util.localMemory._del(appId,"_search-history_")}},QuickApps:{get:function(){return Util.localMemory._get("_quick-apps_")},add:function(appId){return Util.localMemory._add(appId,"_quick-apps_",10)},remove:function(appId){return Util.localMemory._del(appId,"_quick-apps_")}},RecentApps:{get:function(){return Util.localMemory._get("_recent-apps_")},add:function(appId){return Util.localMemory._add(appId,"_recent-apps_",10)},remove:function(appId){return Util.localMemory._del(appId,"_recent-apps_")}}},getBdSize:function(){return{width:$(win).width()-60,height:$(win).height()-50-44}},getAppShortName:function(name){return name.substr(0,4)},fixPath:function(data){var copy=$.extend({},data);copy.url=Util.getRightUrl(data.url);copy.icon=Util.getRightUrl(data.icon);return copy},highlightApp:function($app){var dark=function(){$app.animate({opacity:.3},200,next)},light=function(){$app.animate({opacity:1},200,next)},next=function(){var n=$app.queue("highlight");if(!n.length)$app.clearQueue("highlight");else $app.dequeue("highlight")};$app.queue("highlight",[dark,light,dark,light,dark,light,dark,light]);next()},_jsPromise:{},loadJsPromise:function(url){if(this._jsPromise[url])return this._jsPromise[url];var dtd=$.Deferred(),script=document.createElement("script");script.type="text/javascript";if((this.browsers.isIE67||this.browsers.isIE8)&&script.readyState)script.onreadystatechange=function(){if(script.readyState=="loaded"||script.readyState=="complete"){dtd.resolve();script.onreadystatechange=null}};else{script.onload=function(){dtd.resolve();script.onload=null};script.onerror=function(){dtd.reject();script.onerror=null;Util._jsPromise[url]=null}}script.src=Util.getRightUrl(url);document.getElementsByTagName("head")[0].appendChild(script);return this._jsPromise[url]=dtd.promise()},doNiceScroll:function($el,cfg){this.loadJsPromise("frame/fui/js/widgets/jquery.nicescroll.min.js").done(function(){$el.niceScroll(cfg)})},doPlaceHolder:function($el){this.loadJsPromise("frame/fui/js/widgets/jquery.placeholder.min.js").done(function(){$el.placeholder()})},parseNum:function(num){var n=parseInt(num,10);if(n>99)return"99+";else if(n<=0)return"";return n+""}});EpDialog.setMaxCoord({top:50,left:0,right:60,bottom:50});win.eWebSocket=undefined;win.creatWebSocket=function(uid,uname,callback){if(eWebSocket){callback&&callback();return}var cfg=win.EWebSocketConfig?win.EWebSocketConfig:{url:EmsgConfig.websocketUrl};cfg.uid=uid;cfg.uname=uname;if(win.EWebSocket){eWebSocket=new EWebSocket(cfg);callback&&callback();ImacEvent.fire("websocketCreated")}else Util.loadJs("frame/fui/js/widgets/ewebsocket/ewebsocket.js",function(){eWebSocket=new EWebSocket(cfg);callback&&callback();ImacEvent.fire("websocketCreated")})}})(this,jQuery);(function(win,$){var DEFAULT_BG="frame/fui/pages/themes/imac/images/skinbg/bg.jpg";var $bg=$("#imac-skin-bg");Util.ajax({url:ImacDataActionUrl.getBgUrl}).done(function(data){if(data&&data.bg){$bg[0].src=Util.getRightUrl(data.bg);localStorage.setItem("_imac_bg_",data.bg)}else{$bg[0].src=Util.getRightUrl(DEFAULT_BG);console&&console.error("\u672a\u8fd4\u56de\u80cc\u666f\uff0c\u52a0\u8f7d\u9ed8\u8ba4\u80cc\u666f\uff01");localStorage.setItem("_imac_bg_",DEFAULT_BG)}});win.setBg=function(url){$bg[0].src=Util.getRightUrl(url);localStorage.setItem("_umplatform_bg_",url)}})(this,jQuery);(function(win,$){var $pageList=$("#imac-page-list");var $screensCon=$("#imac-screens-container"),$screenList=$(".screen-list");var M=Mustache,pageTempl=$.trim(SCREEN_PAGE_TPL),screenTempl=$.trim(SCREEN_TPL),appTempl=$.trim(SCREEN_APP_TPL),folderTempl=$.trim(SCREEN_FOLDER_TPL);var PAGE_WIDTH=28,PAGE_GAP=10;var pageNum;var activePage=DEFAULT_ACTIVE_PAGE-1;var appNumPerCol=($(win).height()-OCCUPIED_H-APP_INIT_TOP)/(APP_HEIGHT+APP_GAP_V)>>0;var appNumPerRow=6;var appCm;var adjustScreenSize=function(){var $screens=$screensCon.find(".imac-screen"),bdSize=Util.getBdSize(),dis=activePage*bdSize.width;$screensCon.add($screens).css(bdSize);$screenList.css("margin-left",-dis)};var renderPages=function(data){var html=[],wd=data.length*(PAGE_WIDTH+PAGE_GAP);$.each(data,function(i){var temp={page:i,pageNum:i+1};html.push(M.render(pageTempl,temp))});$pageList.css({marginLeft:-wd/2,width:wd}).append(html.join(""))};var renderScreens=function(data){var html=[];$.each(data,function(i,item){var temp={page:i+1};ImacScreen._screenCache[i]={id:item.id,name:item.name};html.push(M.render(screenTempl,temp))});$screenList.html(html.join(""))};function reLayoutApp(){var newColNum=($(win).height()-OCCUPIED_H-APP_INIT_TOP)/(APP_HEIGHT+APP_GAP_V)>>0;if(newColNum===appNumPerCol)return;appNumPerCol=newColNum;$.each($screenList.children(),function(i,screen){var $screen=$(screen);$screen.find(".app-item").each(function(j,app){var $app=$(app);var pos=getAppPosByIndex(j);$app.removeClass("trans").css(pos).addClass("trans")})})}$(win).on("resize",Util.debounce(reLayoutApp,50));var getAppPosByIndex=function(index){var col=Util.toInt(index/appNumPerCol),row=Util.toInt(index%appNumPerCol);return{left:APP_INIT_LEFT+(APP_WIDTH+APP_GAP_H)*col,top:APP_INIT_TOP+(APP_HEIGHT+APP_GAP_V)*row}};var getAppPosByIndexInFolder=function(index){var col=Util.toInt(index%appNumPerRow),row=Util.toInt(index/appNumPerRow);return{left:APP_INIT_LEFT+(APP_WIDTH+APP_GAP_H)*col,top:APP_INIT_TOP+(APP_HEIGHT+APP_GAP_V)*row}};var renderAppsByPage=function(page,data){var $screen=null,html=[];if(!data.length)return;$screen=$screenList.find(".imac-screen").eq(page);$.each(data,function(i,item){var isFolder=item.apps&&item.apps.length,count=0;!isFolder&&(item=Util.fixPath(item));var pos=getAppPosByIndex(i),view=$.extend({},item,pos);item.page=page;item.index=i;if(isFolder){$.each(item.apps,function(i1,item1){item1=Util.fixPath(item1);item1.index=i1;item1.folderId=item.id;AppMgr.cacheAppData(item1.id,item1);item.apps[i1]=item1;if(item1.needMsgRemind){AppMgr.msgRemindApps.push(item1.id);count+=item1.count}});item.count=count;FolderMgr.cacheFolderData(item.id,item);view=$.extend({},item,view,{count:Util.parseNum(count)});html.push(M.render(folderTempl,view))}else html.push(M.render(appTempl,view));AppMgr.cacheAppData(item.id,item);if(item.needMsgRemind)AppMgr.msgRemindApps.push(item.id)});$screen.html(html.join(""))};var renderApps=function(data){if(data.length)$.each(data,function(i,item){renderAppsByPage(i,item.apps)})};var getScreenInfo=function(){return Util.ajax({url:win.ImacDataActionUrl.screenAppsUrl}).done(function(data){if(data){if(Object.prototype.toString.call(data)!="[object Array]"){console.error("\u5c4f\u5e55\u5e94\u7528\u6570\u636e\u9519\u8bef\uff01");return}renderPages(data);renderScreens(data);renderApps(data);ImacEvent.fire("afterAllAppsLoad");pageNum=data.length;appCm=createAppContextMenu();folderCm=createFolderContextMenu();AppDragMgr.enableAllScreenApps();adjustScreenSize();setPageActive(activePage)}})};getScreenInfo();var setPageActive=function(page){var dis=page*Util.getBdSize().width,$el=$pageList.find(".page-item").eq(page);$el.addClass("active").siblings().removeClass("active");$screenList.stop(true).animate({marginLeft:-dis},200);appCm.enableItem("page-"+activePage).disableItem("page-"+page);folderCm.enableItem("page-"+activePage).disableItem("page-"+page);activePage=page};var getPropPage=function(page){var rt=page;if(page<0)rt=0;else if(page>pageNum-1)rt=pageNum-1;return rt};$pageList.on("click",".page-item",function(){var $el=$(this),page=Util.toInt($(this).data("page"));if($el.hasClass("active"))return;setPageActive(page)});win.AppCmFuncs={moveToScreen:function(opt,data){AppMgr.moveToScreen(opt.id,data.page)},screenToToolbar:function(opt){AppMgr.screenToToolbar(opt.id)},openApp:function(opt){AppMgr.openApp(opt.id)},uninstallApp:function(opt){epoint.confirm("\u786e\u5b9a\u8981\u5378\u8f7d\u6b64\u5e94\u7528\u5417\uff1f\u5378\u8f7d\u4e4b\u540e\u60a8\u53ef\u4ee5\u91cd\u65b0\u4ece\u5e94\u7528\u4ed3\u5e93\u4e2d\u5b89\u88c5","\u5378\u8f7d\u63d0\u9192",function(){AppMgr.uninstallApp(opt.id)})}};var createAppContextMenu=function(){var items=[],i,moveItems=[],funcs=AppCmFuncs;items.push({text:"\u6253\u5f00\u5e94\u7528",role:"open-app",click:funcs.openApp});items.push("sep");items.push({text:"\u5378\u8f7d\u5e94\u7528",role:"uninstall-app",click:funcs.uninstallApp});items.push("sep");for(i=1;i<=pageNum;i++)moveItems.push({text:ImacScreen._screenCache[i-1].name||"\u684c\u9762-"+i,role:"page-"+(i-1),page:i-1,click:funcs.moveToScreen});items.push({text:"\u79fb\u52a8\u5e94\u7528\u5230",role:"move-app",items:moveItems});items.push({text:"\u53d6\u6d88",role:"hide",click:function(){appCm.hide()}});var cm=(new EpContextMenu({items:items})).setOptions("from","screen");return cm};win.FolderCmFuncs={moveToScreen:function(opt,data){AppMgr.moveToScreen(opt.id,data.page)},openFolder:function(opt){ImacFolder.openFolder(opt.id)}};var createFolderContextMenu=function(){var items=[],i,moveItems=[],funcs=FolderCmFuncs;items.push({text:"\u6253\u5f00\u6587\u4ef6\u5939",role:"open-folder",click:funcs.openFolder});items.push("sep");for(i=1;i<=pageNum;i++)moveItems.push({text:ImacScreen._screenCache[i-1].name||"\u684c\u9762-"+i,role:"page-"+(i-1),page:i-1,click:funcs.moveToScreen});items.push({text:"\u79fb\u52a8\u5230",role:"move-folder",items:moveItems});items.push({text:"\u53d6\u6d88",role:"hide",click:function(){folderCm.hide()}});var cm=(new EpContextMenu({items:items})).setOptions("from","screen");return cm};var LEFT_KEY=37,RIGHT_KEY=39;var handleKeydown=function(event){var code=event.which,page;if(code==LEFT_KEY)page=activePage-1;else if(code==RIGHT_KEY)page=activePage+1;if(page===undefined)return;page=getPropPage(page);setPageActive(page)};$(document).on("keydown",handleKeydown);$(win).on("resize",adjustScreenSize);$screensCon.on("click",".app-item",function(){var $this=$(this),id=$this.data("id");if($this.hasClass("folder"))ImacFolder.openFolder(id);else AppMgr.openApp(id)}).on("contextmenu",".app-item",function(event){var $this=$(this),id=$this.data("id"),isFolder=$this.hasClass("folder"),cm=isFolder?folderCm:appCm;if($this.closest(".folder-container").length)return false;cm.setOptions("id",id).show({x:event.pageX,y:event.pageY});return false});win.AppMgr={_data:{},msgRemindApps:[],cacheAppData:function(id,data){this._data[id]=$.extend({},data)},deleteAppData:function(id){this._data[id]=null},getAppData:function(id){var info=this._data[id];if(!info)return false;return $.extend({},info)},screenToToolbar:function(id){if(QuickApps.isFull())return;QuickApps.addApp(id,false,true)},moveToScreen:function(id,page){var $prevApp=ImacScreen.getScreen(page).find(".app-item").last(),prevAppId=$prevApp.length?$prevApp.data("id"):null;ImacScreen.removeApp(id);if(FolderMgr.getFolderData(id))ImacScreen.addFolder(id,page);else ImacScreen.addApp(id,page);Util.ajax({url:ImacDataActionUrl.appToScreenUrl,data:{appId:id,screenId:ImacScreen._screenCache[page].id,prevAppId:prevAppId}})},openApp:function(id){var data=AppMgr.getAppData(id);if(data.openType=="blank")win.open(data.url);else TabsNav.addOrActiveTab(id);ImacFolder.closeFolder()},installApp:function(id,callback){var $prevApp=ImacScreen.getScreen(activePage).find(".app-item").last(),prevAppId=$prevApp.length?$prevApp.data("id"):null;return Util.ajax({url:ImacDataActionUrl.installAppUrl,data:{appId:id,screenId:ImacScreen._screenCache[activePage].id,prevAppId:prevAppId}}).done(function(data){if(!data)return;callback&&callback();data=Util.fixPath(data);AppMgr.cacheAppData(data.id,data);if(data.needMsgRemind)AppMgr.msgRemindApps.push(data.id);ImacScreen.addApp(data.id,activePage)})},uninstallApp:function(id,callback){if(TabsNav._data[id]){epoint.alert("\u6b64\u5e94\u7528\u5df2\u7ecf\u6253\u5f00\uff0c\u8bf7\u5173\u95ed\u540e\u518d\u5378\u8f7d\uff01",null,null,"info");return}return Util.ajax({url:ImacDataActionUrl.uninstallAppUrl,data:{appId:id}}).done(function(data){if(!data)return;if(data.status=="success"){var appData=AppMgr.getAppData(id);if(appData&&appData.msgCountUrl)for(var i=0,l=AppMgr.msgRemindApps.length;i<l;++i){var currAppId=AppMgr.msgRemindApps[i];if(currAppId==id){AppMgr.msgRemindApps.splice(i,1);break}}appData=null;ImacScreen.removeApp(id);QuickApps.removeApp(id);AppMgr.deleteAppData(id);ImacEvent.fire("afterAppUninstall",id);epoint.showTips("\u5e94\u7528\u5378\u8f7d\u6210\u529f\uff01",{state:"success"});callback&&callback()}else if(data.description)epoint.alert(data.description,null,null,"info")})},creatFolder:function(app,callback){return Util.ajax({url:ImacDataActionUrl.creatFolderUrl,data:{screenId:ImacScreen._screenCache[activePage].id,appId:app.id}}).done(function(data){if(data.id){AppMgr.cacheAppData(data.id,data);ImacScreen.changeAppToFolder(data.id,activePage,app);callback&&callback(data)}})},folderToScreen:function(id,page,callback){var $prevApp=ImacScreen.getScreen(page).find(".app-item").last(),prevAppId=$prevApp.length?$prevApp.data("id"):null;Util.ajax({url:ImacDataActionUrl.appToScreenUrl,data:{appId:id,screenId:ImacScreen._screenCache[page].id,prevAppId:prevAppId}}).done(function(data){if(!data)return;callback&&callback()})}};win.ImacScreen={_screenCache:[],getActivePage:function(){return activePage},getApp:function(id){return $screensCon.find('.app-item[data-id\x3d"'+id+'"]')},getScreen:function(page){return $screensCon.find(".imac-screen").eq(page)},addApp:function(id,page,index){var $screen=this.getScreen(page),data=AppMgr.getAppData(id),pos;if(index===undefined)index=$screen.find(" \x3e .app-item").length;pos=getAppPosByIndex(index);$.extend(data,{index:index,page:page});$app=$(M.render(appTempl,data));$app.appendTo($screen).css(pos);Util.highlightApp($app);AppMgr.cacheAppData(id,data);AppDragMgr.enableScreenApp(id)},removeApp:function(id){var $app=this.getApp(id),data=AppMgr.getAppData(id);$app.addClass("hidden");ImacScreen.adjustAppsPosFromIndex(data.page,data.index+1,1);AppDragMgr.destroy($app);$app.remove()},addFolder:function(id,page,index){var $screen=this.getScreen(page),data=AppMgr.getAppData(id),pos,appHtml=[],$html;if(index===undefined)index=$screen.find(" \x3e .app-item").length;pos=getAppPosByIndex(index);$.extend(data,{index:index,page:page,count:Util.parseNum(data.count)});$html=$(M.render(folderTempl,data));$html.appendTo($screen).css(pos);Util.highlightApp($html);AppMgr.cacheAppData(id,data);AppDragMgr.enableScreenApp(id)},changeAppToFolder:function(id,page,app){var $screen=this.getScreen(page),data=AppMgr.getAppData(id),index=app.index,pos=getAppPosByIndex(index),$app=$screensCon.find('[data-id\x3d"'+app.id+'"]');app.folderId=id;app.index=0;$.extend(data,{index:index,page:page,name:"\u6587\u4ef6\u5939",apps:[app]});$folder=$(M.render(folderTempl,data));$folder.appendTo($screen).css(pos);AppMgr.cacheAppData(id,data);AppDragMgr.enableScreenApp(id);AppDragMgr.destroy($app);$app.remove();AppMgr.cacheAppData(app.id,app)},addAppToFolder:function(appId,folderId){var $app=$screensCon.find('[data-id\x3d"'+appId+'"]'),$folder=$screensCon.find('[data-id\x3d"'+folderId+'"]'),appData=AppMgr.getAppData(appId),$list=$folder.find(".folder-list");$list.append(Mustache.render(FOLDER_ITEM_TPL,{id:appId,icon:appData.icon}));$app.addClass("hidden");ImacScreen.adjustAppsPosFromIndex(activePage,appData.index+1,1);AppDragMgr.destroy($app);$app.remove();FolderMgr.addAppToFolder(appId,folderId)},updateFolderApps:function(folderId){var $folder=$screensCon.find('[data-id\x3d"'+folderId+'"]'),folderData=AppMgr.getAppData(folderId),html=[];$.each(folderData.apps,function(i,item){html.push(Mustache.render(FOLDER_ITEM_TPL,item))});$folder.find(".folder-list").html(html.join(""))},updateFolderName:function(folderId,name){var $folder=$screensCon.find('.app-item[data-id\x3d"'+folderId+'"]');$folder.attr("title",name).find(".app-name").text(name);FolderMgr.updateFolderName(folderId,name)},updateFolderNum:function(){FolderMgr.folderIterator(function(folder){var $folder=ImacScreen.getApp(folder.id),isOpen=folder.id===ImacFolder._currOpenFolderId,$count=$folder.find("\x3e .unread"),count=0;$.each(folder.apps,function(i,item){if(item.needMsgRemind){count+=item.count;if(isOpen)ImacFolder.updateAppNum(item.id,item.count)}});folder.count=count;AppMgr.cacheAppData(folder.id,folder);if(count){count=Util.parseNum(count);$count.text(count).removeClass("hidden")}else $count.addClass("hidden")})},getAppByIndex:function(page,index){var $apps=this.getScreen(page).find(".app-item"),$rt=false;$apps.each(function(i,app){var id=$(app).data("id"),data=AppMgr.getAppData(id);if(data.index==index){$rt=$(app);return false}});return $rt},getAppIndexByPos:function(pos){var c,r,i,isOut=pos.top>APP_INIT_TOP+(appNumPerCol-1)*(APP_GAP_V+APP_HEIGHT)+APP_HEIGHT/2;if(isOut)i=-1;else{c=Math.round((pos.left-APP_INIT_LEFT)/(APP_GAP_H+APP_WIDTH));r=Math.round((pos.top-APP_INIT_TOP)/(APP_GAP_V+APP_HEIGHT));i=c*appNumPerCol+r}return i},adjustAppPosByIndex:function(id,index){var data=AppMgr.getAppData(id),pos=getAppPosByIndex(index),$app=ImacScreen.getApp(id);if(Util.browsers.isIE8||Util.browsers.isIE9)$app.stop(true).animate(pos,200);else $app.css(pos);if(data.index!=index){data.index=index;AppMgr.cacheAppData(id,data)}},adjustAppsPosFromIndex:function(page,index,isUp){var l=ImacScreen.getScreen(page).find("\x3e.app-item").length,i,pos,data,id,temp;var appArr=[];for(i=index;i<l;i++)appArr.push(ImacScreen.getAppByIndex(page,i));$.each(appArr,function(n,$app){id=$app.data("id");data=AppMgr.getAppData(id);temp=isUp?data.index-1:data.index+1;pos=getAppPosByIndex(temp);$app.css(pos);data.index=temp;AppMgr.cacheAppData(id,data)})},getAppsSort:function(page){var sort=[];this.getScreen(page).find(".app-item").each(function(i,app){sort.push($(app).data("id"))});return sort}};win.FolderMgr={_data:{},cacheFolderData:function(id,data){this._data[id]=$.extend({},data)},deleteFolderData:function(id){this._data[id]=null;delete this._data[id]},getFolderData:function(id){var info=this._data[id];if(!info)return false;return $.extend({},info)},addAppToFolder:function(appId,folderId){var folder=AppMgr.getAppData(folderId),app=AppMgr.getAppData(appId),view=$.extend({},app,{index:folder.apps.length,folderId:folderId});folder.apps.push(view);Util.ajax({url:ImacDataActionUrl.addAppToFolderUrl,data:{folderId:folderId,appId:appId}}).done(function(data){AppMgr.cacheAppData(folderId,folder);AppMgr.cacheAppData(appId,view);if(app.needMsgRemind)ImacScreen.updateFolderNum(folderId)})},removeAppFromFolder:function(appId,folderId){var folder=AppMgr.getAppData(folderId),app=AppMgr.getAppData(appId),matchIndex=-1;$.each(folder.apps,function(i,item){if(matchIndex>-1)item.index-=1;else if(item.id===appId)matchIndex=i});if(matchIndex>-1)folder.apps.splice(matchIndex,1);AppMgr.folderToScreen(appId,ImacScreen.getActivePage(),function(){if(!folder.apps.length)FolderMgr.removeFolder(folderId);else AppMgr.cacheAppData(folderId,folder);app.folderId=null;delete app.folderId;AppMgr.cacheAppData(appId,app);ImacFolder.closeFolder()})},removeFolder:function(folderId){ImacScreen.removeApp(folderId);Util.ajax({url:ImacDataActionUrl.removeFolderUrl,data:{folderId:folderId}})},adjustFolderApps:function(folderId,appId){var folder=AppMgr.getAppData(folderId),apps=[],app;if(appId)$.each(folder.apps,function(i,item){if(item.id==appId)app=AppMgr.getAppData(appId);else app=item;apps.push(app)});else $.each(folder.apps,function(i,item){app=AppMgr.getAppData(item.id);apps[app.index]=app});folder.apps=apps;AppMgr.cacheAppData(folderId,folder)},updateFolderName:function(folderId,name){var folder=AppMgr.getAppData(folderId);folder.name=name;AppMgr.cacheAppData(folderId,folder);Util.ajax({url:ImacDataActionUrl.updateFolderNameUrl,data:{folderId:folderId,name:name}})},folderIterator:function(callback){$.each(this._data,function(i,folder){callback(AppMgr.getAppData(folder.id))})}};win.ImacFolder={_currOpenFolderId:null,getAppByIndex:function(index){var $folderCover=$(".folder-cover"),folderId=$folderCover.data("id"),$apps=$folderCover.find(".app-item"),$rt=false;$apps.each(function(i,app){var id=$(app).data("id"),data=AppMgr.getAppData(id);if(data.index==index){$rt=$(app);return false}});return $rt},getAppIndexByPos:function(pos){var c,r,i;if(pos.top>434||pos.left+APP_WIDTH<=0||pos.left>880)return-1;if(pos.left-APP_INIT_LEFT<0)c=0;else c=Math.round((pos.left-APP_INIT_LEFT)/(APP_GAP_H+APP_WIDTH));if(pos.top-APP_INIT_TOP<0)r=0;else r=Math.round((pos.top-APP_INIT_TOP)/(APP_GAP_V+APP_HEIGHT));i=r*appNumPerRow+c;return i},adjustAppPosByIndex:function(id,index){var $folderCover=$(".folder-cover"),folderId=$folderCover.data("id"),data=AppMgr.getAppData(id),pos=getAppPosByIndexInFolder(index),$app=ImacScreen.getApp(id);if(Util.browsers.isIE8||Util.browsers.isIE9)$app.stop(true).animate(pos,200);else $app.css(pos);if(data.index!=index){data.index=index;AppMgr.cacheAppData(id,data)}},updateAppNum:function(appId,count){var $folderCover=$(".folder-cover"),$app=$folderCover.find('.app-item[data-id\x3d"'+appId+'"]'),$unread=$app.find(".unread");if(count)$unread.text(Util.parseNum(count)).removeClass("hidden");else $unread.addClass("hidden")},removeApp:function(appId,folderId){var $folderCover=$(".folder-cover"),$app=$folderCover.find('.app-item[data-id\x3d"'+appId+'"]');ImacScreen.addApp(appId,ImacScreen.getActivePage());FolderMgr.removeAppFromFolder(appId,folderId);AppDragMgr.destroy($app);$app.remove()},openFolder:function(id){var data=AppMgr.getAppData(id),$screen=ImacScreen.getScreen(activePage),html,appHtml=[];$.each(data.apps,function(i,item){var pos=getAppPosByIndexInFolder(i),view=$.extend({},item,pos);if(item.needMsgRemind)view.count=Util.parseNum(view.count);appHtml.push(M.render(appTempl,view))});html=M.render(FOLDER_TPL,$.extend({},data,{appHTML:appHtml.join("")}));$screensCon.append(html);AppDragMgr.enableFolderApps();this._currOpenFolderId=id;TabsNav.minAllTabs()},closeFolder:function(){if(!this._currOpenFolderId)return;var $folderCover=$(".folder-cover",$screensCon),folderId=$folderCover.data("id");$folderCover.remove();this._currOpenFolderId=null;ImacScreen.updateFolderApps(folderId);ImacScreen.updateFolderNum(folderId)},getAppsSort:function(folderId){var sort=[],folder=AppMgr.getAppData(folderId);$.each(folder.apps,function(i,item){sort.push(item.id)});return sort}}})(this,jQuery);(function(win,$){$(document).on("click",function(e){var $target=$(e.target);if($target.hasClass("folder-cover")||!$target.closest(".imac-screen").length&&!$target.closest(".folder-cover").length&&!$target.closest(".ep-context-menu").length)ImacFolder.closeFolder()}).on("click",".folder-name-text",function(e){var $this=$(this),oVal=$this.text(),$p=$this.parent(),$folderCover=$p.closest(".folder-cover"),folderId=$folderCover.data("id"),$input=$p.find(".folder-name-input");$input.val(oVal);$p.addClass("edit");$input.focus().off("blur keyup").on("blur",function(e){onSaveName()}).on("keyup",function(e){if(e.which===13)onSaveName()});function onSaveName(){var val=$input.val();if(!val){epoint.showTips("\u6587\u4ef6\u5939\u540d\u79f0\u4e0d\u80fd\u4e3a\u7a7a\uff01",{state:"error"});return}if(oVal!=val){$this.text(val);ImacScreen.updateFolderName(folderId,val)}$p.removeClass("edit")}})})(this,jQuery);(function(win,$){var $screensCon=$("#imac-screens-container");var screenAppDragStop=function(event,ui){var $el=$(this),id=$el.data("id"),data=AppMgr.getAppData(id),pos=ui.offset,$p=$el.parent(),$t=null,l=$p.find(".app-item").length,i=ImacScreen.getAppIndexByPos(pos);$el.addClass("trans").removeClass("app-drag-zindex");var posChanged=false,changedAppPosArr=[];if($target){addToFolder($target,$el);$target.removeClass("folding");$target=null}else if(i==-1||i==data.index)ImacScreen.adjustAppPosByIndex(id,data.index);else if(i+1>l){var $lastApp=$p.children(".app-item").last();$el.nextAll().each(function(ix,item){changedAppPosArr.push({id:item.getAttribute("data-id"),index:data.index+ix})});$el.insertAfter($lastApp);changedAppPosArr.push({id:id,index:l-1});posChanged=true}else{$t=ImacScreen.getAppByIndex(ImacScreen.getActivePage(),i);posChanged=true;changedAppPosArr.push({id:id,index:i});if(i<data.index){$el.insertBefore($t);$el.nextAll().each(function(ix,item){changedAppPosArr.push({id:item.getAttribute("data-id"),index:i+ix+1})})}else{$el.insertAfter($t);$el.prevAll().each(function(ix,item){changedAppPosArr.push({id:item.getAttribute("data-id"),index:i-1-ix})})}}$.each(changedAppPosArr,function(i,app){setTimeout(function(){ImacScreen.adjustAppPosByIndex(app.id,app.index)},20*i)});if(posChanged)Util.ajax({url:win.ImacDataActionUrl.updateAppPosUrl,data:{appId:id,screenId:ImacScreen._screenCache[ImacScreen.getActivePage()].id,sort:JSON.stringify(ImacScreen.getAppsSort(ImacScreen.getActivePage()))}})};var addToFolder=function($target,$app){var appId=$app.data("id"),data=AppMgr.getAppData(appId);if($target.hasClass("folder"))ImacScreen.addAppToFolder(appId,$target.data("id"));else{var targetId=$target.data("id"),targetData=AppMgr.getAppData(targetId);AppMgr.creatFolder(targetData,function(folder){ImacScreen.addAppToFolder(appId,folder.id)})}};var screenAppDragStart=function(){$(this).removeClass("trans").addClass("app-drag-zindex")};var $target;var screenAppDragging=function(event,ui){var pos=ui.position,oPos=ui.originalPosition,offset=ui.offset,tOffset,i,$t;if(ui.helper.hasClass("folder")||Math.abs(pos.left-oPos.left)<=APP_WIDTH/2&&Math.abs(pos.top-oPos.top)<=APP_HEIGHT/2){$target=null;return}$target&&$target.removeClass("folding");i=ImacScreen.getAppIndexByPos(pos);if(i>-1){$t=ImacScreen.getAppByIndex(ImacScreen.getActivePage(),i);if($t){tOffset=$t.offset();if(Math.abs(offset.left-tOffset.left)<=APP_WIDTH/2&&Math.abs(offset.top-tOffset.top)<=APP_HEIGHT/2)$t.addClass("folding");else $t=null}}$target=$t};var folderAppDragStop=function(event,ui){var $folderCover=$(".folder-cover"),folderId=$folderCover.data("id"),$el=$(this),id=$el.data("id"),data=AppMgr.getAppData(id),pos=ui.position,$p=$el.parent(),$t=null,l=$p.find(".app-item").length,i=ImacFolder.getAppIndexByPos(pos);$el.addClass("trans").removeClass("app-drag-zindex");var posChanged=false,changedAppPosArr=[];if(i==-1){ImacFolder.removeApp(id,folderId);return}if(i==data.index)ImacFolder.adjustAppPosByIndex(id,data.index);else if(i+1>l){var $lastApp=$p.children(".app-item").last();$el.nextAll().each(function(ix,item){changedAppPosArr.push({id:item.getAttribute("data-id"),index:data.index+ix})});$el.insertAfter($lastApp);changedAppPosArr.push({id:id,index:l-1});posChanged=true}else{$t=ImacFolder.getAppByIndex(i);posChanged=true;changedAppPosArr.push({id:id,index:i});if(i<data.index){$el.insertBefore($t);$el.nextAll().each(function(ix,item){changedAppPosArr.push({id:item.getAttribute("data-id"),index:i+ix+1})})}else{$el.insertAfter($t);$el.prevAll().each(function(ix,item){changedAppPosArr.push({id:item.getAttribute("data-id"),index:i-1-ix})})}}var adjustAppPos=function(){var app=changedAppPosArr.shift();if(app){ImacFolder.adjustAppPosByIndex(app.id,app.index);setTimeout(function(){adjustAppPos()},20)}else FolderMgr.adjustFolderApps(folderId)};adjustAppPos();if(posChanged)Util.ajax({url:win.ImacDataActionUrl.updateAppPosUrl,data:{appId:id,folderId:folderId,sort:JSON.stringify(ImacFolder.getAppsSort(folderId))}})};var screenAppDragConfig={containment:"parent",scroll:false,opacity:.5,distance:10,start:screenAppDragStart,drag:screenAppDragging,stop:screenAppDragStop};var folderAppDragConfig={containment:".folder-cover",scroll:false,opacity:.5,distance:10,start:screenAppDragStart,stop:folderAppDragStop};win.AppDragMgr={enableAllScreenApps:function(){$screensCon.find(".app-item").draggable(screenAppDragConfig)},enableFolderApps:function(){$(".folder-container").find(".app-item").draggable(folderAppDragConfig)},enableScreenApp:function(id){ImacScreen.getApp(id).draggable(screenAppDragConfig)},destroy:function($app){$app.draggable("destroy")}}})(this,jQuery);(function(win,$){var $widget=$("#imac-screen-pages"),widget_w=$widget.width();var adjustLeft=function(){var left=($("body").width()-widget_w)/2;$widget.css("left",left)};$(win).on("resize",adjustLeft);adjustLeft()})(this,jQuery);(function(win,$){var $taskBar=$("#imac-taskbar"),$tasksWrap=$(".tasks-wrap",$taskBar),$taskList=$(".task-list",$taskBar),$dropPanel=$("#task-drop"),$dropList=$(".drop-list",$dropPanel);var DROP_SHOW_BOTTOM=44,DROP_HIDE_BOTTOM=-280;var M=Mustache,taskTempl=$.trim(TASK_ITEM_TPL);var contextMenu=new EpContextMenu({items:[{text:"\u663e\u793a\u684c\u9762",click:function(){TabsNav.minAllTabs()}},"sep",{text:"\u5173\u95ed\u6b64\u4efb\u52a1",click:function(opt){var id=opt.id;TabsNav.removeTab(id)}},{text:"\u53ea\u663e\u793a\u6b64\u4efb\u52a1\u7a97\u53e3",click:function(opt){TabsNav.minAllTabs(opt.id)}},"sep",{text:"\u5173\u95ed\u5176\u4ed6\u4efb\u52a1",click:function(opt){var id=opt.id;TabsNav.removeAll(id)}},{text:"\u5173\u95ed\u6240\u6709\u4efb\u52a1",click:function(){TabsNav.removeAll()}},"sep",{text:"\u53d6\u6d88",role:"cancel"}]});var adjustTaskDialogSize=function(){var p,d;for(p in taskCache)if(taskCache.hasOwnProperty(p)){d=taskCache[p];if(!d.isHidden()&&d.isMax())d.maxWin()}};var taskCache={};var DROP_BTN_WIDTH=0,TASK_WIDTH=114,max_w=0;var adjustTaskBar=function(){max_w=$taskBar.width()-DROP_BTN_WIDTH;var tabs_w=TASK_WIDTH*$taskList.children().length;if(tabs_w>0)$taskList.css("width",tabs_w);if(tabs_w>max_w){$tasksWrap.css("width",max_w);var scrollRange=tabs_w-max_w;$taskList.stop(true).animate({marginLeft:-scrollRange},500)}else{$taskList.stop(true).animate({marginLeft:0},500);$tasksWrap.css("width","auto")}};win.TabsNav={_data:taskCache,addTab:function(data){if("stringnumber".indexOf(typeof data)!=-1){this.openTask(data);return}data.id=data.id||+new Date;data.icon=data.icon||"./images/app/8.png";if(!taskCache[data.id]){$(M.render(taskTempl,{id:data.id,name:data.name,icon:data.icon})).appendTo($taskList);$(M.render(DROP_ITEM_TPL,{id:data.id,name:data.name})).appendTo($dropList);adjustTaskBar()}TabsNav.openTask(data);TabsNav.activeTask(data.id)},openTask:function(id){var data,dialog=null,bs=Util.getBdSize();if(typeof id=="object"){data=id;id=data.id||+new Date}else data=AppMgr.getAppData(id);$dropPanel.removeClass("hidden");if(!taskCache[id]){data.widthRatio=data.widthRatio>1?1:data.widthRatio;data.heightRatio=data.heightRatio>1?1:data.heightRatio;dialog=(new EpDialog({id:id+"-epdialog",title:data.name,url:Util.getRightUrl(data.url),draggable:true,dragContainer:".imac-screen",resizable:true,resizeContainer:".imac-screen",width:(data.widthRatio||DIALOG_SIZE_RATIO[0])*bs.width,height:(data.heightRatio||DIALOG_SIZE_RATIO[1])*bs.height,btns:[{role:"min",title:"\u6700\u5c0f\u5316",click:function(){this.hide()}},{role:"maxwin",title:"\u6700\u5927\u5316"},{role:"refresh",title:"\u5237\u65b0"},{role:"close",title:"\u5173\u95ed",click:function(opt){TabsNav.removeTab(opt.id);return false}}]})).setOptions("id",id);data.isFullView=data.isFullView||data.widthRatio==1&&data.heightRatio==1;if(data.isFullView)dialog.show(0,false).maxWin();else dialog.show(0,true);taskCache[id]=dialog}else{dialog=taskCache[id];dialog.show(0,false)}},minAllTabs:function(id){var p,d;for(p in taskCache)if(taskCache.hasOwnProperty(p)){d=taskCache[p];if(p!=id)d.hide();else{d.show(0,0);TabsNav.activeTask(p)}}},addOrActiveTab:function(id){var isOn=taskCache[id],data=AppMgr.getAppData(id);if(!isOn){$(M.render(taskTempl,{id:data.id,name:data.name,icon:data.icon})).appendTo($taskList);$(M.render(DROP_ITEM_TPL,{id:data.id,name:data.name})).appendTo($dropList);adjustTaskBar()}TabsNav.openTask(id);TabsNav.activeTask(id)},makeTabVisiable:function(id){var $task=TabsNav.getTab(id),$prevAll=$task.prevAll(),prev_w=$prevAll.length*TASK_WIDTH,mL=Math.abs(Util.toInt($taskList.css("margin-left"))),wrap_w=$tasksWrap.width(),dis=0;if(prev_w<mL)dis=prev_w;else if(prev_w+TASK_WIDTH-wrap_w>mL)dis=prev_w+TASK_WIDTH-wrap_w;if(!dis)return;$taskList.stop(true).animate({marginLeft:-dis},300)},getTab:function(id){return $taskList.find("#"+id+"-task")},removeTab:function(id){var $task=TabsNav.getTab(id);if(!$task.length)return;$task.remove();$dropList.find("#"+id+"-drop").remove();if(!$dropList.children().length)$dropPanel.addClass("hidden");taskCache[id].hide().destroy();taskCache[id]=null;delete taskCache[id];adjustTaskBar()},_removeOthers:function(stayId){var $tasks=$taskList.find(".task-item");if(!$tasks.length)return;$tasks.each(function(i,el){var $el=$(el),id=$el.data("id");if(stayId!=id)TabsNav.removeTab(id)})},removeAll:function(exceptId){exceptId?this._removeOthers(exceptId):this._removeAll()},_removeAll:function(){var $tasks=$taskList.find(".task-item");if(!$tasks.length)return;$tasks.each(function(i,el){var $el=$(el),id=$el.data("id");$el.remove();taskCache[id].hide().destroy();taskCache[id]=null;delete taskCache[id]});$dropPanel.addClass("hidden");$dropList.children().each(function(i,el){$(el).remove()});adjustTaskBar()},activeTask:function(id){var $task=TabsNav.getTab(id);if(!$task.hasClass("active"))$task.addClass("active").siblings().removeClass("active");this.adjustTabPosOnActive(id);ImacBoard.hide()},adjustTabPosOnActive:function(id){var $el=$taskList.find("#"+id+"-task");$prevs=$el.prevAll(),prev_w=TASK_WIDTH*$prevs.length,scroll_w=Math.ceil(Math.abs(parseFloat($taskList.css("margin-left"),10))),aimMarginLeft=scroll_w;if(prev_w<scroll_w)aimMarginLeft=prev_w;else if(prev_w>=max_w+scroll_w)aimMarginLeft=prev_w+TASK_WIDTH-max_w;else if(prev_w>scroll_w&&prev_w<max_w+scroll_w&&prev_w+TASK_WIDTH>max_w+scroll_w)aimMarginLeft=prev_w+TASK_WIDTH-max_w;$taskList.stop(true).animate({marginLeft:-aimMarginLeft},500)},refreshTabContent:function(id){var dialog=taskCache[id];dialog&&dialog.refresh&&dialog.refresh()}};$("body").on("click",".epdialog-hd",function(e){e.preventDefault();e.stopPropagation();if(!/^epdialog-hd(?!-btn)/.test(e.target.className))return;var dialogId=$(this).parent(".epdialog")[0].id;var appId=dialogId.replace(/(.+)-epdialog$/,"$1");if(appId)TabsNav.addOrActiveTab(appId)});var timer;$(win).on("resize",function(){clearTimeout(timer);timer=setTimeout(function(){adjustTaskBar();adjustTaskDialogSize()},100)});$taskBar.on("click",".task-item",function(){var $el=$(this),id=$el.data("id"),d=taskCache[id];if(!$el.hasClass("active")){$el.addClass("active").siblings().removeClass("active");d.show(0,0)}else d.toggle();TabsNav.activeTask(id)}).on("contextmenu",".task-item",function(event){var id=$(this).data("id");contextMenu.setOptions("id",id).show({x:event.pageX,y:event.pageY});return false});var toggleDrop=function(hide){var aim_bottom;if(hide)$dropPanel.addClass("show");else $taskBar.addClass("drop-zindex");if($dropPanel.hasClass("show"))aim_bottom=DROP_HIDE_BOTTOM;else aim_bottom=DROP_SHOW_BOTTOM;$dropList.stop(true).animate({bottom:aim_bottom},function(){$taskBar.removeClass("drop-zindex")});$dropPanel.toggleClass("show")};Util.doNiceScroll($dropList,{cursorwidth:"2px",cursorcolor:"#3b4252",cursorborder:"1px solid #aaa"});$dropPanel.on("click",".drop-btn",function(e){e.stopPropagation();if(!$dropList.children().length)return;toggleDrop()}).on("click",".drop-item",function(e){e.stopPropagation();var id=this.getAttribute("data-id");TabsNav.addTab(id);TabsNav.activeTask(id);toggleDrop()});$("body").on("click",function(e){if(!$(e.target).closest(".drop-panel").length)if($dropPanel.hasClass("show"))toggleDrop(true)});adjustTaskBar()})(this,jQuery);(function(win,$){var $msgSound=$("#msg-sound");var SOUND_URL="../../msgsound/sound.html",ROLLER_TEXT="\u60a8\u6709\u65b0\u6d88\u606f\u63d0\u9192\uff0c\u8bf7\u70b9\u51fb\u67e5\u770b\uff01";var playNewMsgSound=function($msgSoundContainer,soundIframeUrl,soundFileUrl){if(Util.getFrameSysParam("messageSound")===false)return Util.noop;soundIframeUrl=Util.getRightUrl(soundIframeUrl);if(Util.browsers.isIE){var $soundIframe=$('\x3ciframe src\x3d"" frameborder\x3d"0" class\x3d"hidden"\x3e\x3c/iframe\x3e').appendTo($msgSoundContainer);return function(){$soundIframe[0].src=soundIframeUrl+"?_\x3d"+ +new Date}}var msgAudio=document.createElement("audio");msgAudio.src=Util.getRightUrl(soundFileUrl);msgAudio.className="hidden-accessible";$msgSoundContainer.append(msgAudio);var newMsgAudioTimer=null;return function doPlayNewMsgAudio(retryLimit){if(retryLimit===undefined)retryLimit=100;msgAudio.play()["catch"](function(){clearTimeout(newMsgAudioTimer);if(retryLimit>0)newMsgAudioTimer=setTimeout(function(){doPlayNewMsgAudio(--retryLimit)},50)})}}($msgSound,SOUND_URL,"../../msgsound/newsms.wav");var $rightBar=$("#imac-right-bar"),$infoIcon=$(".message",$rightBar),$msgNum=$(".msg-num",$infoIcon),$emsgIcon=$(".emsg",$rightBar),$eMsgNum=$(".msg-num",$emsgIcon);var title,rollerTip=ROLLER_TEXT,timer=0;var restoreDocTitle=function(){title=win.systemTitle||document.title;clearTimeout(timer);document.title=title;rollerTip=ROLLER_TEXT};var rollMsgTip=function(){document.title=rollerTip;clearTimeout(timer);timer=setTimeout(function roll(){document.title=rollerTip.substring(1,rollerTip.length)+rollerTip.substring(0,1);rollerTip=document.title;timer=setTimeout(roll,300)},300)};var docTitle={roll:rollMsgTip,stop:restoreDocTitle};var nNum=0,oNum=0,hasNew,hasMessage;var checkMsg=function(){hasNew=false;hasMessage=false;Util.ajax({url:win.ImacDataActionUrl.msgCountUrl,data:{haseXun:true,needNum:true},success:function(data){if(data.remind){nNum=parseInt(data.remind)||0;oNum=$msgNum.data("num")||0;if(nNum>oNum)hasNew=true;else if(nNum)hasMessage=true;$msgNum.text(Util.parseNum(nNum)).data("num",nNum).removeClass("hidden")}else $msgNum.text("").data("num",0).addClass("hidden");if(data.eXun){nNum=parseInt(data.eXun)||0;oNum=parseInt($eMsgNum.data("num"),10)||0;if(nNum>oNum)hasNew=true;$eMsgNum.removeClass("hidden").text(Util.parseNum(nNum)).data("num",nNum)}else $eMsgNum.text("").addClass("hidden");if(hasNew){playNewMsgSound(100);docTitle.roll()}else if(!hasMessage)docTitle.stop()}})};checkMsg();win.updateMsgRemindNum=checkMsg;setInterval(checkMsg,60*1E3)})(this,jQuery);(function(win,$){$.each(win.quickApps,function(i,data){data=Util.fixPath(data);data.hasTaskbarIcon=true;AppMgr.cacheAppData(data.id,data)});$("body").on("click",".default-app-btn",function(event){event.preventDefault();var id=$(this).data("id");if(!id)return;AppMgr.openApp(id)})})(this,jQuery);(function(win,$){var $userInfo=$("#top-user");var loadImg=function(url,el){if(!url)return;url=Util.getRightUrl(url);var img=new Image;img.onload=function(){img.onload=null;el.src=url};img.onerror=function(){img.onerror=null;console.error(url+"\u5bf9\u5e94\u7684\u56fe\u7247\u8d44\u6e90\u65e0\u6cd5\u52a0\u8f7d\uff01")};img.src=url};var getUserInfo=function(){return Util.ajax({url:win.ImacDataActionUrl.userInfoUrl}).done(function(data){$userInfo.find(".user-name").text(data.name+"\uff0c\u60a8\u597d\uff01");$userInfo.find(".user-ou").text(data.ouName);data.portrait&&loadImg(function(url){url=/^data:image/.test(url)?url:Util.getRightUrl("rest/"+url);return url}(data.portrait),$userInfo.find(".user-img")[0]);win._userName_=data.name;win._userGuid_=data.ouName;ImacEvent.fire("afterUserInfo",data)})};getUserInfo();var getPageInfo=function(){return Util.ajax({url:ImacDataActionUrl.pageInfoUrl}).done(function(data){loadImg(Util.getRightUrl(data.logo||win.DEFAULT_LOGO_URL),$(".sys-logo")[0]);if(data.title){document.title=data.title;win.systemTitle=data.title}win._fullSearchUrl_=data.fullSearchUrl;ImacEvent.fire("afterPageInfo",data)})};getPageInfo()})(this,jQuery);var eMsgSocket;window.OpenEMsg=function(sessionid,uid,type){if(window.eMsg)if(typeof uid==="undefined")eMsg.open(sessionid);else eMsg.openSession(sessionid,uid,type);else creatWebSocket(_userGuid_,_userName_,function(){eWebSocket.openEmsg(sessionid,uid,type)})};(function(win,$){var $emsgIcon=$(".q-btn.emsg"),$eMsgNum=$(".msg-num",$emsgIcon),$msgEMsg=$("#msgEMsg"),$msgEMsgContent=$(".msg-panel-content",$msgEMsg),$msgEMsgRecent=$(".emsg-recent-list",$msgEMsgContent),$onlineUserNum=$(".online-user-num",$msgEMsg),onlineUserIframe=document.getElementById("online-user");var emsgList;var decreaseEmsgCount=function(sessionid){var cnt=$eMsgNum.text();if(cnt)cnt=parseInt(cnt,10)-1;if(cnt==0){cnt="";$eMsgNum.data("num",0).addClass("hidden")}$eMsgNum.text(cnt)};function initEMsgList(){emsgList=new EMsgList({content:$msgEMsgRecent,getUrl:EmsgConfig.baseUrl,ignoreUrl:EmsgConfig.baseUrl,userImg:EmsgConfig.userImg,groupImg:EmsgConfig.groupImg,afterOpenEMsg:function(){hidePanel()},onDecEmsgCount:function(sessionid){decreaseEmsgCount(sessionid)}});win.RefreshEMsg=$.proxy(emsgList.getData,emsgList)}if(!win.EMsgList)Util.loadJs("frame/fui/js/widgets/emsglist/emsglist.js",function(){initEMsgList()});else initEMsgList();if(win.OnlineUserSettings&&win.OnlineUserSettings.show){$msgEMsg.find(".msg-panel-head").addClass("tab").find(".panel-hd-tab.hidden").removeClass("hidden");onlineUserIframe.src=OnlineUserSettings.url;$msgEMsg.on("click",".panel-hd-tab",function(){var $this=$(this),ref=$this.data("ref"),hasShow=$this.data("hasShow"),$content=$msgEMsgRecent;if(!$this.hasClass("active")){$this.addClass("active").siblings().removeClass("active");if(ref){$content=$("#"+ref,$msgEMsgContent);if(!hasShow)setTimeout(function(){OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count)});$this.data("hasShow",true)},500)}$content.removeClass("hidden").siblings().addClass("hidden")}})}$emsgIcon.on("click",function(){if($emsgIcon.hasClass("active"))hidePanel();else{emsgList.getData();if(win.OnlineUserSettings&&win.OnlineUserSettings.show)OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count)});showPanel()}});$msgEMsg.on("click",".msg-panel-hide",function(){hidePanel()});$("body").on("click",function(e){var $target=$(e.target);if(!$target.closest(".q-btn.emsg, #msgEMsg").length)hidePanel()});function hidePanel(){$msgEMsg.stop(true).animate({right:-350},function(){$msgEMsg.addClass("hidden")});$emsgIcon.removeClass("active")}function showPanel(){$msgEMsg.removeClass("hidden");$msgEMsg.stop(true).animate({right:60});$emsgIcon.addClass("active")}})(this,jQuery);(function(win,$){var $themeBtn=$("#theme-switch");var themeSelection;var themeSelectionUrl="frame/fui/js/widgets/themeselection/themeselection.js";var loadThemeSelection=function(){loadThemeSelection=Util.noop;return Util.loadJs(themeSelectionUrl,function(){ThemeSelection._styleLoaded=true;themeSelection=new ThemeSelection({getPagesUrl:ImacDataActionUrl.getPagesUrl,savePageUrl:ImacDataActionUrl.savePageUrl,hideCallback:function(){$themeBtn.removeClass("active")}});win.themeSelection=themeSelection;themeSelection.show();$themeBtn.addClass("active");$("body").on("click",function(e){var $target=$(e.target);if(!$target.closest(".theme-selection-container, #theme-switch").length){$themeBtn.removeClass("active");themeSelection.hide()}})})};function initThemeSkin(){$themeBtn.on("click",function(){if(!themeSelection)return loadThemeSelection();if($themeBtn.hasClass("active")){$themeBtn.removeClass("active");themeSelection.hide()}else{themeSelection.show();$themeBtn.addClass("active")}})}initThemeSkin()})(this,jQuery);(function(win,$){var $right=$("#imac-right-bar"),$searchBox=$("#search-board"),$searchInput=$(".a-search-input",$searchBox),$allAppsBox=$("#all-apps",$searchBox),$noResult=$(".no-result",$allAppsBox),$searchKey=$("#search-key",$noResult),$allAppsTab=$(".tab-item",$searchBox).eq(0),$historyAppsBox=$("#search-history",$searchBox);var initTabView=function(){new TabView({dom:"#panel-tab-view",activeCls:"active"});Util.doNiceScroll($searchBox.find(".tabview-bd"),{cursorwidth:"4px",cursorcolor:"#bebdbd",cursorborder:"1px solid #bebdbd"})};var renderAllApps=function(){var data=AppMgr._data,appId,html=[];for(appId in data)if(data.hasOwnProperty(appId))html.push(renderApp(appId));$(html.join("")).appendTo($allAppsBox)};var renderHistoryApps=function(){var ids=Util.localMemory.SearchHistory.get(),html=[];$.each(ids,function(i,id){html.push(renderApp(id))});$(html.join("")).appendTo($historyAppsBox)};var renderApp=function(appId){var data=AppMgr.getAppData(appId);if(!data)return"";return Mustache.render(SEARCH_APPS_TPL,data)};win.SearchPanel={isInit:false,init:function(){renderHistoryApps();renderAllApps();initTabView();Util.doPlaceHolder($searchInput);this.isInit=true},_show:function(){$searchBox.removeClass("hidden");$searchInput[0].value="";search();TabsNav.minAllTabs();ImacBoard.hide()},show:function(){if(!this.isInit)this.init();this._show();this.show=this._show},hide:function(){$searchBox.addClass("hidden")},addAimedApp:function(appId){if(Util.localMemory.SearchHistory.add(appId))$(renderApp(appId)).prependTo($historyAppsBox);else $historyAppsBox.find('[data-id\x3d"'+appId+'"]').prependTo($historyAppsBox)},removeApp:function(appId){$allAppsBox.add($historyAppsBox).find("#"+appId+"-search").remove()}};$searchBox.on("click",".close-btn",function(){SearchPanel.hide()});$right.on("click",".right-search-btn",function(){SearchPanel.show()});$searchBox.on("click",".app-item",function(){var id=$(this).data("id");AppMgr.openApp(id);SearchPanel.hide();SearchPanel.addAimedApp(id)});var reset=function(){$allAppsBox.find(".app-name").each(function(i,appName){appName.innerHTML=appName.innerText});$noResult.addClass("hidden")};var search=function(){if(!$allAppsTab.hasClass("active"))$allAppsTab.trigger("click");var key=$.trim($searchInput[0].value),$app,$appName,hasResult=false;reset();if(!key){$allAppsBox.find(".app-item").removeClass("hidden");return}else{$allAppsBox.find(".app-item").addClass("hidden");var appId,data=AppMgr._data;for(appId in data)if(data.hasOwnProperty(appId))if(data[appId].name.indexOf(key)!==-1){$app=$allAppsBox.find("#"+appId+"-search");$appName=$app.find(".app-name");$appName.html($appName.html().replace(key,"\x3cb\x3e"+key+"\x3c/b\x3e"));$app.removeClass("hidden");hasResult=true}}if(!hasResult){$searchKey.text(key);$noResult.removeClass("hidden")}};var searchTimer;if(Util.browsers.isIE8||Util.browsers.isIE9)$searchInput.on("onkeypress",function(){clearTimeout(searchTimer);searchTimer=setTimeout(search,200)});else $searchInput.on("input",function(){clearTimeout(searchTimer);searchTimer=setTimeout(search,200)});$searchInput.on("onkeypress",function(e){if(e.which===13)search()})})(this,jQuery);(function(win,$){var defaultSettings={activeIndex:0,dom:null,triggerEvent:"click",activeCls:"",overDelay:300};win.TabView=function(opts){this.cfg=$.extend({},defaultSettings,opts);this._initView();this._initEvent()};$.extend(TabView.prototype,{_initView:function(){var c=this.cfg;var $widget=$(c.dom),$widgetHd=$widget.find('\x3e [data-role\x3d"head"]'),$widgetBd=$widget.find('\x3e [data-role\x3d"body"]'),$tabs=$widgetHd.find('[data-role\x3d"tab"]'),$tabCons=$widgetBd.find('\x3e [data-role\x3d"tab-content"]');$.extend(this,{$widgetHd:$widgetHd,$tabs:$tabs,$tabCons:$tabCons});this.activeTabByIndex(c.activeIndex)},_initEvent:function(){var c=this.cfg,triggerEvent=c.triggerEvent,$widgetHd=this.$widgetHd,self=this;var overTimer=0;if(triggerEvent=="click")$widgetHd.on("click",'[data-role\x3d"tab"]',function(event){event.preventDefault();$.proxy(self._activeTab,self,$(this))()});else if(triggerEvent=="mouseover")$widgetHd.on("mouseover",'[data-role\x3d"tab"]',function(){overTimer&&clearTimeout(overTimer);overTimer=setTimeout($.proxy(self._activeTab,self,$(this)),c.overDelay)}).on("mouseout",'[data-role\x3d"tab"]',function(){overTimer&&clearTimeout(overTimer)})},_activeTab:function($tab){var c=this.cfg,activeCls=c.activeCls;var $tabs=this.$tabs;var targetId=$tab.data("target");$tabs.removeClass(activeCls);$tab.addClass(activeCls);this._activeTabContent(targetId)},activeTabByIndex:function(index){var c=this.cfg,activeCls=c.activeCls;var $tabs=this.$tabs,$activeTab=null,targetId="";if(index>=0&&index<$tabs.length){$activeTab=$tabs.removeClass(activeCls).eq(index).addClass(activeCls);targetId=$activeTab.data("target");this._activeTabContent(targetId)}},_activeTabContent:function(targetId){var $tabCons=this.$tabCons;$tabCons.addClass("hidden").filter('[data-id\x3d"'+targetId+'"]').removeClass("hidden")}})})(this,jQuery);(function(win,$){Util.doPlaceHolder($("[placeholder]"))})(this,jQuery);(function(win,$){var $container=$("body");var appElCache={};var resolveDtd=function(){var dtd=$.Deferred();dtd.resolve();return dtd.promise()}();var getAppMsgCount=function(){var ids=$.unique(AppMgr.msgRemindApps);if(!ids)return resolveDtd;var appIds=JSON.stringify(ids);return Util.ajax({url:ImacDataActionUrl.updateAppMsgCountUrl,data:{appIds:appIds}}).done(function(data){if(!data)return;$.each(data,function(id,count){count=parseInt(count,10)||0;var app=AppMgr.getAppData(id);AppMgr.cacheAppData(id,$.extend(app,{count:count}));if(app.folderId)FolderMgr.adjustFolderApps(app.folderId,app.id);else{var $appCount=appElCache[id]?appElCache[id]:appElCache[id]=$container.find('[data-id\x3d"'+id+'"]').find(".unread");if(count){count=Util.parseNum(count);$appCount.text(count).removeClass("hidden")}else $appCount.addClass("hidden")}});ImacScreen.updateFolderNum()})};function startUpdateAppMsgCount(){getAppMsgCount().always(function(){setTimeout(startUpdateAppMsgCount,30*1E3)})}ImacEvent.on("afterAllAppsLoad",startUpdateAppMsgCount)})(this,jQuery);(function(win,$){$("body").on("click",".q-btn.logout",function(){win.logout&&logout()})})(this,jQuery);(function(win,$){var $headerSearch=$("#header-search-container");function doSearch(type,kw){type=type||"all";TabsNav.addTab({id:"fullsearch",name:"\u5168\u6587\u68c0\u7d22",url:win._fullSearchUrl_+"?wd\x3d"+win.encodeURI(kw)+"\x26type\x3d"+type})}function getCateData(){return Util.ajax({url:win._searchCfg.fullSearchCateUrl}).done(function(data){initTopFullSearch(data.categories)})}function initTopFullSearch(cateData){cateData=cateData||[];if(typeof cateData=="string")cateData=JSON.parse(cateData);var cates=[];$.each(cateData,function(i,item){cates.push({id:item.guid,name:item.name,iconCls:item.icon||"view"})});if(!cates.length)cates.push({id:"all",name:"\u5168\u6587\u68c0\u7d22",iconCls:"modicon-25"});ClassifySearch._styleLoaded=true;ClassifySearch.CLASSIFICATION_TPL='\x3cdiv class\x3d"classify-search-classify-item {{#isActive}}active{{/isActive}}" data-id\x3d"{{id}}" data-title-tpl\x3d"\u4e0e${keyword}\u76f8\u5173\u7684{{name}}"\x3e\x3cspan class\x3d"classify-search-classify-icon {{iconCls}}"\x3e\x3c/span\x3e\u4e0e\x3cspan class\x3d"classify-search-classify-kw"\x3e\x3c/span\x3e\u76f8\u5173\u7684{{name}}\x3cspan class\x3d"classify-search-classify-target hidden"\x3e{{target}}\x3c/span\x3e\x3c/div\x3e';var classifySearch=new ClassifySearch({id:"header-search-container",searchTarget:"\u5185\u5bb9",category:cates,placeholder:"\u8bf7\u8f93\u5165",maxShowCharacter:3,enter:function(id,key){doSearch(id,key)}});dealUserAppSearch(classifySearch);classifySearch.$input.on("focus",function(){TabsNav.minAllTabs()})}function dealUserAppSearch(classifySearch){var $userItem=classifySearch.$classifyList.find('[data-id\x3d"user"]'),$appItem=classifySearch.$classifyList.find('[data-id\x3d"app"]');if(!$userItem.length||!$appItem.length)return;var $userList=$('\x3cul class\x3d"fulltext-search-user-list"\x3e\x3c/ul\x3e'),$appList=$('\x3cul class\x3d"fulltext-search-app-list"\x3e\x3c/ul\x3e');if($userItem.length){$userList.insertAfter($userItem);$userList.on("click",".fulltext-search-user-item",function(){_searchCfg.userClick&&_searchCfg.userClick(this.getAttribute("data-id"),this.title);classifySearch.$input.blur().val("");classifySearch.hidePopup()})}if($appItem.length){$appList.insertAfter($appItem);$appList.on("click",".fulltext-search-app-item",function(){var $this=$(this);$this.data("url")&&dealLinkOpen({id:$this.data("id"),name:this.title,url:$this.data("url"),openType:$this.data("opentype")});classifySearch.$input.blur().val("");classifySearch.hidePopup()})}var timer;var ignoreCodes=[13,16,17,18,27,37,38,39,40];var isSupportInput=function(){var input=document.createElement("input");return"oninput"in input}();if(isSupportInput)classifySearch.$input.on("input",function(){clearTimeout(timer);timer=setTimeout(immediatelySearch,50)});else classifySearch.$input.on("keyup",function(ev){if($.inArray(ev.which,ignoreCodes)!=-1)return;clearTimeout(timer);timer=setTimeout(immediatelySearch,50)});classifySearch.$input.on("setHistoryValue",immediatelySearch);var lastRequest;var USER_ITEM_TPL='\x3cli class\x3d"fulltext-search-user-item" data-id\x3d"{{guid}}" title\x3d"{{name}}" \x3e\x3cimg class\x3d"fulltext-search-user-item-img" src\x3d"{{portrait}}" \x3e{{{hlname}}}\x3c/li\x3e';var APP_ITEM_TPL='\x3cli class\x3d"fulltext-search-app-item" data-id\x3d"{{code}}" title\x3d"{{name}}" data-opentype\x3d"{{openType}}" data-url\x3d"{{url}}"\x3e\x3cimg class\x3d"fulltext-search-app-item-icon" src\x3d"{{icon}}"/\x3e{{{hlname}}}\x3c/li\x3e';function immediatelySearch(){var value=$.trim(classifySearch.$input.val());if(lastRequest)lastRequest.abort();if(!value)return;lastRequest=Util.ajax({url:epoint.dealRestfulUrl(_searchCfg.userModuleSearchUrl),data:{cnum:"user,app",key:value,rn:3,location:"search"}});lastRequest.done(function(res){var data=mini.decode(res.frameinfo);var userHTML=[],appsHTML=[],hlReg=new RegExp(value,"ig");data.users&&$.each(data.users,function(i,item){item.portrait=Util.getRightUrl(item.portrait);item.hlname=item.name.replace(hlReg,'\x3cspan class\x3d"fulltext-search-kw"\x3e'+value+"\x3c/span\x3e");userHTML.push(Mustache.render(USER_ITEM_TPL,item))});data.apps&&$.each(data.apps,function(i,item){item.icon=Util.getRightUrl(item.icon);item.hlname=item.name.replace(hlReg,'\x3cspan class\x3d"fulltext-search-kw" \x3e'+value+"\x3c/span\x3e");appsHTML.push(Mustache.render(APP_ITEM_TPL,item))});$(userHTML.join("")).appendTo($userList.empty());$(appsHTML.join("")).appendTo($appList.empty())})}}ImacEvent.on("afterPageInfo",function(){if(win._fullSearchUrl_)getCateData()})})(this,jQuery);(function(win,$){var PORTAL_ITEM_TPL='\x3cli class\x3d"portal-item" data-id\x3d"{{code}}" data-url\x3d"{{url}}" data-opentype\x3d"{{openType}}" title\x3d"{{name}}"\x3e\x3cspan class\x3d"portal-icon {{icon}}"\x3e\x3c/span\x3e\x3cspan class\x3d"portal-name"\x3e{{name}}\x3c/span\x3e\x3c/li\x3e';var $portalBtn=$("#portal-btn"),$portalWrap=$("#portal-wrap"),$portalContent=$("#portal-content"),$portal=$portalBtn.add($portalWrap),$boardPanel=$("#board-panel");function initPortal(homes,defaultHome){if(!homes){console.error("\u672a\u83b7\u53d6\u5230\u95e8\u6237\u6570\u636e");$portalBtn.addClass("hidden");return}var home={closeIcon:false,refresh:true};var singleHomes=[];for(var i=0;i<homes.length;i++){var cate=homes[i];var finded=false;if(cate.items!=undefined)!finded&&$.each(cate.items,function(j,item){if(defaultHome){if(item.code==defaultHome){home.id=item.code||"home";home.url=item.url;home.name=item.name;finded=true;return false}}else if(item.openType=="tabsnav"){home.id=item.code||"home";home.url=item.url;home.name=item.name;finded=true;return false}});else{if(!finded)if(defaultHome){if(cate.code==defaultHome){home.id=cate.code||"home";home.url=cate.url;home.name=cate.name;finded=true}}else if(cate.openType=="tabsnav"){home.id=cate.code||"home";home.url=cate.url;home.name=cate.name;finded=true}singleHomes=singleHomes.concat(homes.splice(i,1));i--}}initView(singleHomes,homes);initEvent(home)}function initEvent(defaultHome){var $cover=$("");$portalBtn.on("click",function(){togglePortal(!$portal.hasClass("active"))});$portalWrap.on("click",".portal-header",function(){TabsNav.addTab(defaultHome)}).on("click",".portal-item",function(){var $this=$(this),openType=$this.data("opentype"),url=Util.getRightUrl($this.data("url"));openType=="blank"?win.open(url):ImacBoard.show($(this).data("id"));togglePortal(false)}).on("click",".portal-cate",function(){var $block=$(this).parent();$block.toggleClass("collapse")});$boardPanel.on("click",".board-close",function(){ImacBoard.hide()});function togglePortal(show){if(show){$portal.addClass("active");$cover.removeClass("hidden");TabsNav.minAllTabs();ImacBoard.hide();return}$portal.removeClass("active");$cover.addClass("hidden")}$("body").on("click",function(ev){if(!$(ev.target).closest($portal).length)togglePortal(false)});var timer,$portalPanel=$portal.find(".portal");$(win).on("resize",function(){clearTimeout(timer);timer=setTimeout(function(){var h=$(win).height()-140;h>0&&$portalPanel.css("max-height",h)},17)}).trigger("resize")}function initView(singleHomes,homes){var html=[];if(singleHomes){html.push('\x3cul class\x3d"portal-list"\x3e');$.each(singleHomes,function(i,item){item.icon=item.icon||"default-modicon";item.url=Util.getRightUrl(item.url);html.push(Mustache.render(PORTAL_ITEM_TPL,item));ImacBoard.data[item.code]=item});html.push("\x3c/ul\x3e")}$.each(homes,function(i,cate){html.push('\x3cdiv class\x3d"portal-block"\x3e\x3ch3 class\x3d"portal-cate"\x3e'+cate.name+'\x3cspan class\x3d"portal-cate-trigger"\x3e\x3c/span\x3e\x3c/h3\x3e\x3cul class\x3d"portal-list" style\x3d"max-height:'+30*cate.items.length+'px"\x3e');$.each(cate.items,function(j,item){item.icon=item.icon||"default-modicon";item.url=Util.getRightUrl(item.url);html.push(Mustache.render(PORTAL_ITEM_TPL,item));ImacBoard.data[item.code]=item});html.push("\x3c/ul\x3e\x3c/div\x3e")});$(html.join("")).appendTo($portalContent)}win.ImacBoard={data:{},cache:{},show:function(id){var $target;if(!this.cache[id])$target=this.cache[id]=renderBoardIframe(id);else $target=this.cache[id];TabsNav.minAllTabs();$boardPanel.removeClass("hidden");$target.removeClass("hidden").siblings(".board-content").addClass("hidden")},hide:function(){$boardPanel.addClass("hidden")}};var renderBoardIframe=function(id){return $(Mustache.render(BOARD_CONTENT_TPL,ImacBoard.data[id])).appendTo($boardPanel)};ImacEvent.on("afterPageInfo",function(ev){initPortal(ev.data.homes,ev.data.defaultHome)})})(this,jQuery);(function(win,$){var msgCenterUrl="frame/fui/js/widgets/msgcenter/msgcenter.js";function initMsgCenter(data){var msgcenterConfig=$.extend({},MsgCenterConfig,{isMsgCenterMaxSize:data.isMsgCenterMaxSize||false,msgCenterOrder:data.msgCenterOrder||"asc",hideCallback:function(){}});var msgCenter=null;var $msgRemindBtn=$(".q-btn.message");var loadMsgCenter=function(){loadMsgCenter=Util.noop;return Util.loadJs(msgCenterUrl,function(){msgCenter=new MsgCenter(msgcenterConfig);msgCenter.show()})};$msgRemindBtn.on("click",function(){if(!msgCenter)return loadMsgCenter();if(!msgCenter.isShow)msgCenter.show();else msgCenter.hide()})}ImacEvent.on("afterUserInfo",function(ev){var data=ev.data;initMsgCenter(data)})})(this,jQuery);(function(win,$){var $quickApps=$("#imac-right-bar .quick-apps"),$list=$(".list-wrap",$quickApps),$cfgBtn=$(".quick-cfg-btn",$quickApps);var dockAppTempl=$.trim(DOCK_APP_TPL);var PREV_HEIGHT=0,NEXT_HEIGHT=0,TOP_BAR_HEIGHT=50,CFG_BTN_HEIGHT=50,wrap_h=0;Util.doNiceScroll($list,{cursorwidth:"2px",cursorcolor:"#3b4252",cursorborder:"1px solid #aaa",horizrailenabled:false});var adjustListHeight=function(){PREV_HEIGHT=$quickApps.position().top;NEXT_HEIGHT=$quickApps.next().outerHeight();var bd_h=$("body").height();wrap_h=bd_h-(TOP_BAR_HEIGHT+PREV_HEIGHT+NEXT_HEIGHT);$quickApps.css("height",wrap_h);$list.css("max-height",wrap_h-CFG_BTN_HEIGHT)};$(win).on("resize",Util.debounce(adjustListHeight,50));win.QuickApps={isInit:false,init:function(){if(QuickApps.isInit)return;adjustListHeight();QuickApps._init()},_init:function(){return this.getData().done(function(data){QuickApps._initView(data)._initEvent()})},update:function(){return this._init()},removeApp:function(id){var $app=$list.find('[data-id\x3d"'+id+'"]');if($app.length)$app.remove()},getData:function(){return Util.ajax({url:ImacDataActionUrl.getQuickAppsUrl})},_initView:function(data){if(!data||!data.length)return this;var html=[];$.each(data,function(i,item){item=Util.fixPath(item);item.sname=Util.getAppShortName(item.name);if(!item.id)item.id=item.code;if(!AppMgr.getAppData(item.id))AppMgr.cacheAppData(item.id,item);html.push(Mustache.render(dockAppTempl,item))});$(html.join("")).appendTo($list.empty());$cfgBtn.removeClass("hidden");return this},_initEvent:function(){!this.isInit&&$quickApps.on("click",".dock-app",function(){var id=$(this).data("id");AppMgr.openApp(id)});return this}};ImacEvent.on("afterAllAppsLoad",QuickApps.init);var cfgUrl=ImacDataActionUrl.commonAppCfgUrl;var themeId=function(){var themeMatch=location.href.match(/^https?:\/\/.*\/fui\/pages\/themes\/(\w+)\/\1/i),themeId=themeMatch&&themeMatch[1];return themeId}();var pageId=Util.getUrlParams("pageId")||themeId;cfgUrl=Util.addUrlParams(cfgUrl,{themeId:themeId,pageId:pageId});var isCfgOpened=false;$cfgBtn.on("click",function(){if(isCfgOpened)return;isCfgOpened=true;var opt={width:920,height:500};var win_size=Util.getWinSize();if(win_size.height<opt.height)opt.height=win_size.height;else opt.height=win_size.height*.6>>0;if(win_size.width<opt.width)opt.width=win_size.width;epoint.openDialog("\u5e38\u7528\u5e94\u7528\u914d\u7f6e",cfgUrl,function(isChanged){if(isChanged===true)QuickApps.update();isCfgOpened=false},opt)})})(this,jQuery);(function(win,$){var appCenterUrl="frame/fui/js/widgets/appcenter/appcenter.js";var appCenter=null;function appCenterHandler(){if(appCenter){appCenter.show();return}loadAppCenter()}var loadAppCenter=function(){loadAppCenter=Util.noop;return Util.loadJs(appCenterUrl,function(){appCenter=new AppCenterDialog({getDataUrl:ImacDataActionUrl.appCenterDataUrl,on:{show:function(){$appStoreBtn.addClass("active")},hide:function(){$appStoreBtn.removeClass("active")},installApp:function(ev){var data=ev.data;AppMgr.installApp(data.id,function(){appCenter._afterInstallApp(data.id)})},uninstallApp:function(ev){var data=ev.data,self=this;AppMgr.uninstallApp(data.id,function(){self._afterUninstallApp(data.id)})}}});appCenter.show()})};var $appStoreBtn=$("#imac-right-bar .q-btn.appstore");$appStoreBtn.on("click",appCenterHandler)})(this,jQuery);