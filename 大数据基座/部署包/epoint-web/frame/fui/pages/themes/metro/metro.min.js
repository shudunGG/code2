// 应用模板
var METRO_APP_TPL='\x3cdiv class\x3d"metro-app" data-id\x3d"{{id}}" title\x3d"{{name}}" style\x3d"top:{{top}}px;left:{{left}}px;width:{{width}}px;height:{{height}}px;"\x3e\x3cdiv class\x3d"app-inner" style\x3d"background-color:{{bgcolor}}"\x3e{{#innerUrl}}\x3ciframe src\x3d"{{innerUrl}}" frameborder\x3d"0" width\x3d"{{ifrWidth}}" height\x3d"{{ifrHeight}}" allowtransparency\x3d"true" class\x3d"app-iframe" scrolling\x3d"no"\x3e\x3c/iframe\x3e{{/innerUrl}}{{#icon}}{{{icon}}}{{/icon}}\x3cp class\x3d"app-name"\x3e{{name}}\x3c/p\x3e\x3cspan class\x3d"app-unread unread {{^count}}hidden{{/count}}"\x3e{{count}}\x3c/span\x3e\x3c/div\x3e\x3c/div\x3e',METRO_SCREEN_TPL='\x3cdiv class\x3d"screen-item l" data-name\x3d"{{name}}" data-server-index\x3d"{{screenIndex}}"\x3e\x3ch2 class\x3d"screen-header"\x3e{{name}}\x3c/h2\x3e\x3cdiv class\x3d"apps-wrap"\x3e{{{appHtml}}}\x3c/div\x3e\x3c/div\x3e',METRO_SCREEN_NAV_TPL='\x3cli class\x3d"screen-nav-item" title\x3d"{{name}}" data-server-index\x3d"{{screenIndex}}"\x3e\x3c/li\x3e',COMMON_APP_TPL='\x3cdiv class\x3d"common-app" data-id\x3d"{{id}}" title\x3d"{{name}}"\x3e\x3cspan class\x3d"common-app-unread app-unread unread {{^count}}hidden{{/count}}"\x3e{{count}}\x3c/span\x3e\x3cspan class\x3d"common-app-icon-wrap"\x3e{{#icon}}{{{icon}}}{{/icon}}\x3c/span\x3e\x3cspan class\x3d"common-app-name"\x3e{{sname}}\x3c/span\x3e\x3c/div\x3e',METRO_TASK_TPL='\x3ca href\x3d"javascript:void(0);" data-id\x3d"{{id}}" class\x3d"task-item l clearfix" title\x3d"{{name}}"\x3e\x3cp class\x3d"task-name"\x3e{{name}}\x3c/p\x3e\x3c/a\x3e',BOARD_CONTENT_TPL='\x3ciframe src\x3d"{{url}}" class\x3d"board-content hidden" id\x3d"board-content-{{id}}" height\x3d"100%" width\x3d"100%" frameborder\x3d"0" scrolling\x3d"no"\x3e\x3c/iframe\x3e';window.dealLinkOpen=function(linkData){switch(linkData.openType){case "tabsnav":TabsNav.addTab(linkData);break;case "dialog":epoint.openTopDialog(linkData.name,Util.getRightUrl(linkData.url));break;case "blank":window.open(Util.getRightUrl(linkData.url),(linkData.id+"").replace(/-/g,"_"));break;default:break}};(function(win,$){if(!Util.browsers.isIE8)$.ajax({url:"./images/app/svg.svg",dataType:"html",async:false,success:function(data){$('\x3cdiv hidden class\x3d"hidden"\x3e\x3c/div\x3e').append(data).appendTo("body")}});EpDialog.setMaxCoord({top:50,left:0,right:0,bottom:40});if(!win.METRO_SETTINGS)win.METRO_SETTINGS={};var METRO_SETTINGS_DEFAULT={columns:4,rows:4,activePage:1,dialogSizeRadio:[.6,.6],scrollDirection:0,appSize:[200,90],baseSize:[1200,600]};METRO_SETTINGS=$.extend({},METRO_SETTINGS_DEFAULT,METRO_SETTINGS);function freeze(obj){Object.freeze(obj);for(var key in obj)if(typeof obj[key]=="object"&&Object.prototype.hasOwnProperty.call(obj,key))Object.freeze(obj[key])}if(Object.freeze)freeze(win.METRO_SETTINGS);win.useWebsocket=Util.getFrameSysParam("useWebsocket")===true;win.eWebSocket=undefined;win.creatWebSocket=function(uid,uname,callback){if(eWebSocket){callback&&callback();return}var cfg=win.EWebSocketConfig?win.EWebSocketConfig:{url:EmsgConfig.websocketUrl};cfg.uid=uid;cfg.uname=uname;if(win.EWebSocket){eWebSocket=new EWebSocket(cfg);callback&&callback();_aideEvent_.fire("websocketCreated")}else Util.loadJs("frame/fui/js/widgets/ewebsocket/ewebsocket.js",function(){eWebSocket=new EWebSocket(cfg);callback&&callback();_aideEvent_.fire("websocketCreated")})};$.extend(Util,{debounce:function(fn,delay,ctx){delay=delay||17;var timer;return function(){var args=arguments;var context=ctx||this;clearTimeout(timer);timer=setTimeout(function(){fn.apply(context,args)},delay)}},throttle:function(fn,delay,ctx){delay=delay||200;var timer,prevTime=+new Date;return function(){clearTimeout(timer);var args=arguments;var context=ctx||this;var pastTime=+new Date-prevTime;if(pastTime>=delay){fn.apply(context,args);prevTime=+new Date}else timer=setTimeout(function(){fn.apply(context,args);prevTime=+new Date},delay-pastTime)}},sortArr:function(arr,type){var copyArr=Array.prototype.slice.call(arr,0),sortFunc;if(!type)type="asc";if(type=="asc")sortFunc=function(a,b){return a-b};else if(type=="desc")sortFunc=function(a,b){return b-a};return copyArr.sort(sortFunc)},fixPath:function(data){var copy=$.extend({},data);copy.url=Util.getRightUrl(data.url);if(data.innerUrl)copy.innerUrl=Util.getRightUrl(data.innerUrl);return copy},_genderIconHtml:function(){if(Util.browsers.isIE8)return function(icon,cls){return'\x3cimg src\x3d"'+Util.getRightUrl("./images/app/"+icon+".png")+'" class\x3d"'+cls+'" alt\x3d""\x3e'};return function(icon,cls){return'\x3csvg class\x3d"'+cls+'"\x3e\x3cuse xlink:href\x3d"#metro-app-icon-'+icon+'"\x3e\x3c/use\x3e\x3c/svg\x3e'}}(),highlightApp:function($app){var dark=function(){$app.animate({opacity:.3},200,next)},light=function(){$app.animate({opacity:1},200,next)},next=function(){var n=$app.queue("highlight");if(!n.length)$app.clearQueue("highlight");else $app.dequeue("highlight")};$app.queue("highlight",[dark,light,dark,light,dark,light,dark,light]);next()},configAppCmOpers:function(cm,data){data.uninstallable!==false?cm.enableItem("uninstall-app"):cm.disableItem("uninstall-app");data.movable!==false?cm.enableItem("move-app"):cm.disableItem("move-app");data.openable!==false?cm.enableItem("open-app"):cm.disableItem("open-app")},getAppShortName:function(name){return name.substr(0,4)},_jsPromise:{},loadJsPromise:function(url){if(this._jsPromise[url])return this._jsPromise[url];var dtd=$.Deferred(),script=document.createElement("script");script.type="text/javascript";if((this.browsers.isIE67||this.browsers.isIE8)&&script.readyState)script.onreadystatechange=function(){if(script.readyState=="loaded"||script.readyState=="complete"){dtd.resolve();script.onreadystatechange=null}};else{script.onload=function(){dtd.resolve();script.onload=null};script.onerror=function(){dtd.reject();script.onerror=null;Util._jsPromise[url]=null}}script.src=Util.getRightUrl(url);document.getElementsByTagName("head")[0].appendChild(script);return this._jsPromise[url]=dtd.promise()},doNiceScroll:function($el,cfg){this.loadJsPromise("frame/fui/js/widgets/jquery.nicescroll.min.js").done(function(){$el.niceScroll(cfg)})}});win._MetroEvent_=new Util.UserEvent})(this,jQuery);(function(win,$){var DEFAULT_BG="frame/fui/pages/themes/metro/images/skinbg/new.jpg";var $bg=$("#metro-skin-bg");Util.ajax({url:MetroDataActionUrl.getBgUrl}).done(function(data){if(data&&data.bg){$bg[0].src=Util.getRightUrl(data.bg);localStorage.setItem("_imac_bg_",data.bg)}else{$bg[0].src=Util.getRightUrl(DEFAULT_BG);console&&console.error("\u672a\u8fd4\u56de\u80cc\u666f\uff0c\u52a0\u8f7d\u9ed8\u8ba4\u80cc\u666f\uff01");localStorage.setItem("_imac_bg_",DEFAULT_BG)}});win.setBg=function(url){$bg[0].src=Util.getRightUrl(url);localStorage.setItem("_umplatform_bg_",url)}})(this,jQuery);(function(win,$){var $userInfo=$("#top-user"),$userPortrait=$(".user-img",$userInfo);var $logo=$("#sys-logo");var getUserInfo=function(){return Util.ajax({url:win.MetroDataActionUrl.userInfoUrl,success:function(data){$userInfo.find(".user-name").text(data.name);$userInfo.find(".user-ou").text(data.ouName);win._userName_=data.name;win._userGuid_=data.guid;win._msgcenterConfig_=$.extend({},MsgCenterConfig,{isMsgCenterMaxSize:data.isMsgCenterMaxSize||false,msgCenterOrder:data.msgCenterOrder||"asc",hideCallback:function(){$cover.addClass("hidden")}});if(useWebsocket)creatWebSocket(_userGuid_,_userName_);if(data.portrait){var url=Util.getRightUrl(epoint.dealRestfulUrl(data.portrait));$userPortrait.attr("src",url)}if(data.hasParttime)$userInfo.find(".user-action-item.role-change").removeClass("hidden");_MetroEvent_.fire("afterUserInfo",data)}})};getUserInfo();getPageInfo();function getPageInfo(){return Util.ajax({url:MetroDataActionUrl.pageInfoUrl}).done(function(data){if(data.logo)$logo.attr("src",Util.getRightUrl(data.logo));if(data.title){document.title=data.title;win.systemTitle=data.title}win._fullSearchUrl_=data.fullSearchUrl;_MetroEvent_.fire("afterPageInfo",data)})}})(this,jQuery);(function(win,$){var $screenContainer=$("#metro-screens"),$screenList=$(".screen-list",$screenContainer),$screenNavList=$("#screen-nav"),$screenBtn=$(".screen-btn",$screenContainer),$screenPrev=$screenBtn.filter(".prev"),$screenNext=$screenBtn.filter(".next");$screenList[0].setAttribute("data-direction",METRO_SETTINGS.scrollDirection===0?"0":"1");$screenBtn.attr("data-direction",METRO_SETTINGS.scrollDirection===0?"0":"1");var LEFT_WIDTH=$("#left-bar").width()||90,TOP_HEIGHT=$("#metro-top-bar").height()||50,BOTTOM_HEIGHT=$("#metro-task-bar").height()||40,PAGE_ITEM_SIZE={width:0,height:0},SCROLL_PROP=METRO_SETTINGS.scrollDirection==0?"margin-left":"margin-top",APP_UNIT_WIDTH=METRO_SETTINGS.appSize[0],APP_UNIT_HEIGHT=METRO_SETTINGS.appSize[1],APP_BORDER_WIDTH=3,appsWrap_w=(win.METRO_SETTINGS.columns||4)*APP_UNIT_WIDTH,appsWrap_h=(win.METRO_SETTINGS.rows||4)*APP_UNIT_HEIGHT,appsWrap_mt=appsWrap_h/2,appsWrap_ml=appsWrap_w/2;var needAdjustApp=true;function scaleAppSize(){var size=Util.getWinSize();var radio=1;if(size.width>METRO_SETTINGS.baseSize[0]&&size.height>METRO_SETTINGS.baseSize[1])radio=parseFloat(Math.min(size.width/METRO_SETTINGS.baseSize[0],size.height/METRO_SETTINGS.baseSize[1]),10);var w=METRO_SETTINGS.appSize[0]*radio>>0,h=METRO_SETTINGS.appSize[1]*radio>>0;if(w==APP_UNIT_WIDTH&&h==APP_UNIT_HEIGHT)needAdjustApp=false;else needAdjustApp=true;APP_UNIT_WIDTH=w;APP_UNIT_HEIGHT=h;appsWrap_w=win.METRO_SETTINGS.columns*APP_UNIT_WIDTH;appsWrap_h=win.METRO_SETTINGS.rows*APP_UNIT_HEIGHT;appsWrap_mt=appsWrap_h/2;appsWrap_ml=appsWrap_w/2}scaleAppSize();var adjustScreenSize=function(){scaleAppSize();var bs=Util.getWinSize();PAGE_ITEM_SIZE={width:bs.width-LEFT_WIDTH,height:bs.height-TOP_HEIGHT-BOTTOM_HEIGHT};var showHeader=bs.height<600?false:true;$screenContainer.css(PAGE_ITEM_SIZE).find(".screen-item").css(PAGE_ITEM_SIZE).find(".screen-header").css({width:appsWrap_w,marginLeft:-(appsWrap_w/2),marginTop:-(appsWrap_h/2+80),display:showHeader?"block":"none"});$screenList.find(".apps-wrap").css({marginTop:-appsWrap_mt,marginLeft:-appsWrap_ml,width:appsWrap_w,height:appsWrap_h});$screenNavList.css({marginTop:appsWrap_h/2+40});$screenBtn.css("margin-top",-appsWrap_h/2);$screenPrev.css("margin-left",-(appsWrap_w/2+$screenPrev.outerHeight()));$screenNext.css("margin-left",appsWrap_w/2);if(METRO_SETTINGS.scrollDirection==0)$screenList.css("margin-left",-activePage*PAGE_ITEM_SIZE.width);else $screenList.css("margin-top",-activePage*PAGE_ITEM_SIZE.height)};var IFR_TO_TOP=6,IFR_TO_LEFT=14,IFR_TO_BOTTOM=35;var getPropStyles=function(data){var styles={},r=data.rowspan,c=data.colspan,i=data.index;var el_w=APP_UNIT_WIDTH*c-APP_BORDER_WIDTH*2,el_h=APP_UNIT_HEIGHT*r-APP_BORDER_WIDTH*2,ifr_w=el_w-IFR_TO_LEFT*2,ifr_h=el_h-IFR_TO_TOP-IFR_TO_BOTTOM,el_t=i%METRO_SETTINGS.rows*APP_UNIT_HEIGHT,el_l=Util.toInt(i/METRO_SETTINGS.rows)*APP_UNIT_WIDTH,bgc=data.bgcolor||"#2a6ebb";$.extend(styles,{width:el_w,height:el_h,ifrWidth:ifr_w,ifrHeight:ifr_h,top:el_t,left:el_l,bgcolor:bgc});console.log(styles);return styles};function setAppPos(app,style){$(app).css({top:style.top,left:style.left,width:style.width,height:style.height}).find(".app-iframe").css({width:style.ifrWidth,height:style.ifrHeight})}function adjustAppsSize(){if(!needAdjustApp)return;$screenList.children().each(function(i,screenEl){$(screenEl).find(".metro-app").each(function(j,app){var appId=app.getAttribute("data-id");var data=AppMgr.getAppData(appId);if(data){var style=getPropStyles(data);setAppPos(app,style)}})})}$(win).on("resize",Util.debounce(function(){adjustScreenSize();adjustAppsSize()},17));var PAGE_NUM;var activePage=(win.METRO_SETTINGS.activePage||1)-1;var appTpl=$.trim(METRO_APP_TPL);var appCm;var renderScreens=function(data){var screen={};var len=data.length;var html=$.map(data,function(item,i){screen={name:item.leftNav.name,icon:item.leftNav.icon,screenIndex:item.leftNav.screenIndex,isFirst:i===0,isLast:i===len-1,appHtml:renderApps(item.screenApps,item.leftNav.screenIndex)};return Mustache.render(METRO_SCREEN_TPL,screen)});var $screens=$(html.join(""));$screens.find(".apps-wrap").css({marginTop:-appsWrap_mt,marginLeft:-appsWrap_ml,width:appsWrap_w,height:appsWrap_h});$screenList.append($screens)};var renderApps=function(apps,screenIndex){var html=$.map(apps,function(item){item=Util.fixPath(item);if(item.icon)item.icon=Util._genderIconHtml(item.icon,"app-icon");item.screenIndex=screenIndex;AppMgr.cacheAppData(item.id,item);return Mustache.render(appTpl,$.extend({},item,getPropStyles(item)))});return html.join("")};var leftItems=[];var renderPages=function(data){var l=data.length,leftData,html=[],i=0;for(;i<l;i++){leftData=data[i].leftNav;leftItems.push(leftData);html.push(Mustache.render(METRO_SCREEN_NAV_TPL,{page:i,name:leftData.name,icon:leftData.icon,screenIndex:leftData.screenIndex}))}var w=20*l;$screenNavList.css({marginLeft:-w/2,width:w}).html(html.join(""));PAGE_NUM=l};var getScreenInfo=function(){Util.ajax({type:"POST",dataType:"json",url:win.MetroDataActionUrl.screenInfoUrl,data:{query:"screen-apps"},success:function(data){if(data&&data.length){renderScreens(data);renderPages(data);if(appContextmenu)appCm=createAppContextMenu();AppDragMgr.enableAllApps();adjustScreenSize();MetroScreen.setPageActive(activePage)}_MetroEvent_.fire("afterAllAppsLoad")},error:Util._ajaxErr})};var getRightPage=function(page){var rt=page;if(page<0)rt=0;else if(page>=PAGE_NUM)rt=PAGE_NUM-1;return rt};var LEFT_KEY=37,UP_KEY=38,RIGHT_KEY=39,DOWN_KEY=40;var handleKeydown=function(event){var code=event.which,page;if(code==UP_KEY||code==LEFT_KEY)page=activePage-1;else if(code==DOWN_KEY||code==RIGHT_KEY)page=activePage+1;if(page===undefined)return;page=getRightPage(page);MetroScreen.setPageActive(page)};$(document).on("keydown",handleKeydown);$screenNavList.on("click",".screen-nav-item",function(event){event.preventDefault();var page=$(this).index();MetroScreen.setPageActive(page)});$screenPrev.click(function(){if(this.disabled)return;MetroScreen.goPrev()});$screenNext.click(function(){if(this.disabled)return;MetroScreen.goNext()});Util.loadJs(Util.getRightUrl("frame/fui/js/libs/jquery.mousewheel.min.js"),function(){var mousewheelTimer;$screenContainer.on("mousewheel",function(event){console.log(event.deltaX,event.deltaY,event.deltaFactor);clearTimeout(mousewheelTimer);mousewheelTimer=setTimeout(function(){var page;if(event.deltaY<0)page=activePage+1;else if(event.deltaY>0)page=activePage-1;if(page===undefined)return;page=getRightPage(page);MetroScreen.setPageActive(page)},200)})});win.MetroScreen={setPageActive:function(i){var page=getRightPage(i);var $page=$screenNavList.find(".screen-nav-item").eq(page);if($page.hasClass("active"))return;$screenPrev.prop("disabled",page===0);$screenNext.prop("disabled",page===PAGE_NUM-1);var range={};var v=METRO_SETTINGS.scrollDirection==0?PAGE_ITEM_SIZE.width:PAGE_ITEM_SIZE.height;range[SCROLL_PROP]=-(v*page);$screenList.stop(true).animate(range,300);$page.addClass("active").siblings().removeClass("active");if(appContextmenu)appCm.enableItem("page-"+activePage).disableItem("page-"+page);activePage=page},getActivePage:function(){return activePage},goPrev:function(){return this.setPageActive(this.getActivePage()-1)},goNext:function(){return this.setPageActive(this.getActivePage()+1)},getActiveNavItem:function(){return $screenNavList.find(".page-item").eq(activePage)},getScreen:function(page){return $screenList.find(".screen-item").eq(page)},getApp:function(id){return $screenContainer.find('[data-id\x3d"'+id+'"]')},addApp:function(data,page){var $screen=$screenList.find(".screen-item").eq(page),$app=$(Mustache.render(appTpl,$.extend({},data,getPropStyles(data))));$app.find(".app-center-item-icon").attr("class","app-icon");$app.appendTo($screen.find(".apps-wrap"));AppDragMgr.enableApp($app);data.screenIndex=$screen.data("server-index");AppMgr.cacheAppData(data.id,data);Util.highlightApp($app)},removeApp:function(id){var $app=this.getApp(id);AppDragMgr.destroy($app);$app.fadeOut(200,function(){$app.remove()})},getOccupiedGrids:function(page){var arr=[],$apps=this.getScreen(page).find(".metro-app");$.each($apps,function(i,el){var $el=$(el),id=$el.data("id");if($el.hasClass("ignored"))return;arr=arr.concat(MetroScreen.getAppOccupiedGrids(id))});if(arr.length>=2)arr=Util.sortArr(arr);return Array.prototype.slice.call(arr,0)},getAppOccupiedGrids:function(id){var data=$.isPlainObject(id)?id:AppMgr.getAppData(id),arr=[],r=data.rowspan,c=data.colspan,idx=data.index,i=0,j=1,n;if(c==1&&r==1)arr.push(idx);else for(;i<r;i++){n=idx+i;arr.push(n);for(j=1;j<c;j++)arr.push(n+j*METRO_SETTINGS.rows)}if(arr.length>=2)arr=Util.sortArr(arr);return Array.prototype.slice.call(arr,0)},getAppByIndex:function(page,index){var $apps=this.getScreen(page).find(".metro-app"),$rt=false;$apps.each(function(i,app){var id=$(app).data("id"),data=AppMgr.getAppData(id);if(!data)return;if(data.index==index){$rt=$(app);return false}});return $rt},getAppIndexByPos:function(pos){var c,r,index;var isOut=pos.left>(METRO_SETTINGS.columns-1)*APP_UNIT_WIDTH+APP_UNIT_WIDTH/2||pos.top>(METRO_SETTINGS.rows-1)*APP_UNIT_HEIGHT+APP_UNIT_HEIGHT/2;if(isOut)index=-1;else{c=(pos.left<0?0:pos.left)/APP_UNIT_WIDTH;r=(pos.top<0?0:pos.top)/APP_UNIT_HEIGHT;index=Math.round(c)*METRO_SETTINGS.rows+Math.round(r)}return index},adjustAppPosByIndex:function($app,index){var id=$app.data("id"),data=AppMgr.getAppData(id),pos=getAppPosByIndex(index);if(!data)return;$app.stop(true).animate(pos,200);if(data.index!=index){data.index=index;AppMgr.cacheAppData(id,data);AppMgr.sendAppUpdate(id,"update-app-index")}},isOneBlock:function(data){var idx=data.index,r=data.rowspan,col=Util.toInt(idx/METRO_SETTINGS.rows),i=1;for(;i<r;i++)if(Util.toInt((idx+i)/METRO_SETTINGS.rows)!=col)return false;return true},getEmptyGrids:function(page){var l=METRO_SETTINGS.columns*METRO_SETTINGS.rows,occupiedGrids=MetroScreen.getOccupiedGrids(page),emptyGrids=[],i=0;for(;i<l;i++)if($.inArray(i,occupiedGrids)==-1)emptyGrids.push(i);return Array.prototype.slice.call(emptyGrids,0)},getInsertIndex:function(data,page){var r=data.rowspan,c=data.colspan,emptyGrids=MetroScreen.getEmptyGrids(page),occupiedGrids=[],rt=0,hasRoom=true,i,j,l,m;l=emptyGrids.length;m=r*c;if(!l||m>l)rt=-1;else if(r==1&&c==1)rt=emptyGrids[0];else{for(i=0;i<l;i++){hasRoom=true;data.index=emptyGrids[i];if(!MetroScreen.isOneBlock(data))continue;occupiedGrids=MetroScreen.getAppOccupiedGrids(data);for(j=0;j<m;j++)if($.inArray(occupiedGrids[j],emptyGrids)==-1){hasRoom=false;break}if(hasRoom){rt=data.index;break}}if(!hasRoom)rt==-1}return rt}};var getAppPosByIndex=function(index){var col=Util.toInt(index/METRO_SETTINGS.rows),row=Util.toInt(index%METRO_SETTINGS.rows);return{left:APP_UNIT_WIDTH*col,top:APP_UNIT_HEIGHT*row}};var createAppContextMenu=function(){var items=[],i,moveItems=[];var moveToScreen=function(opt,data){AppMgr.moveToScreen(opt.id,data.page)};items.push({text:"\u6253\u5f00\u5e94\u7528",role:"open-app",click:function(opt){AppMgr.openApp(opt.id)}});items.push("sep");for(i=1;i<=PAGE_NUM;i++)moveItems.push({text:leftItems[i-1].name,role:"page-"+(i-1),page:i-1,click:moveToScreen});items.push({text:"\u79fb\u52a8\u5e94\u7528\u5230",role:"move-app",items:moveItems});items.push({text:"\u5378\u8f7d\u5e94\u7528",role:"uninstall-app",click:function(opt){mini.confirm("\u60a8\u786e\u5b9a\u5378\u8f7d\u8be5\u5e94\u7528\u5417\uff1f\u5378\u8f7d\u540e\u53ef\u4ece\u5e94\u7528\u4ed3\u5e93\u4e2d\u518d\u6b21\u6dfb\u52a0\u5230\u684c\u9762\u3002","\u7cfb\u7edf\u63d0\u793a",function(action){if(action=="ok")AppMgr.uninstallApp(opt.id)})}});var cm=new EpContextMenu({items:items});return cm};var updateUnread=function($app,count){var $unread=$app.find(".app-unread");if(count<=0)$unread.addClass("hidden");else $unread.html(count>=99?99:count).removeClass("hidden")};var appDataCache={};win.sss=appDataCache;win.AppMgr={msgRemindApps:[],cacheAppData:function(id,data){appDataCache[id]=$.extend({},data);if(data.needMsgRemind)AppMgr.msgRemindApps.push(data.id)},getAppData:function(id){if(appDataCache[id])return $.extend({},appDataCache[id])},delAppData:function(id){appDataCache[id]=null},openApp:function(id){var data=AppMgr.getAppData(id);if(data.isBlank)win.open(data.url);else TabsNav.addOrActiveTask(id)},installApp:function(data,callback){if(!data.rowspan||!data.colspan){console.error("\u5e94\u7528\u6570\u636e\u4e0d\u5b8c\u6574\u65e0\u6cd5\u5b89\u88c5",data);return}var page=MetroScreen.getActivePage(),data=Util.fixPath(data);var insertIndex=MetroScreen.getInsertIndex(data,page);if(insertIndex===-1){epoint.showTips("\u5f88\u62b1\u6b49\uff0c\u5f53\u524d\u9875\u6ca1\u6709\u8db3\u591f\u7684\u7a7a\u95f4\u5b89\u88c5\u8be5\u5e94\u7528\uff0c\u60a8\u53ef\u4ee5\u9009\u62e9\u5176\u4ed6\u5206\u5c4f\u6216\u8005\u8c03\u6574\u5e94\u7528\u5e03\u5c40\u540e\u518d\u5b89\u88c5\u3002",{state:"error"});return false}data.index=insertIndex;MetroScreen.addApp(data,page);epoint.showTips("\u5e94\u7528\u3010"+data.name+"\u3011\u5b89\u88c5\u6210\u529f\uff01",{state:"success"});AppMgr.sendAppUpdate(data,"install-app");callback&&callback()},moveToScreen:function(id,page){var data=AppMgr.getAppData(id);if(!data)return;var idx=MetroScreen.getInsertIndex(data,page);if(idx==-1)mini.showMessageBox({title:"\u7cfb\u7edf\u63d0\u793a",message:"\u5f88\u62b1\u6b49\uff0c\u7b2c"+(page+1)+"\u5206\u5c4f\u6ca1\u6709\u8db3\u591f\u7684\u7a7a\u95f4\uff0c\u60a8\u53ef\u4ee5\u9009\u62e9\u5176\u4ed6\u5206\u5c4f\u6216\u8005\u8c03\u6574\u5e94\u7528\u5e03\u5c40\u540e\u518d\u79fb\u52a8\u3002",buttons:["ok"],iconCls:"mini-messagebox-warn"});else{data.index=idx;MetroScreen.removeApp(id);MetroScreen.addApp(data,page);MetroScreen.setPageActive(page);AppMgr.sendAppUpdate(id,"screen-to-screen")}},uninstallApp:function(id,callback){TabsNav.removeTab(id);MetroScreen.removeApp(id);AppMgr.sendAppUpdate(id,"uninstall-app");AppMgr.delAppData(id);callback&&callback()},sendAppUpdate:function(id,query){var data=$.isPlainObject(id)?id:AppMgr.getAppData(id),params=$.extend({},data,{query:query});Util.ajax({type:"POST",url:MetroDataActionUrl.updateAppUrl,dataType:"json",data:params,success:Util.noop,error:Util._ajaxErr})}};$screenContainer.on("click",".metro-app",function(event){var id=$(this).data("id");AppMgr.openApp(id)});if(appContextmenu)$screenContainer.on("contextmenu",".metro-app",function(event){var id=$(this).data("id"),data=AppMgr.getAppData(id);if(!data)return;appCm.setOptions("id",id).show({x:event.pageX,y:event.pageY});Util.configAppCmOpers(appCm,data);return false});getScreenInfo()})(this,jQuery);(function(win,$){var $screenContainer=$("#metro-screens");var appDragStart=function(event,ui){var $el=$(this);$el.addClass("app-drag-zindex")};var appDragStop=function(event,ui){var $el=$(this),id=$el.data("id"),data=AppMgr.getAppData(id);if(!data)return;var oldIdx=data.index,pos=ui.position,i=MetroScreen.getAppIndexByPos(pos),occupied=[],oldOccupied=[],overApps=[],overOccupied=[],empty=[],temp=[],isFit=false,activePage=MetroScreen.getActivePage();data.index=i;if(i==-1)isFit=false;else if(!MetroScreen.isOneBlock(data))isFit=false;else{occupied=MetroScreen.getAppOccupiedGrids(data);oldOccupied=MetroScreen.getAppOccupiedGrids($.extend({},data,{index:oldIdx}));empty=MetroScreen.getEmptyGrids(activePage);$.each(occupied,function(i,idx){var $app=MetroScreen.getAppByIndex(activePage,idx);if($app&&$app.data("id")!=id)overApps.push($app.addClass("ignored"))});if(overApps.length)$.each(overApps,function(i,$app){var id=$app.data("id");overOccupied=overOccupied.concat(MetroScreen.getAppOccupiedGrids(id))});$.each(occupied,function(i,idx){if($.inArray(idx,empty)!=-1||$.inArray(idx,oldOccupied)!=-1)temp.push(idx)});temp=Util.sortArr(temp.concat(overOccupied));isFit=temp[0]==occupied[0]&&temp[temp.length]==occupied[occupied.length]&&temp.length==occupied.length}if(!isFit)i=oldIdx;MetroScreen.adjustAppPosByIndex($el,i);if(overApps.length)if(isFit)$.each(overApps,function(i,$app){var id=$app.data("id"),data=AppMgr.getAppData(id);if(!data)return;var idx=MetroScreen.getInsertIndex(data,activePage);MetroScreen.adjustAppPosByIndex($app.removeClass("ignored"),idx)});else $.each(overApps,function(i,$app){$app.removeClass("ignored")});$el.removeClass("app-drag-zindex")};var dragConfig={containment:"body",scroll:false,opacity:.5,distance:10,iframeFix:true,start:appDragStart,stop:appDragStop};win.AppDragMgr={enableAllApps:function(){$screenContainer.find(".metro-app").draggable(dragConfig)},enableApp:function($app){$app.draggable(dragConfig)},destroy:function($app){$app.draggable("destroy")}}})(this,jQuery);(function(win,$){var $container=$("body");var appElCache={};var resolveDtd=function(){var dtd=$.Deferred();dtd.resolve();return dtd.promise()}();var getAppMsgCount=function(){var ids=$.unique(AppMgr.msgRemindApps);if(!ids)return resolveDtd;var appIds=JSON.stringify(ids);return Util.ajax({url:MetroDataActionUrl.updateAppMsgCountUrl,data:{appIds:appIds}}).done(function(data){if(!data)return;$.each(data,function(id,count){count=parseInt(count,10)||0;count=count>99?"99+":count;var $appCount=appElCache[id]?appElCache[id]:appElCache[id]=$container.find('[data-id\x3d"'+id+'"]').find(".unread");if(count)$appCount.text(count).removeClass("hidden");else $appCount.addClass("hidden")})})};function startUpdateAppMsgCount(){getAppMsgCount().always(function(){setTimeout(startUpdateAppMsgCount,30*1E3)})}_MetroEvent_.on("afterAllAppsLoad",startUpdateAppMsgCount)})(this,jQuery);(function(win,$){var $taskBar=$("#metro-task-bar"),$tasksWrap=$(".tasks-wrap",$taskBar),$taskList=$(".task-list",$taskBar);var $scrollWrap=$taskBar.find(".scroll-wrap");var SCROLL_WIDTH=50,TASK_WIDTH=114,SCROLL_UNIT=200,EXTRA_WIDTH=0;var taskTempl=$.trim(METRO_TASK_TPL);var adjustTabsNav=function(){var bd_w=$("body").width(),wrap_w=bd_w-SCROLL_WIDTH*2-EXTRA_WIDTH;$tasksWrap.css("width",wrap_w);var l=$taskList.find(".task-item").length,tasks_w=TASK_WIDTH*l;if(tasks_w>wrap_w)$scrollWrap.removeClass("hidden");else{$scrollWrap.addClass("hidden");$taskList.css("margin-left",0)}};var contextMenu=new EpContextMenu({items:[{text:"\u663e\u793a\u684c\u9762",click:function(opt){TabsNav.minAllTabs()}},"sep",{text:"\u5173\u95ed\u6b64\u4efb\u52a1",click:function(opt){var id=opt.id;TabsNav.removeTab(id)}},{text:"\u53ea\u663e\u793a\u6b64\u4efb\u52a1\u7a97\u53e3",click:function(opt){TabsNav.minAllTabs(opt.id)}},"sep",{text:"\u5173\u95ed\u5176\u4ed6\u4efb\u52a1",click:function(opt){var id=opt.id;TabsNav.removeOthers(id)}},{text:"\u5173\u95ed\u6240\u6709\u4efb\u52a1",click:function(){TabsNav.removeAll()}},"sep",{text:"\u53d6\u6d88",role:"cancel"}]});var taskCache={};var adjustTaskDialogSize=function(){var p,d;for(p in taskCache)if(taskCache.hasOwnProperty(p)){d=taskCache[p];if(d&&!d.isHidden()&&d.isMax())d.maxWin()}};var containerSize={width:$(win).width()-66,height:$(win).height()-50-40};win.TabsNav={openTask:function(id){var data=AppMgr.getAppData(id),dialog=null;if(!data)return;if(!taskCache[id]){dialog=(new EpDialog({id:id+"-epdialog",title:data.name,url:data.url,draggable:true,resizable:true,width:(data.widthRatio||METRO_SETTINGS.dialogSizeRadio[0])*containerSize.width,height:(data.heightRatio||METRO_SETTINGS.dialogSizeRadio[1])*containerSize.height,btns:[{role:"min",title:"\u6700\u5c0f\u5316",click:function(){this.hide()}},{role:"maxwin",title:"\u6700\u5927\u5316"},{role:"refresh",title:"\u5237\u65b0"},{role:"close",title:"\u5173\u95ed",click:function(opt){TabsNav.removeTab(opt.id);return false}}]})).setOptions("id",id);if(data.isFullView)dialog.show(0,0).maxWin();else dialog.show(0,1);taskCache[id]=dialog}else{dialog=taskCache[id];dialog.show(0,0)}},minAllTabs:function(id){var p,d;for(p in taskCache)if(taskCache.hasOwnProperty(p)){d=taskCache[p];if(p!=id)d.hide();else{d.show(0,0);TabsNav.activeTask(p)}}},addOrActiveTask:function(id){var isOn=taskCache[id],data=AppMgr.getAppData(id);if(!data)return;if(!isOn){$(Mustache.render(taskTempl,{id:data.id,name:data.name})).appendTo($taskList);adjustTabsNav()}TabsNav.openTask(id);TabsNav.activeTask(id)},makeTaskVisiable:function(id){var $task=TabsNav.getTask(id),$prevAll=$task.prevAll(),prev_w=$prevAll.length*TASK_WIDTH,mL=Math.abs(Util.toInt($taskList.css("margin-left"))),wrap_w=$tasksWrap.width(),dis=0;if(prev_w<mL)dis=prev_w;else if(prev_w+TASK_WIDTH-wrap_w>mL)dis=prev_w+TASK_WIDTH-wrap_w;if(!dis)return;$taskList.stop(true).animate({marginLeft:-dis},300)},getTask:function(id){return $taskList.find('[data-id\x3d"'+id+'"]')},removeTab:function(id){var $task=TabsNav.getTask(id);if(!$task.length)return;$task.remove();taskCache[id].hide().destroy();taskCache[id]=null;delete taskCache[id];adjustTabsNav()},removeOthers:function(stayId){var $tasks=$taskList.find(".task-item");if(!$tasks.length)return;$tasks.each(function(i,el){var $el=$(el),id=$el.data("id");if(stayId!=id){$el.remove();taskCache[id].hide().destroy();taskCache[id]=null;delete taskCache[id]}});adjustTabsNav()},removeAll:function(){var $tasks=$taskList.find(".task-item");if(!$tasks.length)return;$tasks.each(function(i,el){var $el=$(el),id=$el.data("id");$el.remove();taskCache[id].hide().destroy();taskCache[id]=null;delete taskCache[id]});adjustTabsNav()},activeTask:function(id){var $task=TabsNav.getTask(id);if(!$task.hasClass("active"))$task.addClass("active").siblings().removeClass("active");TabsNav.makeTaskVisiable(id)}};$(win).on("resize",Util.debounce(function(){containerSize={width:$(win).width()-66,height:$(win).height()-50-40};adjustTabsNav();adjustTaskDialogSize()},50));$taskBar.on("click",".scroll-l",function(event){var mL=Math.abs(Util.toInt($taskList.css("margin-left"))),dis=mL-SCROLL_UNIT;if(!mL)return;if(dis<0)dis=0;$taskList.stop(true).animate({marginLeft:-dis},200)}).on("click",".scroll-r",function(event){var mL=Math.abs(Util.toInt($taskList.css("margin-left"))),total_w=$taskList.find(".task-item").length*TASK_WIDTH,wrap_w=$tasksWrap.width(),delta=total_w-wrap_w;dis=mL+SCROLL_UNIT;if(mL==total_w-wrap_w)return;if(dis>delta)dis=delta;$taskList.stop(true).animate({marginLeft:-dis},300)}).on("click",".task-item",function(event){var $el=$(this),id=$el.data("id"),d=taskCache[id];if(!$el.hasClass("active")){$el.addClass("active").siblings().removeClass("active");d.show(0,0)}else d.toggle()}).on("contextmenu",".task-item",function(event){var id=$(this).data("id");contextMenu.setOptions("id",id).show({x:event.pageX,y:event.pageY});return false});$("body").on("click",".epdialog-hd",function(e){e.preventDefault();e.stopPropagation();if(!/^epdialog-hd(?!-btn)/.test(e.target.className))return;var dialogId=$(this).parent(".epdialog")[0].id,appId=dialogId.replace(/(.+)-epdialog$/,"$1");if(appId)TabsNav.addOrActiveTask(appId)});adjustTabsNav()})(this,jQuery);(function(win,$){var $topBtns=$("#metro-top-bar .top-btns");$topBtns.on("click",".logout",function(event){event.preventDefault();mini.confirm("\u60a8\u786e\u5b9a\u8981\u9000\u51fa\u7cfb\u7edf\u5417\uff1f","\u7cfb\u7edf\u63d0\u793a",function(action){if(action=="ok")if(win.onLogout){eMsgSocket&&eMsgSocket.close();win.onLogout()}})})})(this,jQuery);(function(win,$){var $msgSound=$("#msg-sound");var SOUND_URL="../../msgsound/sound.html";var ROLLER_TEXT="\u60a8\u6709\u65b0\u6d88\u606f\u63d0\u9192\uff0c\u8bf7\u70b9\u51fb\u67e5\u770b\uff01",rollerTip=ROLLER_TEXT,timer=0,title="";var rollDocTitle=function(){title=win.systemTitle||document.title;document.title=rollerTip;clearTimeout(timer);timer=setTimeout(function roll(){document.title=rollerTip.substring(1,rollerTip.length)+rollerTip.substring(0,1);rollerTip=document.title;timer=setTimeout(roll,300)},300)};var restoreDocTitle=function(){clearTimeout(timer);document.title=title||document.title;rollerTip=ROLLER_TEXT};var docTitle={roll:rollDocTitle,stop:restoreDocTitle};var parseNum=function(num){var n=parseInt(num,10);if(n>99)return"99+";else if(n<=0)return"";return n+""};var playNewMsgSound=function($msgSoundContainer,soundIframeUrl,soundFileUrl){if(Util.getFrameSysParam("messageSound")===false)return Util.noop;soundIframeUrl=Util.getRightUrl(soundIframeUrl);if(Util.browsers.isIE){var $soundIframe=$('\x3ciframe src\x3d"" frameborder\x3d"0" class\x3d"hidden"\x3e\x3c/iframe\x3e').appendTo($msgSoundContainer);return function(){$soundIframe[0].src=soundIframeUrl+"?_\x3d"+ +new Date}}var msgAudio=document.createElement("audio");msgAudio.src=Util.getRightUrl(soundFileUrl);msgAudio.className="hidden-accessible";$msgSoundContainer.append(msgAudio);var newMsgAudioTimer=null;return function doPlayNewMsgAudio(retryLimit){if(retryLimit===undefined)retryLimit=100;msgAudio.play()["catch"](function(){clearTimeout(newMsgAudioTimer);if(retryLimit>0)newMsgAudioTimer=setTimeout(function(){doPlayNewMsgAudio(--retryLimit)},50)})}}($msgSound,SOUND_URL,"../../msgsound/newsms.wav");var getMsgCount=function(useCache){var params={haseXun:true,needNum:true};if(useCache)params.inCache=true;return Util.ajax({url:win.MetroDataActionUrl.msgCountUrl,dataType:"json",global:false,data:{haseXun:true,needNum:true}}).done(updateMsgCount)};var $topBtns=$("#top-btns"),$remind=$(".msg-remind",$topBtns),$remindNum=$(".unread",$remind),$chat=$(".chat",$topBtns),$eMsgNum=$(".unread",$chat),$msgEMsg=$("#msgEMsg"),$msgEMsgContent=$(".msg-panel-content",$msgEMsg),$msgEMsgRecent=$(".emsg-recent-list",$msgEMsgContent),$onlineUserNum=$(".online-user-num",$msgEMsg),onlineUserIframe=document.getElementById("online-user");function updateMsgCount(data){var old=0,hasNew=false;if(data.remind){old=parseInt($remindNum.data("num"),10)||0;if(data.remind>old)hasNew=true;$remindNum.removeClass("hidden").text(parseNum(data.remind));$remindNum.data("num",data.remind)}else $remindNum.text("").addClass("hidden");if(data.eXun){old=parseInt($eMsgNum.data("num"),10)||0;if(data.eXun>old)hasNew=true;$eMsgNum.removeClass("hidden").text(parseNum(data.eXun));$eMsgNum.data("num",data.eXun)}else $eMsgNum.text("").addClass("hidden");if(hasNew){playNewMsgSound(100);docTitle.roll()}else docTitle.stop()}var emsgList;var loadEMsgList=function(){loadEMsgList=Util.noop;return Util.loadJs("frame/fui/js/widgets/emsglist/emsglist.js",function(){emsgList=new EMsgList({content:$msgEMsgRecent,getUrl:EmsgConfig.baseUrl,ignoreUrl:EmsgConfig.baseUrl,userImg:EmsgConfig.userImg,groupImg:EmsgConfig.groupImg,afterOpenEMsg:function(){toggleEmsgList(false)},onDecEmsgCount:function(){var cnt=$eMsgNum.text();if(cnt)cnt=parseInt(cnt,10)-1;if(cnt==0){cnt="";$eMsgNum.data("num",0).addClass("hidden")}$eMsgNum.text(cnt)}});win.RefreshEMsg=$.proxy(emsgList.getData,emsgList);toggleEmsgList(true)})};$chat.on("click",function(){if(!emsgList)return loadEMsgList();toggleEmsgList(!$chat.hasClass("active"))});$msgEMsg.find(".msg-panel-hide").on("click",function(){toggleEmsgList(false)});$(document).on("click",function(ev){var $target=$(ev.target);if(!$target.closest($msgEMsg.add($chat)).length)toggleEmsgList(false)});function toggleEmsgList(active){if(active)return show();hide();function show(){$chat.addClass("active");$msgEMsg.removeClass("hidden");$msgEMsg.stop(true).animate({right:0})}function hide(){$msgEMsg.stop(true).animate({right:-350},function(){$msgEMsg.addClass("hidden")});$chat.removeClass("active")}}if(win.OnlineUserSettings&&win.OnlineUserSettings.show){$msgEMsg.find(".msg-panel-head").addClass("tab").find(".panel-hd-tab.hidden").removeClass("hidden");onlineUserIframe.src=OnlineUserSettings.url;$msgEMsg.on("click",".panel-hd-tab",function(){var $this=$(this),ref=$this.data("ref"),hasShow=$this.data("hasShow"),$content=$msgEMsgRecent;if(!$this.hasClass("active")){$this.addClass("active").siblings().removeClass("active");if(ref){$content=$("#"+ref,$msgEMsgContent);if(!hasShow)setTimeout(function(){OnlineUserSettings.onRefreshData(function(count){$onlineUserNum.html(count)});$this.data("hasShow",true)},10)}$content.removeClass("hidden").siblings().addClass("hidden")}})}_MetroEvent_.on("afterPageInfo",function(){getMsgCount(false);if(!useWebsocket)setInterval(function(){getMsgCount(true)},6E4)})})(this,jQuery);(function(win,$){var $topBtns=$("#metro-top-bar .top-btns");$.each(win.defaultApps,function(i,data){data=Util.fixPath(data);AppMgr.cacheAppData(data.id,data)});$topBtns.on("click",".default-app-btn",function(event){event.preventDefault();var id=$(this).data("id");AppMgr.openApp(id)})})(this,jQuery);var eMsgSocket;window.OpenEMsg=function(sessionid,uid,type){if(window.eMsg)if(typeof uid=="undefined")eMsg.open(sessionid);else eMsg.openSession(sessionid,uid,type);else Util.loadPageModule({templ:"frame/fui/pages/emsg/emsg.tpl",js:"frame/fui/pages/emsg/emsg.js",css:"frame/fui/pages/emsg/emsg.css",callback:function(){eMsgSocket=new EMsgSocket(_userGuid_,_userName_);if(typeof uid=="undefined")eMsg.open(sessionid);else eMsg.openSession(sessionid,uid,type)}})};(function(win,$){var PORTAL_ITEM_TPL='\x3cli class\x3d"portal-item" data-id\x3d"{{code}}" data-url\x3d"{{url}}" data-opentype\x3d"{{openType}}" title\x3d"{{name}}"\x3e\x3cspan class\x3d"portal-icon {{icon}}"\x3e\x3c/span\x3e\x3cspan class\x3d"portal-name"\x3e{{name}}\x3c/span\x3e\x3c/li\x3e';var $portalBtn=$("#portal-btn"),$portalWrap=$("#portal-wrap"),$portalContent=$("#portal-content"),$portal=$portalBtn.add($portalWrap),$boardPanel=$("#board-panel");function initPortal(homes,defaultHome){if(!homes){console.error("\u672a\u83b7\u53d6\u5230\u95e8\u6237\u6570\u636e");$portalBtn.addClass("hidden");return}var home={closeIcon:false,refresh:true};var singleHomes=[];for(var i=0;i<homes.length;i++){var cate=homes[i];var finded=false;if(cate.items!=undefined)!finded&&$.each(cate.items,function(j,item){if(defaultHome){if(item.code==defaultHome){home.id=item.code||"home";home.url=item.url;home.name=item.name;finded=true;return false}}else if(item.openType=="tabsnav"){home.id=item.code||"home";home.url=item.url;home.name=item.name;finded=true;return false}});else{if(!finded)if(defaultHome){if(cate.code==defaultHome){home.id=cate.code||"home";home.url=cate.url;home.name=cate.name;finded=true}}else if(cate.openType=="tabsnav"){home.id=cate.code||"home";home.url=cate.url;home.name=cate.name;finded=true}singleHomes=singleHomes.concat(homes.splice(i,1));i--}}initView(singleHomes,homes);initEvent(home)}function initEvent(defaultHome){$portalBtn.on("click",function(){togglePortal(!$portal.hasClass("active"))});$portalWrap.on("click",".portal-item",function(){var $this=$(this),openType=$this.data("opentype"),url=Util.getRightUrl($this.data("url"));openType=="blank"?win.open(url):BoardCenter.show($(this).data("id"));togglePortal(false)}).on("click",".portal-cate",function(){var $block=$(this).parent();$block.toggleClass("collapse")});$boardPanel.on("click",".board-close",function(){BoardCenter.hide()});function togglePortal(show){if(show){$portal.addClass("active");TabsNav.minAllTabs();BoardCenter.hide();return}$portal.removeClass("active")}$("body").on("click",function(ev){if(!$(ev.target).closest($portal).length)togglePortal(false)});var $portalPanel=$portal.find(".portal");function adjustPortalHeight(){var h=$(win).height()-140;h>0&&$portalPanel.css("max-height",h)}adjustPortalHeight();$(win).on("resize",Util.debounce(adjustPortalHeight,17))}function initView(singleHomes,homes){var html=[];if(singleHomes){html.push('\x3cul class\x3d"portal-list"\x3e');$.each(singleHomes,function(i,item){item.icon=item.icon||"default-modicon";item.url=Util.getRightUrl(item.url);html.push(Mustache.render(PORTAL_ITEM_TPL,item));BoardCenter.data[item.code]=item});html.push("\x3c/ul\x3e")}$.each(homes,function(i,cate){html.push('\x3cdiv class\x3d"portal-block"\x3e\x3ch3 class\x3d"portal-cate"\x3e'+cate.name+'\x3cspan class\x3d"portal-cate-trigger"\x3e\x3c/span\x3e\x3c/h3\x3e\x3cul class\x3d"portal-list" style\x3d"max-height:'+30*cate.items.length+'px"\x3e');$.each(cate.items,function(j,item){item.icon=item.icon||"default-modicon";item.url=Util.getRightUrl(item.url);html.push(Mustache.render(PORTAL_ITEM_TPL,item));BoardCenter.data[item.code]=item});html.push("\x3c/ul\x3e\x3c/div\x3e")});$(html.join("")).appendTo($portalContent)}win.BoardCenter={data:{},cache:{},show:function(id){var $target;if(!this.cache[id])$target=this.cache[id]=renderBoardIframe(id);else $target=this.cache[id];TabsNav.minAllTabs();$boardPanel.removeClass("hidden");$target.removeClass("hidden").siblings(".board-content").addClass("hidden")},hide:function(){$boardPanel.addClass("hidden")}};var renderBoardIframe=function(id){return $(Mustache.render(BOARD_CONTENT_TPL,BoardCenter.data[id])).appendTo($boardPanel)};_MetroEvent_.on("afterPageInfo",function(ev){initPortal(ev.data.homes,ev.data.defaultHome)})})(this,jQuery);(function(win,$){var $leftBar=$("#left-bar"),$quickApps=$("#common-apps"),$list=$(".list-wrap",$quickApps),$cfgBtn=$(".common-cfg-btn",$quickApps);var PREV_HEIGHT=$("#portal-btn").outerHeight(true)||50,NEXT_HEIGHT=0,CFG_BTN_HEIGHT=50,wrap_h=0;Util.doNiceScroll($list,{cursorwidth:"2px",cursorcolor:"rgba(0,0,0,.3)",cursorborder:"1px solid rgba(0,0,0,.6)",horizrailenabled:false});var adjustListHeight=function(){PREV_HEIGHT=$quickApps.position().top;var h=$leftBar.height();wrap_h=h-(PREV_HEIGHT+NEXT_HEIGHT);$quickApps.css("height",wrap_h);$list.css("max-height",wrap_h-CFG_BTN_HEIGHT)};$(win).on("resize",Util.debounce(adjustListHeight,50));win.QuickApps={isInit:false,init:function(){if(QuickApps.isInit)return;adjustListHeight();QuickApps._init()},_init:function(){return this.getData().done(function(data){QuickApps._initView(data)._initEvent()})},update:function(){return this._init()},getData:function(){return Util.ajax({url:MetroDataActionUrl.commonAppsUrl})},_initView:function(data){if(!data||!data.length)return this;var html=[];$.each(data,function(i,item){item=Util.fixPath(item);item.sname=Util.getAppShortName(item.name);if(parseInt(item.count,10)>99)item.count="99";if(!item.id)item.id=item.code;if(!AppMgr.getAppData(item.id))AppMgr.cacheAppData(item.id,item);if(item.icon)item.icon=Util._genderIconHtml(item.icon,"common-app-icon");html.push(Mustache.render(COMMON_APP_TPL,item))});$(html.join("")).appendTo($list.empty());$cfgBtn.removeClass("hidden");return this},_initEvent:function(){!this.isInit&&$quickApps.on("click",".common-app",function(){var id=$(this).data("id");AppMgr.openApp(id)});return this}};_MetroEvent_.on("afterAllAppsLoad",QuickApps.init);var cfgUrl=MetroDataActionUrl.commonAppCfgUrl;var themeId=function(){var themeMatch=location.href.match(/^https?:\/\/.*\/fui\/pages\/themes\/(\w+)\/\1/i),theme=themeMatch&&themeMatch[1];return theme}();var pageId=Util.getUrlParams("pageId")||themeId;cfgUrl=Util.addUrlParams(cfgUrl,{themeId:themeId,pageId:pageId});var isCfgOpened=false;$cfgBtn.on("click",function(){if(isCfgOpened)return;isCfgOpened=true;var opt={width:920,height:500};var win_size=Util.getWinSize();if(win_size.height<opt.height)opt.height=win_size.height;else opt.height=win_size.height*.6>>0;if(win_size.width<opt.width)opt.width=win_size.width;epoint.openDialog("\u5e38\u7528\u5e94\u7528\u914d\u7f6e",cfgUrl,function(isChanged){if(isChanged===true)QuickApps.update();isCfgOpened=false},opt)})})(this,jQuery);(function(win,$){var appCenterUrl="frame/fui/js/widgets/appcenter/appcenter.js";var appCenter=null;function appCenterHandler(){if(appCenter){appCenter.show();return}loadAppCenter()}var loadAppCenter=function(){loadAppCenter=Util.noop;return Util.loadJs(appCenterUrl,function(){appCenter=new AppCenterDialog({getDataUrl:MetroDataActionUrl.appCenterDataUrl,on:{show:function(){$appStoreBtn.addClass("active")},hide:function(){$appStoreBtn.removeClass("active")},installApp:function(ev){var data=ev.data;console.log(data);AppMgr.installApp(data,function(){appCenter._afterInstallApp(data.id)})},uninstallApp:function(ev){var data=ev.data,self=this;AppMgr.uninstallApp(data.id,function(){self._afterUninstallApp(data.id)})}}});appCenter.show()})};var $appStoreBtn=$("#top-btns .appstore");$appStoreBtn.on("click",appCenterHandler)})(this,jQuery);(function(win,$){var $headerSearch=$("#header-search-container");function doSearch(type,kw){type=type||"all";win.open(Util.getRightUrl(win._fullSearchUrl_+"?wd\x3d"+win.encodeURI(kw)+"\x26type\x3d"+type))}function getCateData(){return Util.ajax({url:win._searchCfg.fullSearchCateUrl}).done(function(data){initTopFullSearch(data.categories)})}function initTopFullSearch(cateData){cateData=cateData||[];if(typeof cateData=="string")cateData=JSON.parse(cateData);var cates=[];$.each(cateData,function(i,item){cates.push({id:item.guid,name:item.name,iconCls:item.icon||"view"})});if(!cates.length)cates.push({id:"all",name:"\u5168\u6587\u68c0\u7d22",iconCls:"modicon-25"});ClassifySearch._styleLoaded=true;ClassifySearch.CLASSIFICATION_TPL='\x3cdiv class\x3d"classify-search-classify-item {{#isActive}}active{{/isActive}}" data-id\x3d"{{id}}" data-title-tpl\x3d"\u4e0e${keyword}\u76f8\u5173\u7684{{name}}"\x3e\x3cspan class\x3d"classify-search-classify-icon {{iconCls}}"\x3e\x3c/span\x3e\u4e0e\x3cspan class\x3d"classify-search-classify-kw"\x3e\x3c/span\x3e\u76f8\u5173\u7684{{name}}\x3cspan class\x3d"classify-search-classify-target hidden"\x3e{{target}}\x3c/span\x3e\x3c/div\x3e';var classifySearch=new ClassifySearch({id:"header-search-container",searchTarget:"\u5185\u5bb9",category:cates,placeholder:"\u8bf7\u8f93\u5165",maxShowCharacter:3,enter:function(id,key){doSearch(id,key)}});dealUserAppSearch(classifySearch);classifySearch.$input.on("focus",function(){TabsNav.minAllTabs()})}function dealUserAppSearch(classifySearch){var $userItem=classifySearch.$classifyList.find('[data-id\x3d"user"]'),$appItem=classifySearch.$classifyList.find('[data-id\x3d"app"]');if(!$userItem.length||!$appItem.length)return;var $userList=$('\x3cul class\x3d"fulltext-search-user-list"\x3e\x3c/ul\x3e'),$appList=$('\x3cul class\x3d"fulltext-search-app-list"\x3e\x3c/ul\x3e');if($userItem.length){$userList.insertAfter($userItem);$userList.on("click",".fulltext-search-user-item",function(){_searchCfg.userClick&&_searchCfg.userClick(this.getAttribute("data-id"),this.title);classifySearch.$input.blur().val("");classifySearch.hidePopup()})}if($appItem.length){$appList.insertAfter($appItem);$appList.on("click",".fulltext-search-app-item",function(){var $this=$(this);$this.data("url")&&dealLinkOpen({id:$this.data("id"),name:this.title,url:$this.data("url"),openType:$this.data("opentype")});classifySearch.$input.blur().val("");classifySearch.hidePopup()})}var timer;var ignoreCodes=[13,16,17,18,27,37,38,39,40];var isSupportInput=function(){var input=document.createElement("input");return"oninput"in input}();if(isSupportInput)classifySearch.$input.on("input",function(){clearTimeout(timer);timer=setTimeout(immediatelySearch,50)});else classifySearch.$input.on("keyup",function(ev){if($.inArray(ev.which,ignoreCodes)!=-1)return;clearTimeout(timer);timer=setTimeout(immediatelySearch,50)});classifySearch.$input.on("setHistoryValue",immediatelySearch);var lastRequest;var USER_ITEM_TPL='\x3cli class\x3d"fulltext-search-user-item" data-id\x3d"{{guid}}" title\x3d"{{name}}" \x3e\x3cimg class\x3d"fulltext-search-user-item-img" src\x3d"{{portrait}}" \x3e{{{hlname}}}\x3c/li\x3e';var APP_ITEM_TPL='\x3cli class\x3d"fulltext-search-app-item" data-id\x3d"{{code}}" title\x3d"{{name}}" data-opentype\x3d"{{openType}}" data-url\x3d"{{url}}"\x3e\x3cimg class\x3d"fulltext-search-app-item-icon" src\x3d"{{icon}}"/\x3e{{{hlname}}}\x3c/li\x3e';function immediatelySearch(){var value=$.trim(classifySearch.$input.val());if(lastRequest)lastRequest.abort();if(!value)return;lastRequest=Util.ajax({url:epoint.dealRestfulUrl(_searchCfg.userModuleSearchUrl),data:{cnum:"user,app",key:value,rn:3,location:"search"}});lastRequest.done(function(res){var data=mini.decode(res.frameinfo);var userHTML=[],appsHTML=[],hlReg=new RegExp(value,"ig");data.users&&$.each(data.users,function(i,item){item.portrait=Util.getRightUrl(item.portrait);item.hlname=item.name.replace(hlReg,'\x3cspan class\x3d"fulltext-search-kw"\x3e'+value+"\x3c/span\x3e");userHTML.push(Mustache.render(USER_ITEM_TPL,item))});data.apps&&$.each(data.apps,function(i,item){item.icon=Util.getRightUrl(item.icon);item.hlname=item.name.replace(hlReg,'\x3cspan class\x3d"fulltext-search-kw" \x3e'+value+"\x3c/span\x3e");appsHTML.push(Mustache.render(APP_ITEM_TPL,item))});$(userHTML.join("")).appendTo($userList.empty());$(appsHTML.join("")).appendTo($appList.empty())})}}_MetroEvent_.on("afterPageInfo",function(){if(win._fullSearchUrl_)getCateData()})})(this,jQuery);(function(win,$){var msgCenterUrl="frame/fui/js/widgets/msgcenter/msgcenter.js";function initMsgCenter(data){var msgcenterConfig=$.extend({},MsgCenterConfig,{isMsgCenterMaxSize:data.isMsgCenterMaxSize||false,msgCenterOrder:data.msgCenterOrder||"asc",hideCallback:function(){}});var msgCenter=null;var $msgRemindBtn=$("#top-btns .msg-remind");var loadMsgCenter=function(){loadMsgCenter=Util.noop;return Util.loadJs(msgCenterUrl,function(){msgCenter=new MsgCenter(msgcenterConfig);msgCenter.show()})};$msgRemindBtn.on("click",function(){if(!msgCenter)return loadMsgCenter();if(!msgCenter.isShow)msgCenter.show();else msgCenter.hide()})}_MetroEvent_.on("afterUserInfo",function(ev){var data=ev.data;initMsgCenter(data)})})(this,jQuery);(function(win,$){var $themeBtn=$("#theme-switch");var themeSelection;var themeSelectionUrl="frame/fui/js/widgets/themeselection/themeselection.js";var loadThemeSelection=function(){loadThemeSelection=Util.noop;return Util.loadJs(themeSelectionUrl,function(){ThemeSelection._styleLoaded=true;themeSelection=new ThemeSelection({getPagesUrl:MetroDataActionUrl.getPagesUrl,savePageUrl:MetroDataActionUrl.savePageUrl,hideCallback:function(){$themeBtn.removeClass("active")}});win.themeSelection=themeSelection;themeSelection.show();$themeBtn.addClass("active");$("body").on("click",function(e){var $target=$(e.target);if(!$target.closest(".theme-selection-container, #theme-switch").length){$themeBtn.removeClass("active");themeSelection.hide()}})})};function initThemeSkin(){$themeBtn.on("click",function(){if(!themeSelection)return loadThemeSelection();if($themeBtn.hasClass("active")){$themeBtn.removeClass("active");themeSelection.hide()}else{themeSelection.show();$themeBtn.addClass("active")}})}initThemeSkin()})(this,jQuery);