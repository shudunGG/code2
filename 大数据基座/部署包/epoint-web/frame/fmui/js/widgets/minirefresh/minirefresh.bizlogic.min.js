!function(t,e){"use strict";var i=t.MiniRefreshBiz||e(t);"undefined"!=typeof module&&module.exports?exports.MiniRefreshBiz=i:"function"==typeof define&&(define.amd||define.cmd)&&define(function(){return i}),t.MiniRefreshBiz=i}("undefined"!=typeof window?window:global,function(t){"use strict";function e(t){var e=this;t=a.extend(!0,{},d,t);var i=t.template;if("string"==typeof i&&/^[.#]/.test(i)||i instanceof HTMLElement){var n=a.selector(i);n&&(i=n.innerHTML.toString()||"")}t.template=i;var s=t.theme||o;if(!s)throw new Error("错误:请检查传入的minirefresh主题是否正确!");var r=t.setting;r.container=t.container,r.down&&(r.down.callback=function(){e._pullDownCallback()}),r.up&&(r.up.callback=function(){e._pullUpCallback()}),this.container=a.selector(t.container),this.listContainer=a.selector(t.listContainer),this.options=t,this.setting=r,this._initParams(),this.instance=new s(r),this._addEvent()}var i="log",n="warn",s="error",a=window.MiniRefreshTools,o=window.MiniRefresh,r=window.Mustache,u=window.mui,l=Util.ajax,c=Util.dataProcess,h="ontouchstart"in document,p=h?"tap":"click",d={isDebug:!1,container:"#minirefresh",listContainer:"#listdata",type:"POST",initPageIndex:0,url:null,template:"#item-template",dataRequest:null,dataChange:null,itemClick:null,success:null,error:null,pullDown:null,isAutoRender:!0,itemSelector:"li",isAutoProxy:void 0,delay:0,timeout:6e3,accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},contentType:"application/x-www-form-urlencoded",headers:null,setting:{down:{},up:{isAuto:!0}}};return e.prototype={_log:function(t,e){this.options.isDebug&&console[t](e)},_initParams:function(){this.isNoMoreData=!1,this.currPage=this.options.initPageIndex,this.setting.up&&this.setting.up.isAuto&&this.currPage--},_pullDownCallback:function(){var t=this,e=this.options;this.loadingDown||(this.isPullDown=!0,this.loadingDown=!0,this.currPage=e.initPageIndex,setTimeout(function(){t._ajaxRequest()},e.delay),e.pullDown&&e.pullDown())},_pullUpCallback:function(){var t=this;this.loadingUp||(this.isPullDown=!1,this.loadingUp=!0,this.currPage++,setTimeout(function(){t._ajaxRequest()},this.options.delay))},_clearResponseEl:function(){this.options.isAutoRender&&this.listContainer&&(this.listContainer.innerHTML="")},_render:function(t){var e=this.options,i=0;if(e.isAutoRender)if(this.isPullDown&&this._clearResponseEl(),r)if(t&&Array.isArray(t)&&t.length>0){for(var n="",a=0,o=t.length;a<o;a++){var u=t[a],l="",c=e.template;c&&("string"==typeof c?l=c:"function"==typeof c&&(l=c(u))),n+=r.render(l,u),i++}""!==n&&(this.listContainer.innerHTML+=n)}else this.isNoMoreData=!0;else this.isNoMoreData=!0,this._log(s,"error***没有包含mustache文件,无法进行模板渲染");return i},_dataChangeDefault:function(t){var e=c(t,{dataPath:["custom.infoList","custom.infolist","UserArea.InfoList"]});return e.data},_ajaxRequest:function(){var t=this,e=this.options;if(!e.url)return this._log(s,"error***url无效,无法访问"),void this._errorRequest(null,null,"请求url为空!");this.currPage>e.initPageIndex?e.up=!0:e.up=!1;var i=function(i){var n="";n="function"==typeof e.url?e.url():e.url,l({isAutoProxy:e.isAutoProxy,url:n,data:i,dataType:e.dataType||"json",timeout:e.timeout,type:e.type,accepts:e.accepts,headers:e.headers,contentType:e.contentType,success:function(e){t._successRequest(e)},error:function(e,i){t._errorRequest(e,i,"请求失败!")}})};if(e.dataRequest){var a=e.dataRequest(this.currPage,function(t){i(t)});void 0!==a&&i(a)}else this._log(n,"warning***请注意dataRequest不存在,默认数据为空"),i()},_errorRequest:function(t,e,i){var n=this.options;this.isNoMoreData=!0,this._refreshState(!1),this.currPage--,this.currPage=this.currPage>=n.initPageIndex?this.currPage:n.initPageIndex,n.error&&n.error(t,e,i)},_successRequest:function(t){var e=this.options;if(!t)return this._log(n,"warning***返回的数据为空,请注意！"),this.isNoMoreData=!0,void this._refreshState(!1);this._log(i,"下拉刷新返回数据:"+JSON.stringify(t)),t=e.dataChange?e.dataChange(t):this._dataChangeDefault(t);var s=this._render(t);this.loadingMoreSuccess&&(this.loadingMoreSuccess(),this.loadingMoreSuccess=null),e.success&&"function"==typeof e.success&&e.success(t,this.isPullDown||this.currPage===e.initPageIndex),this._refreshState(s>0,s)},_refreshState:function(t,e){e=e||0,this.isPullDown&&(this.instance.endDownLoading(t,"更新"+e+"条数据"),this.isNoMoreData&&(this.instance.resetUpLoading(),this.isNoMoreData=!1)),this.instance.endUpLoading(this.isNoMoreData),this.loadingDown=!1,this.loadingUp=!1},_addEvent:function(){var t=this.listContainer,e=this.options,i=e.itemClick;"function"==typeof i&&u(t).on(p,e.itemSelector,i)},refresh:function(){var t=this.options;!t.up||this.instance.options.up.isLock?(this._clearResponseEl(),this._pullDownCallback()):this.loadingUp||(this._clearResponseEl(),this.currPage=t.initPageIndex-1,this.loadingMore())},refreshNosense:function(){var t=this.currPage,e=this.options,i=e.initPageIndex,s=e.dataChange,a=e.template,o=this,u="",c="",h="",p=[];u="function"==typeof e.url?e.url():e.url;var d=function(t){return l({isAutoProxy:e.isAutoProxy,url:u,data:t,dataType:e.dataType||"json",timeout:e.timeout,type:e.type,accepts:e.accepts,headers:e.headers,contentType:e.contentType})};if(e.dataRequest)for(;i<=t;i++){var f=e.dataRequest(i,function(t){p.push(d(t))});void 0!==f&&p.push(d(f))}else this._log(n,"warning***请注意dataRequest不存在,默认数据为空"),p.push(d());Promise.all(p).then(function(t){t&&Array.isArray(t)&&t.forEach(function(t){var e="";if(e=s?s(t):o._dataChangeDefault(t),a&&("string"==typeof a?h=a:"function"==typeof a&&(h=a(e))),r&&e&&Array.isArray(e)&&e.length>0)for(var i=0,n=e.length;i<n;i++)c+=r.render(h,e[i])}),o.listContainer.innerHTML=c})},_ajaxRequestNosense:function(){var t=this,e=this.options,i="";this.currPage>e.initPageIndex?e.up=!0:e.up=!1;var s=e.dataChange,a=function(n){var a="";a="function"==typeof e.url?e.url():e.url,l({isAutoProxy:e.isAutoProxy,url:a,data:n,dataType:e.dataType||"json",timeout:e.timeout,type:e.type,accepts:e.accepts,headers:e.headers,contentType:e.contentType,success:function(n){if(n=s?e.dataChange(n):t._dataChangeDefault(n),n&&Array.isArray(n)&&n.length>0)for(var a=0,o=n.length;a<o;a++){var u=n[a],l="",c=e.template;c&&("string"==typeof c?l=c:"function"==typeof c&&(l=c(u))),i+=r.render(l,u)}},error:function(e,i){t._errorRequest(e,i,"请求失败!")}})};if(e.dataRequest){var o=e.dataRequest(this.currPage,function(t){a(t)});void 0!==o&&a(o)}else this._log(n,"warning***请注意dataRequest不存在,默认数据为空"),a()},loadingMore:function(t){this.loadingMoreSuccess=t,this.isNoMoreData&&(this.instance.resetUpLoading(),this.isNoMoreData=!1),this.instance.triggerUpLoading()},refreshSetting:function(t){this.setting=a.extend(!0,{},this.setting,t),this.instance.refreshOptions(this.setting)},destroy:function(){u(this.listContainer).off(),this.container=null,this.listContainer=null,this.instance=null,this.options=null}},e});