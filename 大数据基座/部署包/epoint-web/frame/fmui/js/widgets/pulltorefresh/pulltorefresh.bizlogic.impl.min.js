!function(e){"use strict";function t(e){if(null==e||"string"!=typeof e)return null;var t,s=document.createElement("div"),i=document.createDocumentFragment();for(s.innerHTML=e;t=s.firstChild;)i.appendChild(t);return i}function s(t){var s=this;t=e.extend(!0,{},a,t);var i=t.template;if("string"==typeof i&&/^[.#]/.test(i)||i instanceof HTMLElement){var n=e.selector(i);n&&(i=n.innerHTML.toString()||"")}t.template=i;var o=null;switch(t.skin){case"type1":o=PullToRefreshTools.skin.type1;break;case"type2":o=PullToRefreshTools.skin.type2;break;case"type3":o=PullToRefreshTools.skin.type3;break;case"type4":o=PullToRefreshTools.skin.type4;break;case"type5":o=PullToRefreshTools.skin.type5;break;case"native":o=PullToRefreshTools.skin["native"];break;default:o=PullToRefreshTools.skin.defaults}if(!o)throw new Error("错误:传入的下拉刷新皮肤错误,超出范围!");var r=t.setting;r.container=t.container,r.down&&(r.down.callback=function(){s._pullDownCallback()}),r.up&&(r.up.callback=function(){s._pullUpCallback()}),this.container=e.selector(t.container),this.listContainer=e.selector(t.listContainer),this.options=t,this.setting=r,this._initParams(),this.instance=new o(r),this._addEvent()}var i=Util.dataProcess,n="ontouchstart"in document,o=n?"tap":"click",a={isDebug:!1,container:"#pullrefresh",listContainer:"#listdata",type:"POST",initPageIndex:0,pageSize:10,url:null,template:"#item-template",dataRequest:null,dataChange:null,itemClick:null,success:null,error:null,refresh:null,isAutoRender:!0,itemSelector:"li",delay:0,timeout:6e3,accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},contentType:"application/x-www-form-urlencoded",headers:null,setting:{down:{isSuccessTips:!0},up:{auto:!0}}};s.prototype={_initParams:function(){this.isShouldNoMoreData=!0,this.currPage=this.options.initPageIndex,this.setting.up&&this.setting.up.auto&&this.currPage--},_pullDownCallback:function(){var e=this,t=this.options;this.loadingDown||(this.isPullDown=!0,this.loadingDown=!0,this.currPage=t.initPageIndex,setTimeout(function(){e._ajaxRequest()},t.delay),t.refresh&&t.refresh(!0))},_pullUpCallback:function(){var e=this;this.loadingUp||(this.isPullDown=!1,this.loadingUp=!0,this.currPage++,setTimeout(function(){e._ajaxRequest()},this.options.delay))},_clearResponseEl:function(){this.options.isAutoRender&&this.listContainer&&(this.listContainer.innerHTML="")},_render:function(e){var s=this.options,i=0;if(s.isAutoRender)if(this.isPullDown&&this._clearResponseEl(),window.Mustache)if(e&&Array.isArray(e)&&e.length>0){for(var n="",o=0,a=e.length;o<a;o++){var r=e[o],l="";s.template&&("string"==typeof s.template?l=s.template:"function"==typeof s.template&&(l=s.template(r))),n+=Mustache.render(l,r),i++}""!=n&&this.listContainer.appendChild(t(n))}else this.isShouldNoMoreData=!1;else this.isShouldNoMoreData=!1,s.isDebug&&console.error("error***没有包含mustache文件,无法进行模板渲染");return i},_dataChangeDefault:function(e){var t=i(e,{dataPath:["custom.infoList","custom.list","UserArea.InfoList"]});return t.data},_ajaxRequest:function(){var e=this,t=this.options;if(!t.url)return t.isDebug&&console.error("error***url无效,无法访问"),void this._errorRequest(null,null,"请求url为空!");var s=function(s){var i="";i="function"==typeof t.url?t.url():t.url,Util.ajax({url:i,data:s,dataType:"json",timeout:t.timeout,type:t.type,accepts:t.accepts,headers:t.headers,contentType:t.contentType,success:function(t){e._successRequest(t)},error:function(t,s){e._errorRequest(t,s,"请求失败!")}})};if(t.dataRequest){var i=t.dataRequest(this.currPage,function(e){s(e)});void 0!==i&&s(i)}else t.isDebug&&console.warn("warning***请注意dataRequest不存在,默认数据为空"),s()},_errorRequest:function(e,t,s){var i=this.options;this.isShouldNoMoreData=!1,this._refreshState(!1),this.currPage--,this.currPage=this.currPage>=i.initPageIndex?this.currPage:i.initPageIndex,i.error&&i.error(e,t,s)},_successRequest:function(e){var t=this.options;if(this.options.ajaxResponse=e,!e)return t.isDebug&&console.log("warning***返回的数据为空,请注意！"),this.isShouldNoMoreData=!1,void this._refreshState(!1);t.isDebug&&console.log("下拉刷新返回数据:"+JSON.stringify(e)),e=t.dataChange?t.dataChange(e):this._dataChangeDefault(e);var s=this._render(e);this.loadingMoreSuccess&&(this.loadingMoreSuccess(),this.loadingMoreSuccess=null),t.success&&"function"==typeof t.success&&t.success(e,this.isPullDown||this.currPage==t.initPageIndex,this.options.ajaxResponse),this._refreshState(!0,s)},_refreshState:function(e,t){var s=this.instance;t=t||0,s.setSuccessTips&&s.setSuccessTips("刷新成功"),this.isPullDown&&(s.endPullDownToRefresh(e),s.finished&&(s.refresh(!0),this.isShouldNoMoreData=!0)),this.isShouldNoMoreData?s.endPullUpToRefresh(!1,e):s.endPullUpToRefresh(!0,e),this.loadingDown=!1,this.loadingUp=!1},_addEvent:function(){var e=this.listContainer,t=this.options,s=t.itemClick;"function"==typeof s&&mui(e).on(o,t.itemSelector,s)},refresh:function(){var e=this.options;e.up&&this.instance.enablePullUp?this.loadingUp||(this._clearResponseEl(),this.currPage=e.initPageIndex-1,this.loadingMore()):(this._clearResponseEl(),this._pullDownCallback())},loadingMore:function(e){var t=this.instance;this.loadingMoreSuccess=e,this.instance.finished&&(this.instance.refresh(!0),this.isShouldNoMoreData=!0),t.pullupLoading()},disablePullupToRefresh:function(){this.pullToRefreshInstance.disablePullupToRefresh()},enablePullupToRefresh:function(){this.pullToRefreshInstance.enablePullupToRefresh()},destroy:function(){mui(listContainer).off(),this.container=null,this.listContainer=null,this.instance=null,this.options=null}},e.namespace("bizlogic",s)}(PullToRefreshTools);