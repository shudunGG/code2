<!DOCTYPE html>
<html>

<head>
    <title>个人信息审核表工作流</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <!-- 请修改相对路径 -->
    <script src="../../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
<div class="page-loading"></div>

<!-- toolbar区域 -->
<div class="fui-toolbar">
    <div class="uc-handlecontrols" id="handlecontrols" action="handleCtrl"
         style="width: 100%"></div>
</div>

<div class="fui-content">
    <div class="fui-accordions">
        <div role="accordion" opened="true">
            <div role="head" title="表单填写"></div>
            <div role="body">
                <!-- 隐藏按钮id不能修改 -->
                <div class="hidden">
                    <a class="mini-button" id="btnSaveFrom" onclick="saveFrom">保存</a>
                    <a class="mini-button" id="btnSubmit" onclick="submit">提交</a>
                </div>

                <!-- 内容区域 -->
                <div id="fui-form" class="fui-form">
                    <div role="row">
                        <div role="control" label="出生日期">
                            <div class="mini-datepicker" bind="dataBean.birthday" id="birthday"
                                 allowInput="false" dateFormat="yyyy-MM-dd"
                                 data-options='{"format":"yyyy-MM-dd"}' required="true"></div>
                        </div>
                        <div role="control" label="车牌号">
                            <div id="carnum" class="mini-textbox" bind="dataBean.carnum" vtype="maxLength:10"></div>
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="备注">
                            <div id="description" class="mini-textbox" bind="dataBean.description" vtype="maxLength:100"></div>
                        </div>
                        <div role="control" label="用户名字">
                            <div id="displayname" class="mini-textbox" bind="dataBean.displayname"></div>
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="Email">
                            <div id="email" class="mini-textbox" bind="dataBean.email" vtype="email"></div>
                        </div>
                        <div role="control" label="传真">
                            <div id="fax" class="mini-textbox" bind="dataBean.fax" onvalidation="onFaxValidation"></div>
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="身份证">
                            <div id="identitycardnum" class="mini-textbox" bind="dataBean.identitycardnum" vtype="idCard"></div>
                        </div>
                        <div role="control" label="登录标识">
                            <div id="loginid" class="mini-textbox" bind="dataBean.loginid"></div>
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="地址">
                            <div id="postaladdress" class="mini-textbox" bind="dataBean.postaladdress"></div>
                        </div>
                        <div role="control" label="邮政编码">
                            <div id="postalcode" class="mini-textbox" bind="dataBean.postalcode"></div>
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="qq号">
                            <div id="qqnumber" class="mini-textbox" bind="dataBean.qqnumber" onvalidation="onQQValidation"></div>
                        </div>
                        <div role="control" label="性别">
                            <div class="mini-combobox" action="sexModel" id="sex" bind="dataBean.sex" textField="text"
                                 valueField="id" emptyText="请选择..."></div>
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="办公室电话">
                            <div id="telephoneoffice" class="mini-textbox" bind="dataBean.telephoneoffice"></div>
                        </div>
                        <div role="control" label="职务">
                            <div id="title" class="mini-textbox" bind="dataBean.title" vtype="maxLength:50"></div>
                        </div>
                    </div>
                    <div role="row">
                        <div role="control" label="手机">
                            <div id="mobile" class="mini-textbox" bind="dataBean.mobile"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div role="accordion">
            <div role="head" title="相关附件"></div>
            <div role="body">
                <div class="uc-workflowattach" id="workflowattach"
                     action="attachCtrl" style="width: 100%;"></div>
            </div>
        </div>
        <div role="accordion">
            <div role="head" title="签署意见"></div>
            <div role="body">
                <!--
                    showmode(显示意见模板模式)
                       1:(默认)显示意见模板区域，但仅显示个人意见模板
                       2:显示意见模板区域，显示公共和个人意见模板
                       3:不显示意见模板区域
                -->
                <div class="uc-workflowopinion" id="workflowopinion"
                     action="opinionCtrl" data-options="{showmode : 1}"
                     style="width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 请修改相对路径 -->
<script src="../../../../rest/resource/jsboot"></script>
<script>
    SrcBoot.output(['frame/pages/epointworkflow/js/workflowjsboot.js',
        'frame/pages/epointworkflow/js/tableproperty.js']);
</script>

<script>
    //初始化页面
    epoint.initPage('frameuserinfoauditworkflowaction', '', function (data) {
        setControlsAccessRight(data);
        if (data.fielddisabled && "true" == data.fielddisabled) {
            var miniForm = new mini.Form('#fui-form');
            miniForm.getFields().forEach(function(item) {
                item.setEnabled(false);
            });

        }
    });


    function saveFrom() {
        var ids = validateIds();
        if (epoint.validate(ids)) {
            epoint.execute('saveForm', 'fui-form', newCallback);
        } else
            ShowTdOperate(true);
    }

    function submit() {
        var ids = validateIds();
        if (epoint.validate(ids)) {
            epoint.execute('submit', 'fui-form', newCallback);
        } else
            ShowTdOperate(true);
    }

    // 新增操作的回调,必须回调handlecontrols中的HeaderSubmit触发流程流转
    function newCallback(data) {
        if (data && data.msg) {
            epoint.alert(data.msg, '', null, 'info');
            ShowTdOperate(true);
        } else {
            HeaderSubmit();
        }
    }

    // 脱敏字段
    var clearIds = ['carnum','email','fax','identitycardnum','postaladdress','address','qqnumber','mobile'];
    var activeControl, activeControlValue;
    $('body').on('click', '.form-control > :first-child', function(e) {
        var controlEl = this;

        if (controlEl && controlEl.id) {
            e.stopPropagation();
            var c = mini.get(controlEl.id);
            if (c && c.getEnabled() == false) {
                return;
            }
            if (activeControl) {
                var idIndex = $.inArray(activeControl.id, clearIds);
                if (idIndex >= 0) {
                    if(activeControl.getValue() == ''){
                        activeControl.setValue(activeControlValue);
                    }
                    activeControl.removeCls(clearIds[idIndex]);
                }
            }

            if (c) {
                var idIndex = $.inArray(c.id, clearIds);
                if(idIndex < 0 || (idIndex >= 0 && !$(c.el).hasClass(clearIds[idIndex]))){
                    activeControl = c;
                    activeControlValue = c.getValue();
                    if (idIndex >= 0) {
                        c.addCls(clearIds[idIndex]);
                        mini.get(clearIds[idIndex]).setValue('');
                    }
                }
            }
        }
    })
    .on('click', function(e) {
        // 空白处点击
        if (activeControl) {
            // 验证不通过时值还原
            if (activeControl.validate
                && !activeControl.validate()) {
                activeControlValue
                && activeControl
                    .setValue(activeControlValue);
            }
            var idIndex = $.inArray(activeControl.id, clearIds);
            if (idIndex >= 0) {
                if(activeControl.getValue() == ''){
                    activeControl.setValue(activeControlValue);
                }
                activeControl.removeCls(clearIds[idIndex]);
            }
        }
    });

    //isQQ
    function isQQ(v) {
        var re = new RegExp(/[1-9][0-9]{4,}/);
        if (re.test(v))
            return true;
        return false;
    }

    //QQ验证
    function onQQValidation(e) {
        if (e.isValid) {
            if (e.value && isQQ(e.value) == false) {
                e.errorText = "请输入正确QQ号码";
                e.isValid = false;
            }
        }
    }

    //isFax
    function isFax(v) {
        var re = new RegExp(/^((\d{3,4}-)?\d{7,8})$/);
        if (re.test(v))
            return true;
        return false;
    }

    //fax验证
    function onFaxValidation(e) {
        if (e.isValid) {
            if (e.value && isFax(e.value) == false) {
                e.errorText = "请输入正确的传真号";
                e.isValid = false;
            }
        }
    }

    // 获取需要验证的字段
    function validateIds(){
        var form = new mini.Form("fui-form");
        var fields = form.getFields();
        var ids = [];
        // 包含*号的字段不验证
        fields.forEach(function(item) {
            var itemvalue = item.getValue();
            if (typeof itemvalue == "string" && itemvalue.indexOf("*")<0) {
                ids.push(item.id);
            }
        });
        return ids;
    }
</script>

</body>

</html>