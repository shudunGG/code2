<!DOCTYPE html>
<html>

<head>
<title>E讯聊天记录</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />

<script src="../../../../../frame/fui/js/cssboot.js"></script>
</head>
<body>
	<!-- 等待提示框 -->
	<div class="page-loading"></div>

	<!-- 左侧树 -->
	<div class="fui-left">
		<div role="head" title="在线人员"></div>
		<div role="body">
			<ul id="tree" class="mini-tree" style="height: 100%" textField="text"
				idField="id" parentField="pid" action="getTreeData"
				resultAsTree="false"></ul>
		</div>
	</div>


	<!-- 右侧内容区域 -->
	<div class="fui-right">

		<!-- 按钮区域 -->
		<div class="fui-toolbar">
			<a class="mini-button" state="danger" onclick="deleteSelect">删除选中</a>
		</div>

		<!-- 条件区域 -->
		<div class="fui-search" opened="false" primaryControl="content">
			<div class="fui-form" id="fui-form">
				<div role="form">
					<div role="row">
						<div role="control" label="时间">
							<input name="dateFrom" id="time1" class="mini-datepicker"
								style="width: 44%;" format="yyyy-MM-dd H:mm:ss"
								timeFormat="H:mm:ss" showTime="true" bind="dateFrom"
								showClearButton="true" onValuechanged="validateDate(this)" /> <span
								style="width: 12%; text-align: center">至</span> <input
								name="dateTo" id="time2" class="mini-datepicker"
								style="width: 44%;" format="yyyy-MM-dd H:mm:ss"
								timeFormat="H:mm:ss" showTime="true" bind="dateTo"
								showClearButton="true" onValuechanged="validateDate(this)" />
						</div>
						<div role="control" label="内容">
							<div class="mini-textbox" bind="content" id="content"></div>
						</div>
					</div>
					<div role="row">
						<div role="control" label="发送人">
							<div class="mini-textbox" bind="fromUserDisplayName"></div>
						</div>
						<div role="control" label="接收人">
							<div class="mini-textbox" bind="toUserDisplayName"></div>
						</div>
					</div>
				</div>
			</div>
			<!-- 搜索按钮 -->
			<a role="searcher" callback="searchData"></a>
		</div>


		<!-- 内容区域 -->
		<div class="fui-content">
			<div id="datagrid" name="datagrid" class="mini-datagrid"
				idField="messageguid" multiSelect="true"
				style="width: 100%; height: 100%;" allowResize="true"
				showPager="true" action="getDataGridData" allowCellEdit="true"
				allowCellSelect="true" editNextOnEnterKey="true"
				editNextRowCell="true">
				<div property="columns">
					<div type="checkcolumn" width="40"></div>
					<div type="indexcolumn" width="40" headerAlign="center">序</div>
					<div field="fromUserDisplayName">发送人</div>
					<div field="toUserDisplayName">接收人</div>
					<div field="content" width="30%" validateLevel="3">内容</div>
					<div field="sendTime"
						data-options="{'format' : 'yyyy-MM-dd HH:mm:ss'}"
						dateFormat="yyyy-MM-dd HH:mm:ss">发送时间</div>
				</div>
			</div>
		</div>
	</div>

	<script src="../../../../../rest/resource/jsboot"></script>

	<script>
		//<![CDATA[  
		//初始化页面
		epoint.initPage("exunmessagelist");

		//树js对象
		var tree = mini.get("tree");

		//删除选中行
		function deleteSelect() {
			var datagrid = mini.get('datagrid');
			var ids = datagrid.getSelectedIds();
			if (ids.length > 0) {
				epoint.confirm("确定删除选中记录？", "", function(action) {
					epoint.execute("exunmessagelist.delete", "", [ ids
							.join(',') ], function(data) {
						if (data.msg) {
							epoint.alert(data.msg, null, null, 'info');
							epoint
									.refresh([ 'datagrid', 'fui-form' ], '',
											true);
						}
					});
				});
			} else {
				epoint.alert("请选择要删除的记录!", null, null, 'warning');
			}
		}

		// 表格的搜索
		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		}

		//点击树节点刷新表格
		tree.on("nodeclick", function(e) {
			if (e.node) {
				var isSubNode = e.node.isSubNode;
				if (isSubNode == 'true') {
					var id = e.node.id;
					//打开聊天窗口
					top.OpenEMsg(id);
				}
			}
		});

		//　日期控件的验证
		var start = mini.get("time1");
		var end = mini.get("time2");

		function validateDate(e) {
			if (start.getValue() && end.getValue()) {
				if (!epoint.validateDateInterval(start, end, 0)) {
					if (e.id == 'time1') {
						epoint.alert("开始时间不能大于结束时间！", null, null, 'warning');
						start.setValue(null);
					} else {
						epoint.alert("结束时间不能小于开始时间！", null, null, 'warning');
						end.setValue(null);
					}
				}
			}
		}

		//]]>
	</script>

</body>
</html>