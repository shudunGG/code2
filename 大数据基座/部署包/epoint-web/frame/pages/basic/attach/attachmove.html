<!DOCTYPE html>
<html>

<head>
<title>附件迁移</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<script src="../../../../frame/fui/js/cssboot.js"></script>
</head>

<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>
	<div class="fui-left">
		<div role="head" title="选择数据源"></div>
		<div role="body">
			<ul id="tree" class="mini-tree" style="height: 100%" textField="text"
				idField="id" parentField="pid" action="getTreeData"
				resultAsTree="false"></ul>
		</div>
	</div>
	<div class="fui-right">
		<!-- toolbar区域 `-->
		<div class="fui-toolbar">
			<div class="mini-btn-group">
				<a class="mini-button" state="primary" onclick="moveAttachList">转移附件</a>
			</div>
			<div text="是否删除源数据" class="mini-checkbox" checked="true"
				onvaluechanged="onValueChanged"></div>
		</div>

		<!-- 条件区域 -->
		<div class="fui-search" primaryControl="attachFileName" opened="false">
			<div class="fui-form" id="fui-form" style="margin-right: 100px">
				<div id="cform" role="form">
					<div role="row">
						<div role="control" label="附件guid">
							<input class="mini-textbox" bind="attachGuid" />
						</div>
						<div role="control" label="附件名称">
							<input id="attachFileName" class="mini-textbox"
								bind="attachFileName" />
						</div>
					</div>
					<div role="row">
						<div role="control" label="业务主键">
							<input class="mini-textbox" bind="cliengGuid" />
						</div>
						<div role="control" label="业务标签">
							<input class="mini-textbox" bind="cliengTag" />
						</div>
					</div>
					<div role="row">
						<div role="control" label="应用信息">
							<input class="mini-combobox" action="selectAppModel"
								bind="appKey" allowInput="true" />
						</div>
						<div role="control"></div>
					</div>
				</div>
				<input id="attachConnectionStringName"
					bind="attachConnectionStringName" class="mini-hidden" /> <input
					id="times" class="mini-hidden" bind="times" /> <input
					id="newConfigName" class="mini-hidden" /> <input id="isDelOld"
					class="mini-hidden" value="false" />
			</div>
			<a role="reset" callback="resetCallback"></a> <a role="searcher"
				callback="searchData"></a><a role="close" callback="closeCallback"></a>
		</div>
		<div id="fuiContent" class="fui-content">
			<div id="datagrid" class="mini-datagrid" idField="attachguid"
				action="getDataGridData" sortOrder="desc" showPager="true"
				style="height: 100%;" allowResize="true" multiSelect="true"
				allowCellEdit="true" allowCellSelect="true"
				editNextOnEnterKey="true" editNextRowCell="true">
				<div property="columns">
					<div type="checkcolumn" width="40"></div>
					<div type="indexcolumn" width="40" align="left">序</div>
					<div field="attachfilename" width="200">附件名称</div>
					<div field="contenttype" width="150">文件类型</div>
					<div field="attach_connectionstringname" width="200">数据源名称</div>
					<div field="filepath" width="100%">路径</div>
					<div field="attachguid" width="300">附件guid</div>
					<div field="cliengguid" width="300">业务主键</div>
					<div field="cliengtag" width="100">业务标签</div>
					<div field="appName" width="100">应用信息</div>
				</div>
			</div>
		</div>
	</div>
	<div id="info-box" class="mini-window mini-messagebox" title="进度提醒"
		style="width: 400px; height: 250px; display: none;"
		showMaxButton="false" showCollapseButton="false" showShadow="true"
		showToolbar="false" showFooter="true" showModal="true"
		allowResize="false" allowDrag="false">
		<i class="mini-messagebox-icon mini-messagebox-info" style=""></i>
		<div style="margin-left: 60px; height: 50px; margin-top: 60px;">
			<div id="info-box-moving">
				<div id="move-progressbar" class="mini-progressbar" value="0"></div>
				<p>
					文件转移中，当前第<span id="info-box-curr"></span> 个，共 <span
						id="info-box-all"></span> 个。
				</p>
			</div>
			<div id="info-box-pausing" style="display: none;">
				<p>转移已暂停。</p>
			</div>
		</div>

		<div property="footer"
			style="text-align: right; padding: 5px; padding-right: 15px;">
			<a class="mini-button" id="restart-moveing" onclick="reStart"
				style="display: none;">继续</a> <a class="mini-button"
				id="cancel-moveing" onclick="cancelMove">停止</a>
		</div>
	</div>

	<script src="../../../../rest/resource/jsboot"></script>
	<script>
		// 初始化页面
		epoint.initPage('attachinfolistaction', '', function() {
			mini.get('isDelOld').setValue(true);
		});

		// 表格的搜索
		function searchData() {
			epoint.refresh([ 'datagrid', 'fui-form' ]);
		}
		//树js对象
		var tree = mini.get("tree");
		// 点击左侧树刷新右侧表格
		tree.on("nodeselect", function(e) {
			if (e.node) {
				var text = e.node.text;
				//将左侧树点击的节点id放到隐藏域中
				mini.get('attachConnectionStringName').setValue(
						text == '数据源' ? "" : text);
			}
			//刷新表格
			searchData();
		});

		// 弹出数据源选择窗口
		function moveAttachList() {
			var attachConnectionStringName = epoint.encode(mini.get(
					'attachConnectionStringName').getValue());
			epoint.openDialog('选择数据源',
					"frame/pages/basic/attach/selectattachconfig?attachConnectionStringName="
							+ attachConnectionStringName,
					selectAttachListOperJS, {
						'width' : 300,
						'height' : 550
					});
		}
		function selectAttachListOperJS(rtnValue) {
			if (rtnValue && rtnValue != 'close') {
				mini.get('newConfigName').setValue(rtnValue);
				epoint.execute('check', '', rtnValue, checkCallBack1);
			}
		}
		function checkCallBack1(rtnValue) {
			console.log(rtnValue);
			if (rtnValue.message) {
				epoint.showTips(rtnValue.message,{state : 'info'});
				return;
			}
			if (rtnValue.msg) {
				mini.prompt(rtnValue.msg, "请输入", function(action, value) {
					if (action == "ok") {
						mini.get("times").setValue(value);
						var newConfigName = mini.get("newConfigName")
								.getValue();
						epoint.execute("check", '', newConfigName,
								checkCallBack);
					} else {
						return;
					}
				});
			} else {
				checkCallBack(rtnValue);
			}
		}
		// 提示区域
		var infoBox = mini.get('info-box');
		// 进度条
		var progressbar = mini.get('move-progressbar');
		// 总数
		var $infoCountAll = $('#info-box-all'),
		// 当前数据
		$infoCountCurr = $('#info-box-curr'),
		// 转移中提示
		$moveingTips = $('#info-box-moving'),
		// 暂停中提示
		$pausingTips = $('#info-box-moving');

		//var IS_PAUSED = false;

		function checkCallBack(rtnValue) {
			//IS_PAUSED = false;

			// 有文件需要转移才显示
			if (!rtnValue.totalcount)
				return;
			// 初始记录总数初始为1
			var all = rtnValue.totalcount;
			$infoCountAll.text(all);
			$infoCountCurr.text(1);
			// 显示提示
			infoBox.show();
			var countmove = setInterval(function() {
				countMoveCallback();
			}, 1000);
			var dataUrl = epoint
					.dealRestfulUrl('attachinfolistaction/moveAttachList');
			var isDelOld = mini.get('isDelOld').getValue();
			Util.ajax({
				type : 'POST',
				dataType : 'json',
				url : dataUrl,
				data : {
					"isDelOld" : isDelOld
				},
				success : function(data) {
					console.log('success');
				}
			});

			function countMoveCallback() {
				var dataUrl = epoint
						.dealRestfulUrl('attachinfolistaction/countAttachMoveLeft');
				Util.ajax({
					type : 'POST',
					dataType : 'json',
					url : dataUrl,
					success : function(amountleft) {
						// 未完成则更新当前计数和进度条
						// 总的-剩余即为当前
						var curr;
						if (amountleft.length == 0) {
							curr = all - 1;
						} else {
							curr = all - amountleft;
						}
						console.log(curr);
						var progress = parseFloat(
								(curr / all * 100).toFixed(2), 10);
						progressbar.setValue(progress);
						$infoCountCurr.text(curr);

						// 已经暂停
						/* if (IS_PAUSED) {
							//$moveingTips.hide();
							//$pausingTips.show();
						} */
						if (amountleft <= 0) {
							clearInterval(countmove);
							// 转移完成
							epoint.execute('countFailedAttach', '', '',
									function(e) {
										// 隐藏提示框
										infoBox.hide();
										if (e != 0) {
											epoint.showTips('转移结束，有' + e
													+ '个文件转移失败，详情请查看后台日志', {state : 'warning'});
										} else {
											epoint.showTips('转移结束', {state : 'success'});
										}
										mini.get("times").setValue(0);
										searchData();
										progressbar.setValue(0);
									});
						}
					}
				});

			}

			/* // 继续方法
			window.reStartMove = function(n) {
				//$moveingTips.show();
				//$pausingTips.hide();
				//countMoveCallback(n);
			} */
		}

		//var pauseBtn = mini.get('pause-moveing'), restartBtn = mini
		//		.get('restart-moveing');

		/* function pauseMove() {
			// 暂停
			// 发一个请求到后端 成功后设置IS_PAUSED = true;
			//epoint.execute('pauseMove', '', '', function() {
			//	pauseBtn.hide();
			//	restartBtn.show();
			//	IS_PAUSED = true;
			});
		} */

		/* function reStart() {
			// 开始
			// 重新开始转移并返回当前的未转移到数目
			pauseBtn.show();
			restartBtn.hide();
			var dataUrl = epoint.dealRestfulUrl('attachinfolistaction/reStart');
			Util.ajax({
				type : 'POST',
				dataType : 'json',
				url : dataUrl,
				success : function(data) {
					console.log('restartsuccess');
					IS_PAUSED = false;
					reStartMove(n);
				}
			});
		} */
		function cancelMove() {
			// 转移完成
			epoint.execute('cancelMove', '', '', function(e) {

			});
		}
		//　日期控件的验证
		var start = mini.get("dateFrom");
		var end = mini.get("dateTo");

		function validateDate(e) {
			if (start.getValue() && end.getValue()) {
				if (!epoint.validateDateInterval(start, end, 0)) {
					if (e.id == 'dateFrom') {
						epoint.showTips("起始时间不能大于终止时间!", {state : 'warning'});
						start.setValue(null);
					} else {
						epoint.showTips("终止时间不能小于起始时间!",  {state : 'warning'});
						end.setValue(null);
					}
				}
			}
		}
		function onValueChanged() {
			var checked = this.checked;
			mini.get('isDelOld').setValue(checked);
		}
	</script>
</body>

</html>
