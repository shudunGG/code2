<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"></meta>
<meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
<title>API预警列表</title>
<script src="../../../../../fui/js/cssboot.js"></script>
</head>
<body>
	<div class="page-loading"></div>
	
	<div class="fui-left">
		<!-- 左侧的内容区域 -->
		<div role="body">
			<ul id="tree" class="mini-tree" style="height: 100%" textField="text"
				idField="id" parentField="pid" action="getTreeData"
				expandOnLoad="true" resultAsTree="false">
			</ul>
		</div>
	</div>

	<!-- 左右布局页面的右侧内容 -->
	<div class="fui-right" id="fui-right">
		<!-- 条件区域 -->
		<div class="fui-condition">
			<div class="fui-form" id="fui-form">
				<div id="cform" role="form">
					<div role="row">
						<div role="control" label="API名称">
							<input id="apiname" class="mini-textbox" bind="apiName" />
						</div>
					</div>
				</div>
				<!-- 添加隐藏域，用于树与表格的联动 -->
				<input bind="categoryid" id="search_categoryid" class="mini-hidden" />
			</div>
			<a role="searcher" callback="searchData"></a>
		</div>
	
		<div class="fui-content">
			<div class="fui-content">
				<div id="datagrid" name="datagrid" class="mini-datagrid"
					idField="rowguid" multiSelect="true"
					style="width: 100%; height: 100%;" allowResize="true"
					showPager="true" action="getDataGridData">
					<div property="columns">
						<div type="indexcolumn" width="60" headerAlign="center">序</div>
						<div field="subjectname" headerAlign="center" width="100%">API名称</div>
						<div field="alerttotalnumber" headerAlign="center" align="center" width="130">总预警次数</div>
						<div field="recentalertnumber" headerAlign="center" align="center" width="130">近24小时预警次数</div>
						<div headerAlign="center" align="center" width="80" renderer="onAlertDetailRenderer">预警信息</div>
						<div headerAlign="center" align="center" width="80" renderer="onApiDetailRenderer">查看API</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="../../../../../../rest/resource/jsboot"></script>
	<script>
		epoint.initPage('apialertinfolistaction');
		
		//绘制预警信息操作列
		var onAlertDetailRenderer = function(e) {
			var html = '<a href="javascript:void(0);" onclick="handleAlertInfoList(\''
				+ e.row.subjectguid
				+ '\');" class="action-icon icon-doc" title="预警信息列表"></a>&nbsp;';
			return html;
		};
		
		//绘制查看API操作列
		var onApiDetailRenderer = function(e) {
			var html = '<a href="javascript:void(0);" onclick="openApiDetail(\''
				+ e.row.subjectguid
				+ '\');" class="action-icon icon-search" title="查看API"></a>&nbsp;';
			return html;
		};
		
		// 弹出API预警信息列表
		function handleAlertInfoList(subjectguid) {
			var url = 'frame/pages/basic/gateway/api/apiinfo/alertinfolist?subjectguid='+subjectguid;
			epoint.openDialog("预警信息列表", url, searchData, {
				'width' : 1500,
				'height' : 1000
			});
		}

		// API详情窗口
		function openApiDetail(id) {
			epoint.openDialog('查看API',
					"frame/pages/basic/gateway/api/apiinfo/apiinfodetail?guid="
							+ id + "&isdetail=1", null);
		}

		// 表格的搜索
		function searchData() {
			epoint.refresh(['datagrid','fui-form']);
		}

		//树js对象
		var tree = mini.get("tree");
		// 点击左侧树刷新右侧表格
		tree.on("nodeselect", function(e) {
			var id = e.node.id;
			// 将左侧树点击的节点id放到隐藏域中
			// 在表格发二次请求时，会自动带上条件区域中的内容
			mini.get('search_categoryid').setValue(id == 'f9root' ? "" : id);
			//刷新表格
			searchDataExcludeTree();
		});

		// 表格的搜索
		function searchDataExcludeTree() {
			epoint.refresh([ 'datagrid', 'fui-form' ], '', true);
		}
	</script>
</body>
</html>