<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>办公配置</title>
    <script src="../../../../../frame/fui/js/cssboot.js"></script>
    <script>
        SrcBoot.output([
            './css/officecfg.css'
        ]);
    </script>
    <script>
        SrcBoot.outputCustomSkin("./skins/officecfg/");
    </script>
</head>

<body>
    <!-- 个性签名的图片上传 -->
    <div id="uploader2" class="mini-webuploader" action="myinfomodifyaction.getFileUploadModel2" fileSingleSizeLimit="2048" limitType="jpeg,jpg,gif,png,bmp"
        mimeTypes="image/*" showDefaultUI="false" auto="true" pickerText="请上传" onfilesuccess="onSignFileSuccess" style="position:absolute;top:-50px;"></div>
    <div class="fui-content" style="padding:0 20px;">
        <div class="scroll-container">
        <div class="cate-header fui-theme-main-color">个性签名图</div>
        <div class="signature office-cfg-box">
            <div class="signature-box empty" id="signature-box">
                <img class="signature-img" id="signature-img">
                <span class="signature-upload-btn" id="signature-upload-btn">点击更换</span>
            </div>
            <div class="signature-help">
                <p class="info">您亲笔书写的个人姓名，主要用作签名者的身份证明，提高文件落款的可信度</p>
                <p class="limit">最佳图片尺寸：220*80像素</p>
                <p class="limit">图片大小在2M以内</p>
            </div>
        </div>
        <div class="cate-header fui-theme-main-color">我的意见</div>
        <div class="office-cfg-box my-opinion" id="my-opinion">
            <span class="add-btn"></span>
            <div class="add-box hidden" id="my-opinion-add-box">
                <span class="sort-wrap">
                    <input class="sort-input" placeholder="排序" type="text">
                </span>
                <span class="text-wrap">
                    <input class="text-input" placeholder="输入意见模板" type="text">
                </span>
                <span class="actions">
                    <span class="save">保存</span>
                    <span class="cancel">取消</span>
                </span>
            </div>
            <div class="my-opinion-list" id="my-opinion-list">

            </div>
            <div class="cate-header fui-theme-main-color">表格配置</div>
			<div class="fui-form" id="form-container">
				<div role="form">
					<div role="row">
						<div role="control" label="表格每页展示数目">
							<input class="mini-combobox" bind="pageSize"
								action="getPageSizeModel" id="pageSize"
								onvaluechanged="saveChange" />
						</div>
						<div role="control" label="自动撑满">
							<div class="mini-checkbox switch" trueValue="true"
								id="adjustGridPageSize" bind="adjustGridPageSize"
								falseValue="false" onvaluechanged="gridPageSave"></div>
						</div>
						<div role="control"></div>
					</div>
				</div>
			</div>
			<div class="cate-header fui-theme-main-color">字体大小设置</div>
			<div class="fui-form" id="form-container">
				<div role="form">
					<div role="row">
						<div role="control" label="字体大小设置">
							<input id="font-size-spinner" changeOnMousewheel="false" class="mini-spinner" increment="0.05"  minValue="1" maxValue="2" onvaluechanged="saveFontSizeRatio"/>
						</div>
					</div>
				</div>
			</div>
        </div>
    </div>
    <script>
        // 数据模拟
        SrcBoot.debug = true;
        SrcBoot.mock = true;
    </script>
    <script src="../../../../../rest/resource/jsboot"></script>
    <script>
        // 获取数据
        // 如果存在签名图片 执行下面代码
        // if (data.signPicture) {
        //     $('#signature-img').attr('src', data.signPicture);
        //     $('#signature-box').removeClass('empty');
        // }

        // 我意见配置
        var myOpinion = {
            getUrl: './test/myopinion.json',
            // 编辑或新增请求地址
            // {
            //     id: id, // 新增时无id
            //     sort: s,
            //     text: t
            // }
            editOrAddUrl: './test/upload.json',
            // 移除的请求地址 {id : id}
            removeUrl: './test/upload.json'
        };

        var addUploaderBtnTimer = {};

        function addBtnForUploader(uid, el) {
            var u = mini.get(uid).getUploader();

            if (u) {
                u.addButton({
                    id: el
                });
                clearTimeout(addUploaderBtnTimer[uid]);
            } else {
                var args = arguments;
                addUploaderBtnTimer[uid] = setTimeout(function () {
                    addBtnForUploader.apply(undefined, args);
                }, 50);
            }
        }

        addBtnForUploader('uploader2', '#signature-upload-btn');

        // 个性签名图片上传成功
        function onSignFileSuccess(args) {
            if (args.data.extraDatas.signPicture) {
                $('#signature-img').attr('src', Util.getRightUrl(args.data.extraDatas.signPicture));
                $('#signature-box').removeClass('empty');
            }
        }
    </script>
    <script>
        // 我的意见
        (function (win, $) {
            var OPINION_TPL =
                '<div class="my-opinion-item" data-id="{{id}}"><span class="sort-wrap"><input class="sort-input" placeholder="排序" type="text" value="{{sort}}" readonly></span><span class="text-wrap"><input class="text-input" placeholder="输入意见模板" type="text" value="{{text}}" readonly></span><span class="actions"><span class="edit">编辑</span><span class="save">保存</span><span class="cancel">取消</span><span class="remove" title="删除"></span></span></div>';

            var $myOpinion = $('#my-opinion');
            var $list = $('#my-opinion-list');
            var $addRow = $('#my-opinion-add-box');

            function getData() {
                return Util.ajax({
                    url: myOpinion.getUrl
                }).done(function (data) {
                    var html = '';
                    $.each(data, function (i, item) {
                        html += Mustache.render(OPINION_TPL, item);
                    });
                    $(html).appendTo($list.empty());
                });
            }
            getData();

            var oldVlue = [];
            $myOpinion.on('click', '.edit', function () {
                if ($list.find('.my-opinion-item.in-edit').length || $addRow.is(':visible')) {
                    epoint.showTips('请先处理当前的编辑！', {
                        state: 'danger'
                    });
                    return;
                }
                var $this = $(this).closest('.my-opinion-item'),
                    $sort = $this.find('.sort-input'),
                    $text = $this.find('.text-input');
                $this.addClass('in-edit');
                $this.find('.sort-input,.text-input').prop('readonly', false);
                oldVlue[0] = $.trim($sort.val());
                oldVlue[1] = $.trim($text.val());
            }).on('click', '.cancel', function () {
                var $this = $(this).closest('.my-opinion-item'),
                    $sort = $this.find('.sort-input'),
                    $text = $this.find('.text-input');
                $this.removeClass('in-edit');
                $this.find('.sort-input,.text-input').prop('readonly', true);
                // getData();
                if ($addRow.is(':visible')) {
                    $sort.val('');
                    $text.val('');
                    $addRow.addClass('hidden');
                } else {
                    // 恢复值
                    $sort.val(oldVlue[0]);
                    $text.val(oldVlue[1]);
                }
            }).on('click', '.remove', function () {
                // var $this = $(this).closest('.my-opinion-item');
                remove($(this).closest('.my-opinion-item').data('id')).done(function (res) {
                    if (res.success) {
                        epoint.showTips('删除成功', {
                            state: 'success'
                        });
                        // 后刷新列表
                        getData();
                    } else if (res.msg) {
                        epoint.showTips('删除失败' + res.msg, {
                            state: 'danger'
                        });
                    }
                })

            }).on('click', '.save', function () {
                var $this = $(this).closest('.my-opinion-item,.add-box'),
                    $sort = $this.find('.sort-input'),
                    $text = $this.find('.text-input');
                var s = $.trim($sort.val());
                var t = $.trim($text.val());
                if (!s.length || !t.length) {
                    epoint.showTips('排序值和意见内容必填', {
                        state: 'danger'
                    });
                    return;
                }
                if (!/^\d+$/.test(s)) {
                    epoint.showTips('排序值必须为数字', {
                        state: 'danger'
                    });
                    return;
                }
                if (t.length >= 50) {
                    epoint.showTips('意见长度不能超过50', {
                        state: 'danger'
                    });
                    return;
                }
                if (s != oldVlue[0] || t != oldVlue[1]) {
                    // 保存
                    save({
                        id: $this.data('id') || null,
                        sort: s,
                        text: t
                    }).done(function (res) {
                        if (res.success) {
                            epoint.showTips('保存成功', {
                                state: 'success'
                            });
                            $this.removeClass('in-edit');
                            $addRow.addClass('hidden');
                            $this.find('.sort-input,.text-input').prop('readonly', true);
                            // 保存成功后刷新列表
                            getData();
                        } else if (res.msg) {
                            epoint.showTips('保存失败' + res.msg, {
                                state: 'danger'
                            });
                        }
                    });
                } else {
                    epoint.showTips('未更改');
                    $addRow.addClass('hidden');
                    $this.removeClass('in-edit');
                    $this.find('.sort-input,.text-input').prop('readonly', true);
                }
            }).on('click', '.add-btn', function () {
                if ($addRow.is(':visible')) {
                    epoint.showTips('请先处理当前的编辑！', {
                        state: 'danger'
                    });
                    return;
                }
                $addRow.removeClass('hidden').find('.sort-input,.text-input').val('').prop('readonly',
                    false);
            });


            function save(data) {
                return Util.ajax({
                    url: myOpinion.editOrAddUrl,
                    data: data
                });
            }

            function remove(id) {
                return Util.ajax({
                    url: myOpinion.removeUrl,
                    data: {
                        id: id
                    }
                });
            }

            // 字体大小切换
            var fontSizeSpinner = mini.get('font-size-spinner');

            var font_size_ratio = parseFloat(Util.readCookie('_font_size_ratio_') || 1, 10);

            fontSizeSpinner.setValue(font_size_ratio);

            function saveFontSizeRatio() {
                var r = parseFloat(fontSizeSpinner.getValue(), 10);

                Util.fontSizeSwitcher.saveFontSizeRatio(r);

            }

            function gridPageSave() {
                var val = mini.get("adjustGridPageSize").value;
                epoint.execute('save', null, function(data) {
                    if (data.success) {
                        var msg = "";

                        if (val == "true") {
                            msg = "开启成功，表格每页展示数目配置将失效！"
                        } else {
                            msg = "关闭成功！"
                        }
                        epoint.showTips(msg, {
                            state : 'success'
                        });
                    }
                });
            }
        })(this, jQuery);
    </script>
    	<script>
            // 我的意见
            (function(win, $) {
                var OPINION_TPL = '<div class="my-opinion-item" data-id="{{id}}"><span class="sort-wrap"><input class="sort-input" placeholder="排序" type="text" value="{{sort}}" readonly></span><span class="text-wrap"><input class="text-input" placeholder="输入意见模板" type="text" value="{{text}}" readonly></span><span class="actions"><span class="edit">编辑</span><span class="save">保存</span><span class="cancel">取消</span><span class="remove" title="删除"></span></span></div>';
    
                var $myOpinion = $('#my-opinion');
                var $list = $('#my-opinion-list');
                var $addRow = $('#my-opinion-add-box');
    
                function getData() {
                    return Util.ajax({
                        url : myOpinion.getUrl
                    }).done(function(data) {
                        var html = '';
                        $.each(data, function(i, item) {
                            html += Mustache.render(OPINION_TPL, item);
                        });
                        $(html).appendTo($list.empty());
                    });
                }
                getData();
    
                var oldVlue = [];
                $myOpinion
                        .on(
                                'click',
                                '.edit',
                                function() {
                                    if ($list.find('.my-opinion-item.in-edit').length
                                            || $addRow.is(':visible')) {
                                        epoint.showTips('请先处理当前的编辑！', {
                                            state : 'danger'
                                        });
                                        return;
                                    }
                                    var $this = $(this).closest('.my-opinion-item'), $sort = $this
                                            .find('.sort-input'), $text = $this
                                            .find('.text-input');
                                    $this.addClass('in-edit');
                                    $this.find('.sort-input,.text-input').prop(
                                            'readonly', false);
                                    oldVlue[0] = $.trim($sort.val());
                                    oldVlue[1] = $.trim($text.val());
                                })
                        .on(
                                'click',
                                '.cancel',
                                function() {
                                    var $this = $(this).closest('.my-opinion-item'), $sort = $this
                                            .find('.sort-input'), $text = $this
                                            .find('.text-input');
                                    $this.removeClass('in-edit');
                                    $this.find('.sort-input,.text-input').prop(
                                            'readonly', true);
                                    // getData();
                                    if ($addRow.is(':visible')) {
                                        $sort.val('');
                                        $text.val('');
                                        $addRow.addClass('hidden');
                                    } else {
                                        // 恢复值
                                        $sort.val(oldVlue[0]);
                                        $text.val(oldVlue[1]);
                                    }
                                })
                        .on(
                                'click',
                                '.remove',
                                function() {
                                    // var $this = $(this).closest('.my-opinion-item');
                                    remove(
                                            $(this).closest('.my-opinion-item')
                                                    .data('id')).done(
                                            function(res) {
                                                if (res.success) {
                                                    epoint.showTips('删除成功', {
                                                        state : 'success'
                                                    });
                                                    // 后刷新列表
                                                    getData();
                                                } else if (res.msg) {
                                                    epoint.showTips('删除失败'
                                                            + res.msg, {
                                                        state : 'danger'
                                                    });
                                                }
                                            })
    
                                })
                        .on(
                                'click',
                                '.save',
                                function() {
                                    var $this = $(this).closest(
                                            '.my-opinion-item,.add-box'), $sort = $this
                                            .find('.sort-input'), $text = $this
                                            .find('.text-input');
                                    var s = $.trim($sort.val());
                                    var t = $.trim($text.val());
                                    if (!s.length || !t.length) {
                                        epoint.showTips('排序值和意见内容必填', {
                                            state : 'danger'
                                        });
                                        return;
                                    }
                                    if (!/^\d+$/.test(s)) {
                                        epoint.showTips('排序值必须为正整数', {
                                            state : 'danger'
                                        });
                                        return;
                                    }
                                    if (s.length > 10) {
                                        epoint.showTips('意见排序号长度不能超过10', {
                                            state : 'danger'
                                        });
                                        return;
                                    }
                                    if (t.length > 50) {
                                        epoint.showTips('意见长度不能超过50', {
                                            state : 'danger'
                                        });
                                        return;
                                    }
                                    if (s != oldVlue[0] || t != oldVlue[1]) {
                                        // 保存
                                        save({
                                            id : $this.data('id') || null,
                                            sort : s,
                                            text : t
                                        })
                                                .done(
                                                        function(res) {
                                                            if (res.success) {
                                                                epoint
                                                                        .showTips(
                                                                                '保存成功',
                                                                                {
                                                                                    state : 'success'
                                                                                });
                                                                $this
                                                                        .removeClass('in-edit');
                                                                $addRow
                                                                        .addClass('hidden');
                                                                $this
                                                                        .find(
                                                                                '.sort-input,.text-input')
                                                                        .prop(
                                                                                'readonly',
                                                                                true);
                                                                // 保存成功后刷新列表
                                                                getData();
                                                            } else if (res.msg) {
                                                                epoint
                                                                        .showTips(
                                                                                '保存失败'
                                                                                        + res.msg,
                                                                                {
                                                                                    state : 'danger'
                                                                                });
                                                            }
                                                        });
                                    } else {
                                        epoint.showTips('未更改');
                                        $addRow.addClass('hidden');
                                        $this.removeClass('in-edit');
                                        $this.find('.sort-input,.text-input').prop(
                                                'readonly', true);
                                    }
                                }).on(
                                'click',
                                '.add-btn',
                                function() {
                                    if ($addRow.is(':visible')) {
                                        epoint.showTips('请先处理当前的编辑！', {
                                            state : 'danger'
                                        });
                                        return;
                                    }
                                    $addRow.removeClass('hidden').find(
                                            '.sort-input,.text-input').val('')
                                            .prop('readonly', false);
                                });
    
                function save(data) {
                    return Util.ajax({
                        url : myOpinion.editOrAddUrl,
                        data : data
                    });
                }
    
                function remove(id) {
                    return Util.ajax({
                        url : myOpinion.removeUrl,
                        data : {
                            id : id
                        }
                    });
                }
            })(this, jQuery);
        </script>
</body>

</html>