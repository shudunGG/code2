<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>流程代理人</title>
	<script src="../../../../../frame/fui/js/cssboot.js"></script>
	<script>
		SrcBoot.output(['./css/flowagency.css']);
	</script>
	
	<script>
		SrcBoot.outputCustomSkin("./skins/flowagency/");
	</script>
</head>

<body>
	<div class="fui-content" style="padding: 0 20px;">
		<div class="scroll-container">
			<div class="cate-header fui-theme-main-color">流程代理人</div>
			<div class="office-cfg-box flow-agency" id="flow-agency">
				<span id="agent" class="add-btn"></span>
				<div class="flow-agency-list"></div>
			</div>
		</div>
	</div>

	<script src="../../../../../rest/resource/jsboot"></script>

	<script>
	epoint.initPage("myinfomodifyaction", "", function(data) {
		console.log(data);
		if (data.setAegntError) {
			epoint.alert("当前系统接入了统一代办  无法在此页面新增代理人");
			$("#agent").css("display","none");
		}
	});
		// 流程代理信息配置
		var flowAgencyCfg = {
			// 获取信息的请求地址
			// getDataUrl: 'getFlowAgencyInfo',
			getDataUrl: epoint
				.dealRestfulUrl('myinfomodifyaction/getFlowAgencyInfo'),
			// 新增 和 修改 点击
			addOrEdit: function (guid) {
				// 如果为新增 则无guid  修改 guid 表示代理的标识
				var url = 'frame/pages/basic/commission/mycommission?type=own',
					name = '新增代理人配置';
				if (guid) {
					url += '&commissionGuid=' + guid;
					name = '修改代理人配置';
				}
				epoint.openTopDialog(name, url, function (e) {
					// 如果新增成功 则刷新列表数据
					if (e == 'success') {
						refreshFlowAgency();
						epoint.showTips('处理成功', {
							state: 'success'
						});
					}
				});
			},
			remove: function (guid) {
				// 删除点击 发请求删除成功后 刷新代理信息 调用 refreshFlowAgency() 即可
				epoint.execute('myinfomodifyaction.deleteCommission', null,
					guid,
					function (data) {
						if (data.success) {
							epoint.showTips('删除成功', {
								state: 'success'
							});
							refreshFlowAgency();
						}
					});
			}
		};
	</script>
	<script>
		// 流程代理
		(function (win, $) {
			var $flowAgency = $('#flow-agency'),
				$addBtn = $('>.add-btn',
					$flowAgency),
				$list = $('.flow-agency-list', $flowAgency);

			var AGENCY_TPL =
				'<div class="flow-agency-item" data-id="{{id}}"><img src="{{portrait}}" alt="{{username}}" class="icon"><span class="name text-ellipsis" title="{{username}}">{{username}}</span><div class="info-box"><span class="info" title="{{agencyInfo}}">{{{agencyInfo}}}</span></div><span class="actions"><span class="edit" data-id="{{id}}">编辑</span><span class="remove" data-id="{{id}}"></span></span></div>';

			// '授权时间：2018-01-01到2018-01-30';
			// '授权单据：【待办】公文审批【签发】某某区发文某某区发文某某区发文某某区发文某某区发文...';

			function render(data) {
				var html = '';
				var item;
				for (var i = data.length - 1; i >= 0; i--) {
					item = data[i];
					item.portrait = Util.getRightUrl(item.portrait ||
						'./images/user-demo1.png');
					if (item.type == 'time') {
						item.agencyInfo = '授权时间：' + item.startDate + ' 到 ' +
							item.endDate;
					} else if (item.type == 'case') {
						item.agencyInfo = '授权单据：' + (item.caseName || '已处理');
					}
					html += Mustache.render(AGENCY_TPL, item);
				}
				return $(html).appendTo($list.empty());
			}

			function getData() {
				Util.ajax({
					url: flowAgencyCfg.getDataUrl
				}).done(function (data) {
					render(data);
				});
			}

			getData();

			$addBtn.on('click', function () {
				flowAgencyCfg.addOrEdit();
			});
			$list.on('click', '.edit', function () {
				flowAgencyCfg.addOrEdit($(this).data('id'));
			}).on('click', '.remove', function () {
				flowAgencyCfg.remove($(this).data('id'));
			})

			win.refreshFlowAgency = getData;
		})(this, jQuery);
	</script>
</body>

</html>