<!DOCTYPE html>
<html>

<head>
<title>外部通讯录联系人列表</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<!-- 请修改相对路径 -->
<script src="../../../../fui/js/cssboot.js"></script>
</head>

<body>
	<!-- 必须有，加载时的loading效果 -->
	<div class="page-loading"></div>
	<div class="fui-left">
		<div role="head" title="分组设置">
			<a class="mini-button" onclick="settings()" id="settings" style="position: relative;left:40px;top:-2px;">分组设置</a>
		</div>
		<div role="body">
			<ul id="tree" name="tree" class="mini-tree"
				style="width: 100%; height: 100%" autoLoad="false"
				showTreeIcon="true" textField="text" idField="id" parentField="pid"
				action="getBelongProjectModal" resultAsTree="false"></ul>
		</div>
	</div>
	<div class="fui-right">
		<!-- toolbar区域 -->
		<div class="fui-toolbar" id="tool">
			<div class="btn-group mr10">
				<a class="mini-button" onclick="openAdd();" id="btnAddRecord">
					新增记录 </a>
				<a id="btnTsf" class="mini-button" onclick="if(mini.get('datagrid').getSelecteds()==0){epoint.alert('请选择要转移的联系人!');} else {transferSelect();}">
					转移选中 </a>
				<a id="btnDel" class="mini-button" onclick="if(mini.get('datagrid').getSelecteds()==0){epoint.alert('请选择要删除的联系人!');} else {epoint.confirm('确认要删除吗?','',deleteSelect);}">
					删除选定 </a>
			</div>
		</div>
		<!-- 内容区域 -->
		<div id="fuiContent" class="fui-content">
			<div id="datagrid" class="mini-datagrid" idField="linkuserguid"
				action="getDataGridData" sortOrder="desc" showPager="true"
				style="height: 100%;" allowResize="true" multiSelect="true"
				allowCellEdit="true" allowCellSelect="true" editNextOnEnterKey="true"
				editNextRowCell="true">
				<div property="columns">
					<div type="checkcolumn" width="20"></div>
					<div type="indexcolumn" width="20" headerAlign="center">序</div>
					<div field="linkdisplayname" headerAlign="center">联系人姓名</div>
					<div field="companyname" headerAlign="center">公司名称</div>
					<div field="telephoneoffice" headerAlign="center">办公电话</div>
					<div width="60" align="center" headerAlign="center"
						renderer="onEditRenderer">修改</div>
					<div width="60" align="center" headerAlign="center"
						renderer="onDetailRenderer">查看</div>
				</div>
			</div>
			<div style="display: none">
				<input class="mini-textbox" id="categoryguid" bind="categoryguid" />
			</div>
		</div>
	</div>

	

	<!-- 请修改相对路径 -->
	<script src="../../../../rest/resource/jsboot"></script>
	<script>
		//<![CDATA[
    // 初始化页面
    var categoryguid = mini.get('categoryguid');
	var type;
	var tree=mini.get('tree');
	// 根据角色不用，对公共联系人中
    epoint.initPage('oabusinesscarduserlistaction','',function(data){
		if(data){
			if(data.role=="Boss"){
				if(data.type=="Pub"){
					type="Pub";
				}
			}else {
				if(data.type=="Pub"){
					mini.get('settings').setVisible(false);
					mini.get('btnAddRecord').setVisible(false);
					mini.get('btnTsf').setVisible(false);
					mini.get('btnDel').setVisible(false);
				}
			}
		}
	});

    // 绘制行编辑按钮
    var onEditRenderer = function (e) {
        return epoint.renderCell(e, "action-icon icon-edit", "openEdit");
    };

    // 绘制行查看按钮
    var onDetailRenderer = function (e) {
        return epoint.renderCell(e, "action-icon icon-search", "openDetail");
    };

    // 弹出新增窗口
    function openAdd() {
		if(categoryguid.getValue()=="f9root"){
			epoint.alert('请先选择部门！');
		}else {
			epoint.openDialog('新增记录', "oa9/communication/businesscard/oabusinesscarduser/oabusinesscarduseradd?categoryguid=" + categoryguid.getValue()+"&type="+type, searchData, {
				'width': 1000,
				'height': 550
			});
		}
    }

    // 弹出修改窗口
    function openEdit(id) {
        epoint.openDialog('修改记录', "oa9/communication/businesscard/oabusinesscarduser/oabusinesscarduseredit?guid=" + id, searchData, {
            'width': 1000,
            'height': 550
        });
    }

    // 弹出明细窗口
    function openDetail(id) {
        epoint.openDialog('详细信息', "oa9/communication/businesscard/oabusinesscarduser/oabusinesscarduserdetail?guid=" + id, searchData, {
            'width': 1000,
            'height': 550
        });
    }

    // 弹出分组窗口
    function settings() {
        epoint.openDialog('分组管理', "oa9/communication/businesscard/oabusinesscardcategory/oabusinesscardcategorylist?type="+type, searchTree, {
            'width': 1000,
            'height': 550
        });
    }

	// 弹出转移窗口
	function transferSelect() {
		var sel=mini.get('datagrid').getSelecteds();
		epoint.openDialog('部门树', "oa9/communication/businesscard/oabusinesscarduser/doucumenttree?json="+mini.encode(sel)+"&type="+type, searchData, {
			'width': 500,
			'height': 550
		});
	}


    // 删除数据
    function deleteSelect() {
        epoint.execute("deleteSelect", '', callback);
    }


    function callback(data) {
        if (data.msg) {
            epoint.alert(data.msg, '', searchData);
        }
    }

    // 表格的搜索
    function searchData() {
        epoint.refresh(['datagrid','categoryguid']);
    }
    
    tree.on('nodeclick', function(e) {
		// 获取点击节点的id
		console.log(e.node);
		var id = e.node.id;
		categoryguid.setValue(id);
		searchData();
	});

	// 左侧树的搜索
    function searchTree() {
        epoint.refresh(['tree']);
    }
		//]]>
</script>
</body>
</html>