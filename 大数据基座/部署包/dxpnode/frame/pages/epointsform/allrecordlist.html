<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>过程管理</title>
<script src="../../fui/js/cssboot.js"></script>
</head>

<body>
	<div class="page-loading"></div>

	<!-- toolbar区域 -->
	<div class="fui-toolbar">
		<div class="btn-group mr10">
			<a class="mini-button" id="startprocess" onclick="startProcess();">发起流程</a>
			<a class="mini-dataexport l" id="dataexport" gridId="datagrid"  fileName="记录信息" 
			    action="getExcelExportModel" ></a> 
		</div>
		<input class="mini-output" bind="name" />
	</div>
	
	<!-- 内容区域 -->
	<div id="fui-content" class="fui-content">
		<div id="datagrid" name="datagrid" class="mini-datagrid" allowResize="true"
			idField="rowguid" multiSelect="true" action="getDefaultDataModel"
			 style="width: 100%; height: 100%;">
		</div>
		<input class="mini-hidden" id="params" bind="params" /> 
		<input class="mini-hidden" id="tableId" bind="tableId" />
		<input class="mini-hidden" id="processGuid" bind="processGuid"/>
	</div>

	<script src="../../../rest/resource/jsboot"></script>
	<script src="../../fui/js/epoint/epoint.controlconfig.js"></script>
	<script src="../../fui/js/epoint/epoint.form.js"></script>
	<script>
		//<![CDATA[ 
		// 初始化页面
		epoint.initPage('allrecordlistaction','',initCallBack);
		
		// 表格对象
		var grid = mini.get("datagrid");
		
		var tId = "";
		
		var fieldMaps = null, params = mini.get('params');
		
		// 初始化回调，动态生成列
		function initCallBack(data){
			if(data.msg){
				epoint.alertAndClose(data.msg, null, null, null, 'info');
			}else{
				//adjustContentHeight();//隐藏的condition出来 要重新计算一次高度
				if (data && data.controls) {
					//appearCondition(data);
					drawDynamicColumn(data);
					if(data.fields){
						fieldMaps = data.fields;
					}
					mini.parse();
				}
			}
			tId= mini.get("tableId").getValue();
		}
		
		// 加载查询区域
		/*function appearCondition(data) {
			var html = epoint.parseForm(data.controls);
			$('#fuiCondition').prepend(html);
			initCondition();
		}*/
		
		// 绘制动态列
		function drawDynamicColumn(data) {
			var tmp = data.columns;
			var columns = Util.safeEval('(' + tmp + ')');
			grid.set(columns);
		}
		
		// 在表格数据加载完之后打开表格编辑状态
		grid.on("load", function(e) {
			var rows = e.sender.findRows();
			for (var i = 0; i < rows.length; i++) {
				grid.beginEditRow(rows[i]);
			}
		});
		
		function startProcess(){
			var processGuid=mini.get("processGuid").getValue();
			var url = "processsformcreateinstance?ProcessGuid=" + processGuid;
			if (!processGuid) {
				epoint.alert("没有可启动的流程！", null, null, 'error');
				return false;
			}
			epoint.openDialog("新建工作流程","frame/pages/epointsform/" + url, searchData);
		}
		
		//新增回调
		function callBack(param) {
			if (param != 'close') {
				searchData();
			}
		}

		// 表格的搜索
		function searchData() {
			// 获取查询区域的值并赋值给params
			if(fieldMaps){
				$.each(fieldMaps, function(k, v){
					var control = mini.get(k);
					if(control){
						fieldMaps[k] = control.getValue();
					}
				});
				params.setValue(JSON.stringify(fieldMaps));
			}
			epoint.refresh(['datagrid', 'params']);
		}
		
		function onSearchRenderer(e){
			return epoint.renderCell (e, "action-icon icon-search", "openViewDialog", "rowguid");
		}
		
		function openViewDialog(rowGuid) {
			epoint.execute('getPreviewUrl', '', [ tId, rowGuid ], showUrl);
        }
		
		function showUrl(args) {
			if (args.previewUrl) {
				epoint.openDialog("表单详细信息", args.previewUrl, callBack);
			} else {
				epoint.alertAndClose("当前记录没有查询到对应数据", null, null, null, 'error');
			}
		}
		
		function onZhuiZongRenderer(e){
			return epoint.renderCell (e, "action-icon icon-edit", "openFlowChartDialog","processversioninstanceguid");
		}
		
		function openFlowChartDialog(pviGuid) {
			epoint.execute("handlecontrolsaction.processClient", "@none", [pviGuid], ShowChart);
        }
		
		function ShowChart(data){
			if(data && data.url){
				epoint.openDialog(
						"流程页面", data.url, callBack,
						 {
							'width' : 1000,
							'height' : 700
						});
			}
		}
		
		function onDelRenderer(e){
			return epoint.renderCell (e, "action-icon icon-removecircle", "del", "rowguid,processversioninstanceguid");
		}
		
		function del(data){
			//解码json字符串为对象
			data = epoint.decodeJson(data);
			var rowguid = data.rowguid;
			var processversioninstanceguid = data.processversioninstanceguid;
			epoint.execute('deleteitem', '', [rowguid,processversioninstanceguid], searchData);
		}

		//]]>
	</script>
</body>
</html>