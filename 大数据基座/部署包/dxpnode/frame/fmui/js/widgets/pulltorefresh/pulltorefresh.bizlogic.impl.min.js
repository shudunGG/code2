!function(e){"use strict";function t(e){if(null==e||"string"!=typeof e)return null;var t,i=document.createElement("div"),s=document.createDocumentFragment();for(i.innerHTML=e;t=i.firstChild;)s.appendChild(t);return s}function i(t){var i=this;t=e.extend(!0,{},a,t);var s=t.template;if("string"==typeof s&&/^[.#]/.test(s)||s instanceof HTMLElement){var n=e.selector(s);n&&(s=n.innerHTML.toString()||"")}t.template=s;var o=null;switch(t.skin){case"type1":o=PullToRefreshTools.skin.type1;break;case"type2":o=PullToRefreshTools.skin.type2;break;case"type3":o=PullToRefreshTools.skin.type3;break;case"type4":o=PullToRefreshTools.skin.type4;break;case"type5":o=PullToRefreshTools.skin.type5;break;case"native":o=PullToRefreshTools.skin["native"];break;default:o=PullToRefreshTools.skin.defaults}if(!o)throw new Error("错误:传入的下拉刷新皮肤错误,超出范围!");var r=t.setting;r.container=t.container,r.down&&(r.down.callback=function(){i._pullDownCallback()}),r.up&&(r.up.callback=function(){i._pullUpCallback()}),this.container=e.selector(t.container),this.listContainer=e.selector(t.listContainer),this.options=t,this.setting=r,this._initParams(),this.instance=new o(r),this._addEvent()}var s=Util.dataProcess,n="ontouchstart"in document,o=n?"tap":"click",a={isDebug:!1,container:"#pullrefresh",listContainer:"#listdata",type:"POST",initPageIndex:0,pageSize:10,url:null,template:"#item-template",dataRequest:null,dataChange:null,itemClick:null,success:null,error:null,refresh:null,isAutoRender:!0,itemSelector:"li",delay:0,timeout:6e3,accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},contentType:"application/x-www-form-urlencoded",headers:null,setting:{down:{isSuccessTips:!0},up:{auto:!0}}};i.prototype={_initParams:function(){this.isShouldNoMoreData=!0,this.currPage=this.options.initPageIndex,this.setting.up&&this.setting.up.auto&&this.currPage--},_pullDownCallback:function(){var e=this,t=this.options;this.loadingDown||(this.isPullDown=!0,this.loadingDown=!0,this.currPage=t.initPageIndex,setTimeout(function(){e._ajaxRequest()},t.delay),t.refresh&&t.refresh(!0))},_pullUpCallback:function(){var e=this;this.loadingUp||(this.isPullDown=!1,this.loadingUp=!0,this.currPage++,setTimeout(function(){e._ajaxRequest()},this.options.delay))},_clearResponseEl:function(){this.options.isAutoRender&&this.listContainer&&(this.listContainer.innerHTML="")},_render:function(e){var i=this.options,s=0;if(i.isAutoRender)if(this.isPullDown&&this._clearResponseEl(),window.Mustache)if(e&&Array.isArray(e)&&e.length>0){for(var n="",o=0,a=e.length;o<a;o++){var r=e[o],l="";i.template&&("string"==typeof i.template?l=i.template:"function"==typeof i.template&&(l=i.template(r))),n+=Mustache.render(l,r),s++}""!=n&&this.listContainer.appendChild(t(n))}else this.isShouldNoMoreData=!1;else this.isShouldNoMoreData=!1,i.isDebug&&console.error("error***没有包含mustache文件,无法进行模板渲染");return s},_dataChangeDefault:function(e){var t=s(e,{dataPath:["custom.infoList","custom.list","UserArea.InfoList"]});return t.data},_ajaxRequest:function(){var e=this,t=this.options;if(!t.url)return t.isDebug&&console.error("error***url无效,无法访问"),void this._errorRequest(null,null,"请求url为空!");var i=function(i){var s="";s="function"==typeof t.url?t.url():t.url,Util.ajax({url:s,data:i,dataType:"json",timeout:t.timeout,type:t.type,accepts:t.accepts,headers:t.headers,contentType:t.contentType,success:function(t){e._successRequest(t)},error:function(t,i){e._errorRequest(t,i,"请求失败!")}})};if(t.dataRequest){var s=t.dataRequest(this.currPage,function(e){i(e)});void 0!==s&&i(s)}else t.isDebug&&console.warn("warning***请注意dataRequest不存在,默认数据为空"),i()},_errorRequest:function(e,t,i){var s=this.options;this.isShouldNoMoreData=!1,this._refreshState(!1),this.currPage--,this.currPage=this.currPage>=s.initPageIndex?this.currPage:s.initPageIndex,s.error&&s.error(e,t,i)},_successRequest:function(e){var t=this.options;if(!e)return t.isDebug&&console.log("warning***返回的数据为空,请注意！"),this.isShouldNoMoreData=!1,void this._refreshState(!1);t.isDebug&&console.log("下拉刷新返回数据:"+JSON.stringify(e)),e=t.dataChange?t.dataChange(e):this._dataChangeDefault(e);var i=this._render(e);this.loadingMoreSuccess&&(this.loadingMoreSuccess(),this.loadingMoreSuccess=null),t.success&&"function"==typeof t.success&&t.success(e,this.isPullDown||this.currPage==t.initPageIndex),this._refreshState(!0,i)},_refreshState:function(e,t){var i=this.instance;t=t||0,i.setSuccessTips&&i.setSuccessTips("更新"+t+"条数据"),this.isPullDown&&(i.endPullDownToRefresh(e),i.finished&&(i.refresh(!0),this.isShouldNoMoreData=!0)),this.isShouldNoMoreData?i.endPullUpToRefresh(!1,e):i.endPullUpToRefresh(!0,e),this.loadingDown=!1,this.loadingUp=!1},_addEvent:function(){var e=this.listContainer,t=this.options,i=t.itemClick;"function"==typeof i&&mui(e).on(o,t.itemSelector,i)},refresh:function(){var e=this.options;e.up&&this.instance.enablePullUp?this.loadingUp||(this._clearResponseEl(),this.currPage=e.initPageIndex-1,this.loadingMore()):(this._clearResponseEl(),this._pullDownCallback())},loadingMore:function(e){var t=this.instance;this.loadingMoreSuccess=e,this.instance.finished&&(this.instance.refresh(!0),this.isShouldNoMoreData=!0),t.pullupLoading()},disablePullupToRefresh:function(){this.pullToRefreshInstance.disablePullupToRefresh()},enablePullupToRefresh:function(){this.pullToRefreshInstance.enablePullupToRefresh()},destroy:function(){mui(listContainer).off(),this.container=null,this.listContainer=null,this.instance=null,this.options=null}},e.namespace("bizlogic",i)}(PullToRefreshTools);