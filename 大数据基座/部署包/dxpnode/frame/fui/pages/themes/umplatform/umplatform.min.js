/* jshint -W030 */
// 分屏页码模板
var SCREEN_PAGE_TPL='\x3ca href\x3d"javascript:void(0);" data-page\x3d"{{page}}" class\x3d"page-item l mr10"\x3e\x3cspan\x3e{{pageNum}}\x3c/span\x3e\x3c/a\x3e',SCREEN_TPL='\x3cdiv class\x3d"imac-screen l" data-title\x3d"\u7b2c{{page}}\u5206\u5c4f"\x3e\x3c/div\x3e',SCREEN_APP_TPL='\x3cdiv class\x3d"app-item trans" title\x3d"{{name}}" style\x3d"top:{{top}}px;left:{{left}}px" data-id\x3d"{{id}}"\x3e\x3cspan class\x3d"unread {{^count}}hidden{{/count}}"\x3e{{count}}\x3c/span\x3e\x3cimg src\x3d"{{icon}}" alt\x3d"" class\x3d"app-icon"\x3e\x3cp class\x3d"app-name"\x3e{{name}}\x3c/p\x3e\x3c/div\x3e',TASK_ITEM_TPL='\x3ca href\x3d"javascript:void(0);" id\x3d"{{id}}-task" data-id\x3d"{{id}}" class\x3d"task-item l clearfix" title\x3d"{{name}}"\x3e\x3cp class\x3d"task-name l"\x3e{{name}}\x3c/p\x3e\x3c/a\x3e',DROP_ITEM_TPL='\x3cli id\x3d"{{id}}-drop" data-id\x3d"{{id}}" class\x3d"drop-item" title\x3d"{{name}}"\x3e{{name}}\x3c/li\x3e',DOCK_APP_TPL='\x3cdiv class\x3d"dock-app" data-id\x3d"{{id}}" title\x3d"{{name}}"\x3e{{#count}}\x3cspan class\x3d"unread"\x3e{{count}}\x3c/span\x3e{{/count}}\x3cimg src\x3d"{{icon}}" alt\x3d"" \x3e\x3cp class\x3d"name"\x3e{{{sname}}}\x3c/p\x3e\x3c/div\x3e',SEARCH_APPS_TPL='\x3cdiv class\x3d"app-item trans in-panel l" title\x3d"{{name}}" id\x3d"{{id}}-search" data-id\x3d"{{id}}"\x3e\x3cimg src\x3d"{{icon}}" alt\x3d"" class\x3d"app-icon"\x3e\x3cp class\x3d"app-name"\x3e{{name}}\x3c/p\x3e\x3c/div\x3e',BOARD_BTN_TPL='\x3cdiv class\x3d"right-board-btn" data-id\x3d"{{id}}" data-url\x3d"{{url}}"\x3e{{name}}\x3c/div\x3e',BOARD_CONTENT_TPL='\x3ciframe src\x3d"{{url}}" class\x3d"board-content hidden" id\x3d"board-content-{{id}}" height\x3d"100%" width\x3d"100%" frameborder\x3d"0" scrolling\x3d"no"\x3e\x3c/iframe\x3e';(function(f,a){a.extend(Util,{getZIndex:function(){return mini.getMaxZIndex()},localMemory:{_get:function(a){return JSON.parse(localStorage.getItem(a))||[]},_add:function(e,c,d){var g=this._get(c),l=a.inArray(e,g);if(-1!=l)return g.splice(l,1),g.unshift(e),!1;g.unshift(e)>d&&(g.length=d);localStorage.setItem(c,JSON.stringify(g));return!0},_del:function(e,c){var d=this._get(c),g=a.inArray(e,d);-1!==g&&(d.splice(g,1),localStorage.setItem(c,JSON.stringify(d)))},SearchHistory:{get:function(){return Util.localMemory._get("_search-history_")},add:function(a){return Util.localMemory._add(a,"_search-history_",20)},remove:function(a){return Util.localMemory._del(a,"_search-history_")}},QuickApps:{get:function(){return Util.localMemory._get("_quick-apps_")},add:function(a){return Util.localMemory._add(a,"_quick-apps_",10)},remove:function(a){return Util.localMemory._del(a,"_quick-apps_")}},RecentApps:{get:function(){return Util.localMemory._get("_recent-apps_")},add:function(a){return Util.localMemory._add(a,"_recent-apps_",10)},remove:function(a){return Util.localMemory._del(a,"_recent-apps_")}}},getBdSize:function(){return{width:a(f).width()-60,height:a(f).height()-50-44}},getAppShortName:function(a){a=a.substr(0,2);return a[0]+"\x26nbsp;"+a[1]},fixPath:function(e){var c=a.extend({},e);c.url=Util.getRightUrl(e.url);/^data:image/.test(e.icon)||(c.icon=Util.getRightUrl(e.icon));return c},highlightApp:function(a){var c=function(){a.animate({opacity:.3},200,e)},d=function(){a.animate({opacity:1},200,e)},e=function(){a.queue("highlight").length?a.dequeue("highlight"):a.clearQueue("highlight")};a.queue("highlight",[c,d,c,d,c,d,c,d]);e()},_jsPromise:{},loadJsPromise:function(e){if(this._jsPromise[e])return this._jsPromise[e];var c=a.Deferred(),d=document.createElement("script");d.type="text/javascript";(this.browsers.isIE67||this.browsers.isIE8)&&d.readyState?d.onreadystatechange=function(){if("loaded"==d.readyState||"complete"==d.readyState)c.resolve(),d.onreadystatechange=null}:(d.onload=function(){c.resolve();d.onload=null},d.onerror=function(){c.reject();d.onerror=null;Util._jsPromise[e]=null});d.src=Util.getRightUrl(e);document.getElementsByTagName("head")[0].appendChild(d);return this._jsPromise[e]=c.promise()},doNiceScroll:function(a,c){this.loadJsPromise("frame/fui/js/widgets/jquery.nicescroll.min.js").done(function(){a.niceScroll(c)})},doPlaceHolder:function(a){this.loadJsPromise("frame/fui/js/widgets/jquery.placeholder.min.js").done(function(){a.placeholder()})}});EpDialog.setMaxCoord({top:50,left:0,right:60,bottom:50})})(this,jQuery);(function(f,a){var e=a("#imac-skin-bg");Util.ajax({url:getBgUrl}).done(function(a){a&&a.bg?(e[0].src=Util.getRightUrl(a.bg),localStorage.setItem("_umplatform_bg_",a.bg)):(e[0].src=Util.getRightUrl("frame/fui/pages/themes/umplatform/images/skinbg/bg.jpg"),console&&console.error("\u672a\u8fd4\u56de\u80cc\u666f\uff0c\u52a0\u8f7d\u9ed8\u8ba4\u80cc\u666f\uff01"),localStorage.setItem("_umplatform_bg_","frame/fui/pages/themes/umplatform/images/skinbg/bg.jpg"))});f.setBg=function(a){e[0].src=Util.getRightUrl(a);localStorage.setItem("_umplatform_bg_",a)}})(this,jQuery);(function(f){f.ImacEvent=new Util.UserEvent})(this);(function(f,a){var e=a("#imac-page-list"),c=a("#imac-screens-container"),d=a(".screen-list"),g=Mustache,l=a.trim(SCREEN_PAGE_TPL),k=a.trim(SCREEN_TPL),r=a.trim(SCREEN_APP_TPL),p,h=DEFAULT_ACTIVE_PAGE-1,m=(a(f).height()-94-15)/145>>0,n,q=function(){var a=c.find(".imac-screen"),b=Util.getBdSize(),v=h*b.width;c.add(a).css(b);d.css("margin-left",-v)},t=function(b){var u=[],c=38*b.length;a.each(b,function(a){u.push(g.render(l,{page:a,pageNum:a+1}))});e.css({marginLeft:-c/2,width:c}).append(u.join(""))},b=function(b){var u=[];a.each(b,function(a,b){var c={page:a+1};ImacScreen._screenCache[a]={id:b.id,name:b.name};u.push(g.render(k,c))});d.html(u.join(""))},v=function(a){var b=Util.toInt(a/m);a=Util.toInt(a%m);return{left:25+145*b,top:15+145*a}},x=function(b,c){var u=null,e=[];c.length&&(u=d.find(".imac-screen").eq(b),a.each(c,function(u,c){c=Util.fixPath(c);var d=v(u),d=a.extend({},c,d);c.page=b;c.index=u;AppMgr.cacheAppData(c.id,c);c.msgCountUrl&&AppMgr.msgRemindApps.push({id:c.id,url:c.msgCountUrl});e.push(g.render(r,d))}),u.html(e.join("")))},y=function(b){a.each(b,function(a,b){x(a,b.apps)})};(function(){return Util.ajax({url:f.screenAppsUrl,error:Util._ajaxErr}).done(function(a){a&&(t(a),b(a),y(a),ImacEvent.fire("afterAllAppsLoad"),p=a.length,n=z(),AppDragMgr.enableAllScreenApps(),q(),w(h))})})();var w=function(a){var b=a*Util.getBdSize().width;e.find(".page-item").eq(a).addClass("active").siblings().removeClass("active");d.stop(!0).animate({marginLeft:-b},200);n.enableItem("page-"+h).disableItem("page-"+a);h=a};e.on("click",".page-item",function(){var b=a(this),c=Util.toInt(a(this).data("page"));b.hasClass("active")||w(c)});f.AppCmFuncs={moveToScreen:function(a,b){AppMgr.moveToScreen(a.id,b.page)},screenToToolbar:function(a){AppMgr.screenToToolbar(a.id)},openApp:function(a){AppMgr.openApp(a.id)},uninstallApp:function(a){TabsNav._data[id]?epoint.alert("\u6b64\u5e94\u7528\u5df2\u7ecf\u6253\u5f00\uff0c\u8bf7\u5173\u95ed\u540e\u518d\u5378\u8f7d\uff01"):epoint.confirm("\u786e\u5b9a\u8981\u5378\u8f7d\u6b64\u5e94\u7528\u5417\uff1f\u5378\u8f7d\u4e4b\u540e\u60a8\u53ef\u4ee5\u91cd\u65b0\u4ece\u5e94\u7528\u4ed3\u5e93\u4e2d\u5b89\u88c5","\u5378\u8f7d\u63d0\u9192",function(){AppMgr.uninstallApp(a.id)})}};var z=function(){var a=[],b,c=[],d=AppCmFuncs;a.push({text:"\u6253\u5f00\u5e94\u7528",role:"open-app",click:d.openApp});a.push("sep");a.push({text:"\u5378\u8f7d\u5e94\u7528",role:"uninstall-app",click:d.uninstallApp});a.push("sep");f.rightUseQuickApps&&(a.push({text:"\u6dfb\u52a0\u5230\u5feb\u6377\u5e94\u7528",click:d.screenToToolbar}),a.push("sep"));for(b=1;b<=p;b++)c.push({text:ImacScreen._screenCache[b-1].name||"\u684c\u9762-"+b,role:"page-"+(b-1),page:b-1,click:d.moveToScreen});a.push({text:"\u79fb\u52a8\u5e94\u7528\u5230",role:"move-app",items:c});a.push({text:"\u53d6\u6d88",role:"hide",click:function(){n.hide()}});return(new EpContextMenu({items:a})).setOptions("from","screen")};a(document).on("keydown",function(a){a=a.which;var b;37==a?b=h-1:39==a&&(b=h+1);void 0!==b&&(a=b,0>b?a=0:b>p-1&&(a=p-1),w(a))});a(f).on("resize",q);c.on("click",".app-item",function(){var b=a(this).data("id");AppMgr.openApp(b)}).on("contextmenu",".app-item",function(b){var c=a(this).data("id");n.setOptions("id",c).show({x:b.pageX,y:b.pageY});return!1});f.AppMgr={_data:{},msgRemindApps:[],cacheAppData:function(b,c){this._data[b]=a.extend({},c)},deleteAppData:function(a){this._data[a]=null},getAppData:function(b){return(b=this._data[b])?a.extend({},b):!1},screenToToolbar:function(a){QuickApps.isFull()||QuickApps.addApp(a,!1,!0)},moveToScreen:function(a,b){var c=ImacScreen.getScreen(b).find(".app-item").last(),c=c.length?c.data("id"):null;ImacScreen.removeApp(a);ImacScreen.addApp(a,b);Util.ajax({url:appToScreenUrl,data:{appId:a,screenId:ImacScreen._screenCache[b].id,prevAppId:c}})},openApp:function(a){f.rightUseQuickApps||QuickApps.addApp(a);var b=AppMgr.getAppData(a);"blank"==b.openType?f.open(b.url):TabsNav.addOrActiveTab(a)},installApp:function(a,b){var c=ImacScreen.getScreen(h).find(".app-item").last(),c=c.length?c.data("id"):null;return Util.ajax({url:installAppUrl,data:{appId:a,screenId:ImacScreen._screenCache[h].id,prevAppId:c}}).done(function(a){a&&(b&&b(),a=Util.fixPath(a),AppMgr.cacheAppData(a.id,a),a.msgCountUrl&&AppMgr.msgRemindApps.push({id:a.id,url:a.msgCountUrl}),ImacScreen.addApp(a.id,h))})},uninstallApp:function(a){if(TabsNav._data[a])epoint.alert("\u6b64\u5e94\u7528\u5df2\u7ecf\u6253\u5f00\uff0c\u8bf7\u5173\u95ed\u540e\u518d\u5378\u8f7d\uff01");else return Util.ajax({url:uninstallAppUrl,data:{appId:a}}).done(function(b){if(b)if("success"==b.status){if((b=AppMgr.getAppData(a))&&b.msgCountUrl){b=0;for(var c=AppMgr.msgRemindApps.length;b<c;++b){var d=AppMgr.msgRemindApps[b];if(d.id==a){d._$count=null;AppMgr.msgRemindApps.splice(b,1);break}}}ImacScreen.removeApp(a);QuickApps.removeApp(a);AppMgr.deleteAppData(a);ImacEvent.fire("afterAppUninstall",a)}else b.description&&epoint.alert(b.description)})}};f.ImacScreen={_screenCache:[],getActivePage:function(){return h},getApp:function(a){return c.find('[data-id\x3d"'+a+'"]')},getScreen:function(a){return c.find(".imac-screen").eq(a)},addApp:function(b,c,d){var e=this.getScreen(c),l=AppMgr.getAppData(b),k;void 0===d&&(d=e.find(".app-item").length);k=v(d);a.extend(l,{index:d,page:c});$app=a(g.render(r,l));$app.appendTo(e).css(k);Util.highlightApp($app);AppMgr.cacheAppData(b,l);AppDragMgr.enableScreenApp(b)},removeApp:function(a){var b=this.getApp(a);a=AppMgr.getAppData(a);b.addClass("hidden");ImacScreen.adjustAppsPosFromIndex(a.page,a.index+1,1);AppDragMgr.destroy(b);b.remove()},getAppByIndex:function(b,c){var d=!1;this.getScreen(b).find(".app-item").each(function(b,v){var e=a(v).data("id");if(AppMgr.getAppData(e).index==c)return d=a(v),!1});return d},getAppIndexByPos:function(a){var b;a.top>145*(m-1)+67.5?b=-1:(b=Math.round((a.left-25)/145),a=Math.round((a.top-15)/145),b=b*m+a);return b},adjustAppPosByIndex:function(a,b){var c=AppMgr.getAppData(a),d=v(b),e=ImacScreen.getApp(a);Util.browsers.isIE8||Util.browsers.isIE9?e.stop(!0).animate(d,200):e.css(d);c.index!=b&&(c.index=b,AppMgr.cacheAppData(a,c))},adjustAppsPosFromIndex:function(b,c,d){for(var e=ImacScreen.getScreen(b).find(".app-item").length,l,k,g,f,t=[];c<e;c++)t.push(ImacScreen.getAppByIndex(b,c));a.each(t,function(a,b){g=b.data("id");k=AppMgr.getAppData(g);f=d?k.index-1:k.index+1;l=v(f);b.css(l);k.index=f;AppMgr.cacheAppData(g,k)})},getAppsSort:function(b){var c=[];this.getScreen(b).find(".app-item").each(function(b,d){c.push(a(d).data("id"))});return c}}})(this,jQuery);(function(f,a){var e=a("#imac-screens-container"),c={containment:"parent",scroll:!1,opacity:.5,distance:10,start:function(){a(this).removeClass("trans").addClass("app-drag-zindex")},stop:function(c,e){var d=a(this),k=d.data("id"),g=AppMgr.getAppData(k),p=e.offset,h=d.parent(),m=null,m=h.find(".app-item").length,n=ImacScreen.getAppIndexByPos(p);d.addClass("trans").removeClass("app-drag-zindex");var p=!1,q=[];-1==n||n==g.index?ImacScreen.adjustAppPosByIndex(k,g.index):n+1>m?(h=h.children(".app-item").last(),d.nextAll().each(function(a,b){q.push({id:b.getAttribute("data-id"),index:g.index+a})}),d.insertAfter(h),q.push({id:k,index:m-1}),p=!0):(m=ImacScreen.getAppByIndex(ImacScreen.getActivePage(),n),p=!0,q.push({id:k,index:n}),n<g.index?(d.insertBefore(m),d.nextAll().each(function(a,b){q.push({id:b.getAttribute("data-id"),index:n+a+1})})):(d.insertAfter(m),d.prevAll().each(function(a,b){q.push({id:b.getAttribute("data-id"),index:n-1-a})})));a.each(q,function(a,b){setTimeout(function(){ImacScreen.adjustAppPosByIndex(b.id,b.index)},20*a)});p&&Util.ajax({url:f.updateAppPosUrl,data:{appId:k,screenId:ImacScreen._screenCache[ImacScreen.getActivePage()].id,sort:JSON.stringify(ImacScreen.getAppsSort(ImacScreen.getActivePage()))}})}};f.AppDragMgr={enableAllScreenApps:function(){e.find(".app-item").draggable(c)},enableScreenApp:function(a){ImacScreen.getApp(a).draggable(c)},destroy:function(a){a.draggable("destroy")}}})(this,jQuery);(function(f,a){var e=a("#imac-screen-pages"),c=e.width(),d=function(){var d=(a("body").width()-c)/2;e.css("left",d)};a(f).on("resize",d);d()})(this,jQuery);(function(f,a){var e=a("#imac-taskbar"),c=a(".tasks-wrap",e),d=a(".task-list",e),g=a("#task-drop"),l=a(".drop-list",g),k=Mustache,r=a.trim(TASK_ITEM_TPL),p=new EpContextMenu({items:[{text:"\u663e\u793a\u684c\u9762",click:function(){TabsNav.minAllTabs()}},"sep",{text:"\u5173\u95ed\u6b64\u4efb\u52a1",click:function(a){TabsNav.removeTab(a.id)}},{text:"\u53ea\u663e\u793a\u6b64\u4efb\u52a1\u7a97\u53e3",click:function(a){TabsNav.minAllTabs(a.id)}},"sep",{text:"\u5173\u95ed\u5176\u4ed6\u4efb\u52a1",click:function(a){TabsNav.removeAll(a.id)}},{text:"\u5173\u95ed\u6240\u6709\u4efb\u52a1",click:function(){TabsNav.removeAll()}},"sep",{text:"\u53d6\u6d88",role:"cancel"}]}),h={},m=0,n=function(){m=e.width()-0;var a=114*d.children().length;0<a&&d.css("width",a);a>m?(c.css("width",m),a-=m,d.stop(!0).animate({marginLeft:-a},500)):(d.stop(!0).animate({marginLeft:0},500),c.css("width","auto"))};f.TabsNav={_data:h,addTab:function(b){-1!="stringnumber".indexOf(typeof b)?this.openTask(b):(b.id=b.id||+new Date,b.icon=b.icon||"./images/app/8.png",h[b.id]||(a(k.render(r,{id:b.id,name:b.name,icon:b.icon})).appendTo(d),a(k.render(DROP_ITEM_TPL,{id:b.id,name:b.name})).appendTo(l),n()),TabsNav.openTask(b),TabsNav.activeTask(b.id))},openTask:function(a){var b,c=null,c=Util.getBdSize();"object"==typeof a?(b=a,a=b.id||+new Date):b=AppMgr.getAppData(a);g.removeClass("hidden");h[a]?(c=h[a],c.show(0,!1)):(b.widthRatio=1<b.widthRatio?1:b.widthRatio,b.heightRatio=1<b.heightRatio?1:b.heightRatio,c=(new EpDialog({id:a+"-epdialog",title:b.name,url:Util.getRightUrl(b.url),draggable:!0,dragContainer:".imac-screen",resizable:!0,resizeContainer:".imac-screen",width:(b.widthRatio||DIALOG_SIZE_RATIO[0])*c.width,height:(b.heightRatio||DIALOG_SIZE_RATIO[1])*c.height,btns:[{role:"min",title:"\u6700\u5c0f\u5316",click:function(){this.hide()}},{role:"maxwin",title:"\u6700\u5927\u5316"},{role:"refresh",title:"\u5237\u65b0"},{role:"close",title:"\u5173\u95ed",click:function(a){TabsNav.removeTab(a.id);return!1}}]})).setOptions("id",a),b.isFullView=b.isFullView||1==b.widthRatio&&1==b.heightRatio,b.isFullView?c.show(0,!1).maxWin():c.show(0,!0),h[a]=c)},minAllTabs:function(a){var b,c;for(b in h)h.hasOwnProperty(b)&&(c=h[b],b!=a?c.hide():(c.show(0,0),TabsNav.activeTask(b)))},addOrActiveTab:function(b){var c=h[b],e=AppMgr.getAppData(b);c||(a(k.render(r,{id:e.id,name:e.name,icon:e.icon})).appendTo(d),a(k.render(DROP_ITEM_TPL,{id:e.id,name:e.name})).appendTo(l),n());TabsNav.openTask(b);TabsNav.activeTask(b)},makeTabVisiable:function(a){a=114*TabsNav.getTab(a).prevAll().length;var b=Math.abs(Util.toInt(d.css("margin-left"))),e=c.width(),k=0;a<b?k=a:a+114-e>b&&(k=a+114-e);k&&d.stop(!0).animate({marginLeft:-k},300)},getTab:function(a){return d.find("#"+a+"-task")},removeTab:function(a){var b=TabsNav.getTab(a);b.length&&(b.remove(),l.find("#"+a+"-drop").remove(),l.children().length||g.addClass("hidden"),h[a].hide().destroy(),h[a]=null,delete h[a],n())},_removeOthers:function(b){var c=d.find(".task-item");c.length&&c.each(function(c,d){var e=a(d).data("id");b!=e&&TabsNav.removeTab(e)})},removeAll:function(a){a?this._removeOthers(a):this._removeAll()},_removeAll:function(){var b=d.find(".task-item");b.length&&(b.each(function(b,c){var d=a(c),e=d.data("id");d.remove();h[e].hide().destroy();h[e]=null;delete h[e]}),g.addClass("hidden"),l.children().each(function(b,c){a(c).remove()}),n())},activeTask:function(a){var b=TabsNav.getTab(a);b.hasClass("active")||b.addClass("active").siblings().removeClass("active");this.adjustTabPosOnActive(a);ImacBoard.hide()},adjustTabPosOnActive:function(a){$prevs=d.find("#"+a+"-task").prevAll();prev_w=114*$prevs.length;aimMarginLeft=scroll_w=Math.ceil(Math.abs(parseFloat(d.css("margin-left"),10)));prev_w<scroll_w?aimMarginLeft=prev_w:prev_w>=m+scroll_w?aimMarginLeft=prev_w+114-m:prev_w>scroll_w&&prev_w<m+scroll_w&&prev_w+114>m+scroll_w&&(aimMarginLeft=prev_w+114-m);d.stop(!0).animate({marginLeft:-aimMarginLeft},500)},refreshTabContent:function(a){(a=h[a])&&a.refresh&&a.refresh()}};a("body").on("click",".epdialog-hd",function(b){b.preventDefault();b.stopPropagation();/^epdialog-hd(?!-btn)/.test(b.target.className)&&(b=a(this).parent(".epdialog")[0].id.replace(/(.+)-epdialog$/,"$1"))&&TabsNav.addOrActiveTab(b)});var q;a(f).on("resize",function(){clearTimeout(q);q=setTimeout(function(){n();var a,c;for(a in h)h.hasOwnProperty(a)&&(c=h[a],!c.isHidden()&&c.isMax()&&c.maxWin())},100)});e.on("click",".task-item",function(){var b=a(this),c=b.data("id"),d=h[c];b.hasClass("active")?d.toggle():(b.addClass("active").siblings().removeClass("active"),d.show(0,0));TabsNav.activeTask(c)}).on("contextmenu",".task-item",function(b){var c=a(this).data("id");p.setOptions("id",c).show({x:b.pageX,y:b.pageY});return!1});var t=function(a){a?g.addClass("show"):e.addClass("drop-zindex");a=g.hasClass("show")?-280:44;l.stop(!0).animate({bottom:a},function(){e.removeClass("drop-zindex")});g.toggleClass("show")};Util.doNiceScroll(l,{cursorwidth:"2px",cursorcolor:"#3b4252",cursorborder:"1px solid #aaa"});g.on("click",".drop-btn",function(a){a.stopPropagation();l.children().length&&t()}).on("click",".drop-item",function(a){a.stopPropagation();a=this.getAttribute("data-id");TabsNav.addTab(a);TabsNav.activeTask(a);t()});a("body").on("click",function(b){a(b.target).closest(".drop-panel").length||g.hasClass("show")&&t(!0)});n()})(this,jQuery);(function(f,a){var e=a("#msg-sound"),c,d;Util.browsers.isIE?c=a('\x3ciframe src\x3d"" frameborder\x3d"0" class\x3d"hidden" id\x3d"msgcenter-sound"\x3e\x3c/iframe\x3e').appendTo(e):(e.html('\x3caudio id\x3d"msgcenter-sound-audio" controls\x3d"controls" src\x3d"../../msgsound/newsms.wav" class\x3d"hidden-accessible"\x3e\x3c/audio\x3e'),d=document.getElementById("msgcenter-sound-audio"));var e=a("#imac-right-bar .message"),g=a(".msg-num",e),l,k="\u60a8\u6709\u65b0\u6d88\u606f\u63d0\u9192\uff0c\u8bf7\u70b9\u51fb\u67e5\u770b\uff01",r=0,p={roll:function(){document.title=k;clearTimeout(r);r=setTimeout(function b(){document.title=k.substring(1,k.length)+k.substring(0,1);k=document.title;r=setTimeout(b,300)},300)},stop:function(){l=f.systemTitle||document.title;clearTimeout(r);document.title=l;k="\u60a8\u6709\u65b0\u6d88\u606f\u63d0\u9192\uff0c\u8bf7\u70b9\u51fb\u67e5\u770b\uff01"}},h=0,m=0,n,q,e=function(){q=n=!1;Util.ajax({url:f.msgCountUrl,data:{haseXun:!1,needNum:!0},success:function(a){a.remind?(h=parseInt(a.remind)||0,m=g.data("num")||0,h>m?n=!0:h&&(q=!0),g.text(99<h?"99+":h).data("num",h).removeClass("hidden")):g.text("").data("num",0).addClass("hidden");n?(Util.browsers.isIE?c[0].src=Util.getRightUrl("../../msgsound/sound.html?_\x3d"+ +new Date):d.play(),p.roll()):q||p.stop()},error:Util.noop,complete:Util.noop})};e();setInterval(e,6E4)})(this,jQuery);(function(f,a){var e=a("#imac-right-bar .quick-apps"),c=a(".r-empty-tpis-bg",e),d=c.find("#r-empty-tips"),g=a(".list-wrap",e),l=0,k=0,r=0,p=Mustache,h=a.trim(DOCK_APP_TPL),m=function(){l=e.position().top;k=e.next().outerHeight();r=a("body").height()-(50+l+k);g.css("height",r)};Util.doNiceScroll(g,{cursorwidth:"2px",cursorcolor:"#3b4252",cursorborder:"1px solid #aaa"});var n;a(f).on("resize",function(){clearTimeout(n);n=setTimeout(function(){m()},100)});var q=function(){var a=[];a.push({text:"\u6253\u5f00\u5e94\u7528",click:AppCmFuncs.openApp});a.push("sep");a.push({text:"\u79fb\u9664\u5e94\u7528",click:function(a){QuickApps.removeApp(a.id)}});return(new EpContextMenu({items:a})).setOptions("from","toolbar")}();e.on("click",".dock-app",function(){var c=a(this).data("id");AppMgr.openApp(c)}).on("contextmenu",".dock-app",function(c){if(f.rightUseQuickApps){var b=a(this).data("id");q.setOptions("id",b).show({x:c.pageX,y:c.pageY});return!1}});f.QuickApps={showEmptyTips:function(){d.attr("src",f.rightUseQuickApps?"./images/right/quick-tips.png":"./images/right/recent-tips.png").parent().removeClass("hidden")},hideEmptyTips:function(){c.addClass("hidden")},isFull:function(){var a=g.find(".dock-app").length==MAX_DOCK_APP_NUM;a&&mini.showMessageBox({title:"\u7cfb\u7edf\u63d0\u793a",message:"\u5f88\u62b1\u6b49\uff0c\u5de5\u5177\u680f\u4e2d\u7684\u5feb\u6377\u5e94\u7528\u5df2\u6ee1\uff08\u5f53\u524d\u914d\u7f6e\u4e3a\u6700\u591a"+MAX_DOCK_APP_NUM+"\u4e2a\uff09,\u5efa\u8bae\u79fb\u9664\u4e2a\u522b\u4e0d\u5e38\u7528\u7684\u5e94\u7528\u3002",buttons:["ok"],iconCls:"mini-messagebox-info"});return a},isInit:!1,init:function(){if(!this.isInit){m();var c=f.rightUseQuickApps?Util.localMemory.QuickApps.get():Util.localMemory.RecentApps.get();c.length?a.each(c,function(a,c){QuickApps.addApp(c,!0)}):this.showEmptyTips();this.isInit=!0}},_addApp:function(c,b){var d=AppMgr.getAppData(c);if(d)return d.sname=Util.getAppShortName(d.name),d=a(p.render(h,d)),d[b?"appendTo":"prependTo"](g),b||f.rightUseQuickApps||Util.highlightApp(d),d},addApp:function(a,b,c){this.hideEmptyTips();f.rightUseQuickApps?Util.localMemory.QuickApps.add(a):Util.localMemory.RecentApps.add(a);if(this.getApp(a).length)f.rightUseQuickApps&&mini.showMessageBox({title:"\u7cfb\u7edf\u63d0\u793a",message:"\u6b64\u5e94\u7528\u5df2\u5728\u53f3\u4fa7\u5feb\u6377\u5e94\u7528\u4e2d\u4e86",buttons:["ok"],iconCls:"mini-messagebox-warning"});else if(c){var d=this._addApp(a,b).addClass("hidden");a=ImacScreen.getApp(a);b=a.position();var e=a.clone().removeClass("trans").css({position:"absolute",top:b.top+50,zIndex:5E3}).appendTo("body");e.animate({top:180,left:Util.getBdSize().width-60},function(){e.remove();e=null;d.removeClass("hidden")})}else this._addApp(a,b)},getApp:function(a){return g.find('[data-id\x3d"'+a+'"]')},removeApp:function(a){var b=this.getApp(a);b.length&&(Util.localMemory[f.rightUseQuickApps?"QuickApps":"RecentApps"].remove(a),b.remove())}};ImacEvent.on("afterAllAppsLoad",function(){setTimeout(function(){QuickApps.init()},20)})})(this,jQuery);(function(f,a){a.each(f.quickApps,function(a,c){c=Util.fixPath(c);c.hasTaskbarIcon=!0;AppMgr.cacheAppData(c.id,c)});a("body").on("click",".default-app-btn",function(e){e.preventDefault();(e=a(this).data("id"))&&AppMgr.openApp(e)})})(this,jQuery);(function(f,a){var e=a("#top-user"),c=a("#imac-right-bar .right-board-btns"),d=a(".multi-board-list",c),g=a("#board-panel"),l=function(a,c){var d=new Image;d.onload=function(){c.src=a};d.onerror=function(){console.error(a+"\u5bf9\u5e94\u7684\u56fe\u7247\u8d44\u6e90\u65e0\u6cd5\u52a0\u8f7d\uff01")};d.src=a};(function(){return Util.ajax({url:f.userInfoUrl}).done(function(a){e.find(".user-name").text(a.name+"\uff0c\u60a8\u597d\uff01");e.find(".user-ou").text(a.ouName);if(a.portrait){var c=a.portrait,c=/^data:image/.test(c)?c:Util.getRightUrl("rest/"+c);l(c,e.find(".user-img")[0])}f._userName_=a.name;f._userGuid_=a.ouName})})();(function(){return Util.ajax({url:pageInfoUrl}).done(function(e){l(Util.getRightUrl(e.logo||f.DEFAULT_LOGO_URL),a(".sys-logo")[0]);e.title&&(document.title=e.title,f.systemTitle=e.title);var g=document.getElementById("full-search-form");e.fullSearchUrl?g.action=e.fullSearchUrl:g.className+=" hidden";if(e.homes){var k=1<e.homes.length;a.each(e.homes,function(e,g){g.id=g.id||+new Date;g.url=Util.getRightUrl(g.url);var f=Mustache.render(BOARD_BTN_TPL,g);a(f).appendTo(k?d:c);ImacBoard.data[g.id]=g});k&&d.prev().removeClass("hidden")}else throw Error("\u672a\u914d\u7f6e\u95e8\u6237");})})();f.ImacBoard={data:{},cache:{},show:function(c){c=this.cache[c]?this.cache[c]:this.cache[c]=a(Mustache.render(BOARD_CONTENT_TPL,ImacBoard.data[c])).appendTo(g);TabsNav.minAllTabs();g.removeClass("hidden");c.removeClass("hidden").siblings(".board-content").addClass("hidden")},hide:function(){g.addClass("hidden")}};c.on("click",".right-board-btn",function(){var a=this.getAttribute("data-id");ImacBoard.show(a);d.addClass("hidden")}).on("click",".multi-board-trigger",function(){d.toggleClass("hidden");ImacBoard.hide()});a("body").on("click",function(c){a(c.target).closest(".right-board-btns").length||d.addClass("hidden")});g.on("click",".board-close",function(){ImacBoard.hide()})})(this,jQuery);var eMsgSocket;window.OpenEMsg=function(f,a,e){window.eMsg?"undefined"==typeof a?eMsg.open(f):eMsg.openSession(f,a,e):Util.loadPageModule({templ:"frame/fui/pages/emsg/emsg.tpl",js:"frame/fui/pages/emsg/emsg.js",css:"frame/fui/pages/emsg/emsg.css",callback:function(){eMsgSocket=new EMsgSocket(_userGuid_,_userName_);"undefined"==typeof a?eMsg.open(f):eMsg.openSession(f,a,e)}})};(function(f,a){var e=a("#imac-right-bar"),c=a("#search-board"),d=a(".a-search-input",c),g=a("#all-apps",c),l=a(".no-result",g),k=a("#search-key",l),r=a(".tab-item",c).eq(0),p=a("#search-history",c),h=function(){var b=Util.localMemory.SearchHistory.get(),c=[];a.each(b,function(a,b){c.push(m(b))});a(c.join("")).appendTo(p)},m=function(a){return(a=AppMgr.getAppData(a))?Mustache.render(SEARCH_APPS_TPL,a):""};f.SearchPanel={isInit:!1,init:function(){h();var b=AppMgr._data,e,f=[];for(e in b)b.hasOwnProperty(e)&&f.push(m(e));a(f.join("")).appendTo(g);new TabView({dom:"#panel-tab-view",activeCls:"active"});Util.doNiceScroll(c.find(".tabview-bd"),{cursorwidth:"4px",cursorcolor:"#bebdbd",cursorborder:"1px solid #bebdbd"});Util.doPlaceHolder(d);this.isInit=!0},_show:function(){c.removeClass("hidden");d[0].value="";q();TabsNav.minAllTabs();ImacBoard.hide()},show:function(){this.isInit||this.init();this._show();this.show=this._show},hide:function(){c.addClass("hidden")},addAimedApp:function(b){Util.localMemory.SearchHistory.add(b)?a(m(b)).prependTo(p):p.find('[data-id\x3d"'+b+'"]').prependTo(p)},removeApp:function(a){g.add(p).find("#"+a+"-search").remove()}};c.on("click",".close-btn",function(){SearchPanel.hide()});e.on("click",".right-search-btn",function(){SearchPanel.show()});c.on("click",".app-item",function(){var b=a(this).data("id");AppMgr.openApp(b);SearchPanel.hide();SearchPanel.addAimedApp(b)});var n=function(){g.find(".app-name").each(function(a,c){c.innerHTML=c.innerText});l.addClass("hidden")},q=function(){r.hasClass("active")||r.trigger("click");var b=a.trim(d[0].value),c,e;c=!1;n();if(b){g.find(".app-item").addClass("hidden");var f,h=AppMgr._data;for(f in h)h.hasOwnProperty(f)&&-1!==h[f].name.indexOf(b)&&(c=g.find("#"+f+"-search"),e=c.find(".app-name"),e.html(e.html().replace(b,"\x3cb\x3e"+b+"\x3c/b\x3e")),c.removeClass("hidden"),c=!0);c||(k.text(b),l.removeClass("hidden"))}else g.find(".app-item").removeClass("hidden")},t;if(Util.browsers.isIE8||Util.browsers.isIE9)d.on("onkeypress",function(){clearTimeout(t);t=setTimeout(q,200)});else d.on("input",function(){clearTimeout(t);t=setTimeout(q,200)});d.on("onkeypress",function(a){13===a.which&&q()})})(this,jQuery);(function(f,a){var e={activeIndex:0,dom:null,triggerEvent:"click",activeCls:"",overDelay:300};f.TabView=function(c){this.cfg=a.extend({},e,c);this._initView();this._initEvent()};a.extend(TabView.prototype,{_initView:function(){var c=this.cfg,d=a(c.dom),e=d.find('\x3e [data-role\x3d"head"]'),f=d.find('\x3e [data-role\x3d"body"]'),d=e.find('[data-role\x3d"tab"]'),f=f.find('\x3e [data-role\x3d"tab-content"]');a.extend(this,{$widgetHd:e,$tabs:d,$tabCons:f});this.activeTabByIndex(c.activeIndex)},_initEvent:function(){var c=this.cfg,d=c.triggerEvent,e=this.$widgetHd,f=this,k=0;if("click"==d)e.on("click",'[data-role\x3d"tab"]',function(c){c.preventDefault();a.proxy(f._activeTab,f,a(this))()});else if("mouseover"==d)e.on("mouseover",'[data-role\x3d"tab"]',function(){k&&clearTimeout(k);k=setTimeout(a.proxy(f._activeTab,f,a(this)),c.overDelay)}).on("mouseout",'[data-role\x3d"tab"]',function(){k&&clearTimeout(k)})},_activeTab:function(a){var c=this.cfg.activeCls,e=this.$tabs,f=a.data("target");e.removeClass(c);a.addClass(c);this._activeTabContent(f)},activeTabByIndex:function(a){var c=this.cfg.activeCls,e=this.$tabs;0<=a&&a<e.length&&(a=e.removeClass(c).eq(a).addClass(c),a=a.data("target"),this._activeTabContent(a))},_activeTabContent:function(a){this.$tabCons.addClass("hidden").filter('[data-id\x3d"'+a+'"]').removeClass("hidden")}})})(this,jQuery);(function(f,a){Util.doPlaceHolder(a("[placeholder]"))})(this,jQuery);(function(f,a){var e=a("#imac-screens-container"),c=function(a){a=a<AppMgr.msgRemindApps.length?a:0;setTimeout(function(){d(AppMgr.msgRemindApps[a],a)},0===a?APP_MSG_CONFIG.interval||6E4:APP_MSG_CONFIG.space||50)},d=function(a,d){return Util.ajax({url:a.url,data:{query:"getAppMsgCount",id:a.id}}).done(function(c){if(c){var d=a._$count?a._$count:a._$count=e.find('[data-id\x3d"'+a.id+'"]').find(".unread"),f=c.count;c.count?d.text(99<f?"99+":f).removeClass("hidden"):d.addClass("hidden")}}).complete(function(){c(d+1)})},g=function(a){a.length&&setTimeout(function(){d(a[0],0)},APP_MSG_CONFIG.interval)};ImacEvent.on("afterAllAppsLoad",function(){g(AppMgr.msgRemindApps)})})(this,jQuery);(function(f,a){ImacEvent.on("afterAppUninstall",function(a){Util.localMemory.SearchHistory.remove(a.data);Util.localMemory[f.rightUseQuickApps?"QuickApps":"RecentApps"].remove(a.data);SearchPanel.isInit&&SearchPanel.removeApp(a.data);if(a=TabsNav._data["sys-appstore"])try{a.$iframe[0].contentWindow.afterAppUninstall()}catch(c){throw c;}})})(this,jQuery);(function(f,a){a("body").on("click",".q-btn.logout",function(){f.logout&&logout()})})(this,jQuery);